<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Adventure Log Dashboard</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg"/>
<link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"/>
<link rel="shortcut icon" href="favicon.ico"/>
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"/>
<link rel="manifest" href="site.webmanifest"/>
<style>
:root{
  --bg:#f6f8fb; --surface:#fff; --ink:#0f172a; --muted:#64748b; --primary:#1a73e8; --border:#e5eaf3;
  --radius:16px; --shadow1:0 2px 10px rgba(16,24,40,.06); --shadow2:0 20px 40px rgba(16,24,40,.12);
  --dur:220ms; --ease:cubic-bezier(.2,.8,.2,1); --gap:14px; --min-card:320px;
  --danger:#dc2626;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg);scrollbar-gutter:stable}
.container{max-width:1200px;margin:28px auto 80px;padding:0 20px 120px}
.header{position:relative;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow1)}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.avatar{display:block;width:auto;height:72px;max-width:100%;border-radius:0;box-shadow:none;object-fit:contain}
.avatar.has-avatar{cursor:zoom-in;}
.avatar:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:3px}
h1{margin:0;font-size:28px;line-height:1.05;font-weight:800;letter-spacing:-0.01em}
.header-main{display:flex;flex-direction:column;gap:6px;min-width:0;flex:1 1 auto}
.title-select-wrap{display:flex;align-items:center;gap:6px;position:relative;max-width:100%;min-width:0}
.title-select-wrap::after{content:"";flex-shrink:0;width:12px;height:8px;clip-path:polygon(0 0,100% 0,50% 100%);background:currentColor;opacity:.55;transition:opacity var(--dur) var(--ease),transform var(--dur) var(--ease);pointer-events:none;transform:translateY(0)}
.title-select-wrap:focus-within::after{opacity:1;transform:translateY(-2px)}
.title-select{appearance:none;border:none;background:transparent;font:inherit;color:var(--ink);padding:0;margin:0;cursor:pointer;line-height:1.1;font-weight:800;letter-spacing:-0.01em;max-width:100%;min-width:0;font-size:clamp(16px,3vw,22px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.title-select:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:2px;border-radius:6px}
.title-select option{color:var(--ink)}
.char-badges{margin-top:4px;display:none;gap:8px;flex-wrap:wrap;align-items:center}
.char-badges .identity-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#eef4ff;color:#1e293b;font-weight:600;font-size:12px}
.char-badges .identity-badge .label{font-size:10px;letter-spacing:.08em;text-transform:uppercase;color:#64748b}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.muted{color:var(--muted);font-size:13px}
.char-meta{display:none;margin-top:4px;font-size:14px;font-weight:600;color:var(--muted)}

/* Toolbar */
.toolbar{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
.select,.btn,.search input{border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 12px;font-weight:600;box-shadow:var(--shadow1)}
.btn{cursor:pointer;transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.btn:hover{transform:translateY(-1px);box-shadow:var(--shadow2)}
.btn.primary{background:var(--primary);color:#fff;border-color:transparent}
.btn-icon{display:inline-flex;align-items:center;justify-content:center;margin-right:6px}
.btn-icon svg{width:14px;height:14px}
.btn.danger{border:1px solid rgba(220,38,38,.2);background:rgba(254,226,226,1);color:var(--danger);}
.btn.danger:hover{background:#fecaca;border-color:rgba(220,38,38,.35)}
.btn.small{padding:6px 10px;font-size:12px;border-radius:10px;display:inline-flex;align-items:center;gap:6px}
.search{position:relative}
.search input{padding-left:36px;outline:none;width:220px;max-width:100%}
.search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:18px;height:18px;opacity:.6}
.toolbar .spacer{flex:1 1 auto}

.icon-btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:#fff;color:var(--muted);cursor:pointer;transition:background var(--dur) var(--ease),color var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.icon-btn svg{width:14px;height:14px;pointer-events:none}
.icon-btn:hover{color:var(--primary);background:#eef4ff;box-shadow:var(--shadow1)}
.icon-btn.danger{border-color:rgba(220,38,38,.2);background:#fee2e2;color:var(--danger)}
.icon-btn.danger:hover{color:#991b1b;background:#fecaca;box-shadow:var(--shadow1)}
.icon-btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.icon-btn.primary:hover{box-shadow:var(--shadow2)}
.icon-btn[disabled]{opacity:.5;cursor:not-allowed;box-shadow:none;background:#f1f5f9;color:#94a3b8}
.download-btn{margin-left:auto;align-self:flex-start;display:inline-flex;align-items:center;justify-content:center;gap:6px;width:auto;height:32px;padding:0 12px;border:none;border-radius:999px;background:transparent;box-shadow:none;color:var(--primary);font-weight:600;font-size:13px;line-height:1}
.download-btn .save-icon,.download-btn .save-spinner,.download-btn .save-success{display:none;align-items:center;justify-content:center;gap:6px}
.download-btn .save-icon svg,.download-btn .save-spinner svg{width:20px;height:20px}
.download-btn .save-success{letter-spacing:.01em}
.download-btn:not(.saving):not(.success) .save-icon{display:inline-flex}
.download-btn.saving .save-spinner{display:inline-flex}
.download-btn.success .save-success{display:inline-flex}
.download-btn::after{content:none}
.download-btn:hover{color:#1257b3}
.download-btn.dirty{color:#0b3f88;background:transparent}
.download-btn.dirty:hover{color:#0a3572}
.download-btn:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:2px}
.download-btn.saving{color:var(--muted);cursor:progress}
.download-btn.success{color:#15803d}
.download-btn.error{color:var(--danger)}
.download-btn .save-spinner svg{animation:save-spin 900ms linear infinite}

@keyframes save-spin{
  0%{transform:rotate(0)}
  100%{transform:rotate(360deg)}
}

/* Header metrics */
.header-quick{margin-top:14px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.inventory-buttons{display:flex;align-items:center;gap:18px;margin-left:auto;flex-wrap:wrap}
.inventory-link{display:inline-flex;align-items:center;gap:8px;background:transparent;border:none;padding:6px 8px;border-radius:10px;font-weight:600;font-size:14px;color:var(--muted);cursor:pointer;transition:color var(--dur) var(--ease),background var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.inventory-link .icon svg,.inventory-link .icon img,.inventory-metric .icon svg{width:24px;height:24px;display:block}
.inventory-link .text,.inventory-metric .text{letter-spacing:.02em}
.inventory-link:hover,.inventory-link:focus-visible{color:var(--primary);background:#eef4ff;box-shadow:0 8px 16px rgba(26,115,232,.18)}
.inventory-link:active{color:#0b57d0;background:#d7e4ff}
.inventory-link:focus-visible{outline:none}
.inventory-metric{display:inline-flex;align-items:center;gap:8px;padding:6px 0;color:var(--muted);font-weight:600}
.inventory-metric .text{white-space:nowrap}
.inventory-metric .amount{font-weight:700;color:var(--ink)}
@media (max-width:520px){
  .row{flex-wrap:nowrap;gap:10px}
  .header-main{flex:1 1 auto;min-width:0}
  .title-select-wrap{flex:1 1 auto}
  .title-select{font-size:clamp(18px,5vw,22px)}
  .header-quick{flex-direction:column;align-items:flex-start;gap:12px}
  .inventory-buttons{margin-left:0}
}

/* Grid / masonry columns */
.grid{margin-top:24px}
.grid.cols{display:flex;gap:var(--gap);align-items:flex-start}
.grid.cols .col{display:flex;flex-direction:column;gap:var(--gap);flex:1 1 0;min-width:var(--min-card)}

/* Card */
.card{display:block;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow1);overflow:hidden;transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.card:hover{transform:translateY(-3px);box-shadow:var(--shadow2)}
.card-hd{display:flex;align-items:flex-start;justify-content:flex-start;gap:10px;padding:14px 12px 14px 14px;cursor:pointer;min-height:96px}
.card-hd .titleLine,.card-hd .activity-line{flex:1 1 auto;min-width:0}
.card-hd .titleLine{width:100%}
.card-hd .card-tools{display:flex;align-items:center;gap:6px;margin-left:auto}
.card .card-tools .icon-btn{opacity:0;visibility:hidden;pointer-events:none;transform:translateY(-4px);transition:opacity var(--dur) var(--ease),transform var(--dur) var(--ease)}
.card:hover .card-tools .icon-btn,
.card.open .card-tools .icon-btn,
.card.editing .card-tools .icon-btn,
.card .card-tools .icon-btn:focus-visible{opacity:1;visibility:visible;pointer-events:auto;transform:translateY(0)}
.card.editing .card-hd{cursor:default}
.card.editing{border-color:rgba(26,115,232,.35);box-shadow:0 0 0 2px rgba(26,115,232,.08);background:#e8f0ff}
.titleLine{display:flex;flex-direction:column}
.date{color:var(--muted);line-height:16px}
.title{font-weight:700;line-height:20px;height:20px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%;width:100%}
.subtitle{color:var(--muted);font-size:12px;line-height:16px;min-height:16px}
.chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;min-height:22px}
.subtitle-row{display:flex;align-items:center;gap:10px;margin-top:4px;width:100%;min-height:22px}
.subtitle-row .subtitle{margin-top:0}
.subtitle-row .chips{margin-top:0;margin-left:auto;justify-content:flex-end}
.card.open .subtitle-row{flex-wrap:wrap;gap:6px}
.card.open .subtitle-row .chips{margin-left:auto;justify-content:flex-end}
.pill{background:#fff7e6;color:#a05a00;border:1px solid #ffe3b0;border-radius:999px;padding:4px 8px;font-weight:700;font-size:11px}

/* Collapsible */
.card-bd{height:0;overflow:hidden;border-top:1px solid var(--border);transition:height var(--card-dur,var(--dur)) var(--ease),opacity var(--card-dur,var(--dur)) linear;padding:0 14px;opacity:0;will-change:height,opacity;contain:layout paint}
.bd-in{padding:12px 0 16px}
.edit-form{padding:12px 0 16px;display:none}
.card.editing .edit-form{display:none}
@media (prefers-reduced-motion:reduce){.card-bd{transition:none}}

/* Fields */
.field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
.field .k{color:var(--muted);font-size:12px;font-weight:400}
.field .v{width:100%}
.field .display{display:block}
.field .editor{display:none}
.card.editing .field .display{display:none}
.card.editing .field .editor{display:block}
.show-when-editing{display:none}
.card.editing .show-when-editing{display:block}
.field.show-when-editing{display:none}
.card.editing .field.show-when-editing{display:flex}
.editable-inline .display{display:inline}
.editable-inline .editor{display:none}
.card:not(.editing) .editable-inline .editor{display:none!important}
.card.editing .editable-inline{width:100%;min-width:0}
.card.editing .editable-inline .display{display:none}
.card.editing .editable-inline .editor{display:flex;width:100%}
.card.editing .editable-inline .editor > *{flex:1 1 auto;width:100%;min-width:0}
.editable-inline .editor input,.editable-inline .editor select{font:inherit;padding:6px 8px;line-height:1.3;border:1px solid var(--border);border-radius:10px;outline:none;background:#fff;max-width:100%;min-width:0;box-shadow:none;min-height:calc(1em + 12px)}
.editable-inline .editor input{min-width:0;max-width:100%}
.card.editing .subtitle-row{flex-wrap:wrap;align-items:flex-start;gap:6px}
.card.editing .subtitle-row .subtitle{width:100%;min-width:0}
.card.editing .subtitle-row .chips{margin-left:0;width:100%;justify-content:flex-start}
.card.editing .activity-line{flex-wrap:wrap;gap:6px}
.card.editing .activity-left{flex-wrap:wrap;white-space:normal;min-width:0}
.card.editing .activity-left .editable-inline{flex:1 1 100%;width:100%}
.card.editing .activity-line .chips{margin-left:0;width:100%;justify-content:flex-start}
.field input,.field textarea,.field select{font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;resize:vertical}
.field textarea{min-height:80px}
.kv2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:8px 0}
.kvsingle{display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;margin:6px 0}
.kvsingle .k{color:var(--muted);font-size:12px;font-weight:400}
.kvsingle .v{font-weight:400;min-width:0}
.kvsingle .display{display:block}
.kvsingle .editor{display:none;width:100%}
.card.editing .kvsingle .display{display:none}
.card.editing .kvsingle .editor{display:flex}
.card.editing .kvsingle .editor > *{flex:1 1 auto;width:100%;min-width:0}
.kvsingle .editor input,.kvsingle .editor select{font:inherit;padding:4px 6px;border:1px solid var(--border);border-radius:10px;outline:none;background:#fff;max-width:100%;min-width:0;box-shadow:none}
.scrollbox{background:#f9fafb;border:1px dashed var(--border);border-radius:12px;padding:10px;max-height:160px;overflow:auto}
.scrollbox .item{margin:2px 0}
.notesbox{background:#f9fafb;border:1px solid var(--border);border-radius:12px;padding:10px;max-height:160px;overflow:auto}
.empty{text-align:center;color:var(--muted);padding:40px 0}
.list-editor{display:flex;flex-direction:column;gap:8px}
.list-editor .list{display:flex;flex-direction:column;gap:8px}
.list-editor .list-row{display:flex;align-items:center;gap:8px}
.list-editor .list-row input{flex:1 1 auto;font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;min-width:0}
.list-editor .list-row button{width:32px;height:32px;border-radius:10px;border:1px solid rgba(220,38,38,.25);background:#fee2e2;color:var(--danger);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background var(--dur) var(--ease),color var(--dur) var(--ease)}
.list-editor .list-row button:hover{background:#fecaca;color:#991b1b}
.list-editor .list-row button svg{width:16px;height:16px}
.list-editor .add-row{align-self:flex-start;border:1px dashed var(--border);background:#f8fafc;color:var(--primary);border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}
.list-editor .add-row:hover{background:#eef4ff}
.edit-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
.card:not(.editing) .edit-actions{display:none}
.card.editing .edit-actions{display:flex}
.edit-actions .delete-btn{margin-right:auto}

.edit-form form{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.edit-form .field{margin:0}
.edit-form .field.full{grid-column:1 / -1}
.edit-form .field .v input,.edit-form .field .v select,.edit-form .field .v textarea{width:100%}
.edit-form input[type=number]{max-width:140px}
.edit-form .kv2{grid-column:1 / -1;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:0}
.edit-form .kv2 .kvsingle{margin:0}
.edit-form .kv2 .v{display:flex}
.edit-form .kv2 .v input{flex:1 1 auto}
.edit-form .list-editor{grid-column:1 / -1}
.edit-form .edit-actions{grid-column:1 / -1;margin-top:4px}

.card.editing input,.card.editing textarea,.card.editing select,.card.editing .list-editor .list-row input{outline:none;box-shadow:none;border-radius:10px;background:#fff}
.card.editing input:focus,.card.editing textarea:focus,.card.editing select:focus,.card.editing .editable-inline .editor input:focus,.card.editing .editable-inline .editor select:focus{outline:none;box-shadow:0 0 0 2px rgba(26,115,232,.2)}

body.modal-open{overflow:hidden;}
body.modal-open #addCard{display:none;}

#addCard{
  position:fixed;
  bottom:24px;
  right:24px;
  width:64px;
  height:64px;
  border-radius:50%;
  border:none;
  background:linear-gradient(135deg,#ff8a5c,#ff3d71);
  color:#fff;
  box-shadow:0 16px 30px rgba(255,61,113,.35);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease);
  z-index:60;
}
#addCard svg{width:28px;height:28px}
#addCard:hover{transform:translateY(-2px);box-shadow:0 24px 40px rgba(255,61,113,.45)}
#addCard:focus-visible{outline:3px solid rgba(255,61,113,.4);outline-offset:4px}
.toolbar #addCard{margin-left:auto}

/* Activity cards (compact header) */
.card.activity{background:#f7f8fa;border-color:#e6e9f2}
.card.activity .card-hd{padding:6px 12px;min-height:44px;display:flex;align-items:center}
.activity-line{display:flex;align-items:center;justify-content:space-between;flex-wrap:nowrap;width:100%;gap:8px}
.activity-left{display:flex;align-items:center;gap:6px;min-width:0;flex:1 1 auto;white-space:nowrap}
.activity-date{font-size:12px;line-height:16px;color:var(--muted)}
.activity-name{font-weight:600;font-size:14px;line-height:18px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.card.activity .chips{display:flex;flex:0 0 auto;align-items:center;gap:6px;margin:0;white-space:nowrap}
.card.activity .pill{height:22px;line-height:22px;padding:0 8px;max-width:160px;overflow:hidden;text-overflow:ellipsis}
.pill.muted{background:#eef1f6;color:#475569;border-color:#dce2ee}

/* Modals (shared) */
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(15,23,42,.4);z-index:50}
.modal.open{display:grid}
.modal-card{width:min(92vw,800px);max-height:80vh;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow2);display:flex;flex-direction:column;overflow:hidden}
.modal-hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700;display:flex;align-items:center;justify-content:space-between;gap:8px}
.modal-body{padding:12px 16px;overflow:auto}
.modal-actions{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
.inv-meta{color:var(--muted);font-size:12px}
.inv-list{display:flex;flex-direction:column;gap:6px}
.modal-add{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.modal-add input,.modal-add select{font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
.modal-add button{border:1px solid var(--primary);background:rgba(26,115,232,.1);color:var(--primary);border-radius:10px;padding:8px 14px;font-weight:600;cursor:pointer}
.modal-add button:hover{background:rgba(26,115,232,.2)}

/* Inventory row styles */
.inv-row{display:grid;grid-template-columns:1fr auto;align-items:center;padding:6px 10px;border-radius:8px;cursor:pointer;transition:background .2s}
.inv-row:nth-child(odd){background:#fafbfc}
.inv-row:nth-child(even){background:#f2f5f8}
.inv-row.active{background:#e8f0ff;font-weight:600}
.inv-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.inv-name.consumable-name{display:flex;flex-direction:column;align-items:flex-start;gap:4px;min-width:0}
.inv-name.consumable-name .cons-primary{display:flex;align-items:center;gap:6px;flex-wrap:nowrap;min-width:0}
.inv-name.consumable-name .cons-name{display:block;font-weight:600;min-width:0;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1 1 auto}
.inv-name.consumable-name .cons-chips{display:inline-flex;flex-wrap:nowrap;gap:6px;margin-left:6px;flex:0 0 auto}
.inv-tools{display:flex;align-items:center;gap:6px}
.inv-row .delete-btn{display:none;margin-left:8px}
.modal.editing .inv-row{cursor:default}
.modal.editing .inv-row .delete-btn{display:inline-flex}
.modal.editing .inv-row .attune-pill{pointer-events:none;opacity:.6}
.modal.editing .inv-row .qty-icon{pointer-events:none;opacity:.6}
.modal.editing .inv-row .qty-pill{opacity:.6}

/* Attunement pill (perm modal, active rows only) */
.attune-pill{display:inline-block;border:1px solid #cfe0ff;background:#eef4ff;color:#1a73e8;border-radius:999px;padding:2px 8px;font-size:11px;user-select:none;cursor:pointer;transition:background .2s,color .2s}
.attune-pill.on{background:#1a73e8;color:#fff}

/* Consumables qty controls */
.inv-row .qty{display:flex;align-items:center;gap:8px;white-space:nowrap}
.qty-pill{display:inline-block;min-width:28px;padding:2px 8px;text-align:center;border:1px solid var(--border);border-radius:999px;background:#f9fafb;font-size:11px;color:#475569}
.qty-input{width:64px;padding:4px 8px;border:1px solid var(--border);border-radius:10px;font:inherit;font-size:12px;text-align:center;background:#fff}
.qty-icon{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;color:#1e3a8a;background:transparent;cursor:pointer;transition:color var(--dur) var(--ease),transform var(--dur) var(--ease)}
.qty-icon svg{width:22px;height:22px;stroke-width:1.8}
.qty-icon:hover{color:#1a73e8;transform:translateY(-1px)}
.qty-icon:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:3px}
.qty-icon.disabled{opacity:.35;cursor:not-allowed;transform:none}
.qty-icon.disabled:hover{color:inherit}
.cons-section{display:flex;flex-direction:column;gap:6px;padding:2px 0}
.cons-section+.cons-section{margin-top:16px}
.cons-section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);padding:0 4px}
.cons-sublist{display:flex;flex-direction:column;gap:6px}
.cons-name{display:block;font-weight:600}
.cons-chips{display:inline-flex;gap:6px;margin-left:6px;flex-wrap:wrap;align-items:center}
.cons-chip{display:inline-flex;align-items:center;justify-content:center;padding:2px 6px;border-radius:999px;background:#eef4ff;color:#1e3a8a;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em}
.cons-chip--potion{background:#fef3c7;color:#b45309}
.cons-chip--scroll{background:#ede9fe;color:#5b21b6}
.cons-secondary{display:block;margin-top:3px;font-size:11px;color:var(--muted);white-space:normal}

/* Reduce scroll anchoring jumps */
html,body,.grid,.grid .col,.card-bd{overflow-anchor:none}

/* New entry overlay */
.card-overlay{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(15,23,42,.4);backdrop-filter:blur(2px);z-index:70;padding:48px 16px;overflow:auto}
.card-overlay.open{display:flex}
.card-overlay .card{max-width:720px;width:100%;box-shadow:var(--shadow2);margin:0 auto}
.card-overlay .card .card-tools{display:none}
.avatar-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.7);backdrop-filter:blur(2px);z-index:80;padding:24px}
.avatar-overlay.open{display:flex}
.avatar-overlay .avatar-preview{display:flex;align-items:center;justify-content:center;max-width:calc(100vw - 48px);max-height:calc(100vh - 48px)}
.avatar-overlay .avatar-preview img{display:block;width:auto;height:auto;max-width:100%;max-height:100%;filter:drop-shadow(0 40px 90px rgba(15,23,42,.6))}
.avatar-overlay{cursor:zoom-out}
body.avatar-overlay-open{overflow:hidden}
</style>
</head>
<body>
<div class="container">
  <section class="header">
    <div class="row">
      <img id="charAvatar" class="avatar" alt="Character avatar"/>
      <div class="header-main">
        <h1 class="title-select-wrap" id="charTitle">
          <label for="charSel" class="sr-only">Select a sheet or character</label>
          <select id="charSel" class="title-select"></select>
        </h1>
        <div id="charMeta" class="char-meta muted" aria-live="polite"></div>
        <div id="charBadges" class="char-badges" aria-live="polite"></div>
      </div>
      <button id="downloadData" class="icon-btn download-btn" type="button" title="Save data.js" aria-label="Save data.js">
        <span class="save-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 3h9l4 4v13H6a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3Z"/>
            <path d="M15 3v5H6V3"/>
            <path d="M9 14h6v5H9z"/>
          </svg>
        </span>
        <span class="save-spinner" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="9" stroke-opacity=".3"/>
            <path d="M21 12a9 9 0 0 0-9-9"/>
          </svg>
        </span>
        <span class="save-success" aria-hidden="true">Saved</span>
      </button>
    </div>
    <div class="toolbar">
      <div class="search">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/></svg>
        <input id="q" placeholder="Search adventures"/>
      </div>
      <button id="activityToggle" class="btn small" type="button" aria-pressed="false">Hide activities</button>
      <button id="addCard" class="icon-btn" title="Add new adventure" aria-label="Add new adventure">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
      </button>
    </div>
    <div class="header-quick" id="headerQuick">
      <div class="inventory-buttons">
        <button id="magicItemsBtn" class="inventory-link" type="button" title="View permanent magic items" aria-label="View permanent magic items">
          <span class="icon" aria-hidden="true">
            <img src="chest.png" alt="" width="24" height="24"/>
          </span>
          <span class="sr-only" id="magicItemsCount">0</span>
        </button>
        <button id="consumablesBtn" class="inventory-link" type="button" title="View consumables" aria-label="View consumables">
          <span class="icon" aria-hidden="true">
            <img src="potion.png" alt="" width="24" height="24"/>
          </span>
          <span class="sr-only" id="consumablesCount">0</span>
        </button>
        <div class="inventory-metric" id="goldMetric" role="group" aria-label="Gold pieces total">
          <span class="text">Gold</span>
          <span class="amount" id="goldValue">0</span>
        </div>
        <div class="inventory-metric" id="downtimeMetric" role="group" aria-label="Downtime days total">
          <span class="text">Downtime</span>
          <span class="amount" id="downtimeValue">0</span>
        </div>
      </div>
    </div>
  </section>
  <section id="grid" class="grid cols"></section>
  <div id="empty" class="empty" style="display:none;">No adventures match your filters.</div>
</div>

<!-- Permanent Items Modal -->
<div id="invModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="invTitle">
  <div class="modal-card">
    <div class="modal-hd">
      <div id="invTitle">Permanent Magic Items</div>
      <div class="inv-meta" id="invMeta"></div>
    </div>
    <div class="modal-body">
      <div id="invSummary" class="inv-meta" style="margin-bottom:8px;"></div>
      <div id="invList" class="inv-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="invClose">Close</button>
    </div>
  </div>
</div>

<!-- Consumables Modal -->
<div id="consModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="consTitle">
  <div class="modal-card">
    <div class="modal-hd">
      <div id="consTitle">Consumables</div>
      <div class="inv-meta" id="consMeta"></div>
    </div>
    <div class="modal-body">
      <div id="consSummary" class="inv-meta" style="margin-bottom:8px;"></div>
      <div id="consList" class="inv-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="consClose">Close</button>
    </div>
  </div>
</div>

<div id="cardOverlay" class="card-overlay" role="dialog" aria-modal="true" aria-hidden="true"></div>
<div id="avatarOverlay" class="avatar-overlay" role="dialog" aria-modal="true" aria-hidden="true" tabindex="-1">
  <div class="avatar-preview">
    <img class="avatar-preview-image" alt="Character avatar"/>
  </div>
</div>

<script>
(function(){
  var KEY='al_logs_data_version';
  window.AL_DATA_VERSION_KEY=KEY;
  var version='';
  try{
    version=localStorage.getItem(KEY)||'';
  }catch(err){
    version='';
  }
  if(!version){
    try{
      version=sessionStorage.getItem(KEY)||'';
    }catch(err){
      version='';
    }
  }
  window.AL_DATA_VERSION=version;
  var cacheBust=String(Date.now());
  window.AL_DATA_CACHE_BUST=cacheBust;
  var srcBase=version?('data.js?v='+encodeURIComponent(version)):'data.js';
  var separator=srcBase.indexOf('?')===-1?'?':'&';
  var src=srcBase+separator+'cb='+encodeURIComponent(cacheBust);
  try {
    var script=document.createElement('script');
    script.src=src;
    script.id='dataScript';
    script.async=false;
    script.setAttribute('data-version', version||'');
    script.setAttribute('data-cache-bust', cacheBust);
    var parent=document.currentScript&&document.currentScript.parentNode;
    (parent||document.head||document.body||document.documentElement).appendChild(script);
  } catch(err){
    var fallback=document.createElement('script');
    fallback.src=src;
    fallback.id='dataScript';
    fallback.async=false;
    fallback.setAttribute('data-version', version||'');
    fallback.setAttribute('data-cache-bust', cacheBust);
    (document.head||document.body||document.documentElement).appendChild(fallback);
  }
})();
</script>
<script>
/* --- data boot --- */
let DATA = window.DATA || null;

/* --- DOM handles --- */
const charSel  = document.getElementById('charSel');
const avatarEl = document.getElementById('charAvatar');
const downloadBtn = document.getElementById('downloadData');
const qEl      = document.getElementById('q');
const grid     = document.getElementById('grid');
const emptyEl  = document.getElementById('empty');
const badgesEl = document.getElementById('charBadges');
const metaEl   = document.getElementById('charMeta');
const addCardBtn = document.getElementById('addCard');
const activityToggleBtn = document.getElementById('activityToggle');
const cardOverlay=document.getElementById('cardOverlay');
const avatarOverlay=document.getElementById('avatarOverlay');
const avatarPreview=avatarOverlay?avatarOverlay.querySelector('.avatar-preview'):null;
const avatarPreviewImage=avatarOverlay?avatarOverlay.querySelector('.avatar-preview-image'):null;
const dataScriptEl=document.getElementById('dataScript');
const DATA_VERSION_KEY=window.AL_DATA_VERSION_KEY||'al_logs_data_version';
let dataVersion=(dataScriptEl&&dataScriptEl.getAttribute('data-version'))||window.AL_DATA_VERSION||'';
window.AL_DATA_VERSION=dataVersion;
let dataCacheBust=(dataScriptEl&&dataScriptEl.getAttribute('data-cache-bust'))||window.AL_DATA_CACHE_BUST||'';
window.AL_DATA_CACHE_BUST=dataCacheBust;
if(avatarEl){
  avatarEl.tabIndex=-1;
  avatarEl.addEventListener('click',evt=>{
    if(!avatarEl.classList.contains('has-avatar')) return;
    evt.preventDefault();
    openAvatarOverlay();
  });
  avatarEl.addEventListener('keydown',evt=>{
    if(!avatarEl.classList.contains('has-avatar')) return;
    if(evt.key==='Enter'||evt.key===' '){
      evt.preventDefault();
      openAvatarOverlay();
    }
  });
}
const goldMetricEl=document.getElementById('goldMetric');
const goldValueEl=document.getElementById('goldValue');
const downtimeMetricEl=document.getElementById('downtimeMetric');
const downtimeValueEl=document.getElementById('downtimeValue');
const magicItemsBtn=document.getElementById('magicItemsBtn');
const consumablesBtn=document.getElementById('consumablesBtn');
const magicItemsCountEl=document.getElementById('magicItemsCount');
const consumablesCountEl=document.getElementById('consumablesCount');
let overlayCard=null;
const avatarCache=new Map();
let avatarLoadToken=0;
const ICON_TRASH='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-14"/></svg>';
const ICON_MINUS='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="9"/><path d="M8 12h8"/></svg>';
const ICON_PLUS='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="9"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>';

function bindButtonLike(el, handler){
  if(!el) return;
  el.addEventListener('click', handler);
  el.addEventListener('keydown', evt => {
    if(evt.key==='Enter' || evt.key===' '){
      evt.preventDefault();
      handler(evt);
    }
  });
}

bindButtonLike(magicItemsBtn, () => openInventoryModal(charSel.value));
bindButtonLike(consumablesBtn, () => openConsumableModal(charSel.value));

let pendingChanges=false;
let savingData=false;
let lastSaveResult=null;
let saveFeedbackTimeout=null;
const SAVE_ENDPOINT=(typeof window!=='undefined' && window.AL_SAVE_ENDPOINT)||'https://al-logs.vercel.app/api/save-data';
const SAVE_HEADERS=(typeof window!=='undefined' && window.AL_SAVE_HEADERS)||null;
const STORAGE_KEYS={
  showActivities:'al_logs_show_activities',
  lastCharacter:'al_logs_last_character'
};

let showActivities=true;
try{
  const saved=localStorage.getItem(STORAGE_KEYS.showActivities);
  if(saved==='0'||saved==='false') showActivities=false;
}catch(err){
  /* no-op */
}

function persistActivityVisibility(){
  try{
    localStorage.setItem(STORAGE_KEYS.showActivities, showActivities?'1':'0');
  }catch(err){
    /* no-op */
  }
}

let cachedLastCharacterKey=null;
function getRememberedCharacterKey(){
  if(cachedLastCharacterKey===null){
    try{
      cachedLastCharacterKey=localStorage.getItem(STORAGE_KEYS.lastCharacter)||'';
    }catch(err){
      cachedLastCharacterKey='';
    }
  }
  return cachedLastCharacterKey;
}
function rememberCharacterKey(key){
  const hasCharacters=!!(DATA&&DATA.characters);
  const nextKey=(key && hasCharacters && DATA.characters[key])?String(key):'';
  if(cachedLastCharacterKey===nextKey) return;
  cachedLastCharacterKey=nextKey;
  try{
    if(nextKey){
      localStorage.setItem(STORAGE_KEYS.lastCharacter,nextKey);
    }else{
      localStorage.removeItem(STORAGE_KEYS.lastCharacter);
    }
  }catch(err){
    /* no-op */
  }
}

function updateActivityToggle(){
  if(!activityToggleBtn) return;
  const hiding=!showActivities;
  activityToggleBtn.textContent=hiding?'Show activities':'Hide activities';
  activityToggleBtn.setAttribute('aria-pressed', hiding?'true':'false');
  activityToggleBtn.classList.toggle('primary', hiding);
  const label=hiding?'Show downtime activities':'Hide downtime activities';
  activityToggleBtn.setAttribute('aria-label', label);
  activityToggleBtn.title=label;
}

function updateSaveButtonState(){
  if(!downloadBtn) return;
  const baseLabel=pendingChanges?'Save changes to data.js':'All changes saved';
  let label=baseLabel;
  downloadBtn.classList.toggle('dirty',pendingChanges && !savingData);
  downloadBtn.classList.toggle('saving',savingData);
  downloadBtn.classList.toggle('success',!pendingChanges && lastSaveResult==='success');
  downloadBtn.classList.toggle('error',lastSaveResult==='error');
  downloadBtn.disabled=!!savingData;
  downloadBtn.setAttribute('aria-busy',savingData?'true':'false');
  if(savingData){
    label='Saving data.js...';
  }else if(lastSaveResult==='error'){
    label='Last save failed — try again';
  }else if(lastSaveResult==='success' && !pendingChanges){
    label='Changes saved to data.js';
  }
  downloadBtn.setAttribute('aria-label',label);
  downloadBtn.title=label;
}

function setSaveResult(state){
  lastSaveResult=state;
  clearTimeout(saveFeedbackTimeout);
  if(state==='success'){
    saveFeedbackTimeout=setTimeout(()=>{
      if(lastSaveResult==='success'){
        lastSaveResult=null;
        updateSaveButtonState();
      }
    },2500);
  }
  updateSaveButtonState();
}

function anyModalOpen(){
  return (invModal && invModal.classList.contains('open'))
    || (consModal && consModal.classList.contains('open'))
    || (cardOverlay && cardOverlay.classList.contains('open'));
}

function refreshModalState(){
  if(anyModalOpen()){ document.body.classList.add('modal-open'); }
  else{ document.body.classList.remove('modal-open'); }
}

function openCardOverlay(card){
  if(!cardOverlay || !card) return;
  cardOverlay.innerHTML='';
  cardOverlay.appendChild(card);
  cardOverlay.classList.add('open');
  cardOverlay.setAttribute('aria-hidden','false');
  overlayCard=card;
  refreshModalState();
}

function closeCardOverlay(){
  if(!cardOverlay) return;
  cardOverlay.classList.remove('open');
  cardOverlay.setAttribute('aria-hidden','true');
  overlayCard=null;
  cardOverlay.innerHTML='';
  refreshModalState();
}

function markDirty(){
  pendingChanges=true;
  lastSaveResult=null;
  clearTimeout(saveFeedbackTimeout);
  updateSaveButtonState();
}
function clearDirty(){
  pendingChanges=false;
  lastSaveResult=null;
  clearTimeout(saveFeedbackTimeout);
  updateSaveButtonState();
}

function touchDataMetaTimestamp(){
  if(!DATA||typeof DATA!=='object') return;
  const meta=DATA.meta;
  if(meta&&typeof meta==='object'){
    try{
      meta.generated=new Date().toISOString();
    }catch(err){
      /* no-op */
    }
  }
}

async function saveDataJs(options={}){
  const { silent=false, dataJs:customDataJs=null, headers:customHeaders=null, endpoint=SAVE_ENDPOINT }=options;
  if(typeof customDataJs!=='string'){
    touchDataMetaTimestamp();
  }
  const payload=(typeof customDataJs==='string')?customDataJs:('window.DATA = '+JSON.stringify(DATA,null,2)+';');
  const baseHeaders=(SAVE_HEADERS && typeof SAVE_HEADERS==='object')?SAVE_HEADERS:{};
  const extraHeaders=(customHeaders && typeof customHeaders==='object')?customHeaders:{};
  const headers={
    'content-type':'application/json',
    ...baseHeaders,
    ...extraHeaders
  };
  if(!endpoint){
    const err=new Error('Save endpoint not configured.');
    if(!silent){
      window.alert(err.message);
    }
    throw err;
  }
  if(savingData){
    return;
  }
  savingData=true;
  updateSaveButtonState();
  try{
    const response=await fetch(endpoint,{
      method:'POST',
      headers,
      body:JSON.stringify({ dataJs:payload })
    });
    const contentType=response.headers.get('content-type')||'';
    let body=null;
    if(contentType.includes('application/json')){
      try{ body=await response.json(); }
      catch(err){ body=null; }
    }else{
      const text=await response.text();
      body=text?{ message:text }:null;
    }
    if(!response.ok){
      const message=(body&&typeof body==='object' && (body.error||body.message))||response.statusText||'Failed to save data.js.';
      throw new Error(message);
    }
    clearDirty();
    setSaveResult('success');
    const versionForSave=String(Date.now());
    setDataVersion(versionForSave);
    try{
      await refreshDataJsCache({ expectedDataJs:payload, retries:3, retryDelay:800, version:versionForSave });
    }catch(err){
      console.warn('Unable to refresh data.js cache after save', err);
    }
    return body;
  }catch(err){
    console.error('Failed to save data.js', err);
    setSaveResult('error');
    if(!silent){
      const message=(err && err.message)?err.message:String(err);
      window.alert('Failed to save data.js: '+message);
    }
    throw err;
  }finally{
    savingData=false;
    updateSaveButtonState();
  }
}

function showDataLoadError(message){
  if(!emptyEl) return;
  emptyEl.style.display='block';
  emptyEl.innerHTML=message||'Could not load <code>data.js</code>.';
}

function buildDataUrl(version,{cacheBustToken=null}={}){
  const v=(version||'').trim();
  const params=[];
  if(v){
    params.push('v='+encodeURIComponent(v));
  }
  const cbToken=cacheBustToken==null?'' : String(cacheBustToken||'').trim();
  if(cbToken){
    params.push('cb='+encodeURIComponent(cbToken));
  }
  if(params.length){
    return `data.js?${params.join('&')}`;
  }
  return 'data.js';
}

function persistDataVersion(version){
  try{
    if(version){
      localStorage.setItem(DATA_VERSION_KEY, version);
    }else{
      localStorage.removeItem(DATA_VERSION_KEY);
    }
  }catch(err){
    /* no-op */
  }
  try{
    if(version){
      sessionStorage.setItem(DATA_VERSION_KEY, version);
    }else{
      sessionStorage.removeItem(DATA_VERSION_KEY);
    }
  }catch(err){
    /* no-op */
  }
}

function setDataVersion(version){
  dataVersion=version||'';
  window.AL_DATA_VERSION=dataVersion;
  persistDataVersion(dataVersion);
  if(dataScriptEl){
    dataCacheBust=String(Date.now());
    window.AL_DATA_CACHE_BUST=dataCacheBust;
    dataScriptEl.setAttribute('data-version', dataVersion);
    dataScriptEl.setAttribute('data-cache-bust', dataCacheBust);
    const desired=buildDataUrl(dataVersion,{cacheBustToken:dataCacheBust});
    try{
      const absolute=new URL(desired, window.location.href).href;
      if(dataScriptEl.src!==absolute){
        dataScriptEl.src=desired;
      }
    }catch(err){
      dataScriptEl.src=desired;
    }
  }
}

function applyDataJs(text){
  if(typeof text!=='string' || !text.trim()) return;
  try{
    const fn=new Function(text+'\n//# sourceURL=data.js');
    fn();
  }catch(err){
    console.error('Failed to evaluate data.js', err);
    throw err;
  }
  const next=window.DATA||null;
  if(!next || !next.characters){
    throw new Error('DATA missing after applying data.js');
  }
  DATA=next;
  rebuildCharacterOptions({preserveSelection:true});
  filterAndRender();
}

function extractDataPayload(text){
  if(typeof text!=='string') return null;
  const match=text.match(/window\.DATA\s*=\s*(\{[\s\S]*\})\s*;?\s*$/);
  return match && match[1]?match[1]:null;
}

function parseDataPayload(text){
  const payload=extractDataPayload(text);
  if(!payload) return null;
  try{
    return JSON.parse(payload);
  }catch(err){
    return null;
  }
}

function dataPayloadsMatch(a,b){
  const parsedA=parseDataPayload(a);
  const parsedB=parseDataPayload(b);
  if(parsedA && parsedB){
    return JSON.stringify(parsedA)===JSON.stringify(parsedB);
  }
  if(typeof a==='string' && typeof b==='string'){
    return a.trim()===b.trim();
  }
  return false;
}

function wait(ms){
  return new Promise(resolve=>setTimeout(resolve,ms));
}

async function refreshDataJsCache({ expectedDataJs=null, retries=0, retryDelay=500, version=null }={}){
  let attempt=0;
  const pinnedVersion=version?String(version):null;
  while(attempt<=retries){
    const versionToUse=pinnedVersion||String(Date.now());
    const response=await fetch(buildDataUrl(versionToUse,{cacheBustToken:Date.now()}),{ cache:'reload', headers:{ 'cache-control':'no-cache', pragma:'no-cache' } });
    if(!response.ok){
      throw new Error('HTTP '+response.status);
    }
    const text=await response.text();
    if(!expectedDataJs || dataPayloadsMatch(text, expectedDataJs)){
      applyDataJs(text);
      setDataVersion(versionToUse);
      return true;
    }
    if(attempt===retries){
      console.warn('Latest data.js did not match newly saved content; skipping cache refresh to avoid overwriting edits.');
      return false;
    }
    attempt+=1;
    await wait(retryDelay);
  }
}

/* --- character selector (no session counts) --- */
function rebuildCharacterOptions({preserveSelection=true, preferredKey=null}={}){
  if(!charSel) return null;
  const hasData=DATA && DATA.characters && typeof DATA.characters==='object';
  const previousSelection=preserveSelection?charSel.value:null;
  const scrollTop=charSel.scrollTop||0;
  charSel.innerHTML='';
  if(!hasData){
    return null;
  }
  let storedKey=getRememberedCharacterKey();
  if(storedKey && !DATA.characters[storedKey]){
    rememberCharacterKey('');
    storedKey='';
  }
  const entries=Object.entries(DATA.characters).map(([key,obj])=>{
    const sheetName=(obj.sheet||'').toString().trim();
    const displayName=(obj.display_name||'').toString().trim();
    const baseLabel=sheetName||displayName||key;
    const label=(displayName && displayName!==key)?(displayName+(sheetName&&sheetName!==displayName?' ('+sheetName+')':'')):baseLabel;
    const labelText=(label||'').toString().trim()||key;
    const sortValue=(displayName||sheetName||key||'').toString().trim();
    return { key, label:labelText, sortValue };
  }).sort((a,b)=>{
    const cmp=a.sortValue.localeCompare(b.sortValue,undefined,{sensitivity:'base',numeric:true});
    if(cmp!==0) return cmp;
    return a.key.localeCompare(b.key,undefined,{sensitivity:'base',numeric:true});
  });
  entries.forEach(({key,label})=>{
    const opt=document.createElement('option');
    opt.value=key;
    opt.textContent=label;
    charSel.appendChild(opt);
  });
  const candidateKeys=[preferredKey, previousSelection, storedKey];
  let nextKey=null;
  for(const candidate of candidateKeys){
    if(candidate && DATA.characters[candidate]){ nextKey=candidate; break; }
  }
  if(!nextKey){
    nextKey=getMostRecentCharacter();
  }
  if(nextKey){
    charSel.value=nextKey;
    rememberCharacterKey(nextKey);
  }else{
    rememberCharacterKey('');
  }
  if(typeof charSel.scrollTop==='number'){
    charSel.scrollTop=scrollTop;
  }
  return charSel.value||nextKey||null;
}

/* --- utils --- */
function fmtDate(iso){ if(!iso)return'—'; const d=new Date(iso); if(isNaN(d))return String(iso); return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }
function fmtNumber(n,{signed=false}={}){
  if(n==null) return '0';
  const num=Number(n);
  if(!Number.isFinite(num)) return String(n);
  let rounded=Math.round(num*100)/100;
  if(Object.is(rounded,-0)) rounded=0;
  const formatted=rounded.toLocaleString(undefined,{maximumFractionDigits:2});
  if(signed){
    if(rounded===0) return '0';
    if(rounded>0) return '+'+formatted;
  }
  return formatted;
}
function normalizeDisplayValue(val){
  if(val==null) return '';
  if(typeof val==='number'){
    if(!Number.isFinite(val)) return '';
    return String(val);
  }
  const text=String(val).trim();
  if(!text) return '';
  const simple=text.replace(/[\s._\-\/?]/g,'').toLowerCase();
  if(!simple) return '';
  if(simple==='na'||simple==='none'||simple==='null'||simple==='tbd') return '';
  return text;
}
function hasMeaningfulValue(val){
  return normalizeDisplayValue(val)!=='';
}
function pill(label){ const s=document.createElement('span'); s.className='pill'; s.textContent=label; return s; }
function formatRace(value){
  if(!value) return '';
  if(Array.isArray(value)){
    return value.map(formatRace).filter(Boolean).join(' / ');
  }
  if(typeof value==='object'){
    const parts=[];
    if(value.lineage) parts.push(String(value.lineage));
    if(value.race) parts.push(String(value.race));
    if(value.ancestry) parts.push(String(value.ancestry));
    if(value.subrace) parts.push(String(value.subrace));
    if(value.variant) parts.push(String(value.variant));
    if(value.name && !parts.length) parts.push(String(value.name));
    return parts.filter(Boolean).join(' ');
  }
  return String(value);
}
function formatClassEntry(entry){
  if(!entry) return '';
  if(typeof entry==='string') return entry;
  if(typeof entry==='number') return String(entry);
  if(Array.isArray(entry)){
    return entry.map(formatClassEntry).filter(Boolean).join(' / ');
  }
  const parts=[];
  if(entry.name) parts.push(String(entry.name));
  if(entry.subclass) parts.push(String(entry.subclass));
  if(entry.level!=null && entry.level!=='') parts.push(String(entry.level));
  if(entry.title && !parts.length) parts.push(String(entry.title));
  return parts.filter(Boolean).join(' ');
}
function formatClasses(value){
  if(!value) return '';
  if(Array.isArray(value)){
    return value.map(formatClassEntry).filter(Boolean).join(' / ');
  }
  if(typeof value==='object'){
    return formatClassEntry(value);
  }
  return String(value);
}
function collectAvatarNames(obj,key){
  const names=[];
  if(obj){
    if(typeof obj.sheet==='string' && obj.sheet.trim()) names.push(obj.sheet);
    if(typeof obj.display_name==='string' && obj.display_name.trim()) names.push(obj.display_name);
    if(obj.identity && typeof obj.identity.name==='string' && obj.identity.name.trim()) names.push(obj.identity.name);
  }
  if(typeof key==='string' && key.trim()) names.push(key);
  return names
    .map(name=>String(name).trim())
    .filter((value,index,self)=>value && self.indexOf(value)===index);
}
function makeAvatarFileCandidates(name){
  if(!name) return [];
  const trimmed=String(name).trim();
  if(!trimmed) return [];
  const variants=new Set();
  variants.add(trimmed);
  variants.add(trimmed.toLowerCase());
  const dashed=trimmed.replace(/[^a-zA-Z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  if(dashed) variants.add(dashed);
  if(dashed) variants.add(dashed.toLowerCase());
  const collapsed=trimmed.replace(/[^a-zA-Z0-9]+/g,'');
  if(collapsed) variants.add(collapsed);
  if(collapsed) variants.add(collapsed.toLowerCase());
  return Array.from(variants).map(v=>`${v}.png`);
}
function closeAvatarOverlay({returnFocus=true}={}){
  if(!avatarOverlay) return;
  if(!avatarOverlay.classList.contains('open')) return;
  avatarOverlay.classList.remove('open');
  avatarOverlay.setAttribute('aria-hidden','true');
  avatarOverlay.removeAttribute('aria-label');
  document.body.classList.remove('avatar-overlay-open');
  if(avatarEl){
    avatarEl.setAttribute('aria-expanded','false');
  }
  if(avatarPreview){
    avatarPreview.removeAttribute('data-avatar-src');
  }
  if(avatarPreviewImage){
    avatarPreviewImage.removeAttribute('src');
    avatarPreviewImage.setAttribute('alt','Character avatar');
  }
  document.removeEventListener('keydown', onAvatarOverlayKeydown);
  if(returnFocus && avatarEl){
    avatarEl.focus({preventScroll:true});
  }
}

function onAvatarOverlayKeydown(evt){
  if(evt.key==='Escape'){
    evt.preventDefault();
    closeAvatarOverlay();
  }
}

function openAvatarOverlay(){
  if(!avatarEl || !avatarOverlay || !avatarPreview) return;
  if(!avatarEl.classList.contains('has-avatar')) return;
  const src=avatarEl.getAttribute('data-avatar-src');
  if(!src) return;
  avatarPreview.setAttribute('data-avatar-src',src);
  const selectedOption=charSel && charSel.options && charSel.selectedIndex>=0 ? charSel.options[charSel.selectedIndex] : null;
  const optionLabel=selectedOption?selectedOption.textContent.trim():'';
  const label=optionLabel?`${optionLabel} avatar`:'Character avatar';
  if(avatarPreviewImage){
    avatarPreviewImage.src=src;
    avatarPreviewImage.setAttribute('alt',label);
  }
  avatarOverlay.setAttribute('aria-label',label);
  avatarOverlay.classList.add('open');
  avatarOverlay.setAttribute('aria-hidden','false');
  document.body.classList.add('avatar-overlay-open');
  avatarOverlay.focus({preventScroll:true});
  if(avatarEl){
    avatarEl.setAttribute('aria-expanded','true');
  }
  document.addEventListener('keydown', onAvatarOverlayKeydown);
}

if(avatarOverlay){
  avatarOverlay.addEventListener('click',()=>closeAvatarOverlay());
}

function resetAvatar(){
  if(!avatarEl) return;
  avatarEl.removeAttribute('src');
  avatarEl.classList.remove('has-avatar');
  avatarEl.removeAttribute('data-avatar-src');
  avatarEl.alt='Character avatar';
  avatarEl.removeAttribute('role');
  avatarEl.removeAttribute('aria-haspopup');
  avatarEl.removeAttribute('aria-expanded');
  avatarEl.tabIndex=-1;
  closeAvatarOverlay({returnFocus:false});
}
function applyAvatar(path,token){
  if(!avatarEl || token!==avatarLoadToken) return;
  avatarEl.src=path;
  avatarEl.classList.add('has-avatar');
  avatarEl.setAttribute('data-avatar-src',path);
  const selectedOption=charSel && charSel.options && charSel.selectedIndex>=0 ? charSel.options[charSel.selectedIndex] : null;
  const optionLabel=selectedOption?selectedOption.textContent.trim():'';
  const label=optionLabel?`${optionLabel} avatar`:'Character avatar';
  avatarEl.alt=label;
  avatarEl.setAttribute('role','button');
  avatarEl.setAttribute('aria-haspopup','dialog');
  avatarEl.setAttribute('aria-expanded','false');
  avatarEl.tabIndex=0;
}
function updateAvatar(key,obj){
  if(!avatarEl){
    return;
  }
  const names=collectAvatarNames(obj,key);
  if(!names.length){
    avatarLoadToken++;
    resetAvatar();
    return;
  }
  const candidates=[];
  names.forEach(name=>{
    makeAvatarFileCandidates(name).forEach(file=>{
      if(file && !candidates.includes(file)) candidates.push(file);
    });
  });
  if(!candidates.length){
    avatarLoadToken++;
    resetAvatar();
    return;
  }
  const token=++avatarLoadToken;
  resetAvatar();
  const tryNext=(index)=>{
    if(token!==avatarLoadToken) return;
    if(index>=candidates.length){
      resetAvatar();
      return;
    }
    const path=candidates[index];
    if(avatarCache.has(path)){
      if(avatarCache.get(path)){
        applyAvatar(path,token);
      }else{
        tryNext(index+1);
      }
      return;
    }
    const img=new Image();
    img.onload=()=>{
      if(token!==avatarLoadToken) return;
      avatarCache.set(path,true);
      applyAvatar(path,token);
    };
    img.onerror=()=>{
      if(token!==avatarLoadToken) return;
      avatarCache.set(path,false);
      tryNext(index+1);
    };
    img.src=path;
  };
  tryNext(0);
}
function extractCharacterIdentity(obj){
  const identity={race:'',classes:''};
  if(!obj) return identity;
  const sheet=obj.sheet;
  if(sheet && typeof sheet==='object'){
    identity.race = identity.race || formatRace(sheet.race || sheet.ancestry || sheet.lineage);
    identity.classes = identity.classes || formatClasses(sheet.classes || sheet.class || sheet.archetype);
  }
  if((!identity.race || !identity.classes) && Array.isArray(obj.adventures)){
    const source=obj.adventures.find(entry=>entry && typeof entry.character==='object');
    if(source && source.character){
      const ch=source.character;
      identity.race = identity.race || formatRace(ch.race || ch.ancestry || ch.lineage);
      identity.classes = identity.classes || formatClasses(ch.classes || ch.class || ch.archetype);
    }
  }
  if(typeof obj.identity==='object'){
    identity.race = identity.race || formatRace(obj.identity.race || obj.identity.ancestry);
    identity.classes = identity.classes || formatClasses(obj.identity.classes || obj.identity.class);
  }
  return {
    race:identity.race && identity.race.trim()?identity.race.trim():'',
    classes:identity.classes && identity.classes.trim()?identity.classes.trim():''
  };
}
function identityBadge(label,value){
  const chip=document.createElement('span');
  chip.className='identity-badge';
  const labelEl=document.createElement('span');
  labelEl.className='label';
  labelEl.textContent=label;
  const valueEl=document.createElement('span');
  valueEl.className='value';
  valueEl.textContent=value;
  chip.append(labelEl,valueEl);
  return chip;
}
function sanitizeTitle(title){
  if(!title) return '';
  return String(title).replace(/\bdown\s*time\s*activity\b/gi,'').replace(/\s{2,}/g,' ').replace(/^[\s:,.–—-]+|[\s:,.–—-]+$/g,'').trim();
}
function listBox(items){
  const wrap=document.createElement('div'); wrap.className='scrollbox';
  const normalized=Array.isArray(items)?items.map(normalizeDisplayValue).filter(Boolean):[];
  if(!normalized.length){ wrap.innerHTML='<div class="muted">—</div>'; return wrap; }
  normalized.forEach(name=>{ const row=document.createElement('div'); row.className='item'; row.textContent='• '+name; wrap.appendChild(row); });
  return wrap;
}
function getMostRecentCharacter(){
  if(!DATA || !DATA.characters){
    return '';
  }
  let latestKey=null, latestDate=0;
  for (const [key,obj] of Object.entries(DATA.characters)){
    if(!obj.adventures||!obj.adventures.length) continue;
    const maxDate=Math.max(...obj.adventures.map(a=>{ const t=new Date(a.date).getTime(); return isNaN(t)?0:t; }));
    if(maxDate>latestDate){ latestDate=maxDate; latestKey=key; }
  }
  const keys=Object.keys(DATA.characters);
  return latestKey || (keys.length?keys[0]:'');
}
function isActivityEntry(a){ return a && a.kind && a.kind!=='adventure'; }
function netVals(a){ return { gp:(+a.gp_plus||0)-(+a.gp_minus||0), dtd:(+a.dtd_plus||0)-(+a.dtd_minus||0) }; }
function fmtSigned(n){ return fmtNumber(n,{signed:true}); }

/* --- smooth expand/collapse --- */
function isAnimating(card){ return card.dataset.anim==='1'; }
function setAnimating(card,on){ if(on) card.dataset.anim='1'; else delete card.dataset.anim; }
function afterTransition(el,prop,ms,cb){ let done=false; const onEnd=e=>{ if(e.propertyName!==prop||done)return; done=true; el.removeEventListener('transitionend',onEnd); cb(); }; el.addEventListener('transitionend',onEnd); setTimeout(()=>{ if(done)return; done=true; el.removeEventListener('transitionend',onEnd); cb(); },ms); }
function calcCardDuration(px){ if(!px||px<=0) return 220; const dur=200+px*0.35; return Math.round(Math.max(220, Math.min(620, dur))); }
function setCardDuration(bd,px){ const dur=calcCardDuration(px); bd.style.setProperty('--card-dur', dur+'ms'); return dur; }
function clearCardDuration(bd){ bd.style.removeProperty('--card-dur'); }
function expandCard(card){ if(isAnimating(card))return; const bd=card.querySelector('.card-bd'); if(!bd)return; setAnimating(card,true); const start=bd.offsetHeight||0; const target=Math.max(bd.scrollHeight, start); const duration=setCardDuration(bd,target); bd.style.height=start+'px'; bd.style.opacity='0'; card.classList.add('open'); void bd.offsetHeight; requestAnimationFrame(()=>{ bd.style.height=target+'px'; bd.style.opacity='1'; }); afterTransition(bd,'height',duration+100,()=>{ bd.style.height='auto'; clearCardDuration(bd); setAnimating(card,false); columnizeGrid('relayout'); }); }
function collapseCard(card){ if(isAnimating(card))return; const bd=card.querySelector('.card-bd'); if(!bd)return; setAnimating(card,true); const start=bd.offsetHeight||bd.scrollHeight||0; const duration=setCardDuration(bd,start); bd.style.height=start+'px'; bd.style.opacity='1'; void bd.offsetHeight; requestAnimationFrame(()=>{ bd.style.height='0px'; bd.style.opacity='0'; }); afterTransition(bd,'height',duration+100,()=>{ card.classList.remove('open'); clearCardDuration(bd); setAnimating(card,false); columnizeGrid('relayout'); }); }
function toggleCard(card){ card.classList.contains('open')?collapseCard(card):expandCard(card); }

/* --- inventory helpers --- */
function normItemName(s){ return (s||'').trim(); }
function parseAcquisitionName(s){ const t=String(s||'').trim(); const m=t.match(/^\((.*)\)$/); return m?{name:m[1].trim(),acquired:false}:{name:t,acquired:true}; }
function looksLikeLossEntry(entry){ const t=((entry.title||'')+' '+(entry.notes||'')).toLowerCase(); return /trade|traded|sold|gave|gifted|lost|relinquish|transfer/.test(t); }
function collectPermanentInventory(charKey){
  const ch=DATA.characters[charKey]; if(!ch||!ch.adventures) return {kept:[], map:new Map()};
  const entries=ch.adventures.map((adv,index)=>({adv,index})).sort((a,b)=>new Date(a.adv.date||'1900-01-01')-new Date(b.adv.date||'1900-01-01'));
  const keptMap=new Map();
  entries.forEach(({adv,index})=>{
    const items=adv.perm_items||[];
    const isLoss=(adv.kind&&adv.kind!=='adventure')?looksLikeLossEntry(adv):false;
    if(isLoss){
      if(items.length){
        items.forEach(raw=>{
          const cleaned=normItemName(raw.replace(/^\(|\)$/g,''));
          if(!cleaned) return;
          keptMap.delete(cleaned.toLowerCase());
        });
      }else if(adv.notes){
        [...keptMap.values()].forEach(meta=>{
          const regex=new RegExp('\\b'+meta.name.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')+'\\b','i');
          if(regex.test(adv.notes)) keptMap.delete(meta.name.toLowerCase());
        });
      }
      return;
    }
    items.forEach(raw=>{
      const {name,acquired}=parseAcquisitionName(raw);
      const cleaned=normItemName(name);
      if(!cleaned) return;
      const key=cleaned.toLowerCase();
      if(!acquired){
        keptMap.delete(key);
        return;
      }
      keptMap.set(key,{name:cleaned,index,adv});
    });
  });
  const kept=[...keptMap.values()].sort((a,b)=>a.name.localeCompare(b.name));
  return {kept,map:keptMap};
}
function currentLevelFor(charKey){
  const ch=DATA.characters[charKey]; const lvl=1+Math.floor((ch.adventures||[]).reduce((s,a)=>s+(+a.level_plus||0),0)); return Math.max(1,lvl);
}
function activeSlotsFor(level){ if(level<=4)return 1; if(level<=10)return 3; if(level<=16)return 6; return 10; }
function consumableCarrySlotsFor(level){ if(level<=4)return 5; if(level<=16)return 10; return 15; }
function consumableCarryKey(k){ return 'CARRIED_CONS__'+k; }
function loadCarriedConsumables(k){
  try{
    const raw=JSON.parse(localStorage.getItem(consumableCarryKey(k))||'[]');
    if(Array.isArray(raw)) return raw.map(item=>String(item||'').trim()).filter(Boolean);
  }catch(_){ /* ignore */ }
  return [];
}
function saveCarriedConsumables(k,list){
  localStorage.setItem(consumableCarryKey(k),JSON.stringify(Array.isArray(list)?list:[]));
}
function activeKey(k){ return 'ACTIVE_INV__'+k; }
function attuneKey(k){ return 'ATTUNED__'+k; }
function loadActive(k){ try{return JSON.parse(localStorage.getItem(activeKey(k))||'[]')}catch(_){return[]} }
function saveActive(k,a){ localStorage.setItem(activeKey(k),JSON.stringify(a||[])) }
function loadAttuned(k){ try{return JSON.parse(localStorage.getItem(attuneKey(k))||'[]')}catch(_){return[]} }
function saveAttuned(k,a){ localStorage.setItem(attuneKey(k),JSON.stringify(a||[])) }

function parseConsumableName(s){ const t=String(s||'').trim(); const m=t.match(/^\((.*)\)$/); return m?{name:m[1].trim(),acquired:false}:{name:t,acquired:true}; }
function formatConsumableDisplay(raw){
  const original=String(raw||'').trim();
  if(!original) return {label:'',chips:[]};
  let working=original;
  const chips=[];
  const addChip=(chip)=>{ if(!chips.includes(chip)) chips.push(chip); };
  const stripOuterParens=(str)=>{
    let next=String(str||'').trim();
    while(next.startsWith('(') && next.endsWith(')')){
      const inner=next.slice(1,-1).trim();
      if(!inner) break;
      next=inner;
    }
    return next;
  };
  const stripLeadingSeparators=(str)=>String(str||'').replace(/^[\s,:;–—-]+/, '');

  const hasSpellScroll=/spell\s*scroll/i.test(working);
  if(hasSpellScroll){ addChip('Scroll'); }
  else if(/^scrolls?\b/i.test(working)){ addChip('Scroll'); }

  const potionPrefix=/^potion\b/i.test(working);
  if(potionPrefix) addChip('Potion');

  if(!/^spell\s*scrolls?\b/i.test(working)){
    let match;
    if((match=working.match(/^spell\s*\((.+)\)\s*$/i))){
      working=match[1];
    }else if((match=working.match(/^spell\s*(?:of\s+|[:–—-]\s*)(.+)$/i))){
      working=match[1];
    }else if(/^spell\b/i.test(working)){
      working=working.replace(/^spell\b/i,'');
      working=stripLeadingSeparators(working);
    }
  }

  if(/^spell\s*scrolls?\b/i.test(working)){
    working=working.replace(/^spell\s*scrolls?\b/i,'');
    working=stripLeadingSeparators(working);
    if(/^of\s+/i.test(working)) working=working.replace(/^of\s+/i,'');
    working=stripOuterParens(working);
  }else if(/^scrolls?\b/i.test(working)){
    working=working.replace(/^scrolls?\b/i,'');
    working=stripLeadingSeparators(working);
    if(/^of\s+/i.test(working)) working=working.replace(/^of\s+/i,'');
    working=stripOuterParens(working);
  }

  if(potionPrefix || /^potion\b/i.test(working)){
    working=working.replace(/^potion\b/i,'');
    working=stripLeadingSeparators(working);
    if(/^of\s+/i.test(working)) working=working.replace(/^of\s+/i,'');
    working=stripOuterParens(working);
  }

  working=stripOuterParens(working).trim();
  if(!working) working=original;
  return {label:working,chips};
}
function deriveConsumableInventory(charKey){
  const ch=DATA.characters[charKey]; if (!ch || !ch.adventures) return new Map();
  const sorted=[...ch.adventures].sort((a,b)=>new Date(a.date||'1900-01-01')-new Date(b.date||'1900-01-01'));
  const counts=new Map();
  const add=(n,k=1)=>{ n=n.trim(); if(!n) return; counts.set(n,(counts.get(n)||0)+k); };
  const sub=(n,k=1)=>{ n=n.trim(); if(!n) return; const cur=(counts.get(n)||0)-k; counts.set(n,Math.max(0,cur)); if(counts.get(n)===0) counts.delete(n); };
  sorted.forEach(e=>{
    const items=e.consumable_items||[];
    const isLoss=(e.kind&&e.kind!=='adventure')?looksLikeLossEntry(e):false;
    if(isLoss){
      if(items.length) items.forEach(raw=>sub(raw.replace(/^\(|\)$/g,'')));
      else if(e.notes){ [...counts.keys()].forEach(name=>{ if(new RegExp('\\b'+name.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')+'\\b','i').test(e.notes)) sub(name); }); }
      return;
    }
    items.forEach(raw=>{ const {name,acquired}=parseConsumableName(raw); if(acquired) add(name); });
  });
  return counts;
}
function getConsumableUseMap(charKey){
  const ch=DATA.characters[charKey];
  const uses=new Map();
  const rawUses=ch&&typeof ch.consumable_uses==='object'&&ch.consumable_uses;
  if(!rawUses) return uses;
  Object.entries(rawUses).forEach(([name,val])=>{
    const count=Math.max(0,Number(val)||0);
    if(count>0) uses.set(name,count);
  });
  return uses;
}
function buildConsumableInventory(charKey){
  const base=deriveConsumableInventory(charKey);
  const ch=DATA.characters[charKey];
  const manual=(ch&&typeof ch.consumables==='object'&&ch.consumables)?ch.consumables:null;
  if(manual){
    Object.entries(manual).forEach(([name,val])=>{
      const num=Math.max(0,Number(val)||0);
      if(num>0) base.set(name,num);
      else base.delete(name);
    });
  }
  const uses=getConsumableUseMap(charKey);
  uses.forEach((used,name)=>{
    if(!base.has(name)) return;
    const remaining=Math.max(0,(base.get(name)||0)-used);
    if(remaining>0) base.set(name,remaining);
    else base.delete(name);
  });
  return base;
}
function incrementConsumableUse(charKey,name){
  const ch=DATA.characters[charKey];
  if(!ch) return false;
  const baseCount=(deriveConsumableInventory(charKey).get(name)||0);
  let total=baseCount;
  if(ch.consumables&&typeof ch.consumables==='object'&&Object.prototype.hasOwnProperty.call(ch.consumables,name)){
    const manualCount=Math.max(0,Number(ch.consumables[name])||0);
    total=manualCount;
  }
  if(total<=0) return false;
  const uses=getConsumableUseMap(charKey);
  const used=uses.get(name)||0;
  if(used>=total) return false;
  if(!ch.consumable_uses||typeof ch.consumable_uses!=='object') ch.consumable_uses={};
  const next=used+1;
  ch.consumable_uses[name]=next;
  if(ch.consumable_uses[name]<=0) delete ch.consumable_uses[name];
  if(ch.consumable_uses && !Object.keys(ch.consumable_uses).length) delete ch.consumable_uses;
  markDirty();
  applyDataMutation(charKey);
  return true;
}

/* --- inventory modal UI --- */
const invModal=document.getElementById('invModal');
const invTitle=document.getElementById('invTitle');
const invMeta=document.getElementById('invMeta');
const invList=document.getElementById('invList');
const invSummary=document.getElementById('invSummary');
const consModal=document.getElementById('consModal');
const consTitle=document.getElementById('consTitle');
const consMeta=document.getElementById('consMeta');
const consList=document.getElementById('consList');
const consSummary=document.getElementById('consSummary');
document.getElementById('invClose').addEventListener('click',()=>{ invModal.classList.remove('open','editing'); refreshModalState(); });
function closeConsumableModal(){
  consModal.classList.remove('open','editing');
  refreshModalState();
}
document.getElementById('consClose').addEventListener('click',closeConsumableModal);
invModal.addEventListener('click',(e)=>{ if(e.target===invModal){ invModal.classList.remove('open','editing'); refreshModalState(); } });
consModal.addEventListener('click',(e)=>{ if(e.target===consModal) closeConsumableModal(); });

function openInventoryModal(charKey, opts={}){
  const ch=DATA.characters[charKey];
  const level=currentLevelFor(charKey);
  const cap=activeSlotsFor(level);
  const {kept:keptMeta}=collectPermanentInventory(charKey);
  const keptNames=keptMeta.map(item=>item.name);
  let active=loadActive(charKey).filter(n=>keptNames.some(k=>k.toLowerCase()===n.toLowerCase()));
  let attuned=loadAttuned(charKey).filter(n=>keptNames.some(k=>k.toLowerCase()===n.toLowerCase()));
  if(active.length>cap) active=active.slice(0,cap);
  if(attuned.length>3) attuned=attuned.slice(0,3);

  invTitle.textContent=(ch.display_name||ch.sheet||'Character')+' — Permanent Items';
  invMeta.textContent=`Level ${level} • Active slots: ${cap} • Attunement max: 3`;

  const activeSet=new Set(active.map(a=>a.toLowerCase()));
  const attunedSet=new Set(attuned.map(a=>a.toLowerCase()));
  const metaByName=new Map(keptMeta.map(item=>[item.name.toLowerCase(),item]));
  const activeOrdered=active
    .map(name=>metaByName.get(name.toLowerCase()))
    .filter(Boolean)
    .sort((a,b)=>a.name.localeCompare(b.name,undefined,{sensitivity:'base'}));
  const rest=keptMeta
    .filter(item=>!activeSet.has(item.name.toLowerCase()))
    .sort((a,b)=>a.name.localeCompare(b.name,undefined,{sensitivity:'base'}));
  const ordered=activeOrdered.concat(rest);

  invList.innerHTML='';
  const actions=invModal.querySelector('.modal-actions');
  let editToggle=actions?actions.querySelector('.edit-toggle'):null;
  if(actions && !editToggle){
    editToggle=document.createElement('button');
    editToggle.type='button';
    editToggle.className='btn small edit-toggle';
    editToggle.textContent='Edit items';
    editToggle.setAttribute('aria-pressed','false');
    editToggle.style.marginRight='auto';
    actions.insertBefore(editToggle, actions.firstChild);
  }
  let editing=!!(opts && opts.editing);
  if(!ordered.length){ editing=false; }
  function syncEditing(){
    const activeEditing=editing && ordered.length>0;
    invModal.classList.toggle('editing', activeEditing);
    if(editToggle){
      editToggle.textContent=activeEditing?'Done':'Edit items';
      editToggle.setAttribute('aria-pressed', activeEditing?'true':'false');
    }
  }
  if(editToggle){
    editToggle.onclick=()=>{
      if(!ordered.length) return;
      openInventoryModal(charKey,{editing:!editing});
    };
    editToggle.style.display=ordered.length?'':'none';
  }

  ordered.forEach(item=>{
    const label=item&&item.name?item.name:String(item||'');
    const lower=label.toLowerCase();
    const isActive=activeSet.has(lower);
    const row=document.createElement('div');
    row.className='inv-row'+(isActive?' active':'');
    row.dataset.name=label;

    const nameDiv=document.createElement('div');
    nameDiv.className='inv-name';
    nameDiv.textContent=label;

    const rightDiv=document.createElement('div');
    rightDiv.className='inv-tools';
    if(isActive){
      const pill=document.createElement('span');
      pill.className='attune-pill'+(attunedSet.has(lower)?' on':'');
      pill.textContent=attunedSet.has(lower)?'Attuned':'Attune';
      pill.title='Toggle attunement (max 3)';
      pill.addEventListener('click',(ev)=>{
        if(editing) return;
        ev.stopPropagation();
        let cur=loadAttuned(charKey).filter(n=>keptNames.some(k=>k.toLowerCase()===n.toLowerCase()));
        const on=attunedSet.has(lower);
        if(!on){
          if(cur.length>=3){ alert('You can only be attuned to 3 items at a time.'); return; }
          cur.push(label);
        }else{
          cur=cur.filter(n=>n.toLowerCase()!==lower);
        }
        saveAttuned(charKey,cur);
        openInventoryModal(charKey,{editing});
      });
      rightDiv.appendChild(pill);
    }

    const deleteBtn=document.createElement('button');
    deleteBtn.type='button';
    deleteBtn.className='icon-btn danger delete-btn';
    deleteBtn.innerHTML=ICON_TRASH;
    deleteBtn.setAttribute('aria-label',`Remove ${label}`);
    deleteBtn.title='Remove this item';
    deleteBtn.addEventListener('click',(ev)=>{
      ev.stopPropagation();
      if(!window.confirm(`Remove "${label}" from permanent items?`)) return;
      const adv=item&&item.adv;
      if(adv){
        const lowerName=lower;
        const source=Array.isArray(adv.perm_items)?adv.perm_items:[];
        adv.perm_items=source.filter(raw=>{
          const parsed=parseAcquisitionName(raw);
          const cleaned=normItemName(parsed.name).toLowerCase();
          return cleaned!==lowerName;
        });
      }
      const lc=lower;
      saveActive(charKey, loadActive(charKey).filter(n=>n.toLowerCase()!==lc));
      saveAttuned(charKey, loadAttuned(charKey).filter(n=>n.toLowerCase()!==lc));
      markDirty();
      applyDataMutation(charKey);
      openInventoryModal(charKey,{editing:true});
    });
    rightDiv.appendChild(deleteBtn);

    row.appendChild(nameDiv);
    row.appendChild(rightDiv);

    row.addEventListener('click',()=>{
      if(editing) return;
      let cur=loadActive(charKey).filter(n=>keptNames.some(k=>k.toLowerCase()===n.toLowerCase()));
      const on=cur.some(n=>n.toLowerCase()===lower);
      if(!on){
        if(cur.length>=cap){ alert(`You can only have ${cap} active item${cap>1?'s':''} at level ${level}.`); return; }
        cur.push(label);
      }else{
        cur=cur.filter(n=>n.toLowerCase()!==lower);
        saveAttuned(charKey, loadAttuned(charKey).filter(n=>n.toLowerCase()!==lower));
      }
      saveActive(charKey,cur);
      openInventoryModal(charKey,{editing});
    });

    invList.appendChild(row);
  });

  syncEditing();

  function updateSummary(){
    const aCount=loadActive(charKey).length;
    const tCount=loadAttuned(charKey).length;
    invSummary.textContent=`Kept: ${keptMeta.length} • Active: ${aCount}/${cap} • Attuned: ${tCount}/3`;
  }
  updateSummary();
  invModal.classList.add('open');
  refreshModalState();
}


function openConsumableModal(charKey){
  const ch=DATA.characters[charKey];
  const level=currentLevelFor(charKey);
  const carryCap=consumableCarrySlotsFor(level);
  let baseCounts=deriveConsumableInventory(charKey);
  let counts=buildConsumableInventory(charKey);
  const reloadData=()=>{
    baseCounts=deriveConsumableInventory(charKey);
    counts=buildConsumableInventory(charKey);
  };
  const hasBaseInventory=()=>Array.from(baseCounts.values()).some(val=>val>0);

  consTitle.textContent=(ch.display_name||ch.sheet||'Character')+' — Consumables';
  consMeta.textContent=`Level ${level} • Carry limit: ${carryCap}`;
  consList.innerHTML='';

  let lastBaseSummary='';
  let summaryNote='';
  const applySummary=()=>{
    if(summaryNote){
      if(lastBaseSummary) consSummary.textContent=`${lastBaseSummary} • ${summaryNote}`;
      else consSummary.textContent=summaryNote;
    }else{
      consSummary.textContent=lastBaseSummary;
    }
  };
  const setSummaryNote=(msg)=>{
    summaryNote=msg||'';
    applySummary();
  };
  setSummaryNote('');

  const state={carriedList:[],carriedCounts:new Map()};
  const rawCarried=loadCarriedConsumables(charKey);
  rawCarried.forEach(item=>{
    const name=String(item||'').trim();
    if(name) state.carriedList.push(name);
  });

  const sanitizeCarried=()=>{
    const next=[];
    const usage=new Map();
    let changed=false;
    state.carriedList.forEach(name=>{
      if(!counts.has(name)){
        changed=true;
        return;
      }
      const total=counts.get(name)||0;
      const current=usage.get(name)||0;
      if(current>=total){
        changed=true;
        return;
      }
      usage.set(name,current+1);
      next.push(name);
    });
    if(changed || next.length!==state.carriedList.length){
      saveCarriedConsumables(charKey,next);
    }
    state.carriedList=next;
    state.carriedCounts=usage;
  };

  const totalCarried=()=>state.carriedList.length;
  const slotsFree=()=>Math.max(0,carryCap-totalCarried());
  const totalInventoryCopies=()=>Array.from(counts.values()).reduce((sum,val)=>sum+val,0);
  const totalStowedCopies=()=>Array.from(counts.entries()).reduce((sum,[name,total])=>{
    const carried=state.carriedCounts.get(name)||0;
    return sum+Math.max(0,total-carried);
  },0);

  const buildNameDiv=(name)=>{
    const nameDiv=document.createElement('div');
    nameDiv.className='inv-name consumable-name';
    const {label:displayLabel,chips}=formatConsumableDisplay(name);
    const primary=document.createElement('div');
    primary.className='cons-primary';
    const labelSpan=document.createElement('span');
    labelSpan.className='cons-name';
    labelSpan.textContent=displayLabel||name;
    primary.appendChild(labelSpan);
    if(Array.isArray(chips) && chips.length){
      const chipWrap=document.createElement('span');
      chipWrap.className='cons-chips';
      chips.forEach(chip=>{
        const chipEl=document.createElement('span');
        chipEl.className='cons-chip';
        const slug=chip.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
        if(slug){ chipEl.classList.add(`cons-chip--${slug}`); }
        chipEl.textContent=chip;
        chipWrap.appendChild(chipEl);
      });
      primary.appendChild(chipWrap);
    }
    nameDiv.appendChild(primary);
    return {element:nameDiv,label:labelSpan.textContent};
  };

  const createSection=(title)=>{
    const section=document.createElement('section');
    section.className='cons-section';
    const heading=document.createElement('div');
    heading.className='cons-section-title';
    heading.textContent=title;
    const list=document.createElement('div');
    list.className='cons-sublist';
    section.appendChild(heading);
    section.appendChild(list);
    return {section,list};
  };

  const addCarry=(name,{toFront=true}={})=>{
    const total=counts.get(name)||0;
    const carried=state.carriedCounts.get(name)||0;
    if(total<=carried) return false;
    if(totalCarried()>=carryCap){
      window.alert(`You can only carry ${carryCap} consumable${carryCap===1?'':'s'} at level ${level}.`);
      return false;
    }
    if(toFront) state.carriedList.unshift(name);
    else state.carriedList.push(name);
    saveCarriedConsumables(charKey,state.carriedList);
    setSummaryNote('');
    renderView();
    return true;
  };

  const removeCarry=(name)=>{
    const idx=state.carriedList.indexOf(name);
    if(idx===-1) return false;
    state.carriedList.splice(idx,1);
    saveCarriedConsumables(charKey,state.carriedList);
    setSummaryNote('');
    renderView();
    return true;
  };

  const renderView=()=>{
    reloadData();
    sanitizeCarried();
    consList.innerHTML='';

    if(!hasBaseInventory()){
      lastBaseSummary='No consumables tracked yet.';
      applySummary();
      const empty=document.createElement('div');
      empty.className='muted';
      empty.textContent='No consumables tracked yet.';
      consList.appendChild(empty);
      return;
    }

    const inventoryTotal=totalInventoryCopies();
    if(inventoryTotal<=0){
      lastBaseSummary='No consumables remaining.';
      applySummary();
      const empty=document.createElement('div');
      empty.className='muted';
      empty.textContent='All consumables have been used.';
      consList.appendChild(empty);
      return;
    }

    const carriedTotal=totalCarried();
    const free=slotsFree();
    const stowed=totalStowedCopies();
    const summaryParts=[`Carried: ${carriedTotal}/${carryCap}`];
    summaryParts.push(free>0?`${free} slot${free===1?'':'s'} free`:'Carry limit reached');
    summaryParts.push(`${inventoryTotal} total remaining`);
    if(stowed>0) summaryParts.push(`${stowed} stowed`);
    lastBaseSummary=summaryParts.join(' • ');
    applySummary();

    const carriedSection=createSection('Carried');
    const carriedOrdered=[];
    const seen=new Set();
    state.carriedList.forEach(name=>{ if(!seen.has(name)){ seen.add(name); carriedOrdered.push(name); } });
    carriedOrdered.sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));
    if(carriedOrdered.length){
      carriedOrdered.forEach(name=>{
        const total=counts.get(name)||0;
        const carried=state.carriedCounts.get(name)||0;
        const remaining=Math.max(0,total-carried);
        const row=document.createElement('div');
        row.className='inv-row active';
        row.style.cursor='default';
        row.dataset.name=name;
        const {element:nameDiv,label:displayLabel}=buildNameDiv(name);
        const secondary=document.createElement('span');
        secondary.className='cons-secondary';
        secondary.textContent=`Carried ${carried} of ${total}`+(remaining>0?` • ${remaining} stowed`:'');
        nameDiv.appendChild(secondary);
        row.appendChild(nameDiv);

        const tools=document.createElement('div');
        tools.className='inv-tools';

        const qtyDiv=document.createElement('div');
        qtyDiv.className='qty';

        const minus=document.createElement('span');
        minus.className='qty-icon'+(carried<=0?' disabled':'');
        minus.innerHTML=ICON_MINUS;
        minus.setAttribute('role','button');
        minus.setAttribute('aria-label',`Stow one ${name}`);
        minus.tabIndex=0;
        minus.setAttribute('aria-disabled',carried<=0?'true':'false');

        const pill=document.createElement('span');
        pill.className='qty-pill';
        pill.textContent=String(carried);

        const plus=document.createElement('span');
        const canIncrease=remaining>0 && free>0;
        plus.className='qty-icon'+(canIncrease?'':' disabled');
        plus.innerHTML=ICON_PLUS;
        plus.setAttribute('role','button');
        plus.setAttribute('aria-label',`Carry one more ${name}`);
        plus.tabIndex=0;
        plus.setAttribute('aria-disabled',canIncrease?'false':'true');

        const handleAdjust=(delta)=>(ev)=>{
          if(ev.type==='keydown' && ev.key!=='Enter' && ev.key!==' ' && ev.key!=='Spacebar'){ return; }
          ev.preventDefault();
          ev.stopPropagation();
          if(delta<0){
            if(carried>0) removeCarry(name);
          }else{
            addCarry(name,{toFront:false});
          }
        };

        minus.addEventListener('click',handleAdjust(-1));
        minus.addEventListener('keydown',handleAdjust(-1));
        plus.addEventListener('click',handleAdjust(1));
        plus.addEventListener('keydown',handleAdjust(1));

        qtyDiv.appendChild(minus);
        qtyDiv.appendChild(pill);
        qtyDiv.appendChild(plus);
        tools.appendChild(qtyDiv);

        const useBtn=document.createElement('button');
        useBtn.type='button';
        useBtn.className='btn small danger cons-use-btn';
        useBtn.textContent='Use';
        useBtn.disabled=total<=0;
        const handleUse=(ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          const success=incrementConsumableUse(charKey,name);
          if(!success){
            window.alert(`No ${displayLabel} remaining to use.`);
            return;
          }
          const idx=state.carriedList.indexOf(name);
          if(idx!==-1){
            state.carriedList.splice(idx,1);
            saveCarriedConsumables(charKey,state.carriedList);
          }
          setSummaryNote(`Used one ${displayLabel}. Remember to save data.js.`);
          renderView();
        };
        useBtn.addEventListener('click',handleUse);
        tools.appendChild(useBtn);

        row.appendChild(tools);
        carriedSection.list.appendChild(row);
      });
    }else{
      const empty=document.createElement('div');
      empty.className='muted';
      empty.style.padding='4px 8px';
      empty.textContent='Not carrying any consumables.';
      carriedSection.list.appendChild(empty);
    }
    consList.appendChild(carriedSection.section);

    const availableSection=createSection('Stowed');
    const availableNames=Array.from(counts.keys()).filter(name=>{
      const total=counts.get(name)||0;
      const carried=state.carriedCounts.get(name)||0;
      return total-carried>0;
    }).sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));
    if(availableNames.length){
      availableNames.forEach(name=>{
        const total=counts.get(name)||0;
        const carried=state.carriedCounts.get(name)||0;
        const remaining=Math.max(0,total-carried);
        const row=document.createElement('div');
        row.className='inv-row';
        row.setAttribute('role','button');
        row.tabIndex=0;
        row.title='Click to carry one copy';
        const {element:nameDiv}=buildNameDiv(name);
        const secondary=document.createElement('span');
        secondary.className='cons-secondary';
        secondary.textContent=`${remaining} available${total!==remaining?` • ${total} total`:''}`;
        nameDiv.appendChild(secondary);
        row.appendChild(nameDiv);

        const tools=document.createElement('div');
        tools.className='inv-tools';
        const qtyDiv=document.createElement('div');
        qtyDiv.className='qty';
        const pill=document.createElement('span');
        pill.className='qty-pill';
        pill.textContent=String(remaining);
        qtyDiv.appendChild(pill);
        tools.appendChild(qtyDiv);
        row.appendChild(tools);

        const activate=(ev)=>{
          if(ev.type==='keydown' && ev.key!=='Enter' && ev.key!==' ' && ev.key!=='Spacebar'){ return; }
          ev.preventDefault();
          ev.stopPropagation();
          addCarry(name,{toFront:true});
        };
        row.addEventListener('click',activate);
        row.addEventListener('keydown',activate);
        availableSection.list.appendChild(row);
      });
    }else{
      const empty=document.createElement('div');
      empty.className='muted';
      empty.style.padding='4px 8px';
      empty.textContent='No consumables stowed.';
      availableSection.list.appendChild(empty);
    }
    consList.appendChild(availableSection.section);
  };

  renderView();
  consModal.classList.add('open');
  refreshModalState();
}

/* --- cards --- */
function makeCard(a,idx){
  const act=isActivityEntry(a); const {gp,dtd}=netVals(a);
  const card=document.createElement('article'); card.className='card'+(act?' activity':''); card.dataset.idx=String(idx);
  card.__dataRef=a;

  const hd=document.createElement('div'); hd.className='card-hd';
  const main=document.createElement('div');
  let titleEditorSlot=null, titleDisplayEl=null;
  let dateEditorSlot=null, dateDisplayEl=null;
  let codeEditorSlot=null, codeDisplayEl=null;
  let codeFieldView=null;
  if(act){
    main.className='activity-line';
    const left=document.createElement('div'); left.className='activity-left';
    const dateSpan=document.createElement('span'); dateSpan.className='activity-date editable-inline';
    const actDateDisplay=document.createElement('span'); actDateDisplay.className='display'; actDateDisplay.textContent=fmtDate(a.date);
    const actDateEditor=document.createElement('span'); actDateEditor.className='editor';
    dateSpan.append(actDateDisplay,actDateEditor); dateSpan.__display=actDateDisplay; dateSpan.__editor=actDateEditor;
    dateEditorSlot=actDateEditor; dateDisplayEl=actDateDisplay;
    const nameSpan=document.createElement('span'); nameSpan.className='activity-name editable-inline';
    const actNameDisplay=document.createElement('span'); actNameDisplay.className='display'; actNameDisplay.textContent=sanitizeTitle(a.title||'Activity');
    const actNameEditor=document.createElement('span'); actNameEditor.className='editor';
    nameSpan.append(actNameDisplay,actNameEditor); nameSpan.__display=actNameDisplay; nameSpan.__editor=actNameEditor;
    titleEditorSlot=actNameEditor; titleDisplayEl=actNameDisplay;
    left.appendChild(dateSpan); left.appendChild(nameSpan);
    const chips=document.createElement('div'); chips.className='chips';
    if(gp){ const p=pill('GP '+fmtSigned(gp)); p.classList.add('muted'); chips.appendChild(p); }
    if(dtd){ const p=pill('DTD '+fmtSigned(dtd)); p.classList.add('muted'); chips.appendChild(p); }
    main.appendChild(left); main.appendChild(chips);
  }else{
    main.className='titleLine';
    const dateDiv=document.createElement('div'); dateDiv.className='date editable-inline';
    const dateDisplay=document.createElement('span'); dateDisplay.className='display'; dateDisplay.textContent=fmtDate(a.date);
    const dateEditor=document.createElement('span'); dateEditor.className='editor';
    dateDiv.append(dateDisplay,dateEditor); dateDiv.__display=dateDisplay; dateDiv.__editor=dateEditor;
    dateEditorSlot=dateEditor; dateDisplayEl=dateDisplay;
    const titleDiv=document.createElement('div'); titleDiv.className='title editable-inline';
    const titleDisplay=document.createElement('span'); titleDisplay.className='display'; titleDisplay.textContent=sanitizeTitle(a.title||'Untitled Adventure');
    const titleEditor=document.createElement('span'); titleEditor.className='editor';
    titleDiv.append(titleDisplay,titleEditor); titleDiv.__display=titleDisplay; titleDiv.__editor=titleEditor;
    titleEditorSlot=titleEditor; titleDisplayEl=titleDisplay;
    const subtitleDiv=document.createElement('div'); subtitleDiv.className='subtitle editable-inline';
    const subtitleDisplay=document.createElement('span'); subtitleDisplay.className='display'; subtitleDisplay.textContent=a.code||'';
    const subtitleEditor=document.createElement('span'); subtitleEditor.className='editor';
    subtitleDiv.append(subtitleDisplay,subtitleEditor); subtitleDiv.__display=subtitleDisplay; subtitleDiv.__editor=subtitleEditor;
    codeEditorSlot=subtitleEditor; codeDisplayEl=subtitleDisplay;
    const chips=document.createElement('div'); chips.className='chips';
    const netGP=(a.gp_net==null?gp:a.gp_net);
    chips.appendChild(pill('GP '+fmtSigned(Number(netGP))));
    const subtitleRow=document.createElement('div'); subtitleRow.className='subtitle-row';
    subtitleRow.appendChild(subtitleDiv);
    subtitleRow.appendChild(chips);
    main.appendChild(dateDiv);
    main.appendChild(titleDiv);
    main.appendChild(subtitleRow);
  }
  hd.appendChild(main);

  const tools=document.createElement('div'); tools.className='card-tools';
  const editBtn=document.createElement('button');
  editBtn.type='button';
  editBtn.className='icon-btn';
  editBtn.setAttribute('aria-label','Toggle edit mode');
  editBtn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.1 5.1 5 12.2V19h6.8l7.1-7.1-6.8-6.8Z"/><path d="M3 21h18"/></svg>';
  editBtn.title='Edit entry';
  editBtn.addEventListener('click',(ev)=>{
    ev.stopPropagation();
    if(card.classList.contains('editing')){
      exitEditMode(card);
    }else{
      enterEditMode(card);
    }
  });
  tools.appendChild(editBtn);
  hd.appendChild(tools);

  hd.addEventListener('click',(ev)=>{ if(card.classList.contains('editing')) return; toggleCard(card); });

  const bd=document.createElement('div'); bd.className='card-bd';
  const view=document.createElement('div'); view.className='bd-in';
  view.innerHTML='';

  function makeValue(val, empty='—'){
    const text=normalizeDisplayValue(val);
    return text?text:empty;
  }

  function makeKVS(label,value){
    const cell=document.createElement('div');
    cell.className='kvsingle';
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v';
    const display=document.createElement('div'); display.className='display'; display.textContent=value;
    const editor=document.createElement('div'); editor.className='editor';
    v.appendChild(display); v.appendChild(editor);
    cell.appendChild(k); cell.appendChild(v);
    cell.__display=display;
    cell.__editor=editor;
    return cell;
  }

  function appendField(label, content, extraClass){
    const field=document.createElement('div');
    field.className='field'+(extraClass?(' '+extraClass):'');
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v';
    const display=document.createElement('div'); display.className='display';
    if(content instanceof Node){ display.appendChild(content); }
    else{ display.textContent=makeValue(content); }
    const editor=document.createElement('div'); editor.className='editor';
    v.appendChild(display); v.appendChild(editor);
    field.appendChild(k); field.appendChild(v);
    view.appendChild(field);
    field.__display=display;
    field.__editor=editor;
    return field;
  }

  const gpRowView=document.createElement('div'); gpRowView.className='kv2';
  const gpEarn=Number(a.gp_plus??0);
  const gpEarnCell=makeKVS('Gold earned', fmtNumber(gpEarn)); gpRowView.appendChild(gpEarnCell);
  const gpSpend=Number(a.gp_minus??0);
  const gpSpendCell=makeKVS('Gold spent', fmtNumber(gpSpend)); gpRowView.appendChild(gpSpendCell);
  const showGpEarn=(!act || gpEarn!==0);
  const showGpSpend=(!act || gpSpend!==0);
  gpEarnCell.style.display=showGpEarn?'':'none';
  gpSpendCell.style.display=showGpSpend?'':'none';
  if(!(showGpEarn||showGpSpend)){ gpRowView.style.display='none'; }
  view.appendChild(gpRowView);

  const dtRowView=document.createElement('div'); dtRowView.className='kv2';
  const dtEarnVal=Number(a.dtd_plus??0);
  const dtEarnCell=makeKVS('Downtime earned', fmtNumber(dtEarnVal)); dtRowView.appendChild(dtEarnCell);
  const dtSpendVal=Number(a.dtd_minus??0);
  const dtSpendCell=makeKVS('Downtime spent', fmtNumber(dtSpendVal)); dtRowView.appendChild(dtSpendCell);
  const showDtEarn=(!act || dtEarnVal!==0);
  const showDtSpend=(!act || dtSpendVal!==0);
  dtEarnCell.style.display=showDtEarn?'':'none';
  dtSpendCell.style.display=showDtSpend?'':'none';
  if(!(showDtEarn||showDtSpend)){ dtRowView.style.display='none'; }
  view.appendChild(dtRowView);

  const lvlVal=Number(a.level_plus||0);
  const levelField=makeKVS('Levels gained', fmtNumber(lvlVal));
  const showLevel=(!act && lvlVal) || (act && lvlVal!==0);
  if(!showLevel){ levelField.style.display='none'; }
  view.appendChild(levelField);

  const hasTradeMeta = act && (('itemTraded' in a) || ('itemReceived' in a));
  const dmDisplay=normalizeDisplayValue(a.dm);
  const playerRaw=normalizeDisplayValue(a.player);
  const characterDisplay=normalizeDisplayValue(a.character);
  const tradePlayer=hasTradeMeta?(playerRaw||dmDisplay):playerRaw;
  const usedDmAsPlayer=hasTradeMeta && !playerRaw && !!dmDisplay && tradePlayer===dmDisplay;

  const kindField=appendField('Entry type', act?'Downtime Activity':'Adventure');
  kindField.classList.add('show-when-editing');
  kindField.style.display='none';

  if(act){
    codeFieldView=appendField('Adventure Code', a.code||'');
    codeFieldView.classList.add('show-when-editing');
    if(!(a.code||'').trim()){ codeFieldView.style.display='none'; }
  }

  const dmField=makeKVS('DM', dmDisplay||'—');
  const showDM=!act || (dmDisplay && !usedDmAsPlayer);
  if(!showDM){ dmField.style.display='none'; }
  view.appendChild(dmField);

  if(hasTradeMeta){
    const tradedAway=normalizeDisplayValue(a.itemTraded);
    const received=normalizeDisplayValue(a.itemReceived);
    if(tradedAway){ appendField('Item traded away', tradedAway); }
    if(received){ appendField('Item received', received); }
    if(tradePlayer || characterDisplay){
      const metaRow=document.createElement('div');
      metaRow.className='kv2';
      if(tradePlayer){ metaRow.appendChild(makeKVS('Player', tradePlayer)); }
      if(characterDisplay){ metaRow.appendChild(makeKVS('Character', characterDisplay)); }
      if(metaRow.children.length){ view.appendChild(metaRow); }
    }
  }

  let tradedItemField=null;
  if(!hasTradeMeta && act){
    const tradedItem=normalizeDisplayValue(a.traded_item);
    tradedItemField=appendField('Item traded away', tradedItem);
    if(!tradedItem){ tradedItemField.style.display='none'; }
  }

  const hasPermItems=Array.isArray(a.perm_items)&&a.perm_items.some(item=>hasMeaningfulValue(item));
  const permField=appendField('Magic Items', listBox(a.perm_items),'mi');
  const showPerm=(!act || (!hasTradeMeta && hasPermItems));
  if(!showPerm){ permField.style.display='none'; }
  const hasConsumables=Array.isArray(a.consumable_items)&&a.consumable_items.some(item=>hasMeaningfulValue(item));
  const consField=appendField('Consumables', listBox(a.consumable_items),'cons');
  const showCons=(!act || hasConsumables);
  if(!showCons){ consField.style.display='none'; }
  const noteText=normalizeDisplayValue(a.notes);
  const notesBox=document.createElement('div');
  notesBox.className='notesbox';
  notesBox.textContent=noteText||'—';
  const notesField=appendField('Notes', notesBox);
  const showNotes=(!hasTradeMeta && (!act || noteText));
  if(!showNotes){ notesField.style.display='none'; }

  const formWrap=document.createElement('div'); formWrap.className='edit-form';
  const form=document.createElement('form');
  form.addEventListener('submit',async(ev)=>{ ev.preventDefault(); await saveCardChanges(card); });
  formWrap.appendChild(form);

  const controls={};
  function addField(label, element){
    const field=document.createElement('div'); field.className='field';
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v'; v.appendChild(element);
    field.appendChild(k); field.appendChild(v);
    form.appendChild(field);
    return element;
  }
  function makeInput(type){ const input=document.createElement('input'); input.type=type; if(type==='number'){ input.step='any'; } return input; }
  function makeTextarea(){ const t=document.createElement('textarea'); return t; }

  controls.title=addField('Title', makeInput('text'));
  controls.date=addField('Date', makeInput('date'));
  controls.code=addField('Code', makeInput('text'));
  controls.dm=addField('DM', makeInput('text'));
  function makeKindSelect(){
    const select=document.createElement('select');
    const options=[
      {value:'adventure',label:'Adventure'},
      {value:'Downtime Activity',label:'Downtime Activity'}
    ];
    options.forEach(opt=>{ const o=document.createElement('option'); o.value=opt.value; o.textContent=opt.label; select.appendChild(o); });
    return select;
  }
  controls.kind=addField('Kind', makeKindSelect());
  controls.traded_item=addField('Item traded away', makeInput('text'));

  const gpRowForm=document.createElement('div'); gpRowForm.className='kv2';
  const gpEarnField=document.createElement('div'); gpEarnField.className='kvsingle';
  gpEarnField.innerHTML='<div class="k">Gold earned</div>';
  controls.gp_plus=makeInput('number');
  const gpEarnWrap=document.createElement('div'); gpEarnWrap.className='v'; gpEarnWrap.appendChild(controls.gp_plus); gpEarnField.appendChild(gpEarnWrap);

  const gpSpendField=document.createElement('div'); gpSpendField.className='kvsingle';
  gpSpendField.innerHTML='<div class="k">Gold spent</div>';
  controls.gp_minus=makeInput('number');
  const gpSpendWrap=document.createElement('div'); gpSpendWrap.className='v'; gpSpendWrap.appendChild(controls.gp_minus); gpSpendField.appendChild(gpSpendWrap);

  gpRowForm.appendChild(gpEarnField); gpRowForm.appendChild(gpSpendField); form.appendChild(gpRowForm);

  const dtRowForm=document.createElement('div'); dtRowForm.className='kv2';
  const dtEarnField=document.createElement('div'); dtEarnField.className='kvsingle';
  dtEarnField.innerHTML='<div class="k">Downtime earned</div>';
  controls.dtd_plus=makeInput('number');
  const dtEarnWrap=document.createElement('div'); dtEarnWrap.className='v'; dtEarnWrap.appendChild(controls.dtd_plus); dtEarnField.appendChild(dtEarnWrap);
  const dtSpendField=document.createElement('div'); dtSpendField.className='kvsingle';
  dtSpendField.innerHTML='<div class="k">Downtime spent</div>';
  controls.dtd_minus=makeInput('number');
  const dtSpendWrap=document.createElement('div'); dtSpendWrap.className='v'; dtSpendWrap.appendChild(controls.dtd_minus); dtSpendField.appendChild(dtSpendWrap);
  dtRowForm.appendChild(dtEarnField); dtRowForm.appendChild(dtSpendField); form.appendChild(dtRowForm);

  controls.level_plus=addField('Levels gained', makeInput('number'));

  let tradeField=controls.traded_item.closest('.field');
  function syncKindVisibility(){
    const isActivity=controls.kind.value!=='adventure';
    if(tradeField){ tradeField.style.display=isActivity?'':'none'; }
  }
  controls.kind.addEventListener('change', syncKindVisibility);
  syncKindVisibility();

  function createListEditor(items){
    const wrap=document.createElement('div'); wrap.className='list-editor';
    const list=document.createElement('div'); list.className='list'; wrap.appendChild(list);
    function addRow(val){
      const row=document.createElement('div'); row.className='list-row';
      const input=document.createElement('input'); input.type='text'; input.value=val||'';
      const btn=document.createElement('button'); btn.type='button'; btn.innerHTML=ICON_TRASH; btn.setAttribute('aria-label','Remove item');
      btn.addEventListener('click',()=>row.remove());
      row.appendChild(input); row.appendChild(btn); list.appendChild(row);
    }
    (items||[]).forEach(item=>addRow(item));
    const addBtn=document.createElement('button'); addBtn.type='button'; addBtn.className='add-row'; addBtn.textContent='Add item';
    addBtn.addEventListener('click',()=>addRow(''));
    wrap.appendChild(addBtn);
    wrap.getValues=()=>Array.from(list.querySelectorAll('input')).map(el=>el.value.trim()).filter(Boolean);
    wrap.setValues=(vals)=>{ list.innerHTML=''; (vals||[]).forEach(item=>addRow(item)); };
    return wrap;
  }

  controls.perm_items=createListEditor(a.perm_items||[]);
  addField('Magic items', controls.perm_items);
  controls.consumable_items=createListEditor(a.consumable_items||[]);
  addField('Consumables', controls.consumable_items);
  controls.notes=addField('Notes', makeTextarea());
  if(controls.notes){ controls.notes.rows=4; }

  form.querySelectorAll('.field,.kv2').forEach(el=>el.remove());

  function mountControl(control,target){
    if(!control||!target) return;
    target.appendChild(control);
  }

  mountControl(controls.title,titleEditorSlot);
  mountControl(controls.date,dateEditorSlot);
  mountControl(controls.code, codeEditorSlot || (codeFieldView && codeFieldView.__editor));
  mountControl(controls.dm, dmField.__editor);
  mountControl(controls.kind, kindField.__editor);
  if(tradedItemField && controls.traded_item){
    mountControl(controls.traded_item, tradedItemField.__editor);
    tradeField=controls.traded_item.closest('.field');
  }
  mountControl(controls.gp_plus, gpEarnCell.__editor);
  mountControl(controls.gp_minus, gpSpendCell.__editor);
  mountControl(controls.dtd_plus, dtEarnCell.__editor);
  mountControl(controls.dtd_minus, dtSpendCell.__editor);
  mountControl(controls.level_plus, levelField.__editor);
  mountControl(controls.perm_items, permField.__editor);
  mountControl(controls.consumable_items, consField.__editor);
  mountControl(controls.notes, notesField.__editor);

  permField.classList.add('full');
  consField.classList.add('full');
  notesField.classList.add('full','notes-field');

  const actions=document.createElement('div'); actions.className='edit-actions';
  actions.classList.add('show-when-editing');
  const deleteBtn=document.createElement('button'); deleteBtn.type='button'; deleteBtn.className='btn small danger delete-btn'; deleteBtn.innerHTML='<span class="btn-icon">'+ICON_TRASH+'</span><span>Delete entry</span>';
  deleteBtn.addEventListener('click',(ev)=>{ ev.preventDefault(); deleteCard(card); });
  const cancelBtn=document.createElement('button'); cancelBtn.type='button'; cancelBtn.className='btn small'; cancelBtn.textContent='Cancel';
  cancelBtn.addEventListener('click',(ev)=>{
    ev.preventDefault();
    if(card.__dataRef && card.__dataRef.__isNew){
      closeCardOverlay();
      return;
    }
    exitEditMode(card,true);
  });
  const saveBtn=document.createElement('button'); saveBtn.type='button'; saveBtn.className='btn small primary'; saveBtn.textContent='Save changes';
  saveBtn.addEventListener('click',async(ev)=>{ ev.preventDefault(); await saveCardChanges(card); });
  actions.appendChild(deleteBtn);
  actions.appendChild(cancelBtn); actions.appendChild(saveBtn);
  view.appendChild(actions);

  function populate(editing=false){
    const kindRaw=(a.kind||'').toString();
    const kindVal=kindRaw && kindRaw.toLowerCase()!=='adventure'?'Downtime Activity':'adventure';
    controls.kind.value=kindVal;
    const isActivityMode=(controls.kind.value||'adventure')!=='adventure';

    const titleRaw=a.title||'';
    controls.title.value=titleRaw;
    if(titleDisplayEl){
      const fallback=isActivityMode?'Activity':'Untitled Adventure';
      titleDisplayEl.textContent=sanitizeTitle(titleRaw||fallback);
    }

    const dateValue=a.date?String(a.date).slice(0,10):'';
    controls.date.value=dateValue;
    if(dateDisplayEl){ dateDisplayEl.textContent=fmtDate(a.date); }

    const codeRaw=a.code||'';
    controls.code.value=codeRaw;
    if(codeDisplayEl){ codeDisplayEl.textContent=codeRaw||''; }
    if(codeFieldView){
      codeFieldView.__display.textContent=makeValue(codeRaw);
      codeFieldView.style.display=(editing||codeRaw)?'':'none';
    }

    const kindLabel=(controls.kind.value||'adventure')==='adventure'?'Adventure':'Downtime Activity';
    kindField.__display.textContent=kindLabel;
    kindField.style.display=editing?'':'none';

    const dmRaw=a.dm||'';
    controls.dm.value=dmRaw;
    const dmDisplayVal=normalizeDisplayValue(dmRaw)||'—';
    if(dmField && dmField.__display){ dmField.__display.textContent=dmDisplayVal; }
    if(dmField){
      const showDM=editing || !isActivityMode || dmDisplayVal!=='—';
      dmField.style.display=showDM?'':'none';
    }

    if(tradedItemField && controls.traded_item){
      const tradeVal=a.traded_item||'';
      controls.traded_item.value=tradeVal;
      tradedItemField.__display.textContent=makeValue(tradeVal);
      tradedItemField.style.display=(editing||tradeVal.trim())?'':'none';
    }

    const gpEarn=Number(a.gp_plus??0);
    controls.gp_plus.value=a.gp_plus!=null&&a.gp_plus!==''?a.gp_plus:'';
    gpEarnCell.__display.textContent=fmtNumber(gpEarn);
    const gpSpend=Number(a.gp_minus??0);
    controls.gp_minus.value=a.gp_minus!=null&&a.gp_minus!==''?a.gp_minus:'';
    gpSpendCell.__display.textContent=fmtNumber(gpSpend);
    const showGpEarn=!isActivityMode || gpEarn!==0 || editing;
    const showGpSpend=!isActivityMode || gpSpend!==0 || editing;
    gpEarnCell.style.display=showGpEarn?'':'none';
    gpSpendCell.style.display=showGpSpend?'':'none';
    gpRowView.style.display=(editing||showGpEarn||showGpSpend)?'':'none';

    const dtEarn=Number(a.dtd_plus??0);
    controls.dtd_plus.value=a.dtd_plus!=null&&a.dtd_plus!==''?a.dtd_plus:'';
    dtEarnCell.__display.textContent=fmtNumber(dtEarn);
    const dtSpend=Number(a.dtd_minus??0);
    controls.dtd_minus.value=a.dtd_minus!=null&&a.dtd_minus!==''?a.dtd_minus:'';
    dtSpendCell.__display.textContent=fmtNumber(dtSpend);
    const showDtEarn=!isActivityMode || dtEarn!==0 || editing;
    const showDtSpend=!isActivityMode || dtSpend!==0 || editing;
    dtEarnCell.style.display=showDtEarn?'':'none';
    dtSpendCell.style.display=showDtSpend?'':'none';
    dtRowView.style.display=(editing||showDtEarn||showDtSpend)?'':'none';

    const levelVal=Number(a.level_plus||0);
    controls.level_plus.value=a.level_plus!=null&&a.level_plus!==''?a.level_plus:'';
    levelField.__display.textContent=fmtNumber(levelVal);
    const showLevel=(editing||(!isActivityMode && levelVal) || (isActivityMode && levelVal!==0));
    levelField.style.display=showLevel?'':'none';

    const permValues=Array.isArray(a.perm_items)?a.perm_items:[];
    controls.perm_items.setValues(permValues);
    permField.__display.innerHTML='';
    permField.__display.appendChild(listBox(permValues));
    const hasPermItemsNow=permValues.some(item=>hasMeaningfulValue(item));
    permField.style.display=(editing || (!hasTradeMeta && (!isActivityMode || hasPermItemsNow)))?'':'none';

    const consValues=Array.isArray(a.consumable_items)?a.consumable_items:[];
    controls.consumable_items.setValues(consValues);
    consField.__display.innerHTML='';
    consField.__display.appendChild(listBox(consValues));
    const hasConsNow=consValues.some(item=>hasMeaningfulValue(item));
    consField.style.display=(editing || (!isActivityMode || hasConsNow))?'':'none';

    const notesRaw=a.notes||'';
    controls.notes.value=notesRaw;
    const notesDisplay=normalizeDisplayValue(notesRaw)||'—';
    notesField.__display.innerHTML='';
    const notesNode=document.createElement('div'); notesNode.className='notesbox'; notesNode.textContent=notesDisplay;
    notesField.__display.appendChild(notesNode);
    const showNotes=(editing || (!hasTradeMeta && (!isActivityMode || notesDisplay!=='—')));
    notesField.style.display=showNotes?'':'none';

    syncKindVisibility();
  }

  function collect(){
    const selectedKind=(controls.kind.value||'').trim();
    const normalizedKind=selectedKind==='Downtime Activity'?'Downtime Activity':'adventure';
    const isActivity=normalizedKind!=='adventure';
    return {
      title:(controls.title.value||'').trim(),
      date:controls.date.value||'',
      code:(controls.code.value||'').trim(),
      dm:(controls.dm.value||'').trim(),
      kind:normalizedKind,
      gp_plus:Number(controls.gp_plus.value||0),
      gp_minus:Number(controls.gp_minus.value||0),
      dtd_plus:Number(controls.dtd_plus.value||0),
      dtd_minus:Number(controls.dtd_minus.value||0),
      level_plus:Number(controls.level_plus.value||0),
      perm_items:controls.perm_items.getValues(),
      consumable_items:controls.consumable_items.getValues(),
      notes:controls.notes.value||'',
      traded_item:isActivity?(controls.traded_item.value||'').trim():''
    };
  }

  formWrap.populate=populate;
  formWrap.collect=collect;

  bd.appendChild(view);
  bd.appendChild(formWrap);
  card.appendChild(hd);
  card.appendChild(bd);

  card.__edit={button:editBtn, form:formWrap, populate, collect};

  if(a && a.__openEdit){
    delete a.__openEdit;
    requestAnimationFrame(()=>enterEditMode(card));
  }

  return card;
}

function enterEditMode(card){
  if(!card||!card.__edit) return;
  card.classList.add('editing');
  card.classList.add('open');
  card.__edit.populate(true);
  const bd=card.querySelector('.card-bd');
  if(bd){
    bd.style.height='auto';
    bd.style.opacity='1';
  }
  if(card.__edit.button){
    card.__edit.button.setAttribute('aria-pressed','true');
    card.__edit.button.title='Exit edit mode';
  }
}

function exitEditMode(card,reset){
  if(!card||!card.__edit) return;
  card.classList.remove('editing');
  if(reset){ card.__edit.populate(false); }
  if(card.__edit.button){
    card.__edit.button.setAttribute('aria-pressed','false');
    card.__edit.button.title='Edit entry';
  }
}

async function saveCardChanges(card){
  if(!card||!card.__edit) return;
  const data=card.__dataRef;
  if(!data) return;
  const updates=card.__edit.collect();
  data.title=updates.title||null;
  data.date=updates.date||null;
  data.code=updates.code||'';
  data.dm=updates.dm||null;
  data.kind=updates.kind||'adventure';
  data.gp_plus=Number.isFinite(updates.gp_plus)?updates.gp_plus:0;
  data.gp_minus=Number.isFinite(updates.gp_minus)?updates.gp_minus:0;
  data.gp_net=data.gp_plus-data.gp_minus;
  data.dtd_plus=Number.isFinite(updates.dtd_plus)?updates.dtd_plus:0;
  data.dtd_minus=Number.isFinite(updates.dtd_minus)?updates.dtd_minus:0;
  data.dtd_net=data.dtd_plus-data.dtd_minus;
  data.level_plus=Number.isFinite(updates.level_plus)?updates.level_plus:0;
  data.perm_items=[...updates.perm_items];
  data.consumable_items=[...updates.consumable_items];
  const trimmedNotes=(updates.notes||'').trim();
  data.notes=trimmedNotes||'';
  data.traded_item=data.kind!=='adventure'?(updates.traded_item||''):'';
  const keyOverride=data.__charKey||null;
  const wasNew=!!data.__isNew;
  const targetKey=keyOverride||charSel.value;
  if(wasNew){
    const targetChar=DATA.characters[targetKey];
    if(targetChar){
      targetChar.adventures=Array.isArray(targetChar.adventures)?targetChar.adventures:[];
      targetChar.adventures.unshift(data);
    }
    delete data.__isNew;
    delete data.__charKey;
  }
  markDirty();
  exitEditMode(card);
  if(wasNew){
    closeCardOverlay();
  }
  const mutationKey=wasNew?targetKey:charSel.value;
  applyDataMutation(mutationKey);
  try{
    await saveDataJs();
  }catch(err){
    /* saveDataJs already handles user feedback */
  }
}

function deleteCard(card){
  if(!card||!card.__dataRef) return;
  if(card.__dataRef.__isNew){
    const confirmed=window.confirm('Discard this new entry?');
    if(confirmed) closeCardOverlay();
    return;
  }
  const key=charSel.value;
  const ch=DATA.characters[key];
  if(!ch||!Array.isArray(ch.adventures)) return;
  const idx=ch.adventures.indexOf(card.__dataRef);
  if(idx===-1) return;
  const confirmed=window.confirm('Delete this entry?');
  if(!confirmed) return;
  ch.adventures.splice(idx,1);
  markDirty();
  applyDataMutation(key);
}

function updateDerivedDataFor(key){
  const ch=DATA.characters[key];
  if(!ch) return;
  const advs=ch.adventures||[];
  const years=new Set();
  let sessions=0, netGP=0, netDTD=0, levelUps=0;
  advs.forEach(entry=>{
    if(entry.date){
      const year=new Date(entry.date).getFullYear();
      if(!Number.isNaN(year)) years.add(year);
    }
    const {gp,dtd}=netVals(entry);
    netGP+=gp;
    netDTD+=dtd;
    levelUps+=Number(entry.level_plus||0);
    if(!isActivityEntry(entry)) sessions++;
  });
  DATA.years[key]=Array.from(years).sort((a,b)=>a-b);
  const perm=collectPermanentInventory(key);
  const cons=buildConsumableInventory(key);
  DATA.stats[key]={
    sessions,
    net_gp:netGP,
    net_dtd:netDTD,
    level_ups:levelUps,
    perm_count:(perm.kept||[]).length,
    cons_count:cons.size||0
  };
}

function applyDataMutation(key){
  updateDerivedDataFor(key);
  filterAndRender();
}

/* --- stats & header --- */
function updateCharMeta(key){
  if(!metaEl) return;
  const stats=DATA.stats[key];
  if(!stats){
    metaEl.textContent='';
    metaEl.style.display='none';
    metaEl.setAttribute('aria-hidden','true');
    return;
  }
  const levelUps=Number(stats.level_ups||0);
  const currentLevel=(Number.isFinite(levelUps)?Math.round(levelUps):0)+1;
  const sessionsRaw=Number(stats.sessions||0);
  const parts=[];
  if(Number.isFinite(currentLevel)) parts.push(`Level ${fmtNumber(currentLevel)}`);
  if(Number.isFinite(sessionsRaw)){
    const label=sessionsRaw===1?'Session':'Sessions';
    parts.push(`${fmtNumber(sessionsRaw)} ${label}`);
  }
  const text=parts.join(' • ');
  metaEl.textContent=text;
  const show=Boolean(text);
  metaEl.style.display=show?'block':'none';
  metaEl.setAttribute('aria-hidden',show?'false':'true');
}

function renderStats(key){
  const s=DATA.stats[key]||{};
  updateCharMeta(key);
  const goldVal=fmtNumber(s.net_gp||0);
  if(goldValueEl) goldValueEl.textContent=goldVal;
  if(goldMetricEl) goldMetricEl.setAttribute('aria-label', `Gold: ${goldVal} gold pieces total`);
  const dtdVal=fmtNumber(s.net_dtd||0);
  if(downtimeValueEl) downtimeValueEl.textContent=dtdVal;
  if(downtimeMetricEl) downtimeMetricEl.setAttribute('aria-label', `Downtime: ${dtdVal} downtime days total`);
  const permCount=Number(s.perm_count||0);
  const consCount=Number(s.cons_count||0);
  if(magicItemsCountEl) magicItemsCountEl.textContent=`${fmtNumber(permCount)} permanent items`;
  if(consumablesCountEl) consumablesCountEl.textContent=`${fmtNumber(consCount)} consumables`;
  if(magicItemsBtn){
    const label=`View permanent magic items (${fmtNumber(permCount)} total)`;
    magicItemsBtn.setAttribute('aria-label',label);
    magicItemsBtn.title=label;
  }
  if(consumablesBtn){
    const label=`View consumables (${fmtNumber(consCount)} total)`;
    consumablesBtn.setAttribute('aria-label',label);
    consumablesBtn.title=label;
  }
}
function setHeader(key){
  const obj=DATA.characters[key];
  updateAvatar(key,obj);
  if(metaEl&&!obj){
    metaEl.textContent='';
    metaEl.style.display='none';
    metaEl.setAttribute('aria-hidden','true');
  }
  if(!badgesEl) return;
  badgesEl.innerHTML='';
  if(!obj){
    badgesEl.style.display='none';
    badgesEl.setAttribute('aria-hidden','true');
    return;
  }
  const identity=extractCharacterIdentity(obj);
  const chips=[];
  if(identity.race){ chips.push(identityBadge('Race', identity.race)); }
  if(identity.classes){ chips.push(identityBadge('Classes', identity.classes)); }
  chips.forEach(chip=>badgesEl.appendChild(chip));
  const show=chips.length>0;
  badgesEl.style.display=show?'flex':'none';
  badgesEl.setAttribute('aria-hidden', show?'false':'true');
}

/* --- masonry --- */
let __lastCols = null, __lastWidth = window.innerWidth || document.documentElement.clientWidth || 0;

function columnizeGrid(mode){
  if (!grid.classList.contains('cols')) return;
  if (mode === 'relayout') return;

  const GAP = 14, MIN = 320;
  const cw  = grid.clientWidth || grid.offsetWidth || 1200;
  const cols = Math.max(1, Math.floor((cw + GAP) / (MIN + GAP)));

  // NEW: if grid currently contains direct .card children, we must wrap them
  const hasDirectCards = Array.from(grid.children).some(el => el.classList && el.classList.contains('card'));
  const hasColumns     = Array.from(grid.children).some(el => el.classList && el.classList.contains('col'));

  // Only skip when columns exist AND count hasn't changed
  if (hasColumns && !hasDirectCards && __lastCols === cols) return;

  __lastCols = cols;

  const y = window.scrollY || document.documentElement.scrollTop || 0;

  // Collect whatever cards exist (either direct children or inside old columns)
  const cards = hasDirectCards
    ? Array.from(grid.querySelectorAll(':scope > .card'))
    : Array.from(grid.querySelectorAll('.col .card'));

  // Remove old columns
  Array.from(grid.children)
    .filter(el => el.classList && el.classList.contains('col'))
    .forEach(c => c.remove());

  // Create new columns
  const colEls = [];
  for (let i = 0; i < cols; i++) {
    const col = document.createElement('div');
    col.className = 'col';
    grid.appendChild(col);
    colEls.push(col);
  }

  // Stable order by data-idx
  cards.sort((a,b) => parseInt(a.dataset.idx||'0',10) - parseInt(b.dataset.idx||'0',10));
  cards.forEach((card,i) => colEls[i % cols].appendChild(card));

  window.scrollTo(0, y);
}
/* --- rendering --- */
function filterAndRender(){
  if(!DATA || !DATA.characters || !charSel) return;
  let key=charSel.value;
  if((!key || !DATA.characters[key]) && DATA.characters){
    const stored=getRememberedCharacterKey();
    if(stored && DATA.characters[stored]){
      charSel.value=stored;
      key=stored;
    }
  }
  if(!key || !DATA.characters[key]){
    const fallback=getMostRecentCharacter();
    if(fallback){
      charSel.value=fallback;
      key=fallback;
    }else{
      rememberCharacterKey('');
      grid.innerHTML='';
      emptyEl.style.display='block';
      return;
    }
  }
  rememberCharacterKey(key);
  const advs=(DATA.characters[key]&&DATA.characters[key].adventures)||[];
  const q=(qEl.value||'').toLowerCase();
  const filtered=advs.filter(a=>{
    if(!showActivities && isActivityEntry(a)) return false;
    const blob=[a.title,a.code,a.notes,a.dm,a.traded_item,a.itemTraded,a.itemReceived,a.player,a.character]
      .concat(a.perm_items||[])
      .concat(a.consumable_items||[])
      .map(x=>(x||'').toString().toLowerCase()).join(' ');
    return !q||blob.indexOf(q)!==-1;
  });
  grid.innerHTML='';
  if(!filtered.length){ emptyEl.style.display='block'; }
  else { emptyEl.style.display='none'; filtered.forEach((a,i)=>grid.appendChild(makeCard(a,i))); }
  renderStats(key); setHeader(key); columnizeGrid('build');
}

/* --- events --- */
qEl.addEventListener('input',filterAndRender);
charSel.addEventListener('change',filterAndRender);
if(activityToggleBtn){
  activityToggleBtn.addEventListener('click',()=>{
    showActivities=!showActivities;
    persistActivityVisibility();
    updateActivityToggle();
    filterAndRender();
  });
}
window.addEventListener('resize',()=>{
  const w=window.innerWidth||document.documentElement.clientWidth||0;
  if(Math.abs(w-__lastWidth)<8) return; __lastWidth=w;
  clearTimeout(window.__colize); window.__colize=setTimeout(()=>{ columnizeGrid('build'); },120);
});

/* --- init --- */
function initApp(){
  DATA=window.DATA||null;
  if(!DATA || !DATA.characters){
    showDataLoadError('Could not load <code>data.js</code>.');
    return false;
  }
  if(emptyEl){
    emptyEl.style.display='none';
  }
  updateActivityToggle();
  const initialKey=rebuildCharacterOptions({preserveSelection:false})||getMostRecentCharacter();
  if(initialKey && charSel){
    charSel.value=initialKey;
  }
  filterAndRender();
  clearDirty();
  return true;
}

let __appInitialized=false;
function ensureAppInitialized(){
  if(__appInitialized) return;
  __appInitialized=initApp();
}

function tryInitApp(){
  if(window.DATA && window.DATA.characters){
    DATA=window.DATA;
    ensureAppInitialized();
    return __appInitialized;
  }
  return false;
}

if(!tryInitApp()){
  if(dataScriptEl){
    const onLoad=()=>{
      if(!tryInitApp()){
        showDataLoadError('Could not load <code>data.js</code>.');
      }
    };
    dataScriptEl.addEventListener('load', onLoad, {once:true});
    dataScriptEl.addEventListener('error',()=>{
      showDataLoadError('Could not load <code>data.js</code>.');
    },{once:true});
    const state=dataScriptEl.readyState;
    if(state==='loaded'||state==='complete'){
      tryInitApp();
    }
    [0,50,200].forEach(delay=>{ setTimeout(()=>{ tryInitApp(); },delay); });
  }else{
    showDataLoadError('Could not load <code>data.js</code>.');
  }
}

/* prevent accidental jump-to-top for href="#" */
document.addEventListener('click',(e)=>{ const a=e.target.closest('a[href="#"]'); if(a) e.preventDefault(); },{passive:true});

/* save data.js */
if(downloadBtn){
  downloadBtn.addEventListener('click',async()=>{
    try{
      await saveDataJs();
    }catch(err){
      /* saveDataJs already handles user feedback */
    }
  });
}
if(addCardBtn){
  addCardBtn.addEventListener('click',()=>{
    const key=charSel.value;
    const ch=DATA.characters[key];
    if(!ch) return;
    const today=new Date().toISOString().slice(0,10);
    const template={
      date:today,
      title:'New Adventure',
      code:'',
      dm:'',
      gp_plus:0,
      gp_minus:0,
      dtd_plus:0,
      dtd_minus:0,
      level_plus:0,
      perm_items:[],
      consumable_items:[],
      notes:'',
      kind:'adventure',
      traded_item:'',
      __openEdit:true,
      __isNew:true,
      __charKey:key
    };
    const card=makeCard(template,-1);
    card.classList.add('overlay-card');
    openCardOverlay(card);
  });
}
</script>
</body>
</html>
