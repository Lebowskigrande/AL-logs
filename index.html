<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Adventure Log Dashboard</title>
<link rel="icon" href="favicon.ico"/>
<style>
:root {
  color-scheme: light dark;
  font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  --bg: #f8fafc;
  --panel-bg: rgba(255, 255, 255, 0.92);
  --panel-border: rgba(148, 163, 184, 0.35);
  --text-primary: #0f172a;
  --text-secondary: #475569;
  --text-muted: #64748b;
  --accent: #2563eb;
  --accent-soft: rgba(37, 99, 235, 0.1);
  --chip-bg: rgba(37, 99, 235, 0.12);
  --chip-color: #1d4ed8;
  --shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0f172a;
    --panel-bg: rgba(15, 23, 42, 0.92);
    --panel-border: rgba(71, 85, 105, 0.55);
    --text-primary: #e2e8f0;
    --text-secondary: #cbd5f5;
    --text-muted: #94a3b8;
    --accent: #60a5fa;
    --accent-soft: rgba(96, 165, 250, 0.22);
    --chip-bg: rgba(96, 165, 250, 0.16);
    --chip-color: #bfdbfe;
    --shadow: 0 24px 55px rgba(15, 23, 42, 0.48);
  }
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  min-height: 100vh;
  background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.22), transparent 55%),
    radial-gradient(circle at bottom right, rgba(37, 99, 235, 0.15), transparent 50%),
    var(--bg);
  color: var(--text-primary);
}

h1, h2, h3, h4, h5 {
  margin: 0;
  font-weight: 700;
  line-height: 1.1;
  letter-spacing: -0.01em;
}

p {
  margin: 0;
}

a {
  color: var(--accent);
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

.app-shell {
  max-width: 1200px;
  margin: 0 auto;
  padding: 32px 16px 64px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.topbar {
  padding: 28px 28px 24px;
  background: var(--panel-bg);
  border: 1px solid var(--panel-border);
  border-radius: 24px;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.topbar h1 {
  font-size: clamp(26px, 3vw, 34px);
}

.meta-line {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  color: var(--text-secondary);
  font-size: 15px;
}

.meta-line span {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.meta-notes {
  font-size: 14px;
  color: var(--text-muted);
  line-height: 1.6;
}

.sheet-summary {
  font-size: 14px;
  color: var(--text-secondary);
}

.sheet-summary[hidden] {
  display: none;
}

.sheet-summary summary {
  cursor: pointer;
  list-style: none;
}

.sheet-summary summary::-webkit-details-marker {
  display: none;
}

.sheet-summary summary::after {
  content: "\203A";
  display: inline-block;
  margin-left: 8px;
  transition: transform 0.2s ease;
}

.sheet-summary[open] summary::after {
  transform: rotate(90deg);
}

.sheet-summary ul {
  margin: 12px 0 0;
  padding: 0;
  list-style: none;
  columns: auto 200px;
  column-gap: 16px;
}

.sheet-summary li {
  margin: 4px 0;
}

.tabs {
  display: inline-flex;
  border-radius: 14px;
  background: var(--panel-bg);
  border: 1px solid var(--panel-border);
  padding: 6px;
  box-shadow: var(--shadow);
  gap: 6px;
  align-self: flex-start;
}

.tab {
  border: none;
  background: transparent;
  padding: 10px 18px;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  transition: background 0.2s ease, color 0.2s ease;
}

.tab:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

.tab.is-active {
  background: var(--accent-soft);
  color: var(--accent);
}

.panels {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.panel {
  display: none;
  padding: 28px;
  background: var(--panel-bg);
  border: 1px solid var(--panel-border);
  border-radius: 24px;
  box-shadow: var(--shadow);
}

.panel.is-active {
  display: block;
}

.character-layout {
  display: grid;
  grid-template-columns: minmax(220px, 280px) minmax(0, 1fr);
  gap: 28px;
}

.character-sidebar {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.search-box label {
  display: block;
  font-size: 14px;
  color: var(--text-muted);
  margin-bottom: 6px;
}

.search-box input {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid var(--panel-border);
  background: rgba(255, 255, 255, 0.65);
  color: var(--text-primary);
  font-size: 15px;
}

@media (prefers-color-scheme: dark) {
  .search-box input {
    background: rgba(15, 23, 42, 0.65);
  }
}

.character-list {
  border: 1px solid var(--panel-border);
  border-radius: 14px;
  background: rgba(255, 255, 255, 0.55);
  padding: 6px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  max-height: 520px;
  overflow-y: auto;
}

@media (prefers-color-scheme: dark) {
  .character-list {
    background: rgba(15, 23, 42, 0.55);
  }
}

.character-item {
  border: none;
  background: transparent;
  text-align: left;
  padding: 10px 12px;
  border-radius: 10px;
  font-size: 15px;
  color: var(--text-primary);
  cursor: pointer;
  transition: background 0.2s ease, color 0.2s ease;
}

.character-item:hover {
  background: rgba(148, 163, 184, 0.16);
}

.character-item.is-active {
  background: var(--accent-soft);
  color: var(--accent);
  font-weight: 600;
}

.empty-message {
  font-size: 14px;
  color: var(--text-muted);
  padding: 12px 8px;
}

.character-details {
  position: relative;
  min-height: 320px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.character-details .empty-state {
  display: none;
  padding: 24px;
  border-radius: 18px;
  border: 1px dashed var(--panel-border);
  background: rgba(148, 163, 184, 0.12);
  color: var(--text-secondary);
  text-align: center;
  font-size: 16px;
}

.character-details.is-empty .empty-state {
  display: block;
}

.character-details.is-empty .character-content {
  display: none;
}

.character-header {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.character-header h2 {
  font-size: clamp(22px, 2.4vw, 28px);
}

.character-header .subtitle {
  font-size: 15px;
  color: var(--text-muted);
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 16px;
}

.summary-grid dt {
  font-size: 12px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--text-muted);
}

.summary-grid dd {
  margin: 4px 0 0;
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
}

.summary-grid--compact dd {
  font-size: 16px;
}

.inventory {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.inventory h3 {
  font-size: 18px;
}

.inventory-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 16px;
}

.inventory-card {
  border: 1px solid var(--panel-border);
  border-radius: 16px;
  padding: 16px;
  background: rgba(255, 255, 255, 0.6);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

@media (prefers-color-scheme: dark) {
  .inventory-card {
    background: rgba(15, 23, 42, 0.6);
  }
}

.inventory-card h4 {
  font-size: 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  color: var(--text-secondary);
}

.count-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 24px;
  padding: 2px 8px;
  border-radius: 999px;
  background: var(--accent-soft);
  color: var(--accent);
  font-size: 12px;
  font-weight: 600;
}

.pill-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.pill-list li {
  padding: 6px 10px;
  border-radius: 999px;
  background: var(--chip-bg);
  color: var(--chip-color);
  font-size: 13px;
  line-height: 1.3;
}

.logs {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.table-wrap {
  border: 1px solid var(--panel-border);
  border-radius: 18px;
  overflow: hidden;
  background: rgba(255, 255, 255, 0.7);
}

@media (prefers-color-scheme: dark) {
  .table-wrap {
    background: rgba(15, 23, 42, 0.7);
  }
}

.log-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  min-width: 720px;
}

.log-table thead {
  background: rgba(148, 163, 184, 0.18);
  color: var(--text-secondary);
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.08em;
}

.log-table th,
.log-table td {
  padding: 12px 14px;
  text-align: left;
  border-bottom: 1px solid rgba(148, 163, 184, 0.2);
  vertical-align: top;
}

.log-table tbody tr:nth-child(even) {
  background: rgba(148, 163, 184, 0.08);
}

.log-table .adventure-name {
  display: block;
  font-weight: 600;
  color: var(--text-primary);
}

.log-table .adventure-code {
  display: block;
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: 4px;
}

.log-table .chip {
  display: inline-flex;
  align-items: center;
  padding: 4px 8px;
  border-radius: 999px;
  background: var(--chip-bg);
  color: var(--chip-color);
  font-size: 12px;
  margin: 2px 4px 2px 0;
}

.notes {
  white-space: pre-wrap;
}

.dm-layout {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.section-header .subtitle {
  font-size: 15px;
  color: var(--text-muted);
  margin-top: 6px;
}

.dm-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.season-list {
  display: grid;
  gap: 18px;
}

.season-card {
  border: 1px solid var(--panel-border);
  border-radius: 20px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.65);
  display: flex;
  flex-direction: column;
  gap: 16px;
}

@media (prefers-color-scheme: dark) {
  .season-card {
    background: rgba(15, 23, 42, 0.65);
  }
}

.season-card h4 {
  font-size: 18px;
}

.season-card .season-meta {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 12px;
}

.allocation-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.allocation-item {
  padding: 10px 12px;
  border-radius: 12px;
  background: rgba(148, 163, 184, 0.12);
}

.allocation-item .meta {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 4px;
}

.dm-table {
  min-width: 640px;
}

@media (max-width: 960px) {
  .character-layout {
    grid-template-columns: 1fr;
  }

  .character-sidebar {
    order: 2;
  }

  .character-details {
    order: 1;
  }
}

@media (max-width: 720px) {
  .panel {
    padding: 22px;
  }

  .topbar {
    padding: 24px 20px;
  }

  .table-wrap {
    overflow-x: auto;
  }
}
</style>
</head>
<body>
<div class="app-shell">
  <header class="topbar">
    <div>
      <h1>Adventure Log Dashboard</h1>
      <p class="meta-line">
        <span>Updated <strong data-role="meta-generated">—</strong></span>
        <span><strong data-role="character-count">0</strong> characters</span>
        <span>Source file <strong data-role="source-file">—</strong></span>
      </p>
    </div>
    <details class="sheet-summary" data-role="sheet-details">
      <summary><span data-role="sheet-count">0</span> sheets parsed</summary>
      <ul data-role="sheet-list"></ul>
    </details>
    <p class="meta-notes" data-role="meta-notes" hidden></p>
  </header>

  <nav class="tabs" role="tablist" aria-label="Adventure log views">
    <button type="button" class="tab is-active" role="tab" aria-selected="true" data-tab="characters">Characters</button>
    <button type="button" class="tab" role="tab" aria-selected="false" data-tab="dm-log">DM Log</button>
  </nav>

  <main class="panels">
    <section class="panel is-active" data-panel="characters" role="tabpanel" aria-labelledby="characters-tab">
      <div class="character-layout">
        <aside class="character-sidebar">
          <div class="search-box">
            <label for="character-search">Search characters</label>
            <input id="character-search" type="search" placeholder="Start typing a name…" autocomplete="off" data-role="character-search"/>
          </div>
          <div class="character-list" data-role="character-list" role="listbox" aria-label="Characters"></div>
          <p class="empty-message" data-role="character-empty" hidden>No characters match your search.</p>
        </aside>
        <section class="character-details is-empty" data-role="character-details">
          <div class="empty-state" data-role="character-placeholder">Select a character from the list to see their progress.</div>
          <div class="character-content">
            <header class="character-header">
              <h2 data-role="character-name"></h2>
              <p class="subtitle" data-role="character-sheet"></p>
            </header>
            <dl class="summary-grid">
              <div>
                <dt>Log entries</dt>
                <dd data-role="summary-entries">0</dd>
              </div>
              <div>
                <dt>Recorded sessions</dt>
                <dd data-role="summary-sessions">0</dd>
              </div>
              <div>
                <dt>Total gold</dt>
                <dd data-role="summary-gold">0</dd>
              </div>
              <div>
                <dt>Downtime days</dt>
                <dd data-role="summary-downtime">0</dd>
              </div>
              <div>
                <dt>First entry</dt>
                <dd data-role="summary-first">—</dd>
              </div>
              <div>
                <dt>Most recent</dt>
                <dd data-role="summary-last">—</dd>
              </div>
            </dl>
            <section class="inventory">
              <h3>Inventory</h3>
              <div class="inventory-grid">
                <article class="inventory-card">
                  <h4>Magic items <span class="count-badge" data-role="magic-count">0</span></h4>
                  <ul class="pill-list" data-role="magic-items"></ul>
                </article>
                <article class="inventory-card">
                  <h4>Consumables <span class="count-badge" data-role="consumable-count">0</span></h4>
                  <ul class="pill-list" data-role="consumables"></ul>
                </article>
                <article class="inventory-card">
                  <h4>Supernatural gifts <span class="count-badge" data-role="gift-count">0</span></h4>
                  <ul class="pill-list" data-role="supernatural"></ul>
                </article>
              </div>
            </section>
            <section class="logs">
              <h3>Adventure log</h3>
              <div class="table-wrap">
                <table class="log-table" aria-label="Adventure log entries">
                  <thead>
                    <tr>
                      <th scope="col">Date</th>
                      <th scope="col">Adventure</th>
                      <th scope="col">DM</th>
                      <th scope="col">Level</th>
                      <th scope="col">Gold</th>
                      <th scope="col">Downtime</th>
                      <th scope="col">Rewards</th>
                      <th scope="col">Notes</th>
                    </tr>
                  </thead>
                  <tbody data-role="log-rows"></tbody>
                </table>
                <p class="empty-message" data-role="logs-empty">No log entries recorded yet.</p>
              </div>
            </section>
          </div>
        </section>
      </div>
    </section>

    <section class="panel" data-panel="dm-log" role="tabpanel" aria-labelledby="dm-log-tab" aria-hidden="true">
      <div class="dm-layout">
        <header class="section-header">
          <h2>Dungeon Master rewards</h2>
          <p class="subtitle">Generated <span data-role="dm-generated">—</span></p>
        </header>
        <dl class="summary-grid summary-grid--compact">
          <div>
            <dt>Total entries</dt>
            <dd data-role="dm-total-runs">0</dd>
          </div>
          <div>
            <dt>Pre-season</dt>
            <dd data-role="dm-pre-count">0</dd>
          </div>
          <div>
            <dt>Seasonal</dt>
            <dd data-role="dm-season-count">0</dd>
          </div>
          <div>
            <dt>Allocations</dt>
            <dd data-role="dm-allocation-count">0</dd>
          </div>
          <div>
            <dt>Total hours</dt>
            <dd data-role="dm-hours">0 h</dd>
          </div>
        </dl>
        <section class="dm-section">
          <h3>Pre-season modules</h3>
          <div class="table-wrap">
            <table class="log-table dm-table" aria-label="Pre-season DM sessions">
              <thead>
                <tr>
                  <th scope="col">Date</th>
                  <th scope="col">Adventure</th>
                  <th scope="col">Tier</th>
                  <th scope="col">Levels</th>
                  <th scope="col">Item</th>
                  <th scope="col">Allocation</th>
                  <th scope="col">Location</th>
                </tr>
              </thead>
              <tbody data-role="dm-pre-rows"></tbody>
            </table>
            <p class="empty-message" data-role="dm-pre-empty">No pre-season entries recorded.</p>
          </div>
        </section>
        <section class="dm-section">
          <h3>Seasonal programs</h3>
          <div class="season-list" data-role="dm-season-list"></div>
        </section>
      </div>
    </section>
  </main>
</div>

<script type="module">
import { DATA } from './data.js';

const STORAGE_KEY = 'al_logs_last_character';
const DM_LOG_KEY = '__dmLog';

const integerFormatter = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });
const decimalFormatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 });
const dateFormatter = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium' });
const dateTimeFormatter = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' });

const elements = {
  meta: {
    generated: document.querySelector('[data-role="meta-generated"]'),
    characterCount: document.querySelector('[data-role="character-count"]'),
    sourceFile: document.querySelector('[data-role="source-file"]'),
    notes: document.querySelector('[data-role="meta-notes"]'),
    sheetDetails: document.querySelector('[data-role="sheet-details"]'),
    sheetCount: document.querySelector('[data-role="sheet-count"]'),
    sheetList: document.querySelector('[data-role="sheet-list"]')
  },
  tabs: Array.from(document.querySelectorAll('.tab[data-tab]')),
  panels: Array.from(document.querySelectorAll('[data-panel]')),
  character: {
    search: document.querySelector('[data-role="character-search"]'),
    list: document.querySelector('[data-role="character-list"]'),
    listEmpty: document.querySelector('[data-role="character-empty"]'),
    details: document.querySelector('[data-role="character-details"]'),
    placeholder: document.querySelector('[data-role="character-placeholder"]'),
    name: document.querySelector('[data-role="character-name"]'),
    sheet: document.querySelector('[data-role="character-sheet"]'),
    summary: {
      entries: document.querySelector('[data-role="summary-entries"]'),
      sessions: document.querySelector('[data-role="summary-sessions"]'),
      gold: document.querySelector('[data-role="summary-gold"]'),
      downtime: document.querySelector('[data-role="summary-downtime"]'),
      first: document.querySelector('[data-role="summary-first"]'),
      last: document.querySelector('[data-role="summary-last"]')
    },
    inventory: {
      magic: document.querySelector('[data-role="magic-items"]'),
      magicCount: document.querySelector('[data-role="magic-count"]'),
      consumables: document.querySelector('[data-role="consumables"]'),
      consumableCount: document.querySelector('[data-role="consumable-count"]'),
      supernatural: document.querySelector('[data-role="supernatural"]'),
      giftCount: document.querySelector('[data-role="gift-count"]')
    },
    logs: {
      tableBody: document.querySelector('[data-role="log-rows"]'),
      empty: document.querySelector('[data-role="logs-empty"]')
    }
  },
  dm: {
    generated: document.querySelector('[data-role="dm-generated"]'),
    total: document.querySelector('[data-role="dm-total-runs"]'),
    preCount: document.querySelector('[data-role="dm-pre-count"]'),
    seasonCount: document.querySelector('[data-role="dm-season-count"]'),
    allocations: document.querySelector('[data-role="dm-allocation-count"]'),
    hours: document.querySelector('[data-role="dm-hours"]'),
    preRows: document.querySelector('[data-role="dm-pre-rows"]'),
    preEmpty: document.querySelector('[data-role="dm-pre-empty"]'),
    seasonList: document.querySelector('[data-role="dm-season-list"]')
  }
};

const state = {
  characters: transformCharacters(DATA?.characters ?? {}),
  filter: '',
  selectedKey: null,
  activeTab: 'characters'
};

updateMeta(DATA?.meta ?? {});

const initial = determineInitialState();
if (initial.tab === 'characters') {
  state.selectedKey = resolveCharacterKey(initial.key);
} else {
  state.selectedKey = resolveCharacterKey(getStoredSelection());
}

renderCharacterList();
setActiveTab(initial.tab, { skipHash: true, skipStorage: true });

if (state.activeTab === 'characters') {
  selectCharacter(state.selectedKey, { skipHash: true, skipStorage: true });
} else {
  loadDmPanel();
}

setupEventListeners();

function setupEventListeners() {
  elements.character.search?.addEventListener('input', (event) => {
    state.filter = (event.target.value || '').trim().toLowerCase();
    renderCharacterList();
  });

  elements.character.list?.addEventListener('click', (event) => {
    const target = event.target.closest('.character-item[data-key]');
    if (!target) return;
    const key = target.getAttribute('data-key');
    selectCharacter(key);
  });

  elements.tabs.forEach((tabButton) => {
    tabButton.addEventListener('click', () => {
      const tab = tabButton.getAttribute('data-tab');
      setActiveTab(tab);
    });
  });

  window.addEventListener('hashchange', () => {
    const { tab, key } = parseHash(window.location.hash);
    if (tab !== state.activeTab) {
      setActiveTab(tab, { skipHash: true, skipStorage: true });
    }
    if (tab === 'characters' && key && key !== state.selectedKey) {
      selectCharacter(key, { skipHash: true, skipStorage: true });
    }
    if (tab === 'characters' && !key && state.selectedKey) {
      selectCharacter(state.selectedKey, { skipHash: true, skipStorage: true });
    }
    if (tab === 'dm-log') {
      loadDmPanel();
    }
  });
}

function updateMeta(meta) {
  if (elements.meta.generated) {
    elements.meta.generated.textContent = meta.generatedAt ? formatDateTime(meta.generatedAt) : '—';
  }
  if (elements.meta.sourceFile) {
    elements.meta.sourceFile.textContent = meta.sourceFile || '—';
  }
  if (elements.meta.characterCount) {
    elements.meta.characterCount.textContent = formatInteger(state.characters.length);
  }
  if (elements.meta.notes) {
    if (meta.notes) {
      elements.meta.notes.textContent = meta.notes;
      elements.meta.notes.hidden = false;
    } else {
      elements.meta.notes.hidden = true;
    }
  }
  const sheets = Array.isArray(meta.sheetsParsed) ? meta.sheetsParsed.filter(Boolean) : [];
  if (elements.meta.sheetDetails) {
    if (sheets.length) {
      elements.meta.sheetDetails.hidden = false;
      elements.meta.sheetCount.textContent = formatInteger(sheets.length);
      const fragment = document.createDocumentFragment();
      sheets.forEach((sheet) => {
        const li = document.createElement('li');
        li.textContent = sheet;
        fragment.appendChild(li);
      });
      elements.meta.sheetList.replaceChildren(fragment);
    } else {
      elements.meta.sheetDetails.hidden = true;
    }
  }
}

function renderCharacterList() {
  const container = elements.character.list;
  if (!container) return;
  const filter = state.filter;
  const filteredCharacters = filter
    ? state.characters.filter((char) => char.nameLower.includes(filter))
    : state.characters;

  const fragment = document.createDocumentFragment();
  filteredCharacters.forEach((character) => {
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'character-item' + (character.key === state.selectedKey ? ' is-active' : '');
    button.textContent = character.name;
    button.setAttribute('data-key', character.key);
    button.setAttribute('role', 'option');
    button.setAttribute('aria-selected', character.key === state.selectedKey ? 'true' : 'false');
    fragment.appendChild(button);
  });
  container.replaceChildren(fragment);

  const listEmpty = elements.character.listEmpty;
  if (listEmpty) {
    listEmpty.hidden = filteredCharacters.length > 0;
  }

  if (state.activeTab === 'characters') {
    if (filteredCharacters.length === 0) {
      selectCharacter(null, { skipHash: true, skipStorage: true });
    } else if (!state.selectedKey || !filteredCharacters.some((c) => c.key === state.selectedKey)) {
      selectCharacter(filteredCharacters[0].key, { skipHash: true, skipStorage: true });
    } else {
      updateActiveListSelection();
    }
  }
}

function updateActiveListSelection() {
  const buttons = elements.character.list?.querySelectorAll('.character-item[data-key]');
  if (!buttons) return;
  buttons.forEach((button) => {
    const key = button.getAttribute('data-key');
    const isActive = key === state.selectedKey;
    button.classList.toggle('is-active', isActive);
    button.setAttribute('aria-selected', isActive ? 'true' : 'false');
  });
}

function selectCharacter(key, options = {}) {
  const character = state.characters.find((char) => char.key === key) || null;
  state.selectedKey = character ? character.key : null;
  renderCharacterDetails(character);
  updateActiveListSelection();
  if (!options.skipStorage) {
    storeSelection(character ? character.key : '');
  }
  if (!options.skipHash && state.activeTab === 'characters') {
    setHash(character ? encodeURIComponent(character.key) : '');
  }
}

function renderCharacterDetails(character) {
  const details = elements.character.details;
  if (!details) return;
  const isEmpty = !character;
  details.classList.toggle('is-empty', isEmpty);
  if (isEmpty) {
    elements.character.logs.tableBody.replaceChildren();
    elements.character.logs.empty.hidden = false;
    return;
  }
  const summary = elements.character.summary;
  elements.character.name.textContent = character.name;
  elements.character.sheet.textContent = `${formatInteger(character.counts.sessions)} sessions • ${formatInteger(character.counts.entries)} entries`;
  summary.entries.textContent = formatInteger(character.counts.entries);
  summary.sessions.textContent = formatInteger(character.counts.sessions);
  summary.gold.textContent = formatAmount(character.finalTallies.gold);
  summary.downtime.textContent = formatAmount(character.finalTallies.downtimeDays);
  summary.first.textContent = character.firstDate ? formatDate(character.firstDate) : '—';
  summary.last.textContent = character.lastDate ? formatDate(character.lastDate) : '—';

  renderInventoryList(elements.character.inventory.magic, character.finalTallies.magicItems, elements.character.inventory.magicCount);
  renderInventoryList(elements.character.inventory.consumables, character.finalTallies.consumables, elements.character.inventory.consumableCount);
  renderInventoryList(elements.character.inventory.supernatural, character.finalTallies.supernatural, elements.character.inventory.giftCount);

  renderLogs(character.visibleLogs);
}

function renderInventoryList(listElement, items, countElement) {
  if (!listElement) return;
  const list = Array.isArray(items) ? items.filter(Boolean) : [];
  if (countElement) {
    countElement.textContent = formatInteger(list.length);
  }
  if (list.length === 0) {
    const emptyItem = document.createElement('li');
    emptyItem.className = 'empty-message';
    emptyItem.textContent = 'None recorded';
    listElement.replaceChildren(emptyItem);
    return;
  }
  const fragment = document.createDocumentFragment();
  list.forEach((item) => {
    const li = document.createElement('li');
    li.textContent = item;
    fragment.appendChild(li);
  });
  listElement.replaceChildren(fragment);
}

function renderLogs(logs) {
  const tbody = elements.character.logs.tableBody;
  if (!tbody) return;
  const meaningfulLogs = Array.isArray(logs) ? logs : [];
  if (meaningfulLogs.length === 0) {
    tbody.replaceChildren();
    elements.character.logs.empty.hidden = false;
    return;
  }
  elements.character.logs.empty.hidden = true;
  const fragment = document.createDocumentFragment();
  meaningfulLogs.forEach((log) => {
    const tr = document.createElement('tr');

    const dateCell = document.createElement('td');
    dateCell.textContent = log.displayDate;
    if (log.rawDate) {
      dateCell.title = log.rawDate;
    }
    tr.appendChild(dateCell);

    const adventureCell = document.createElement('td');
    if (log.code) {
      const code = document.createElement('span');
      code.className = 'adventure-code';
      code.textContent = log.code;
      adventureCell.appendChild(code);
    }
    const name = document.createElement('span');
    name.className = 'adventure-name';
    name.textContent = log.name || (log.code ? '' : '—');
    adventureCell.appendChild(name);
    tr.appendChild(adventureCell);

    const dmCell = document.createElement('td');
    dmCell.textContent = log.dm || '—';
    tr.appendChild(dmCell);

    const levelCell = document.createElement('td');
    if (log.levelPlus > 0) {
      levelCell.textContent = `+${formatInteger(log.levelPlus)}`;
    } else if (log.levelPlus < 0) {
      levelCell.textContent = `-${formatInteger(Math.abs(log.levelPlus))}`;
    } else {
      levelCell.textContent = '0';
    }
    tr.appendChild(levelCell);

    const goldCell = document.createElement('td');
    goldCell.textContent = formatSigned(log.goldNet);
    const goldDetails = [];
    if (log.goldPlus) goldDetails.push(`Earned: ${formatAmount(log.goldPlus)}`);
    if (log.goldMinus) goldDetails.push(`Spent: ${formatAmount(log.goldMinus)}`);
    if (goldDetails.length) {
      goldCell.title = goldDetails.join('\n');
    }
    tr.appendChild(goldCell);

    const downtimeCell = document.createElement('td');
    downtimeCell.textContent = formatSigned(log.downtimeNet);
    const dtDetails = [];
    if (log.downtimePlus) dtDetails.push(`Gained: ${formatAmount(log.downtimePlus)}`);
    if (log.downtimeMinus) dtDetails.push(`Spent: ${formatAmount(log.downtimeMinus)}`);
    if (dtDetails.length) {
      downtimeCell.title = dtDetails.join('\n');
    }
    tr.appendChild(downtimeCell);

    const rewardsCell = document.createElement('td');
    const rewardCount = log.permItems.length + log.consumables.length + log.storyRewards.length + log.supernatural.length;
    if (rewardCount === 0) {
      rewardsCell.textContent = '—';
    } else {
      const rewardFragment = document.createDocumentFragment();
      appendRewardChips(rewardFragment, log.permItems, 'Item');
      appendRewardChips(rewardFragment, log.consumables, 'Consumable');
      appendRewardChips(rewardFragment, log.storyRewards, 'Story');
      appendRewardChips(rewardFragment, log.supernatural, 'Gift');
      rewardsCell.appendChild(rewardFragment);
    }
    tr.appendChild(rewardsCell);

    const notesCell = document.createElement('td');
    notesCell.className = 'notes';
    notesCell.textContent = log.notes || '—';
    tr.appendChild(notesCell);

    fragment.appendChild(tr);
  });
  tbody.replaceChildren(fragment);
}

function appendRewardChips(fragment, items, label) {
  items.forEach((item) => {
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.textContent = label ? `${label}: ${item}` : item;
    fragment.appendChild(chip);
  });
}

let dmDataPromise = null;
let dmRendered = false;

function loadDmPanel() {
  if (dmRendered) return;
  if (!dmDataPromise) {
    dmDataPromise = import('./dmData.js').then((mod) => mod.DMDATA || window.DMDATA || {});
  }
  dmDataPromise.then((data) => {
    renderDmPanel(data);
    dmRendered = true;
  }).catch((error) => {
    console.error('Failed to load DM data', error);
  });
}

function renderDmPanel(data) {
  if (!data) return;
  const metaGenerated = data.meta?.generated;
  if (elements.dm.generated) {
    elements.dm.generated.textContent = metaGenerated ? formatDateTime(metaGenerated) : '—';
  }

  const preSeason = Array.isArray(data.preS11) ? data.preS11.map(transformPreSeasonEntry) : [];
  const seasonalEntries = buildSeasonalEntries(data.seasonal);

  const totalRuns = preSeason.length + seasonalEntries.runCount;
  const allocationCount = preSeason.filter((entry) => entry.allocation).length + seasonalEntries.allocationCount;
  const totalHours = seasonalEntries.totalHours;
  const totalExtraHours = seasonalEntries.totalExtraHours;

  elements.dm.total.textContent = formatInteger(totalRuns);
  elements.dm.preCount.textContent = formatInteger(preSeason.length);
  elements.dm.seasonCount.textContent = formatInteger(seasonalEntries.runCount);
  elements.dm.allocations.textContent = formatInteger(allocationCount);
  elements.dm.hours.textContent = formatHours(totalHours, totalExtraHours);

  renderDmPreSeason(preSeason);
  renderDmSeasons(seasonalEntries.seasons);
}

function transformPreSeasonEntry(entry) {
  const dateValue = toDateValue(entry.date);
  return {
    dateValue,
    displayDate: dateValue ? formatDate(new Date(dateValue)) : '—',
    rawDate: entry.date || '',
    code: (entry.code || '').trim(),
    name: (entry.name || '').trim(),
    tier: toNumber(entry.tier),
    levelsPlus: toNumber(entry.levels_plus),
    levelsMinus: toNumber(entry.levels_minus),
    item: (entry.item || '').trim(),
    allocation: (entry.allocation || '').trim(),
    location: (entry.location || '').trim()
  };
}

function renderDmPreSeason(entries) {
  const tbody = elements.dm.preRows;
  if (!tbody) return;
  if (!entries.length) {
    tbody.replaceChildren();
    elements.dm.preEmpty.hidden = false;
    return;
  }
  elements.dm.preEmpty.hidden = true;
  const fragment = document.createDocumentFragment();
  entries.forEach((entry) => {
    const tr = document.createElement('tr');

    const dateCell = document.createElement('td');
    dateCell.textContent = entry.displayDate;
    if (entry.rawDate) dateCell.title = entry.rawDate;
    tr.appendChild(dateCell);

    const adventureCell = document.createElement('td');
    if (entry.code) {
      const code = document.createElement('span');
      code.className = 'adventure-code';
      code.textContent = entry.code;
      adventureCell.appendChild(code);
    }
    const name = document.createElement('span');
    name.className = 'adventure-name';
    name.textContent = entry.name || (entry.code ? '' : '—');
    adventureCell.appendChild(name);
    tr.appendChild(adventureCell);

    const tierCell = document.createElement('td');
    tierCell.textContent = entry.tier ? formatInteger(entry.tier) : '—';
    tr.appendChild(tierCell);

    const levelCell = document.createElement('td');
    const levelParts = [];
    if (entry.levelsPlus) levelParts.push(`+${formatInteger(entry.levelsPlus)}`);
    if (entry.levelsMinus) levelParts.push(`-${formatInteger(entry.levelsMinus)}`);
    levelCell.textContent = levelParts.length ? levelParts.join(' / ') : '0';
    tr.appendChild(levelCell);

    const itemCell = document.createElement('td');
    itemCell.textContent = entry.item || '—';
    tr.appendChild(itemCell);

    const allocationCell = document.createElement('td');
    allocationCell.textContent = entry.allocation || '—';
    tr.appendChild(allocationCell);

    const locationCell = document.createElement('td');
    locationCell.textContent = entry.location || '—';
    tr.appendChild(locationCell);

    fragment.appendChild(tr);
  });
  tbody.replaceChildren(fragment);
}

function buildSeasonalEntries(seasonal) {
  const seasons = [];
  let runCount = 0;
  let allocationCount = 0;
  let totalHours = 0;
  let totalExtraHours = 0;

  if (seasonal && typeof seasonal === 'object') {
    Object.entries(seasonal).forEach(([name, section]) => {
      const runs = Array.isArray(section?.runs) ? section.runs.map((run) => transformSeasonRun(run, name)) : [];
      const allocations = Array.isArray(section?.allocations) ? section.allocations.map((alloc) => transformSeasonAllocation(alloc, name)) : [];
      const totals = section?.totals || {};
      const hours = toNumber(totals.hours) || runs.reduce((sum, run) => sum + run.hours, 0);
      const extraHours = toNumber(totals.extra_hours) || runs.reduce((sum, run) => sum + run.extraHours, 0);

      seasons.push({
        name,
        runs,
        allocations,
        totals: {
          hours,
          extraHours,
          entries: toNumber(totals.entries) || runs.length
        }
      });

      runCount += runs.length;
      allocationCount += allocations.length;
      totalHours += hours;
      totalExtraHours += extraHours;
    });
  }

  return { seasons, runCount, allocationCount, totalHours, totalExtraHours };
}

function transformSeasonRun(run, seasonName) {
  const dateValue = toDateValue(run.date);
  return {
    seasonName,
    dateValue,
    displayDate: dateValue ? formatDate(new Date(dateValue)) : '—',
    rawDate: run.date || '',
    code: (run.code || '').trim(),
    name: (run.name || '').trim(),
    hours: toNumber(run.hours),
    extraHours: toNumber(run.extra_hours),
    roles: Array.isArray(run.roles) ? run.roles.filter(Boolean) : [],
    location: (run.location || '').trim()
  };
}

function transformSeasonAllocation(allocation, seasonName) {
  const dateValue = toDateValue(allocation.date);
  return {
    seasonName,
    dateValue,
    displayDate: dateValue ? formatDate(new Date(dateValue)) : '—',
    rawDate: allocation.date || '',
    allocation: (allocation.allocation || '').trim(),
    cost: toNumber(allocation.cost),
    levels: toNumber(allocation.levels_plus)
  };
}

function renderDmSeasons(seasons) {
  const container = elements.dm.seasonList;
  if (!container) return;
  if (!seasons.length) {
    const message = document.createElement('p');
    message.className = 'empty-message';
    message.textContent = 'No seasonal program entries recorded.';
    container.replaceChildren(message);
    return;
  }
  const fragment = document.createDocumentFragment();
  seasons.sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));
  seasons.forEach((season) => {
    const card = document.createElement('article');
    card.className = 'season-card';

    const heading = document.createElement('h4');
    heading.textContent = season.name;
    card.appendChild(heading);

    const meta = document.createElement('div');
    meta.className = 'season-meta summary-grid summary-grid--compact';
    meta.appendChild(createDefinitionEntry('Runs', formatInteger(season.runs.length)));
    meta.appendChild(createDefinitionEntry('Hours', formatAmount(season.totals.hours)));
    meta.appendChild(createDefinitionEntry('Extra hours', formatAmount(season.totals.extraHours)));
    meta.appendChild(createDefinitionEntry('Allocations', formatInteger(season.allocations.length)));
    card.appendChild(meta);

    const runsWrap = document.createElement('div');
    runsWrap.className = 'table-wrap';
    const runsTable = document.createElement('table');
    runsTable.className = 'log-table';
    runsTable.innerHTML = `
      <thead>
        <tr>
          <th scope="col">Date</th>
          <th scope="col">Program</th>
          <th scope="col">Hours</th>
          <th scope="col">Extra</th>
          <th scope="col">Roles</th>
          <th scope="col">Location</th>
        </tr>
      </thead>
      <tbody></tbody>`;
    const runBody = runsTable.querySelector('tbody');
    if (season.runs.length) {
      const runFragment = document.createDocumentFragment();
      season.runs.forEach((run) => {
        const tr = document.createElement('tr');
        const dateCell = document.createElement('td');
        dateCell.textContent = run.displayDate;
        if (run.rawDate) dateCell.title = run.rawDate;
        tr.appendChild(dateCell);

        const programCell = document.createElement('td');
        if (run.code) {
          const code = document.createElement('span');
          code.className = 'adventure-code';
          code.textContent = run.code;
          programCell.appendChild(code);
        }
        const name = document.createElement('span');
        name.className = 'adventure-name';
        name.textContent = run.name || (run.code ? '' : '—');
        programCell.appendChild(name);
        tr.appendChild(programCell);

        const hoursCell = document.createElement('td');
        hoursCell.textContent = formatAmount(run.hours);
        tr.appendChild(hoursCell);

        const extraCell = document.createElement('td');
        extraCell.textContent = formatAmount(run.extraHours);
        tr.appendChild(extraCell);

        const rolesCell = document.createElement('td');
        rolesCell.textContent = run.roles.length ? run.roles.join(', ') : '—';
        tr.appendChild(rolesCell);

        const locationCell = document.createElement('td');
        locationCell.textContent = run.location || '—';
        tr.appendChild(locationCell);

        runFragment.appendChild(tr);
      });
      runBody.replaceChildren(runFragment);
    } else {
      const emptyRow = document.createElement('tr');
      const cell = document.createElement('td');
      cell.colSpan = 6;
      cell.className = 'empty-message';
      cell.textContent = 'No runs recorded.';
      emptyRow.appendChild(cell);
      runBody.replaceChildren(emptyRow);
    }
    runsWrap.appendChild(runsTable);
    card.appendChild(runsWrap);

    if (season.allocations.length) {
      const allocationHeading = document.createElement('h5');
      allocationHeading.textContent = 'Allocations';
      card.appendChild(allocationHeading);
      const list = document.createElement('ul');
      list.className = 'allocation-list';
      season.allocations.forEach((allocation) => {
        const item = document.createElement('li');
        item.className = 'allocation-item';
        const primary = document.createElement('div');
        primary.textContent = allocation.allocation || '—';
        item.appendChild(primary);
        const meta = document.createElement('div');
        meta.className = 'meta';
        const parts = [];
        parts.push(allocation.displayDate);
        if (allocation.cost) parts.push(`${formatAmount(allocation.cost)} TP`);
        if (allocation.levels) parts.push(`Levels +${formatInteger(allocation.levels)}`);
        meta.textContent = parts.join(' • ');
        item.appendChild(meta);
        list.appendChild(item);
      });
      card.appendChild(list);
    }

    fragment.appendChild(card);
  });
  container.replaceChildren(fragment);
}

function transformCharacters(characters) {
  return Object.entries(characters)
    .map(([key, value]) => transformCharacter(key, value))
    .sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));
}

function transformCharacter(key, value) {
  const logs = Array.isArray(value?.logs) ? value.logs.map((log, index) => transformLog(log, index)) : [];
  const visibleLogs = logs.filter((log) => log.hasContent);
  const dateValues = visibleLogs.map((log) => log.dateValue).filter((val) => val != null);
  const firstDate = dateValues.length ? new Date(Math.min(...dateValues)) : null;
  const lastDate = dateValues.length ? new Date(Math.max(...dateValues)) : null;
  const totals = value?.finalTallies ?? {};

  return {
    key,
    name: key,
    nameLower: key.toLowerCase(),
    logs,
    visibleLogs,
    firstDate,
    lastDate,
    counts: {
      entries: logs.length,
      sessions: visibleLogs.length
    },
    finalTallies: {
      gold: toNumber(totals.gold),
      downtimeDays: toNumber(totals.downtimeDays),
      magicItems: sanitizeList(totals.magicItems),
      consumables: sanitizeList(totals.consumablesRemaining),
      supernatural: sanitizeList(totals.supernaturalGifts)
    }
  };
}

function transformLog(log, index) {
  const goldPlus = toNumber(log.goldPlus);
  const goldMinus = toNumber(log.goldMinus);
  const downtimePlus = toNumber(log.downtimePlus);
  const downtimeMinus = toNumber(log.downtimeMinus);
  const levelPlus = toNumber(log.levelPlus);
  const dateValue = toDateValue(log.date);
  const permItems = sanitizeList(log.permItems);
  const consumables = sanitizeList(log.consumables);
  const storyRewards = sanitizeList(log.storyRewards);
  const supernatural = sanitizeList(log.supernaturalGiftsFoundHere);
  return {
    index,
    dateValue,
    rawDate: log.date || '',
    displayDate: dateValue ? formatDate(new Date(dateValue)) : '—',
    code: (log.adventureCode || '').trim(),
    name: (log.adventureName || '').trim(),
    dm: (log.dm || '').trim(),
    levelPlus,
    goldPlus,
    goldMinus,
    goldNet: goldPlus - goldMinus,
    downtimePlus,
    downtimeMinus,
    downtimeNet: downtimePlus - downtimeMinus,
    permItems,
    consumables,
    storyRewards,
    supernatural,
    notes: typeof log.notes === 'string' ? log.notes.trim() : '',
    hasContent: Boolean(
      (log.adventureCode && log.adventureCode.trim()) ||
      (log.adventureName && log.adventureName.trim()) ||
      (log.dm && log.dm.trim()) ||
      goldPlus ||
      goldMinus ||
      downtimePlus ||
      downtimeMinus ||
      levelPlus ||
      permItems.length ||
      consumables.length ||
      storyRewards.length ||
      supernatural.length ||
      (typeof log.notes === 'string' && log.notes.trim())
    )
  };
}

function determineInitialState() {
  const parsed = parseHash(window.location.hash);
  if (parsed.tab === 'dm-log') {
    return { tab: 'dm-log', key: null };
  }
  const stored = getStoredSelection();
  if (!window.location.hash) {
    if (stored === DM_LOG_KEY) {
      return { tab: 'dm-log', key: null };
    }
    if (stored) {
      return { tab: 'characters', key: stored };
    }
  }
  return { tab: parsed.tab, key: parsed.key };
}

function setActiveTab(tab, options = {}) {
  const targetTab = tab === 'dm-log' ? 'dm-log' : 'characters';
  state.activeTab = targetTab;
  elements.tabs.forEach((button) => {
    const isActive = button.getAttribute('data-tab') === targetTab;
    button.classList.toggle('is-active', isActive);
    button.setAttribute('aria-selected', isActive ? 'true' : 'false');
  });
  elements.panels.forEach((panel) => {
    const isActive = panel.getAttribute('data-panel') === targetTab;
    panel.classList.toggle('is-active', isActive);
    panel.setAttribute('aria-hidden', isActive ? 'false' : 'true');
  });

  if (!options.skipHash) {
    if (targetTab === 'dm-log') {
      setHash('dm-log');
    } else {
      setHash(state.selectedKey ? encodeURIComponent(state.selectedKey) : '');
    }
  }

  if (!options.skipStorage) {
    if (targetTab === 'dm-log') {
      storeSelection(DM_LOG_KEY);
    } else if (state.selectedKey) {
      storeSelection(state.selectedKey);
    }
  }

  if (targetTab === 'dm-log') {
    loadDmPanel();
  }
}

function parseHash(hashValue) {
  const raw = (hashValue || '').replace(/^#/, '');
  if (!raw) return { tab: 'characters', key: null };
  const decoded = decodeURIComponent(raw);
  if (decoded === 'dm-log') {
    return { tab: 'dm-log', key: null };
  }
  return { tab: 'characters', key: decoded };
}

function resolveCharacterKey(key) {
  if (!key) return state.characters[0]?.key || null;
  return state.characters.some((char) => char.key === key) ? key : state.characters[0]?.key || null;
}

function getStoredSelection() {
  try {
    return localStorage.getItem(STORAGE_KEY);
  } catch (error) {
    return null;
  }
}

function storeSelection(value) {
  try {
    if (value) {
      localStorage.setItem(STORAGE_KEY, value);
    } else {
      localStorage.removeItem(STORAGE_KEY);
    }
  } catch (error) {
    /* ignore */
  }
}

function setHash(value) {
  const url = new URL(window.location.href);
  if (value) {
    url.hash = value;
  } else {
    url.hash = '';
  }
  if (url.hash === window.location.hash) return;
  history.replaceState(null, '', url);
}

function formatDate(value) {
  if (!value) return '—';
  const date = value instanceof Date ? value : new Date(value);
  if (!Number.isFinite(date.getTime())) return '—';
  return dateFormatter.format(date);
}

function formatDateTime(value) {
  if (!value) return '—';
  const date = value instanceof Date ? value : new Date(value);
  if (!Number.isFinite(date.getTime())) return '—';
  return dateTimeFormatter.format(date);
}

function formatInteger(value) {
  const number = Math.round(Number(value) || 0);
  return integerFormatter.format(number);
}

function formatAmount(value) {
  const number = Number(value) || 0;
  if (Math.abs(number % 1) < 1e-6) {
    return integerFormatter.format(Math.round(number));
  }
  return decimalFormatter.format(number);
}

function formatSigned(value) {
  const number = Number(value) || 0;
  if (Math.abs(number) < 1e-9) return '0';
  const formatted = formatAmount(Math.abs(number));
  return number > 0 ? `+${formatted}` : `-${formatted}`;
}

function formatHours(hours, extraHours) {
  const primary = formatAmount(hours || 0);
  if (extraHours) {
    return `${primary} h (+${formatAmount(extraHours)} extra)`;
  }
  return `${primary} h`;
}

function toDateValue(value) {
  if (!value) return null;
  const date = new Date(value);
  const timestamp = date.getTime();
  return Number.isFinite(timestamp) ? timestamp : null;
}

function toNumber(value) {
  if (typeof value === 'number') {
    return Number.isFinite(value) ? value : 0;
  }
  if (typeof value === 'string' && value.trim() !== '') {
    const parsed = Number.parseFloat(value);
    return Number.isFinite(parsed) ? parsed : 0;
  }
  return 0;
}

function sanitizeList(value) {
  if (!Array.isArray(value)) return [];
  return value
    .map((item) => {
      if (item == null) return null;
      if (typeof item === 'string') return item.trim();
      if (typeof item === 'object') {
        if ('name' in item) return String(item.name).trim();
        return JSON.stringify(item);
      }
      return String(item);
    })
    .filter(Boolean);
}

function createDefinitionEntry(label, value) {
  const wrapper = document.createElement('div');
  const dt = document.createElement('dt');
  dt.textContent = label;
  const dd = document.createElement('dd');
  dd.textContent = value;
  wrapper.append(dt, dd);
  return wrapper;
}
</script>
</body>
</html>
