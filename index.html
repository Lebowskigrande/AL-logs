<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Adventure Log Dashboard</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg"/>
<link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"/>
<link rel="shortcut icon" href="favicon.ico"/>
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"/>
<link rel="manifest" href="site.webmanifest"/>
<style>
:root{
  --bg:#e0e4ea; --surface:#fff; --ink:#0f172a; --muted:#64748b; --primary:#1a73e8; --border:#e5eaf3;
  --radius:16px; --shadow1:0 3px 12px rgba(16,24,40,.08); --shadow2:0 22px 44px rgba(16,24,40,.14);
  --dur:220ms; --ease:cubic-bezier(.2,.8,.2,1); --gap:14px; --min-card:320px;
  --danger:#dc2626;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%;min-height:100%;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg);scrollbar-gutter:stable}
body{display:flex;flex-direction:column;min-height:100vh;overflow:hidden}
.container{flex:1 1 auto;display:flex;flex-direction:column;max-width:1200px;width:100%;margin:0 auto;padding:28px 20px 40px;min-height:0}
.sheet-card{position:relative;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow1);display:flex;flex-direction:column;min-height:0;flex:1 1 auto;overflow:hidden}
.sheet-card-header{padding:20px 20px 18px;display:flex;flex-direction:column;gap:18px;background:inherit;flex:0 0 auto}
.sheet-card-body{flex:1 1 auto;display:flex;flex-direction:column;gap:16px;padding:20px;background:inherit;min-height:0}
.log-window{flex:1 1 auto;display:flex;flex-direction:column;position:relative;border-radius:0;border:none;background:var(--surface);box-shadow:none;overflow:hidden;min-height:0}
.log-window::before{content:none}
.log-list{--log-row-gap:0;flex:1 1 auto;display:flex;flex-direction:column;align-items:stretch;overflow-y:auto;overflow-x:hidden;scrollbar-gutter:stable;padding:6px;margin:0;gap:var(--log-row-gap);min-height:0}
.log-list::after{content:none}
.log-window>.empty{padding:48px 24px;display:flex;align-items:center;justify-content:center;text-align:center;font-size:14px;color:var(--muted)}
@media (max-width:768px){
  body{background:#fff}
  .container{padding:0 0 20px}
  .sheet-card{border:none;border-radius:0;box-shadow:none;background:#fff}
  .sheet-card-header{padding:20px 16px 18px}
  .sheet-card-body{padding:0 16px 16px}
  .log-window{border-radius:0;border:none;background:#fff;box-shadow:none}
  .log-list{padding:6px 0;gap:0}
}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.avatar{display:block;width:auto;height:72px;max-width:100%;border-radius:0;box-shadow:none;object-fit:contain}
.avatar.has-avatar{cursor:zoom-in;}
.avatar.avatar-fallback{background:linear-gradient(135deg,#dbeafe,#bfdbfe);}
.avatar:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:3px}
h1{margin:0;font-size:28px;line-height:1.05;font-weight:800;letter-spacing:-0.01em}
.header-main{display:flex;flex-direction:column;gap:6px;min-width:0;flex:1 1 auto}
.title-select-group{position:relative;display:inline-flex;flex-direction:column;align-items:flex-start;gap:6px;max-width:100%;min-width:0}
.title-select-wrap{display:flex;align-items:center;gap:6px;position:relative;margin:0;max-width:100%;min-width:0}
.title-select{display:none}
.title-select-trigger{appearance:none;border:none;background:linear-gradient(135deg,#ffffff,#f3f6fb);border-radius:14px;padding:12px 18px;font:inherit;font-size:clamp(20px,3vw,28px);line-height:1.1;font-weight:800;letter-spacing:-0.01em;color:var(--ink);display:inline-flex;align-items:center;gap:12px;cursor:pointer;box-shadow:var(--shadow1);transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease),background var(--dur) var(--ease);min-width:0;max-width:100%;text-align:left}
.title-select-trigger:hover{transform:translateY(-1px);box-shadow:var(--shadow2)}
.title-select-trigger:focus-visible{outline:3px solid rgba(26,115,232,.35);outline-offset:4px}
.title-select-trigger[aria-expanded="true"]{transform:translateY(-1px);box-shadow:var(--shadow2)}
.title-select-trigger:disabled{cursor:not-allowed;opacity:.6;box-shadow:none;transform:none;background:#e2e8f0;color:#64748b}
.title-select-trigger:disabled .char-toggle-icon{background:#cbd5f5;color:#475569}
.char-toggle-text{display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.char-toggle-icon{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#eef4ff;color:var(--primary);flex:0 0 auto;transition:transform var(--dur) var(--ease),background var(--dur) var(--ease)}
.title-select-trigger:hover .char-toggle-icon{background:#dbeafe}
.title-select-trigger[aria-expanded="true"] .char-toggle-icon{transform:rotate(180deg)}
.title-select-trigger svg{width:16px;height:16px}
.char-menu{position:absolute;top:calc(100% + 12px);left:0;min-width:280px;max-width:min(360px,calc(100vw - 32px));max-height:360px;padding:8px 0;border-radius:16px;background:#fff;border:1px solid var(--border);box-shadow:var(--shadow2);display:flex;flex-direction:column;gap:2px;z-index:55;overflow:auto}
.char-menu[hidden]{display:none}
.char-menu-item{width:100%;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 18px;font:inherit;font-size:16px;color:var(--ink);background:none;border:none;cursor:pointer;transition:background var(--dur) var(--ease),color var(--dur) var(--ease)}
.char-menu-item:hover,.char-menu-item:focus-visible{background:#eef4ff;color:var(--primary);outline:none}
.char-menu-item.active{color:var(--primary);font-weight:600}
.char-menu-text{flex:1 1 auto;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.char-menu-check{flex:0 0 auto;display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;color:var(--primary);opacity:0;transform:scale(.7);transition:transform var(--dur) var(--ease),opacity var(--dur) var(--ease)}
.char-menu-item.active .char-menu-check{opacity:1;transform:scale(1)}
.char-menu-check svg{width:18px;height:18px}
.char-badges{margin-top:4px;display:none;gap:8px;flex-wrap:wrap;align-items:center}
.char-badges .identity-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#eef4ff;color:#1e293b;font-weight:600;font-size:12px}
.char-badges .identity-badge .label{font-size:10px;letter-spacing:.08em;text-transform:uppercase;color:#64748b}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.muted{color:var(--muted);font-size:13px}
.char-meta{display:none;margin-top:4px;font-size:14px;font-weight:600;color:var(--muted)}

/* Toolbar */
.toolbar{margin-top:0;display:flex;gap:10px;flex-wrap:wrap}
.sheet-card-header > .toolbar{padding-top:12px}
.sheet-card-header > .header-quick{padding-top:12px}
.sheet-card-header > .header-quick.dm-summary{border-top:none;padding-top:0;margin-top:6px}
.select,.btn,.search input{border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 12px;font-weight:600;box-shadow:var(--shadow1)}
.btn{cursor:pointer;transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.btn:hover{transform:translateY(-1px);box-shadow:var(--shadow2)}
.btn.primary{background:var(--primary);color:#fff;border-color:transparent}
.btn-icon{display:inline-flex;align-items:center;justify-content:center;margin-right:6px}
.btn-icon svg{width:14px;height:14px}
.btn.danger{border:1px solid rgba(220,38,38,.2);background:rgba(254,226,226,1);color:var(--danger);}
.btn.danger:hover{background:#fecaca;border-color:rgba(220,38,38,.35)}
.btn.small{padding:6px 10px;font-size:12px;border-radius:10px;display:inline-flex;align-items:center;gap:6px}
.search{position:relative}
.search input{padding-left:36px;outline:none;width:220px;max-width:100%}
.search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:18px;height:18px;opacity:.6}
.toolbar .spacer{flex:1 1 auto}

.icon-btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:#fff;color:var(--muted);cursor:pointer;transition:background var(--dur) var(--ease),color var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.icon-btn svg{width:14px;height:14px;pointer-events:none}
.icon-btn:hover{color:var(--primary);background:#eef4ff;box-shadow:var(--shadow1)}
.icon-btn.danger{border-color:rgba(220,38,38,.2);background:#fee2e2;color:var(--danger)}
.icon-btn.danger:hover{color:#991b1b;background:#fecaca;box-shadow:var(--shadow1)}
.icon-btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.icon-btn.primary:hover{box-shadow:var(--shadow2)}
.icon-btn[disabled]{opacity:.5;cursor:not-allowed;box-shadow:none;background:#f1f5f9;color:#94a3b8}
.download-btn{margin-left:auto;align-self:flex-start;display:inline-flex;align-items:center;justify-content:center;gap:6px;width:auto;height:32px;padding:0 12px;border:none;border-radius:999px;background:transparent;box-shadow:none;color:var(--primary);font-weight:600;font-size:13px;line-height:1}
.download-btn .save-icon,.download-btn .save-spinner,.download-btn .save-success{display:none;align-items:center;justify-content:center;gap:6px}
.download-btn .save-icon svg,.download-btn .save-icon img,.download-btn .save-spinner svg{width:20px;height:20px}
.download-btn .save-success{letter-spacing:.01em}
.download-btn:not(.saving):not(.success) .save-icon{display:inline-flex}
.download-btn.saving .save-spinner{display:inline-flex}
.download-btn.success .save-success{display:inline-flex}
.download-btn::after{content:none}
.download-btn:hover{color:#1257b3}
.download-btn.dirty{color:#0b3f88;background:transparent}
.download-btn.dirty:hover{color:#0a3572}
.download-btn:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:2px}
.download-btn.saving{color:var(--muted);cursor:progress}
.download-btn.success{color:#15803d}
.download-btn.error{color:var(--danger)}
.download-btn .save-spinner svg{animation:save-spin 900ms linear infinite}

@keyframes save-spin{
  0%{transform:rotate(0)}
  100%{transform:rotate(360deg)}
}

/* Header metrics */
.header-quick{margin-top:8px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.dm-summary{gap:24px}
.dm-summary[hidden]{display:none}
.dm-metric{display:flex;flex-direction:column;gap:2px}
.dm-metric-label{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);font-weight:600}
.dm-metric-value{font-size:20px;font-weight:700;color:var(--ink)}
.dm-items-btn{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;font-weight:600;font-size:14px;color:var(--muted);box-shadow:var(--shadow1);cursor:pointer;transition:color var(--dur) var(--ease),background var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.dm-items-btn:hover,.dm-items-btn:focus-visible{color:var(--primary);background:#eef4ff;box-shadow:var(--shadow2);outline:none}
.dm-items-btn[aria-expanded="true"]{color:var(--primary);background:#eef4ff}
.dm-items-icon img{display:block;width:24px;height:24px}
.dm-items-count{font-weight:700;color:var(--ink)}
.inventory-buttons{display:flex;align-items:center;gap:18px;margin-left:auto;flex-wrap:wrap}
.inventory-link{display:inline-flex;align-items:center;gap:8px;background:transparent;border:none;padding:6px 8px;border-radius:10px;font-weight:600;font-size:14px;color:var(--muted);cursor:pointer;transition:color var(--dur) var(--ease),background var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.inventory-link .icon svg,.inventory-link .icon img,.inventory-metric .icon svg{width:24px;height:24px;display:block}
.inventory-link .text,.inventory-metric .text{letter-spacing:.02em}
.inventory-link:hover,.inventory-link:focus-visible{color:var(--primary);background:#eef4ff;box-shadow:0 8px 16px rgba(26,115,232,.18)}
.inventory-link:active{color:#0b57d0;background:#d7e4ff}
.inventory-link:focus-visible{outline:none}
.inventory-metric{display:inline-flex;align-items:center;gap:8px;padding:6px 0;color:var(--muted);font-weight:600}
.inventory-metric .text{white-space:nowrap}
.inventory-metric .amount{font-weight:700;color:var(--ink)}
.dm-items-card{max-width:420px;width:100%}
.dm-items-card .modal-body{display:flex;flex-direction:column;gap:12px;max-height:360px}
.dm-items-list{display:flex;flex-direction:column;gap:10px}
.dm-items-row{display:flex;flex-direction:column;gap:2px;font-size:14px;color:var(--ink)}
.dm-items-meta{font-size:12px;color:var(--muted)}
.dm-items-empty{color:var(--muted)}
@media (max-width:520px){
  .row{flex-wrap:nowrap;gap:10px}
  .header-main{flex:1 1 auto;min-width:0}
  .title-select-group{flex:1 1 auto;width:100%}
  .title-select-wrap{flex:1 1 auto;width:100%}
  .title-select-trigger{width:100%;font-size:clamp(20px,5vw,24px)}
  .char-menu{min-width:100%;max-width:calc(100vw - 32px)}
  .header-quick{flex-direction:column;align-items:flex-start;gap:12px}
  .inventory-buttons{margin-left:0}
  .log-row{flex-direction:column;align-items:flex-start}
  .log-row-chips{margin-left:0;padding-left:0;justify-items:start}
}

/* Grid / masonry columns */

/* Card */
.card{display:block;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow1);overflow:hidden;transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease),background var(--dur) var(--ease)}
.card:hover{transform:none;box-shadow:var(--shadow1)}
.log-list .card{--row-bg:transparent;position:relative;margin:0;background:transparent;border:0;border-bottom:1px solid var(--border);border-radius:0;box-shadow:none;overflow:visible;transition:border-color var(--dur) var(--ease);flex:0 0 auto}
.log-list .card:first-child{border-top:1px solid var(--border)}
.log-list .card::before{content:"";position:absolute;inset:0;pointer-events:none;border-left:3px solid transparent;transition:border-color var(--dur) var(--ease);z-index:1}
.log-list .card::after{content:"";position:absolute;top:-1px;right:0;bottom:-1px;left:0;background:var(--row-bg);pointer-events:none;transition:background var(--dur) var(--ease);z-index:0}
.log-list .card>*{position:relative;z-index:1}
.log-list .card:hover{--row-bg:rgba(15,23,42,.03)}
.log-list .card.open{--row-bg:#fff}
.log-list .card.open::before{border-left-color:rgba(148,163,184,.7)}
.log-list .card.open .card-hd{background:#f1f5f9}
.log-list .card.editing .card-hd{background:var(--row-bg,#f1f5f9)}
.log-list .card.editing{--row-bg:rgba(241,245,249,.9)}
.log-list .card.editing::before{border-left-color:rgba(100,116,139,.45)}
.log-list .card .card-hd{padding:14px 20px;display:flex;align-items:flex-start;gap:16px;min-height:0}
.log-list .card .card-hd .card-tools{margin-left:auto;display:flex;align-items:center;gap:8px}
.log-list .card-bd{border-top:1px solid rgba(148,163,184,.35);padding:0 20px;background:rgba(248,250,252,.85)}
.log-list .card .bd-in{padding:18px 0 20px}
.log-list .card .edit-form{padding:18px 0 24px}
.card:focus-visible{outline:2px solid rgba(100,116,139,.45);outline-offset:4px}
.card.focus-glow{animation:card-focus-glow 1300ms ease-out}
@keyframes card-focus-glow{
  0%{box-shadow:none;background-color:var(--row-bg,#fff)}
  40%{box-shadow:0 0 0 4px rgba(100,116,139,.32);background-color:rgba(148,163,184,.16)}
  100%{box-shadow:none;background-color:var(--row-bg,#fff)}
}
.card-hd{display:flex;align-items:flex-start;justify-content:flex-start;gap:16px;padding:16px 20px;cursor:pointer;min-height:0}
.card-hd .card-tools{display:flex;align-items:center;gap:8px;margin-left:auto;flex-wrap:nowrap}
.card .card-tools .icon-btn{opacity:0;visibility:hidden;pointer-events:none;transform:translateY(-4px);transition:opacity var(--dur) var(--ease),transform var(--dur) var(--ease)}
.card:hover .card-tools .icon-btn,
.card.open .card-tools .icon-btn,
.card.editing .card-tools .icon-btn,
.card .card-tools .icon-btn:focus-visible{opacity:1;visibility:visible;pointer-events:auto;transform:translateY(0)}
.card.editing .card-hd{cursor:default}
.card.editing{border-color:rgba(148,163,184,.45);box-shadow:var(--card-shadow,0 0 0 2px rgba(15,23,42,.08));background:var(--row-bg,#f8fafc)}
.log-row{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;width:100%;min-height:0}
.log-row-info{display:flex;flex-direction:column;align-items:flex-start;gap:4px;min-width:0;flex:1 1 auto}
.log-row-meta{color:var(--muted);font-size:12px;line-height:1.4}
.log-row-date{display:none;color:var(--muted);font-size:12px;line-height:1.4;white-space:nowrap}
.card.editing .log-row-meta{display:none}
.card.editing .log-row-date{display:flex;align-items:center;gap:8px}
.log-row-date .display{white-space:nowrap}
.log-row-title{flex:1 1 auto;min-width:0;position:relative;overflow:hidden;display:flex;align-items:center}
.log-row-title .display{display:block;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.35;font-size:14px;--scroll-distance:0px;--scroll-duration:0s;--scroll-delay:1.2s}
.log-row-title.is-adventure .display{font-weight:700}
.log-row-title.is-activity .display{font-weight:400;color:var(--muted)}
.log-row-title.scrollable .display{animation:log-row-scroll var(--scroll-duration,8s) ease-in-out infinite alternate;animation-delay:var(--scroll-delay,1.2s)}
@media (prefers-reduced-motion:reduce){
  .log-row-title.scrollable .display{animation:none}
}
.chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:0;min-height:0}
.log-row-chips{margin-left:auto;display:grid;grid-auto-flow:column;grid-auto-columns:minmax(88px,max-content);column-gap:10px;row-gap:6px;align-items:center;justify-items:end;overflow:hidden;padding-left:8px;font-size:13px;color:var(--muted);flex-shrink:0}
.log-row-chips .chip-slot{display:flex;justify-content:flex-end;min-width:88px}
.log-row-chips .chip-slot-empty{visibility:hidden}
.log-row-chips .pill{display:inline-flex;align-items:center;white-space:nowrap;background:rgba(148,163,184,.12);border:1px solid rgba(148,163,184,.24);border-radius:999px;padding:4px 10px;font-weight:600;font-size:12px;color:inherit;box-shadow:none}
.log-row-chips .pill.pill-level{background:transparent;border-color:rgba(59,130,246,.32);color:#1d4ed8}
.log-row-chips .pill.pill-level.pill-level-gain{background:rgba(59,130,246,.14);border-color:rgba(59,130,246,.42);color:#1d4ed8;box-shadow:none}
.log-row-chips .pill.gain{background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.3);color:#166534}
.log-row-chips .pill.loss{background:rgba(248,113,113,.16);border-color:rgba(248,113,113,.32);color:#b91c1c}
.log-row-chips .pill.neutral{background:rgba(148,163,184,.14);border-color:rgba(148,163,184,.28);color:var(--muted)}
.log-row-chips .pill.pill-gp,
.log-row-chips .pill.pill-gp.gain,
.log-row-chips .pill.pill-gp.loss,
.log-row-chips .pill.pill-gp.neutral{background:#fef3c7;border-color:#facc15;color:#854d0e}
.log-row-chips .pill.pill-dtd,
.log-row-chips .pill.pill-dtd.gain,
.log-row-chips .pill.pill-dtd.loss,
.log-row-chips .pill.pill-dtd.neutral{background:#e2e8f0;border-color:#cbd5f5;color:#334155}
.card-link-chip-row{display:none;margin-bottom:16px;justify-content:flex-start}
.card-link-chip{align-self:flex-start}
.card.open .card-link-chip-row{display:flex}
.pill{background:#fff7e6;color:#a05a00;border:1px solid #ffe3b0;border-radius:999px;padding:4px 8px;font-weight:700;font-size:11px}
.pill-link{display:inline-flex;align-items:center;justify-content:center;gap:6px;appearance:none;font:inherit;font-weight:600;font-size:12px;line-height:1;white-space:nowrap;text-decoration:none;background:#eef4ff;color:#1a73e8;border:1px solid rgba(26,115,232,.35);border-radius:999px;padding:4px 10px;cursor:pointer;box-shadow:none;transition:background var(--dur) var(--ease),color var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.pill-link svg{width:14px;height:14px;display:block;pointer-events:none}
.pill-link:hover{background:#dbeafe;color:#0b57d0;box-shadow:var(--shadow1)}
.pill-link:focus-visible{outline:2px solid rgba(26,115,232,.45);outline-offset:2px}
@keyframes log-row-scroll{
  0%,12%{transform:translateX(0)}
  88%,100%{transform:translateX(calc(-1 * var(--scroll-distance)))}
}
.titleLine{display:flex;flex-direction:column;gap:6px}
.date{color:var(--muted);font-size:13px;line-height:1.35}
.title{font-weight:400;font-size:12px;line-height:1.35;white-space:normal;word-break:break-word}
.subtitle{color:var(--muted);font-size:13px;line-height:1.4;min-height:0;white-space:normal}
.subtitle-row{display:flex;align-items:flex-start;flex-wrap:wrap;gap:8px;margin-top:8px;width:100%;min-height:0}
.subtitle-row .subtitle{margin-top:0}
.subtitle-row .chips{margin-top:0;margin-left:0;justify-content:flex-start}
.card.open .subtitle-row{flex-wrap:wrap;gap:8px}
.card.open .subtitle-row .chips{margin-left:0;justify-content:flex-start}

/* Collapsible */
.card-bd{height:0;overflow:hidden;border-top:1px solid var(--border);transition:height var(--card-dur,var(--dur)) var(--ease),opacity var(--card-dur,var(--dur)) linear;padding:0 14px;opacity:0;will-change:height,opacity;contain:layout paint}
.bd-in{padding:12px 0 16px}
.edit-form{padding:12px 0 16px;display:none}
.card.editing .edit-form{display:none}
@media (prefers-reduced-motion:reduce){.card-bd{transition:none}}

/* Fields */
.field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
.field .k{color:var(--muted);font-size:12px;font-weight:400}
.field .v{width:100%}
.field .display{display:block}
.field .editor{display:none}
.card.editing .field .display{display:none}
.card.editing .field .editor{display:block}
.field.inline-field{flex-direction:row;align-items:center;gap:10px;margin:4px 0 0}
.field.inline-field .k{font-size:11px;font-weight:600;letter-spacing:.08em;text-transform:uppercase}
.field.inline-field .v{display:flex;align-items:center;gap:10px;width:auto;flex:1 1 auto}
.field.inline-field .display{display:inline-flex;font-weight:600;color:var(--ink)}
.field.inline-field .editor{display:none}
.card.editing .field.inline-field .editor{display:flex;align-items:center}
.card.editing .field.inline-field .editor > *{flex:1 1 220px;max-width:100%}
.card.editing .field.inline-field input{width:100%;min-width:0}
.show-when-editing{display:none}
.card.editing .show-when-editing{display:block}
.field.show-when-editing{display:none}
.card.editing .field.show-when-editing{display:flex}
.editable-inline .display{display:inline}
.editable-inline .editor{display:none}
.card:not(.editing) .editable-inline .editor{display:none!important}
.card.editing .editable-inline{width:100%;min-width:0}
.card.editing .editable-inline .display{display:none}
.card.editing .editable-inline .editor{display:flex;width:100%}
.card.editing .editable-inline .editor > *{flex:1 1 auto;width:100%;min-width:0}
.editable-inline .editor input,.editable-inline .editor select{font:inherit;padding:6px 8px;line-height:1.3;border:1px solid var(--border);border-radius:10px;outline:none;background:#fff;max-width:100%;min-width:0;box-shadow:none;min-height:calc(1em + 12px)}
.editable-inline .editor input{min-width:0;max-width:100%}
.card.editing .subtitle-row{flex-wrap:wrap;align-items:flex-start;gap:6px}
.card.editing .subtitle-row .subtitle{width:100%;min-width:0}
.card.editing .subtitle-row .chips{margin-left:0;width:100%;justify-content:flex-start}
.card.editing .activity-line{flex-wrap:wrap;gap:6px}
.card.editing .activity-left{flex-wrap:wrap;white-space:normal;min-width:0}
.card.editing .activity-left .editable-inline{flex:1 1 100%;width:100%}
.card.editing .activity-line .chips{margin-left:0;width:100%;justify-content:flex-start}
.field input,.field textarea,.field select{font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;resize:vertical}
.field textarea{min-height:80px}
.notes-field .v{display:flex;flex-direction:column}
.notes-field .v textarea{min-height:200px;width:100%}
.kv2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:8px 0}
.kvsingle{display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;margin:6px 0}
.kvsingle .k{color:var(--muted);font-size:12px;font-weight:400}
.kvsingle .v{font-weight:400;min-width:0}
.kvsingle .display{display:block}
.kvsingle .editor{display:none;width:100%}
.card.editing .kvsingle .display{display:none}
.card.editing .kvsingle .editor{display:flex}
.card.editing .kvsingle .editor > *{flex:1 1 auto;width:100%;min-width:0}
.kvsingle .editor input,.kvsingle .editor select{font:inherit;padding:4px 6px;border:1px solid var(--border);border-radius:10px;outline:none;background:#fff;max-width:100%;min-width:0;box-shadow:none}
.scrollbox{background:none;border:none;border-radius:0;padding:0;max-height:160px;overflow:auto}
.scrollbox .item{margin:2px 0}
.notesbox{background:none;border:none;border-radius:0;padding:0;max-height:160px;overflow:auto}
.empty{text-align:center;color:var(--muted);padding:40px 0}
.list-editor{display:flex;flex-direction:column;gap:8px}
.list-editor .list{display:flex;flex-direction:column;gap:8px}
.list-editor .list-row{display:flex;align-items:center;gap:8px}
.list-editor .list-row input,.list-editor .list-row select{flex:1 1 auto;font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;min-width:0}
.list-editor .list-row button{width:32px;height:32px;border-radius:10px;border:1px solid rgba(220,38,38,.25);background:#fee2e2;color:var(--danger);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background var(--dur) var(--ease),color var(--dur) var(--ease)}
.list-editor .list-row button:hover{background:#fecaca;color:#991b1b}
.list-editor .list-row button svg{width:16px;height:16px}
.list-editor .add-row{align-self:flex-start;border:1px dashed var(--border);background:#f8fafc;color:var(--primary);border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}
.list-editor .add-row:hover{background:#eef4ff}
.list-editor .list-row select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,currentColor 50%),linear-gradient(135deg,currentColor 50%,transparent 50%);background-position:calc(100% - 16px) calc(50% + 3px),calc(100% - 11px) calc(50% + 3px);background-size:5px 5px;background-repeat:no-repeat;padding-right:28px;cursor:pointer}
.list-editor .list-row select:focus{outline:none;box-shadow:0 0 0 2px rgba(15,23,42,.18)}
.edit-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
.card:not(.editing) .edit-actions{display:none}
.card.editing .edit-actions{display:flex}
.edit-actions .delete-btn{margin-right:auto}

.edit-form form{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.edit-form .field{margin:0}
.edit-form .field.full{grid-column:1 / -1}
.edit-form .field .v input,.edit-form .field .v select,.edit-form .field .v textarea{width:100%}
.edit-form input[type=number]{max-width:8ch}
.edit-form .kv2{grid-column:1 / -1;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:0}
.edit-form .kv2 .kvsingle{margin:0}
.edit-form .kv2 .v{display:flex;align-items:center}
.edit-form .kv2 .v input{flex:0 0 auto;width:8ch}
.edit-form .list-editor{grid-column:1 / -1}
.edit-form .edit-actions{grid-column:1 / -1;margin-top:4px}

.card.editing input,.card.editing textarea,.card.editing select,.card.editing .list-editor .list-row input,.card.editing .list-editor .list-row select{outline:none;box-shadow:none;border-radius:10px;background:#fff}
.card.editing input:focus,.card.editing textarea:focus,.card.editing select:focus,.card.editing .editable-inline .editor input:focus,.card.editing .editable-inline .editor select:focus{outline:none;box-shadow:0 0 0 2px rgba(15,23,42,.18)}

body.modal-open{overflow:hidden;}
body.modal-open #addCard{display:none;}
body.modal-open #addCardMenu{display:none;}

#addCard{
  position:fixed;
  bottom:24px;
  right:24px;
  width:64px;
  height:64px;
  border-radius:50%;
  border:none;
  background:linear-gradient(135deg,#ff8a5c,#ff3d71);
  color:#fff;
  box-shadow:0 16px 30px rgba(255,61,113,.35);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease);
  z-index:60;
}
#addCard svg{width:28px;height:28px}
#addCard:hover{transform:translateY(-2px);box-shadow:0 24px 40px rgba(255,61,113,.45)}
#addCard:focus-visible{outline:3px solid rgba(255,61,113,.4);outline-offset:4px}
.toolbar #addCard{margin-left:auto}

.fab-menu{position:fixed;right:24px;bottom:100px;display:flex;flex-direction:column;gap:6px;min-width:200px;padding:8px 0;border-radius:12px;background:#fff;box-shadow:var(--shadow2);border:1px solid var(--border);z-index:65}
.fab-menu[hidden]{display:none}
.fab-menu button{padding:10px 16px;text-align:left;background:none;border:none;font:inherit;color:var(--ink);cursor:pointer;transition:background var(--dur) var(--ease),color var(--dur) var(--ease);display:flex;align-items:center;gap:10px}
.fab-menu button:hover,.fab-menu button:focus-visible{background:#eef4ff;color:var(--primary);outline:none}

/* Activity cards (compact header) */
.pill.muted{background:#eef1f6;color:#475569;border-color:#dce2ee}

/* Modals (shared) */
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(15,23,42,.4);z-index:50}
.modal.open{display:grid}
.modal-card{width:min(92vw,800px);max-height:80vh;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow2);display:flex;flex-direction:column;overflow:hidden}
.modal-hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700;display:flex;align-items:center;justify-content:space-between;gap:8px}
.modal-body{padding:12px 16px;overflow:auto}
.modal-actions{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
.inv-meta{color:var(--muted);font-size:12px}
.inv-list{display:flex;flex-direction:column;gap:6px}
.modal-add{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.modal-add input,.modal-add select{font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
.modal-add button{border:1px solid var(--primary);background:rgba(26,115,232,.1);color:var(--primary);border-radius:10px;padding:8px 14px;font-weight:600;cursor:pointer}
.modal-add button:hover{background:rgba(26,115,232,.2)}

/* Inventory row styles */
.inv-row{display:grid;grid-template-columns:1fr auto;align-items:center;padding:6px 10px;border-radius:8px;cursor:pointer;transition:background .2s}
.inv-row:nth-child(odd){background:#fafbfc}
.inv-row:nth-child(even){background:#f2f5f8}
.inv-row.active{background:#e8f0ff;font-weight:600}
.inv-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.inv-name.consumable-name{display:flex;flex-direction:column;align-items:flex-start;gap:4px;min-width:0}
.inv-name.consumable-name .cons-primary{display:flex;align-items:center;gap:6px;flex-wrap:nowrap;min-width:0}
.inv-name.consumable-name .cons-name{display:block;font-weight:600;min-width:0;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1 1 auto}
.inv-name.consumable-name .cons-chips{display:inline-flex;flex-wrap:nowrap;gap:6px;margin-left:6px;flex:0 0 auto}
.inv-tools{display:flex;align-items:center;gap:6px}
.inv-row .delete-btn{display:none;margin-left:8px}
.modal.editing .inv-row{cursor:default}
.modal.editing .inv-row .delete-btn{display:inline-flex}
.modal.editing .inv-row .attune-pill{pointer-events:none;opacity:.6}
.modal.editing .inv-row .qty-icon{pointer-events:none;opacity:.6}
.modal.editing .inv-row .qty-pill{opacity:.6}

/* Attunement pill (perm modal, active rows only) */
.attune-pill{display:inline-block;border:1px solid #cfe0ff;background:#eef4ff;color:#1a73e8;border-radius:999px;padding:2px 8px;font-size:11px;user-select:none;cursor:pointer;transition:background .2s,color .2s}
.attune-pill.on{background:#1a73e8;color:#fff}

/* Consumables qty controls */
.inv-row .qty{display:flex;align-items:center;gap:8px;white-space:nowrap}
.qty-pill{display:inline-block;min-width:28px;padding:2px 8px;text-align:center;border:1px solid var(--border);border-radius:999px;background:#f9fafb;font-size:11px;color:#475569}
.qty-input{width:64px;padding:4px 8px;border:1px solid var(--border);border-radius:10px;font:inherit;font-size:12px;text-align:center;background:#fff}
.qty-icon{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;color:#1e3a8a;background:transparent;cursor:pointer;transition:color var(--dur) var(--ease),transform var(--dur) var(--ease)}
.qty-icon svg{width:22px;height:22px;stroke-width:1.8}
.qty-icon:hover{color:#1a73e8;transform:translateY(-1px)}
.qty-icon:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:3px}
.qty-icon.disabled{opacity:.35;cursor:not-allowed;transform:none}
.qty-icon.disabled:hover{color:inherit}
.cons-section{display:flex;flex-direction:column;gap:6px;padding:2px 0}
.cons-section+.cons-section{margin-top:16px}
.cons-section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);padding:0 4px}
.cons-sublist{display:flex;flex-direction:column;gap:6px}
.cons-name{display:block;font-weight:600}
.cons-chips{display:inline-flex;gap:6px;margin-left:6px;flex-wrap:wrap;align-items:center}
.cons-chip{display:inline-flex;align-items:center;justify-content:center;padding:2px 6px;border-radius:999px;background:#eef4ff;color:#1e3a8a;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em}
.cons-chip--potion{background:#fef3c7;color:#b45309}
.cons-chip--scroll{background:#ede9fe;color:#5b21b6}
.cons-secondary{display:block;margin-top:3px;font-size:11px;color:var(--muted);white-space:normal}

/* Reduce scroll anchoring jumps */
html,body,.log-list,.card-bd{overflow-anchor:none}

/* New entry overlay */
.card-overlay{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(15,23,42,.4);backdrop-filter:blur(2px);z-index:70;padding:48px 16px;overflow:auto}
.card-overlay.open{display:flex}
.card-overlay .card{max-width:720px;width:100%;box-shadow:var(--shadow2);margin:0 auto}
.card-overlay .card .card-tools{display:none}
.avatar-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.7);backdrop-filter:blur(2px);z-index:80;padding:24px}
.avatar-overlay.open{display:flex}
.avatar-overlay .avatar-preview{display:flex;align-items:center;justify-content:center;max-width:calc(100vw - 48px);max-height:calc(100vh - 48px)}
.avatar-overlay .avatar-preview img{display:block;width:auto;height:auto;max-width:100%;max-height:100%;filter:drop-shadow(0 40px 90px rgba(15,23,42,.6))}
.avatar-overlay{cursor:zoom-out}
body.avatar-overlay-open{overflow:hidden}
</style>
</head>
<body>
<div class="container">
  <section class="sheet-card">
    <div class="sheet-card-header">
      <div class="row">
        <img id="charAvatar" class="avatar" alt="Character avatar"/>
        <div class="header-main">
          <div class="title-select-group">
            <label id="charSelToggleLabel" for="charSelToggle" class="sr-only">Select a sheet or character</label>
            <h1 class="title-select-wrap" id="charTitle">
              <button id="charSelToggle" class="title-select-trigger" type="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="charSelMenu" aria-labelledby="charSelToggleLabel charSelDisplay">
                <span id="charSelDisplay" class="char-toggle-text">Select a character</span>
                <span class="char-toggle-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m6 9 6 6 6-6" />
                  </svg>
                </span>
              </button>
              <select id="charSel" class="title-select" aria-hidden="true" tabindex="-1"></select>
            </h1>
            <div id="charSelMenu" class="char-menu" role="listbox" aria-labelledby="charSelToggle" aria-hidden="true" hidden></div>
          </div>
          <div id="charMeta" class="char-meta muted" aria-live="polite"></div>
          <div id="charBadges" class="char-badges" aria-live="polite"></div>
        </div>
        <button id="downloadData" class="icon-btn download-btn" type="button" title="Save data.js" aria-label="Save data.js">
          <span class="save-icon" aria-hidden="true">
            <img src="save.svg" alt="" width="20" height="20"/>
          </span>
          <span class="save-spinner" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="9" stroke-opacity=".3"/>
              <path d="M21 12a9 9 0 0 0-9-9"/>
            </svg>
          </span>
          <span class="save-success" aria-hidden="true">Saved</span>
        </button>
      </div>
      <div class="toolbar">
        <div class="search">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/></svg>
          <input id="q" placeholder="Search adventures"/>
        </div>
        <button id="activityToggle" class="btn small" type="button" aria-pressed="false">Hide activities</button>
        <button id="addCard" title="Add new entry" aria-label="Add new entry" type="button" aria-haspopup="true" aria-expanded="false">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
        </button>
      </div>
      <div class="header-quick" id="headerQuick">
        <div class="inventory-buttons">
          <button id="magicItemsBtn" class="inventory-link" type="button" title="View permanent magic items" aria-label="View permanent magic items">
            <span class="icon" aria-hidden="true">
              <img src="chest.png" alt="" width="24" height="24"/>
            </span>
            <span class="sr-only" id="magicItemsCount">0</span>
          </button>
          <button id="consumablesBtn" class="inventory-link" type="button" title="View consumables" aria-label="View consumables">
            <span class="icon" aria-hidden="true">
              <img src="potion.png" alt="" width="24" height="24"/>
            </span>
            <span class="sr-only" id="consumablesCount">0</span>
          </button>
          <div class="inventory-metric" id="goldMetric" role="group" aria-label="Gold pieces total">
            <span class="text">Gold</span>
            <span class="amount" id="goldValue">0</span>
          </div>
          <div class="inventory-metric" id="downtimeMetric" role="group" aria-label="Downtime days total">
            <span class="text">Downtime</span>
            <span class="amount" id="downtimeValue">0</span>
          </div>
        </div>
      </div>
      <div class="header-quick dm-summary" id="dmSummaryBar" hidden aria-hidden="true">
        <div class="dm-metric" id="dmHoursMetric" role="group" aria-label="Available Dungeon Master hours">
          <div class="dm-metric-label">Available hours</div>
          <div class="dm-metric-value" id="dmHoursValue">0</div>
        </div>
        <div class="dm-metric" id="dmLevelsMetric" role="group" aria-label="Available Dungeon Master levels">
          <div class="dm-metric-label">Available levels</div>
          <div class="dm-metric-value" id="dmLevelsValue">0</div>
        </div>
        <button id="dmItemsBtn" class="dm-items-btn" type="button" aria-haspopup="dialog" aria-controls="dmItemsModal" aria-expanded="false" title="View unallocated pre-Season 11 magic items">
          <span class="sr-only" id="dmItemsLabel">View unallocated pre-Season 11 magic items</span>
          <span class="dm-items-icon" aria-hidden="true">
            <img src="chest.png" alt="" width="24" height="24"/>
          </span>
          <span class="dm-items-count" id="dmItemsCount">0</span>
        </button>
      </div>
    </div>
    <div class="sheet-card-body">
      <div class="log-window">
        <div id="grid" class="log-list"></div>
        <div id="empty" class="empty" style="display:none;">No adventures match your filters.</div>
      </div>
    </div>
  </section>
</div>

<div id="addCardMenu" class="fab-menu" role="menu" hidden aria-hidden="true"></div>

<div id="dmItemsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dmItemsTitle">
  <div class="modal-card dm-items-card">
    <div class="modal-hd">
      <div id="dmItemsTitle">Pre-Season 11 magic items</div>
    </div>
    <div class="modal-body">
      <div id="dmItemsList" class="dm-items-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn small" id="dmItemsClose" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Permanent Items Modal -->
<div id="invModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="invTitle">
  <div class="modal-card">
    <div class="modal-hd">
      <div id="invTitle">Permanent Magic Items</div>
      <div class="inv-meta" id="invMeta"></div>
    </div>
    <div class="modal-body">
      <div id="invSummary" class="inv-meta" style="margin-bottom:8px;"></div>
      <div id="invList" class="inv-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="invClose">Close</button>
    </div>
  </div>
</div>

<!-- Consumables Modal -->
<div id="consModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="consTitle">
  <div class="modal-card">
    <div class="modal-hd">
      <div id="consTitle">Consumables</div>
      <div class="inv-meta" id="consMeta"></div>
    </div>
    <div class="modal-body">
      <div id="consSummary" class="inv-meta" style="margin-bottom:8px;"></div>
      <div id="consList" class="inv-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="consClose">Close</button>
    </div>
  </div>
</div>

<div id="cardOverlay" class="card-overlay" role="dialog" aria-modal="true" aria-hidden="true"></div>
<div id="avatarOverlay" class="avatar-overlay" role="dialog" aria-modal="true" aria-hidden="true" tabindex="-1">
  <div class="avatar-preview">
    <img class="avatar-preview-image" alt="Character avatar"/>
  </div>
</div>

<script>
(function(){
  var KEY='al_logs_data_version';
  window.AL_DATA_VERSION_KEY=KEY;
  var version='';
  try{
    version=localStorage.getItem(KEY)||'';
  }catch(err){
    version='';
  }
  if(!version){
    try{
      version=sessionStorage.getItem(KEY)||'';
    }catch(err){
      version='';
    }
  }
  window.AL_DATA_VERSION=version;
  var cacheBust=String(Date.now());
  window.AL_DATA_CACHE_BUST=cacheBust;
  var srcBase=version?('data.js?v='+encodeURIComponent(version)):'data.js';
  var separator=srcBase.indexOf('?')===-1?'?':'&';
  var src=srcBase+separator+'cb='+encodeURIComponent(cacheBust);
  try {
    var script=document.createElement('script');
    script.src=src;
    script.id='dataScript';
    script.async=false;
    script.setAttribute('data-version', version||'');
    script.setAttribute('data-cache-bust', cacheBust);
    var parent=document.currentScript&&document.currentScript.parentNode;
    (parent||document.head||document.body||document.documentElement).appendChild(script);
  } catch(err){
    var fallback=document.createElement('script');
    fallback.src=src;
    fallback.id='dataScript';
    fallback.async=false;
    fallback.setAttribute('data-version', version||'');
    fallback.setAttribute('data-cache-bust', cacheBust);
    (document.head||document.body||document.documentElement).appendChild(fallback);
  }
})();
</script>
<script src="dmData.js"></script>
<script>
/* --- data boot --- */
let DATA = window.DATA || null;

/* --- DOM handles --- */
const charSel  = document.getElementById('charSel');
const charSelToggle = document.getElementById('charSelToggle');
const charSelMenu = document.getElementById('charSelMenu');
const charSelDisplay = document.getElementById('charSelDisplay');
const DEFAULT_CHARACTER_MENU_LABEL='Select a character';
const avatarEl = document.getElementById('charAvatar');
const downloadBtn = document.getElementById('downloadData');
const qEl      = document.getElementById('q');
const grid     = document.getElementById('grid');
const emptyEl  = document.getElementById('empty');
const badgesEl = document.getElementById('charBadges');
const metaEl   = document.getElementById('charMeta');
const addCardBtn = document.getElementById('addCard');
const addCardMenu = document.getElementById('addCardMenu');
const activityToggleBtn = document.getElementById('activityToggle');
const headerQuick = document.getElementById('headerQuick');
const dmSummaryBar = document.getElementById('dmSummaryBar');
const dmHoursValueEl = document.getElementById('dmHoursValue');
const dmLevelsValueEl = document.getElementById('dmLevelsValue');
const dmItemsCountEl = document.getElementById('dmItemsCount');
const dmItemsBtnEl = document.getElementById('dmItemsBtn');
const dmItemsModal = document.getElementById('dmItemsModal');
const dmItemsListEl = document.getElementById('dmItemsList');
const dmItemsCloseBtn = document.getElementById('dmItemsClose');
const cardOverlay=document.getElementById('cardOverlay');
const avatarOverlay=document.getElementById('avatarOverlay');
const avatarPreview=avatarOverlay?avatarOverlay.querySelector('.avatar-preview'):null;
const avatarPreviewImage=avatarOverlay?avatarOverlay.querySelector('.avatar-preview-image'):null;
const dataScriptEl=document.getElementById('dataScript');
const DATA_VERSION_KEY=window.AL_DATA_VERSION_KEY||'al_logs_data_version';
let dataVersion=(dataScriptEl&&dataScriptEl.getAttribute('data-version'))||window.AL_DATA_VERSION||'';
window.AL_DATA_VERSION=dataVersion;
let dataCacheBust=(dataScriptEl&&dataScriptEl.getAttribute('data-cache-bust'))||window.AL_DATA_CACHE_BUST||'';
window.AL_DATA_CACHE_BUST=dataCacheBust;
const DATA_DRAFT_STORAGE_KEY='al_logs_data_draft_v1';
if(avatarEl){
  avatarEl.tabIndex=-1;
  avatarEl.addEventListener('click',evt=>{
    if(!avatarEl.classList.contains('has-avatar')) return;
    evt.preventDefault();
    openAvatarOverlay();
  });
  avatarEl.addEventListener('keydown',evt=>{
    if(!avatarEl.classList.contains('has-avatar')) return;
    if(evt.key==='Enter'||evt.key===' '){
      evt.preventDefault();
      openAvatarOverlay();
    }
  });
}
const goldMetricEl=document.getElementById('goldMetric');
const goldValueEl=document.getElementById('goldValue');
const downtimeMetricEl=document.getElementById('downtimeMetric');
const downtimeValueEl=document.getElementById('downtimeValue');
const magicItemsBtn=document.getElementById('magicItemsBtn');
const consumablesBtn=document.getElementById('consumablesBtn');
const magicItemsCountEl=document.getElementById('magicItemsCount');
const consumablesCountEl=document.getElementById('consumablesCount');
const defaultEmptyMessage=emptyEl?(emptyEl.textContent||''):'';
const defaultSearchPlaceholder=qEl?(qEl.getAttribute('placeholder')||''):'';
const DM_EMPTY_MESSAGE='No log entries match your filters.';

const DM_LOG_KEY='__dmLog';
const DM_DATA=(typeof window!=='undefined' && window.DMDATA && typeof window.DMDATA==='object')?window.DMDATA:null;
let DM_ENTRIES=[];
let DM_SUMMARY={ runs:0, allocations:0, earnedHours:0, earnedBonus:0, allocatedHours:0, allocatedBonus:0, allocatedCost:0, earnedLevels:0, spentLevels:0, entries:0 };
let DM_PRE_ITEMS=[];
let overlayCard=null;
const scrollableTitleRegistry=(()=>{
  const wrappers=new Set();
  let rafId=null;
  const schedule=()=>{
    if(rafId!=null) return;
    rafId=requestAnimationFrame(()=>{
      rafId=null;
      wrappers.forEach((wrapper)=>{
        if(wrapper && typeof wrapper.__refreshScroll==='function'){
          try{
            wrapper.__refreshScroll();
          }catch(err){
            /* no-op */
          }
        }
      });
    });
  };
  if(typeof window!=='undefined'){
    window.addEventListener('resize',schedule,{passive:true});
  }
  return{
    register(wrapper){
      if(!wrapper) return;
      wrappers.add(wrapper);
      schedule();
    },
    unregister(wrapper){
      wrappers.delete(wrapper);
    },
    schedule
  };
})();
buildDmEntries();
if(avatarEl){
  try{ avatarEl.decoding='async'; }catch(err){ /* no-op */ }
  try{ avatarEl.loading='eager'; }catch(err){ /* no-op */ }
  try{ avatarEl.fetchPriority='high'; }catch(err){ /* no-op */ }
}
if(avatarPreviewImage){
  try{ avatarPreviewImage.decoding='async'; }catch(err){ /* no-op */ }
}
const AVATAR_PATH_STORAGE_PREFIX='al_logs_avatar_paths_v1';
const avatarPathStorageKey=`${AVATAR_PATH_STORAGE_PREFIX}_${dataVersion||'0'}`;
const AVATAR_MANIFEST=Object.freeze({
  'Ecthelion':'Ecthelion.png',
  'Gnat':'gnat.png',
  'Squelch':'squelch.png',
  'Squelch (prequel)':'squelch (prequel).png',
  'Norixius':'norixius.png',
  'Madam Renata':'madam renata.png',
  'Goblert Godfrey':'goblert godfrey.png',
  'Lyrielle':'lyrielle.png',
  'Sentient Hat':'sentient hat.png',
  'Arvistan Brightwave':'arvistan.png',
  'Agatha':'agatha.png',
  'Darrendrian':'darrendrian.png',
  'Copy of Darrendrian':'darrendrian.png',
  'Morty':'morty.png',
  'Zandarax':'zandarax.png',
  'Zandaraxs Inventory':'zandarax.png',
  'Zandaraxs Bastion':'zandarax.png'
});
const AVATAR_FALLBACK_PATH='avatar-fallback.svg';
const avatarCache=new Map();
const avatarPreloadPromises=new Map();
let avatarLoadToken=0;
let persistedAvatarPaths={};
let avatarPathsDirty=false;
let avatarPathsSaveTimeout=null;
try{
  const raw=localStorage.getItem(avatarPathStorageKey);
  if(raw){
    const parsed=JSON.parse(raw);
    if(parsed&&typeof parsed==='object'&&!Array.isArray(parsed)){
      persistedAvatarPaths=parsed;
    }
  }
}catch(err){
  persistedAvatarPaths={};
}
function schedulePersistAvatarPaths(){
  if(!avatarPathsDirty) return;
  if(avatarPathsSaveTimeout) return;
  avatarPathsSaveTimeout=setTimeout(()=>{
    avatarPathsSaveTimeout=null;
    if(!avatarPathsDirty) return;
    try{
      localStorage.setItem(avatarPathStorageKey,JSON.stringify(persistedAvatarPaths));
      avatarPathsDirty=false;
    }catch(err){
      /* no-op */
      avatarPathsDirty=false;
    }
  },200);
}
function persistAvatarPathsImmediately(){
  if(!avatarPathsDirty) return;
  try{
    localStorage.setItem(avatarPathStorageKey,JSON.stringify(persistedAvatarPaths));
    avatarPathsDirty=false;
  }catch(err){
    /* no-op */
    avatarPathsDirty=false;
  }
}
if(typeof window!=='undefined'){
  window.addEventListener('pagehide',persistAvatarPathsImmediately);
  window.addEventListener('beforeunload',persistAvatarPathsImmediately);
}
function getPersistedAvatarPath(key){
  if(!key) return '';
  const normalized=String(key);
  return persistedAvatarPaths[normalized]||'';
}
function rememberAvatarPath(key,path){
  if(!key) return;
  const normalized=String(key);
  if(!path){
    if(Object.prototype.hasOwnProperty.call(persistedAvatarPaths,normalized)){
      delete persistedAvatarPaths[normalized];
      avatarPathsDirty=true;
      schedulePersistAvatarPaths();
    }
    return;
  }
  if(persistedAvatarPaths[normalized]===path) return;
  persistedAvatarPaths[normalized]=path;
  avatarPathsDirty=true;
  schedulePersistAvatarPaths();
}
function forgetAvatarPath(key){
  rememberAvatarPath(key,null);
}
const ICON_TRASH='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-14"/></svg>';
const ICON_MINUS='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="9"/><path d="M8 12h8"/></svg>';
const ICON_PLUS='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="9"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>';

function bindButtonLike(el, handler){
  if(!el) return;
  el.addEventListener('click', handler);
  el.addEventListener('keydown', evt => {
    if(evt.key==='Enter' || evt.key===' '){
      evt.preventDefault();
      handler(evt);
    }
  });
}

bindButtonLike(magicItemsBtn, () => openInventoryModal(charSel.value));
bindButtonLike(consumablesBtn, () => openConsumableModal(charSel.value));

let pendingChanges=false;
let savingData=false;
let lastSaveResult=null;
let saveFeedbackTimeout=null;
let hasLocalDraft=false;
let draftStateApplied=false;
let draftPersistWarningShown=false;
let draftLoadWarningShown=false;
const SAVE_ENDPOINT=(typeof window!=='undefined' && window.AL_SAVE_ENDPOINT)||'https://al-logs.vercel.app/api/save-data';
const SAVE_HEADERS=(typeof window!=='undefined' && window.AL_SAVE_HEADERS)||null;
const STORAGE_KEYS={
  showActivities:'al_logs_show_activities',
  lastCharacter:'al_logs_last_character'
};

function hasDmLogData(){
  return !!DM_DATA;
}
function isDmLogKey(key){
  return key===DM_LOG_KEY;
}
function isValidSheetKey(key){
  if(!key) return false;
  if(isDmLogKey(key)) return hasDmLogData();
  return !!(DATA && DATA.characters && DATA.characters[key]);
}

let showActivities=true;
try{
  const saved=localStorage.getItem(STORAGE_KEYS.showActivities);
  if(saved==='0'||saved==='false') showActivities=false;
}catch(err){
  /* no-op */
}

function persistActivityVisibility(){
  try{
    localStorage.setItem(STORAGE_KEYS.showActivities, showActivities?'1':'0');
  }catch(err){
    /* no-op */
  }
}

let cachedLastCharacterKey=null;
function getRememberedCharacterKey(){
  if(cachedLastCharacterKey===null){
    try{
      cachedLastCharacterKey=localStorage.getItem(STORAGE_KEYS.lastCharacter)||'';
    }catch(err){
      cachedLastCharacterKey='';
    }
  }
  if(cachedLastCharacterKey && !isValidSheetKey(cachedLastCharacterKey)){
    cachedLastCharacterKey='';
  }
  return cachedLastCharacterKey;
}
function rememberCharacterKey(key){
  const nextKey=isValidSheetKey(key)?String(key):'';
  if(cachedLastCharacterKey===nextKey) return;
  cachedLastCharacterKey=nextKey;
  try{
    if(nextKey){
      localStorage.setItem(STORAGE_KEYS.lastCharacter,nextKey);
    }else{
      localStorage.removeItem(STORAGE_KEYS.lastCharacter);
    }
  }catch(err){
    /* no-op */
  }
}

function setEmptyStateMessage(text){
  if(!emptyEl) return;
  emptyEl.textContent=text;
}

function updateActivityToggle(){
  if(!activityToggleBtn) return;
  const hiding=!showActivities;
  activityToggleBtn.textContent=hiding?'Show activities':'Hide activities';
  activityToggleBtn.setAttribute('aria-pressed', hiding?'true':'false');
  activityToggleBtn.classList.toggle('primary', hiding);
  const label=hiding?'Show downtime activities':'Hide downtime activities';
  activityToggleBtn.setAttribute('aria-label', label);
  activityToggleBtn.title=label;
}

function updateSaveButtonState(){
  if(!downloadBtn) return;
  const baseLabel=pendingChanges?'Save changes to data.js':'All changes saved';
  let label=baseLabel;
  downloadBtn.classList.toggle('dirty',pendingChanges && !savingData);
  downloadBtn.classList.toggle('saving',savingData);
  downloadBtn.classList.toggle('success',!pendingChanges && lastSaveResult==='success');
  downloadBtn.classList.toggle('error',lastSaveResult==='error');
  downloadBtn.disabled=!!savingData;
  downloadBtn.setAttribute('aria-busy',savingData?'true':'false');
  if(savingData){
    label='Saving data.js...';
  }else if(lastSaveResult==='error'){
    label='Last save failed — try again';
  }else if(lastSaveResult==='success' && !pendingChanges){
    label='Changes saved to data.js';
  }
  downloadBtn.setAttribute('aria-label',label);
  downloadBtn.title=label;
}

function setSaveResult(state){
  lastSaveResult=state;
  clearTimeout(saveFeedbackTimeout);
  if(state==='success'){
    saveFeedbackTimeout=setTimeout(()=>{
      if(lastSaveResult==='success'){
        lastSaveResult=null;
        updateSaveButtonState();
      }
    },2500);
  }
  updateSaveButtonState();
}

function anyModalOpen(){
  return (invModal && invModal.classList.contains('open'))
    || (consModal && consModal.classList.contains('open'))
    || (dmItemsModal && dmItemsModal.classList.contains('open'))
    || (cardOverlay && cardOverlay.classList.contains('open'));
}

function refreshModalState(){
  if(anyModalOpen()){ document.body.classList.add('modal-open'); }
  else{ document.body.classList.remove('modal-open'); }
}

function closeAddMenu(){
  if(addCardMenu){
    addCardMenu.hidden=true;
    addCardMenu.setAttribute('aria-hidden','true');
    addCardMenu.innerHTML='';
  }
  if(addCardBtn){
    addCardBtn.setAttribute('aria-expanded','false');
  }
}

function dispatchDmNewEntry(type){
  if(!type) return;
  window.dispatchEvent(new CustomEvent('dm:new-entry',{detail:{type}}));
}

function buildAddMenuOptions(){
  if(!charSel) return [];
  const key=charSel.value;
  if(isDmLogKey(key)){
    if(!hasDmLogData()) return [];
    return [
      {label:'New session', action:()=>dispatchDmNewEntry('session')},
      {label:'New allocation', action:()=>dispatchDmNewEntry('allocation')}
    ];
  }
  if(!isValidSheetKey(key)) return [];
  return [
    {label:'New adventure', action:()=>createCharacterNewEntry('adventure')},
    {label:'Downtime activity', action:()=>createCharacterNewEntry('Downtime Activity')}
  ];
}

function openAddMenu(){
  if(!addCardMenu||!addCardBtn) return;
  closeCharMenu();
  const options=buildAddMenuOptions();
  if(!options.length){
    closeAddMenu();
    return;
  }
  addCardMenu.innerHTML='';
  options.forEach(option=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='fab-menu-item';
    btn.textContent=option.label;
    btn.setAttribute('role','menuitem');
    btn.addEventListener('click',()=>{
      closeAddMenu();
      option.action();
    });
    addCardMenu.appendChild(btn);
  });
  addCardMenu.hidden=false;
  addCardMenu.setAttribute('aria-hidden','false');
  addCardBtn.setAttribute('aria-expanded','true');
  const first=addCardMenu.querySelector('button');
  if(first){
    try{ first.focus({preventScroll:true}); }
    catch(err){ first.focus(); }
  }
}

function openCardOverlay(card){
  if(!cardOverlay || !card) return;
  closeAddMenu();
  cardOverlay.innerHTML='';
  cardOverlay.appendChild(card);
  cardOverlay.classList.add('open');
  cardOverlay.setAttribute('aria-hidden','false');
  overlayCard=card;
  refreshModalState();
}

function closeCardOverlay(){
  if(!cardOverlay) return;
  cardOverlay.classList.remove('open');
  cardOverlay.setAttribute('aria-hidden','true');
  overlayCard=null;
  cardOverlay.innerHTML='';
  refreshModalState();
}

function createCharacterNewEntry(kind){
  if(!DATA || !DATA.characters || !charSel) return;
  const key=charSel.value;
  if(!isValidSheetKey(key) || !DATA.characters[key]) return;
  const normalized=kind==='Downtime Activity'?'Downtime Activity':'adventure';
  const isActivity=normalized!=='adventure';
  const today=new Date().toISOString().slice(0,10);
  const estimatedLevel=currentLevelFor(key);
  const template={
    date:today,
    title:isActivity?'New Downtime Activity':'New Adventure',
    code:'',
    dm:'',
    gp_plus:0,
    gp_minus:0,
    dtd_plus:0,
    dtd_minus:0,
    level_plus:0,
    perm_items:[],
    lost_perm_item:'',
    consumable_items:[],
    notes:'',
    kind:normalized,
    traded_item:'',
    __openEdit:true,
    __isNew:true,
    __charKey:key,
    __lockedKind:normalized,
    __levelAtStart:Number.isFinite(estimatedLevel)?estimatedLevel:null
  };
  const card=makeCard(template,-1);
  card.classList.add('overlay-card');
  openCardOverlay(card);
}

function loadDataDraft(){
  try{
    const raw=localStorage.getItem(DATA_DRAFT_STORAGE_KEY);
    if(!raw){
      return null;
    }
    const parsed=JSON.parse(raw);
    if(parsed && typeof parsed==='object' && parsed.data){
      hasLocalDraft=true;
      return parsed;
    }
  }catch(err){
    if(!draftLoadWarningShown){
      draftLoadWarningShown=true;
      console.warn('Unable to load data.js draft from storage', err);
    }
    try{ localStorage.removeItem(DATA_DRAFT_STORAGE_KEY); }
    catch(_){ /* no-op */ }
  }
  return null;
}
function persistDataDraft(){
  if(!DATA||typeof DATA!=='object') return;
  try{
    const serialized=JSON.stringify({
      version:dataVersion||'',
      data:DATA
    });
    localStorage.setItem(DATA_DRAFT_STORAGE_KEY, serialized);
    hasLocalDraft=true;
  }catch(err){
    if(!draftPersistWarningShown){
      draftPersistWarningShown=true;
      console.warn('Unable to persist data.js draft to storage', err);
    }
  }
}
function clearDataDraft(){
  hasLocalDraft=false;
  try{
    localStorage.removeItem(DATA_DRAFT_STORAGE_KEY);
  }catch(err){
    /* no-op */
  }
}

function discardDraftBeforeNavigation(){
  if(!(pendingChanges || hasLocalDraft)) return;
  clearDataDraft();
}

if(typeof window!=='undefined'){
  window.addEventListener('pagehide',discardDraftBeforeNavigation);
  window.addEventListener('unload',discardDraftBeforeNavigation);
}
function applyDraftIfAvailable({force=false}={}){
  if(draftStateApplied && !force) return false;
  let draft=null;
  try{
    draft=loadDataDraft();
  }catch(err){
    draft=null;
  }
  if(!draft||!draft.data||!draft.data.characters) return false;
  draftStateApplied=true;
  window.DATA=draft.data;
  DATA=window.DATA;
  if(draft.version){
    dataVersion=draft.version;
    window.AL_DATA_VERSION=dataVersion;
  }
  pendingChanges=true;
  lastSaveResult=null;
  clearTimeout(saveFeedbackTimeout);
  hasLocalDraft=true;
  updateSaveButtonState();
  return true;
}

function reapplyLocalDraftAndRefresh(){
  const applied=applyDraftIfAvailable({force:true});
  if(applied){
    DATA=window.DATA||DATA;
    if(__appInitialized){
      refreshAllDerivedData();
      rebuildCharacterOptions({preserveSelection:true});
      filterAndRender();
      scheduleAvatarPreload();
    }
  }
  return applied;
}

function markDirty(){
  pendingChanges=true;
  lastSaveResult=null;
  clearTimeout(saveFeedbackTimeout);
  updateSaveButtonState();
}
function clearDirty(){
  pendingChanges=false;
  lastSaveResult=null;
  clearTimeout(saveFeedbackTimeout);
  clearDataDraft();
  updateSaveButtonState();
}

function touchDataMetaTimestamp(){
  if(!DATA||typeof DATA!=='object') return;
  const meta=DATA.meta;
  if(meta&&typeof meta==='object'){
    try{
      meta.generated=new Date().toISOString();
    }catch(err){
      /* no-op */
    }
  }
}

async function saveDataJs(options={}){
  const { silent=false, dataJs:customDataJs=null, headers:customHeaders=null, endpoint=SAVE_ENDPOINT }=options;
  if(typeof customDataJs!=='string'){
    touchDataMetaTimestamp();
  }
  const payload=(typeof customDataJs==='string')?customDataJs:('window.DATA = '+JSON.stringify(DATA,null,2)+';');
  const hadPendingChanges=pendingChanges;
  const baseHeaders=(SAVE_HEADERS && typeof SAVE_HEADERS==='object')?SAVE_HEADERS:{};
  const extraHeaders=(customHeaders && typeof customHeaders==='object')?customHeaders:{};
  const headers={
    'content-type':'application/json',
    ...baseHeaders,
    ...extraHeaders
  };
  if(!endpoint){
    const err=new Error('Save endpoint not configured.');
    if(!silent){
      window.alert(err.message);
    }
    throw err;
  }
  if(savingData){
    return;
  }
  savingData=true;
  updateSaveButtonState();
  try{
    const response=await fetch(endpoint,{
      method:'POST',
      headers,
      body:JSON.stringify({ dataJs:payload })
    });
    const contentType=response.headers.get('content-type')||'';
    let body=null;
    if(contentType.includes('application/json')){
      try{ body=await response.json(); }
      catch(err){ body=null; }
    }else{
      const text=await response.text();
      body=text?{ message:text }:null;
    }
    if(!response.ok){
      const message=(body&&typeof body==='object' && (body.error||body.message))||response.statusText||'Failed to save data.js.';
      throw new Error(message);
    }
    const versionForSave=String(Date.now());
    setDataVersion(versionForSave);
    let refreshOutcome=null;
    let refreshError=null;
    try{
      refreshOutcome=await refreshDataJsCache({ expectedDataJs:payload, retries:3, retryDelay:800, version:versionForSave });
    }catch(err){
      refreshError=err;
    }
    if(!refreshError && refreshOutcome!==false){
      clearDirty();
      setSaveResult('success');
    }else{
      if(refreshError){
        console.warn('Unable to refresh data.js cache after save', refreshError);
      }else{
        console.warn('Unable to refresh data.js cache after save');
      }
      const shouldPersistDraft=(typeof customDataJs!=='string' && DATA && typeof DATA==='object' && (hadPendingChanges || hasLocalDraft));
      if(shouldPersistDraft){
        persistDataDraft();
      }
      if(hadPendingChanges || hasLocalDraft || shouldPersistDraft){
        pendingChanges=true;
        reapplyLocalDraftAndRefresh();
        setSaveResult(null);
      }
    }
    return body;
  }catch(err){
    console.error('Failed to save data.js', err);
    setSaveResult('error');
    if(!silent){
      const message=(err && err.message)?err.message:String(err);
      window.alert('Failed to save data.js: '+message);
    }
    throw err;
  }finally{
    savingData=false;
    updateSaveButtonState();
  }
}

function showDataLoadError(message){
  if(!emptyEl) return;
  emptyEl.style.display='block';
  emptyEl.innerHTML=message||'Could not load <code>data.js</code>.';
}

function buildDataUrl(version,{cacheBustToken=null}={}){
  const v=(version||'').trim();
  const params=[];
  if(v){
    params.push('v='+encodeURIComponent(v));
  }
  const cbToken=cacheBustToken==null?'' : String(cacheBustToken||'').trim();
  if(cbToken){
    params.push('cb='+encodeURIComponent(cbToken));
  }
  if(params.length){
    return `data.js?${params.join('&')}`;
  }
  return 'data.js';
}

function persistDataVersion(version){
  try{
    if(version){
      localStorage.setItem(DATA_VERSION_KEY, version);
    }else{
      localStorage.removeItem(DATA_VERSION_KEY);
    }
  }catch(err){
    /* no-op */
  }
  try{
    if(version){
      sessionStorage.setItem(DATA_VERSION_KEY, version);
    }else{
      sessionStorage.removeItem(DATA_VERSION_KEY);
    }
  }catch(err){
    /* no-op */
  }
}

function setDataVersion(version){
  dataVersion=version||'';
  window.AL_DATA_VERSION=dataVersion;
  persistDataVersion(dataVersion);
  if(dataScriptEl){
    dataCacheBust=String(Date.now());
    window.AL_DATA_CACHE_BUST=dataCacheBust;
    dataScriptEl.setAttribute('data-version', dataVersion);
    dataScriptEl.setAttribute('data-cache-bust', dataCacheBust);
    const desired=buildDataUrl(dataVersion,{cacheBustToken:dataCacheBust});
    try{
      const absolute=new URL(desired, window.location.href).href;
      if(dataScriptEl.src!==absolute){
        dataScriptEl.src=desired;
      }
    }catch(err){
      dataScriptEl.src=desired;
    }
  }
}

function applyDataJs(text){
  if(typeof text!=='string' || !text.trim()) return;
  try{
    const fn=new Function(text+'\n//# sourceURL=data.js');
    fn();
  }catch(err){
    console.error('Failed to evaluate data.js', err);
    throw err;
  }
  const next=window.DATA||null;
  if(!next || !next.characters){
    throw new Error('DATA missing after applying data.js');
  }
  DATA=next;
  refreshAllDerivedData();
  rebuildCharacterOptions({preserveSelection:true});
  filterAndRender();
}

function extractDataPayload(text){
  if(typeof text!=='string') return null;
  const match=text.match(/window\.DATA\s*=\s*(\{[\s\S]*\})\s*;?\s*$/);
  return match && match[1]?match[1]:null;
}

function parseDataPayload(text){
  const payload=extractDataPayload(text);
  if(!payload) return null;
  try{
    return JSON.parse(payload);
  }catch(err){
    return null;
  }
}

function dataPayloadsMatch(a,b){
  const parsedA=parseDataPayload(a);
  const parsedB=parseDataPayload(b);
  if(parsedA && parsedB){
    return JSON.stringify(parsedA)===JSON.stringify(parsedB);
  }
  if(typeof a==='string' && typeof b==='string'){
    return a.trim()===b.trim();
  }
  return false;
}

function wait(ms){
  return new Promise(resolve=>setTimeout(resolve,ms));
}

async function refreshDataJsCache({ expectedDataJs=null, retries=0, retryDelay=500, version=null }={}){
  let attempt=0;
  const pinnedVersion=version?String(version):null;
  let lastMismatchError=null;
  while(attempt<=retries){
    const versionToUse=pinnedVersion||String(Date.now());
    const response=await fetch(buildDataUrl(versionToUse,{cacheBustToken:Date.now()}),{ cache:'reload', headers:{ 'cache-control':'no-cache', pragma:'no-cache' } });
    if(!response.ok){
      throw new Error('HTTP '+response.status);
    }
    const text=await response.text();
    if(!expectedDataJs || dataPayloadsMatch(text, expectedDataJs)){
      applyDataJs(text);
      setDataVersion(versionToUse);
      return true;
    }
    lastMismatchError=new Error('Latest data.js did not match the newly saved content.');
    if(attempt===retries){
      console.warn('Latest data.js did not match newly saved content; giving up on cache refresh for now.');
      throw lastMismatchError;
    }
    attempt+=1;
    await wait(retryDelay);
  }
  if(lastMismatchError){
    throw lastMismatchError;
  }
}

function getCharMenuItems(){
  if(!charSelMenu) return [];
  return Array.from(charSelMenu.querySelectorAll('.char-menu-item'));
}

function focusCharMenuItem(item){
  if(!item) return;
  try{ item.focus({preventScroll:true}); }
  catch(err){ item.focus(); }
  try{ item.scrollIntoView({block:'nearest'}); }
  catch(err){ /* no-op */ }
}

function syncCharacterSelectorUI(){
  const selectedOption=(charSel && charSel.options && charSel.selectedIndex>=0)?charSel.options[charSel.selectedIndex]:null;
  const labelText=selectedOption?selectedOption.textContent.trim():'';
  const finalLabel=labelText||DEFAULT_CHARACTER_MENU_LABEL;
  if(charSelDisplay){
    charSelDisplay.textContent=finalLabel;
  }
  if(charSelToggle){
    charSelToggle.title=finalLabel;
    const hasOptions=!!(charSel && charSel.options && charSel.options.length);
    charSelToggle.disabled=!hasOptions;
    charSelToggle.setAttribute('aria-disabled',hasOptions?'false':'true');
  }
  if(!charSelMenu) return;
  const currentValue=(charSel&&charSel.value)||'';
  getCharMenuItems().forEach(item=>{
    const isActive=item.dataset&&item.dataset.value===currentValue;
    item.classList.toggle('active',isActive);
    item.setAttribute('aria-selected',isActive?'true':'false');
  });
}

function rebuildCharacterMenu(){
  if(!charSelMenu||!charSel) return;
  const previousScroll=charSelMenu.scrollTop||0;
  charSelMenu.innerHTML='';
  const options=Array.from(charSel.options||[]);
  if(!options.length){
    charSelMenu.scrollTop=0;
    syncCharacterSelectorUI();
    return;
  }
  options.forEach((opt,index)=>{
    if(opt.disabled) return;
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='char-menu-item';
    btn.id=`char-menu-item-${index}`;
    btn.dataset.value=opt.value;
    btn.setAttribute('role','option');
    const text=document.createElement('span');
    text.className='char-menu-text';
    text.textContent=opt.textContent||opt.value||DEFAULT_CHARACTER_MENU_LABEL;
    const check=document.createElement('span');
    check.className='char-menu-check';
    check.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.5 10 17l9-10"/></svg>';
    btn.appendChild(text);
    btn.appendChild(check);
    btn.addEventListener('click',()=>{
      selectCharacterFromMenu(opt.value);
    });
    charSelMenu.appendChild(btn);
  });
  charSelMenu.scrollTop=previousScroll;
  syncCharacterSelectorUI();
}

function closeCharMenu({focusToggle=false}={}){
  if(charSelMenu){
    charSelMenu.hidden=true;
    charSelMenu.setAttribute('aria-hidden','true');
  }
  if(charSelToggle){
    charSelToggle.setAttribute('aria-expanded','false');
    if(focusToggle){
      try{ charSelToggle.focus({preventScroll:true}); }
      catch(err){ charSelToggle.focus(); }
    }
  }
}

function openCharMenu({focusLast=false}={}){
  if(!charSelToggle||!charSelMenu) return;
  rebuildCharacterMenu();
  const items=getCharMenuItems();
  if(!items.length){
    closeCharMenu();
    return;
  }
  closeAddMenu();
  charSelMenu.hidden=false;
  charSelMenu.setAttribute('aria-hidden','false');
  charSelToggle.setAttribute('aria-expanded','true');
  const active=items.find(item=>item.classList.contains('active'));
  let target=active||null;
  if(focusLast){
    target=items[items.length-1];
  }else if(!target){
    target=items[0];
  }
  if(target){
    requestAnimationFrame(()=>focusCharMenuItem(target));
  }
}

function toggleCharMenu(){
  if(!charSelMenu) return;
  if(charSelMenu.hidden){
    openCharMenu();
  }else{
    closeCharMenu();
  }
}

function selectCharacterFromMenu(value){
  if(!charSel) return;
  const previous=charSel.value;
  if(previous!==value){
    charSel.value=value;
    const event=new Event('change',{bubbles:true});
    charSel.dispatchEvent(event);
    closeCharMenu({focusToggle:true});
  }else{
    syncCharacterSelectorUI();
    closeCharMenu({focusToggle:true});
  }
}

/* --- character selector (no session counts) --- */
function rebuildCharacterOptions({preserveSelection=true, preferredKey=null}={}){
  if(!charSel) return null;
  const hasData=DATA && DATA.characters && typeof DATA.characters==='object';
  const previousSelection=preserveSelection?charSel.value:null;
  const scrollTop=charSel.scrollTop||0;
  charSel.innerHTML='';
  if(!hasData){
    return null;
  }
  let storedKey=getRememberedCharacterKey();
  if(storedKey && !isValidSheetKey(storedKey)){
    rememberCharacterKey('');
    storedKey='';
  }
  const entries=Object.entries(DATA.characters).map(([key,obj])=>{
    const sheetName=(obj.sheet||'').toString().trim();
    const displayName=(obj.display_name||'').toString().trim();
    const baseLabel=sheetName||displayName||key;
    const label=(displayName && displayName!==key)?(displayName+(sheetName&&sheetName!==displayName?' ('+sheetName+')':'')):baseLabel;
    const labelText=(label||'').toString().trim()||key;
    const sortValue=(displayName||sheetName||key||'').toString().trim();
    return { key, label:labelText, sortValue };
  }).sort((a,b)=>{
    const cmp=a.sortValue.localeCompare(b.sortValue,undefined,{sensitivity:'base',numeric:true});
    if(cmp!==0) return cmp;
    return a.key.localeCompare(b.key,undefined,{sensitivity:'base',numeric:true});
  });
  entries.forEach(({key,label})=>{
    const opt=document.createElement('option');
    opt.value=key;
    opt.textContent=label;
    charSel.appendChild(opt);
  });
  if(hasDmLogData()){
    const dmOpt=document.createElement('option');
    dmOpt.value=DM_LOG_KEY;
    dmOpt.textContent='Dungeon Master Log';
    charSel.appendChild(dmOpt);
  }
  const candidateKeys=[preferredKey, previousSelection, storedKey];
  let nextKey=null;
  for(const candidate of candidateKeys){
    if(isValidSheetKey(candidate)){ nextKey=candidate; break; }
  }
  if(!nextKey){
    nextKey=getMostRecentCharacter();
  }
  if(!nextKey && hasDmLogData()){
    nextKey=DM_LOG_KEY;
  }
  if(nextKey){
    charSel.value=nextKey;
    rememberCharacterKey(nextKey);
  }else{
    rememberCharacterKey('');
  }
  if(typeof charSel.scrollTop==='number'){
    charSel.scrollTop=scrollTop;
  }
  rebuildCharacterMenu();
  syncCharacterSelectorUI();
  return charSel.value||nextKey||null;
}

/* --- utils --- */
function fmtDate(iso){ if(!iso)return'—'; const d=new Date(iso); if(isNaN(d))return String(iso); return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }
function fmtNumber(n,{signed=false}={}){
  if(n==null) return '0';
  const num=Number(n);
  if(!Number.isFinite(num)) return String(n);
  let rounded=Math.round(num*100)/100;
  if(Object.is(rounded,-0)) rounded=0;
  const formatted=rounded.toLocaleString(undefined,{maximumFractionDigits:2});
  if(signed){
    if(rounded===0) return '0';
    if(rounded>0) return '+'+formatted;
  }
  return formatted;
}
function normalizeDisplayValue(val){
  if(val==null) return '';
  if(typeof val==='number'){
    if(!Number.isFinite(val)) return '';
    return String(val);
  }
  const text=String(val).trim();
  if(!text) return '';
  const simple=text.replace(/[\s._\-\/?]/g,'').toLowerCase();
  if(!simple) return '';
  if(simple==='na'||simple==='none'||simple==='null'||simple==='tbd') return '';
  return text;
}
function hasMeaningfulValue(val){
  return normalizeDisplayValue(val)!=='';
}
function pill(label){ const s=document.createElement('span'); s.className='pill'; s.textContent=label; return s; }
function formatRace(value){
  if(!value) return '';
  if(Array.isArray(value)){
    return value.map(formatRace).filter(Boolean).join(' / ');
  }
  if(typeof value==='object'){
    const parts=[];
    if(value.lineage) parts.push(String(value.lineage));
    if(value.race) parts.push(String(value.race));
    if(value.ancestry) parts.push(String(value.ancestry));
    if(value.subrace) parts.push(String(value.subrace));
    if(value.variant) parts.push(String(value.variant));
    if(value.name && !parts.length) parts.push(String(value.name));
    return parts.filter(Boolean).join(' ');
  }
  return String(value);
}
function formatClassEntry(entry){
  if(!entry) return '';
  if(typeof entry==='string') return entry;
  if(typeof entry==='number') return String(entry);
  if(Array.isArray(entry)){
    return entry.map(formatClassEntry).filter(Boolean).join(' / ');
  }
  const parts=[];
  if(entry.name) parts.push(String(entry.name));
  if(entry.subclass) parts.push(String(entry.subclass));
  if(entry.level!=null && entry.level!=='') parts.push(String(entry.level));
  if(entry.title && !parts.length) parts.push(String(entry.title));
  return parts.filter(Boolean).join(' ');
}
function formatClasses(value){
  if(!value) return '';
  if(Array.isArray(value)){
    return value.map(formatClassEntry).filter(Boolean).join(' / ');
  }
  if(typeof value==='object'){
    return formatClassEntry(value);
  }
  return String(value);
}
function collectAvatarNames(obj,key){
  const names=[];
  if(obj){
    if(typeof obj.sheet==='string' && obj.sheet.trim()) names.push(obj.sheet);
    if(typeof obj.display_name==='string' && obj.display_name.trim()) names.push(obj.display_name);
    if(obj.identity && typeof obj.identity.name==='string' && obj.identity.name.trim()) names.push(obj.identity.name);
  }
  if(typeof key==='string' && key.trim()) names.push(key);
  return names
    .map(name=>String(name).trim())
    .filter((value,index,self)=>value && self.indexOf(value)===index);
}
function makeAvatarFileCandidates(name){
  if(!name) return [];
  const trimmed=String(name).trim();
  if(!trimmed) return [];
  const variants=new Set();
  variants.add(trimmed);
  variants.add(trimmed.toLowerCase());
  const dashed=trimmed.replace(/[^a-zA-Z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  if(dashed) variants.add(dashed);
  if(dashed) variants.add(dashed.toLowerCase());
  const collapsed=trimmed.replace(/[^a-zA-Z0-9]+/g,'');
  if(collapsed) variants.add(collapsed);
  if(collapsed) variants.add(collapsed.toLowerCase());
  return Array.from(variants).map(v=>`${v}.png`);
}
function closeAvatarOverlay({returnFocus=true}={}){
  if(!avatarOverlay) return;
  if(!avatarOverlay.classList.contains('open')) return;
  avatarOverlay.classList.remove('open');
  avatarOverlay.setAttribute('aria-hidden','true');
  avatarOverlay.removeAttribute('aria-label');
  document.body.classList.remove('avatar-overlay-open');
  if(avatarEl){
    avatarEl.setAttribute('aria-expanded','false');
  }
  if(avatarPreview){
    avatarPreview.removeAttribute('data-avatar-src');
  }
  if(avatarPreviewImage){
    avatarPreviewImage.removeAttribute('src');
    avatarPreviewImage.setAttribute('alt','Character avatar');
  }
  document.removeEventListener('keydown', onAvatarOverlayKeydown);
  if(returnFocus && avatarEl){
    avatarEl.focus({preventScroll:true});
  }
}

function onAvatarOverlayKeydown(evt){
  if(evt.key==='Escape'){
    evt.preventDefault();
    closeAvatarOverlay();
  }
}

function openAvatarOverlay(){
  if(!avatarEl || !avatarOverlay || !avatarPreview) return;
  if(!avatarEl.classList.contains('has-avatar')) return;
  const src=avatarEl.getAttribute('data-avatar-src');
  if(!src) return;
  avatarPreview.setAttribute('data-avatar-src',src);
  const selectedOption=charSel && charSel.options && charSel.selectedIndex>=0 ? charSel.options[charSel.selectedIndex] : null;
  const optionLabel=selectedOption?selectedOption.textContent.trim():'';
  const label=optionLabel?`${optionLabel} avatar`:'Character avatar';
  if(avatarPreviewImage){
    avatarPreviewImage.src=src;
    avatarPreviewImage.setAttribute('alt',label);
  }
  avatarOverlay.setAttribute('aria-label',label);
  avatarOverlay.classList.add('open');
  avatarOverlay.setAttribute('aria-hidden','false');
  document.body.classList.add('avatar-overlay-open');
  avatarOverlay.focus({preventScroll:true});
  if(avatarEl){
    avatarEl.setAttribute('aria-expanded','true');
  }
  document.addEventListener('keydown', onAvatarOverlayKeydown);
}

if(avatarOverlay){
  avatarOverlay.addEventListener('click',()=>closeAvatarOverlay());
}

function resetAvatar(){
  if(!avatarEl) return;
  avatarEl.removeAttribute('src');
  avatarEl.classList.remove('has-avatar');
  avatarEl.classList.remove('avatar-fallback');
  avatarEl.removeAttribute('data-avatar-src');
  avatarEl.alt='Character avatar';
  avatarEl.removeAttribute('role');
  avatarEl.removeAttribute('aria-haspopup');
  avatarEl.removeAttribute('aria-expanded');
  avatarEl.tabIndex=-1;
  closeAvatarOverlay({returnFocus:false});
}
function applyAvatar(path,token,key,{persist=true,isFallback=false}={}){
  if(!avatarEl || token!==avatarLoadToken) return;
  avatarEl.src=path;
  avatarEl.classList.add('has-avatar');
  if(isFallback){
    avatarEl.classList.add('avatar-fallback');
  }else{
    avatarEl.classList.remove('avatar-fallback');
  }
  avatarEl.setAttribute('data-avatar-src',path);
  const selectedOption=charSel && charSel.options && charSel.selectedIndex>=0 ? charSel.options[charSel.selectedIndex] : null;
  const optionLabel=selectedOption?selectedOption.textContent.trim():'';
  const defaultLabel=optionLabel?`${optionLabel} avatar`:'Character avatar';
  const fallbackLabel=optionLabel?`${optionLabel} default avatar`:'Default character avatar';
  avatarEl.alt=isFallback?fallbackLabel:defaultLabel;
  avatarEl.setAttribute('role','button');
  avatarEl.setAttribute('aria-haspopup','dialog');
  avatarEl.setAttribute('aria-expanded','false');
  avatarEl.tabIndex=0;
  if(persist) rememberAvatarPath(key,path);
}
function buildAvatarCandidates(key,obj){
  const names=collectAvatarNames(obj,key);
  const candidates=[];
  const persistedPath=getPersistedAvatarPath(key);
  if(persistedPath) candidates.push(persistedPath);
  const manifestPath=AVATAR_MANIFEST[String(key)]||'';
  if(manifestPath && !candidates.includes(manifestPath)) candidates.push(manifestPath);
  names.forEach(name=>{
    makeAvatarFileCandidates(name).forEach(file=>{
      if(file && !candidates.includes(file)) candidates.push(file);
    });
  });
  return candidates;
}
function preloadAvatar(path){
  if(!path) return null;
  if(avatarCache.has(path)) return null;
  if(avatarPreloadPromises.has(path)) return avatarPreloadPromises.get(path);
  const promise=new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      avatarCache.set(path,true);
      resolve(true);
    };
    img.onerror=()=>{
      avatarCache.set(path,false);
      resolve(false);
    };
    img.src=path;
  });
  avatarPreloadPromises.set(path,promise);
  return promise;
}
function collectAllAvatarPaths(){
  if(!DATA || !DATA.characters) return [];
  const paths=new Set();
  Object.entries(DATA.characters).forEach(([key,obj])=>{
    buildAvatarCandidates(key,obj).forEach(path=>{ if(path) paths.add(path); });
  });
  if(AVATAR_FALLBACK_PATH) paths.add(AVATAR_FALLBACK_PATH);
  return Array.from(paths);
}
let avatarPreloadScheduled=false;
function scheduleAvatarPreload(){
  if(avatarPreloadScheduled) return;
  avatarPreloadScheduled=true;
  const startPreload=()=>{
    avatarPreloadScheduled=false;
    collectAllAvatarPaths().forEach(path=>preloadAvatar(path));
  };
  if(typeof window!=='undefined' && typeof window.requestIdleCallback==='function'){
    window.requestIdleCallback(startPreload,{timeout:1200});
  }else{
    setTimeout(startPreload,150);
  }
}
function updateAvatar(key,obj){
  if(!avatarEl){
    return;
  }
  const candidates=buildAvatarCandidates(key,obj);
  if(!candidates.length){
    const token=++avatarLoadToken;
    resetAvatar();
    forgetAvatarPath(key);
    if(AVATAR_FALLBACK_PATH){
      avatarCache.set(AVATAR_FALLBACK_PATH,true);
      applyAvatar(AVATAR_FALLBACK_PATH,token,key,{persist:false,isFallback:true});
    }
    return;
  }
  const token=++avatarLoadToken;
  resetAvatar();
  const tryNext=(index)=>{
    if(token!==avatarLoadToken) return;
    if(index>=candidates.length){
      forgetAvatarPath(key);
      if(AVATAR_FALLBACK_PATH){
        avatarCache.set(AVATAR_FALLBACK_PATH,true);
        applyAvatar(AVATAR_FALLBACK_PATH,token,key,{persist:false,isFallback:true});
      }else{
        resetAvatar();
      }
      return;
    }
    const path=candidates[index];
    if(avatarCache.has(path)){
      if(avatarCache.get(path)){
        applyAvatar(path,token,key);
      }else{
        tryNext(index+1);
      }
      return;
    }
    const img=new Image();
    img.onload=()=>{
      if(token!==avatarLoadToken) return;
      avatarCache.set(path,true);
      applyAvatar(path,token,key);
    };
    img.onerror=()=>{
      if(token!==avatarLoadToken) return;
      avatarCache.set(path,false);
      tryNext(index+1);
    };
    img.src=path;
  };
  tryNext(0);
}
function extractCharacterIdentity(obj){
  const identity={race:'',classes:''};
  if(!obj) return identity;
  const sheet=obj.sheet;
  if(sheet && typeof sheet==='object'){
    identity.race = identity.race || formatRace(sheet.race || sheet.ancestry || sheet.lineage);
    identity.classes = identity.classes || formatClasses(sheet.classes || sheet.class || sheet.archetype);
  }
  if((!identity.race || !identity.classes) && Array.isArray(obj.adventures)){
    const source=obj.adventures.find(entry=>entry && typeof entry.character==='object');
    if(source && source.character){
      const ch=source.character;
      identity.race = identity.race || formatRace(ch.race || ch.ancestry || ch.lineage);
      identity.classes = identity.classes || formatClasses(ch.classes || ch.class || ch.archetype);
    }
  }
  if(typeof obj.identity==='object'){
    identity.race = identity.race || formatRace(obj.identity.race || obj.identity.ancestry);
    identity.classes = identity.classes || formatClasses(obj.identity.classes || obj.identity.class);
  }
  return {
    race:identity.race && identity.race.trim()?identity.race.trim():'',
    classes:identity.classes && identity.classes.trim()?identity.classes.trim():''
  };
}
function identityBadge(label,value){
  const chip=document.createElement('span');
  chip.className='identity-badge';
  const labelEl=document.createElement('span');
  labelEl.className='label';
  labelEl.textContent=label;
  const valueEl=document.createElement('span');
  valueEl.className='value';
  valueEl.textContent=value;
  chip.append(labelEl,valueEl);
  return chip;
}
function sanitizeTitle(title){
  if(!title) return '';
  return String(title).replace(/\bdown\s*time\s*activity\b/gi,'').replace(/\s{2,}/g,' ').replace(/^[\s:,.–—-]+|[\s:,.–—-]+$/g,'').trim();
}
function shortenTitleForCrowdedChips(title,count){
  const text=title==null?'':String(title);
  if(!text) return '';
  const limit=count>4?36:44;
  if(text.length<=limit) return text;
  const slice=text.slice(0,limit-1).replace(/\s+$/,'');
  return slice?slice+'…':'…';
}
function listBox(items){
  const wrap=document.createElement('div'); wrap.className='scrollbox';
  const normalized=Array.isArray(items)?items.map(normalizeDisplayValue).filter(Boolean):[];
  if(!normalized.length){ wrap.innerHTML='<div class="muted">—</div>'; return wrap; }
  normalized.forEach(name=>{ const row=document.createElement('div'); row.className='item'; row.textContent=name; wrap.appendChild(row); });
  return wrap;
}

/* --- DM log helpers --- */
function dmNormalizeSeasonLabel(label){
  const text=(label==null?'':String(label)).trim();
  return text||'Unlabeled season';
}
function normalizeSeasonGroup(label){
  const text=(label==null?'':String(label)).trim().toLowerCase();
  if(!text) return '';
  if(text.startsWith('seasonal')) return 'seasonal';
  const seasonMatch=text.match(/^season\s*(\d+)([a-z])?/);
  if(seasonMatch){
    return `season-${seasonMatch[1]}`;
  }
  const anniversaryMatch=text.match(/(\d{1,3})(st|nd|rd|th)\s+anniversary\s+season/);
  if(anniversaryMatch){
    return `${anniversaryMatch[1]}th-anniversary-season`;
  }
  return text;
}
function extractSeasonLabel(text){
  if(!text) return '';
  const value=String(text);
  const anniversary=value.match(/(\d{1,3})(st|nd|rd|th)\s+Anniversary\s+Season\s+([A-Za-z])/i);
  if(anniversary){
    const ordinal=`${anniversary[1]}${anniversary[2]}`;
    const seasonLetter=anniversary[3].toUpperCase();
    return `${ordinal} Anniversary Season ${seasonLetter}`;
  }
  const seasonal=value.match(/Seasonal\s*\(([^)]+)\)/i);
  if(seasonal){
    return `Seasonal (${seasonal[1].trim()})`;
  }
  const detailed=value.match(/Season\s*(\d+)\s*([A-Za-z])?/i);
  if(detailed){
    const seasonNumber=detailed[1];
    const letter=(detailed[2]||'').trim();
    if(letter){
      return `Season ${seasonNumber}${letter.toLowerCase()}`;
    }
    return `Season ${seasonNumber}`;
  }
  return '';
}
function inferSeasonFromReward(adv){
  if(!adv || typeof adv!=='object') return '';
  const direct=extractSeasonLabel(adv.season);
  if(direct) return dmNormalizeSeasonLabel(direct);
  const fromTitle=extractSeasonLabel(adv.title);
  if(fromTitle) return dmNormalizeSeasonLabel(fromTitle);
  const fromNotes=extractSeasonLabel(adv.notes);
  if(fromNotes) return dmNormalizeSeasonLabel(fromNotes);
  return '';
}
function dmToNullableNumber(value){
  const num=Number(value);
  return Number.isFinite(num)?num:null;
}
function dmToNumber(value){
  const num=Number(value);
  return Number.isFinite(num)?num:0;
}
function dmTimestamp(value){
  if(!value) return Number.NEGATIVE_INFINITY;
  const t=new Date(value).getTime();
  return Number.isFinite(t)?t:Number.NEGATIVE_INFINITY;
}
function buildDmEntries(){
  DM_ENTRIES=[];
  DM_SUMMARY={ runs:0, allocations:0, earnedHours:0, earnedBonus:0, allocatedHours:0, allocatedBonus:0, allocatedCost:0, earnedLevels:0, spentLevels:0, entries:0 };
  DM_PRE_ITEMS=[];
  if(!DM_DATA) return;
  let sortIndex=0;
  const normalizeSeason=(raw)=>dmNormalizeSeasonLabel(raw);
  const pushEntry=(entry)=>{
    entry.__origIndex=sortIndex++;
    if(entry && typeof entry==='object'){
      entry.seasonGroup=normalizeSeasonGroup(entry.season||'');
    }
    DM_ENTRIES.push(entry);
  };
  const addRun=(seasonLabel, run)=>{
    const season=normalizeSeason(seasonLabel);
    const hoursVal=dmToNullableNumber(run.hours);
    const bonusVal=dmToNullableNumber(run.extra_hours);
    const levelsPlus=dmToNullableNumber(run.levels_plus);
    const levelsMinus=dmToNullableNumber(run.levels_minus);
    pushEntry({
      type:'run',
      season,
      date:run.date||'',
      code:run.code||'',
      name:run.name||'',
      tier:run.tier,
      hours:hoursVal,
      extra_hours:bonusVal,
      roles:Array.isArray(run.roles)?run.roles.slice():[],
      location:run.location||'',
      levels_plus:levelsPlus,
      levels_minus:levelsMinus,
      item:run.item||'',
      allocation:run.allocation||''
    });
    DM_SUMMARY.runs+=1;
    if(hoursVal!=null) DM_SUMMARY.earnedHours+=hoursVal;
    if(bonusVal!=null) DM_SUMMARY.earnedBonus+=bonusVal;
    if(levelsPlus!=null) DM_SUMMARY.earnedLevels+=levelsPlus;
    if(levelsMinus!=null) DM_SUMMARY.spentLevels+=levelsMinus;
  };
  const addPreEntry=(entry)=>{
    const season=normalizeSeason('Pre-Season 11');
    const levelsPlus=dmToNullableNumber(entry.levels_plus);
    const levelsMinus=dmToNullableNumber(entry.levels_minus);
    pushEntry({
      type:'run',
      season,
      date:entry.date||'',
      code:entry.code||'',
      name:entry.name||'',
      tier:entry.tier,
      hours:null,
      extra_hours:null,
      roles:[],
      location:entry.location||'',
      levels_plus:levelsPlus,
      levels_minus:levelsMinus,
      item:entry.item||'',
      allocation:entry.allocation||''
    });
    if(levelsPlus!=null) DM_SUMMARY.earnedLevels+=levelsPlus;
    if(levelsMinus!=null) DM_SUMMARY.spentLevels+=levelsMinus;
    const hasAllocation=Boolean((entry.allocation||'').trim());
    const itemName=String(entry.item||'').trim();
    if(itemName && !hasAllocation){
      DM_PRE_ITEMS.push({
        item:itemName,
        date:entry.date||'',
        code:entry.code||'',
        location:entry.location||''
      });
    }
    DM_SUMMARY.runs+=1;
  };
  const addAllocation=(seasonLabel, alloc)=>{
    const season=normalizeSeason(seasonLabel);
    const hoursVal=dmToNullableNumber(alloc.hours);
    const bonusVal=dmToNullableNumber(alloc.extra_hours);
    const baseLevelsPlus=dmToNullableNumber(alloc.levels_plus);
    const baseLevelsMinus=dmToNullableNumber(alloc.levels_minus);
    const baseCost=dmToNullableNumber(alloc.cost);
    const parsed=interpretAllocationDetails(alloc.allocation);
    const effectiveLevelsPlus=(parsed && parsed.levelsSpent!=null)?parsed.levelsSpent:baseLevelsPlus;
    const effectiveLevelsMinus=(parsed && parsed.levelsGained!=null)?parsed.levelsGained:baseLevelsMinus;
    const effectiveCost=(parsed && parsed.downtimeSpent!=null)?parsed.downtimeSpent:baseCost;
    const effectiveGold=(parsed && parsed.goldSpent!=null)?parsed.goldSpent:null;
    const entry={
      type:'allocation',
      season,
      date:alloc.date||'',
      allocation:alloc.allocation||'',
      cost:effectiveCost,
      levels_plus:effectiveLevelsPlus,
      levels_minus:effectiveLevelsMinus,
      hours:hoursVal,
      extra_hours:bonusVal,
      location:alloc.location||'',
      gp:effectiveGold,
      allocation_tokens:parsed && Array.isArray(parsed.tokens)?parsed.tokens.slice():[],
      allocation_recipients:parsed && Array.isArray(parsed.recipients)?parsed.recipients.slice():[],
      allocation_item_tokens:parsed && Array.isArray(parsed.itemTokens)?parsed.itemTokens.slice():[]
    };
    pushEntry(entry);
    DM_SUMMARY.allocations+=1;
    if(hoursVal!=null) DM_SUMMARY.allocatedHours+=hoursVal;
    if(bonusVal!=null) DM_SUMMARY.allocatedBonus+=bonusVal;
    if(entry.cost!=null) DM_SUMMARY.allocatedCost+=entry.cost;
    if(entry.levels_plus!=null) DM_SUMMARY.spentLevels+=entry.levels_plus;
    if(entry.levels_minus!=null) DM_SUMMARY.earnedLevels+=entry.levels_minus;
  };
  if(Array.isArray(DM_DATA.preS11)){
    DM_DATA.preS11.forEach(preEntry=>addPreEntry(preEntry));
  }
  if(DM_DATA.seasonal && typeof DM_DATA.seasonal==='object'){
    Object.entries(DM_DATA.seasonal).forEach(([seasonName, seasonData])=>{
      const runs=seasonData && Array.isArray(seasonData.runs)?seasonData.runs:[];
      runs.forEach(run=>addRun(seasonName, run));
      const allocations=seasonData && Array.isArray(seasonData.allocations)?seasonData.allocations:[];
      allocations.forEach(allocation=>addAllocation(seasonName, allocation));
    });
  }
  DM_ENTRIES.sort((a,b)=>{
    const diff=dmTimestamp(b.date)-dmTimestamp(a.date);
    if(diff!==0) return diff;
    const orderA=(typeof a.__origIndex==='number')?a.__origIndex:0;
    const orderB=(typeof b.__origIndex==='number')?b.__origIndex:0;
    return orderA-orderB;
  });
  DM_ENTRIES.forEach((entry,index)=>{
    entry.sortIndex=index;
  });
  DM_SUMMARY.entries=DM_ENTRIES.length;
  if(DM_PRE_ITEMS.length){
    DM_PRE_ITEMS.sort((a,b)=>dmTimestamp(a.date)-dmTimestamp(b.date));
  }
  updateDmSummaryBar();
}

let DM_ALLOCATION_LINKS=new WeakMap();
let DM_REWARD_LINKS=new WeakMap();

function normalizeDateString(value){
  if(!value) return '';
  const text=String(value);
  if(/^\d{4}-\d{2}-\d{2}/.test(text)){
    return text.slice(0,10);
  }
  const ts=new Date(text).getTime();
  if(Number.isFinite(ts)){
    return new Date(ts).toISOString().slice(0,10);
  }
  return '';
}

function normalizeMatchToken(value){
  return String(value||'').toLowerCase().replace(/[^a-z0-9]+/g,'');
}

function parseAllocationRecipients(text){
  const raw=String(text||'');
  const idx=raw.toLowerCase().lastIndexOf(' to ');
  if(idx===-1) return [];
  let after=raw.slice(idx+4).trim();
  if(!after) return [];
  after=after.replace(/[,.;]+$/,'');
  after=after.replace(/\band\b/gi,',');
  after=after.replace(/&/g,',');
  after=after.replace(/\//g,',');
  const parts=after.split(',').map(part=>part.trim()).filter(Boolean);
  return parts;
}
function extractAllocationItemTokens(text){
  if(text && typeof text==='object'){
    if(Array.isArray(text.allocation_item_tokens)){
      return text.allocation_item_tokens.slice();
    }
    text=text.allocation||'';
  }
  const raw=String(text||'');
  if(!raw) return [];
  const idx=raw.toLowerCase().lastIndexOf(' to ');
  const before=idx===-1?raw:raw.slice(0, idx);
  const candidates=before.split(/[+,&/]/).map(part=>normalizeMatchToken(part));
  const tokens=new Set();
  candidates.forEach(token=>{
    if(!token) return;
    if(token.length<4) return;
    if(!/[a-z]/.test(token)) return;
    if(/^(?:level|levels|hours|extra|bonus|dtd|gp)$/.test(token)) return;
    if(/^\d/.test(token)) return;
    tokens.add(token);
  });
  return Array.from(tokens);
}

function interpretAllocationDetails(text){
  const raw=String(text||'');
  const recipients=parseAllocationRecipients(raw);
  const itemTokens=extractAllocationItemTokens(raw);
  const tokens=new Set();
  itemTokens.forEach(token=>{
    if(token) tokens.add(`item:${token}`);
  });

  const addNumericToken=(prefix,value)=>{
    if(value==null) return;
    const rounded=value%1===0?Math.trunc(value):Number(value.toFixed(2));
    tokens.add(`${prefix}:${rounded}`);
  };

  const normalizeNumber=(value,kFlag)=>{
    if(value==null) return null;
    let cleaned=String(value).replace(/,/g,'');
    if(!cleaned) return null;
    const num=Number(cleaned);
    if(!Number.isFinite(num)) return null;
    return kFlag?num*1000:num;
  };

  const detail={
    recipients,
    itemTokens,
    tokens:null,
    levelsSpent:null,
    levelsGained:null,
    downtimeSpent:null,
    goldSpent:null
  };

  if(Array.isArray(recipients)){
    recipients.forEach(rec=>{
      const normalized=normalizeMatchToken(rec);
      if(normalized) tokens.add(`recipient:${normalized}`);
    });
  }

  const explicitLevelMatches=[];
  raw.replace(/(?:^|[\s,+/&-])([0-9]+)\s*(?:levels?|lvl)\b/gi,(match,value)=>{
    const parsed=normalizeNumber(value,false);
    if(parsed!=null) explicitLevelMatches.push(parsed);
    return match;
  });
  const explicitLevelTotal=explicitLevelMatches.reduce((sum,val)=>sum+val,0);
  const hasLevelPhrase=/levels?\s+(?:to|for|of)\b/i.test(raw);
  const multiplierMatches=[];
  raw.replace(/\(x\s*([0-9]+)\s*\)/gi,(match,value)=>{
    const parsed=normalizeNumber(value,false);
    if(parsed!=null) multiplierMatches.push(parsed);
    return match;
  });

  if(explicitLevelMatches.length>0){
    if(explicitLevelTotal>0){
      detail.levelsSpent=explicitLevelTotal;
    }
  }else if(hasLevelPhrase){
    if(multiplierMatches.length>0){
      const multiplierTotal=multiplierMatches.reduce((sum,val)=>sum+val,0);
      if(multiplierTotal>0){
        detail.levelsSpent=multiplierTotal;
      }
    }
    if(detail.levelsSpent==null){
      if(Array.isArray(recipients) && recipients.length>0){
        detail.levelsSpent=recipients.length;
      }else{
        detail.levelsSpent=1;
      }
    }
  }

  const dtdMatches=[];
  raw.replace(/([0-9][0-9,]*)(?:\s*(k))?\s*dtd\b/gi,(match,value,kFlag)=>{
    const parsed=normalizeNumber(value,kFlag);
    if(parsed!=null) dtdMatches.push(parsed);
    return match;
  });
  if(dtdMatches.length>0){
    const dtdTotal=dtdMatches.reduce((sum,val)=>sum+val,0);
    if(dtdTotal>0) detail.downtimeSpent=dtdTotal;
  }

  const gpMatches=[];
  raw.replace(/([0-9][0-9,]*)(?:\s*(k))?\s*gp\b/gi,(match,value,kFlag)=>{
    const parsed=normalizeNumber(value,kFlag);
    if(parsed!=null) gpMatches.push(parsed);
    return match;
  });
  if(gpMatches.length>0){
    const gpTotal=gpMatches.reduce((sum,val)=>sum+val,0);
    if(gpTotal>0) detail.goldSpent=gpTotal;
  }

  if(detail.levelsSpent!=null) addNumericToken('levels',detail.levelsSpent);
  if(detail.downtimeSpent!=null) addNumericToken('dtd',detail.downtimeSpent);
  if(detail.goldSpent!=null) addNumericToken('gp',detail.goldSpent);

  detail.tokens=Array.from(tokens);
  return detail;
}
function extractContentTokens(values){
  const tokens=new Set();
  const stopWords=new Set(['and','the','for','with','from','into','onto','this','that','item','items','reward','rewards','entry','entries','log','card','cards','season','seasonal','dm','of','to','per','plus','minus','bonus','extra','cost','gp','hour','hours','level','levels','dtd','loss','spent','earned','player']);
  const addFromValue=(val)=>{
    if(val==null) return;
    if(Array.isArray(val)){
      val.forEach(addFromValue);
      return;
    }
    const text=String(val).toLowerCase();
    if(!text.trim()) return;
    text.split(/[^a-z0-9]+/).forEach(part=>{
      const cleaned=part.trim();
      if(!cleaned) return;
      if(cleaned.length<3) return;
      if(stopWords.has(cleaned)) return;
      const normalized=normalizeMatchToken(cleaned);
      if(!normalized) return;
      tokens.add(normalized);
    });
  };
  addFromValue(values);
  return Array.from(tokens);
}
function buildAllocationItemSeasonIndex(entries){
  const map=new Map();
  if(!Array.isArray(entries)) return map;
  entries.forEach(entry=>{
    if(!entry || entry.type!=='allocation') return;
    const season=entry.season||'';
    if(!season) return;
    extractAllocationItemTokens(entry).forEach(token=>{
      if(!map.has(token)) map.set(token,new Set());
      map.get(token).add(season);
    });
  });
  return map;
}

function rebuildDmRewardLinks(){
  DM_ALLOCATION_LINKS=new WeakMap();
  DM_REWARD_LINKS=new WeakMap();
  if(!DATA || !DATA.characters || !DM_ENTRIES || !DM_ENTRIES.length){
    return;
  }
  const charEntries=Object.entries(DATA.characters);
  if(!charEntries.length) return;

  const itemSeasonIndex=buildAllocationItemSeasonIndex(DM_ENTRIES);

  const fragmentOwnersLower=new Map();
  const fragmentOwnersCompact=new Map();
  const characterMeta=charEntries.map(([key,obj])=>{
    const names=new Set();
    const pushName=(val)=>{
      if(!val) return;
      const text=String(val).trim();
      if(text) names.add(text);
    };
    pushName(key);
    if(obj && typeof obj==='object'){
      pushName(obj.display_name);
      if(typeof obj.sheet==='string') pushName(obj.sheet);
    }
    Array.from(names).forEach(name=>{
      const cleaned=name.replace(/\(.*?\)/g,' ').replace(/\s{2,}/g,' ').trim();
      if(cleaned && cleaned!==name){
        names.add(cleaned);
      }
    });
    const lowerVariants=new Set();
    const compactVariants=new Set();
    const fragments=new Set();
    names.forEach(name=>{
      const lower=name.toLowerCase();
      if(lower) lowerVariants.add(lower);
      const compact=normalizeMatchToken(name);
      if(compact) compactVariants.add(compact);
      name.split(/[^A-Za-z0-9]+/).forEach(part=>{
        const trimmed=part.trim();
        if(trimmed.length>=3){
          fragments.add(trimmed);
        }
      });
    });
    return { key, lower:Array.from(lowerVariants).filter(Boolean), compact:Array.from(compactVariants).filter(Boolean), fragments };
  });

  characterMeta.forEach(meta=>{
    meta.fragments.forEach(fragment=>{
      const lower=fragment.toLowerCase();
      if(lower){
        if(!fragmentOwnersLower.has(lower)) fragmentOwnersLower.set(lower,new Set());
        fragmentOwnersLower.get(lower).add(meta.key);
      }
      const compact=normalizeMatchToken(fragment);
      if(compact){
        if(!fragmentOwnersCompact.has(compact)) fragmentOwnersCompact.set(compact,new Set());
        fragmentOwnersCompact.get(compact).add(meta.key);
      }
    });
  });

  const uniqueFragmentLower=new Map();
  fragmentOwnersLower.forEach((owners,frag)=>{
    if(owners.size===1){
      uniqueFragmentLower.set(frag, owners.values().next().value);
    }
  });
  const uniqueFragmentCompact=new Map();
  fragmentOwnersCompact.forEach((owners,frag)=>{
    if(owners.size===1){
      uniqueFragmentCompact.set(frag, owners.values().next().value);
    }
  });

  const rewardMetaByChar=new Map();
  charEntries.forEach(([key,obj])=>{
    const advs=obj && Array.isArray(obj.adventures)?obj.adventures:[];
    advs.forEach(adv=>{
      if(!isDmRewardEntry(adv)) return;
      const inferredSeason=inferSeasonFromReward(adv);
      const meta={
        charKey:key,
        adv,
        date:normalizeDateString(adv.date),
        levels:Number(adv.level_plus||0)||0,
        dtd:Number(adv.dtd_net||0)||0,
        hours:(Number(adv.hours)||0)+(Number(adv.extra_hours)||0),
        itemsNormalized:Array.isArray(adv.perm_items)?adv.perm_items.map(item=>normalizeMatchToken(item)).filter(token=>token && token.length>=2):[],
        season:inferredSeason,
        seasonGroup:normalizeSeasonGroup(inferredSeason)
      };
      const textSources=[];
      const pushText=(val)=>{
        if(val==null) return;
        if(Array.isArray(val)){
          val.forEach(pushText);
          return;
        }
        const text=String(val).trim();
        if(text) textSources.push(text);
      };
      pushText(adv.title);
      pushText(adv.notes);
      pushText(adv.adventure);
      pushText(adv.story_awards);
      pushText(adv.reward);
      pushText(adv.log);
      pushText(adv.description);
      pushText(adv.summary);
      pushText(adv.details);
      pushText(adv.item);
      pushText(adv.magic_item);
      pushText(adv.magic_items);
      pushText(adv.story);
      if(Array.isArray(adv.perm_items)) pushText(adv.perm_items.join(' '));
      if(Array.isArray(adv.temp_items)) pushText(adv.temp_items.join(' '));
      if(Array.isArray(adv.consumable_items)) pushText(adv.consumable_items.join(' '));
      const combinedLower=textSources.join(' ').toLowerCase();
      const contentTokenSet=new Set(meta.itemsNormalized);
      extractContentTokens(textSources).forEach(token=>contentTokenSet.add(token));
      meta.contentTokens=Array.from(contentTokenSet);
      meta.hasLevelKeyword=/\blevels?\b/.test(combinedLower);
      meta.hasDtdKeyword=/\bdtd\b/.test(combinedLower) || /down\s*time/.test(combinedLower);
      meta.hasHourKeyword=/\bhours?\b/.test(combinedLower);
      if(meta.itemsNormalized.length){
        const seasonsFromItems=new Set();
        meta.itemsNormalized.forEach(token=>{
          const seasons=itemSeasonIndex.get(token);
          if(seasons){
            seasons.forEach(season=>{
              if(season) seasonsFromItems.add(season);
            });
          }
        });
        const seasonsArray=Array.from(seasonsFromItems);
        if(seasonsArray.length===1){
          if(!meta.season) meta.season=dmNormalizeSeasonLabel(seasonsArray[0]);
          meta.seasonGroup=normalizeSeasonGroup(meta.season);
        }else if(seasonsArray.length>1){
          const groups=Array.from(new Set(seasonsArray.map(normalizeSeasonGroup).filter(Boolean)));
          if(groups.length===1){
            if(!meta.season) meta.season=dmNormalizeSeasonLabel(seasonsArray[0]);
            meta.seasonGroup=groups[0];
          }
        }
      }
      if(!meta.seasonGroup && meta.season){
        meta.seasonGroup=normalizeSeasonGroup(meta.season);
      }
      if(!rewardMetaByChar.has(key)) rewardMetaByChar.set(key,[]);
      rewardMetaByChar.get(key).push(meta);
    });
  });

  const assignedRewards=new Set();
  DM_ENTRIES.forEach(entry=>{
    if(!entry || entry.type!=='allocation') return;
    const allocationText=entry.allocation||'';
    if(!allocationText) return;
    const normalizedText=allocationText.toLowerCase();
    const normalizedCompact=normalizeMatchToken(allocationText);
    const allocationTokens=(entry && Array.isArray(entry.allocation_item_tokens) && entry.allocation_item_tokens.length)
      ? entry.allocation_item_tokens.slice()
      : extractAllocationItemTokens(allocationText);
    const allocationTokenSet=new Set(allocationTokens);
    const allocationWordSet=new Set(normalizedText.split(/[^a-z0-9]+/).map(part=>normalizeMatchToken(part)).filter(token=>token && token.length>=3));
    const recipients=parseAllocationRecipients(allocationText);
    const matchedKeys=new Set();

    if(recipients.length){
      recipients.forEach(rec=>{
        const variants=[rec, rec.replace(/\(.*?\)/g,' ').trim()];
        variants.forEach(variant=>{
          if(!variant) return;
          const lowerVariant=variant.toLowerCase();
          const compactVariant=normalizeMatchToken(variant);
          characterMeta.forEach(meta=>{
            if(matchedKeys.has(meta.key)) return;
            if(meta.lower.includes(lowerVariant) || (compactVariant && meta.compact.includes(compactVariant))){
              matchedKeys.add(meta.key);
              return;
            }
            if(uniqueFragmentLower.get(lowerVariant)===meta.key || (compactVariant && uniqueFragmentCompact.get(compactVariant)===meta.key)){
              matchedKeys.add(meta.key);
            }
          });
        });
      });
    }

    if(!matchedKeys.size){
      characterMeta.forEach(meta=>{
        const lowerHit=meta.lower.some(name=>name && normalizedText.includes(name));
        const compactHit=meta.compact.some(name=>name && normalizedCompact.includes(name));
        if(lowerHit || compactHit){
          matchedKeys.add(meta.key);
        }
      });
    }

    if(matchedKeys.size!==1) return;
    const [charKey]=matchedKeys;
    const candidates=rewardMetaByChar.get(charKey)||[];
    if(!candidates.length) return;

    const targetLevels=Number(entry.levels_plus||0)||0;
    const targetCost=Number(entry.cost||0)||0;
    const targetHours=(Number(entry.hours)||0)+(Number(entry.extra_hours)||0);
    let bestScore=-Infinity;
    let bestCandidates=[];

    candidates.forEach(meta=>{
      let score=0;
      if(targetLevels && meta.levels===targetLevels) score+=6;
      else if(targetLevels && meta.levels && Math.abs(meta.levels-targetLevels)===1) score+=2;
      else if(!targetLevels && meta.levels===0) score+=1;
      if(targetCost && meta.dtd===targetCost) score+=6;
      else if(targetCost && meta.dtd && Math.abs(meta.dtd-targetCost)<=1) score+=2;
      else if(!targetCost && meta.dtd===0) score+=1;
      if(targetHours && meta.hours===targetHours) score+=5;
      else if(targetHours && meta.hours && Math.abs(meta.hours-targetHours)<=1) score+=2;
      else if(!targetHours && meta.hours===0) score+=1;
      const itemMatches=meta.itemsNormalized.filter(token=>token && (allocationTokenSet.has(token) || normalizedCompact.includes(token))).length;
      if(itemMatches>0){
        score+=itemMatches*7;
        if(itemMatches===meta.itemsNormalized.length){
          score+=3;
        }
      }
      if(Array.isArray(meta.contentTokens) && meta.contentTokens.length){
        const contentMatches=meta.contentTokens.filter(token=>token && (allocationTokenSet.has(token) || normalizedCompact.includes(token) || allocationWordSet.has(token))).length;
        if(contentMatches>0){
          score+=contentMatches*3;
        }
      }
      if(meta.levels>0 && (normalizedText.includes('level') || meta.hasLevelKeyword)) score+=1;
      if(meta.dtd>0 && (normalizedText.includes('dtd') || meta.hasDtdKeyword)) score+=1;
      if(meta.hasHourKeyword && targetHours>0) score+=1;

      if(score>bestScore){
        bestScore=score;
        bestCandidates=[meta];
      }else if(score===bestScore && score>0){
        bestCandidates.push(meta);
      }
    });

    if(bestScore<5 || bestCandidates.length!==1) return;
    const bestMeta=bestCandidates[0];
    if(assignedRewards.has(bestMeta.adv)) return;
    assignedRewards.add(bestMeta.adv);
    DM_ALLOCATION_LINKS.set(entry,{charKey,adv:bestMeta.adv});
    DM_REWARD_LINKS.set(bestMeta.adv,{entry,charKey});
  });
}
function updateDmMeta(){
  if(metaEl){
    metaEl.textContent='';
    metaEl.style.display='none';
    metaEl.setAttribute('aria-hidden','true');
  }
  updateDmSummaryBar();
}
function updateDmSummaryBar(){
  if(!dmSummaryBar) return;
  const earned=(Number(DM_SUMMARY.earnedHours)||0)+(Number(DM_SUMMARY.earnedBonus)||0);
  const spent=(Number(DM_SUMMARY.allocatedHours)||0)+(Number(DM_SUMMARY.allocatedBonus)||0)+(Number(DM_SUMMARY.allocatedCost)||0);
  const available=earned-spent;
  const levelBalance=(Number(DM_SUMMARY.earnedLevels)||0)-(Number(DM_SUMMARY.spentLevels)||0);
  if(dmHoursValueEl){
    dmHoursValueEl.textContent=fmtNumber(available);
    dmHoursValueEl.setAttribute('data-value', String(available));
  }
  if(dmLevelsValueEl){
    dmLevelsValueEl.textContent=fmtNumber(levelBalance);
    dmLevelsValueEl.setAttribute('data-value', String(levelBalance));
  }
  const itemCount=DM_PRE_ITEMS.length||0;
  if(dmItemsCountEl){
    dmItemsCountEl.textContent=fmtNumber(itemCount);
  }
  if(dmItemsBtnEl){
    const label=`View unallocated pre-Season 11 magic items (${fmtNumber(itemCount)} ${itemCount===1?'item':'items'})`;
    dmItemsBtnEl.setAttribute('aria-label', label);
    dmItemsBtnEl.title=label;
  }
  if(dmItemsListEl){
    dmItemsListEl.innerHTML='';
    if(!itemCount){
      const empty=document.createElement('div');
      empty.className='dm-items-empty';
      empty.textContent='All pre-Season 11 items are allocated';
      dmItemsListEl.appendChild(empty);
    }else{
      DM_PRE_ITEMS.forEach(item=>{
        const row=document.createElement('div');
        row.className='dm-items-row';
        const name=document.createElement('div');
        name.textContent=item.item||'Unknown item';
        row.appendChild(name);
        const metaParts=[];
        if(item.date){
          const formatted=fmtDate(item.date);
          if(formatted) metaParts.push(formatted);
        }
        if(item.code){ metaParts.push(item.code); }
        if(item.location){ metaParts.push(item.location); }
        if(metaParts.length){
          const meta=document.createElement('div');
          meta.className='dm-items-meta';
          meta.textContent=metaParts.join(' • ');
          row.appendChild(meta);
        }
        dmItemsListEl.appendChild(row);
      });
    }
  }
}
function openDmItemsModal(){
  if(!dmItemsModal) return;
  closeAddMenu();
  updateDmSummaryBar();
  dmItemsModal.classList.add('open');
  refreshModalState();
  if(dmItemsBtnEl){
    dmItemsBtnEl.setAttribute('aria-expanded','true');
  }
  if(dmItemsCloseBtn){
    try{ dmItemsCloseBtn.focus({preventScroll:true}); }
    catch(err){ dmItemsCloseBtn.focus(); }
  }
}
function closeDmItemsModal(){
  if(dmItemsModal){
    dmItemsModal.classList.remove('open');
  }
  refreshModalState();
  if(dmItemsBtnEl){
    dmItemsBtnEl.setAttribute('aria-expanded','false');
  }
}
function setDmHeader(){
  if(avatarEl){
    resetAvatar();
    if(AVATAR_FALLBACK_PATH){
      avatarEl.src=AVATAR_FALLBACK_PATH;
      avatarEl.classList.add('avatar-fallback');
    }
    avatarEl.alt='Dungeon Master Log';
  }
  if(badgesEl){
    badgesEl.innerHTML='';
    badgesEl.style.display='none';
    badgesEl.setAttribute('aria-hidden','true');
  }
}
function updateUiForSelection(key){
  closeCharMenu();
  closeAddMenu();
  const isDm=isDmLogKey(key);
  if(headerQuick){
    headerQuick.style.display=isDm?'none':'';
    headerQuick.setAttribute('aria-hidden', isDm?'true':'false');
  }
  if(dmSummaryBar){
    const showSummary=isDm && hasDmLogData();
    dmSummaryBar.hidden=!showSummary;
    dmSummaryBar.setAttribute('aria-hidden', showSummary?'false':'true');
  }
  if(!isDm){
    closeDmItemsModal();
  }
  if(activityToggleBtn){
    activityToggleBtn.style.display=isDm?'none':'';
    activityToggleBtn.setAttribute('aria-hidden', isDm?'true':'false');
  }
  if(addCardBtn){
    const showButton=!isDm || hasDmLogData();
    addCardBtn.style.display=showButton?'':'';
    addCardBtn.setAttribute('aria-hidden', showButton?'false':'true');
    if(!showButton){
      closeAddMenu();
    }
  }
  if(qEl){
    const placeholder=isDm?'Search DM log entries':(defaultSearchPlaceholder||'');
    if(placeholder){
      qEl.setAttribute('placeholder', placeholder);
      qEl.setAttribute('aria-label', placeholder);
    }else{
      qEl.removeAttribute('aria-label');
    }
  }
  updateAddButtonContext(isDm);
}

function updateAddButtonContext(isDm){
  if(!addCardBtn) return;
  const description=isDm?'Add a new DM session or reward allocation':'Add a new adventure or downtime activity';
  addCardBtn.title=description;
  addCardBtn.setAttribute('aria-label', description);
  const expanded=(addCardMenu && !addCardMenu.hidden)?'true':'false';
  addCardBtn.setAttribute('aria-expanded', expanded);
}
function renderDmLog(){
  if(!grid) return;
  const query=(qEl && typeof qEl.value==='string')?qEl.value.trim().toLowerCase():'';
  const filtered=DM_ENTRIES.filter(entry=>{
    if(!query) return true;
    const roleText=Array.isArray(entry.roles)?entry.roles.join(' '):'';
    const blob=[
      entry.season,
      entry.name,
      entry.code,
      entry.allocation,
      entry.location,
      entry.item,
      roleText,
      entry.tier,
      entry.cost,
      entry.levels_plus,
      entry.levels_minus,
      entry.hours,
      entry.extra_hours
    ].map(val=>val==null?'':String(val)).join(' ').toLowerCase();
    return blob.includes(query);
  });
  grid.innerHTML='';
  if(!filtered.length){
    if(emptyEl){
      emptyEl.textContent=DM_EMPTY_MESSAGE;
      emptyEl.style.display='block';
    }
    return;
  }
  if(emptyEl){
    emptyEl.textContent=DM_EMPTY_MESSAGE;
    emptyEl.style.display='none';
  }
  filtered.forEach((entry,idx)=>{
    const card=makeDmCard(entry,idx);
    grid.appendChild(card);
  });
}
function makeDmCard(entry,idx){
  const isAllocation=entry.type==='allocation';
  const card=document.createElement('article');
  card.className='card dm-card'+(isAllocation?' activity':'');
  const sortIdx=entry.sortIndex!=null?entry.sortIndex:idx;
  card.dataset.idx=String(sortIdx);
  card.__dmEntry=entry;
  const linkMeta=(DM_ALLOCATION_LINKS && DM_ALLOCATION_LINKS.get(entry))||null;
  let createLinkChip=null;
  if(linkMeta && linkMeta.adv){
    const charObj=(DATA && DATA.characters && DATA.characters[linkMeta.charKey])||null;
    const charName=(charObj && (charObj.display_name || charObj.sheet)) || linkMeta.charKey;
    const label=`View DM reward entry for ${charName}`;
    createLinkChip=()=>{
      const chip=document.createElement('button');
      chip.type='button';
      chip.className='pill pill-link';
      chip.textContent='Reward entry';
      chip.title=label;
      chip.setAttribute('aria-label',label);
      chip.addEventListener('click',(ev)=>{
        ev.stopPropagation();
        ev.preventDefault();
        navigateToCharacterReward(linkMeta.charKey, linkMeta.adv);
      });
      return chip;
    };
  }

  const header=document.createElement('div');
  header.className='card-hd';

  if(isAllocation){
    const main=document.createElement('div');
    main.className='activity-line';
    const left=document.createElement('div');
    left.className='activity-left';
    const dateSpan=document.createElement('span');
    dateSpan.className='activity-date';
    dateSpan.textContent=fmtDate(entry.date);
    const nameSpan=document.createElement('span');
    nameSpan.className='activity-name';
    nameSpan.textContent=sanitizeTitle(entry.allocation || 'Reward allocation');
    left.append(dateSpan,nameSpan);
    main.appendChild(left);
    const chips=document.createElement('div');
    chips.className='chips';
    const linkChip=createLinkChip?createLinkChip():null;
    if(linkChip){ chips.appendChild(linkChip); }
    const costVal=dmToNullableNumber(entry.cost);
    if(costVal!=null && costVal!==0){
      chips.appendChild(pill(`Cost ${fmtNumber(costVal)}`));
    }
    const levelsVal=dmToNullableNumber(entry.levels_plus);
    if(levelsVal!=null && levelsVal!==0){
      chips.appendChild(pill(`Levels ${fmtNumber(levelsVal,{signed:true})}`));
    }
    if(chips.children.length){
      main.appendChild(chips);
    }
    header.appendChild(main);
  }else{
    const main=document.createElement('div');
    main.className='titleLine';
    const dateDiv=document.createElement('div');
    dateDiv.className='date';
    dateDiv.textContent=fmtDate(entry.date);
    const titleDiv=document.createElement('div');
    titleDiv.className='title';
    titleDiv.textContent=sanitizeTitle(entry.name || entry.code || 'DM Session');
    const subtitleRow=document.createElement('div');
    subtitleRow.className='subtitle-row';
    const subtitleDiv=document.createElement('div');
    subtitleDiv.className='subtitle';
    subtitleDiv.textContent=entry.code || entry.season || '';
    subtitleRow.appendChild(subtitleDiv);
    const chips=document.createElement('div');
    chips.className='chips';
    const linkChip=createLinkChip?createLinkChip():null;
    if(linkChip){ chips.appendChild(linkChip); }
    const hoursVal=dmToNullableNumber(entry.hours);
    if(hoursVal!=null && hoursVal!==0){
      chips.appendChild(pill(`Hours ${fmtNumber(hoursVal)}`));
    }
    const extraVal=dmToNullableNumber(entry.extra_hours);
    if(extraVal!=null && extraVal!==0){
      chips.appendChild(pill(`Bonus ${fmtNumber(extraVal)}`));
    }
    if(entry.tier!=null && entry.tier!==''){
      chips.appendChild(pill(`Tier ${fmtNumber(entry.tier)}`));
    }
    const levelsVal=dmToNullableNumber(entry.levels_plus);
    if(levelsVal!=null && levelsVal!==0){
      chips.appendChild(pill(`Levels ${fmtNumber(levelsVal,{signed:true})}`));
    }
    if(chips.children.length){
      subtitleRow.appendChild(chips);
    }
    main.append(dateDiv,titleDiv,subtitleRow);
    header.appendChild(main);
  }

  header.addEventListener('click',()=>toggleCard(card));
  card.appendChild(header);

  const body=document.createElement('div');
  body.className='card-bd';
  const inner=document.createElement('div');
  inner.className='bd-in';

  const addField=(label,value)=>{
    if(value==null) return;
    let node=null;
    let text='';
    if(value instanceof Node){
      node=value;
    }else{
      text=normalizeDisplayValue(value);
      if(!text){
        return;
      }
    }
    const field=document.createElement('div');
    field.className='field';
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v';
    const display=document.createElement('div'); display.className='display';
    if(node){
      display.appendChild(node);
    }else{
      display.textContent=text;
    }
    v.appendChild(display);
    field.append(k,v);
    inner.appendChild(field);
    return field;
  };

  addField('Season', entry.season);
  if(isAllocation){
    addField('Reward allocation', entry.allocation);
    if(entry.cost!=null){ addField('Season cost', fmtNumber(entry.cost)); }
    if(entry.levels_plus!=null){ addField('Levels granted', fmtNumber(entry.levels_plus)); }
    if(entry.hours!=null){ addField('Hours', fmtNumber(entry.hours)); }
    if(entry.extra_hours!=null){ addField('Bonus hours', fmtNumber(entry.extra_hours)); }
    if(entry.location){ addField('Location', entry.location); }
  }else{
    if(entry.code){ addField('Adventure code', entry.code); }
    if(entry.name){ addField('Adventure name', entry.name); }
    if(entry.tier!=null){ addField('Tier', fmtNumber(entry.tier)); }
    if(entry.hours!=null){ addField('Hours', fmtNumber(entry.hours)); }
    if(entry.extra_hours!=null){ addField('Bonus hours', fmtNumber(entry.extra_hours)); }
    if(entry.roles && entry.roles.length){ addField('Roles', listBox(entry.roles)); }
    if(entry.levels_plus!=null){ addField('Levels granted', fmtNumber(entry.levels_plus)); }
    if(entry.levels_minus!=null && entry.levels_minus!==entry.levels_plus){ addField('Levels spent', fmtNumber(entry.levels_minus)); }
    if(entry.item){ addField('Reward item', entry.item); }
    if(entry.allocation){ addField('Reward allocation', entry.allocation); }
    if(entry.location){ addField('Location', entry.location); }
  }

  body.appendChild(inner);
  card.appendChild(body);
  return card;
}

function getMostRecentCharacter(){
  if(!DATA || !DATA.characters){
    return '';
  }
  let latestKey=null, latestDate=0;
  for (const [key,obj] of Object.entries(DATA.characters)){
    if(!obj.adventures||!obj.adventures.length) continue;
    const maxDate=Math.max(...obj.adventures.map(a=>{ const t=new Date(a.date).getTime(); return isNaN(t)?0:t; }));
    if(maxDate>latestDate){ latestDate=maxDate; latestKey=key; }
  }
  const keys=Object.keys(DATA.characters);
  return latestKey || (keys.length?keys[0]:'');
}
function isActivityEntry(a){ return a && a.kind && a.kind!=='adventure'; }
function isDmRewardEntry(entry){
  if(!entry) return false;
  const title=String(entry.title||'').toLowerCase();
  const code=String(entry.code||'').toLowerCase();
  return title.includes('dm reward') || code.includes('dm reward');
}
function netVals(a){ return { gp:(+a.gp_plus||0)-(+a.gp_minus||0), dtd:(+a.dtd_plus||0)-(+a.dtd_minus||0) }; }
function fmtSigned(n){ return fmtNumber(n,{signed:true}); }

const __MIN_TIME=-8640000000000000;
function entryTimestamp(entry){
  if(!entry) return __MIN_TIME;
  const raw=entry.date;
  if(raw==null) return __MIN_TIME;
  if(raw instanceof Date){
    const t=raw.getTime();
    return Number.isFinite(t)?t:__MIN_TIME;
  }
  if(typeof raw==='number' && Number.isFinite(raw)) return raw;
  const t=new Date(raw).getTime();
  return Number.isFinite(t)?t:__MIN_TIME;
}
function entryIndexHint(wrapper){
  if(wrapper && typeof wrapper.idx==='number') return wrapper.idx;
  if(wrapper && typeof wrapper.index==='number') return wrapper.index;
  return 0;
}
function compareChronoDesc(a,b){
  const timeA=entryTimestamp(a&&a.adv?a.adv:a);
  const timeB=entryTimestamp(b&&b.adv?b.adv:b);
  if(timeA!==timeB) return timeB-timeA;
  return entryIndexHint(a)-entryIndexHint(b);
}
function compareChronoAsc(a,b){
  const timeA=entryTimestamp(a&&a.adv?a.adv:a);
  const timeB=entryTimestamp(b&&b.adv?b.adv:b);
  if(timeA!==timeB) return timeA-timeB;
  return entryIndexHint(a)-entryIndexHint(b);
}

/* --- smooth expand/collapse --- */
function isAnimating(card){ return card.dataset.anim==='1'; }
function setAnimating(card,on){ if(on) card.dataset.anim='1'; else delete card.dataset.anim; }
function afterTransition(el,prop,ms,cb){ let done=false; const onEnd=e=>{ if(e.propertyName!==prop||done)return; done=true; el.removeEventListener('transitionend',onEnd); cb(); }; el.addEventListener('transitionend',onEnd); setTimeout(()=>{ if(done)return; done=true; el.removeEventListener('transitionend',onEnd); cb(); },ms); }
function calcCardDuration(px){ if(!px||px<=0) return 220; const dur=200+px*0.35; return Math.round(Math.max(220, Math.min(620, dur))); }
function setCardDuration(bd,px){ const dur=calcCardDuration(px); bd.style.setProperty('--card-dur', dur+'ms'); return dur; }
function clearCardDuration(bd){ bd.style.removeProperty('--card-dur'); }
function expandCard(card){ if(isAnimating(card))return; const bd=card.querySelector('.card-bd'); if(!bd)return; setAnimating(card,true); const start=bd.offsetHeight||0; bd.style.height=start+'px'; bd.style.opacity='0'; card.classList.add('open'); void bd.offsetHeight; requestAnimationFrame(()=>{ const target=Math.max(bd.scrollHeight,start); const duration=setCardDuration(bd,target); bd.style.height=target+'px'; bd.style.opacity='1'; afterTransition(bd,'height',duration+100,()=>{ bd.style.height='auto'; clearCardDuration(bd); setAnimating(card,false); }); }); }
function collapseCard(card){ if(isAnimating(card))return; const bd=card.querySelector('.card-bd'); if(!bd)return; setAnimating(card,true); const start=bd.offsetHeight||bd.scrollHeight||0; const duration=setCardDuration(bd,start); bd.style.height=start+'px'; bd.style.opacity='1'; void bd.offsetHeight; requestAnimationFrame(()=>{ bd.style.height='0px'; bd.style.opacity='0'; }); afterTransition(bd,'height',duration+100,()=>{ card.classList.remove('open'); clearCardDuration(bd); setAnimating(card,false); }); }
function toggleCard(card){ card.classList.contains('open')?collapseCard(card):expandCard(card); }

function focusCardElement(card,{expand=true}={}){
  if(!card) return;
  const shouldExpand=expand && !card.classList.contains('open');
  if(shouldExpand){
    expandCard(card);
  }
  if(!card.hasAttribute('tabindex')){
    card.setAttribute('tabindex','-1');
  }
  const applyFocus=()=>{
    try{ card.scrollIntoView({behavior:'smooth',block:'center'}); }
    catch(err){ try{ card.scrollIntoView({block:'center'}); }catch(_err){ /* no-op */ } }
    if(typeof card.focus==='function'){
      try{ card.focus({preventScroll:true}); }
      catch(err){ card.focus(); }
    }
    card.classList.remove('focus-glow');
    void card.offsetWidth;
    card.classList.add('focus-glow');
    setTimeout(()=>card.classList.remove('focus-glow'),1400);
  };
  const delay=shouldExpand?320:40;
  setTimeout(()=>{ requestAnimationFrame(applyFocus); }, delay);
}

function clearSearchForNavigation(){
  if(qEl && qEl.value){
    qEl.value='';
    return true;
  }
  return false;
}

function ensureActivitiesVisible(){
  if(showActivities) return false;
  showActivities=true;
  persistActivityVisibility();
  updateActivityToggle();
  return true;
}

function findCharacterCardFor(adv){
  if(!grid) return null;
  const cards=Array.from(grid.querySelectorAll('.card'));
  return cards.find(card=>card.__dataRef===adv) || null;
}

function findDmCardFor(entry){
  if(!grid) return null;
  const cards=Array.from(grid.querySelectorAll('.card'));
  return cards.find(card=>card.__dmEntry===entry) || null;
}

function navigateToCharacterReward(charKey, adv){
  if(!charKey || !adv || !charSel){
    return;
  }
  clearSearchForNavigation();
  ensureActivitiesVisible();
  if(charSel.value!==charKey){
    charSel.value=charKey;
  }
  filterAndRender();
  requestAnimationFrame(()=>{
    const card=findCharacterCardFor(adv);
    if(card){
      focusCardElement(card,{expand:true});
    }
  });
}

function navigateToDmAllocation(entry){
  if(!entry || !charSel){
    return;
  }
  clearSearchForNavigation();
  if(charSel.value!==DM_LOG_KEY){
    charSel.value=DM_LOG_KEY;
  }
  filterAndRender();
  requestAnimationFrame(()=>{
    const card=findDmCardFor(entry);
    if(card){
      focusCardElement(card,{expand:true});
    }
  });
}

/* --- inventory helpers --- */
const REGEX_META_CHARS=/[\\^$.*+?()[\]{}|]/g;
function escapeRegexFragment(value){
  return String(value||'').replace(REGEX_META_CHARS,'\\$&');
}
function normItemName(s){ return (s||'').trim(); }
function parseLostItemList(raw){
  if(Array.isArray(raw)){
    return raw.map(normItemName).filter(Boolean);
  }
  const text=String(raw||'').replace(/\r\n?/g,'\n').trim();
  if(!text) return [];
  if(text.includes('\n')){
    return text.split('\n').map(normItemName).filter(Boolean);
  }
  if(text.includes(';')){
    return text.split(';').map(normItemName).filter(Boolean);
  }
  if(text.includes('•')){
    return text.split('•').map(normItemName).filter(Boolean);
  }
  return [normItemName(text)];
}
function parseAcquisitionName(s){ const t=String(s||'').trim(); const m=t.match(/^\((.*)\)$/); return m?{name:m[1].trim(),acquired:false}:{name:t,acquired:true}; }
function looksLikeLossEntry(entry){ const t=((entry.title||'')+' '+(entry.notes||'')).toLowerCase(); return /trade|traded|sold|gave|gifted|lost|relinquish|transfer/.test(t); }
function sortCharacterAdventures(key){
  if(!DATA || !DATA.characters) return;
  const ch=DATA.characters[key];
  if(!ch || !Array.isArray(ch.adventures)) return;
  const decorated=ch.adventures.map((adv,idx)=>({adv,idx})).sort(compareChronoDesc);
  const reordered=decorated.map(item=>item.adv);
  const changed=reordered.length!==ch.adventures.length || reordered.some((adv,idx)=>adv!==ch.adventures[idx]);
  if(changed){
    ch.adventures=reordered;
  }
}
function collectPermanentInventory(charKey){
  const ch=DATA.characters[charKey]; if(!ch||!ch.adventures) return {kept:[], map:new Map()};
  const entries=ch.adventures.map((adv,idx)=>({adv,idx})).sort(compareChronoAsc);
  const keptMap=new Map();
  const removeByName=(name)=>{
    const cleaned=normItemName(name);
    if(!cleaned) return;
    keptMap.delete(cleaned.toLowerCase());
  };
  entries.forEach(({adv,idx})=>{
    const items=adv.perm_items||[];
    const lostNames=parseLostItemList(adv.lost_perm_item);
    const tradedAway=[
      ...parseLostItemList(adv.traded_item),
      ...parseLostItemList(adv.itemTraded)
    ];
    const receivedList=parseLostItemList(adv.itemReceived);
    const hasTradeMeta=tradedAway.length>0||receivedList.length>0||(lostNames.length>0&&items.length>0);
    const isLoss=(adv.kind&&adv.kind!=='adventure')?looksLikeLossEntry(adv):false;
    if(isLoss && !hasTradeMeta){
      if(items.length){
        items.forEach(raw=>{
          const {name}=parseAcquisitionName(raw);
          removeByName(name);
        });
      }else if(adv.notes){
        const note=String(adv.notes||'');
        if(note){
          [...keptMap.values()].forEach(meta=>{
            const pattern=new RegExp(`\\b${escapeRegexFragment(meta.name)}\\b`,'i');
            if(pattern.test(note)){
              keptMap.delete(meta.name.toLowerCase());
            }
          });
        }
      }
      lostNames.forEach(removeByName);
      return;
    }
    const handleAddition=(raw)=>{
      const {name,acquired}=parseAcquisitionName(raw);
      const cleaned=normItemName(name);
      if(!cleaned) return;
      const key=cleaned.toLowerCase();
      if(!acquired){
        keptMap.delete(key);
        return;
      }
      keptMap.set(key,{name:cleaned,index:idx,adv});
    };
    items.forEach(handleAddition);
    if(hasTradeMeta){
      receivedList.forEach(handleAddition);
    }
    lostNames.forEach(removeByName);
    tradedAway.forEach(removeByName);
  });
  const kept=[...keptMap.values()].sort((a,b)=>a.name.localeCompare(b.name));
  return {kept,map:keptMap};
}
function currentLevelFor(charKey){
  const ch=DATA.characters[charKey]; const lvl=1+Math.floor((ch.adventures||[]).reduce((s,a)=>s+(+a.level_plus||0),0)); return Math.max(1,lvl);
}
function entryLevelAtStart(entry){
  if(!entry) return null;
  const stored=Number(entry.__levelAtStart);
  if(Number.isFinite(stored) && stored>0){
    return stored;
  }
  const key=entry.__charKey;
  if(typeof key==='string' && key && isValidSheetKey(key)){
    const fallback=currentLevelFor(key);
    if(Number.isFinite(fallback) && fallback>0){
      return fallback;
    }
  }
  return null;
}
function activeSlotsFor(level){ if(level<=4)return 1; if(level<=10)return 3; if(level<=16)return 6; return 10; }
function consumableCarrySlotsFor(level){ if(level<=4)return 5; if(level<=16)return 10; return 15; }
function consumableCarryKey(k){ return 'CARRIED_CONS__'+k; }
function loadCarriedConsumables(k){
  try{
    const raw=JSON.parse(localStorage.getItem(consumableCarryKey(k))||'[]');
    if(Array.isArray(raw)) return raw.map(item=>String(item||'').trim()).filter(Boolean);
  }catch(_){ /* ignore */ }
  return [];
}
function saveCarriedConsumables(k,list){
  localStorage.setItem(consumableCarryKey(k),JSON.stringify(Array.isArray(list)?list:[]));
}
function activeKey(k){ return 'ACTIVE_INV__'+k; }
function attuneKey(k){ return 'ATTUNED__'+k; }
function loadActive(k){ try{return JSON.parse(localStorage.getItem(activeKey(k))||'[]')}catch(_){return[]} }
function saveActive(k,a){ localStorage.setItem(activeKey(k),JSON.stringify(a||[])) }
function loadAttuned(k){ try{return JSON.parse(localStorage.getItem(attuneKey(k))||'[]')}catch(_){return[]} }
function saveAttuned(k,a){ localStorage.setItem(attuneKey(k),JSON.stringify(a||[])) }

function parseConsumableName(s){ const t=String(s||'').trim(); const m=t.match(/^\((.*)\)$/); return m?{name:m[1].trim(),acquired:false}:{name:t,acquired:true}; }
function formatConsumableDisplay(raw){
  const original=String(raw||'').trim();
  if(!original) return {label:'',chips:[]};
  let working=original;
  const chips=[];
  const addChip=(chip)=>{ if(!chips.includes(chip)) chips.push(chip); };
  const stripOuterParens=(str)=>{
    let next=String(str||'').trim();
    while(next.startsWith('(') && next.endsWith(')')){
      const inner=next.slice(1,-1).trim();
      if(!inner) break;
      next=inner;
    }
    return next;
  };
  const stripLeadingSeparators=(str)=>String(str||'').replace(/^[\s,:;–—-]+/, '');

  const hasSpellScroll=/spell\s*scroll/i.test(working);
  if(hasSpellScroll){ addChip('Scroll'); }
  else if(/^scrolls?\b/i.test(working)){ addChip('Scroll'); }

  const potionPrefix=/^potion\b/i.test(working);
  if(potionPrefix) addChip('Potion');

  if(!/^spell\s*scrolls?\b/i.test(working)){
    let match;
    if((match=working.match(/^spell\s*\((.+)\)\s*$/i))){
      working=match[1];
    }else if((match=working.match(/^spell\s*(?:of\s+|[:–—-]\s*)(.+)$/i))){
      working=match[1];
    }else if(/^spell\b/i.test(working)){
      working=working.replace(/^spell\b/i,'');
      working=stripLeadingSeparators(working);
    }
  }

  if(/^spell\s*scrolls?\b/i.test(working)){
    working=working.replace(/^spell\s*scrolls?\b/i,'');
    working=stripLeadingSeparators(working);
    if(/^of\s+/i.test(working)) working=working.replace(/^of\s+/i,'');
    working=stripOuterParens(working);
  }else if(/^scrolls?\b/i.test(working)){
    working=working.replace(/^scrolls?\b/i,'');
    working=stripLeadingSeparators(working);
    if(/^of\s+/i.test(working)) working=working.replace(/^of\s+/i,'');
    working=stripOuterParens(working);
  }

  if(potionPrefix || /^potion\b/i.test(working)){
    working=working.replace(/^potion\b/i,'');
    working=stripLeadingSeparators(working);
    if(/^of\s+/i.test(working)) working=working.replace(/^of\s+/i,'');
    working=stripOuterParens(working);
  }

  working=stripOuterParens(working).trim();
  if(!working) working=original;
  return {label:working,chips};
}
function deriveConsumableInventory(charKey){
  const ch=DATA.characters[charKey]; if (!ch || !ch.adventures) return new Map();
  const sorted=ch.adventures.map((adv,idx)=>({adv,idx})).sort(compareChronoAsc);
  const counts=new Map();
  const add=(n,k=1)=>{ n=n.trim(); if(!n) return; counts.set(n,(counts.get(n)||0)+k); };
  const sub=(n,k=1)=>{ n=n.trim(); if(!n) return; const cur=(counts.get(n)||0)-k; counts.set(n,Math.max(0,cur)); if(counts.get(n)===0) counts.delete(n); };
  sorted.forEach(({adv})=>{
    const items=adv.consumable_items||[];
    const isLoss=(adv.kind&&adv.kind!=='adventure')?looksLikeLossEntry(adv):false;
    if(isLoss){
      if(items.length){
        items.forEach(raw=>sub(raw.replace(/^\(|\)$/g,'')));
      }else if(adv.notes){
        const note=String(adv.notes||'');
        if(note){
          [...counts.keys()].forEach(name=>{
            const pattern=new RegExp(`\\b${escapeRegexFragment(name)}\\b`,'i');
            if(pattern.test(note)) sub(name);
          });
        }
      }
      return;
    }
    items.forEach(raw=>{ const {name,acquired}=parseConsumableName(raw); if(acquired) add(name); });
  });
  return counts;
}
function getConsumableUseMap(charKey){
  const ch=DATA.characters[charKey];
  const uses=new Map();
  const rawUses=ch&&typeof ch.consumable_uses==='object'&&ch.consumable_uses;
  if(!rawUses) return uses;
  Object.entries(rawUses).forEach(([name,val])=>{
    const count=Math.max(0,Number(val)||0);
    if(count>0) uses.set(name,count);
  });
  return uses;
}
function buildConsumableInventory(charKey){
  const base=deriveConsumableInventory(charKey);
  const ch=DATA.characters[charKey];
  const manual=(ch&&typeof ch.consumables==='object'&&ch.consumables)?ch.consumables:null;
  if(manual){
    Object.entries(manual).forEach(([name,val])=>{
      const num=Math.max(0,Number(val)||0);
      if(num>0) base.set(name,num);
      else base.delete(name);
    });
  }
  const uses=getConsumableUseMap(charKey);
  uses.forEach((used,name)=>{
    if(!base.has(name)) return;
    const remaining=Math.max(0,(base.get(name)||0)-used);
    if(remaining>0) base.set(name,remaining);
    else base.delete(name);
  });
  return base;
}
function incrementConsumableUse(charKey,name){
  const ch=DATA.characters[charKey];
  if(!ch) return false;
  const baseCount=(deriveConsumableInventory(charKey).get(name)||0);
  let total=baseCount;
  if(ch.consumables&&typeof ch.consumables==='object'&&Object.prototype.hasOwnProperty.call(ch.consumables,name)){
    const manualCount=Math.max(0,Number(ch.consumables[name])||0);
    total=manualCount;
  }
  if(total<=0) return false;
  const uses=getConsumableUseMap(charKey);
  const used=uses.get(name)||0;
  if(used>=total) return false;
  if(!ch.consumable_uses||typeof ch.consumable_uses!=='object') ch.consumable_uses={};
  const next=used+1;
  ch.consumable_uses[name]=next;
  if(ch.consumable_uses[name]<=0) delete ch.consumable_uses[name];
  if(ch.consumable_uses && !Object.keys(ch.consumable_uses).length) delete ch.consumable_uses;
  markDirty();
  applyDataMutation(charKey);
  return true;
}

/* --- inventory modal UI --- */
const invModal=document.getElementById('invModal');
const invTitle=document.getElementById('invTitle');
const invMeta=document.getElementById('invMeta');
const invList=document.getElementById('invList');
const invSummary=document.getElementById('invSummary');
const consModal=document.getElementById('consModal');
const consTitle=document.getElementById('consTitle');
const consMeta=document.getElementById('consMeta');
const consList=document.getElementById('consList');
const consSummary=document.getElementById('consSummary');
document.getElementById('invClose').addEventListener('click',()=>{ invModal.classList.remove('open','editing'); refreshModalState(); });
function closeConsumableModal(){
  consModal.classList.remove('open','editing');
  refreshModalState();
}
document.getElementById('consClose').addEventListener('click',closeConsumableModal);
invModal.addEventListener('click',(e)=>{ if(e.target===invModal){ invModal.classList.remove('open','editing'); refreshModalState(); } });
consModal.addEventListener('click',(e)=>{ if(e.target===consModal) closeConsumableModal(); });

function openInventoryModal(charKey, opts={}){
  const ch=DATA.characters[charKey];
  const level=currentLevelFor(charKey);
  const cap=activeSlotsFor(level);
  const {kept:keptMeta}=collectPermanentInventory(charKey);
  const keptNames=keptMeta.map(item=>item.name);
  let active=loadActive(charKey).filter(n=>keptNames.some(k=>k.toLowerCase()===n.toLowerCase()));
  let attuned=loadAttuned(charKey).filter(n=>keptNames.some(k=>k.toLowerCase()===n.toLowerCase()));
  if(active.length>cap) active=active.slice(0,cap);
  if(attuned.length>3) attuned=attuned.slice(0,3);

  invTitle.textContent=(ch.display_name||ch.sheet||'Character')+' — Permanent Items';
  invMeta.textContent=`Level ${level} • Active slots: ${cap} • Attunement max: 3`;

  const activeSet=new Set(active.map(a=>a.toLowerCase()));
  const attunedSet=new Set(attuned.map(a=>a.toLowerCase()));
  const metaByName=new Map(keptMeta.map(item=>[item.name.toLowerCase(),item]));
  const activeOrdered=active
    .map(name=>metaByName.get(name.toLowerCase()))
    .filter(Boolean)
    .sort((a,b)=>a.name.localeCompare(b.name,undefined,{sensitivity:'base'}));
  const rest=keptMeta
    .filter(item=>!activeSet.has(item.name.toLowerCase()))
    .sort((a,b)=>a.name.localeCompare(b.name,undefined,{sensitivity:'base'}));
  const ordered=activeOrdered.concat(rest);

  invList.innerHTML='';
  const actions=invModal.querySelector('.modal-actions');
  let editToggle=actions?actions.querySelector('.edit-toggle'):null;
  if(actions && !editToggle){
    editToggle=document.createElement('button');
    editToggle.type='button';
    editToggle.className='btn small edit-toggle';
    editToggle.textContent='Edit items';
    editToggle.setAttribute('aria-pressed','false');
    editToggle.style.marginRight='auto';
    actions.insertBefore(editToggle, actions.firstChild);
  }
  let editing=!!(opts && opts.editing);
  if(!ordered.length){ editing=false; }
  function syncEditing(){
    const activeEditing=editing && ordered.length>0;
    invModal.classList.toggle('editing', activeEditing);
    if(editToggle){
      editToggle.textContent=activeEditing?'Done':'Edit items';
      editToggle.setAttribute('aria-pressed', activeEditing?'true':'false');
    }
  }
  if(editToggle){
    editToggle.onclick=()=>{
      if(!ordered.length) return;
      openInventoryModal(charKey,{editing:!editing});
    };
    editToggle.style.display=ordered.length?'':'none';
  }

  ordered.forEach(item=>{
    const label=item&&item.name?item.name:String(item||'');
    const lower=label.toLowerCase();
    const isActive=activeSet.has(lower);
    const row=document.createElement('div');
    row.className='inv-row'+(isActive?' active':'');
    row.dataset.name=label;

    const nameDiv=document.createElement('div');
    nameDiv.className='inv-name';
    nameDiv.textContent=label;

    const rightDiv=document.createElement('div');
    rightDiv.className='inv-tools';
    if(isActive){
      const pill=document.createElement('span');
      pill.className='attune-pill'+(attunedSet.has(lower)?' on':'');
      pill.textContent=attunedSet.has(lower)?'Attuned':'Attune';
      pill.title='Toggle attunement (max 3)';
      pill.addEventListener('click',(ev)=>{
        if(editing) return;
        ev.stopPropagation();
        let cur=loadAttuned(charKey).filter(n=>keptNames.some(k=>k.toLowerCase()===n.toLowerCase()));
        const on=attunedSet.has(lower);
        if(!on){
          if(cur.length>=3){ alert('You can only be attuned to 3 items at a time.'); return; }
          cur.push(label);
        }else{
          cur=cur.filter(n=>n.toLowerCase()!==lower);
        }
        saveAttuned(charKey,cur);
        openInventoryModal(charKey,{editing});
      });
      rightDiv.appendChild(pill);
    }

    const deleteBtn=document.createElement('button');
    deleteBtn.type='button';
    deleteBtn.className='icon-btn danger delete-btn';
    deleteBtn.innerHTML=ICON_TRASH;
    deleteBtn.setAttribute('aria-label',`Remove ${label}`);
    deleteBtn.title='Remove this item';
    deleteBtn.addEventListener('click',(ev)=>{
      ev.stopPropagation();
      if(!window.confirm(`Remove "${label}" from permanent items?`)) return;
      const adv=item&&item.adv;
      if(adv){
        const lowerName=lower;
        const source=Array.isArray(adv.perm_items)?adv.perm_items:[];
        adv.perm_items=source.filter(raw=>{
          const parsed=parseAcquisitionName(raw);
          const cleaned=normItemName(parsed.name).toLowerCase();
          return cleaned!==lowerName;
        });
      }
      const lc=lower;
      saveActive(charKey, loadActive(charKey).filter(n=>n.toLowerCase()!==lc));
      saveAttuned(charKey, loadAttuned(charKey).filter(n=>n.toLowerCase()!==lc));
      markDirty();
      applyDataMutation(charKey);
      openInventoryModal(charKey,{editing:true});
    });
    rightDiv.appendChild(deleteBtn);

    row.appendChild(nameDiv);
    row.appendChild(rightDiv);

    row.addEventListener('click',()=>{
      if(editing) return;
      let cur=loadActive(charKey).filter(n=>keptNames.some(k=>k.toLowerCase()===n.toLowerCase()));
      const on=cur.some(n=>n.toLowerCase()===lower);
      if(!on){
        if(cur.length>=cap){ alert(`You can only have ${cap} active item${cap>1?'s':''} at level ${level}.`); return; }
        cur.push(label);
      }else{
        cur=cur.filter(n=>n.toLowerCase()!==lower);
        saveAttuned(charKey, loadAttuned(charKey).filter(n=>n.toLowerCase()!==lower));
      }
      saveActive(charKey,cur);
      openInventoryModal(charKey,{editing});
    });

    invList.appendChild(row);
  });

  syncEditing();

  function updateSummary(){
    const aCount=loadActive(charKey).length;
    const tCount=loadAttuned(charKey).length;
    invSummary.textContent=`Kept: ${keptMeta.length} • Active: ${aCount}/${cap} • Attuned: ${tCount}/3`;
  }
  updateSummary();
  invModal.classList.add('open');
  refreshModalState();
}


function openConsumableModal(charKey){
  const ch=DATA.characters[charKey];
  const level=currentLevelFor(charKey);
  const carryCap=consumableCarrySlotsFor(level);
  let baseCounts=deriveConsumableInventory(charKey);
  let counts=buildConsumableInventory(charKey);
  const reloadData=()=>{
    baseCounts=deriveConsumableInventory(charKey);
    counts=buildConsumableInventory(charKey);
  };
  const hasBaseInventory=()=>Array.from(baseCounts.values()).some(val=>val>0);

  consTitle.textContent=(ch.display_name||ch.sheet||'Character')+' — Consumables';
  consMeta.textContent=`Level ${level} • Carry limit: ${carryCap}`;
  consList.innerHTML='';

  let lastBaseSummary='';
  let summaryNote='';
  const applySummary=()=>{
    if(summaryNote){
      if(lastBaseSummary) consSummary.textContent=`${lastBaseSummary} • ${summaryNote}`;
      else consSummary.textContent=summaryNote;
    }else{
      consSummary.textContent=lastBaseSummary;
    }
  };
  const setSummaryNote=(msg)=>{
    summaryNote=msg||'';
    applySummary();
  };
  setSummaryNote('');

  const state={carriedList:[],carriedCounts:new Map()};
  const rawCarried=loadCarriedConsumables(charKey);
  rawCarried.forEach(item=>{
    const name=String(item||'').trim();
    if(name) state.carriedList.push(name);
  });

  const sanitizeCarried=()=>{
    const next=[];
    const usage=new Map();
    let changed=false;
    state.carriedList.forEach(name=>{
      if(!counts.has(name)){
        changed=true;
        return;
      }
      const total=counts.get(name)||0;
      const current=usage.get(name)||0;
      if(current>=total){
        changed=true;
        return;
      }
      usage.set(name,current+1);
      next.push(name);
    });
    if(changed || next.length!==state.carriedList.length){
      saveCarriedConsumables(charKey,next);
    }
    state.carriedList=next;
    state.carriedCounts=usage;
  };

  const totalCarried=()=>state.carriedList.length;
  const slotsFree=()=>Math.max(0,carryCap-totalCarried());
  const totalInventoryCopies=()=>Array.from(counts.values()).reduce((sum,val)=>sum+val,0);
  const totalStowedCopies=()=>Array.from(counts.entries()).reduce((sum,[name,total])=>{
    const carried=state.carriedCounts.get(name)||0;
    return sum+Math.max(0,total-carried);
  },0);

  const buildNameDiv=(name)=>{
    const nameDiv=document.createElement('div');
    nameDiv.className='inv-name consumable-name';
    const {label:displayLabel,chips}=formatConsumableDisplay(name);
    const primary=document.createElement('div');
    primary.className='cons-primary';
    const labelSpan=document.createElement('span');
    labelSpan.className='cons-name';
    labelSpan.textContent=displayLabel||name;
    primary.appendChild(labelSpan);
    if(Array.isArray(chips) && chips.length){
      const chipWrap=document.createElement('span');
      chipWrap.className='cons-chips';
      chips.forEach(chip=>{
        const chipEl=document.createElement('span');
        chipEl.className='cons-chip';
        const slug=chip.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
        if(slug){ chipEl.classList.add(`cons-chip--${slug}`); }
        chipEl.textContent=chip;
        chipWrap.appendChild(chipEl);
      });
      primary.appendChild(chipWrap);
    }
    nameDiv.appendChild(primary);
    return {element:nameDiv,label:labelSpan.textContent};
  };

  const createSection=(title)=>{
    const section=document.createElement('section');
    section.className='cons-section';
    const heading=document.createElement('div');
    heading.className='cons-section-title';
    heading.textContent=title;
    const list=document.createElement('div');
    list.className='cons-sublist';
    section.appendChild(heading);
    section.appendChild(list);
    return {section,list};
  };

  const addCarry=(name,{toFront=true}={})=>{
    const total=counts.get(name)||0;
    const carried=state.carriedCounts.get(name)||0;
    if(total<=carried) return false;
    if(totalCarried()>=carryCap){
      window.alert(`You can only carry ${carryCap} consumable${carryCap===1?'':'s'} at level ${level}.`);
      return false;
    }
    if(toFront) state.carriedList.unshift(name);
    else state.carriedList.push(name);
    saveCarriedConsumables(charKey,state.carriedList);
    setSummaryNote('');
    renderView();
    return true;
  };

  const removeCarry=(name)=>{
    const idx=state.carriedList.indexOf(name);
    if(idx===-1) return false;
    state.carriedList.splice(idx,1);
    saveCarriedConsumables(charKey,state.carriedList);
    setSummaryNote('');
    renderView();
    return true;
  };

  const renderView=()=>{
    reloadData();
    sanitizeCarried();
    consList.innerHTML='';

    if(!hasBaseInventory()){
      lastBaseSummary='No consumables tracked yet.';
      applySummary();
      const empty=document.createElement('div');
      empty.className='muted';
      empty.textContent='No consumables tracked yet.';
      consList.appendChild(empty);
      return;
    }

    const inventoryTotal=totalInventoryCopies();
    if(inventoryTotal<=0){
      lastBaseSummary='No consumables remaining.';
      applySummary();
      const empty=document.createElement('div');
      empty.className='muted';
      empty.textContent='All consumables have been used.';
      consList.appendChild(empty);
      return;
    }

    const carriedTotal=totalCarried();
    const free=slotsFree();
    const stowed=totalStowedCopies();
    const summaryParts=[`Carried: ${carriedTotal}/${carryCap}`];
    summaryParts.push(free>0?`${free} slot${free===1?'':'s'} free`:'Carry limit reached');
    summaryParts.push(`${inventoryTotal} total remaining`);
    if(stowed>0) summaryParts.push(`${stowed} stowed`);
    lastBaseSummary=summaryParts.join(' • ');
    applySummary();

    const carriedSection=createSection('Carried');
    const carriedOrdered=[];
    const seen=new Set();
    state.carriedList.forEach(name=>{ if(!seen.has(name)){ seen.add(name); carriedOrdered.push(name); } });
    carriedOrdered.sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));
    if(carriedOrdered.length){
      carriedOrdered.forEach(name=>{
        const total=counts.get(name)||0;
        const carried=state.carriedCounts.get(name)||0;
        const remaining=Math.max(0,total-carried);
        const row=document.createElement('div');
        row.className='inv-row active';
        row.style.cursor='default';
        row.dataset.name=name;
        const {element:nameDiv,label:displayLabel}=buildNameDiv(name);
        const secondary=document.createElement('span');
        secondary.className='cons-secondary';
        secondary.textContent=`Carried ${carried} of ${total}`+(remaining>0?` • ${remaining} stowed`:'');
        nameDiv.appendChild(secondary);
        row.appendChild(nameDiv);

        const tools=document.createElement('div');
        tools.className='inv-tools';

        const qtyDiv=document.createElement('div');
        qtyDiv.className='qty';

        const minus=document.createElement('span');
        minus.className='qty-icon'+(carried<=0?' disabled':'');
        minus.innerHTML=ICON_MINUS;
        minus.setAttribute('role','button');
        minus.setAttribute('aria-label',`Stow one ${name}`);
        minus.tabIndex=0;
        minus.setAttribute('aria-disabled',carried<=0?'true':'false');

        const pill=document.createElement('span');
        pill.className='qty-pill';
        pill.textContent=String(carried);

        const plus=document.createElement('span');
        const canIncrease=remaining>0 && free>0;
        plus.className='qty-icon'+(canIncrease?'':' disabled');
        plus.innerHTML=ICON_PLUS;
        plus.setAttribute('role','button');
        plus.setAttribute('aria-label',`Carry one more ${name}`);
        plus.tabIndex=0;
        plus.setAttribute('aria-disabled',canIncrease?'false':'true');

        const handleAdjust=(delta)=>(ev)=>{
          if(ev.type==='keydown' && ev.key!=='Enter' && ev.key!==' ' && ev.key!=='Spacebar'){ return; }
          ev.preventDefault();
          ev.stopPropagation();
          if(delta<0){
            if(carried>0) removeCarry(name);
          }else{
            addCarry(name,{toFront:false});
          }
        };

        minus.addEventListener('click',handleAdjust(-1));
        minus.addEventListener('keydown',handleAdjust(-1));
        plus.addEventListener('click',handleAdjust(1));
        plus.addEventListener('keydown',handleAdjust(1));

        qtyDiv.appendChild(minus);
        qtyDiv.appendChild(pill);
        qtyDiv.appendChild(plus);
        tools.appendChild(qtyDiv);

        const useBtn=document.createElement('button');
        useBtn.type='button';
        useBtn.className='btn small danger cons-use-btn';
        useBtn.textContent='Use';
        useBtn.disabled=total<=0;
        const handleUse=(ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          const success=incrementConsumableUse(charKey,name);
          if(!success){
            window.alert(`No ${displayLabel} remaining to use.`);
            return;
          }
          const idx=state.carriedList.indexOf(name);
          if(idx!==-1){
            state.carriedList.splice(idx,1);
            saveCarriedConsumables(charKey,state.carriedList);
          }
          setSummaryNote(`Used one ${displayLabel}. Remember to save data.js.`);
          renderView();
        };
        useBtn.addEventListener('click',handleUse);
        tools.appendChild(useBtn);

        row.appendChild(tools);
        carriedSection.list.appendChild(row);
      });
    }else{
      const empty=document.createElement('div');
      empty.className='muted';
      empty.style.padding='4px 8px';
      empty.textContent='Not carrying any consumables.';
      carriedSection.list.appendChild(empty);
    }
    consList.appendChild(carriedSection.section);

    const availableSection=createSection('Stowed');
    const availableNames=Array.from(counts.keys()).filter(name=>{
      const total=counts.get(name)||0;
      const carried=state.carriedCounts.get(name)||0;
      return total-carried>0;
    }).sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));
    if(availableNames.length){
      availableNames.forEach(name=>{
        const total=counts.get(name)||0;
        const carried=state.carriedCounts.get(name)||0;
        const remaining=Math.max(0,total-carried);
        const row=document.createElement('div');
        row.className='inv-row';
        row.setAttribute('role','button');
        row.tabIndex=0;
        row.title='Click to carry one copy';
        const {element:nameDiv}=buildNameDiv(name);
        const secondary=document.createElement('span');
        secondary.className='cons-secondary';
        secondary.textContent=`${remaining} available${total!==remaining?` • ${total} total`:''}`;
        nameDiv.appendChild(secondary);
        row.appendChild(nameDiv);

        const tools=document.createElement('div');
        tools.className='inv-tools';
        const qtyDiv=document.createElement('div');
        qtyDiv.className='qty';
        const pill=document.createElement('span');
        pill.className='qty-pill';
        pill.textContent=String(remaining);
        qtyDiv.appendChild(pill);
        tools.appendChild(qtyDiv);
        row.appendChild(tools);

        const activate=(ev)=>{
          if(ev.type==='keydown' && ev.key!=='Enter' && ev.key!==' ' && ev.key!=='Spacebar'){ return; }
          ev.preventDefault();
          ev.stopPropagation();
          addCarry(name,{toFront:true});
        };
        row.addEventListener('click',activate);
        row.addEventListener('keydown',activate);
        availableSection.list.appendChild(row);
      });
    }else{
      const empty=document.createElement('div');
      empty.className='muted';
      empty.style.padding='4px 8px';
      empty.textContent='No consumables stowed.';
      availableSection.list.appendChild(empty);
    }
    consList.appendChild(availableSection.section);
  };

  renderView();
  consModal.classList.add('open');
  refreshModalState();
}

/* --- cards --- */
function makeCard(a,idx){
  const act=isActivityEntry(a); const {gp,dtd}=netVals(a);
  const card=document.createElement('article'); card.className='card'+(act?' activity':''); card.dataset.idx=String(idx);
  card.__dataRef=a;
  const lockedKind=(a && a.__lockedKind)?String(a.__lockedKind):'';
  const hasLockedKind=!!lockedKind;
  const dmLinkMeta=(DM_REWARD_LINKS && DM_REWARD_LINKS.get(a))||null;

  const hd=document.createElement('div'); hd.className='card-hd';
  const main=document.createElement('div'); main.className='log-row';
  const info=document.createElement('div'); info.className='log-row-info';
  let titleEditorSlot=null, titleDisplayEl=null;
  let dateEditorSlot=null, dateDisplayEl=null;
  let codeEditorSlot=null, codeDisplayEl=null;
  let codeFieldView=null;
  let metaDisplayEl=null;

  const dateSpan=document.createElement('span'); dateSpan.className='log-row-date editable-inline';
  const dateDisplay=document.createElement('span'); dateDisplay.className='display'; dateDisplay.textContent=fmtDate(a.date);
  const dateEditor=document.createElement('span'); dateEditor.className='editor';
  dateSpan.append(dateDisplay,dateEditor); dateSpan.__display=dateDisplay; dateSpan.__editor=dateEditor;
  dateEditorSlot=dateEditor; dateDisplayEl=dateDisplay;

  const nameSpan=document.createElement('span'); nameSpan.className='log-row-title editable-inline '+(act?'is-activity':'is-adventure');
  const nameDisplay=document.createElement('span'); nameDisplay.className='display';
  const fullTitle=sanitizeTitle((a.title&&a.title.trim())||(act?'Activity':'Untitled Adventure'));
  nameDisplay.textContent=fullTitle;
  const nameEditor=document.createElement('span'); nameEditor.className='editor';
  nameSpan.append(nameDisplay,nameEditor); nameSpan.__display=nameDisplay; nameSpan.__editor=nameEditor;
  titleEditorSlot=nameEditor; titleDisplayEl=nameDisplay;

  const buildHeaderMeta=(entry)=>{
    if(!entry) return '';
    const parts=[];
    const dateText=fmtDate(entry.date);
    if(dateText && dateText!=='—') parts.push(dateText);
    const codeText=normalizeDisplayValue(entry.code);
    if(codeText) parts.push(`${codeText}`);
    const dmText=normalizeDisplayValue(entry.dm);
    if(dmText) parts.push(`DM: ${dmText}`);
    if(isActivityEntry(entry)) parts.push('Downtime activity');
    return parts.join('     •     ');
  };

  const metaSpan=document.createElement('span');
  metaSpan.className='log-row-meta';
  metaDisplayEl=metaSpan;

  info.appendChild(nameSpan);
  info.appendChild(metaSpan);
  info.appendChild(dateSpan);
  main.appendChild(info);

  metaSpan.textContent=buildHeaderMeta(a);

  const chips=document.createElement('div'); chips.className='chips log-row-chips';
  const createSlot=(className)=>{
    const slot=document.createElement('div');
    slot.className=`chip-slot ${className} chip-slot-empty`;
    slot.setAttribute('aria-hidden','true');
    return slot;
  };
  const levelSlot=createSlot('chip-slot-level');
  const gpSlot=createSlot('chip-slot-gp');
  const dtSlot=createSlot('chip-slot-dtd');
  chips.append(levelSlot,gpSlot,dtSlot);
  let hasChip=false;
  let chipCount=0;
  const placeChip=(slot,pillEl)=>{
    if(!slot||!pillEl) return;
    slot.innerHTML='';
    slot.appendChild(pillEl);
    slot.classList.remove('chip-slot-empty');
    slot.removeAttribute('aria-hidden');
    hasChip=true;
    chipCount++;
  };
  const applyValueStyle=(pillEl,value)=>{
    if(!pillEl) return;
    pillEl.classList.remove('gain','loss','neutral');
    if(value>0) pillEl.classList.add('gain');
    else if(value<0) pillEl.classList.add('loss');
    else pillEl.classList.add('neutral');
  };
  const levelStart=entryLevelAtStart(a);
  if(Number.isFinite(levelStart) && levelStart>0){
    const levelPill=pill('Level '+fmtNumber(levelStart));
    levelPill.classList.add('pill-level');
    const levelGain=Number(a.level_plus);
    if(Number.isFinite(levelGain) && levelGain>0){
      levelPill.classList.add('pill-level-gain');
    }
    placeChip(levelSlot,levelPill);
  }
  if(act){
    if(gp){
      const gpPill=pill('GP '+fmtSigned(gp));
      gpPill.classList.add('pill-gp');
      applyValueStyle(gpPill,gp);
      placeChip(gpSlot,gpPill);
    }
    if(dtd){
      const dtPill=pill('DTD '+fmtSigned(dtd));
      dtPill.classList.add('pill-dtd');
      applyValueStyle(dtPill,dtd);
      placeChip(dtSlot,dtPill);
    }
  }else{
    const netGP=(a.gp_net==null?gp:a.gp_net);
    const gpValue=Number(netGP);
    const gpPill=pill('GP '+fmtSigned(gpValue));
    gpPill.classList.add('pill-gp');
    applyValueStyle(gpPill,gpValue);
    placeChip(gpSlot,gpPill);
    const netDTD=(a.dtd_net==null?dtd:a.dtd_net);
    const dtValue=Number(netDTD);
    if(dtValue){
      const dtPill=pill('DTD '+fmtSigned(dtValue));
      dtPill.classList.add('pill-dtd');
      applyValueStyle(dtPill,dtValue);
      placeChip(dtSlot,dtPill);
    }
  }
  if(hasChip){
    main.appendChild(chips);
  }
  if(chipCount>3){
    const shortened=shortenTitleForCrowdedChips(fullTitle, chipCount);
    if(shortened && shortened!==fullTitle){
      nameDisplay.textContent=shortened;
      nameDisplay.setAttribute('title', fullTitle);
    }else{
      nameDisplay.textContent=fullTitle;
      nameDisplay.removeAttribute('title');
    }
  }else{
    nameDisplay.textContent=fullTitle;
    nameDisplay.removeAttribute('title');
  }
  hd.appendChild(main);

  const refreshScrollState=(wrapper)=>{
    if(!wrapper||!wrapper.__display) return;
    const displayEl=wrapper.__display;
    const distance=Math.max(0,displayEl.scrollWidth-displayEl.clientWidth);
    if(distance>1){
      const duration=Math.min(24,Math.max(7,distance/32+6));
      const delay=Math.min(2.5,Math.max(0.8,duration/4));
      displayEl.style.setProperty('--scroll-distance',distance+'px');
      displayEl.style.setProperty('--scroll-duration',duration+'s');
      displayEl.style.setProperty('--scroll-delay',delay+'s');
      wrapper.classList.add('scrollable');
    }else{
      displayEl.style.removeProperty('--scroll-distance');
      displayEl.style.removeProperty('--scroll-duration');
      displayEl.style.removeProperty('--scroll-delay');
      wrapper.classList.remove('scrollable');
    }
  };
  const bindScrollObserver=(wrapper)=>{
    if(!wrapper) return;
    const trigger=()=>refreshScrollState(wrapper);
    wrapper.__refreshScroll=trigger;
    scrollableTitleRegistry.register(wrapper);
    wrapper.addEventListener('pointerenter',trigger);
    wrapper.addEventListener('pointerdown',trigger);
    wrapper.addEventListener('focus',trigger);
    if(typeof ResizeObserver!=='undefined'){
      if(wrapper.__resizeObserver){
        try{ wrapper.__resizeObserver.disconnect(); }catch(err){ /* no-op */ }
      }
      const observer=new ResizeObserver(()=>{
        scrollableTitleRegistry.schedule();
      });
      observer.observe(wrapper);
      if(wrapper.__display){ observer.observe(wrapper.__display); }
      wrapper.__resizeObserver=observer;
    }
  };
  bindScrollObserver(nameSpan);
  requestAnimationFrame(()=>refreshScrollState(nameSpan));

  const tools=document.createElement('div'); tools.className='card-tools';
  const editBtn=document.createElement('button');
  editBtn.type='button';
  editBtn.className='icon-btn';
  editBtn.setAttribute('aria-label','Toggle edit mode');
  editBtn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.1 5.1 5 12.2V19h6.8l7.1-7.1-6.8-6.8Z"/><path d="M3 21h18"/></svg>';
  editBtn.title='Edit entry';
  editBtn.addEventListener('click',(ev)=>{
    ev.stopPropagation();
    if(card.classList.contains('editing')){
      exitEditMode(card);
    }else{
      enterEditMode(card);
    }
  });
  tools.appendChild(editBtn);
  hd.appendChild(tools);

  hd.addEventListener('click',(ev)=>{ if(card.classList.contains('editing')) return; toggleCard(card); });

  const bd=document.createElement('div'); bd.className='card-bd';
  const view=document.createElement('div'); view.className='bd-in';
  view.innerHTML='';

  if(dmLinkMeta && dmLinkMeta.entry){
    const linkRow=document.createElement('div');
    linkRow.className='card-link-chip-row';
    const linkChip=document.createElement('button');
    linkChip.type='button';
    linkChip.className='pill pill-link card-link-chip';
    const label='View linked DM log allocation';
    linkChip.textContent=label;
    linkChip.title=label;
    linkChip.setAttribute('aria-label',label);
    linkChip.addEventListener('click',(ev)=>{
      ev.stopPropagation();
      ev.preventDefault();
      navigateToDmAllocation(dmLinkMeta.entry);
    });
    linkRow.appendChild(linkChip);
    view.appendChild(linkRow);
  }

  function makeValue(val, empty='—'){
    const text=normalizeDisplayValue(val);
    return text?text:empty;
  }

  function makeKVS(label,value){
    const cell=document.createElement('div');
    cell.className='kvsingle';
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v';
    const display=document.createElement('div'); display.className='display'; display.textContent=value;
    const editor=document.createElement('div'); editor.className='editor';
    v.appendChild(display); v.appendChild(editor);
    cell.appendChild(k); cell.appendChild(v);
    cell.__display=display;
    cell.__editor=editor;
    return cell;
  }

  function appendField(label, content, extraClass){
    const field=document.createElement('div');
    field.className='field'+(extraClass?(' '+extraClass):'');
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v';
    const display=document.createElement('div'); display.className='display';
    if(content instanceof Node){ display.appendChild(content); }
    else{ display.textContent=makeValue(content); }
    const editor=document.createElement('div'); editor.className='editor';
    v.appendChild(display); v.appendChild(editor);
    field.appendChild(k); field.appendChild(v);
    view.appendChild(field);
    field.__display=display;
    field.__editor=editor;
    return field;
  }

  const gpRowView=document.createElement('div'); gpRowView.className='kv2';
  const gpEarn=Number(a.gp_plus??0);
  const gpEarnCell=makeKVS('Gold earned', fmtNumber(gpEarn)); gpRowView.appendChild(gpEarnCell);
  const gpSpend=Number(a.gp_minus??0);
  const gpSpendCell=makeKVS('Gold spent', fmtNumber(gpSpend)); gpRowView.appendChild(gpSpendCell);
  const showGpEarn=(!act || gpEarn!==0);
  const showGpSpend=(!act || gpSpend!==0);
  gpEarnCell.style.display=showGpEarn?'':'none';
  gpSpendCell.style.display=showGpSpend?'':'none';
  if(!(showGpEarn||showGpSpend)){ gpRowView.style.display='none'; }
  view.appendChild(gpRowView);

  const dtRowView=document.createElement('div'); dtRowView.className='kv2';
  const dtEarnVal=Number(a.dtd_plus??0);
  const dtEarnCell=makeKVS('Downtime earned', fmtNumber(dtEarnVal)); dtRowView.appendChild(dtEarnCell);
  const dtSpendVal=Number(a.dtd_minus??0);
  const dtSpendCell=makeKVS('Downtime spent', fmtNumber(dtSpendVal)); dtRowView.appendChild(dtSpendCell);
  const showDtEarn=(!act || dtEarnVal!==0);
  const showDtSpend=(!act || dtSpendVal!==0);
  dtEarnCell.style.display=showDtEarn?'':'none';
  dtSpendCell.style.display=showDtSpend?'':'none';
  if(!(showDtEarn||showDtSpend)){ dtRowView.style.display='none'; }
  view.appendChild(dtRowView);

  const lvlVal=Number(a.level_plus||0);
  const levelField=makeKVS('Levels gained', fmtNumber(lvlVal));
  const showLevel=(!act && lvlVal) || (act && lvlVal!==0);
  if(!showLevel){ levelField.style.display='none'; }
  view.appendChild(levelField);

  const hasTradeMeta = act && (('itemTraded' in a) || ('itemReceived' in a));
  const dmDisplay=normalizeDisplayValue(a.dm);
  const playerRaw=normalizeDisplayValue(a.player);
  const characterDisplay=normalizeDisplayValue(a.character);
  const tradePlayer=hasTradeMeta?(playerRaw||dmDisplay):playerRaw;
  const usedDmAsPlayer=hasTradeMeta && !playerRaw && !!dmDisplay && tradePlayer===dmDisplay;

  const kindField=appendField('Entry type', act?'Downtime Activity':'Adventure');
  kindField.classList.add('show-when-editing');
  kindField.style.display='none';

  codeFieldView=document.createElement('div');
  codeFieldView.className='field inline-field show-when-editing log-row-code';
  const codeLabel=document.createElement('div'); codeLabel.className='k'; codeLabel.textContent='Adventure code';
  const codeValue=document.createElement('div'); codeValue.className='v';
  const codeDisplay=document.createElement('div'); codeDisplay.className='display'; codeDisplay.textContent=makeValue(a.code||'');
  const codeEditor=document.createElement('div'); codeEditor.className='editor';
  codeValue.appendChild(codeDisplay);
  codeValue.appendChild(codeEditor);
  codeFieldView.appendChild(codeLabel);
  codeFieldView.appendChild(codeValue);
  info.appendChild(codeFieldView);
  codeFieldView.__display=codeDisplay;
  codeFieldView.__editor=codeEditor;
  codeEditorSlot=codeEditor;
  codeDisplayEl=codeDisplay;
  if(!(a.code||'').trim()){ codeFieldView.style.display='none'; }

  const dmField=makeKVS('DM', dmDisplay||'—');
  const showDM=!act || (dmDisplay && !usedDmAsPlayer);
  if(!showDM){ dmField.style.display='none'; }
  view.appendChild(dmField);

  if(hasTradeMeta){
    const tradedAway=normalizeDisplayValue(a.itemTraded);
    const received=normalizeDisplayValue(a.itemReceived);
    if(tradedAway){ appendField('Item traded away', tradedAway); }
    if(received){ appendField('Item received', received); }
    if(tradePlayer || characterDisplay){
      const metaRow=document.createElement('div');
      metaRow.className='kv2';
      if(tradePlayer){ metaRow.appendChild(makeKVS('Player', tradePlayer)); }
      if(characterDisplay){ metaRow.appendChild(makeKVS('Character', characterDisplay)); }
      if(metaRow.children.length){ view.appendChild(metaRow); }
    }
  }

  let tradedItemField=null;
  if(!hasTradeMeta && act && !a.__isNew){
    const tradedItem=normalizeDisplayValue(a.traded_item);
    tradedItemField=appendField('Item traded away', tradedItem);
    if(!tradedItem){ tradedItemField.style.display='none'; }
  }

  const hasPermItems=Array.isArray(a.perm_items)&&a.perm_items.some(item=>hasMeaningfulValue(item));
  const permField=appendField('Magic items gained', listBox(a.perm_items),'mi');
  const showPerm=(!act || (!hasTradeMeta && hasPermItems));
  if(!showPerm){ permField.style.display='none'; }
  const lostValueList=parseLostItemList(a.lost_perm_item);
  const lostField=appendField('Magic items lost', listBox(lostValueList));
  lostField.classList.add('milost');
  if(!lostValueList.length){ lostField.style.display='none'; }
  const hasConsumables=Array.isArray(a.consumable_items)&&a.consumable_items.some(item=>hasMeaningfulValue(item));
  const consField=appendField('Consumables', listBox(a.consumable_items),'cons');
  const showCons=(!act || hasConsumables);
  if(!showCons){ consField.style.display='none'; }
  const noteText=normalizeDisplayValue(a.notes);
  const notesBox=document.createElement('div');
  notesBox.className='notesbox';
  notesBox.textContent=noteText||'—';
  const notesField=appendField('Notes', notesBox);
  const showNotes=(!hasTradeMeta && (!act || noteText));
  if(!showNotes){ notesField.style.display='none'; }

  const formWrap=document.createElement('div'); formWrap.className='edit-form';
  const form=document.createElement('form');
  form.addEventListener('submit',async(ev)=>{ ev.preventDefault(); await saveCardChanges(card); });
  formWrap.appendChild(form);

  const controls={};
  function addField(label, element){
    const field=document.createElement('div'); field.className='field';
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v'; v.appendChild(element);
    field.appendChild(k); field.appendChild(v);
    form.appendChild(field);
    return element;
  }
  function makeInput(type){ const input=document.createElement('input'); input.type=type; if(type==='number'){ input.step='any'; } return input; }
  function makeTextarea(){ const t=document.createElement('textarea'); return t; }

  controls.title=addField('Title', makeInput('text'));
  controls.date=addField('Date', makeInput('date'));
  controls.code=addField('Adventure code', makeInput('text'));
  controls.dm=addField('DM', makeInput('text'));
  function makeKindSelect(){
    const select=document.createElement('select');
    const options=[
      {value:'adventure',label:'Adventure'},
      {value:'Downtime Activity',label:'Downtime Activity'}
    ];
    options.forEach(opt=>{ const o=document.createElement('option'); o.value=opt.value; o.textContent=opt.label; select.appendChild(o); });
    return select;
  }
  controls.kind=addField('Kind', makeKindSelect());
  if(hasLockedKind){
    controls.kind.value=lockedKind;
    controls.kind.disabled=true;
    const kindFieldEl=controls.kind.closest('.field');
    if(kindFieldEl){
      kindFieldEl.style.display='none';
    }
  }
  controls.traded_item=addField('Item traded away', makeInput('text'));

  const gpRowForm=document.createElement('div'); gpRowForm.className='kv2';
  const gpEarnField=document.createElement('div'); gpEarnField.className='kvsingle';
  gpEarnField.innerHTML='<div class="k">Gold earned</div>';
  controls.gp_plus=makeInput('number');
  const gpEarnWrap=document.createElement('div'); gpEarnWrap.className='v'; gpEarnWrap.appendChild(controls.gp_plus); gpEarnField.appendChild(gpEarnWrap);

  const gpSpendField=document.createElement('div'); gpSpendField.className='kvsingle';
  gpSpendField.innerHTML='<div class="k">Gold spent</div>';
  controls.gp_minus=makeInput('number');
  const gpSpendWrap=document.createElement('div'); gpSpendWrap.className='v'; gpSpendWrap.appendChild(controls.gp_minus); gpSpendField.appendChild(gpSpendWrap);

  gpRowForm.appendChild(gpEarnField); gpRowForm.appendChild(gpSpendField); form.appendChild(gpRowForm);

  const dtRowForm=document.createElement('div'); dtRowForm.className='kv2';
  const dtEarnField=document.createElement('div'); dtEarnField.className='kvsingle';
  dtEarnField.innerHTML='<div class="k">Downtime earned</div>';
  controls.dtd_plus=makeInput('number');
  const dtEarnWrap=document.createElement('div'); dtEarnWrap.className='v'; dtEarnWrap.appendChild(controls.dtd_plus); dtEarnField.appendChild(dtEarnWrap);
  const dtSpendField=document.createElement('div'); dtSpendField.className='kvsingle';
  dtSpendField.innerHTML='<div class="k">Downtime spent</div>';
  controls.dtd_minus=makeInput('number');
  const dtSpendWrap=document.createElement('div'); dtSpendWrap.className='v'; dtSpendWrap.appendChild(controls.dtd_minus); dtSpendField.appendChild(dtSpendWrap);
  dtRowForm.appendChild(dtEarnField); dtRowForm.appendChild(dtSpendField); form.appendChild(dtRowForm);

  controls.level_plus=addField('Levels gained', makeInput('number'));

  let tradeField=controls.traded_item.closest('.field');
  function syncKindVisibility(){
    const isActivity=controls.kind.value!=='adventure';
    if(tradeField){ tradeField.style.display=isActivity?'':'none'; }
  }
  controls.kind.addEventListener('change', syncKindVisibility);
  syncKindVisibility();

  function createListEditor(items){
    const wrap=document.createElement('div'); wrap.className='list-editor';
    const list=document.createElement('div'); list.className='list'; wrap.appendChild(list);
    function addRow(val){
      const row=document.createElement('div'); row.className='list-row';
      const input=document.createElement('input'); input.type='text'; input.value=val||'';
      const btn=document.createElement('button'); btn.type='button'; btn.innerHTML=ICON_TRASH; btn.setAttribute('aria-label','Remove item');
      btn.addEventListener('click',()=>row.remove());
      row.appendChild(input); row.appendChild(btn); list.appendChild(row);
    }
    (items||[]).forEach(item=>addRow(item));
    const addBtn=document.createElement('button'); addBtn.type='button'; addBtn.className='add-row'; addBtn.textContent='Add item';
    addBtn.addEventListener('click',()=>addRow(''));
    wrap.appendChild(addBtn);
    wrap.getValues=()=>Array.from(list.querySelectorAll('input')).map(el=>el.value.trim()).filter(Boolean);
    wrap.setValues=(vals)=>{ list.innerHTML=''; (vals||[]).forEach(item=>addRow(item)); };
    return wrap;
  }

  controls.perm_items=createListEditor(a.perm_items||[]);
  addField('Magic items gained', controls.perm_items);
  function createLostItemEditor(items){
    const wrap=document.createElement('div');
    wrap.className='list-editor lost-item-editor';
    const list=document.createElement('div');
    list.className='list';
    wrap.appendChild(list);
    wrap.__selects=[];

    function availableNames(){
      const key=(a && a.__charKey)||charSel.value;
      const names=[];
      if(key && DATA && DATA.characters && DATA.characters[key]){
        const {kept}=collectPermanentInventory(key);
        kept.forEach(meta=>{
          const name=meta && meta.name?normItemName(meta.name):'';
          if(name) names.push(name);
        });
      }
      return names;
    }

    function refreshOptions(){
      const baseNames=availableNames();
      const currentValues=wrap.__selects.map(sel=>normItemName(sel.value)).filter(Boolean);
      const uniqueMap=new Map();
      [...baseNames,...currentValues].forEach(name=>{
        const cleaned=normItemName(name);
        if(!cleaned) return;
        const key=cleaned.toLowerCase();
        if(uniqueMap.has(key)) return;
        uniqueMap.set(key,cleaned);
      });
      const options=[...uniqueMap.values()].sort((lhs,rhs)=>lhs.localeCompare(rhs,'en',{sensitivity:'base'}));
      wrap.__selects.forEach(select=>{
        const prev=normItemName(select.value);
        select.innerHTML='';
        const placeholder=document.createElement('option');
        placeholder.value='';
        placeholder.textContent='Select item';
        placeholder.disabled=true;
        placeholder.selected=!prev;
        select.appendChild(placeholder);
        options.forEach(name=>{
          const opt=document.createElement('option');
          opt.value=name;
          opt.textContent=name;
          select.appendChild(opt);
        });
        if(prev){
          const normalizedPrev=prev.toLowerCase();
          const match=options.find(name=>name.toLowerCase()===normalizedPrev);
          if(match){
            select.value=match;
          }else{
            const custom=document.createElement('option');
            custom.value=prev;
            custom.textContent=prev;
            select.appendChild(custom);
            select.value=prev;
          }
        }
      });
    }

    function addRow(value){
      const row=document.createElement('div');
      row.className='list-row';
      const select=document.createElement('select');
      wrap.__selects.push(select);
      select.addEventListener('change',()=>{
        wrap.dispatchEvent(new Event('input',{bubbles:true}));
      });
      row.appendChild(select);
      const btn=document.createElement('button');
      btn.type='button';
      btn.innerHTML=ICON_TRASH;
      btn.setAttribute('aria-label','Remove item');
      btn.addEventListener('click',()=>{
        const idx=wrap.__selects.indexOf(select);
        if(idx>=0){ wrap.__selects.splice(idx,1); }
        row.remove();
        refreshOptions();
        wrap.dispatchEvent(new Event('input',{bubbles:true}));
      });
      row.appendChild(btn);
      list.appendChild(row);
      refreshOptions();
      const val=normItemName(value);
      if(val){
        const normalized=val.toLowerCase();
        const optionMatch=Array.from(select.options).find(opt=>normItemName(opt.value).toLowerCase()===normalized);
        if(optionMatch){
          select.value=optionMatch.value;
        }else{
          const opt=document.createElement('option');
          opt.value=val;
          opt.textContent=val;
          select.appendChild(opt);
          select.value=val;
        }
      }
      return select;
    }

    const setValues=(vals)=>{
      list.innerHTML='';
      wrap.__selects=[];
      const arr=Array.isArray(vals)?vals:parseLostItemList(vals);
      const seen=new Set();
      arr.forEach(item=>{
        const cleaned=normItemName(item);
        if(!cleaned) return;
        const key=cleaned.toLowerCase();
        if(seen.has(key)) return;
        seen.add(key);
        addRow(cleaned);
      });
      refreshOptions();
    };

    wrap.setValues=setValues;
    wrap.getValues=()=>wrap.__selects.map(sel=>normItemName(sel.value)).filter(Boolean);
    Object.defineProperty(wrap,'value',{
      get(){
        return wrap.getValues().join('\n');
      },
      set(val){ setValues(val); }
    });

    const addBtn=document.createElement('button');
    addBtn.type='button';
    addBtn.className='add-row';
    addBtn.textContent='Add item';
    addBtn.addEventListener('click',()=>{
      const select=addRow('');
      select.focus();
    });
    wrap.appendChild(addBtn);

    if(items && items.length){
      setValues(items);
    }else{
      refreshOptions();
    }

    wrap.focus=()=>{
      const target=wrap.__selects[0];
      if(target){
        target.focus();
      }else{
        addBtn.focus();
      }
    };

    wrap.refreshOptions=refreshOptions;
    return wrap;
  }
  controls.lost_perm_item=addField('Magic items lost', createLostItemEditor(lostValueList));
  controls.consumable_items=createListEditor(a.consumable_items||[]);
  addField('Consumables', controls.consumable_items);
  controls.notes=addField('Notes', makeTextarea());
  if(controls.notes){
    controls.notes.rows=8;
    const notesControlField=controls.notes.closest('.field');
    if(notesControlField){
      notesControlField.classList.add('full');
    }
  }

  form.querySelectorAll('.field,.kv2').forEach(el=>el.remove());

  function mountControl(control,target){
    if(!control||!target) return;
    target.appendChild(control);
  }

  mountControl(controls.title,titleEditorSlot);
  mountControl(controls.date,dateEditorSlot);
  mountControl(controls.code, codeEditorSlot || (codeFieldView && codeFieldView.__editor));
  mountControl(controls.dm, dmField.__editor);
  mountControl(controls.kind, kindField.__editor);
  tradeField=null;
  if(tradedItemField && controls.traded_item){
    mountControl(controls.traded_item, tradedItemField.__editor);
    tradeField=controls.traded_item.closest('.field');
  }
  mountControl(controls.gp_plus, gpEarnCell.__editor);
  mountControl(controls.gp_minus, gpSpendCell.__editor);
  mountControl(controls.dtd_plus, dtEarnCell.__editor);
  mountControl(controls.dtd_minus, dtSpendCell.__editor);
  mountControl(controls.level_plus, levelField.__editor);
  mountControl(controls.perm_items, permField.__editor);
  mountControl(controls.lost_perm_item, lostField.__editor);
  mountControl(controls.consumable_items, consField.__editor);
  mountControl(controls.notes, notesField.__editor);

  permField.classList.add('full');
  lostField.classList.add('full');
  consField.classList.add('full');
  notesField.classList.add('full','notes-field');

  const actions=document.createElement('div'); actions.className='edit-actions';
  actions.classList.add('show-when-editing');
  const deleteBtn=document.createElement('button'); deleteBtn.type='button'; deleteBtn.className='btn small danger delete-btn'; deleteBtn.innerHTML='<span class="btn-icon">'+ICON_TRASH+'</span><span>Delete entry</span>';
  deleteBtn.addEventListener('click',(ev)=>{ ev.preventDefault(); deleteCard(card); });
  const cancelBtn=document.createElement('button'); cancelBtn.type='button'; cancelBtn.className='btn small'; cancelBtn.textContent='Cancel';
  cancelBtn.addEventListener('click',(ev)=>{
    ev.preventDefault();
    if(card.__dataRef && card.__dataRef.__isNew){
      closeCardOverlay();
      return;
    }
    exitEditMode(card,true);
  });
  const saveBtn=document.createElement('button'); saveBtn.type='button'; saveBtn.className='btn small primary'; saveBtn.textContent='OK';
  saveBtn.addEventListener('click',async(ev)=>{ ev.preventDefault(); await saveCardChanges(card); });
  actions.appendChild(deleteBtn);
  actions.appendChild(cancelBtn); actions.appendChild(saveBtn);
  view.appendChild(actions);

  function populate(editing=false){
    const kindRaw=hasLockedKind?lockedKind:(a.kind||'').toString();
    const kindVal=kindRaw && kindRaw.toLowerCase()!=='adventure'?'Downtime Activity':'adventure';
    controls.kind.value=kindVal;
    controls.kind.disabled=hasLockedKind;
    const isActivityMode=(controls.kind.value||'adventure')!=='adventure';

    const titleRaw=a.title||'';
    controls.title.value=titleRaw;
    if(titleDisplayEl){
      const fallback=isActivityMode?'Activity':'Untitled Adventure';
      titleDisplayEl.textContent=sanitizeTitle(titleRaw||fallback);
      refreshScrollState(nameSpan);
    }

    const dateValue=a.date?String(a.date).slice(0,10):'';
    controls.date.value=dateValue;
    if(dateDisplayEl){ dateDisplayEl.textContent=fmtDate(a.date); }

    const codeRaw=a.code||'';
    controls.code.value=codeRaw;
    if(codeDisplayEl){ codeDisplayEl.textContent=makeValue(codeRaw); }
    if(codeFieldView){
      codeFieldView.style.display=(editing||codeRaw)?'':'none';
    }

    const kindLabel=(controls.kind.value||'adventure')==='adventure'?'Adventure':'Downtime Activity';
    kindField.__display.textContent=kindLabel;
    const showKindField=editing && !hasLockedKind;
    kindField.style.display=showKindField?'':'none';

    const dmRaw=a.dm||'';
    controls.dm.value=dmRaw;
    const dmDisplayVal=normalizeDisplayValue(dmRaw)||'—';
    if(dmField && dmField.__display){ dmField.__display.textContent=dmDisplayVal; }
    if(dmField){
      const showDM=editing || !isActivityMode || dmDisplayVal!=='—';
      dmField.style.display=showDM?'':'none';
    }

    if(tradedItemField && controls.traded_item){
      const tradeVal=a.traded_item||'';
      controls.traded_item.value=tradeVal;
      tradedItemField.__display.textContent=makeValue(tradeVal);
      tradedItemField.style.display=(editing||tradeVal.trim())?'':'none';
    }

    const gpEarn=Number(a.gp_plus??0);
    controls.gp_plus.value=a.gp_plus!=null&&a.gp_plus!==''?a.gp_plus:'';
    gpEarnCell.__display.textContent=fmtNumber(gpEarn);
    const gpSpend=Number(a.gp_minus??0);
    controls.gp_minus.value=a.gp_minus!=null&&a.gp_minus!==''?a.gp_minus:'';
    gpSpendCell.__display.textContent=fmtNumber(gpSpend);
    const showGpEarn=!isActivityMode || gpEarn!==0 || editing;
    const showGpSpend=!isActivityMode || gpSpend!==0 || editing;
    gpEarnCell.style.display=showGpEarn?'':'none';
    gpSpendCell.style.display=showGpSpend?'':'none';
    gpRowView.style.display=(editing||showGpEarn||showGpSpend)?'':'none';

    const dtEarn=Number(a.dtd_plus??0);
    controls.dtd_plus.value=a.dtd_plus!=null&&a.dtd_plus!==''?a.dtd_plus:'';
    dtEarnCell.__display.textContent=fmtNumber(dtEarn);
    const dtSpend=Number(a.dtd_minus??0);
    controls.dtd_minus.value=a.dtd_minus!=null&&a.dtd_minus!==''?a.dtd_minus:'';
    dtSpendCell.__display.textContent=fmtNumber(dtSpend);
    const showDtEarn=!isActivityMode || dtEarn!==0 || editing;
    const showDtSpend=!isActivityMode || dtSpend!==0 || editing;
    dtEarnCell.style.display=showDtEarn?'':'none';
    dtSpendCell.style.display=showDtSpend?'':'none';
    dtRowView.style.display=(editing||showDtEarn||showDtSpend)?'':'none';

    const levelVal=Number(a.level_plus||0);
    controls.level_plus.value=a.level_plus!=null&&a.level_plus!==''?a.level_plus:'';
    levelField.__display.textContent=fmtNumber(levelVal);
    const showLevel=(editing||(!isActivityMode && levelVal) || (isActivityMode && levelVal!==0));
    levelField.style.display=showLevel?'':'none';

    const permValues=Array.isArray(a.perm_items)?a.perm_items:[];
    controls.perm_items.setValues(permValues);
    permField.__display.innerHTML='';
    permField.__display.appendChild(listBox(permValues));
    const hasPermItemsNow=permValues.some(item=>hasMeaningfulValue(item));
    permField.style.display=(editing || (!hasTradeMeta && (!isActivityMode || hasPermItemsNow)))?'':'none';

    const consValues=Array.isArray(a.consumable_items)?a.consumable_items:[];
    controls.consumable_items.setValues(consValues);
    consField.__display.innerHTML='';
    consField.__display.appendChild(listBox(consValues));
    const hasConsNow=consValues.some(item=>hasMeaningfulValue(item));
    consField.style.display=(editing || (!isActivityMode || hasConsNow))?'':'none';

    const notesRaw=a.notes||'';
    controls.notes.value=notesRaw;
    const notesDisplay=normalizeDisplayValue(notesRaw)||'—';
    notesField.__display.innerHTML='';
    const notesNode=document.createElement('div'); notesNode.className='notesbox'; notesNode.textContent=notesDisplay;
    notesField.__display.appendChild(notesNode);
    const showNotes=(editing || (!hasTradeMeta && (!isActivityMode || notesDisplay!=='—')));
    notesField.style.display=showNotes?'':'none';

    const lostRaw=(a.lost_perm_item||'').trim();
    let lostItems=parseLostItemList(lostRaw);
    if(controls.lost_perm_item){
      controls.lost_perm_item.setValues(lostItems);
      if(typeof controls.lost_perm_item.refreshOptions==='function'){
        controls.lost_perm_item.refreshOptions();
      }
      lostItems=controls.lost_perm_item.getValues();
    }
    lostField.__display.innerHTML='';
    lostField.__display.appendChild(listBox(lostItems));
    lostField.style.display=(editing || lostItems.length)?'':'none';

    if(metaDisplayEl){
      const metaEntry={...a};
      if(editing){
        metaEntry.date=controls.date.value||a.date;
        metaEntry.code=controls.code.value;
        metaEntry.dm=controls.dm.value;
        metaEntry.kind=(controls.kind.value||'adventure')==='adventure'?'adventure':'activity';
      }
      metaDisplayEl.textContent=buildHeaderMeta(metaEntry);
    }

    syncKindVisibility();
  }

  function collect(){
    const selectedKind=(controls.kind.value||'').trim();
    const normalizedKind=selectedKind==='Downtime Activity'?'Downtime Activity':'adventure';
    const isActivity=normalizedKind!=='adventure';
    return {
      title:(controls.title.value||'').trim(),
      date:controls.date.value||'',
      code:(controls.code.value||'').trim(),
      dm:(controls.dm.value||'').trim(),
      kind:normalizedKind,
      gp_plus:Number(controls.gp_plus.value||0),
      gp_minus:Number(controls.gp_minus.value||0),
      dtd_plus:Number(controls.dtd_plus.value||0),
      dtd_minus:Number(controls.dtd_minus.value||0),
      level_plus:Number(controls.level_plus.value||0),
      perm_items:controls.perm_items.getValues(),
      lost_perm_item:controls.lost_perm_item?controls.lost_perm_item.getValues().join('\n'):'',
      consumable_items:controls.consumable_items.getValues(),
      notes:controls.notes.value||'',
      traded_item:isActivity?(controls.traded_item.value||'').trim():''
    };
  }

  formWrap.populate=populate;
  formWrap.collect=collect;

  bd.appendChild(view);
  bd.appendChild(formWrap);
  card.appendChild(hd);
  card.appendChild(bd);

  card.__edit={button:editBtn, form:formWrap, populate, collect};

  if(a && a.__openEdit){
    delete a.__openEdit;
    requestAnimationFrame(()=>enterEditMode(card));
  }

  return card;
}

function enterEditMode(card){
  if(!card||!card.__edit) return;
  card.classList.add('editing');
  card.classList.add('open');
  card.__edit.populate(true);
  const bd=card.querySelector('.card-bd');
  if(bd){
    bd.style.height='auto';
    bd.style.opacity='1';
  }
  if(card.__edit.button){
    card.__edit.button.setAttribute('aria-pressed','true');
    card.__edit.button.title='Exit edit mode';
  }
}

function exitEditMode(card,reset){
  if(!card||!card.__edit) return;
  card.classList.remove('editing');
  if(reset){ card.__edit.populate(false); }
  if(card.__edit.button){
    card.__edit.button.setAttribute('aria-pressed','false');
    card.__edit.button.title='Edit entry';
  }
}

async function saveCardChanges(card){
  if(!card||!card.__edit) return;
  const data=card.__dataRef;
  if(!data) return;
  const updates=card.__edit.collect();
  data.title=updates.title||null;
  data.date=updates.date||null;
  data.code=updates.code||'';
  data.dm=updates.dm||null;
  data.kind=updates.kind||'adventure';
  data.gp_plus=Number.isFinite(updates.gp_plus)?updates.gp_plus:0;
  data.gp_minus=Number.isFinite(updates.gp_minus)?updates.gp_minus:0;
  data.gp_net=data.gp_plus-data.gp_minus;
  data.dtd_plus=Number.isFinite(updates.dtd_plus)?updates.dtd_plus:0;
  data.dtd_minus=Number.isFinite(updates.dtd_minus)?updates.dtd_minus:0;
  data.dtd_net=data.dtd_plus-data.dtd_minus;
  data.level_plus=Number.isFinite(updates.level_plus)?updates.level_plus:0;
  data.perm_items=[...updates.perm_items];
  data.lost_perm_item=updates.lost_perm_item||'';
  data.consumable_items=[...updates.consumable_items];
  const trimmedNotes=(updates.notes||'').trim();
  data.notes=trimmedNotes||'';
  data.traded_item=data.kind!=='adventure'?(updates.traded_item||''):'';
  const keyOverride=data.__charKey||null;
  const wasNew=!!data.__isNew;
  const targetKey=keyOverride||charSel.value;
  if(wasNew){
    const targetChar=DATA.characters[targetKey];
    if(targetChar){
      targetChar.adventures=Array.isArray(targetChar.adventures)?targetChar.adventures:[];
      targetChar.adventures.unshift(data);
    }
    delete data.__isNew;
    delete data.__charKey;
  }
  if(Object.prototype.hasOwnProperty.call(data,'__lockedKind')){
    delete data.__lockedKind;
  }
  markDirty();
  exitEditMode(card);
  if(wasNew){
    closeCardOverlay();
  }
  const mutationKey=wasNew?targetKey:charSel.value;
  applyDataMutation(mutationKey);
}

function deleteCard(card){
  if(!card||!card.__dataRef) return;
  if(card.__dataRef.__isNew){
    const confirmed=window.confirm('Discard this new entry?');
    if(confirmed) closeCardOverlay();
    return;
  }
  const key=charSel.value;
  const ch=DATA.characters[key];
  if(!ch||!Array.isArray(ch.adventures)) return;
  const idx=ch.adventures.indexOf(card.__dataRef);
  if(idx===-1) return;
  const confirmed=window.confirm('Delete this entry?');
  if(!confirmed) return;
  ch.adventures.splice(idx,1);
  markDirty();
  applyDataMutation(key);
}

function ensureDerivedStores(){
  if(!DATA || typeof DATA!=='object') return;
  if(!DATA.stats || typeof DATA.stats!=='object'){
    DATA.stats={};
  }
  if(!DATA.years || typeof DATA.years!=='object'){
    DATA.years={};
  }
}

function updateDerivedDataFor(key){
  if(isDmLogKey(key)) return;
  if(!DATA || !DATA.characters) return;
  ensureDerivedStores();
  sortCharacterAdventures(key);
  const ch=DATA.characters[key];
  if(!ch) return;
  const advs=ch.adventures||[];
  const years=new Set();
  let sessions=0, netGP=0, netDTD=0, levelUps=0;
  advs.forEach(entry=>{
    if(entry && typeof entry==='object'){
      entry.__charKey=key;
    }
    if(entry.date){
      const year=new Date(entry.date).getFullYear();
      if(!Number.isNaN(year)) years.add(year);
    }
    const {gp,dtd}=netVals(entry);
    netGP+=gp;
    netDTD+=dtd;
    const levelGain=Number(entry.level_plus);
    if(Number.isFinite(levelGain)){
      levelUps+=levelGain;
    }
    if(!isActivityEntry(entry)) sessions++;
  });
  const descending=advs.map((adv,idx)=>({adv,idx})).sort(compareChronoDesc);
  let runningLevel=Math.max(1, Math.round(1+levelUps));
  descending.forEach(({adv})=>{
    if(!adv || typeof adv!=='object') return;
    const afterLevel=Number.isFinite(runningLevel)?runningLevel:1;
    const normalizedAfter=Math.max(1, Math.round(afterLevel));
    adv.__levelAfter=normalizedAfter;
    const gainRaw=Number(adv.level_plus);
    const gain=Number.isFinite(gainRaw)?gainRaw:0;
    const beforeLevel=afterLevel-gain;
    const normalizedBefore=Number.isFinite(beforeLevel)?Math.max(1, Math.round(beforeLevel)):normalizedAfter;
    adv.__levelAtStart=normalizedBefore;
    const nextLevel=Number.isFinite(beforeLevel)?Math.max(1, beforeLevel):normalizedBefore;
    runningLevel=nextLevel;
  });
  DATA.years[key]=Array.from(years).sort((a,b)=>a-b);
  const perm=collectPermanentInventory(key);
  const cons=buildConsumableInventory(key);
  DATA.stats[key]={
    sessions,
    net_gp:netGP,
    net_dtd:netDTD,
    level_ups:levelUps,
    perm_count:(perm.kept||[]).length,
    cons_count:cons.size||0
  };
}

function refreshAllDerivedData(){
  if(!DATA || !DATA.characters) return;
  ensureDerivedStores();
  Object.keys(DATA.characters).forEach(key=>{
    updateDerivedDataFor(key);
  });
  rebuildDmRewardLinks();
}

function applyDataMutation(key){
  updateDerivedDataFor(key);
  rebuildDmRewardLinks();
  filterAndRender();
  scheduleAvatarPreload();
  if(pendingChanges){
    persistDataDraft();
  }
}

/* --- stats & header --- */
function updateCharMeta(key){
  if(!metaEl) return;
  const statsMap=(DATA && typeof DATA.stats==='object')?DATA.stats:{};
  const stats=statsMap[key];
  if(!stats){
    metaEl.textContent='';
    metaEl.style.display='none';
    metaEl.setAttribute('aria-hidden','true');
    return;
  }
  const levelUps=Number(stats.level_ups||0);
  const currentLevel=(Number.isFinite(levelUps)?Math.round(levelUps):0)+1;
  const sessionsRaw=Number(stats.sessions||0);
  const parts=[];
  if(Number.isFinite(currentLevel)) parts.push(`Level ${fmtNumber(currentLevel)}`);
  if(Number.isFinite(sessionsRaw)){
    const label=sessionsRaw===1?'Session':'Sessions';
    parts.push(`${fmtNumber(sessionsRaw)} ${label}`);
  }
  const text=parts.join(' • ');
  metaEl.textContent=text;
  const show=Boolean(text);
  metaEl.style.display=show?'block':'none';
  metaEl.setAttribute('aria-hidden',show?'false':'true');
}

function renderStats(key){
  if(isDmLogKey(key)){
    updateDmMeta();
    return;
  }
  const statsMap=(DATA && typeof DATA.stats==='object')?DATA.stats:{};
  const s=statsMap[key]||{};
  updateCharMeta(key);
  const goldVal=fmtNumber(s.net_gp||0);
  if(goldValueEl) goldValueEl.textContent=goldVal;
  if(goldMetricEl) goldMetricEl.setAttribute('aria-label', `Gold: ${goldVal} gold pieces total`);
  const dtdVal=fmtNumber(s.net_dtd||0);
  if(downtimeValueEl) downtimeValueEl.textContent=dtdVal;
  if(downtimeMetricEl) downtimeMetricEl.setAttribute('aria-label', `Downtime: ${dtdVal} downtime days total`);
  const permCount=Number(s.perm_count||0);
  const consCount=Number(s.cons_count||0);
  if(magicItemsCountEl) magicItemsCountEl.textContent=`${fmtNumber(permCount)} permanent items`;
  if(consumablesCountEl) consumablesCountEl.textContent=`${fmtNumber(consCount)} consumables`;
  if(magicItemsBtn){
    const label=`View permanent magic items (${fmtNumber(permCount)} total)`;
    magicItemsBtn.setAttribute('aria-label',label);
    magicItemsBtn.title=label;
  }
  if(consumablesBtn){
    const label=`View consumables (${fmtNumber(consCount)} total)`;
    consumablesBtn.setAttribute('aria-label',label);
    consumablesBtn.title=label;
  }
}
function setHeader(key){
  if(isDmLogKey(key)){
    setDmHeader();
    return;
  }
  const obj=DATA.characters[key];
  updateAvatar(key,obj);
  if(metaEl&&!obj){
    metaEl.textContent='';
    metaEl.style.display='none';
    metaEl.setAttribute('aria-hidden','true');
  }
  if(!badgesEl) return;
  badgesEl.innerHTML='';
  if(!obj){
    badgesEl.style.display='none';
    badgesEl.setAttribute('aria-hidden','true');
    return;
  }
  const identity=extractCharacterIdentity(obj);
  const chips=[];
  if(identity.race){ chips.push(identityBadge('Race', identity.race)); }
  if(identity.classes){ chips.push(identityBadge('Classes', identity.classes)); }
  chips.forEach(chip=>badgesEl.appendChild(chip));
  const show=chips.length>0;
  badgesEl.style.display=show?'flex':'none';
  badgesEl.setAttribute('aria-hidden', show?'false':'true');
}

/* --- rendering --- */
function filterAndRender(){
  if(!charSel) return;
  let key=charSel.value;
  if(!isValidSheetKey(key)){
    const stored=getRememberedCharacterKey();
    if(isValidSheetKey(stored)){
      charSel.value=stored;
      key=stored;
    }
  }
  if(!isValidSheetKey(key)){
    const fallback=getMostRecentCharacter();
    if(isValidSheetKey(fallback)){
      charSel.value=fallback;
      key=fallback;
    }else if(hasDmLogData()){
      charSel.value=DM_LOG_KEY;
      key=DM_LOG_KEY;
    }else{
      rememberCharacterKey('');
      if(grid){
        grid.innerHTML='';
      }
      if(emptyEl){
        setEmptyStateMessage(defaultEmptyMessage);
        emptyEl.style.display='block';
      }
      return;
    }
  }
  rememberCharacterKey(key);
  syncCharacterSelectorUI();
  updateUiForSelection(key);
  if(isDmLogKey(key)){
    setEmptyStateMessage(DM_EMPTY_MESSAGE);
    renderDmLog();
    renderStats(key);
    setHeader(key);
    return;
  }
  if(!DATA || !DATA.characters){
    return;
  }
  setEmptyStateMessage(defaultEmptyMessage);
  sortCharacterAdventures(key);
  const advs=(DATA.characters[key]&&DATA.characters[key].adventures)||[];
  const q=(qEl.value||'').toLowerCase();
  const decorated=advs.map((adv,idx)=>({adv,idx}));
  const filtered=decorated.filter(({adv:a})=>{
    if(!showActivities && isActivityEntry(a)) return false;
    const blob=[a.title,a.code,a.notes,a.dm,a.traded_item,a.itemTraded,a.itemReceived,a.player,a.character,a.lost_perm_item]
      .concat(a.perm_items||[])
      .concat(a.consumable_items||[])
      .map(x=>(x||'').toString().toLowerCase()).join(' ');
    return !q||blob.indexOf(q)!==-1;
  }).sort(compareChronoDesc);
  grid.innerHTML='';
  if(!filtered.length){ emptyEl.style.display='block'; }
  else { emptyEl.style.display='none'; filtered.forEach(({adv},i)=>grid.appendChild(makeCard(adv,i))); }
  renderStats(key);
  setHeader(key);
}

/* --- events --- */
qEl.addEventListener('input',filterAndRender);
if(charSel){
  charSel.addEventListener('change',()=>{
    syncCharacterSelectorUI();
    filterAndRender();
  });
}
if(charSelToggle){
  charSelToggle.addEventListener('click',(event)=>{
    event.preventDefault();
    toggleCharMenu();
  });
  charSelToggle.addEventListener('keydown',(event)=>{
    if(event.key==='ArrowDown'){
      event.preventDefault();
      openCharMenu();
    }else if(event.key==='ArrowUp'){
      event.preventDefault();
      openCharMenu({focusLast:true});
    }else if(event.key==='Enter' || event.key===' '){
      event.preventDefault();
      toggleCharMenu();
    }
  });
}
if(charSelMenu){
  charSelMenu.addEventListener('keydown',(event)=>{
    const items=getCharMenuItems();
    if(!items.length) return;
    const currentIndex=items.indexOf(document.activeElement);
    if(event.key==='ArrowDown'){
      event.preventDefault();
      const nextIndex=currentIndex>=0?((currentIndex+1)%items.length):0;
      const target=items[nextIndex];
      focusCharMenuItem(target||items[0]);
    }else if(event.key==='ArrowUp'){
      event.preventDefault();
      const prevIndex=currentIndex>=0?((currentIndex-1+items.length)%items.length):items.length-1;
      const target=items[prevIndex]||items[items.length-1];
      focusCharMenuItem(target);
    }else if(event.key==='Home'){
      event.preventDefault();
      focusCharMenuItem(items[0]);
    }else if(event.key==='End'){
      event.preventDefault();
      focusCharMenuItem(items[items.length-1]);
    }else if(event.key==='Escape'){
      event.preventDefault();
      closeCharMenu({focusToggle:true});
    }else if(event.key==='Tab'){
      closeCharMenu();
    }else if(event.key==='Enter' || event.key===' '){
      const target=event.target && event.target.closest ? event.target.closest('.char-menu-item') : null;
      if(target){
        event.preventDefault();
        target.click();
      }
    }
  });
}
syncCharacterSelectorUI();
if(dmItemsBtnEl){
  dmItemsBtnEl.addEventListener('click',()=>{
    const isOpen=dmItemsModal && dmItemsModal.classList.contains('open');
    if(isOpen){
      closeDmItemsModal();
    }else{
      openDmItemsModal();
    }
  });
}
if(dmItemsCloseBtn){
  dmItemsCloseBtn.addEventListener('click',()=>{
    closeDmItemsModal();
  });
}
if(dmItemsModal){
  dmItemsModal.addEventListener('click',(event)=>{
    if(event.target===dmItemsModal){
      closeDmItemsModal();
    }
  });
}
document.addEventListener('click',(event)=>{
  if(addCardMenu && !addCardMenu.hidden){
    const withinMenu=addCardMenu.contains(event.target);
    const withinButton=addCardBtn && addCardBtn.contains(event.target);
    if(!withinMenu && !withinButton){
      closeAddMenu();
    }
  }
  if(charSelMenu && !charSelMenu.hidden){
    const withinMenu=charSelMenu.contains(event.target);
    const withinToggle=charSelToggle && charSelToggle.contains(event.target);
    if(!withinMenu && !withinToggle){
      closeCharMenu();
    }
  }
});
document.addEventListener('keydown',(event)=>{
  if(event.key==='Escape'){
    let handled=false;
    if(addCardMenu && !addCardMenu.hidden){
      closeAddMenu();
      handled=true;
    }
    if(charSelMenu && !charSelMenu.hidden){
      closeCharMenu({focusToggle:true});
      handled=true;
    }
    if(dmItemsModal && dmItemsModal.classList.contains('open')){
      closeDmItemsModal();
      handled=true;
    }
    if(handled){
      event.stopPropagation();
    }
  }
});
if(activityToggleBtn){
  activityToggleBtn.addEventListener('click',()=>{
    showActivities=!showActivities;
    persistActivityVisibility();
    updateActivityToggle();
    filterAndRender();
  });
}
window.addEventListener('beforeunload',(event)=>{
  if(pendingChanges || hasLocalDraft){
    const message='You have unsaved changes. Save them before leaving or they will be discarded.';
    event.preventDefault();
    event.returnValue=message;
    return message;
  }
});

/* --- init --- */
function initApp(){
  DATA=window.DATA||null;
  if(!DATA || !DATA.characters){
    showDataLoadError('Could not load <code>data.js</code>.');
    return false;
  }
  refreshAllDerivedData();
  if(emptyEl){
    emptyEl.style.display='none';
  }
  updateActivityToggle();
  const initialKey=rebuildCharacterOptions({preserveSelection:false})||getMostRecentCharacter();
  if(initialKey && charSel){
    charSel.value=initialKey;
  }
  filterAndRender();
  scheduleAvatarPreload();
  if(pendingChanges){
    updateSaveButtonState();
  }else{
    clearDirty();
  }
  return true;
}

let __appInitialized=false;
function ensureAppInitialized(){
  if(__appInitialized) return;
  __appInitialized=initApp();
}

function tryInitApp(){
  const usedDraft=applyDraftIfAvailable({force:pendingChanges || hasLocalDraft});
  if(window.DATA && window.DATA.characters){
    const wasInitialized=__appInitialized;
    DATA=window.DATA;
    ensureAppInitialized();
    if(usedDraft && wasInitialized){
      refreshAllDerivedData();
      rebuildCharacterOptions({preserveSelection:true});
      filterAndRender();
      scheduleAvatarPreload();
    }
    return __appInitialized;
  }
  return false;
}

if(!tryInitApp()){
  if(dataScriptEl){
    const onLoad=()=>{
      if(!tryInitApp()){
        showDataLoadError('Could not load <code>data.js</code>.');
      }
    };
    dataScriptEl.addEventListener('load', onLoad, {once:true});
    dataScriptEl.addEventListener('error',()=>{
      showDataLoadError('Could not load <code>data.js</code>.');
    },{once:true});
    const state=dataScriptEl.readyState;
    if(state==='loaded'||state==='complete'){
      tryInitApp();
    }
    [0,50,200].forEach(delay=>{ setTimeout(()=>{ tryInitApp(); },delay); });
  }else{
    showDataLoadError('Could not load <code>data.js</code>.');
  }
}

/* prevent accidental jump-to-top for href="#" */
document.addEventListener('click',(e)=>{ const a=e.target.closest('a[href="#"]'); if(a) e.preventDefault(); },{passive:true});

/* save data.js */
if(downloadBtn){
  downloadBtn.addEventListener('click',async()=>{
    try{
      await saveDataJs();
    }catch(err){
      /* saveDataJs already handles user feedback */
    }
  });
}
if(addCardBtn){
  addCardBtn.addEventListener('click',()=>{
    if(addCardMenu && !addCardMenu.hidden){
      closeAddMenu();
    }else{
      openAddMenu();
    }
  });
}
</script>
</body>
</html>
