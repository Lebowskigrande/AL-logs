<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Adventure Log Dashboard</title>
<link rel="icon" type="image/svg+xml" href="log-svgrepo-com.svg"/>
<link rel="shortcut icon" type="image/svg+xml" href="log-svgrepo-com.svg"/>
<link rel="apple-touch-icon" sizes="any" href="log-svgrepo-com.svg"/>
<link rel="manifest" href="site.webmanifest"/>
<style>
:root{
  --bg:#fff; --surface:#fff; --ink:#0f172a; --muted:#64748b; --primary:#1a73e8; --border:#e5eaf3;
  --radius:16px; --shadow1:0 3px 12px rgba(16,24,40,.08); --shadow2:0 22px 44px rgba(16,24,40,.14);
  --dur:220ms; --ease:cubic-bezier(.2,.8,.2,1); --accordion-ease:cubic-bezier(.33,1,.68,1); --gap:14px; --min-card:320px;
  --menu-dur:260ms; --danger:#dc2626;
  --open-card-header:#e6eaf2;
  --open-card-body:#f5f7fa;
  --open-card-border:rgba(148,163,184,.22);
  --open-card-shadow:none;
  --open-card-accent:transparent;
  --divider:#e2e8f0;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%;min-height:100%;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg);scrollbar-gutter:stable}
body{display:flex;flex-direction:column;min-height:100vh;overflow-x:hidden;overflow-y:auto;background:var(--bg)}
.app-shell{flex:1 1 auto;display:flex;flex-direction:column;min-height:0;background:var(--bg)}
.app-main{flex:1 1 auto;display:flex;flex-direction:column;min-height:0;padding:24px clamp(20px,4vw,48px);overflow-y:auto;overflow-x:hidden}
.app-main>.container{flex:1 1 auto;display:flex;flex-direction:column;max-width:880px;width:100%;margin:0 auto;min-height:0}
.sheet-card{position:relative;background:transparent;border:none;border-radius:0;box-shadow:none;display:flex;flex-direction:column;min-height:0;flex:1 1 auto;padding:0}
.sheet-card-header{padding:0 0 12px;display:flex;flex-direction:column;gap:20px;background:transparent;flex:0 0 auto;margin-bottom:12px;overflow-y:auto;overflow-x:hidden;scrollbar-gutter:stable}
.sheet-card-body{flex:1 1 auto;display:flex;flex-direction:column;gap:20px;padding:0;background:transparent;min-height:0}
.log-window{flex:1 1 auto;display:flex;flex-direction:column;position:relative;border-radius:0;border:none;background:transparent;box-shadow:none;overflow:hidden;min-height:0}
.log-window::before{content:none}
.log-list{--log-row-gap:0;--log-card-radius:14px;flex:1 1 auto;display:flex;flex-direction:column;align-items:stretch;overflow-y:auto;overflow-x:hidden;scrollbar-gutter:stable;padding:0;margin:0;gap:var(--log-row-gap);min-height:0}
.log-list::after{content:none}
.log-window>.empty{padding:48px 24px;display:flex;align-items:center;justify-content:center;text-align:center;font-size:14px;color:var(--muted)}
.data-diagnostics{margin-top:16px;text-align:left;max-width:560px;margin-left:auto;margin-right:auto}
.data-diagnostics-summary{margin:12px 0;padding-left:20px}
.data-diagnostics-summary li{margin-bottom:6px}
.data-diagnostics details{margin-top:12px}
.data-diagnostics pre{white-space:pre-wrap;word-break:break-word;background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:12px;font-size:12px;line-height:1.5}
.data-diagnostics-timeline ol{padding-left:20px;margin:10px 0}
.data-diagnostics-timeline li{margin-bottom:8px}
@media (max-width:768px){
  .app-main{padding:20px 16px 28px}
  .app-main>.container{max-width:100%}
  .sheet-card-header{padding-bottom:12px;margin-bottom:12px}
  .log-window{border-radius:0;border:none;box-shadow:none}
  .log-list{padding:0}
}
@media (min-width:1100px){
  .app-main{min-width:0;padding:36px clamp(32px,5vw,72px)}
}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.row.ticker-active{flex-wrap:nowrap}
.row.ticker-active .header-main{flex:1 1 auto;min-width:0;overflow:hidden}
.sheet-card-header .row.ticker-active .header-main{overflow:visible;}
.row.ticker-active #saveIndicatorWrap{flex:0 0 auto}
.avatar{display:block;width:auto;height:72px;max-width:100%;border-radius:0;box-shadow:none;object-fit:contain}
.avatar.avatar-hidden{display:none}
.avatar.has-avatar{cursor:zoom-in;}
.avatar.avatar-fallback{background:none;}
.avatar:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:3px}
h1{margin:0;font-size:28px;line-height:1.05;font-weight:800;letter-spacing:-0.01em}
.header-main{display:flex;flex-direction:column;gap:6px;min-width:0;flex:1 1 auto}
.title-select-group{position:relative;display:inline-flex;flex-direction:column;align-items:flex-start;gap:6px;max-width:100%;min-width:0}
.title-select-wrap{display:flex;align-items:center;gap:6px;position:relative;margin:0;width:100%;max-width:100%;min-width:0}
.title-select{display:none}
.title-select-trigger{appearance:none;border:1px solid transparent;background:#fff;border-radius:14px;padding:12px 18px;font:inherit;font-size:clamp(20px,3vw,28px);line-height:1.3;font-weight:800;letter-spacing:-0.01em;color:var(--ink);display:inline-flex;align-items:center;gap:12px;cursor:pointer;transition:background var(--dur) var(--ease),color var(--dur) var(--ease),border-color var(--dur) var(--ease);min-width:0;width:auto;max-width:100%;text-align:left;box-shadow:none;align-self:flex-start}
.title-select-trigger:hover{background:#eef4ff;border-color:rgba(26,115,232,.35)}
.title-select-trigger:focus-visible{outline:3px solid rgba(26,115,232,.35);outline-offset:4px}
.title-select-trigger[aria-expanded="true"]{background:#eef4ff;border-color:rgba(26,115,232,.35)}
.title-select-trigger:disabled{cursor:not-allowed;opacity:.6;box-shadow:none;transform:none;background:#e2e8f0;color:#64748b}
.sheet-card-header.multi-search-active #charAvatar{filter:grayscale(1);opacity:.45}
.sheet-card-header.multi-search-active .title-select-trigger{color:var(--muted);background:#f1f5f9;border-color:rgba(148,163,184,.4)}
.sheet-card-header.multi-search-active .title-select-trigger .char-toggle-icon{background:#e2e8f0;color:var(--muted)}
.sheet-card-header.multi-search-active .char-meta{opacity:.75}
.title-select-trigger:disabled .char-toggle-icon{background:#cbd5f5;color:#475569}
.char-toggle-text{display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;line-height:1.3;padding-block:2px;flex:1 1 auto;min-width:0}
.char-toggle-icon{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#eef4ff;color:var(--primary);flex:0 0 auto;transition:transform var(--dur) var(--ease),background var(--dur) var(--ease)}
.title-select-trigger:hover .char-toggle-icon{background:#dbeafe}
.title-select-trigger[aria-expanded="true"] .char-toggle-icon{transform:rotate(180deg)}
.title-select-trigger svg{width:16px;height:16px}
.char-menu{position:fixed;top:0;left:0;min-width:280px;max-width:min(360px,calc(100vw - 32px));max-height:360px;padding:8px 0;border-radius:16px;background:#fff;border:1px solid var(--border);box-shadow:var(--shadow1),var(--shadow2);display:flex;flex-direction:column;gap:2px;z-index:120;overflow:auto;opacity:0;transform:translateY(-6px) scale(.98);transform-origin:top;pointer-events:none;visibility:hidden;transition:opacity var(--menu-dur,var(--dur)) var(--ease),transform var(--menu-dur,var(--dur)) var(--ease);will-change:opacity,transform}
.char-menu[data-placement='above']{transform:translateY(6px) scale(.98);transform-origin:bottom}
.char-menu[data-placement='above'][data-menu-state='opening'],.char-menu[data-placement='above'][data-menu-state='closing']{transform:translateY(4px) scale(.98)}
.char-menu[data-menu-state]{visibility:visible}
.char-menu[data-menu-state='opening']{opacity:0;transform:translateY(-4px) scale(.98)}
.char-menu[data-menu-state='open']{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.char-menu[data-menu-state='closing']{opacity:0;transform:translateY(-4px) scale(.98);pointer-events:none}
.char-menu[hidden]{display:none}
.char-menu-item{width:100%;display:flex;align-items:center;justify-content:flex-start;gap:12px;padding:10px 18px;font:inherit;font-size:16px;color:var(--ink);background:none;border:none;cursor:pointer;transition:background-color var(--dur) var(--ease),color var(--dur) var(--ease),border-color var(--dur) var(--ease);text-align:left}
.char-menu-group{padding:12px 18px 4px;font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
.char-menu-group--tier1{color:#16a34a}
.char-menu-group--tier2{color:#2563eb}
.char-menu-group--tier3{color:#7c3aed}
.char-menu-group--tier4{color:#d97706}
.char-menu-group:not(:first-child){margin-top:4px;border-top:1px solid var(--divider);padding-top:16px}
.char-menu-item:hover,.char-menu-item:focus-visible{background:#eef4ff;color:var(--primary);outline:none}
.char-menu-item.active{color:var(--primary);font-weight:600}
.char-menu-text{flex:1 1 auto;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.char-menu-check{flex:0 0 auto;display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;color:var(--primary);opacity:0;transform:scale(.7);transition:transform var(--dur) var(--ease),opacity var(--dur) var(--ease);margin-left:auto}
.char-menu-item.active .char-menu-check{opacity:1;transform:scale(1)}
.char-menu-check svg{width:18px;height:18px}
.char-badges{margin-top:4px;display:none;gap:8px;flex-wrap:wrap;align-items:center}
.char-badges .identity-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#eef4ff;color:#1e293b;font-weight:600;font-size:12px;transition:color var(--dur) var(--ease),background-color var(--dur) var(--ease),border-color var(--dur) var(--ease)}
.char-badges .identity-badge .label{font-size:10px;letter-spacing:.08em;text-transform:uppercase;color:#64748b;transition:color var(--dur) var(--ease)}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.muted{color:var(--muted);font-size:13px;transition:color var(--dur) var(--ease)}
.char-meta{display:none;margin-top:4px;font-size:14px;font-weight:600;color:var(--muted)}

/* Toolbar */
.toolbar{margin-top:0;display:flex;gap:10px;flex-wrap:wrap}
.toolbar-layout{align-items:flex-start;row-gap:8px}
.toolbar-primary{display:flex;flex-wrap:wrap;align-items:center;gap:10px;flex:1 1 420px;min-width:0}
.toolbar-layout .header-quick{margin-top:0;margin-left:auto;flex:1 1 320px;justify-content:flex-end}

@media (max-width:840px){
  .toolbar-layout .header-quick{flex-basis:100%;margin-left:0;justify-content:flex-start}
}
.sheet-card-header > .toolbar{padding-top:12px}
.sheet-card-header > .header-quick{padding-top:12px}
.select,.btn,.search input{border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 12px;font-weight:600}
.btn{cursor:pointer;transition:background var(--dur) var(--ease),color var(--dur) var(--ease),border-color var(--dur) var(--ease)}
.btn:hover,.btn:focus-visible{background:#eef4ff;border-color:rgba(26,115,232,.35);color:var(--primary);outline:none}
.btn.primary{background:var(--primary);color:#fff;border-color:transparent}
.btn.primary:hover,.btn.primary:focus-visible{background:#155ccb;border-color:#0b57d0;color:#fff;outline:none}
.btn-icon{display:inline-flex;align-items:center;justify-content:center;margin-right:6px}
.btn-text{display:inline-flex;align-items:center;line-height:1;white-space:nowrap}
.btn-icon svg{width:14px;height:14px}
.btn.danger{border:1px solid rgba(220,38,38,.2);background:rgba(254,226,226,1);color:var(--danger);}
.btn.danger:hover,.btn.danger:focus-visible{background:#fecaca;border-color:rgba(220,38,38,.35);color:#b91c1c;outline:none}
.btn.small{padding:6px 10px;font-size:12px;border-radius:10px;display:inline-flex;align-items:center;gap:6px}
.btn.pill{border-radius:999px}
#activityToggle{background:#fff;color:var(--ink);border-color:var(--border)}
#activityToggle:hover,
#activityToggle:focus-visible{background:#dbeafe;border-color:rgba(26,115,232,.45);color:var(--primary);}
#activityToggle[aria-pressed="true"]{background:var(--primary);color:#fff;border-color:transparent}
#activityToggle[aria-pressed="true"]:hover,
#activityToggle[aria-pressed="true"]:focus-visible{background:#155ccb;border-color:#0b57d0;color:#fff;outline:none}
.search{position:relative}
.search input{padding-left:36px;padding-right:34px;outline:none;width:220px;max-width:100%;transition:border-color var(--dur) var(--ease),background-color var(--dur) var(--ease)}
.search input::placeholder{color:#94a3b8;opacity:1;font-weight:400}
.search input:hover{border-color:#cbd5f5}
.search input:focus-visible{border-color:#475569}
.search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);margin-block:auto;width:18px;height:18px;opacity:.6}
.search-clear{position:absolute;inset-block:0;inset-inline-end:10px;margin-block:auto;display:grid;place-items:center;width:24px;height:24px;border:none;border-radius:50%;background:transparent;color:#94a3b8;cursor:pointer;padding:0;transition:color var(--dur) var(--ease),background-color var(--dur) var(--ease)}
.search-clear svg,.search-clear img{display:block;width:12px;height:12px;pointer-events:none;opacity:.6;filter:brightness(1.35)}
.search-clear:hover,.search-clear:focus-visible{color:var(--primary);background:#eef4ff;outline:none}
.toolbar .spacer{flex:1 1 auto}

.icon-btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:#fff;color:var(--muted);cursor:pointer;transition:background var(--dur) var(--ease),color var(--dur) var(--ease),border-color var(--dur) var(--ease);box-shadow:none}
.icon-btn svg{width:14px;height:14px;pointer-events:none}
.icon-btn:hover,.icon-btn:focus-visible{color:var(--primary);background:#eef4ff;border-color:rgba(26,115,232,.35);outline:none}
.icon-btn.danger{border-color:rgba(220,38,38,.2);background:#fee2e2;color:var(--danger)}
.icon-btn.danger:hover,.icon-btn.danger:focus-visible{color:#991b1b;background:#fecaca;border-color:rgba(220,38,38,.35);outline:none}
.icon-btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.icon-btn.primary:hover,.icon-btn.primary:focus-visible{background:#155ccb;border-color:#0b57d0;outline:none}
.icon-btn[disabled]{opacity:.5;cursor:not-allowed;box-shadow:none;background:#f1f5f9;color:#94a3b8}
.search-scope-toggle{width:32px;height:32px;border-radius:12px}
.search-scope-toggle-icon{display:block;width:18px;height:18px;background-color:currentColor;mask:url('multiple-users-silhouette-svgrepo-com.svg') center/contain no-repeat;-webkit-mask:url('multiple-users-silhouette-svgrepo-com.svg') center/contain no-repeat;transition:background-color var(--dur) var(--ease),transform var(--dur) var(--ease)}
.search-scope-toggle:hover .search-scope-toggle-icon,.search-scope-toggle:focus-visible .search-scope-toggle-icon{transform:scale(1.08)}
.search-scope-toggle[aria-pressed="true"]{color:var(--primary);background:#eef4ff;border-color:rgba(26,115,232,.45)}
.search-scope-toggle[aria-pressed="true"] .search-scope-toggle-icon{background-color:currentColor}
.save-indicator-wrap{margin-left:auto;align-self:flex-start;display:flex;align-items:center;justify-content:flex-end;min-width:28px;position:relative}
.save-indicator{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--muted);opacity:0;transform:scale(.9);transition:opacity var(--dur) var(--ease),transform var(--dur) var(--ease);pointer-events:none}
.save-indicator.active{opacity:1;transform:scale(1)}
.save-indicator svg{width:20px;height:20px;animation:save-spin 900ms linear infinite}

@keyframes save-spin{
  0%{transform:rotate(0)}
  100%{transform:rotate(360deg)}
}

/* Header metrics */
.header-quick{margin-top:8px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.dm-summary{gap:24px}
.dm-summary[hidden]{display:none}
.dm-items-btn{display:inline-flex;align-items:center;gap:8px;padding:6px 8px;border-radius:10px;font-weight:600;font-size:14px;color:var(--muted);cursor:pointer;transition:color var(--dur) var(--ease),background-color var(--dur) var(--ease);background:transparent;border:none}
.dm-items-btn:hover,.dm-items-btn:focus-visible{color:var(--primary);background:#eef4ff;outline:none}
.dm-items-btn[aria-expanded="true"]{color:var(--primary);background:#eef4ff}
.dm-items-icon img{display:block;width:24px;height:24px}
.inventory-buttons{display:flex;align-items:center;gap:clamp(6px,1.8vw,18px);margin-left:auto;flex-wrap:nowrap;min-width:0}
.inventory-link{display:inline-flex;align-items:center;gap:8px;background:transparent;border:none;padding:6px 8px;border-radius:10px;font-weight:600;font-size:14px;color:var(--muted);cursor:pointer;transition:color var(--dur) var(--ease),background-color var(--dur) var(--ease),border-color var(--dur) var(--ease)}
.inventory-link .icon svg,.inventory-link .icon img,.inventory-metric .icon svg{width:24px;height:24px;display:block}
.inventory-link .text,.inventory-metric .text{letter-spacing:.02em}
.inventory-link:hover,.inventory-link:focus-visible{color:var(--primary);background:#eef4ff}
.inventory-link:active{color:#0b57d0;background:#d7e4ff}
.inventory-link:focus-visible{outline:none}
.inventory-metric{display:inline-flex;align-items:center;gap:8px;padding:6px 0;color:var(--muted);font-weight:600;transition:color var(--dur) var(--ease)}
.inventory-metric .text{white-space:nowrap}
.inventory-metric .amount{font-weight:700;color:var(--ink);transition:color var(--dur) var(--ease)}
.dm-items-card{max-width:420px;width:100%}
.dm-items-card .modal-body{display:flex;flex-direction:column;gap:12px;max-height:360px}
.dm-items-list{display:flex;flex-direction:column;gap:10px}
.dm-items-row{display:flex;flex-direction:column;gap:2px;font-size:14px;color:var(--ink);transition:color var(--dur) var(--ease)}
.dm-items-meta{font-size:12px;color:var(--muted);transition:color var(--dur) var(--ease)}
.dm-items-empty{color:var(--muted);transition:color var(--dur) var(--ease)}
@media (max-width:520px){
  .row{flex-wrap:nowrap;gap:10px}
  .header-main{flex:1 1 auto;min-width:0}
  .title-select-group{flex:1 1 auto;width:100%}
  .title-select-wrap{flex:1 1 auto;width:100%}
  .title-select-trigger{width:100%;font-size:clamp(20px,5vw,24px)}
  .header-quick{flex-direction:row;align-items:center;gap:8px;flex-wrap:nowrap;overflow-x:auto;width:100%;scrollbar-width:none}
  .header-quick.dm-summary{gap:8px}
  .header-quick::-webkit-scrollbar{display:none}
  .inventory-buttons{margin-left:0}
  .log-row{flex-direction:column;align-items:flex-start}
  .log-row-chips{align-items:flex-start;gap:6px;margin-top:6px}
}

/* Grid / masonry columns */

/* Card */
.card{display:block;position:relative;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow1);overflow:hidden;transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease),background var(--dur) var(--ease)}
.card:hover{transform:none;box-shadow:var(--shadow1)}
.log-list .card{--row-bg:transparent;--card-highlight-opacity:0;position:relative;margin:0;background:transparent;border:0;border-bottom:1px solid var(--border);border-radius:var(--log-card-radius);box-shadow:none;overflow:visible;transition:border-color var(--dur) var(--ease),box-shadow var(--dur) var(--ease),transform var(--dur) var(--ease),background var(--dur) var(--ease);flex:0 0 auto}
.log-list .card,
.log-list .card::before,
.log-list .card::after{border-radius:0}
.log-list .card.open,
.log-list .card.open::before,
.log-list .card.open::after{border-radius:var(--log-card-radius)}
.log-list .card.editing,
.log-list .card.editing::before,
.log-list .card.editing::after{border-radius:var(--log-card-radius)}
.log-list .card:first-child{border-top:1px solid var(--border)}
.log-list .card::before{content:"";position:absolute;top:-1px;right:-1px;bottom:-1px;left:-1px;pointer-events:none;border-radius:inherit;background:transparent;box-shadow:inset 0 0 0 0 rgba(238,241,247,0);opacity:0;transition:box-shadow var(--dur) var(--ease),opacity var(--dur) var(--ease);z-index:1;will-change:box-shadow,opacity}
.log-list .card::after{content:"";position:absolute;top:-1px;right:-1px;bottom:-1px;left:-1px;background:var(--row-bg);pointer-events:none;transition:background var(--dur) var(--ease),border-color var(--dur) var(--ease);z-index:0;border-radius:inherit;border:3px solid transparent;border-left:0}
.log-list .card>*{position:relative;z-index:1}
.log-list .card:hover{--row-bg:rgba(15,23,42,.03)}
.log-list .card:hover,.log-list .card.open{z-index:1}
.log-list .card.open{--row-bg:rgba(148,163,184,.08);--card-highlight-opacity:1;background:var(--open-card-body);border:1px solid var(--open-card-border);box-shadow:var(--open-card-shadow);transform:none;border-radius:0}
.log-list .card.open .card-hd{background:var(--open-card-header);border-radius:0;border-bottom:1px solid rgba(148,163,184,.18);box-shadow:none}
.log-list .card.open::after{border-color:var(--open-card-border);background:var(--open-card-body);border-radius:0}
.log-list .card.editing::after{border-color:#eef1f7}
.log-list .card.editing .card-hd{background:var(--row-bg,#f1f5f9)}
.log-list .card.editing{--row-bg:rgba(241,245,249,.9)}
.log-list .card.open::before{box-shadow:none;opacity:0;border-radius:0}
.log-list .card.editing::before{box-shadow:inset 3px 0 0 #eef1f7;opacity:1}
.log-list .card .card-hd{padding:8px 18px;display:flex;align-items:flex-start;gap:14px;min-height:0;transition:background var(--dur) var(--ease),border-radius var(--dur) var(--ease),color var(--dur) var(--ease),border-color var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.log-list .card .card-hd .card-tools{margin-left:auto;display:flex;align-items:center;gap:8px}
.log-list .card-bd{border-top:1px solid rgba(148,163,184,.28);padding:0 20px;background:rgba(248,250,252,.85);transition:background-color var(--dur) var(--ease),background var(--dur) var(--ease),border-color var(--dur) var(--ease),color var(--dur) var(--ease)}
.log-list .card.open .card-bd{border-radius:0;background:transparent;border-color:rgba(148,163,184,.2)}
.log-list .card .bd-in{padding:14px 0 16px}
.log-list .card .edit-form{padding:18px 0 24px}
.card:focus-visible{outline:none}
.card.focus-glow{animation:card-focus-glow 1300ms ease-out}
@keyframes card-focus-glow{
  0%{box-shadow:none;background-color:var(--row-bg,#fff)}
  40%{box-shadow:0 0 0 4px rgba(100,116,139,.32);background-color:rgba(148,163,184,.16)}
  100%{box-shadow:none;background-color:var(--row-bg,#fff)}
}
.card-hd{display:flex;align-items:flex-start;justify-content:flex-start;gap:16px;padding:16px 20px;cursor:pointer;min-height:0}
.card-hd .card-tools{display:flex;align-items:center;gap:8px;margin-left:auto;flex-wrap:nowrap}
.card .card-tools .icon-btn{opacity:0;visibility:hidden;pointer-events:none;transform:translateY(-4px);transition:opacity var(--dur) var(--ease),transform var(--dur) var(--ease)}
.card:hover .card-tools .icon-btn,
.card.open .card-tools .icon-btn,
.card.editing .card-tools .icon-btn,
.card .card-tools .icon-btn:focus-visible{opacity:1;visibility:visible;pointer-events:auto;transform:translateY(0)}
.card.editing .card-hd{cursor:default}
.card-actions{position:absolute;top:18px;right:20px;display:flex;justify-content:flex-end;gap:8px;padding:0;z-index:10;opacity:.35;visibility:visible;transform:none;transition:opacity var(--dur) var(--ease),transform var(--dur) var(--ease)}
.card:hover .card-actions,
.card.open .card-actions,
.card.editing .card-actions,
.card .card-actions:focus-within{opacity:1}
.card-actions .card-edit-btn{box-shadow:none}
@media (max-width:520px){
  .card-actions{right:12px}
  .log-row{flex-direction:column;align-items:stretch;gap:12px}
  .log-row-stats{margin-left:0;justify-content:flex-start;width:auto}
}
.card-edit-btn{padding:8px 16px;font-size:13px;border-radius:12px;box-shadow:none;transform:none;transition:background var(--dur) var(--ease),color var(--dur) var(--ease),border-color var(--dur) var(--ease)}
.card-edit-btn:hover{transform:none;box-shadow:none;background:#dbeafe;color:#0b57d0;border-color:rgba(26,115,232,.45)}
.card-edit-btn:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:2px}
.card.editing .card-edit-btn{display:none}
.card.editing{border-color:rgba(148,163,184,.45);box-shadow:var(--card-shadow,0 0 0 2px rgba(15,23,42,.08));background:var(--row-bg,#f8fafc)}
.log-row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;width:100%;min-height:0;flex-wrap:wrap}
.log-row-info{display:flex;flex-direction:column;align-items:flex-start;gap:6px;min-width:0;flex:1 1 320px}
.log-row-main{display:flex;align-items:center;column-gap:12px;row-gap:4px;flex-wrap:wrap;width:100%;min-width:0}
.log-row-main.ticker-active{flex-wrap:nowrap}
.log-row-main.ticker-active .log-row-title{min-width:0}
.log-row-main.ticker-active .log-row-datestats{flex:0 0 auto}
.log-row-main .log-row-title{flex:1 1 auto;min-width:0}
.log-row-datestats{display:flex;align-items:center;gap:6px;flex-wrap:nowrap;min-width:0;margin-left:auto}
.log-row-datestats .log-row-date{flex:1 1 auto;min-width:0}
.log-row-datestats .log-row-stats{margin-left:auto}
.log-row-meta{display:flex;flex-wrap:wrap;gap:6px;align-items:center;color:var(--muted);font-size:12px;line-height:1.4;transition:color var(--dur) var(--ease)}
.log-row-meta-text{display:inline;white-space:normal;font:inherit;margin:0}
.log-row-character{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);flex-wrap:wrap}
.log-row-character-label{font-size:10px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
.log-row-character-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#dcfce7;border:1px solid rgba(74,222,128,.4);color:#15803d;font-size:12px;font-weight:500;text-decoration:none;transition:background-color var(--dur) var(--ease),color var(--dur) var(--ease),border-color var(--dur) var(--ease);line-height:1}
.log-row-character-chip:hover,.log-row-character-chip:focus-visible{background:#bbf7d0;color:#166534;border-color:rgba(34,197,94,.5);outline:none}
.log-row-date{display:inline-flex;align-items:center;gap:6px;color:var(--muted);font-size:12px;line-height:1.4;white-space:nowrap;transition:color var(--dur) var(--ease)}
.log-row-date .display{white-space:nowrap}
.log-row-chips{display:flex;align-items:center;gap:6px;flex-wrap:wrap;width:100%;margin-top:0;min-height:0}
.log-row-chips .log-row-tags{flex:1 1 auto}
.log-row-chips .log-row-stats{margin-left:auto}
.log-row-tags{display:flex;flex-wrap:wrap;gap:6px;width:100%}
.log-row-tags:empty{display:none}
.log-row-stats{margin-left:auto;display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;min-height:0}
@media (max-width:520px){
  .log-row-info{flex:1 1 auto;width:100%}
  .log-row-main{align-items:center;row-gap:4px}
  .log-row-datestats{width:auto;margin-left:auto;flex-wrap:nowrap;justify-content:flex-end}
  .log-row-datestats .log-row-date{flex:0 1 auto;justify-content:flex-end;text-align:right}
  .log-row-stats{margin-left:0;justify-content:flex-start;width:auto}
  .log-row-stats.log-row-stats--mobile{margin-left:auto}
}
.log-row-title{flex:1 1 auto;min-width:0;position:relative;overflow:hidden;display:flex;align-items:center}
.log-row-title .display{display:block;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.35;font-size:14px;transition:color var(--dur) var(--ease)}
.log-row-title.is-adventure .display{font-weight:700}
.dm-card--session .log-row-title .display{font-weight:700}
.log-row-title.is-activity .display{font-weight:400;color:var(--muted)}
@media (prefers-reduced-motion:reduce){
  .log-row-title.scrollable .display{animation:none}
  .log-row-date.scrollable .display{animation:none}
  .char-toggle-text.scrollable{animation:none}
  /* dm cards use shared log-row title styles */
}
.chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:0;min-height:0}
.chip-ticker{position:relative;--chip-ticker-fade-start:rgba(248,250,252,.92)}
.chip-ticker-active{cursor:default}
.chip-ticker::before,.chip-ticker::after{content:none}
@media (max-width:520px){
  .chip-ticker{overflow-x:auto;overflow-y:hidden;flex-wrap:nowrap;-ms-overflow-style:none;scrollbar-width:none}
  .chip-ticker::-webkit-scrollbar{display:none}
  .chip-ticker>*{flex:0 0 auto}
  .chip-ticker-active::before,.chip-ticker-active::after{content:"";position:absolute;top:0;bottom:0;width:12px;pointer-events:none;z-index:1}
  .chip-ticker-active::before{left:0;background:linear-gradient(to right,var(--chip-ticker-fade-start),rgba(255,255,255,0))}
  .chip-ticker-active::after{right:0;background:linear-gradient(to left,var(--chip-ticker-fade-start),rgba(255,255,255,0))}
}
.totals-pill{display:inline-flex;align-items:center;gap:8px;background:rgba(148,163,184,.12);border:1px solid rgba(148,163,184,.24);border-radius:999px;padding:4px 10px;font-size:12px;font-weight:600;color:var(--muted);white-space:nowrap}
.totals-pill-label{display:inline-flex;align-items:center;gap:4px;font-weight:700;color:var(--ink)}
.totals-pill-values{display:inline-flex;align-items:center;gap:8px}
.totals-pill-value{display:inline-flex;align-items:center;gap:4px;font-variant-numeric:tabular-nums}
.totals-pill-value::before{content:"";width:6px;height:6px;border-radius:50%;background:rgba(148,163,184,.45)}
.totals-pill-value.gain{color:#166534}
.totals-pill-value.gain::before{background:#22c55e}
.totals-pill-value.loss{color:#b91c1c}
.totals-pill-value.loss::before{background:#f87171}
.totals-pill-value.neutral{color:var(--muted)}
.totals-pill-value.neutral::before{background:rgba(148,163,184,.6)}
.tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:600;letter-spacing:.03em;text-transform:uppercase;background:rgba(148,163,184,.16);color:var(--muted)}
.tag svg{width:12px;height:12px}
.tag-downtime{background:#e2e8f0;color:#1e293b}
.tag-level{background:#dbeafe;color:#1d4ed8}
.card-link-chip-row{display:none;margin-bottom:16px;justify-content:flex-start}
.card-link-chip{align-self:flex-start}
.card.open .card-link-chip-row{display:flex}
.pill{background:#fff7e6;color:#a05a00;border:1px solid #ffe3b0;border-radius:999px;padding:4px 8px;font-weight:700;font-size:11px}
.btn.pill{background:#fff;color:var(--ink);border:1px solid var(--border);border-radius:999px;box-shadow:none}
.pill-link{display:inline-flex;align-items:center;justify-content:center;gap:6px;appearance:none;font:inherit;font-weight:600;font-size:12px;line-height:1;white-space:nowrap;text-decoration:none;background:#eef4ff;color:#1a73e8;border:1px solid rgba(26,115,232,.35);border-radius:999px;padding:4px 10px;cursor:pointer;box-shadow:none;transition:background var(--dur) var(--ease),color var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.pill-link svg{width:14px;height:14px;display:block;pointer-events:none}
.pill-link:hover{background:#dbeafe;color:#0b57d0;box-shadow:var(--shadow1)}
.pill-link:focus-visible{outline:2px solid rgba(26,115,232,.45);outline-offset:2px}
.card-section{background:rgba(15,23,42,.02);border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:12px;margin-top:12px}
.log-list .card.open .card-section{background:#fff;border-radius:14px;border:1px solid rgba(148,163,184,.18)}
.card-section:first-of-type{margin-top:0}
.card-overview{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-bottom:16px}
.card-overview .field,.card-overview .kvsingle,.card-overview .kv2{margin:0}
.card-section-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
.card-section-title{margin:0;font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
.card-section-content{display:flex;flex-direction:column;gap:16px}
.card-section-content--grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
.card-section--collapsible .card-section-content{display:none}
.card-section--collapsible.open .card-section-content{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
.card-section-toggle{appearance:none;border:none;background:none;font:inherit;font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);display:inline-flex;align-items:center;gap:8px;cursor:pointer;padding:0}
.card-section-toggle::after{content:"";width:10px;height:10px;border:1px solid currentColor;border-radius:2px;transform:rotate(45deg);transition:transform var(--dur) var(--ease)}
.card-section--collapsible.open .card-section-toggle::after{transform:rotate(225deg)}
.card-section-content .field{margin:0}
.card-section-content .kv2{margin:0}
.titleLine{display:flex;flex-direction:column;gap:6px}
.date{color:var(--muted);font-size:13px;line-height:1.35}
.title{font-weight:400;font-size:12px;line-height:1.35;white-space:normal;word-break:break-word}
.subtitle{color:var(--muted);font-size:13px;line-height:1.4;min-height:0;white-space:normal}
.subtitle-row{display:flex;align-items:flex-start;flex-wrap:wrap;gap:8px;margin-top:8px;width:100%;min-height:0}
.subtitle-row .subtitle{margin-top:0}
.subtitle-row .chips{margin-top:0;margin-left:0;justify-content:flex-start}
.card.open .subtitle-row{flex-wrap:wrap;gap:8px}
.card.open .subtitle-row .chips{margin-left:0;justify-content:flex-start}
.log-list .card.open .log-row-title .display{color:var(--ink)}
.log-list .card.open .log-row-meta,.log-list .card.open .log-row-date{color:rgba(15,23,42,.72)}

.dm-card .card-hd{align-items:stretch;position:relative}
.dm-card .tag-dm-session{background:rgba(14,165,233,.18);color:#0369a1}
.dm-card .tag-dm-allocation{background:rgba(129,140,248,.2);color:#4c1d95}
.dm-card .dm-card-metrics{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch;margin-top:4px}
.dm-card .dm-card-metric{display:flex;flex-direction:column;gap:2px;padding:8px 12px;border-radius:14px;background:rgba(148,163,184,.12);min-width:96px}
.dm-card .dm-card-metric-value{font-size:16px;font-weight:700;color:var(--ink);line-height:1.2}
.dm-card .dm-card-metric-label{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
.dm-card .log-row-meta{margin-top:2px}
.dm-card .dm-allocation-chipline{display:inline-flex;flex-wrap:wrap;gap:6px;align-items:center}
.dm-card .dm-allocation-chipline:empty{display:none}
.dm-allocation-editor .card-hd{padding:28px 28px 12px;border-bottom:1px solid var(--border);}
.dm-allocation-editor .dm-allocation-header{display:flex;flex-direction:column;gap:6px;align-items:flex-start;}
.dm-allocation-editor .dm-allocation-header h2{margin:0;font-size:20px;line-height:1.2;font-weight:700;color:var(--ink);}
.dm-allocation-editor .dm-allocation-header p{margin:0;font-size:14px;color:var(--muted);}
.dm-allocation-editor .card-bd{padding:0 28px 28px;}
.dm-allocation-form{display:flex;flex-direction:column;gap:20px;}
.dm-allocation-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;}
.dm-allocation-form .field-group{display:flex;flex-direction:column;gap:6px;}
.dm-allocation-form label{font-weight:600;font-size:13px;color:var(--muted);}
.dm-allocation-form input,.dm-allocation-form select,.dm-allocation-form textarea{border:1px solid var(--border);border-radius:10px;padding:10px 12px;font:inherit;line-height:1.4;background:#fff;transition:border-color var(--dur) var(--ease),box-shadow var(--dur) var(--ease);}
.dm-allocation-form input:focus,.dm-allocation-form select:focus,.dm-allocation-form textarea:focus{outline:none;border-color:rgba(26,115,232,.45);box-shadow:0 0 0 3px rgba(26,115,232,.12);}
.dm-allocation-form textarea{min-height:96px;resize:vertical;}
.dm-allocation-form .field-group.full-width{grid-column:1/-1;}
.dm-allocation-summary-actions{display:flex;justify-content:flex-end;gap:10px;}
.dm-allocation-summary-actions .btn{align-self:flex-start;}
.dm-allocation-inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.dm-allocation-inline .checkbox-label{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);}
.dm-allocation-inline input[type="checkbox"]{width:auto;height:auto;}
.dm-allocation-error{color:var(--danger);font-size:13px;min-height:18px;}
.dm-allocation-error:empty{display:none;}
.dm-allocation-actions{display:flex;justify-content:flex-end;gap:12px;}
.dm-allocation-hint{font-size:12px;color:var(--muted);}
.dm-card .dm-card-metric--hours{background:rgba(59,130,246,.16)}
.dm-card .dm-card-metric--bonus{background:rgba(34,197,94,.18)}
.dm-card .dm-card-metric--levels{background:rgba(249,115,22,.18)}
.dm-card .dm-card-metric--tier{background:rgba(56,189,248,.2)}
.dm-card .dm-card-metric--cost{background:rgba(192,132,252,.22)}
.dm-card .dm-card-metric--spent{background:rgba(248,113,113,.22)}

.dm-card .bd-in.dm-details{display:flex;flex-direction:column;gap:20px}
.dm-card .dm-details-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.dm-card .dm-details-field{margin:0}
.dm-card .dm-details-field .k{font-size:11px;letter-spacing:.08em;text-transform:uppercase}
.dm-card .dm-details-field .v{font-size:14px}

@media (max-width:520px){
  .dm-card .dm-card-metrics{flex-direction:column;align-items:stretch}
  .dm-card .dm-card-metric{min-width:0}
  .dm-card .dm-details-grid{grid-template-columns:1fr}
}

/* Collapsible */
.card-bd{position:relative;height:0;overflow:hidden;border-top:1px solid var(--border);transition:height var(--card-dur,var(--dur)) var(--card-ease,var(--accordion-ease)),opacity calc(var(--card-dur,var(--dur))*0.85) ease;transition-behavior:smooth;padding:0 14px;opacity:0;will-change:height,opacity;contain:layout paint}
.card.open .card-bd{overflow:visible;opacity:1}
.bd-in{padding:12px 0 16px}
.edit-form{padding:12px 0 16px;display:none}
.card.editing .edit-form{display:none}
@media (prefers-reduced-motion:reduce){
  .card-bd{transition:none}
  .char-menu,
  .fab-menu{transition:none;transform:none !important;}
}

/* Fields */
.field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
.field .k{color:var(--muted);font-size:12px;font-weight:400}
.field .v{width:100%}
.field .display{display:block}
.field .editor{display:none}
.card.editing .field .display{display:none}
.card.editing .field .editor{display:block}
.field.inline-field{flex-direction:row;align-items:center;gap:10px;margin:4px 0 0}
.field.inline-field .k{font-size:11px;font-weight:600;letter-spacing:.08em;text-transform:uppercase}
.field.inline-field .v{display:flex;align-items:center;gap:10px;width:auto;flex:1 1 auto}
.field.inline-field .display{display:inline-flex;font-weight:600;color:var(--ink)}
.field.inline-field .editor{display:none}
.card.editing .field.inline-field .editor{display:flex;align-items:center}
.card.editing .field.inline-field .editor > *{flex:1 1 220px;max-width:100%}
.card.editing .field.inline-field input{width:100%;min-width:0}
.card.editing .field.inline-field .editor > input[type="number"]{
  flex:0 0 auto;
  width:6ch;
  min-width:6ch;
  max-width:6ch;
}
.show-when-editing{display:none}
.card.editing .show-when-editing{display:block}
.field.show-when-editing{display:none}
.card.editing .field.show-when-editing{display:flex}
.editable-inline .display{display:inline}
.editable-inline .editor{display:none}
.card:not(.editing) .editable-inline .editor{display:none!important}
.card.editing .editable-inline{width:100%;min-width:0}
.card.editing .editable-inline .display{display:none}
.card.editing .editable-inline .editor{display:flex;width:100%}
.card.editing .editable-inline .editor > *{flex:1 1 auto;width:100%;min-width:0}
.editable-inline .editor input,.editable-inline .editor select{font:inherit;padding:6px 8px;line-height:1.3;border:1px solid var(--border);border-radius:10px;outline:none;background:#fff;max-width:100%;min-width:0;box-shadow:none;min-height:calc(1em + 12px)}
.editable-inline .editor input{min-width:0;max-width:100%}
.card.editing .subtitle-row{flex-wrap:wrap;align-items:flex-start;gap:6px}
.card.editing .subtitle-row .subtitle{width:100%;min-width:0}
.card.editing .subtitle-row .chips{margin-left:0;width:100%;justify-content:flex-start}
.card.editing .activity-line{flex-wrap:wrap;gap:6px}
.card.editing .activity-left{flex-wrap:wrap;white-space:normal;min-width:0}
.card.editing .activity-left .editable-inline{flex:1 1 100%;width:100%}
.card.editing .activity-line .chips{margin-left:0;width:100%;justify-content:flex-start}
.field input,.field textarea,.field select{font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;resize:vertical}
.field textarea{min-height:80px}
.notes-field .v{display:flex;flex-direction:column}
.notes-field .v textarea{max-height:75px;width:100%}
.kv2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:8px 0}
.kvsingle{display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;margin:6px 0}
.kvsingle .k{color:var(--muted);font-size:12px;font-weight:400}
.kvsingle .v{font-weight:400;min-width:0}
.kvsingle .display{display:block}
.kvsingle .editor{display:none;width:100%}
.card.editing .kvsingle .display{display:none}
.card.editing .kvsingle .editor{display:flex}
.card.editing .kvsingle .editor > *{flex:1 1 auto;width:100%;min-width:0}
.kvsingle .editor input,.kvsingle .editor select{font:inherit;padding:4px 6px;border:1px solid var(--border);border-radius:10px;outline:none;background:#fff;max-width:100%;min-width:0;box-shadow:none}
.scrollbox{background:none;border:none;border-radius:0;padding:0;max-height:160px;overflow:auto}
.scrollbox .item{margin:2px 0}
.notesbox{background:none;border:none;border-radius:0;padding:0;max-height:160px;overflow:auto}
.empty{text-align:center;color:var(--muted);padding:40px 0}
.list-editor{display:flex;flex-direction:column;gap:8px}
.list-editor .list{display:flex;flex-direction:column;gap:8px}
.list-editor .list-row{display:flex;align-items:center;gap:8px}
.list-editor .list-row input,.list-editor .list-row select{flex:1 1 auto;font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;min-width:0}
.list-editor .list-row button{width:32px;height:32px;border-radius:10px;border:1px solid rgba(220,38,38,.25);background:#fee2e2;color:var(--danger);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background var(--dur) var(--ease),color var(--dur) var(--ease)}
.list-editor .list-row button:hover{background:#fecaca;color:#991b1b}
.list-editor .list-row button svg{width:16px;height:16px}
.list-editor .add-row{align-self:flex-start;border:1px dashed var(--border);background:#f8fafc;color:var(--primary);border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}
.list-editor .add-row:hover{background:#eef4ff}
.list-editor .list-row select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,currentColor 50%),linear-gradient(135deg,currentColor 50%,transparent 50%);background-position:calc(100% - 16px) calc(50% + 3px),calc(100% - 11px) calc(50% + 3px);background-size:5px 5px;background-repeat:no-repeat;padding-right:28px;cursor:pointer}
.list-editor .list-row select:focus{outline:none;box-shadow:0 0 0 2px rgba(15,23,42,.18)}
.edit-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
.card:not(.editing) .edit-actions{display:none}
.card.editing .edit-actions{display:flex}
.edit-actions .delete-btn{margin-right:auto}

.edit-form form{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.edit-form .field{margin:0}
.edit-form .field.full{grid-column:1 / -1}
.edit-form .field .v input,.edit-form .field .v select,.edit-form .field .v textarea{width:100%}
.edit-form input[type=number]{max-width:6ch}
.edit-form .kv2{grid-column:1 / -1;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:0}
.edit-form .kv2 .kvsingle{margin:0}
.edit-form .kv2 .v{display:flex;align-items:center}
.edit-form .kv2 .v input{flex:0 0 auto;width:6ch}
.edit-form .list-editor{grid-column:1 / -1}
.edit-form .edit-actions{grid-column:1 / -1;margin-top:4px}

.card.editing input,.card.editing textarea,.card.editing select,.card.editing .list-editor .list-row input,.card.editing .list-editor .list-row select{outline:none;box-shadow:none;border-radius:10px;background:#fff}
.card.editing input:focus,.card.editing textarea:focus,.card.editing select:focus,.card.editing .editable-inline .editor input:focus,.card.editing .editable-inline .editor select:focus{outline:none;box-shadow:0 0 0 2px rgba(15,23,42,.18)}

body.modal-open{overflow:hidden;}
body.modal-open #addCard{display:none;}
body.modal-open #addCardMenu{display:none;}

#addCard{
  position:fixed;
  bottom:24px;
  right:24px;
  width:64px;
  height:64px;
  border-radius:50%;
  border:none;
  background:linear-gradient(135deg,#ff8a5c,#ff3d71);
  color:#fff;
  box-shadow:0 16px 30px rgba(255,61,113,.35);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease);
  z-index:60;
}
#addCard svg{width:28px;height:28px}
#addCard:hover{transform:translateY(-2px);box-shadow:0 24px 40px rgba(255,61,113,.45)}
#addCard:focus-visible{outline:3px solid rgba(255,61,113,.4);outline-offset:4px}
.toolbar #addCard{margin-left:auto}

.fab-menu{position:fixed;right:24px;bottom:100px;display:flex;flex-direction:column;gap:6px;min-width:200px;padding:8px 0;border-radius:12px;background:#fff;box-shadow:var(--shadow2);border:1px solid var(--border);z-index:65;opacity:0;transform:translateY(6px) scale(.98);pointer-events:none;visibility:hidden;transition:opacity var(--menu-dur,var(--dur)) var(--ease),transform var(--menu-dur,var(--dur)) var(--ease);will-change:opacity,transform}
.fab-menu[data-menu-state]{visibility:visible}
.fab-menu[data-menu-state='opening']{opacity:0;transform:translateY(6px) scale(.98)}
.fab-menu[data-menu-state='open']{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
.fab-menu[data-menu-state='closing']{opacity:0;transform:translateY(6px) scale(.98);pointer-events:none}
.fab-menu[hidden]{display:none}
.fab-menu button{padding:10px 16px;text-align:left;background:none;border:none;font:inherit;color:var(--ink);cursor:pointer;transition:background-color var(--dur) var(--ease),color var(--dur) var(--ease),border-color var(--dur) var(--ease);display:flex;align-items:center;gap:10px}
.fab-menu button:hover,.fab-menu button:focus-visible{background:#eef4ff;color:var(--primary);outline:none}

/* Activity cards (compact header) */
.pill.muted{background:#eef1f6;color:#475569;border-color:#dce2ee}

/* Modals (shared) */
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(15,23,42,.4);z-index:50}
.modal.open{display:grid}
.modal-card{width:min(92vw,800px);max-height:80vh;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow2);display:flex;flex-direction:column;overflow:hidden}
.modal-hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700;display:flex;align-items:center;justify-content:space-between;gap:8px}
.modal-body{padding:12px 16px;overflow:auto}
.modal-actions{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
.inv-meta{color:var(--muted);font-size:12px}
.inv-list{display:flex;flex-direction:column;gap:6px}
.modal-add{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.modal-add input,.modal-add select{font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
.modal-add button{border:1px solid var(--primary);background:rgba(26,115,232,.1);color:var(--primary);border-radius:10px;padding:8px 14px;font-weight:600;cursor:pointer}
.modal-add button:hover{background:rgba(26,115,232,.2)}

/* Inventory row styles */
.inv-row{display:grid;grid-template-columns:1fr auto;align-items:center;padding:6px 10px;border-radius:8px;cursor:pointer;transition:background .2s;column-gap:18px}
.inv-row:nth-child(odd){background:#fafbfc}
.inv-row:nth-child(even){background:#f2f5f8}
.inv-row.active{font-weight:600;background:var(--gift-active-bg,#e8f0ff);color:var(--gift-active-fg,inherit)}
.inv-row.active--blessing{--gift-active-bg:#dbeafe}
.inv-row.active--boon{--gift-active-bg:#fef3c7}
.inv-row.active--resistance{--gift-active-bg:#e5e7eb}
.inv-row.common .inv-label{font-weight:600}
.inv-row.static{cursor:default}
.inv-name{display:flex;align-items:center;gap:8px;min-width:0;overflow:hidden}
.inv-name .inv-label{flex:1 1 auto;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.trade-card{max-width:520px}
.trade-form{display:flex;flex-direction:column;gap:14px}
.trade-field{display:flex;flex-direction:column;gap:6px}
.trade-field label,.trade-field .trade-field-label{font-size:13px;font-weight:600;color:var(--muted)}
.trade-item-label{font-size:16px;font-weight:600}
.trade-partner-custom{display:grid;gap:12px}
.trade-error{color:var(--danger);font-size:13px;margin:4px 0 0}
.trade-error[hidden]{display:none}
.trade-field input,.trade-field select{border:1px solid var(--border);border-radius:10px;padding:9px 12px;font:inherit}
.trade-field input:focus-visible,.trade-field select:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:2px}
.inv-name.consumable-name{display:flex;flex-direction:column;align-items:flex-start;gap:4px;min-width:0}
.inv-name.consumable-name .cons-primary{display:flex;align-items:center;gap:6px;flex-wrap:nowrap;min-width:0}
.inv-name.consumable-name .cons-name{display:block;font-weight:600;min-width:0;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1 1 auto}
.inv-name.consumable-name .cons-chips{display:inline-flex;flex-wrap:nowrap;gap:6px;margin-left:6px;flex:0 0 auto}
.inv-tools{display:flex;align-items:center;gap:6px}
.inv-row .delete-btn{display:none;margin-left:8px}
.modal.editing .inv-row{cursor:default}
.modal.editing .inv-row .delete-btn{display:inline-flex}
.modal.editing .inv-row .attune-pill{pointer-events:none;opacity:.6}
.modal.editing .inv-row .common-chip{pointer-events:none;opacity:.6}
.modal.editing .inv-row .qty-icon{pointer-events:none;opacity:.6}
.modal.editing .inv-row .qty-pill{opacity:.6}

/* Attunement pill (perm modal, active rows only) */
.attune-pill{display:inline-block;border:1px solid #cfe0ff;background:#eef4ff;color:#1a73e8;border-radius:999px;padding:2px 8px;font-size:11px;user-select:none;cursor:pointer;transition:background .2s,color .2s}
.attune-pill.on{background:#1a73e8;color:#fff}

/* Common item toggle */
.common-chip{appearance:none;display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border:1px solid rgba(148,163,184,.45);background:#f1f5f9;color:#475569;border-radius:50%;padding:0;font-size:11px;font-weight:700;text-transform:none;letter-spacing:0;line-height:1;cursor:pointer;user-select:none;transition:background var(--dur) var(--ease),color var(--dur) var(--ease),border-color var(--dur) var(--ease)}
.common-chip>[aria-hidden]{display:inline-flex;align-items:center;justify-content:center;width:100%;height:100%}
.common-chip:hover,.common-chip:focus-visible{background:#e2e8f0;border-color:#94a3b8;color:#334155;outline:none}
.common-chip.on{background:#475569;color:#f8fafc;border-color:#475569}
.common-chip.on:hover,.common-chip.on:focus-visible{background:#334155;border-color:#334155;color:#f8fafc}
.common-chip:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:2px}
.inv-name .common-chip{margin-left:auto}

/* Consumables qty controls */
.inv-row .qty{display:flex;align-items:center;gap:8px;white-space:nowrap}
.qty-pill{display:inline-block;min-width:28px;padding:2px 8px;text-align:center;border:1px solid var(--border);border-radius:999px;background:#f9fafb;font-size:11px;color:#475569}
.qty-input{width:64px;padding:4px 8px;border:1px solid var(--border);border-radius:10px;font:inherit;font-size:12px;text-align:center;background:#fff}
.qty-icon{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;color:#1e3a8a;background:transparent;cursor:pointer;transition:color var(--dur) var(--ease),transform var(--dur) var(--ease)}
.qty-icon svg{width:22px;height:22px;stroke-width:1.8}
.qty-icon:hover{color:#1a73e8;transform:translateY(-1px)}
.qty-icon:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:3px}
.qty-icon.disabled{opacity:.35;cursor:not-allowed;transform:none}
.qty-icon.disabled:hover{color:inherit}
.cons-section{display:flex;flex-direction:column;gap:6px;padding:2px 0}
.cons-section+.cons-section{margin-top:16px}
.cons-section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);padding:0 4px}
.cons-sublist{display:flex;flex-direction:column;gap:6px}
.cons-name{display:block;font-weight:600}
.cons-chips{display:inline-flex;gap:6px;margin-left:6px;flex-wrap:wrap;align-items:center}
.cons-chip{display:inline-flex;align-items:center;justify-content:center;padding:2px 6px;border-radius:999px;background:#eef4ff;color:#1e3a8a;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em}
.cons-chip--potion{background:#fef3c7;color:#b45309}
.cons-chip--scroll{background:#ede9fe;color:#5b21b6}
.cons-secondary{display:block;margin-top:3px;font-size:11px;color:var(--muted);white-space:normal}
.gifts-sublist{display:flex;flex-direction:column;gap:6px}
.gifts-list-note{font-size:12px;color:var(--muted);padding:0 4px}
.gift-note{font-size:11px;color:var(--muted)}

.data-quality-banner{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px;padding:14px 18px;border-radius:16px;background:rgba(254,242,242,.75);border:1px solid rgba(220,38,38,.25);box-shadow:var(--shadow1);color:#991b1b}
.data-quality-banner[hidden]{display:none}
.data-quality-banner__content{display:flex;align-items:flex-start;gap:12px}
.data-quality-banner__icon{flex:0 0 auto;width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#fee2e2;color:#b91c1c;font-weight:700;font-size:16px}
.data-quality-banner__text{display:flex;flex-direction:column;gap:2px}
.data-quality-banner__title{margin:0;font-weight:700;font-size:15px;color:#991b1b}
.data-quality-banner__summary{margin:0;font-size:13px;color:#b91c1c}
.data-quality-banner__actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.data-quality-banner__actions .btn{white-space:nowrap}
.data-quality-issues{display:flex;flex-direction:column;gap:14px}
.data-quality-issue{border:1px solid var(--border);border-radius:14px;padding:14px;background:#fff;display:flex;flex-direction:column;gap:10px}
.data-quality-issue[data-severity="error"]{border-color:rgba(220,38,38,.35);background:rgba(254,242,242,.6)}
.data-quality-issue[data-severity="warning"]{border-color:rgba(234,179,8,.35);background:rgba(254,249,195,.6)}
.data-quality-issue__header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.data-quality-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
.data-quality-badge--error{background:rgba(220,38,38,.18);color:#991b1b}
.data-quality-badge--warning{background:rgba(234,179,8,.2);color:#92400e}
.data-quality-location{font-size:12px;color:var(--muted)}
.data-quality-message{margin:0;font-size:14px;color:var(--ink);white-space:pre-wrap}
.data-quality-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.data-quality-empty{margin:0;font-size:14px;color:var(--muted)}
.data-quality-card .modal-body{max-height:420px;display:flex;flex-direction:column;gap:12px}

/* Reduce scroll anchoring jumps */
html,body,.log-list,.card-bd{overflow-anchor:none}

/* New entry overlay */
.card-overlay{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(15,23,42,.4);backdrop-filter:blur(2px);z-index:70;padding:48px 16px;overflow:auto}
.card-overlay.open{display:flex}
.card-overlay .card{max-width:880px;width:100%;box-shadow:var(--shadow2);margin:0 auto}
.card-overlay .card .card-section{background:#fff;border:1px solid rgba(148,163,184,.25)}
@media (min-width:1200px){
  .card-overlay .card{max-width:960px}
}
.card-overlay .card .card-tools{display:none}
.avatar-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.7);backdrop-filter:blur(2px);z-index:80;padding:24px;overflow:hidden}
.avatar-overlay.open{display:flex}
.avatar-overlay .avatar-preview{display:flex;align-items:center;justify-content:center;max-width:calc(100vw - 48px);max-height:calc(100vh - 48px);width:100%;height:100%}
.avatar-overlay .avatar-preview img{display:block;width:auto;height:auto;max-width:100%;max-height:100%;filter:drop-shadow(0 40px 90px rgba(15,23,42,.6))}
.avatar-overlay{cursor:zoom-out}
body.avatar-overlay-open{overflow:hidden}
</style>
</head>
<body>
<div class="app-shell">
  <div class="app-main">
    <div class="container">
      <aside id="dataQualityBanner" class="data-quality-banner" hidden aria-live="polite">
        <div class="data-quality-banner__content">
          <div class="data-quality-banner__icon" aria-hidden="true">!</div>
          <div class="data-quality-banner__text">
            <p class="data-quality-banner__title">Data issues detected</p>
            <p id="dataQualitySummary" class="data-quality-banner__summary">Data validation found problems that need your attention.</p>
          </div>
        </div>
        <div class="data-quality-banner__actions">
          <button id="dataQualityReviewBtn" class="btn small primary" type="button">Review issues</button>
        </div>
      </aside>
      <section class="sheet-card">
    <div class="sheet-card-header">
      <div class="row">
        <img id="charAvatar" class="avatar" alt="Character avatar"/>
        <div class="header-main">
          <div class="title-select-group">
            <label id="charSelToggleLabel" for="charSelToggle" class="sr-only">Select a sheet or character</label>
            <h1 class="title-select-wrap" id="charTitle">
              <button id="charSelToggle" class="title-select-trigger" type="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="charSelMenu" aria-labelledby="charSelToggleLabel charSelDisplay">
                <span id="charSelDisplay" class="char-toggle-text">Select a character</span>
                <span class="char-toggle-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m6 9 6 6 6-6" />
                  </svg>
                </span>
              </button>
              <select id="charSel" class="title-select" aria-hidden="true" tabindex="-1"></select>
            </h1>
          </div>
          <div id="charMeta" class="char-meta muted" aria-live="polite"></div>
          <div id="charBadges" class="char-badges" aria-live="polite"></div>
        </div>
        <div id="saveIndicatorWrap" class="save-indicator-wrap">
          <div id="saveIndicator" class="save-indicator" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="9" stroke-opacity=".3"/>
              <path d="M21 12a9 9 0 0 0-9-9"/>
            </svg>
          </div>
          <span id="saveStatusMessage" class="sr-only" aria-live="polite"></span>
        </div>
      </div>
      <div class="toolbar toolbar-layout">
        <div class="toolbar-primary">
          <div class="search">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/></svg>
            <input id="q" placeholder="Search adventures"/>
            <button id="qClear" class="search-clear" type="button" aria-label="Clear search" hidden>
              <img src="close.png" alt="" width="16" height="16" decoding="async" aria-hidden="true" />
            </button>
          </div>
          <button id="searchScopeToggle" class="icon-btn search-scope-toggle" type="button" aria-pressed="false" aria-label="Show entries from the selected character only" title="Show entries from the selected character only">
            <span class="search-scope-toggle-icon" aria-hidden="true"></span>
          </button>
          <button id="activityToggle" class="btn small pill" type="button" aria-pressed="false">Hide activities</button>
          <button id="addCard" title="Add new entry" aria-label="Add new entry" type="button" aria-haspopup="true" aria-expanded="false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
          </button>
        </div>
        <div class="header-quick" id="headerQuick">
          <div class="inventory-buttons">
            <button id="magicItemsBtn" class="inventory-link" type="button" title="View permanent magic items" aria-label="View permanent magic items">
              <span class="icon" aria-hidden="true">
                <img src="chest.png" alt="" width="24" height="24"/>
              </span>
              <span class="sr-only" id="magicItemsCount">0</span>
            </button>
            <button id="consumablesBtn" class="inventory-link" type="button" title="View consumables" aria-label="View consumables">
              <span class="icon" aria-hidden="true">
                <img src="potion.png" alt="" width="24" height="24"/>
              </span>
              <span class="sr-only" id="consumablesCount">0</span>
            </button>
            <button id="giftsBtn" class="inventory-link" type="button" title="View supernatural gifts" aria-label="View supernatural gifts">
              <span class="icon" aria-hidden="true">
                <img src="gift-icon.png" alt="" width="24" height="24"/>
              </span>
              <span class="sr-only" id="giftsCount">0</span>
            </button>
          </div>
          <div class="inventory-metric" id="goldMetric" role="group" aria-label="Gold pieces total">
            <span class="amount" id="goldValue">0</span>
            <span class="text">GP</span>
          </div>
          <div class="inventory-metric" id="downtimeMetric" role="group" aria-label="Downtime days total">
            <span class="amount" id="downtimeValue">0</span>
            <span class="text">DTD</span>
          </div>
        </div>
        <div class="header-quick dm-summary" id="dmSummaryBar" hidden aria-hidden="true">
          <div class="inventory-buttons">
            <button id="dmItemsBtn" class="inventory-link dm-items-btn" type="button" aria-haspopup="dialog" aria-controls="dmItemsModal" aria-expanded="false" title="View unallocated pre-Season 11 magic items">
              <span class="icon dm-items-icon" aria-hidden="true">
                <img src="chest.png" alt="" width="24" height="24"/>
              </span>
              <span class="sr-only" id="dmItemsLabel">View unallocated pre-Season 11 magic items</span>
            </button>
            <div class="inventory-metric" id="dmHoursMetric" role="group" aria-label="Available Dungeon Master hours">
              <span class="amount" id="dmHoursValue">0</span>
              <span class="text">Hours</span>
            </div>
            <div class="inventory-metric" id="dmLevelsMetric" role="group" aria-label="Available Dungeon Master levels">
              <span class="amount" id="dmLevelsValue">0</span>
              <span class="text">Levels</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="charSelMenu" class="char-menu" role="listbox" aria-labelledby="charSelToggle" aria-hidden="true" hidden></div>
    <div class="sheet-card-body">
      <div class="log-window">
        <div id="grid" class="log-list"></div>
        <div id="empty" class="empty" style="display:none;">No adventures match your filters.</div>
      </div>
    </div>
      </section>
    </div>
  </div>
</div>

<div id="addCardMenu" class="fab-menu" role="menu" hidden aria-hidden="true"></div>

<div id="dmItemsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dmItemsTitle">
  <div class="modal-card dm-items-card">
    <div class="modal-hd">
      <div id="dmItemsTitle">Pre-Season 11 magic items</div>
    </div>
    <div class="modal-body">
      <div id="dmItemsList" class="dm-items-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn small" id="dmItemsClose" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Permanent Items Modal -->
<div id="invModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="invTitle">
  <div class="modal-card">
    <div class="modal-hd">
      <div id="invTitle">Permanent Magic Items</div>
      <div class="inv-meta" id="invMeta"></div>
    </div>
    <div class="modal-body">
      <div id="invSummary" class="inv-meta" style="margin-bottom:8px;"></div>
      <div id="invList" class="inv-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="invClose">Close</button>
    </div>
  </div>
</div>

<!-- Consumables Modal -->
<div id="consModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="consTitle">
  <div class="modal-card">
    <div class="modal-hd">
      <div id="consTitle">Consumables</div>
      <div class="inv-meta" id="consMeta"></div>
    </div>
    <div class="modal-body">
      <div id="consSummary" class="inv-meta" style="margin-bottom:8px;"></div>
      <div id="consList" class="inv-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="consClose">Close</button>
    </div>
  </div>
</div>

<!-- Supernatural Gifts Modal -->
<div id="giftsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="giftsTitle">
  <div class="modal-card">
    <div class="modal-hd">
      <div id="giftsTitle">Supernatural Gifts</div>
      <div class="inv-meta" id="giftsMeta"></div>
    </div>
    <div class="modal-body">
      <div id="giftsSummary" class="inv-meta" style="margin-bottom:8px;"></div>
      <div id="giftsList" class="inv-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="giftsClose">Close</button>
    </div>
  </div>
</div>

<!-- Trade Modal -->
<div id="tradeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="tradeTitle">
  <div class="modal-card trade-card">
    <div class="modal-hd">
      <div id="tradeTitle">Trade item</div>
    </div>
    <div class="modal-body">
      <div id="tradeMeta" class="inv-meta"></div>
      <form id="tradeForm" class="trade-form" novalidate>
        <div class="trade-field">
          <span class="trade-field-label">Trading away</span>
          <div id="tradeItemName" class="trade-item-label" role="text"></div>
        </div>
        <div class="trade-field">
          <label for="tradeReceiveInput">Item received</label>
          <input id="tradeReceiveInput" type="text" placeholder="Describe the item you received" autocomplete="off"/>
        </div>
        <div class="trade-field">
          <label for="tradeDateInput">Trade date</label>
          <input id="tradeDateInput" type="date" autocomplete="off"/>
        </div>
        <div class="trade-field">
          <label for="tradePartnerSelect">Trade partner</label>
          <select id="tradePartnerSelect"></select>
        </div>
        <div id="tradePartnerCustom" class="trade-partner-custom" hidden>
          <div class="trade-field">
            <label for="tradePartnerCharacter">Partner character</label>
            <input id="tradePartnerCharacter" type="text" placeholder="Character name" autocomplete="off"/>
          </div>
          <div class="trade-field">
            <label for="tradePartnerPlayer">Partner player</label>
            <input id="tradePartnerPlayer" type="text" placeholder="Player name (optional)" autocomplete="off"/>
          </div>
        </div>
        <p id="tradeError" class="trade-error" role="alert" hidden></p>
      </form>
    </div>
    <div class="modal-actions">
      <button class="btn" id="tradeCancel" type="button">Cancel</button>
      <button class="btn primary" id="tradeSubmit" type="submit" form="tradeForm">Complete trade</button>
    </div>
  </div>
</div>

<div id="dataQualityModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dataQualityTitle" tabindex="-1">
  <div class="modal-card data-quality-card">
    <div class="modal-hd">
      <div id="dataQualityTitle">Data quality review</div>
    </div>
    <div class="modal-body">
      <div id="dataQualityIssueContainer" class="data-quality-issues" role="list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn small" id="dataQualityValidateBtn" type="button">Re-run validation</button>
      <button class="btn small" id="dataQualityCloseBtn" type="button">Close</button>
    </div>
  </div>
</div>

<div id="cardOverlay" class="card-overlay" role="dialog" aria-modal="true" aria-hidden="true"></div>
<div id="avatarOverlay" class="avatar-overlay" role="dialog" aria-modal="true" aria-hidden="true" tabindex="-1">
  <div class="avatar-preview">
    <img class="avatar-preview-image" alt="Character avatar"/>
  </div>
</div>

<script src="legacy-data-loader.js"></script>
<script src="data-pipeline.js"></script>
<script id="dataScript" data-loader="data">
const KEY='al_logs_data_version';
window.AL_DATA_VERSION_KEY=KEY;
let version='';
try{ version=localStorage.getItem(KEY)||''; }
catch(err){ version=''; }
if(!version){
  try{ version=sessionStorage.getItem(KEY)||''; }
  catch(err){ version=''; }
}
window.AL_DATA_VERSION=version;
const cacheBust=String(Date.now());
window.AL_DATA_CACHE_BUST=cacheBust;
const scriptEl=document.getElementById('dataScript')||document.querySelector('script[data-loader="data"]');

const DATA_BOOT_DIAG=initBootstrapDiagnostics({
  key:KEY,
  version,
  cacheBust,
  scriptEl
});

function initBootstrapDiagnostics({key,version,cacheBust,scriptEl}){
  const hasWindow=typeof window!=='undefined';
  const diag={
    startedAt:safeIsoTimestamp(),
    initialVersion:version||'',
    cacheBustToken:cacheBust||'',
    stored:{
      local:hasWindow?readStorageSafe(()=>window.localStorage&&window.localStorage.getItem(key)):null,
      session:hasWindow?readStorageSafe(()=>window.sessionStorage&&window.sessionStorage.getItem(key)):null
    },
    script:{
      id:scriptEl?scriptEl.id||null:null,
      hasSrc:!!(scriptEl&&scriptEl.src),
      type:scriptEl?scriptEl.type||null:null
    },
    steps:[],
    status:'pending'
  };
  if(hasWindow){
    window.__AL_DATA_BOOTSTRAP_DIAG__=diag;
  }
  return diag;
}

function safeIsoTimestamp(){
  try{
    return new Date().toISOString();
  }catch(err){
    return String(Date.now());
  }
}

function readStorageSafe(fn){
  try{
    const value=fn();
    return value==null?null:String(value);
  }catch(err){
    return { error: err && err.message ? err.message : String(err) };
  }
}

function pushDiagStep(event,detail){
  if(!DATA_BOOT_DIAG||!DATA_BOOT_DIAG.steps) return;
  try{
    DATA_BOOT_DIAG.steps.push({
      event:String(event||'unknown'),
      detail:detail&&typeof detail==='object'?{...detail}:detail,
      ts:Date.now()
    });
  }catch(err){
    /* no-op */
  }
}

function snapshotLegacyScript(){
  if(typeof document==='undefined') return null;
  const legacy=document.querySelector('script[data-loader="legacy-data"]');
  if(!legacy) return null;
  return {
    src:legacy.src||null,
    dataset:{
      version:legacy.dataset?legacy.dataset.version||null:null,
      cacheBust:legacy.dataset?legacy.dataset.cacheBust||legacy.dataset.cachebust||null:null
    },
    readyState:legacy.readyState||null
  };
}

pushDiagStep('bootstrap-script-start',{
  hasWindow:typeof window!=='undefined',
  hasDocument:typeof document!=='undefined'
});

function shouldRetryAppInit(error){
  if(!error) return false;
  const name=error&&error.name?String(error.name):'';
  if(name && name!=='ReferenceError') return false;
  const message=error&&error.message?String(error.message):String(error);
  return message.includes('__appInitialized');
}

function scheduleAppInit({attempts=10,delay=60}={}){
  if(typeof window==='undefined') return;
  const invoke=()=>{
    if(typeof window.tryInitApp!=='function') return false;
    try{
      return window.tryInitApp();
    }catch(err){
      if(shouldRetryAppInit(err)) return false;
      throw err;
    }
  };
  if(invoke()) return;
  if(attempts<=0) return;
  setTimeout(()=>{
    try{
      scheduleAppInit({attempts:attempts-1,delay});
    }catch(err){
      console.error('Adventure Log bootstrap retry failed', err);
    }
  },delay);
}

function resolveLegacyLoader(){
  if(typeof window==='undefined') return null;
  const loaderHost=window.AL_LEGACY_LOADER||{};
  const loader=typeof loaderHost.loadLegacyData==='function'?loaderHost.loadLegacyData:null;
  pushDiagStep('legacy-loader-resolve',{ available:!!loader });
  return loader;
}

async function bootstrapData(){
  const loadLegacyData=resolveLegacyLoader();
  if(!loadLegacyData){
    throw new Error('Legacy data loader is unavailable.');
  }
  pushDiagStep('legacy-load-start',{ version:version||'', cacheBust });
  try{
    const { data, raw, versionToken } = await loadLegacyData({ version, cacheBust });
    pushDiagStep('legacy-load-success',{
      versionToken:versionToken||null,
      characters: data && data.characters ? Object.keys(data.characters).length : 0,
      hasRaw: !!raw
    });
    window.RAW_DATA = raw;
    window.DATA = data;
    window.AL_DATA_VERSION = versionToken || version || window.AL_DATA_VERSION || '';
    if(DATA_BOOT_DIAG){
      DATA_BOOT_DIAG.status='success';
      DATA_BOOT_DIAG.finalVersion=window.AL_DATA_VERSION||'';
      DATA_BOOT_DIAG.legacyScript=snapshotLegacyScript();
    }
    if(scriptEl){
      if(versionToken){ scriptEl.setAttribute('data-version', versionToken); }
      scriptEl.setAttribute('data-cache-bust', cacheBust);
      scriptEl.dispatchEvent(new Event('load'));
    }
    scheduleAppInit();
  }catch(error){
    console.error('Failed to load data.js', error);
    if(DATA_BOOT_DIAG){
      DATA_BOOT_DIAG.status='error';
      DATA_BOOT_DIAG.errorMessage=error&&error.message?error.message:String(error);
      DATA_BOOT_DIAG.errorStack=error&&error.stack?String(error.stack):null;
      DATA_BOOT_DIAG.legacyScript=snapshotLegacyScript();
      pushDiagStep('legacy-load-error',{
        message:DATA_BOOT_DIAG.errorMessage,
        stack:DATA_BOOT_DIAG.errorStack
      });
    }
    if(scriptEl){
      const evt=new Event('error');
      scriptEl.dispatchEvent(evt);
    }
  }
  pushDiagStep('bootstrap-script-finished',{ status:DATA_BOOT_DIAG?DATA_BOOT_DIAG.status:null });
}

bootstrapData();
</script>
<script src="dmData.js"></script>
<script>
/* --- data boot --- */
let DATA = window.DATA || null;
let dataNormalized = false;
let pipelineWarned = false;

/* --- DOM handles --- */
const appMainEl = document.querySelector('.app-main');
const sheetHeaderEl = document.querySelector('.sheet-card-header');
const charSel  = document.getElementById('charSel');
const charSelToggle = document.getElementById('charSelToggle');
const charSelMenu = document.getElementById('charSelMenu');
const charSelDisplay = document.getElementById('charSelDisplay');
const DEFAULT_CHARACTER_MENU_LABEL='Select a character';
const CHAR_MENU_GAP = 12;
const CHAR_MENU_VIEWPORT_PADDING = 16;
const avatarEl = document.getElementById('charAvatar');
const saveIndicator = document.getElementById('saveIndicator');
const saveIndicatorWrap = document.getElementById('saveIndicatorWrap');
const saveStatusMessage = document.getElementById('saveStatusMessage');
const qEl      = document.getElementById('q');
const searchClearBtn = document.getElementById('qClear');
const grid     = document.getElementById('grid');
const emptyEl  = document.getElementById('empty');
const badgesEl = document.getElementById('charBadges');
const metaEl   = document.getElementById('charMeta');
const characterSidebarList = document.getElementById('characterSidebarList');
const characterSidebarEmpty = document.getElementById('characterSidebarEmpty');
const inventorySidebarContent = document.getElementById('inventorySidebarContent');
const inventorySidebarEmpty = document.getElementById('inventorySidebarEmpty');
const inventorySidebarMagicList = document.getElementById('inventorySidebarMagicList');
const inventorySidebarMagicCount = document.getElementById('inventorySidebarMagicCount');
const inventorySidebarConsumableList = document.getElementById('inventorySidebarConsumableList');
const inventorySidebarConsumableCount = document.getElementById('inventorySidebarConsumableCount');
const inventorySidebarActiveList = document.getElementById('inventorySidebarActiveList');
const inventorySidebarActiveEmpty = document.getElementById('inventorySidebarActiveEmpty');
const inventorySidebarActiveSummary = document.getElementById('inventorySidebarActiveSummary');
const inventorySidebarMagicManageBtn = document.getElementById('inventorySidebarMagicManage');
const inventorySidebarConsumableManageBtn = document.getElementById('inventorySidebarConsumableManage');
const addCardBtn = document.getElementById('addCard');
const addCardMenu = document.getElementById('addCardMenu');
const searchScopeToggleBtn = document.getElementById('searchScopeToggle');
const activityToggleBtn = document.getElementById('activityToggle');
const headerQuick = document.getElementById('headerQuick');
const dmSummaryBar = document.getElementById('dmSummaryBar');
const dmTotalsPill = document.getElementById('dmTotalsMetric');
const dmHoursValueEl = document.getElementById('dmHoursValue');
const dmLevelsValueEl = document.getElementById('dmLevelsValue');
const dmItemsBtnEl = document.getElementById('dmItemsBtn');
const dmItemsModal = document.getElementById('dmItemsModal');
const dmItemsListEl = document.getElementById('dmItemsList');
const dmItemsCloseBtn = document.getElementById('dmItemsClose');
const dataQualityBanner = document.getElementById('dataQualityBanner');
const dataQualitySummaryEl = document.getElementById('dataQualitySummary');
const dataQualityReviewBtn = document.getElementById('dataQualityReviewBtn');
const dataQualityModal = document.getElementById('dataQualityModal');
const dataQualityIssueContainer = document.getElementById('dataQualityIssueContainer');
const dataQualityCloseBtn = document.getElementById('dataQualityCloseBtn');
const dataQualityValidateBtn = document.getElementById('dataQualityValidateBtn');
const characterSidebarButtons=new Map();
const inventorySidebarManageButtons=[
  inventorySidebarMagicManageBtn,
  inventorySidebarConsumableManageBtn
];
const cardOverlay=document.getElementById('cardOverlay');
const avatarOverlay=document.getElementById('avatarOverlay');
const avatarPreview=avatarOverlay?avatarOverlay.querySelector('.avatar-preview'):null;
const avatarPreviewImage=avatarOverlay?avatarOverlay.querySelector('.avatar-preview-image'):null;
const avatarSizeCache=new Map();
const dataScriptEl=document.getElementById('dataScript');
const DATA_VERSION_KEY=window.AL_DATA_VERSION_KEY||'al_logs_data_version';
let charMenuRafId=null;
let removeCharMenuAutoPosition=null;
let dataVersion=(dataScriptEl&&dataScriptEl.getAttribute('data-version'))||window.AL_DATA_VERSION||'';
window.AL_DATA_VERSION=dataVersion;
let dataCacheBust=(dataScriptEl&&dataScriptEl.getAttribute('data-cache-bust'))||window.AL_DATA_CACHE_BUST||'';
window.AL_DATA_CACHE_BUST=dataCacheBust;
const DATA_DRAFT_STORAGE_KEY='al_logs_data_draft_v1';
if(avatarEl){
  avatarEl.tabIndex=-1;
  avatarEl.addEventListener('click',evt=>{
    if(!avatarEl.classList.contains('has-avatar')) return;
    evt.preventDefault();
    openAvatarOverlay();
  });
  avatarEl.addEventListener('keydown',evt=>{
    if(!avatarEl.classList.contains('has-avatar')) return;
    if(evt.key==='Enter'||evt.key===' '){
      evt.preventDefault();
      openAvatarOverlay();
    }
  });
  avatarEl.addEventListener('load',onAvatarElementLoad);
}
const goldMetricEl=document.getElementById('goldMetric');
const goldValueEl=document.getElementById('goldValue');
const downtimeMetricEl=document.getElementById('downtimeMetric');
const downtimeValueEl=document.getElementById('downtimeValue');
const magicItemsBtn=document.getElementById('magicItemsBtn');
const consumablesBtn=document.getElementById('consumablesBtn');
const giftsBtn=document.getElementById('giftsBtn');
const magicItemsCountEl=document.getElementById('magicItemsCount');
const consumablesCountEl=document.getElementById('consumablesCount');
const giftsCountEl=document.getElementById('giftsCount');
const giftsMetricEl=document.getElementById('giftsMetric');
const giftsValueEl=document.getElementById('giftsValue');
const defaultEmptyMessage=emptyEl?(emptyEl.textContent||''):'';
const defaultSearchPlaceholder=qEl?(qEl.getAttribute('placeholder')||''):'';
const DM_EMPTY_MESSAGE='No log entries match your filters.';
let dataLoadErrorActive=false;

function markDataLoadErrorActive(){
  dataLoadErrorActive=true;
  if(emptyEl){
    emptyEl.dataset.loadErrorActive='true';
  }
}

function clearDataLoadError(){
  dataLoadErrorActive=false;
  if(emptyEl){
    delete emptyEl.dataset.loadErrorActive;
  }
}

function isDataLoadErrorActive(){
  return dataLoadErrorActive;
}

const DATA_VALIDATION_DEBOUNCE_MS=800;
let dataValidationState={ issues:[], lastRun:null };
let pendingValidationHandle=null;
let adventureUidSeed=0;

function getDataPipeline(){
  if(typeof window==='undefined') return null;
  const pipeline=window.AL_DATA_PIPELINE||null;
  if(!pipeline && !pipelineWarned){
    pipelineWarned=true;
    console.warn('Data pipeline unavailable; data validation disabled.');
  }
  return pipeline;
}

function setDataValidationState(issues){
  dataValidationState={
    issues:Array.isArray(issues)?issues:[],
    lastRun:Date.now()
  };
  updateDataQualityBanner();
  if(isDataQualityModalOpen()){
    renderDataQualityIssues();
  }
}

function adoptDataPayload(raw){
  const pipeline=getDataPipeline();
  if(pipeline && typeof pipeline.normalizeData==='function'){
    try{
      const result=pipeline.normalizeData(raw);
      window.DATA=result.data;
      DATA=window.DATA;
      dataNormalized=true;
      attachAdventureUids(window.DATA);
      setDataValidationState(result.issues);
      return result;
    }catch(err){
      console.error('Failed to normalize data.js payload', err);
      pipelineWarned=true;
    }
  }
  window.DATA=raw;
  DATA=window.DATA;
  dataNormalized=true;
  attachAdventureUids(window.DATA);
  setDataValidationState([]);
  return { data:window.DATA, issues:[] };
}

function getSerializableData(){
  const pipeline=getDataPipeline();
  if(pipeline && typeof pipeline.prepareForSave==='function'){
    try{
      return pipeline.prepareForSave(DATA);
    }catch(err){
      console.warn('Unable to prepare data for save', err);
    }
  }
  try{
    return JSON.parse(JSON.stringify(DATA));
  }catch(err){
    console.warn('Unable to clone data for save', err);
    return DATA;
  }
}

function buildDataJsPayload(){
  const serializable=getSerializableData();
  return 'window.DATA = '+JSON.stringify(serializable,null,2)+';';
}

function ensureAdventureUid(adv){
  if(!adv || typeof adv!=='object') return '';
  if(typeof adv.__uid==='string' && adv.__uid){
    return adv.__uid;
  }
  const id=generateAdventureUid();
  try{
    Object.defineProperty(adv,'__uid',{ value:id, enumerable:false, configurable:true });
  }catch(err){
    adv.__uid=id;
  }
  return id;
}

function attachAdventureUids(source){
  if(!source || typeof source!=='object') return;
  const chars=source.characters;
  if(!chars || typeof chars!=='object') return;
  Object.values(chars).forEach(ch=>{
    if(ch && Array.isArray(ch.adventures)){
      ch.adventures.forEach(ensureAdventureUid);
    }
  });
}

function generateAdventureUid(){
  if(typeof crypto!=='undefined' && typeof crypto.randomUUID==='function'){
    return `adv-${crypto.randomUUID()}`;
  }
  adventureUidSeed+=1;
  return `adv-${Date.now().toString(36)}-${adventureUidSeed}`;
}

function updateDataQualityBanner(){
  if(!dataQualityBanner || !dataQualitySummaryEl) return;
  const issues=dataValidationState.issues||[];
  if(!issues.length){
    dataQualityBanner.hidden=true;
    dataQualityBanner.setAttribute('aria-hidden','true');
    return;
  }
  dataQualityBanner.hidden=false;
  dataQualityBanner.setAttribute('aria-hidden','false');
  const errorCount=issues.filter(issue=>issue && issue.severity==='error').length;
  const warningCount=issues.filter(issue=>issue && issue.severity!=='error').length;
  let summary='';
  if(errorCount && warningCount){
    summary=`${errorCount} error${errorCount===1?'':'s'} and ${warningCount} warning${warningCount===1?'':'s'} need attention.`;
  }else if(errorCount){
    summary=`${errorCount} issue${errorCount===1?' requires':'s require'} attention.`;
  }else{
    summary=`${warningCount} warning${warningCount===1?' needs':'s need'} review.`;
  }
  dataQualitySummaryEl.textContent=summary;
}

function resolveIssueAdventure(issue){
  if(!issue || !issue.charKey) return null;
  const key=issue.charKey;
  const ch=(DATA && DATA.characters && DATA.characters[key])||null;
  if(!ch || !Array.isArray(ch.adventures)) return null;
  if(issue.adventureId){
    const found=ch.adventures.find(entry=>entry && entry.__uid===issue.adventureId);
    if(found) return found;
  }
  if(typeof issue.adventureIndex==='number' && issue.adventureIndex>=0 && issue.adventureIndex<ch.adventures.length){
    return ch.adventures[issue.adventureIndex];
  }
  return null;
}

function renderDataQualityIssues(){
  if(!dataQualityIssueContainer) return;
  dataQualityIssueContainer.innerHTML='';
  const issues=Array.isArray(dataValidationState.issues)?dataValidationState.issues.slice():[];
  if(!issues.length){
    const empty=document.createElement('p');
    empty.className='data-quality-empty';
    empty.textContent='No data quality issues detected.';
    dataQualityIssueContainer.appendChild(empty);
    return;
  }
  issues.sort((a,b)=>{
    const aSeverity=(a && a.severity==='error')?0:1;
    const bSeverity=(b && b.severity==='error')?0:1;
    if(aSeverity!==bSeverity) return aSeverity-bSeverity;
    const aKey=(a && a.charKey)||'';
    const bKey=(b && b.charKey)||'';
    if(aKey!==bKey) return aKey.localeCompare(bKey,undefined,{sensitivity:'base'});
    const aIndex=Number.isFinite(a && a.adventureIndex)?a.adventureIndex:Infinity;
    const bIndex=Number.isFinite(b && b.adventureIndex)?b.adventureIndex:Infinity;
    if(aIndex!==bIndex) return aIndex-bIndex;
    const aPath=(a && a.path)||'';
    const bPath=(b && b.path)||'';
    return aPath.localeCompare(bPath,undefined,{sensitivity:'base'});
  });
  issues.forEach(issue=>{
    const item=document.createElement('div');
    item.className='data-quality-issue';
    item.dataset.severity=issue && issue.severity ? issue.severity : 'warning';
    item.setAttribute('role','listitem');

    const header=document.createElement('div');
    header.className='data-quality-issue__header';

    const badge=document.createElement('span');
    const severity=(issue && issue.severity)||'warning';
    badge.className=`data-quality-badge ${severity==='error'?'data-quality-badge--error':'data-quality-badge--warning'}`;
    badge.textContent=severity==='error'?'Error':'Warning';
    header.appendChild(badge);

    const location=document.createElement('span');
    location.className='data-quality-location';
    const parts=[];
    if(issue && issue.charKey){
      parts.push(characterDisplayName(issue.charKey));
    }
    if(issue && Number.isFinite(issue.adventureIndex)){
      parts.push(`Adventure ${issue.adventureIndex+1}`);
    }else if(issue && issue.path){
      parts.push(issue.path);
    }
    location.textContent=parts.length?parts.join('  '):'Unmapped location';
    header.appendChild(location);

    item.appendChild(header);

    const message=document.createElement('p');
    message.className='data-quality-message';
    message.textContent=(issue && issue.message) || (issue && issue.code) || 'Data issue detected.';
    item.appendChild(message);

    if(issue && issue.path && (!issue.charKey || !Number.isFinite(issue.adventureIndex))){
      const pathMeta=document.createElement('span');
      pathMeta.className='data-quality-location';
      pathMeta.textContent=issue.path;
      item.appendChild(pathMeta);
    }

    const actions=document.createElement('div');
    actions.className='data-quality-actions';
    let hasAction=false;
    if(issue && issue.charKey!=null && (issue.adventureId || Number.isFinite(issue.adventureIndex))){
      const editBtn=document.createElement('button');
      editBtn.type='button';
      editBtn.className='btn small primary';
      editBtn.textContent='Edit entry';
      editBtn.addEventListener('click',()=>{
        closeDataQualityModal();
        jumpToIssue(issue);
      });
      actions.appendChild(editBtn);
      hasAction=true;
    }
    if(hasAction){
      item.appendChild(actions);
    }

    dataQualityIssueContainer.appendChild(item);
  });
}

function isDataQualityModalOpen(){
  return dataQualityModal && dataQualityModal.classList.contains('open');
}

function openDataQualityModal(){
  if(!dataQualityModal) return;
  renderDataQualityIssues();
  dataQualityModal.classList.add('open');
  dataQualityModal.setAttribute('aria-hidden','false');
  refreshModalState();
  setTimeout(()=>{
    if(dataQualityModal && typeof dataQualityModal.focus==='function'){
      try{ dataQualityModal.focus({preventScroll:true}); }
      catch(err){ /* no-op */ }
    }
  },40);
}

function closeDataQualityModal(){
  if(!dataQualityModal) return;
  if(!dataQualityModal.classList.contains('open')) return;
  dataQualityModal.classList.remove('open');
  dataQualityModal.setAttribute('aria-hidden','true');
  refreshModalState();
  if(dataQualityReviewBtn){
    try{ dataQualityReviewBtn.focus({preventScroll:true}); }
    catch(err){ /* no-op */ }
  }
}

function scheduleDataValidation(){
  const pipeline=getDataPipeline();
  if(!pipeline || typeof pipeline.validateData!=='function') return;
  if(pendingValidationHandle!=null){
    clearTimeout(pendingValidationHandle);
  }
  pendingValidationHandle=setTimeout(()=>{
    pendingValidationHandle=null;
    runDataValidation();
  }, DATA_VALIDATION_DEBOUNCE_MS);
}

function runDataValidation(){
  const pipeline=getDataPipeline();
  if(!pipeline || typeof pipeline.validateData!=='function'){
    setDataValidationState(dataValidationState.issues||[]);
    return;
  }
  try{
    const result=pipeline.validateData(DATA);
    setDataValidationState(result && Array.isArray(result.issues)?result.issues:[]);
  }catch(err){
    console.error('Data validation failed', err);
  }
}

function jumpToIssue(issue){
  if(!issue) return;
  const targetKey=normalizeHistoryCharKey(issue.charKey||'');
  if(targetKey){
    ensureActivitiesVisible();
    if(charSel && charSel.value!==targetKey){
      charSel.value=targetKey;
    }
  }
  filterAndRender({ immediate:true });
  requestAnimationFrame(()=>{
    const adv=resolveIssueAdventure(issue);
    if(!adv) return;
    ensureAdventureUid(adv);
    const card=findCharacterCardFor(adv);
    if(!card) return;
    focusCardElement(card,{expand:true});
    if(card.__edit){
      enterEditMode(card);
    }
  });
}
const chipTickerRegistry=(()=>{
  const containers=new Set();
  const states=new Map();
  let rafId=null;
  const BASE_SPEED=32;
  const EDGE_HOLD=900;
  const mobileQuery=(typeof window!=='undefined' && typeof window.matchMedia==='function')
    ? window.matchMedia('(max-width: 520px)')
    : null;
  const reduceMotionQuery=(typeof window!=='undefined' && typeof window.matchMedia==='function')
    ? window.matchMedia('(prefers-reduced-motion: reduce)')
    : null;

  const cleanup=(container)=>{
    if(!container) return;
    const state=states.get(container);
    if(state && state.resizeObserver){
      try{ state.resizeObserver.disconnect(); }catch(err){ /* no-op */ }
    }
    states.delete(container);
    containers.delete(container);
    container.classList.remove('chip-ticker','chip-ticker-active');
    delete container.__chipTickerRegistered;
  };

  const schedule=()=>{
    if(rafId!=null) return;
    if(!containers.size) return;
    rafId=requestAnimationFrame(step);
  };

  const ensureObserver=(container,state)=>{
    if(typeof ResizeObserver==='undefined') return;
    if(state.resizeObserver) return;
    const observer=new ResizeObserver(()=>{
      state.lastTime=null;
      state.pauseUntil=0;
      state.pending=state.pending || !container.isConnected;
      schedule();
    });
    observer.observe(container);
    state.resizeObserver=observer;
  };

  const step=(timestamp)=>{
    rafId=null;
    if(!containers.size) return;
    const allowTicker=(!mobileQuery||mobileQuery.matches);
    const reduceMotion=(reduceMotionQuery&&reduceMotionQuery.matches);
    let keepAnimating=false;

    containers.forEach((container)=>{
      const state=states.get(container);
      if(!container||!state){
        cleanup(container);
        return;
      }
      if(state.pending){
        if(container.isConnected){
          state.pending=false;
          state.lastTime=timestamp;
          state.pauseUntil=timestamp+EDGE_HOLD;
          container.scrollLeft=0;
        }else{
          keepAnimating=true;
          return;
        }
      }
      if(!container.isConnected){
        cleanup(container);
        return;
      }
      ensureObserver(container,state);
      if(!allowTicker||reduceMotion||container.offsetWidth===0){
        container.classList.remove('chip-ticker-active');
        if(container.scrollLeft!==0){
          container.scrollLeft=0;
        }
        state.pos=0;
        state.direction=1;
        state.pauseUntil=0;
        state.lastTime=timestamp;
        return;
      }
      const maxScroll=Math.max(0,container.scrollWidth-container.clientWidth);
      if(maxScroll<=1){
        container.classList.remove('chip-ticker-active');
        if(container.scrollLeft!==0){
          container.scrollLeft=0;
        }
        state.pos=0;
        state.direction=1;
        state.pauseUntil=0;
        state.lastTime=timestamp;
        return;
      }
      keepAnimating=true;
      container.classList.add('chip-ticker-active');
      if(state.pauseUntil && timestamp<state.pauseUntil){
        state.lastTime=timestamp;
        return;
      }
      if(state.lastTime==null){
        state.lastTime=timestamp;
        return;
      }
      const delta=Math.min(0.05,(timestamp-state.lastTime)/1000);
      state.lastTime=timestamp;
      let next=state.pos+(state.direction*state.speed*delta);
      if(next>=maxScroll){
        next=maxScroll;
        state.direction=-1;
        state.pauseUntil=timestamp+EDGE_HOLD;
      }else if(next<=0){
        next=0;
        state.direction=1;
        state.pauseUntil=timestamp+EDGE_HOLD;
      }else{
        state.pauseUntil=0;
      }
      state.pos=next;
      container.scrollLeft=next;
    });

    if(keepAnimating){
      schedule();
    }
  };

  const handleMediaChange=()=>{
    states.forEach((state,container)=>{
      state.lastTime=null;
      state.pauseUntil=0;
      state.pending=state.pending||!container.isConnected;
    });
    schedule();
  };

  if(mobileQuery){
    if(typeof mobileQuery.addEventListener==='function'){
      mobileQuery.addEventListener('change',handleMediaChange);
    }else if(typeof mobileQuery.addListener==='function'){
      mobileQuery.addListener(handleMediaChange);
    }
  }
  if(reduceMotionQuery){
    const handler=()=>{ handleMediaChange(); };
    if(typeof reduceMotionQuery.addEventListener==='function'){
      reduceMotionQuery.addEventListener('change',handler);
    }else if(typeof reduceMotionQuery.addListener==='function'){
      reduceMotionQuery.addListener(handler);
    }
  }
  if(typeof window!=='undefined'){
    window.addEventListener('resize',handleMediaChange,{passive:true});
  }

  return{
    register(container){
      if(!container||container.__chipTickerRegistered) return;
      container.__chipTickerRegistered=true;
      const speedAttr=Number(container.dataset.chipTickerSpeed||'');
      const state={
        pos:container.scrollLeft||0,
        direction:1,
        lastTime:null,
        pauseUntil:0,
        speed:(Number.isFinite(speedAttr)&&speedAttr>0)?speedAttr:BASE_SPEED,
        pending:!container.isConnected,
        resizeObserver:null
      };
      containers.add(container);
      states.set(container,state);
      container.classList.add('chip-ticker');
      schedule();
    },
    unregister(container){
      cleanup(container);
    },
    refresh(container){
      if(!container) return;
      const state=states.get(container);
      if(!state) return;
      state.lastTime=null;
      state.pauseUntil=0;
      state.pending=state.pending||!container.isConnected;
      schedule();
    },
    schedule
  };
})();

const DM_LOG_KEY='__dmLog';
const CHARACTER_TIERS=[
  {id:'tier1',label:'Tier 1 (Levels 1-4)',min:1,max:4,order:1},
  {id:'tier2',label:'Tier 2 (Levels 5-10)',min:5,max:10,order:2},
  {id:'tier3',label:'Tier 3 (Levels 11-16)',min:11,max:16,order:3},
  {id:'tier4',label:'Tier 4 (Levels 17-20)',min:17,max:20,order:4}
];
function tierInfoForLevel(level){
  const numeric=Number(level);
  const safeLevel=Number.isFinite(numeric)&&numeric>0?Math.floor(numeric):1;
  for(const tier of CHARACTER_TIERS){
    if(safeLevel>=tier.min&&safeLevel<=tier.max){
      return tier;
    }
  }
  return CHARACTER_TIERS[CHARACTER_TIERS.length-1];
}
const DM_DATA=(typeof window!=='undefined' && window.DMDATA && typeof window.DMDATA==='object')?window.DMDATA:null;
let DM_ENTRIES=[];
let DM_SUMMARY={ runs:0, allocations:0, earnedHours:0, earnedBonus:0, allocatedHours:0, allocatedBonus:0, allocatedCost:0, earnedLevels:0, spentLevels:0, entries:0 };
const DM_HOURS_POOL_START_TS=(()=>{
  const ts=Date.parse('2025-01-01T00:00:00Z');
  return Number.isFinite(ts)?ts:0;
})();
let DM_PRE_ITEMS=[];
let overlayCard=null;


const scrollableTitleRegistry=(()=>{
  const wrappers=new Set();
  let rafId=null;
  const schedule=()=>{
    if(rafId!=null) return;
    rafId=requestAnimationFrame(()=>{
      rafId=null;
      wrappers.forEach((wrapper)=>{
        if(wrapper && typeof wrapper.__refreshScroll==='function'){
          try{
            wrapper.__refreshScroll();
          }catch(err){
            /* no-op */
          }
        }
      });
    });
  };
  if(typeof window!=='undefined'){
    window.addEventListener('resize',schedule,{passive:true});
  }
  return{
    register(wrapper){
      if(!wrapper) return;
      wrappers.add(wrapper);
      schedule();
    },
    unregister(wrapper){
      wrappers.delete(wrapper);
    },
    schedule
  };
})();

function refreshScrollableWrapper(wrapper){
  if(!wrapper||!wrapper.__display) return;
  const displayEl=wrapper.__display;
  if(!(displayEl instanceof Element)) return;

  const cleanupLegacyMarquee=()=>{
    const clone=displayEl.__marqueeClone;
    if(clone&&clone.parentNode===displayEl){
      clone.remove();
    }
    displayEl.__marqueeClone=null;
    const inner=displayEl.__marqueeInner;
    if(inner&&inner.parentNode===displayEl){
      while(inner.firstChild){
        displayEl.insertBefore(inner.firstChild,inner);
      }
      inner.remove();
    }
    displayEl.__marqueeInner=null;
    displayEl.classList.remove('scrollable-marquee');
  };

  cleanupLegacyMarquee();

  const containerWidth=Math.max(0,wrapper.clientWidth||displayEl.clientWidth||0);
  const contentWidth=displayEl.scrollWidth;
  if(contentWidth-containerWidth>1){
    wrapper.classList.add('scrollable');
  }else{
    wrapper.classList.remove('scrollable');
  }
}

function bindScrollableObserver(wrapper){
  if(!wrapper) return;
  if(wrapper.__scrollObserverBound) return;
  wrapper.__scrollObserverBound=true;
  const trigger=()=>refreshScrollableWrapper(wrapper);
  wrapper.__refreshScroll=trigger;
  scrollableTitleRegistry.register(wrapper);
  wrapper.addEventListener('pointerenter',trigger);
  wrapper.addEventListener('pointerdown',trigger);
  wrapper.addEventListener('focus',trigger);
  if(typeof ResizeObserver!=='undefined'){
    if(wrapper.__resizeObserver){
      try{ wrapper.__resizeObserver.disconnect(); }
      catch(err){ /* no-op */ }
    }
    const observer=new ResizeObserver(()=>{
      scrollableTitleRegistry.schedule();
    });
    observer.observe(wrapper);
    if(wrapper.__display instanceof Element){
      observer.observe(wrapper.__display);
    }
    wrapper.__resizeObserver=observer;
  }
}

const tickerRowRegistry=(()=>{
  const rows=new Set();
  let rafId=null;

  const disconnectObserver=(row)=>{
    if(row && row._observer){
      try{ row._observer.disconnect(); }
      catch(err){ /* no-op */ }
      row._observer=null;
    }
  };

  const isElementVisible=(el)=>{
    if(!el || !(el instanceof Element)) return false;
    if(el.offsetParent!==null) return true;
    if(typeof el.getClientRects==='function'){
      const rects=el.getClientRects();
      if(rects && rects.length){
        const rect=rects[0];
        if(rect.width>0 && rect.height>0){
          return true;
        }
      }
    }
    return false;
  };

  const measureNeedsTicker=(row)=>{
    const {container,left,right}=row;
    if(!container||!left||!right) return false;
    if(!(container instanceof Element) || !(left instanceof Element) || !(right instanceof Element)) return false;
    const style=window.getComputedStyle(container);
    if(style && typeof style.flexDirection==='string' && style.flexDirection.indexOf('column')!==-1){
      return false;
    }
    const wasActive=row._active;
    if(wasActive){
      container.classList.remove(row.activeClass||'ticker-active');
    }
    let needsTicker=false;
    const measureOverflow=(el)=>{
      if(!el||!(el instanceof Element)) return false;
      if(el.scrollWidth-el.clientWidth>1) return true;
      const display=el.querySelector('.display');
      return display instanceof Element && (display.scrollWidth-display.clientWidth>1);
    };
    if(measureOverflow(left)){
      needsTicker=true;
    }
    if(!needsTicker && isElementVisible(left) && isElementVisible(right)){
      const leftTop=left.offsetTop;
      const rightTop=right.offsetTop;
      needsTicker=Math.abs(rightTop-leftTop)>1;
    }
    if(wasActive){
      container.classList.add(row.activeClass||'ticker-active');
    }
    return needsTicker;
  };

  const evaluateRow=(row)=>{
    const {container,activeClass='ticker-active',onToggle}=row;
    if(!container || !(container instanceof Element)){
      rows.delete(row);
      disconnectObserver(row);
      return;
    }
    if(!container.isConnected){
      if(row._active){
        container.classList.remove(activeClass);
        row._active=false;
        if(typeof onToggle==='function'){
          try{ onToggle(false,row); }
          catch(err){ /* no-op */ }
        }
      }
      disconnectObserver(row);
      rows.delete(row);
      return;
    }
    const needsTicker=measureNeedsTicker(row);
    if(needsTicker && !row._active){
      container.classList.add(activeClass);
      row._active=true;
      if(typeof onToggle==='function'){
        try{ onToggle(true,row); }
        catch(err){ /* no-op */ }
      }
    }else if(!needsTicker && row._active){
      container.classList.remove(activeClass);
      row._active=false;
      if(typeof onToggle==='function'){
        try{ onToggle(false,row); }
        catch(err){ /* no-op */ }
      }
    }
  };

  const schedule=()=>{
    if(rafId!=null) return;
    rafId=requestAnimationFrame(()=>{
      rafId=null;
      rows.forEach((row)=>{
        try{ evaluateRow(row); }
        catch(err){ /* no-op */ }
      });
    });
  };

  return{
    register(row){
      if(!row||!row.container||(row.container instanceof Element)===false) return;
      if(row._registered) return;
      row.activeClass=row.activeClass||'ticker-active';
      row._registered=true;
      row._active=false;
      rows.add(row);
      if(typeof ResizeObserver!=='undefined'){
        const observer=new ResizeObserver(()=>{ schedule(); });
        observer.observe(row.container);
        if(row.left instanceof Element){ observer.observe(row.left); }
        if(row.right instanceof Element){ observer.observe(row.right); }
        row._observer=observer;
      }
      schedule();
    },
    unregister(row){
      if(!row||!row._registered) return;
      rows.delete(row);
      disconnectObserver(row);
      row._registered=false;
      if(row.container instanceof Element){
        row.container.classList.remove(row.activeClass||'ticker-active');
      }
      if(row._active && typeof row.onToggle==='function'){
        try{ row.onToggle(false,row); }
        catch(err){ /* no-op */ }
      }
      row._active=false;
    },
    schedule
  };
})();

function setupTickerRow(container,left,right,options={}){
  if(!container || !(container instanceof Element)) return null;
  const row={container,left,right,...options};
  tickerRowRegistry.register(row);
  return row;
}

const headerRow=document.querySelector('.sheet-card-header > .row');
const headerMainEl=document.querySelector('.sheet-card-header .header-main');
if(charSelDisplay){
  charSelDisplay.__display=charSelDisplay;
  bindScrollableObserver(charSelDisplay);
  requestAnimationFrame(()=>{ refreshScrollableWrapper(charSelDisplay); });
}
if(headerRow && headerMainEl){
  setupTickerRow(headerRow,headerMainEl,saveIndicatorWrap||null,{
    onToggle:()=>{
      if(charSelDisplay && typeof charSelDisplay.__refreshScroll==='function'){
        charSelDisplay.__refreshScroll();
      }
    }
  });
}
buildDmEntries();
if(avatarEl){
  try{ avatarEl.decoding='async'; }catch(err){ /* no-op */ }
  try{ avatarEl.loading='eager'; }catch(err){ /* no-op */ }
  try{ avatarEl.fetchPriority='high'; }catch(err){ /* no-op */ }
}
if(avatarPreviewImage){
  try{ avatarPreviewImage.decoding='async'; }catch(err){ /* no-op */ }
}
const AVATAR_PATH_STORAGE_PREFIX='al_logs_avatar_paths_v1';
const avatarPathStorageKey=`${AVATAR_PATH_STORAGE_PREFIX}_${dataVersion||'0'}`;
const AVATAR_MANIFEST=Object.freeze({
  'Ecthelion':'Ecthelion.png',
  'Gnat':'gnat.png',
  'Squelch':'squelch.png',
  'Squelch (prequel)':'squelch (prequel).png',
  'Norixius':'norixius.png',
  'Madam Renata':'madam renata.png',
  'Goblert Godfrey':'goblert godfrey.png',
  'Lyrielle':'lyrielle.png',
  'Sentient Hat':'sentient hat.png',
  'Arvistan Brightwave':'arvistan.png',
  'Agatha':'agatha.png',
  'Darrendrian':'darrendrian.png',
  'Copy of Darrendrian':'darrendrian.png',
  'Morty':'morty.png',
  'Zandarax':'zandarax.png',
  'Zandaraxs Inventory':'zandarax.png',
  'Zandaraxs Bastion':'zandarax.png'
});
const AVATAR_FALLBACK_PATH='d20 flat.png';
const avatarCache=new Map();
const avatarPreloadPromises=new Map();
let avatarLoadToken=0;
let persistedAvatarPaths={};
let avatarPathsDirty=false;
let avatarPathsSaveTimeout=null;
try{
  const raw=localStorage.getItem(avatarPathStorageKey);
  if(raw){
    const parsed=JSON.parse(raw);
    if(parsed&&typeof parsed==='object'&&!Array.isArray(parsed)){
      persistedAvatarPaths=parsed;
    }
  }
}catch(err){
  persistedAvatarPaths={};
}
function schedulePersistAvatarPaths(){
  if(!avatarPathsDirty) return;
  if(avatarPathsSaveTimeout) return;
  avatarPathsSaveTimeout=setTimeout(()=>{
    avatarPathsSaveTimeout=null;
    if(!avatarPathsDirty) return;
    try{
      localStorage.setItem(avatarPathStorageKey,JSON.stringify(persistedAvatarPaths));
      avatarPathsDirty=false;
    }catch(err){
      /* no-op */
      avatarPathsDirty=false;
    }
  },200);
}
function persistAvatarPathsImmediately(){
  if(!avatarPathsDirty) return;
  try{
    localStorage.setItem(avatarPathStorageKey,JSON.stringify(persistedAvatarPaths));
    avatarPathsDirty=false;
  }catch(err){
    /* no-op */
    avatarPathsDirty=false;
  }
}
if(typeof window!=='undefined'){
  window.addEventListener('pagehide',persistAvatarPathsImmediately);
  window.addEventListener('beforeunload',persistAvatarPathsImmediately);
}
function getPersistedAvatarPath(key){
  if(!key) return '';
  const normalized=String(key);
  return persistedAvatarPaths[normalized]||'';
}
function rememberAvatarPath(key,path){
  if(!key) return;
  const normalized=String(key);
  if(!path){
    if(Object.prototype.hasOwnProperty.call(persistedAvatarPaths,normalized)){
      delete persistedAvatarPaths[normalized];
      avatarPathsDirty=true;
      schedulePersistAvatarPaths();
    }
    return;
  }
  if(persistedAvatarPaths[normalized]===path) return;
  persistedAvatarPaths[normalized]=path;
  avatarPathsDirty=true;
  schedulePersistAvatarPaths();
}
function forgetAvatarPath(key){
  rememberAvatarPath(key,null);
}
const ICON_TRASH='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-14"/></svg>';
const ICON_MINUS='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="9"/><path d="M8 12h8"/></svg>';
const ICON_PLUS='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="9"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>';

function bindButtonLike(el, handler){
  if(!el) return;
  el.addEventListener('click', handler);
  el.addEventListener('keydown', evt => {
    if(evt.key==='Enter' || evt.key===' '){
      evt.preventDefault();
      handler(evt);
    }
  });
}

bindButtonLike(magicItemsBtn, () => openInventoryModal(charSel.value));
bindButtonLike(consumablesBtn, () => openConsumableModal(charSel.value));
bindButtonLike(giftsBtn, () => openSupernaturalModal(charSel.value));
bindButtonLike(inventorySidebarMagicManageBtn, () => openInventoryModal(charSel.value));
bindButtonLike(inventorySidebarConsumableManageBtn, () => openConsumableModal(charSel.value));

let pendingChanges=false;
let savingData=false;
let lastSaveResult=null;
let saveFeedbackTimeout=null;
let hasLocalDraft=false;
let draftStateApplied=false;
let draftPersistWarningShown=false;
let draftLoadWarningShown=false;
let saveQueueTail=Promise.resolve();
const pendingDerivedUpdates=new Set();
const SAVE_ENDPOINT=(typeof window!=='undefined' && window.AL_SAVE_ENDPOINT)||'https://al-logs.vercel.app/api/save-data';
const SAVE_HEADERS=(typeof window!=='undefined' && window.AL_SAVE_HEADERS)||null;
const STORAGE_KEYS={
  showActivities:'al_logs_show_activities',
  lastCharacter:'al_logs_last_character',
  searchAll:'al_logs_search_all_characters'
};

const HISTORY_STATE_VERSION=1;
const historySupported=(typeof window!=='undefined' && window.history && typeof window.history.replaceState==='function');
const adventureHistoryIds=new WeakMap();
const dmHistoryIds=new WeakMap();
const adventureHistoryLookup=new Map();
const dmHistoryLookup=new Map();
let adventureHistoryIdCounter=1;
let dmHistoryIdCounter=1;
let lastHistoryState=null;
let suppressHistoryUpdates=false;
const lastCharacterEntryState=new Map();

function rememberLastEntryState(charKey,{entryType=null,entryId=null}={}){
  const normalized=normalizeHistoryCharKey(charKey);
  if(!normalized){
    return;
  }
  if((entryType==='adventure'||entryType==='dm') && entryId!=null){
    lastCharacterEntryState.set(normalized,{
      entryType,
      entryId:String(entryId)
    });
    return;
  }
  lastCharacterEntryState.delete(normalized);
}

function getLastEntryState(charKey){
  const normalized=normalizeHistoryCharKey(charKey);
  if(!normalized) return null;
  const stored=lastCharacterEntryState.get(normalized);
  if(!stored) return null;
  const type=stored.entryType;
  const id=stored.entryId;
  if((type==='adventure'||type==='dm') && id!=null){
    return {entryType:type,entryId:String(id)};
  }
  lastCharacterEntryState.delete(normalized);
  return null;
}

function normalizeHistoryCharKey(value){
  if(!value) return '';
  const text=String(value);
  if(isValidSheetKey(text) || isDmLogKey(text)){
    return text;
  }
  return '';
}

function getAdventureHistoryId(adv,charKey){
  if(!adv||typeof adv!=='object') return null;
  let id=adventureHistoryIds.get(adv);
  if(!id){
    id=`adv_${(adventureHistoryIdCounter++).toString(36)}`;
    adventureHistoryIds.set(adv,id);
  }
  const storedChar=charKey!=null?String(charKey):((adventureHistoryLookup.get(id)&&adventureHistoryLookup.get(id).charKey)||'');
  adventureHistoryLookup.set(id,{adv,charKey:storedChar});
  return id;
}

function getDmHistoryId(entry){
  if(!entry||typeof entry!=='object') return null;
  let id=dmHistoryIds.get(entry);
  if(!id){
    id=`dm_${(dmHistoryIdCounter++).toString(36)}`;
    dmHistoryIds.set(entry,id);
  }
  dmHistoryLookup.set(id,{entry});
  return id;
}

function buildHistoryState({charKey,entryType=null,entryId=null}={}){
  return {
    v:HISTORY_STATE_VERSION,
    charKey:charKey?String(charKey):'',
    entryType:(entryType==='adventure'||entryType==='dm')?entryType:null,
    entryId:(entryId!=null)?String(entryId):null
  };
}

function historyStatesEqual(a,b){
  if(a===b) return true;
  if(!a||!b) return false;
  return a.charKey===b.charKey && a.entryType===b.entryType && a.entryId===b.entryId;
}

function historyUrlForState(state){
  if(typeof window==='undefined') return '';
  const params=new URLSearchParams();
  const normalizedChar=normalizeHistoryCharKey(state&&state.charKey);
  if(normalizedChar){
    params.set('char', normalizedChar);
  }
  const type=(state&&state.entryType)&&((state.entryType==='adventure'||state.entryType==='dm')?state.entryType:null);
  const id=(state&&state.entryId!=null)?String(state.entryId):'';
  if(type&&id){
    params.set('entry', id);
    params.set('type', type);
  }
  const hash=params.toString();
  const url=new URL(window.location.href);
  url.hash=hash?`#${hash}`:'';
  return url.pathname+url.search+(hash?`#${hash}`:'');
}

function syncHistoryState(state,{replace=false}={}){
  if(!historySupported) return;
  const normalizedChar=normalizeHistoryCharKey(state&&state.charKey);
  const type=(state&&state.entryType)&&((state.entryType==='adventure'||state.entryType==='dm')?state.entryType:null);
  const id=type&&(state&&state.entryId!=null)?String(state.entryId):null;
  if(!normalizedChar && !id){
    return;
  }
  const nextState=buildHistoryState({charKey:normalizedChar,entryType:type,entryId:id});
  if(!replace && historyStatesEqual(lastHistoryState,nextState)){
    return;
  }
  const url=historyUrlForState(nextState);
  if(replace || !lastHistoryState){
    window.history.replaceState(nextState,'',url);
  }else{
    window.history.pushState(nextState,'',url);
  }
  lastHistoryState=nextState;
}

function getActiveCharacterKey(){
  return (charSel && typeof charSel.value==='string')?charSel.value:'';
}

function recordHistoryState({charKey=null,entryType=null,entryId=null,replace=false}={}){
  if(suppressHistoryUpdates) return;
  const normalizedChar=normalizeHistoryCharKey(charKey||getActiveCharacterKey());
  const type=(entryType==='adventure'||entryType==='dm')?entryType:null;
  const id=type && entryId!=null ? String(entryId) : null;
  if(!normalizedChar && !id){
    return;
  }
  syncHistoryState({charKey:normalizedChar,entryType:type,entryId:id},{replace});
}

function recordCharacterView({charKey=null,replace=false,clearEntryState=false}={}){
  const normalizedChar=normalizeHistoryCharKey(charKey||getActiveCharacterKey());
  if(clearEntryState && normalizedChar){
    rememberLastEntryState(normalizedChar,{});
  }
  const entryState=(!clearEntryState && normalizedChar)?getLastEntryState(normalizedChar):null;
  const entryType=entryState?entryState.entryType:null;
  const entryId=entryState?entryState.entryId:null;
  recordHistoryState({charKey:normalizedChar,entryType,entryId,replace});
}

function recordEntryView({charKey=null,entryType=null,entryId=null}={}){
  const normalizedChar=normalizeHistoryCharKey(charKey||getActiveCharacterKey());
  const type=(entryType==='adventure'||entryType==='dm')?entryType:null;
  const id=type && entryId!=null ? String(entryId) : null;
  if(normalizedChar){
    rememberLastEntryState(normalizedChar,{entryType:type,entryId:id});
  }
  recordHistoryState({charKey:normalizedChar,entryType:type,entryId:id,replace:true});
}

function focusEntryFromState(state,{suppressHistoryPush=false}={}){
  if(!state||!state.entryType||state.entryId==null) return;
  const entryType=(state.entryType==='adventure'||state.entryType==='dm')?state.entryType:null;
  if(!entryType) return;
  const entryId=String(state.entryId);
  requestAnimationFrame(()=>{
    let card=null;
    if(entryType==='adventure'){
      const meta=adventureHistoryLookup.get(entryId);
      const adv=meta?meta.adv:null;
      if(adv){
        card=findCharacterCardFor(adv);
      }
    }else if(entryType==='dm'){
      const meta=dmHistoryLookup.get(entryId);
      const entry=meta?meta.entry:null;
      if(entry){
        card=findDmCardFor(entry);
      }
    }
    if(!card) return;
    const prevSuppress=suppressHistoryUpdates;
    suppressHistoryUpdates=true;
    try{
      focusCardElement(card,{expand:true});
    }finally{
      suppressHistoryUpdates=prevSuppress;
    }
    const charKey=normalizeHistoryCharKey(state.charKey||getActiveCharacterKey());
    if(charKey){
      rememberLastEntryState(charKey,{entryType,entryId});
      if(!suppressHistoryPush){
        recordHistoryState({charKey,entryType,entryId,replace:true});
      }
    }
  });
}

function parseHistoryStateFromLocation(){
  if(typeof window==='undefined') return null;
  const hash=window.location.hash||'';
  if(hash.length<=1) return null;
  const params=new URLSearchParams(hash.slice(1));
  const charKey=params.get('char')||'';
  const entryId=params.get('entry');
  const entryType=params.get('type');
  return buildHistoryState({
    charKey,
    entryType:(entryType==='adventure'||entryType==='dm')?entryType:null,
    entryId:entryId!=null?entryId:null
  });
}

function applyHistoryState(state){
  if(!state) return;
  const desiredChar=normalizeHistoryCharKey(state.charKey);
  const wantsEntry=(state.entryType==='adventure'||state.entryType==='dm') && state.entryId!=null;
  suppressHistoryUpdates=true;
  try{
    clearSearchForNavigation();
    if(wantsEntry && state.entryType==='adventure'){
      ensureActivitiesVisible();
    }
    if(desiredChar && charSel && charSel.value!==desiredChar){
      charSel.value=desiredChar;
    }
    filterAndRender();
  }finally{
    suppressHistoryUpdates=false;
  }
  const activeChar=normalizeHistoryCharKey(getActiveCharacterKey())||desiredChar;
  if(wantsEntry){
    focusEntryFromState({charKey:activeChar,entryType:state.entryType,entryId:state.entryId},{suppressHistoryPush:true});
  }else if(activeChar){
    rememberLastEntryState(activeChar,{});
  }
  const normalized=buildHistoryState({
    charKey:activeChar,
    entryType:wantsEntry?state.entryType:null,
    entryId:wantsEntry?state.entryId:null
  });
  lastHistoryState=normalized;
  if(historySupported){
    const url=historyUrlForState(normalized);
    window.history.replaceState(normalized,'',url);
  }
}

if(historySupported){
  window.addEventListener('popstate',(event)=>{
    const state=(event&&event.state&&event.state.v===HISTORY_STATE_VERSION)?event.state:null;
    if(state){
      applyHistoryState(state);
    }else{
      const fallback=parseHistoryStateFromLocation();
      if(fallback){
        applyHistoryState(fallback);
      }
    }
  });
}

function hasDmLogData(){
  return !!DM_DATA;
}
function isDmLogKey(key){
  return key===DM_LOG_KEY;
}
function isValidSheetKey(key){
  if(!key) return false;
  if(isDmLogKey(key)) return hasDmLogData();
  return !!(DATA && DATA.characters && DATA.characters[key]);
}

function registerDerivedUpdate(key){
  if(!key || isDmLogKey(key)) return;
  if(!isValidSheetKey(key)) return;
  pendingDerivedUpdates.add(key);
}

function syncPendingDerivedData(){
  if(!pendingDerivedUpdates.size) return;
  const keys=[...pendingDerivedUpdates].filter(key=>isValidSheetKey(key) && !isDmLogKey(key));
  if(!keys.length) return;
  let updated=false;
  keys.forEach(key=>{
    try{
      updateDerivedDataFor(key);
      pendingDerivedUpdates.delete(key);
      updated=true;
    }catch(err){
      console.warn('Unable to refresh derived data before save', key, err);
    }
  });
  if(updated){
    rebuildDmRewardLinks();
  }
}

let showActivities=true;
try{
  const saved=localStorage.getItem(STORAGE_KEYS.showActivities);
  if(saved==='0'||saved==='false') showActivities=false;
}catch(err){
  /* no-op */
}

let searchAllCharacters=false;
try{
  const savedScope=localStorage.getItem(STORAGE_KEYS.searchAll);
  if(savedScope==='1'||savedScope==='true'){
    searchAllCharacters=true;
  }
}catch(err){
  /* no-op */
}

const MULTI_SEARCH_MIN_QUERY_LENGTH=2;
const MULTI_SEARCH_PROMPT_TEXT=`Start typing to search across all characters.`;
const SEARCH_INPUT_DEBOUNCE_MS=150;

const adventureSearchCache={
  all:null,
  byCharacter:new Map()
};

const adventureCardCache=new Map();
let pendingRenderFrame=null;
let adventureEntryUid=0;

function ensureAdventureEntryKey(adv){
  if(!adv||typeof adv!=='object') return '';
  if(typeof adv.__entryKey==='string'&&adv.__entryKey) return adv.__entryKey;
  const key=`adv-${++adventureEntryUid}`;
  try{
    Object.defineProperty(adv,'__entryKey',{
      value:key,
      configurable:true,
      enumerable:false,
      writable:false
    });
  }catch(err){
    adv.__entryKey=key;
  }
  return key;
}

function pruneAdventureCardCache(charKey){
  if(!charKey) return;
  for(const [entryKey,card] of adventureCardCache){
    const dataRef=card && card.__dataRef;
    const owner=(card && card.__charKey)|| (dataRef && dataRef.__charKey)||'';
    if(owner===charKey){
      adventureCardCache.delete(entryKey);
      if(card && grid && card.parentNode===grid){
        grid.removeChild(card);
      }
    }
  }
}

function clearAdventureCardCache(){
  for(const card of adventureCardCache.values()){
    if(card && grid && card.parentNode===grid){
      grid.removeChild(card);
    }
  }
  adventureCardCache.clear();
}

function getAdventureEntryKey(entry){
  if(!entry) return '';
  return ensureAdventureEntryKey(entry.adv);
}

function syncAdventureGrid(entries){
  if(!grid) return;
  const desired=[];
  const seenKeys=new Set();
  entries.forEach((entry,index)=>{
    const key=getAdventureEntryKey(entry);
    if(!key){
      return;
    }
    let card=adventureCardCache.get(key);
    const adv=entry.adv;
    if(!card){
      card=makeCard(adv,index);
      card.dataset.entryKey=key;
      adventureCardCache.set(key,card);
    }
    if(card.dataset.idx!==String(index)){
      card.dataset.idx=String(index);
    }
    card.__dataRef=adv;
    card.__charKey=entry.charKey || (adv && adv.__charKey) || '';
    seenKeys.add(key);
    desired.push(card);
  });

  const children=Array.from(grid.children);
  children.forEach(child=>{
    const key=child && child.dataset ? child.dataset.entryKey : null;
    if(!key || !seenKeys.has(key)){
      grid.removeChild(child);
    }
  });

  let pointer=grid.firstChild;
  desired.forEach(card=>{
    if(card===pointer){
      pointer=pointer?pointer.nextSibling:null;
      return;
    }
    grid.insertBefore(card,pointer||null);
  });
}

let pendingSearchInputHandle=null;

const CHARACTER_MENTION_LABELS=new Set(['player','character','reward allocation','notes']);
let characterMentionEntries=[];

function refreshCharacterMentionIndex(){
  characterMentionEntries.length=0;
  if(!DATA || !DATA.characters) return;
  const aliasMap=new Map();
  const addAlias=(rawAlias,key,display)=>{
    if(!rawAlias) return;
    const cleaned=String(rawAlias).trim();
    if(!cleaned) return;
    const normalized=cleaned.toLowerCase();
    if(!normalized) return;
    if(aliasMap.has(normalized)) return;
    aliasMap.set(normalized,{
      alias:cleaned,
      aliasLower:normalized,
      aliasLength:cleaned.length,
      key,
      display
    });
  };
  Object.entries(DATA.characters).forEach(([key,obj])=>{
    if(!obj || typeof obj!=='object') return;
    const displayName=typeof obj.display_name==='string'?obj.display_name.trim():'';
    const sheetName=typeof obj.sheet==='string'?obj.sheet.trim():'';
    const canonical=displayName||sheetName||String(key||'').trim();
    if(!canonical) return;
    const addNormalizedAlias=(alias)=>{
      addAlias(alias,key,canonical);
      if(typeof alias==='string' && alias.includes('(')){
        const withoutParen=alias.replace(/\s*\([^)]*\)/g,' ').replace(/\s+/g,' ').trim();
        if(withoutParen && withoutParen.toLowerCase()!==alias.toLowerCase()){
          addAlias(withoutParen,key,canonical);
        }
      }
    };
    [displayName,sheetName,String(key||'')].forEach(name=>{
      if(!name) return;
      addNormalizedAlias(name);
    });
  });
  characterMentionEntries=Array.from(aliasMap.values())
    .filter(entry=>entry && entry.aliasLength>0)
    .sort((a,b)=>{
      if(b.aliasLength!==a.aliasLength) return b.aliasLength-a.aliasLength;
      return a.alias.localeCompare(b.alias);
    });
}

function ensureCharacterMentionIndex(){
  if(!characterMentionEntries || !characterMentionEntries.length){
    refreshCharacterMentionIndex();
  }
  return characterMentionEntries;
}

const WORD_CHAR_REGEX=/[0-9A-Za-z]/;

function isWordBoundaryBefore(text,index){
  if(index<=0) return true;
  const char=text.charAt(index-1);
  return !WORD_CHAR_REGEX.test(char);
}

function isWordBoundaryAfter(text,index){
  if(index>=text.length) return true;
  const char=text.charAt(index);
  return !WORD_CHAR_REGEX.test(char);
}

function shouldDecorateLabelForCharacter(label){
  if(!label) return false;
  const normalized=String(label).trim().toLowerCase();
  return CHARACTER_MENTION_LABELS.has(normalized);
}

function createCharacterChip(charKey,text,{label}={}){
  const link=document.createElement('a');
  link.href='#';
  link.className='log-row-character-chip';
  link.textContent=text;
  const display=getCharacterDisplayName(charKey)||text;
  const accessibleLabel=label||`View ${display}'s log`;
  link.title=accessibleLabel;
  link.setAttribute('aria-label', accessibleLabel);
  link.dataset.charKey=String(charKey);
  link.addEventListener('click',(event)=>{
    event.preventDefault();
    event.stopPropagation();
    navigateToCharacter(charKey);
  });
  return link;
}

function renderCharacterMentions(value){
  if(value==null) return null;
  const text=String(value);
  if(!text) return null;
  const entries=ensureCharacterMentionIndex();
  if(!entries.length) return null;
  const lower=text.toLowerCase();
  let index=0;
  let lastIndex=0;
  let matchedAny=false;
  const fragment=document.createDocumentFragment();
  while(index<text.length){
    let match=null;
    for(const entry of entries){
      if(entry.aliasLength<=0) continue;
      if(index+entry.aliasLength>text.length) continue;
      if(lower.slice(index,index+entry.aliasLength)!==entry.aliasLower) continue;
      if(!isWordBoundaryBefore(text,index)) continue;
      if(!isWordBoundaryAfter(text,index+entry.aliasLength)) continue;
      match=entry;
      break;
    }
    if(match){
      if(index>lastIndex){
        fragment.appendChild(document.createTextNode(text.slice(lastIndex,index)));
      }
      const original=text.slice(index,index+match.aliasLength);
      const chip=createCharacterChip(match.key, original, {label:`View ${match.display}'s log`});
      fragment.appendChild(chip);
      index+=match.aliasLength;
      lastIndex=index;
      matchedAny=true;
      continue;
    }
    index+=1;
  }
  if(!matchedAny){
    return null;
  }
  if(lastIndex<text.length){
    fragment.appendChild(document.createTextNode(text.slice(lastIndex)));
  }
  return fragment;
}

function setElementTextWithCharacterChips(element,text,{label,force=false}={}){
  if(!element) return;
  const value=text==null?'':String(text);
  const shouldDecorate=force || shouldDecorateLabelForCharacter(label);
  const mentions=shouldDecorate?renderCharacterMentions(value):null;
  if(typeof element.replaceChildren==='function'){
    element.replaceChildren();
  }else{
    while(element.firstChild){ element.removeChild(element.firstChild); }
  }
  if(mentions){
    element.appendChild(mentions);
  }else{
    element.textContent=value;
  }
}

function persistActivityVisibility(){
  try{
    localStorage.setItem(STORAGE_KEYS.showActivities, showActivities?'1':'0');
  }catch(err){
    /* no-op */
  }
}

let cachedLastCharacterKey=null;
function getRememberedCharacterKey(){
  if(cachedLastCharacterKey===null){
    try{
      cachedLastCharacterKey=localStorage.getItem(STORAGE_KEYS.lastCharacter)||'';
    }catch(err){
      cachedLastCharacterKey='';
    }
  }
  if(cachedLastCharacterKey && !isValidSheetKey(cachedLastCharacterKey)){
    cachedLastCharacterKey='';
  }
  return cachedLastCharacterKey;
}
function rememberCharacterKey(key){
  const nextKey=isValidSheetKey(key)?String(key):'';
  if(cachedLastCharacterKey===nextKey) return;
  cachedLastCharacterKey=nextKey;
  try{
    if(nextKey){
      localStorage.setItem(STORAGE_KEYS.lastCharacter,nextKey);
    }else{
      localStorage.removeItem(STORAGE_KEYS.lastCharacter);
    }
  }catch(err){
    /* no-op */
  }
}

function setEmptyStateMessage(text){
  if(!emptyEl||isDataLoadErrorActive()) return;
  emptyEl.textContent=text;
}

function updateActivityToggle(){
  if(!activityToggleBtn) return;
  const hiding=!showActivities;
  activityToggleBtn.textContent=hiding?'Show activities':'Hide activities';
  activityToggleBtn.setAttribute('aria-pressed', hiding?'true':'false');
  const label=hiding?'Show downtime activities':'Hide downtime activities';
  activityToggleBtn.setAttribute('aria-label', label);
  activityToggleBtn.title=label;
}

function persistSearchScope(){
  try{
    localStorage.setItem(STORAGE_KEYS.searchAll, searchAllCharacters?'1':'0');
  }catch(err){
    /* no-op */
  }
}

function updateSearchScopeToggle(){
  if(!searchScopeToggleBtn) return;
  const active=!!searchAllCharacters;
  const label=active
    ?'Showing entries from all characters. Click to limit results to the selected character.'
    :'Showing entries from the selected character. Click to include all characters.';
  searchScopeToggleBtn.setAttribute('aria-pressed', active?'true':'false');
  searchScopeToggleBtn.setAttribute('aria-label', label);
  searchScopeToggleBtn.title=label;
  updateSearchPlaceholder(charSel?charSel.value:'');
}

function invalidateAdventureSearchCache(key){
  if(!key){
    adventureSearchCache.byCharacter.clear();
    adventureSearchCache.all=null;
    clearAdventureCardCache();
    return;
  }
  if(typeof key==='string'){
    adventureSearchCache.byCharacter.delete(key);
  }
  adventureSearchCache.all=null;
  pruneAdventureCardCache(key);
}

function buildAdventureSearchBlob(adv,charKey,{includeCharacterInfo=false}={}){
  if(!adv || typeof adv!=='object') return '';
  const pipeline=getDataPipeline();
  if(pipeline && typeof pipeline.buildAdventureSearchText==='function'){
    const character=(DATA && DATA.characters && DATA.characters[charKey])||null;
    return pipeline.buildAdventureSearchText(adv,charKey,{ includeCharacterInfo, character });
  }
  const baseParts=[
    adv.title,
    adv.code,
    adv.notes,
    adv.dm
  ];
  if(adv.trade && typeof adv.trade==='object'){
    baseParts.push(adv.trade.given);
    baseParts.push(adv.trade.received);
    baseParts.push(adv.trade.partnerCharacter);
    baseParts.push(adv.trade.partnerPlayer);
  }else{
    baseParts.push(adv.traded_item);
    baseParts.push(adv.itemTraded);
    baseParts.push(adv.itemReceived);
    baseParts.push(adv.player);
    baseParts.push(adv.character);
  }
  if(Array.isArray(adv.lost_perm_item)){
    baseParts.push(...adv.lost_perm_item);
  }else{
    baseParts.push(adv.lost_perm_item);
  }
  if(Array.isArray(adv.perm_items)){
    baseParts.push(...adv.perm_items);
  }
  if(Array.isArray(adv.consumable_items)){
    baseParts.push(...adv.consumable_items);
  }
  if(includeCharacterInfo){
    const charObj=(DATA && DATA.characters && DATA.characters[charKey])||null;
    if(charObj){
      baseParts.push(String(charObj.display_name||''));
      baseParts.push(String(charObj.sheet||''));
    }
    baseParts.push(String(charKey||''));
  }
  return baseParts
    .filter(value=>value!=null)
    .map(value=>String(value).toLowerCase())
    .join(' ');
}

function createAdventureEntry(adv,idx,charKey,{includeCharacterInfo=false}={}){
  if(!adv || typeof adv!=='object') return null;
  if(!adv.__charKey){
    adv.__charKey=charKey;
  }
  ensureAdventureEntryKey(adv);
  return {
    adv,
    idx,
    charKey,
    searchBlob:buildAdventureSearchBlob(adv,charKey,{includeCharacterInfo})
  };
}

function getCharacterAdventureEntries(key){
  if(!isValidSheetKey(key) || isDmLogKey(key)) return [];
  if(adventureSearchCache.byCharacter.has(key)){
    return adventureSearchCache.byCharacter.get(key);
  }
  if(!DATA || !DATA.characters || !DATA.characters[key]) return [];
  sortCharacterAdventures(key);
  const advs=(DATA.characters[key]&&DATA.characters[key].adventures)||[];
  const entries=[];
  advs.forEach((adv,idx)=>{
    const entry=createAdventureEntry(adv,idx,key);
    if(entry) entries.push(entry);
  });
  adventureSearchCache.byCharacter.set(key,entries);
  return entries;
}

function buildAllAdventureEntries(){
  if(!DATA || !DATA.characters) return [];
  const entries=[];
  let globalIndex=0;
  Object.entries(DATA.characters).forEach(([charKey,ch])=>{
    if(!ch || !Array.isArray(ch.adventures)) return;
    sortCharacterAdventures(charKey);
    ch.adventures.forEach((adv)=>{
      const entry=createAdventureEntry(adv,globalIndex,charKey,{includeCharacterInfo:true});
      if(entry){
        entry.index=globalIndex;
        globalIndex+=1;
        entries.push(entry);
      }else{
        globalIndex+=1;
      }
    });
  });
  entries.sort(compareChronoDesc);
  return entries;
}

function getAllAdventureEntries(){
  if(adventureSearchCache.all) return adventureSearchCache.all;
  adventureSearchCache.all=buildAllAdventureEntries();
  return adventureSearchCache.all;
}

function updateSaveIndicatorState(){
  if(saveIndicator){
    const showSpinner=!!savingData;
    saveIndicator.classList.toggle('active',showSpinner);
    saveIndicator.setAttribute('aria-hidden',showSpinner?'false':'true');
  }
  if(saveStatusMessage){
    let message='';
    if(savingData){
      message='Saving changes';
    }else if(lastSaveResult==='error'){
      message='Failed to save changes.';
    }else if(lastSaveResult==='success' && !pendingChanges){
      message='Changes saved.';
    }else if(pendingChanges){
      message='Unsaved changes pending.';
    }
    saveStatusMessage.textContent=message;
  }
}

function setSaveResult(state){
  lastSaveResult=state;
  clearTimeout(saveFeedbackTimeout);
  if(state==='success'){
    saveFeedbackTimeout=setTimeout(()=>{
      if(lastSaveResult==='success'){
        lastSaveResult=null;
        updateSaveIndicatorState();
      }
    },2500);
  }
  updateSaveIndicatorState();
}

function anyModalOpen(){
  return (invModal && invModal.classList.contains('open'))
    || (consModal && consModal.classList.contains('open'))
    || (dmItemsModal && dmItemsModal.classList.contains('open'))
    || (tradeModal && tradeModal.classList.contains('open'))
    || (dataQualityModal && dataQualityModal.classList.contains('open'))
    || (cardOverlay && cardOverlay.classList.contains('open'));
}

function refreshModalState(){
  if(anyModalOpen()){ document.body.classList.add('modal-open'); }
  else{ document.body.classList.remove('modal-open'); }
}

function closeAddMenu({immediate=false}={}){
  if(addCardBtn){
    addCardBtn.setAttribute('aria-expanded','false');
  }
  if(!addCardMenu) return;
  const cleanup=()=>{ addCardMenu.innerHTML=''; };
  if(immediate){
    addCardMenu.setAttribute('aria-hidden','true');
    addCardMenu.hidden=true;
    delete addCardMenu.dataset.menuState;
    clearMenuTransitionDuration(addCardMenu);
    cleanup();
    return;
  }
  animateMenuClose(addCardMenu,cleanup);
}

function dispatchDmNewEntry(type){
  if(!type) return;
  window.dispatchEvent(new CustomEvent('dm:new-entry',{detail:{type}}));
}

const DM_SEASON_DATALIST_ID='dm-allocation-season-options';

function getKnownDmSeasonLabels(){
  const seasons=new Set();
  if(DM_DATA && DM_DATA.seasonal && typeof DM_DATA.seasonal==='object'){
    Object.keys(DM_DATA.seasonal).forEach(label=>{
      const normalized=dmNormalizeSeasonLabel(label);
      if(normalized) seasons.add(normalized);
    });
  }
  if(Array.isArray(DM_ENTRIES)){
    DM_ENTRIES.forEach(entry=>{
      if(entry && entry.season){
        const normalized=dmNormalizeSeasonLabel(entry.season);
        if(normalized) seasons.add(normalized);
      }
    });
  }
  if(DATA && Array.isArray(DATA.dm_allocations)){
    DATA.dm_allocations.forEach(alloc=>{
      if(alloc && alloc.season){
        const normalized=dmNormalizeSeasonLabel(alloc.season);
        if(normalized) seasons.add(normalized);
      }
    });
  }
  return Array.from(seasons).sort((a,b)=>a.localeCompare(b,undefined,{numeric:true,sensitivity:'base'}));
}

function createDmAllocationId(){
  const ts=Date.now().toString(36);
  const rand=Math.random().toString(36).slice(2,8);
  return `dmAlloc_${ts}_${rand}`;
}

function parseDmAllocationList(value){
  if(value==null) return [];
  const text=String(value).replace(/\r\n?/g,'\n').trim();
  if(!text) return [];
  return text.split(/[\n;,]+/).map(item=>item.trim()).filter(Boolean);
}

function buildDmAllocationSummaryText({charName='',items=[],consumables=[],gifts=[],gp=null,dtd=null,levels=null}){
  const parts=[];
  [...items,...consumables,...gifts].forEach(item=>{ if(item) parts.push(item); });
  if(Number.isFinite(gp) && gp!==0){
    const formatted=fmtNumber(Math.abs(gp));
    const label=gp>=0?`${formatted} gp`:`-${formatted} gp`;
    parts.push(label);
  }
  if(Number.isFinite(dtd) && dtd!==0){
    const formatted=fmtNumber(Math.abs(dtd));
    const label=dtd>=0?`${formatted} DTD`:`-${formatted} DTD`;
    parts.push(label);
  }
  if(Number.isFinite(levels) && levels>0){
    const formatted=fmtNumber(levels);
    parts.push(levels===1?'Level':`Levels (x${formatted})`);
  }
  let summary=parts.join(' + ');
  if(charName){
    if(summary){
      summary+=` to ${charName}`;
    }else{
      summary=`Reward to ${charName}`;
    }
  }
  return summary;
}

function resolveDefaultDmSeason(){
  if(Array.isArray(DM_ENTRIES) && DM_ENTRIES.length){
    const latest=DM_ENTRIES.find(entry=>entry && entry.season);
    if(latest && latest.season){
      return dmNormalizeSeasonLabel(latest.season);
    }
  }
  const knownSeasons=getKnownDmSeasonLabels();
  return knownSeasons.length?knownSeasons[0]:'';
}

function openNewDmAllocationModal(){
  if(!DATA || !DATA.characters){
    window.alert('Character data must be loaded before creating a DM allocation.');
    return;
  }
  const characterKeys=Object.keys(DATA.characters||{});
  if(!characterKeys.length){
    window.alert('Add a character before creating a DM allocation.');
    return;
  }
  ensureDerivedStores();
  closeAddMenu();

  const card=document.createElement('article');
  card.className='card overlay-card dm-allocation-editor';
  card.setAttribute('role','dialog');
  card.setAttribute('aria-modal','true');
  card.setAttribute('aria-label','New DM reward allocation');

  const header=document.createElement('div');
  header.className='card-hd';
  const headerContent=document.createElement('div');
  headerContent.className='dm-allocation-header';
  const title=document.createElement('h2');
  title.textContent='New DM reward allocation';
  const subtitle=document.createElement('p');
  subtitle.textContent='Creates a DM log entry and adds a DM reward to the selected character.';
  headerContent.append(title,subtitle);
  header.appendChild(headerContent);
  card.appendChild(header);

  const body=document.createElement('div');
  body.className='card-bd';
  const form=document.createElement('form');
  form.className='dm-allocation-form';
  form.noValidate=true;

  const grid=document.createElement('div');
  grid.className='dm-allocation-grid';
  form.appendChild(grid);

  const charGroup=document.createElement('div');
  charGroup.className='field-group';
  const charLabel=document.createElement('label'); charLabel.textContent='Character';
  charLabel.setAttribute('for','dmAllocationCharacter');
  const charSelect=document.createElement('select');
  charSelect.id='dmAllocationCharacter';
  charSelect.required=true;
  const placeholderOption=document.createElement('option');
  placeholderOption.value='';
  placeholderOption.textContent='Select a character';
  charSelect.appendChild(placeholderOption);
  const charOptions=characterKeys.map(key=>({ key, name:getCharacterDisplayName(key)||key }))
    .sort((a,b)=>a.name.localeCompare(b.name,undefined,{sensitivity:'base'}));
  charOptions.forEach(({key,name})=>{
    const opt=document.createElement('option');
    opt.value=key;
    opt.textContent=name;
    charSelect.appendChild(opt);
  });
  const defaultChar=(charSel && isValidSheetKey(charSel.value) && !isDmLogKey(charSel.value))?charSel.value:'';
  if(defaultChar){
    charSelect.value=defaultChar;
  }
  charGroup.append(charLabel,charSelect);
  grid.appendChild(charGroup);

  const seasonGroup=document.createElement('div');
  seasonGroup.className='field-group';
  const seasonLabel=document.createElement('label'); seasonLabel.textContent='Season';
  seasonLabel.setAttribute('for','dmAllocationSeason');
  const seasonInput=document.createElement('input');
  seasonInput.type='text';
  seasonInput.id='dmAllocationSeason';
  seasonInput.placeholder='e.g. Season 13a';
  seasonInput.setAttribute('list', DM_SEASON_DATALIST_ID);
  const defaultSeason=resolveDefaultDmSeason();
  if(defaultSeason){ seasonInput.value=defaultSeason; }
  seasonGroup.append(seasonLabel, seasonInput);
  grid.appendChild(seasonGroup);

  let seasonList=document.getElementById(DM_SEASON_DATALIST_ID);
  if(seasonList){ seasonList.remove(); }
  seasonList=document.createElement('datalist');
  seasonList.id=DM_SEASON_DATALIST_ID;
  getKnownDmSeasonLabels().forEach(label=>{
    const option=document.createElement('option');
    option.value=label;
    seasonList.appendChild(option);
  });

  const dateGroup=document.createElement('div');
  dateGroup.className='field-group';
  const dateLabel=document.createElement('label'); dateLabel.textContent='Date';
  dateLabel.setAttribute('for','dmAllocationDate');
  const dateInput=document.createElement('input');
  dateInput.type='date';
  dateInput.id='dmAllocationDate';
  try{ dateInput.value=new Date().toISOString().slice(0,10); }
  catch(err){ /* ignore */ }
  dateGroup.append(dateLabel,dateInput);
  grid.appendChild(dateGroup);

  const locationGroup=document.createElement('div');
  locationGroup.className='field-group';
  const locationLabel=document.createElement('label'); locationLabel.textContent='Location (optional)';
  locationLabel.setAttribute('for','dmAllocationLocation');
  const locationInput=document.createElement('input');
  locationInput.type='text';
  locationInput.id='dmAllocationLocation';
  locationInput.placeholder='Table, store, or event name';
  locationGroup.append(locationLabel,locationInput);
  grid.appendChild(locationGroup);

  const costGroup=document.createElement('div');
  costGroup.className='field-group';
  const costLabel=document.createElement('label'); costLabel.textContent='Seasonal cost (hours spent)';
  costLabel.setAttribute('for','dmAllocationCost');
  const costInput=document.createElement('input');
  costInput.type='number';
  costInput.step='any';
  costInput.min='0';
  costInput.id='dmAllocationCost';
  costInput.placeholder='Optional';
  costGroup.append(costLabel,costInput);
  grid.appendChild(costGroup);

  const gpGroup=document.createElement('div');
  gpGroup.className='field-group';
  const gpLabel=document.createElement('label'); gpLabel.textContent='Gold (gp)';
  gpLabel.setAttribute('for','dmAllocationGold');
  const gpInput=document.createElement('input');
  gpInput.type='number';
  gpInput.step='any';
  gpInput.id='dmAllocationGold';
  gpInput.placeholder='Positive values award GP';
  gpGroup.append(gpLabel,gpInput);
  grid.appendChild(gpGroup);

  const dtdGroup=document.createElement('div');
  dtdGroup.className='field-group';
  const dtdLabel=document.createElement('label'); dtdLabel.textContent='Downtime (DTD)';
  dtdLabel.setAttribute('for','dmAllocationDtd');
  const dtdInput=document.createElement('input');
  dtdInput.type='number';
  dtdInput.step='any';
  dtdInput.id='dmAllocationDtd';
  dtdInput.placeholder='Positive values award DTD';
  dtdGroup.append(dtdLabel,dtdInput);
  grid.appendChild(dtdGroup);

  const levelsGroup=document.createElement('div');
  levelsGroup.className='field-group';
  const levelsLabel=document.createElement('label'); levelsLabel.textContent='Levels granted';
  levelsLabel.setAttribute('for','dmAllocationLevels');
  const levelsWrap=document.createElement('div');
  levelsWrap.className='dm-allocation-inline';
  const levelsInput=document.createElement('input');
  levelsInput.type='number';
  levelsInput.step='1';
  levelsInput.min='0';
  levelsInput.id='dmAllocationLevels';
  levelsInput.placeholder='0';
  const earnLevelWrap=document.createElement('label');
  earnLevelWrap.className='checkbox-label';
  const earnLevelInput=document.createElement('input');
  earnLevelInput.type='checkbox';
  earnLevelInput.id='dmAllocationEarnLevel';
  earnLevelWrap.append(earnLevelInput,document.createTextNode('Earns DM level back'));
  levelsWrap.append(levelsInput,earnLevelWrap);
  levelsGroup.append(levelsLabel,levelsWrap);
  grid.appendChild(levelsGroup);

  const itemsGroup=document.createElement('div');
  itemsGroup.className='field-group full-width';
  const itemsLabel=document.createElement('label'); itemsLabel.textContent='Magic items (one per line)';
  itemsLabel.setAttribute('for','dmAllocationItems');
  const itemsArea=document.createElement('textarea');
  itemsArea.id='dmAllocationItems';
  itemsArea.placeholder='Example: Vorpal Sword';
  itemsGroup.append(itemsLabel,itemsArea);
  grid.appendChild(itemsGroup);

  const consumablesGroup=document.createElement('div');
  consumablesGroup.className='field-group full-width';
  const consumablesLabel=document.createElement('label'); consumablesLabel.textContent='Consumables (optional)';
  consumablesLabel.setAttribute('for','dmAllocationConsumables');
  const consumablesArea=document.createElement('textarea');
  consumablesArea.id='dmAllocationConsumables';
  consumablesArea.placeholder='Example: Potion of Healing';
  consumablesGroup.append(consumablesLabel,consumablesArea);
  grid.appendChild(consumablesGroup);

  const giftsGroup=document.createElement('div');
  giftsGroup.className='field-group full-width';
  const giftsLabel=document.createElement('label'); giftsLabel.textContent='Supernatural gifts (optional)';
  giftsLabel.setAttribute('for','dmAllocationGifts');
  const giftsArea=document.createElement('textarea');
  giftsArea.id='dmAllocationGifts';
  giftsArea.placeholder='Example: Blessing of Protection';
  giftsGroup.append(giftsLabel,giftsArea);
  grid.appendChild(giftsGroup);

  const notesGroup=document.createElement('div');
  notesGroup.className='field-group full-width';
  const notesLabel=document.createElement('label'); notesLabel.textContent='Notes (optional)';
  notesLabel.setAttribute('for','dmAllocationNotes');
  const notesArea=document.createElement('textarea');
  notesArea.id='dmAllocationNotes';
  notesArea.rows=3;
  notesArea.placeholder='Notes that will appear on the character\'s DM reward entry.';
  notesGroup.append(notesLabel,notesArea);
  grid.appendChild(notesGroup);

  const summaryGroup=document.createElement('div');
  summaryGroup.className='field-group full-width';
  const summaryLabel=document.createElement('label'); summaryLabel.textContent='Allocation summary';
  summaryLabel.setAttribute('for','dmAllocationSummary');
  const summaryArea=document.createElement('textarea');
  summaryArea.id='dmAllocationSummary';
  summaryArea.required=true;
  summaryArea.rows=3;
  summaryArea.placeholder='Describe the rewards allocated';
  const summaryActions=document.createElement('div');
  summaryActions.className='dm-allocation-summary-actions';
  const regenerateBtn=document.createElement('button');
  regenerateBtn.type='button';
  regenerateBtn.className='btn small';
  regenerateBtn.textContent='Generate summary';
  summaryActions.appendChild(regenerateBtn);
  summaryGroup.append(summaryLabel,summaryArea,summaryActions);
  form.appendChild(summaryGroup);

  const errorEl=document.createElement('div');
  errorEl.className='dm-allocation-error';
  errorEl.setAttribute('role','alert');
  form.appendChild(errorEl);

  const actions=document.createElement('div');
  actions.className='dm-allocation-actions';
  const cancelBtn=document.createElement('button');
  cancelBtn.type='button';
  cancelBtn.className='btn small';
  cancelBtn.textContent='Cancel';
  cancelBtn.addEventListener('click',()=>{ closeCardOverlay(); });
  const saveBtn=document.createElement('button');
  saveBtn.type='submit';
  saveBtn.className='btn small primary';
  saveBtn.textContent='Create allocation';
  actions.append(cancelBtn,saveBtn);
  form.appendChild(actions);

  body.appendChild(form);
  card.appendChild(body);
  card.appendChild(seasonList);

  const parseNumericInput=(input)=>{
    const raw=(input && typeof input.value==='string')?input.value.trim():'';
    if(!raw) return null;
    const num=Number(raw);
    return Number.isFinite(num)?num:null;
  };

  const generateSummary=()=>{
    const gp=parseNumericInput(gpInput);
    const dtd=parseNumericInput(dtdInput);
    const levels=parseNumericInput(levelsInput);
    return buildDmAllocationSummaryText({
      charName:getCharacterDisplayName(charSelect.value)||'',
      items:parseDmAllocationList(itemsArea.value),
      consumables:parseDmAllocationList(consumablesArea.value),
      gifts:parseDmAllocationList(giftsArea.value),
      gp,
      dtd,
      levels
    });
  };

  regenerateBtn.addEventListener('click',(event)=>{
    event.preventDefault();
    const nextSummary=generateSummary();
    if(nextSummary){
      summaryArea.value=nextSummary;
    }
    summaryArea.focus();
  });

  charSelect.addEventListener('change',()=>{
    if(!summaryArea.value.trim()){
      const nextSummary=generateSummary();
      if(nextSummary){ summaryArea.value=nextSummary; }
    }
  });

  if(!summaryArea.value.trim()){
    const initialSummary=generateSummary();
    if(initialSummary){ summaryArea.value=initialSummary; }
  }

  form.addEventListener('submit',async(event)=>{
    event.preventDefault();
    errorEl.textContent='';
    const charKey=charSelect.value;
    if(!isValidSheetKey(charKey) || isDmLogKey(charKey)){
      errorEl.textContent='Select a character to receive the reward allocation.';
      try{ charSelect.focus({preventScroll:true}); }
      catch(err){ charSelect.focus(); }
      return;
    }
    const summaryValue=summaryArea.value.trim();
    if(!summaryValue){
      errorEl.textContent='Enter an allocation summary.';
      summaryArea.focus();
      return;
    }
    const seasonValue=dmNormalizeSeasonLabel(seasonInput.value.trim());
    const dateValue=(dateInput && dateInput.value)?dateInput.value.trim():'';
    let rewardDate=null;
    if(dateValue){
      const parsed=new Date(dateValue);
      if(!Number.isNaN(parsed.getTime())){
        rewardDate=dateValue;
      }
    }
    if(!rewardDate){
      try{ rewardDate=new Date().toISOString().slice(0,10); }
      catch(err){ rewardDate=''; }
    }
    const dmDate=rewardDate?`${rewardDate}T00:00:00`:'';
    const locationValue=locationInput.value.trim();
    const costValue=parseNumericInput(costInput);
    const gpValue=parseNumericInput(gpInput);
    const dtdValue=parseNumericInput(dtdInput);
    const levelsValue=parseNumericInput(levelsInput);
    const levelsGranted=Number.isFinite(levelsValue)&&levelsValue>0?levelsValue:0;
    const permItems=parseDmAllocationList(itemsArea.value);
    const consumables=parseDmAllocationList(consumablesArea.value);
    const gifts=parseDmAllocationList(giftsArea.value);
    const notesValue=notesArea.value.trim();
    const earnLevel=!!earnLevelInput.checked;

    const gpPlus=(Number.isFinite(gpValue) && gpValue>0)?gpValue:0;
    const gpMinus=(Number.isFinite(gpValue) && gpValue<0)?Math.abs(gpValue):0;
    const gpNet=gpPlus-gpMinus;
    const dtdPlus=(Number.isFinite(dtdValue) && dtdValue>0)?dtdValue:0;
    const dtdMinus=(Number.isFinite(dtdValue) && dtdValue<0)?Math.abs(dtdValue):0;
    const dtdNet=dtdPlus-dtdMinus;

    const allocationId=createDmAllocationId();

    const charObj=DATA.characters[charKey];
    if(!charObj){
      errorEl.textContent='Selected character could not be found.';
      return;
    }
    if(!Array.isArray(charObj.adventures)){
      charObj.adventures=[];
    }

    const rewardEntry={
      title:levelsGranted>1?`DM Reward (x${levelsGranted})`:'DM Reward',
      date:rewardDate||'',
      code:'DM-REWARD',
      dm:null,
      gp_plus:gpPlus,
      gp_minus:gpMinus,
      gp_net:gpNet,
      dtd_plus:dtdPlus,
      dtd_minus:dtdMinus,
      dtd_net:dtdNet,
      level_plus:levelsGranted>0?levelsGranted:0,
      perm_items:permItems.slice(),
      consumable_items:consumables.slice(),
      story_awards:[],
      supernatural_gifts:gifts.slice(),
      notes:notesValue||summaryValue,
      kind:'Downtime Activity',
      __charKey:charKey,
      __dmAllocationId:allocationId
    };

    charObj.adventures.unshift(rewardEntry);

    const allocationRecord={
      id:allocationId,
      season:seasonValue||'',
      date:dmDate,
      allocation:summaryValue,
      cost:costValue!=null?costValue:null,
      levels_plus:levelsGranted>0?levelsGranted:null,
      levels_minus:(earnLevel && levelsGranted>0)?1:null,
      hours:null,
      extra_hours:null,
      location:locationValue,
      gp:(Number.isFinite(gpValue) && gpValue<0)?Math.abs(gpValue):null,
      charKey:charKey,
      reward:{
        gp:gpNet,
        dtd:dtdNet,
        levels:levelsGranted,
        perm_items:permItems.slice(),
        consumable_items:consumables.slice(),
        supernatural_gifts:gifts.slice(),
        notes:notesValue||summaryValue,
        summary:summaryValue
      },
      earns_level:earnLevel
    };

    const saveLabel=saveBtn.textContent;
    saveBtn.disabled=true;
    saveBtn.setAttribute('aria-busy','true');
    saveBtn.textContent='Saving';
    try{
      ensureDerivedStores();
      if(!Array.isArray(DATA.dm_allocations)){
        DATA.dm_allocations=[];
      }
      DATA.dm_allocations.unshift(allocationRecord);
      registerDerivedUpdate(charKey);
      markDirty();
      buildDmEntries();
      applyDataMutation(charKey);
      const dmEntry=Array.isArray(DM_ENTRIES)?DM_ENTRIES.find(entry=>entry && entry.id===allocationId):null;
      if(dmEntry){
        navigateToDmAllocation(dmEntry);
      }else{
        filterAndRender();
      }
      closeCardOverlay();
      await saveDataJs();
    }catch(err){
      console.error('Failed to create DM allocation', err);
      if(cardOverlay && cardOverlay.classList.contains('open')){
        errorEl.textContent='Could not create allocation. Please try again.';
      }
      return;
    }finally{
      saveBtn.disabled=false;
      saveBtn.removeAttribute('aria-busy');
      saveBtn.textContent=saveLabel;
    }
  });

  openCardOverlay(card);
  expandCard(card);
  try{ charSelect.focus({preventScroll:true}); }
  catch(err){ charSelect.focus(); }
}

window.addEventListener('dm:new-entry',(event)=>{
  const detail=event && event.detail;
  if(!detail) return;
  if(detail.type==='allocation'){
    openNewDmAllocationModal();
  }
});

function buildAddMenuOptions(){
  if(!charSel) return [];
  const key=charSel.value;
  if(isDmLogKey(key)){
    if(!hasDmLogData()) return [];
    return [
      {label:'New session', action:()=>dispatchDmNewEntry('session')},
      {label:'New allocation', action:()=>dispatchDmNewEntry('allocation')}
    ];
  }
  if(!isValidSheetKey(key)) return [];
  return [
    {label:'New adventure', action:()=>createCharacterNewEntry('adventure')},
    {label:'Downtime activity', action:()=>createCharacterNewEntry('Downtime Activity')}
  ];
}

function openAddMenu(){
  if(!addCardMenu||!addCardBtn) return;
  closeCharMenu();
  const options=buildAddMenuOptions();
  if(!options.length){
    closeAddMenu();
    return;
  }
  addCardMenu.innerHTML='';
  options.forEach(option=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='fab-menu-item';
    btn.textContent=option.label;
    btn.setAttribute('role','menuitem');
    btn.addEventListener('click',()=>{
      closeAddMenu();
      option.action();
    });
    addCardMenu.appendChild(btn);
  });
  animateMenuOpen(addCardMenu);
  addCardBtn.setAttribute('aria-expanded','true');
  const first=addCardMenu.querySelector('button');
  if(first){
    try{ first.focus({preventScroll:true}); }
    catch(err){ first.focus(); }
  }
}

function openCardOverlay(card){
  if(!cardOverlay || !card) return;
  closeAddMenu();
  cardOverlay.innerHTML='';
  cardOverlay.appendChild(card);
  cardOverlay.classList.add('open');
  cardOverlay.setAttribute('aria-hidden','false');
  overlayCard=card;
  refreshModalState();
}

function closeCardOverlay(){
  if(!cardOverlay) return;
  cardOverlay.classList.remove('open');
  cardOverlay.setAttribute('aria-hidden','true');
  overlayCard=null;
  cardOverlay.innerHTML='';
  refreshModalState();
}

function createCharacterNewEntry(kind){
  if(!DATA || !DATA.characters || !charSel) return;
  const key=charSel.value;
  if(!isValidSheetKey(key) || !DATA.characters[key]) return;
  const normalized=kind==='Downtime Activity'?'Downtime Activity':'adventure';
  const isActivity=normalized!=='adventure';
  const today=new Date().toISOString().slice(0,10);
  const estimatedLevel=currentLevelFor(key);
  const template={
    date:today,
    title:isActivity?'New Downtime Activity':'New Adventure',
    code:'',
    dm:'',
    gp_plus:0,
    gp_minus:0,
    dtd_plus:0,
    dtd_minus:0,
    level_plus:0,
    perm_items:[],
    lost_perm_item:[],
    consumable_items:[],
    supernatural_gifts:[],
    notes:'',
    kind:normalized,
    trade:null,
    __openEdit:true,
    __isNew:true,
    __charKey:key,
    __lockedKind:normalized,
    __levelAtStart:Number.isFinite(estimatedLevel)?estimatedLevel:null
  };
  ensureAdventureUid(template);
  const card=makeCard(template,-1);
  card.classList.add('overlay-card');
  openCardOverlay(card);
}

function loadDataDraft(){
  try{
    const raw=localStorage.getItem(DATA_DRAFT_STORAGE_KEY);
    if(!raw){
      return null;
    }
    const parsed=JSON.parse(raw);
    if(parsed && typeof parsed==='object' && parsed.data){
      hasLocalDraft=true;
      return parsed;
    }
  }catch(err){
    if(!draftLoadWarningShown){
      draftLoadWarningShown=true;
      console.warn('Unable to load data.js draft from storage', err);
    }
    try{ localStorage.removeItem(DATA_DRAFT_STORAGE_KEY); }
    catch(_){ /* no-op */ }
  }
  return null;
}
function persistDataDraft(){
  if(!DATA||typeof DATA!=='object') return;
  try{
    const snapshot=getSerializableData();
    const serialized=JSON.stringify({
      version:dataVersion||'',
      data:snapshot
    });
    localStorage.setItem(DATA_DRAFT_STORAGE_KEY, serialized);
    hasLocalDraft=true;
  }catch(err){
    if(!draftPersistWarningShown){
      draftPersistWarningShown=true;
      console.warn('Unable to persist data.js draft to storage', err);
    }
  }
}
function clearDataDraft(){
  hasLocalDraft=false;
  try{
    localStorage.removeItem(DATA_DRAFT_STORAGE_KEY);
  }catch(err){
    /* no-op */
  }
}

function discardDraftBeforeNavigation(){
  if(!(pendingChanges || hasLocalDraft)) return;
  clearDataDraft();
}

if(typeof window!=='undefined'){
  window.addEventListener('pagehide',discardDraftBeforeNavigation);
  window.addEventListener('unload',discardDraftBeforeNavigation);
}
function applyDraftIfAvailable({force=false}={}){
  if(draftStateApplied && !force) return false;
  let draft=null;
  try{
    draft=loadDataDraft();
  }catch(err){
    draft=null;
  }
  if(!draft||!draft.data||!draft.data.characters) return false;
  draftStateApplied=true;
  adoptDataPayload(draft.data);
  if(draft.version){
    dataVersion=draft.version;
    window.AL_DATA_VERSION=dataVersion;
  }
  pendingChanges=true;
  lastSaveResult=null;
  clearTimeout(saveFeedbackTimeout);
  hasLocalDraft=true;
  updateSaveIndicatorState();
  return true;
}

function reapplyLocalDraftAndRefresh(){
  const applied=applyDraftIfAvailable({force:true});
  if(applied){
    DATA=window.DATA||DATA;
    if(__appInitialized){
      refreshAllDerivedData();
      rebuildCharacterOptions({preserveSelection:true});
      filterAndRender();
      scheduleAvatarPreload();
    }
  }
  return applied;
}

function markDirty(){
  pendingChanges=true;
  lastSaveResult=null;
  clearTimeout(saveFeedbackTimeout);
  updateSaveIndicatorState();
}
function clearDirty(){
  pendingChanges=false;
  lastSaveResult=null;
  clearTimeout(saveFeedbackTimeout);
  clearDataDraft();
  updateSaveIndicatorState();
}

function touchDataMetaTimestamp(){
  if(!DATA||typeof DATA!=='object') return;
  const meta=DATA.meta;
  if(meta&&typeof meta==='object'){
    try{
      meta.generated=new Date().toISOString();
    }catch(err){
      /* no-op */
    }
  }
}

function saveDataJs(options={}){
  const task=async()=>{
    const { silent=false, dataJs:customDataJs=null, headers:customHeaders=null, endpoint=SAVE_ENDPOINT }=options;
    if(typeof customDataJs!=='string'){
      syncPendingDerivedData();
      touchDataMetaTimestamp();
    }
    const payload=(typeof customDataJs==='string')?customDataJs:buildDataJsPayload();
    const hadPendingChanges=pendingChanges;
    const baseHeaders=(SAVE_HEADERS && typeof SAVE_HEADERS==='object')?SAVE_HEADERS:{};
    const extraHeaders=(customHeaders && typeof customHeaders==='object')?customHeaders:{};
    const headers={
      'content-type':'application/json',
      ...baseHeaders,
      ...extraHeaders
    };
    if(!endpoint){
      const err=new Error('Save endpoint not configured.');
      if(!silent){
        window.alert(err.message);
      }
      throw err;
    }
    savingData=true;
    updateSaveIndicatorState();
    try{
      const response=await fetch(endpoint,{
        method:'POST',
        headers,
        body:JSON.stringify({ dataJs:payload })
      });
      const contentType=response.headers.get('content-type')||'';
      let body=null;
      if(contentType.includes('application/json')){
        try{ body=await response.json(); }
        catch(err){ body=null; }
      }else{
        const text=await response.text();
        body=text?{ message:text }:null;
      }
      if(!response.ok){
        const message=(body&&typeof body==='object' && (body.error||body.message))||response.statusText||'Failed to save data.js.';
        throw new Error(message);
      }
      const versionForSave=String(Date.now());
      setDataVersion(versionForSave);
      let refreshOutcome=null;
      let refreshError=null;
      try{
        refreshOutcome=await refreshDataJsCache({ expectedDataJs:payload, retries:3, retryDelay:800, version:versionForSave });
      }catch(err){
        refreshError=err;
      }
      if(!refreshError && refreshOutcome!==false){
        clearDirty();
        setSaveResult('success');
      }else{
        if(refreshError){
          console.warn('Unable to refresh data.js cache after save', refreshError);
        }else{
          console.warn('Unable to refresh data.js cache after save');
        }
        const shouldPersistDraft=(typeof customDataJs!=='string' && DATA && typeof DATA==='object' && (hadPendingChanges || hasLocalDraft));
        if(shouldPersistDraft){
          persistDataDraft();
        }
        if(hadPendingChanges || hasLocalDraft || shouldPersistDraft){
          pendingChanges=true;
          reapplyLocalDraftAndRefresh();
          setSaveResult(null);
        }
      }
      return body;
    }catch(err){
      console.error('Failed to save data.js', err);
      setSaveResult('error');
      if(!silent){
        const message=(err && err.message)?err.message:String(err);
        window.alert('Failed to save data.js: '+message);
      }
      throw err;
    }finally{
      savingData=false;
      updateSaveIndicatorState();
    }
  };
  const runPromise=saveQueueTail.then(task);
  saveQueueTail=runPromise.catch(()=>{});
  return runPromise;
}

function showDataLoadError(message){
  if(!emptyEl) return;
  markDataLoadErrorActive();
  emptyEl.style.display='block';
  const diagMarkup=buildDataLoadDiagnosticsMarkup();
  const baseMessage=message||'Could not load <code>data.js</code>.';
  emptyEl.innerHTML=baseMessage+diagMarkup;
}

function buildDataLoadDiagnosticsMarkup(){
  const diag=window.__AL_DATA_BOOTSTRAP_DIAG__;
  if(!diag) return '';
  const summaryItems=[];
  if(diag.status){
    summaryItems.push(`<li><strong>Status:</strong> ${escapeHtml(diag.status)}</li>`);
  }
  if(diag.errorMessage){
    summaryItems.push(`<li><strong>Error:</strong> ${escapeHtml(diag.errorMessage)}</li>`);
  }
  if(diag.finalVersion){
    summaryItems.push(`<li><strong>Resolved version:</strong> ${escapeHtml(diag.finalVersion)}</li>`);
  }else if(diag.initialVersion){
    summaryItems.push(`<li><strong>Requested version:</strong> ${escapeHtml(diag.initialVersion)}</li>`);
  }
  const legacyScript=diag.legacyScript||diag.script||null;
  if(legacyScript&&legacyScript.src){
    summaryItems.push(`<li><strong>Legacy script URL:</strong> ${escapeHtml(legacyScript.src)}</li>`);
  }
  const summaryHtml=summaryItems.length?`<ul class="data-diagnostics-summary">${summaryItems.join('')}</ul>`:'';

  let stepsHtml='';
  if(Array.isArray(diag.steps)&&diag.steps.length){
    const items=diag.steps.map((step)=>{
      const ts=formatDiagTimestamp(step&&step.ts);
      const detail=step&&step.detail!=null?escapeHtml(summariseDiagDetail(step.detail)):'No extra detail';
      const tsHtml=ts?` <span class="muted">(${escapeHtml(ts)})</span>`:'';
      return `<li><code>${escapeHtml(step.event||'event')}</code>${tsHtml}<div class="muted">${detail}</div></li>`;
    }).join('');
    stepsHtml=`<details class="data-diagnostics-timeline"><summary>Bootstrap timeline</summary><ol>${items}</ol></details>`;
  }

  let rawHtml='';
  try{
    rawHtml=`<details class="data-diagnostics-raw"><summary>Raw diagnostic payload</summary><pre>${escapeHtml(JSON.stringify(diag,null,2))}</pre></details>`;
  }catch(err){
    rawHtml='';
  }

  return `<div class="data-diagnostics">${summaryHtml}${stepsHtml}${rawHtml}</div>`;
}

function summariseDiagDetail(detail){
  if(detail==null) return '';
  if(typeof detail==='string') return detail;
  if(typeof detail==='number'||typeof detail==='boolean') return String(detail);
  try{
    return JSON.stringify(detail);
  }catch(err){
    return '[unserializable detail]';
  }
}

function formatDiagTimestamp(value){
  if(!value) return '';
  try{
    const date=new Date(value);
    if(Number.isNaN(date.getTime())){
      return String(value);
    }
    return date.toISOString();
  }catch(err){
    return String(value);
  }
}

function escapeHtml(value){
  return String(value==null?'':value)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

function buildDataUrl(version,{cacheBustToken=null}={}){
  const v=(version||'').trim();
  const params=[];
  if(v){
    params.push('v='+encodeURIComponent(v));
  }
  const cbToken=cacheBustToken==null?'' : String(cacheBustToken||'').trim();
  if(cbToken){
    params.push('cb='+encodeURIComponent(cbToken));
  }
  if(params.length){
    return `data.js?${params.join('&')}`;
  }
  return 'data.js';
}

function persistDataVersion(version){
  try{
    if(version){
      localStorage.setItem(DATA_VERSION_KEY, version);
    }else{
      localStorage.removeItem(DATA_VERSION_KEY);
    }
  }catch(err){
    /* no-op */
  }
  try{
    if(version){
      sessionStorage.setItem(DATA_VERSION_KEY, version);
    }else{
      sessionStorage.removeItem(DATA_VERSION_KEY);
    }
  }catch(err){
    /* no-op */
  }
}

function setDataVersion(version){
  dataVersion=version||'';
  window.AL_DATA_VERSION=dataVersion;
  persistDataVersion(dataVersion);
  if(dataScriptEl){
    dataCacheBust=String(Date.now());
    window.AL_DATA_CACHE_BUST=dataCacheBust;
    dataScriptEl.setAttribute('data-version', dataVersion);
    dataScriptEl.setAttribute('data-cache-bust', dataCacheBust);
    const desired=buildDataUrl(dataVersion,{cacheBustToken:dataCacheBust});
    try{
      const absolute=new URL(desired, window.location.href).href;
      if(dataScriptEl.src!==absolute){
        dataScriptEl.src=desired;
      }
    }catch(err){
      dataScriptEl.src=desired;
    }
  }
}

function applyDataJs(text){
  if(typeof text!=='string' || !text.trim()) return;
  const parsed=parseDataPayload(text);
  if(!parsed){
    throw new Error('Unable to parse data.js payload');
  }
  const result=adoptDataPayload(parsed);
  const next=(result && result.data) || window.DATA || null;
  if(!next || !next.characters){
    throw new Error('DATA missing after applying data.js');
  }
  DATA=next;
  refreshAllDerivedData();
  rebuildCharacterOptions({preserveSelection:true});
  filterAndRender();
}

function extractDataPayload(text){
  if(typeof text!=='string') return null;
  const patterns=[
    /window\.DATA\s*=\s*(\{[\s\S]*\})\s*;?\s*$/,
    /export\s+const\s+DATA\s*=\s*(\{[\s\S]*\})\s*;?\s*$/,
    /export\s+default\s*(\{[\s\S]*\})\s*;?\s*$/
  ];
  for(const pattern of patterns){
    const match=text.match(pattern);
    if(match && match[1]){
      return match[1];
    }
  }
  return null;
}

function parseDataPayload(text){
  const payload=extractDataPayload(text);
  if(!payload) return null;
  try{
    return JSON.parse(payload);
  }catch(err){
    return null;
  }
}

function dataPayloadsMatch(a,b){
  const parsedA=parseDataPayload(a);
  const parsedB=parseDataPayload(b);
  if(parsedA && parsedB){
    return JSON.stringify(parsedA)===JSON.stringify(parsedB);
  }
  if(typeof a==='string' && typeof b==='string'){
    return a.trim()===b.trim();
  }
  return false;
}

function wait(ms){
  return new Promise(resolve=>setTimeout(resolve,ms));
}

async function refreshDataJsCache({ expectedDataJs=null, retries=0, retryDelay=500, version=null }={}){
  let attempt=0;
  const pinnedVersion=version?String(version):null;
  let lastMismatchError=null;
  while(attempt<=retries){
    const versionToUse=pinnedVersion||String(Date.now());
    const response=await fetch(buildDataUrl(versionToUse,{cacheBustToken:Date.now()}),{ cache:'reload', headers:{ 'cache-control':'no-cache', pragma:'no-cache' } });
    if(!response.ok){
      throw new Error('HTTP '+response.status);
    }
    const text=await response.text();
    if(!expectedDataJs || dataPayloadsMatch(text, expectedDataJs)){
      applyDataJs(text);
      setDataVersion(versionToUse);
      return true;
    }
    lastMismatchError=new Error('Latest data.js did not match the newly saved content.');
    if(attempt===retries){
      console.warn('Latest data.js did not match newly saved content; giving up on cache refresh for now.');
      throw lastMismatchError;
    }
    attempt+=1;
    await wait(retryDelay);
  }
  if(lastMismatchError){
    throw lastMismatchError;
  }
}

function getCharMenuItems(){
  if(!charSelMenu) return [];
  return Array.from(charSelMenu.querySelectorAll('.char-menu-item'));
}

function focusCharMenuItem(item){
  if(!item) return;
  try{ item.focus({preventScroll:true}); }
  catch(err){ item.focus(); }
  try{ item.scrollIntoView({block:'nearest'}); }
  catch(err){ /* no-op */ }
}

function syncCharacterSelectorUI(){
  const selectedOption=(charSel && charSel.options && charSel.selectedIndex>=0)?charSel.options[charSel.selectedIndex]:null;
  const override=getHeaderOverride();
  const overrideLabel=override && override.label ? override.label.trim() : '';
  const labelText=overrideLabel || (selectedOption?selectedOption.textContent.trim():'');
  const finalLabel=labelText||DEFAULT_CHARACTER_MENU_LABEL;
  if(charSelDisplay){
    charSelDisplay.textContent=finalLabel;
    if(typeof charSelDisplay.__refreshScroll==='function'){
      charSelDisplay.__refreshScroll();
    }
  }
  if(charSelToggle){
    const titleText=(override && override.title)?override.title:finalLabel;
    charSelToggle.title=titleText;
    const hasOptions=!!(charSel && charSel.options && charSel.options.length);
    charSelToggle.disabled=!hasOptions;
    charSelToggle.setAttribute('aria-disabled',hasOptions?'false':'true');
  }
  tickerRowRegistry.schedule();
  if(!charSelMenu) return;
  const currentValue=(charSel&&charSel.value)||'';
  getCharMenuItems().forEach(item=>{
    const isActive=item.dataset&&item.dataset.value===currentValue;
    item.classList.toggle('active',isActive);
    item.setAttribute('aria-selected',isActive?'true':'false');
  });
}

function rebuildCharacterMenu(){
  if(!charSelMenu||!charSel) return;
  const previousScroll=charSelMenu.scrollTop||0;
  charSelMenu.innerHTML='';
  const options=Array.from(charSel.options||[]);
  if(!options.length){
    charSelMenu.scrollTop=0;
    syncCharacterSelectorUI();
    return;
  }
  let currentTierId=null;
  let itemIndex=0;
  options.forEach((opt)=>{
    if(opt.disabled) return;
    const tierId=opt.dataset?opt.dataset.tierId||'':'';
    const tierLabel=opt.dataset?opt.dataset.tierLabel||'':'';
    if(tierId && tierLabel && tierId!==currentTierId){
      const header=document.createElement('div');
      header.className=`char-menu-group char-menu-group--${tierId}`;
      header.textContent=tierLabel;
      header.setAttribute('role','presentation');
      header.setAttribute('aria-hidden','true');
      charSelMenu.appendChild(header);
      currentTierId=tierId;
    }else if(!tierId){
      currentTierId=null;
    }
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='char-menu-item';
    btn.id=`char-menu-item-${itemIndex}`;
    btn.dataset.value=opt.value;
    btn.setAttribute('role','option');
    const text=document.createElement('span');
    text.className='char-menu-text';
    text.textContent=opt.textContent||opt.value||DEFAULT_CHARACTER_MENU_LABEL;
    const check=document.createElement('span');
    check.className='char-menu-check';
    check.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.5 10 17l9-10"/></svg>';
    btn.appendChild(text);
    btn.appendChild(check);
    btn.addEventListener('click',()=>{
      selectCharacterFromMenu(opt.value);
    });
    charSelMenu.appendChild(btn);
    itemIndex++;
  });
  charSelMenu.scrollTop=previousScroll;
  if(isMenuOpen(charSelMenu)){
    scheduleCharMenuReposition();
  }
  syncCharacterSelectorUI();
}

function resolveSidebarAvatarSrc(key){
  if(!key) return AVATAR_FALLBACK_PATH||'';
  const obj=DATA && DATA.characters ? DATA.characters[key] : null;
  const candidates=buildAvatarCandidates(key,obj||null);
  if(Array.isArray(candidates)){
    const usable=candidates.find(path=>path);
    if(usable) return usable;
  }
  return AVATAR_FALLBACK_PATH||'';
}

function createCharacterSidebarButton(key,label){
  const li=document.createElement('li');
  const btn=document.createElement('button');
  btn.type='button';
  btn.className='character-sidebar-item';
  btn.dataset.value=key;
  const avatar=document.createElement('img');
  avatar.className='character-sidebar-avatar';
  avatar.alt='';
  avatar.loading='lazy';
  const avatarSrc=resolveSidebarAvatarSrc(key);
  if(avatarSrc){
    avatar.src=avatarSrc;
    if(AVATAR_FALLBACK_PATH){
      avatar.addEventListener('error',()=>{
        if(avatar.dataset.fallbackApplied==='true') return;
        avatar.dataset.fallbackApplied='true';
        avatar.src=AVATAR_FALLBACK_PATH;
      });
    }
  }
  const nameSpan=document.createElement('span');
  nameSpan.className='character-sidebar-name';
  nameSpan.textContent=label;
  btn.appendChild(avatar);
  btn.appendChild(nameSpan);
  btn.addEventListener('click',()=>{
    if(!charSel) return;
    if(charSel.value===key){
      filterAndRender();
      return;
    }
    selectCharacterFromMenu(key,{focusToggle:false});
  });
  li.appendChild(btn);
  return { li, btn };
}

function rebuildCharacterSidebar(){
  if(!characterSidebarList){
    return;
  }
  characterSidebarButtons.clear();
  characterSidebarList.innerHTML='';
  const options=charSel?Array.from(charSel.options||[]):[];
  const charOptions=options.filter(opt=>isValidSheetKey(opt.value) && !isDmLogKey(opt.value));
  if(!charOptions.length){
    characterSidebarList.setAttribute('aria-hidden','true');
    if(characterSidebarEmpty){
      characterSidebarEmpty.hidden=false;
      characterSidebarEmpty.setAttribute('aria-hidden','false');
    }
    return;
  }
  characterSidebarList.setAttribute('aria-hidden','false');
  if(characterSidebarEmpty){
    characterSidebarEmpty.hidden=true;
    characterSidebarEmpty.setAttribute('aria-hidden','true');
  }
  charOptions.forEach(opt=>{
    const key=opt.value;
    const label=opt.textContent||key;
    const { li, btn }=createCharacterSidebarButton(key,label);
    characterSidebarList.appendChild(li);
    characterSidebarButtons.set(key,btn);
  });
  updateCharacterSidebarSelection(charSel?charSel.value:null);
}

function updateCharacterSidebarSelection(selectedKey){
  characterSidebarButtons.forEach((btn,key)=>{
    const active=key===selectedKey && !isDmLogKey(selectedKey);
    btn.classList.toggle('active',active);
    if(active){
      btn.setAttribute('aria-current','true');
    }else{
      btn.removeAttribute('aria-current');
    }
  });
  if(!characterSidebarButtons.size && characterSidebarEmpty){
    characterSidebarEmpty.hidden=false;
    characterSidebarEmpty.setAttribute('aria-hidden','false');
  }
}

function resetCharMenuPosition(){
  if(!charSelMenu) return;
  charSelMenu.style.removeProperty('top');
  charSelMenu.style.removeProperty('left');
  charSelMenu.style.removeProperty('width');
  charSelMenu.style.removeProperty('min-width');
  charSelMenu.removeAttribute('data-placement');
}

function positionCharMenu(){
  if(!charSelMenu || !charSelToggle) return;
  if(typeof window==='undefined') return;
  const toggleRect=charSelToggle.getBoundingClientRect();
  const docEl=document.documentElement;
  const viewportWidth=Math.max(window.innerWidth||0, docEl?docEl.clientWidth||0:0);
  const viewportHeight=Math.max(window.innerHeight||0, docEl?docEl.clientHeight||0:0);
  const baseMinWidth=280;
  let width=Math.max(toggleRect.width, baseMinWidth);
  if(viewportWidth){
    const available=Math.max(viewportWidth-(CHAR_MENU_VIEWPORT_PADDING*2),0);
    if(available>0){
      width=Math.min(width, Math.min(available, 360));
      if(width<=0){
        width=Math.min(Math.max(available,0), baseMinWidth);
      }
    }else{
      width=Math.min(width, Math.min(viewportWidth, 360));
    }
  }else{
    width=Math.min(width,360);
  }
  if(!Number.isFinite(width)||width<=0){
    width=baseMinWidth;
  }
  const minWidth=width<baseMinWidth?width:baseMinWidth;
  charSelMenu.style.width=`${Math.round(width)}px`;
  charSelMenu.style.minWidth=`${Math.round(minWidth)}px`;
  let left=toggleRect.left;
  if(viewportWidth){
    const maxLeft=viewportWidth-CHAR_MENU_VIEWPORT_PADDING-width;
    left=Math.min(left, maxLeft);
    left=Math.max(left, CHAR_MENU_VIEWPORT_PADDING);
  }
  if(!Number.isFinite(left)){
    left=0;
  }
  charSelMenu.style.left=`${Math.round(left)}px`;
  let top=toggleRect.bottom+CHAR_MENU_GAP;
  let placement='below';
  const menuHeight=charSelMenu.offsetHeight||0;
  if(viewportHeight&&menuHeight){
    const maxTop=viewportHeight-CHAR_MENU_VIEWPORT_PADDING-menuHeight;
    if(top>maxTop){
      const aboveTop=toggleRect.top-CHAR_MENU_GAP-menuHeight;
      if(aboveTop>=CHAR_MENU_VIEWPORT_PADDING){
        top=aboveTop;
        placement='above';
      }else{
        top=Math.max(maxTop, CHAR_MENU_VIEWPORT_PADDING);
      }
    }
  }
  if(!Number.isFinite(top)){
    top=0;
  }
  top=Math.max(top, CHAR_MENU_VIEWPORT_PADDING);
  charSelMenu.style.top=`${Math.round(top)}px`;
  if(placement==='above'){
    charSelMenu.setAttribute('data-placement','above');
  }else{
    charSelMenu.removeAttribute('data-placement');
  }
}

function scheduleCharMenuReposition(){
  if(!charSelMenu || !isMenuOpen(charSelMenu)) return;
  if(typeof requestAnimationFrame!=='function'){
    positionCharMenu();
    return;
  }
  if(charMenuRafId!=null && typeof cancelAnimationFrame==='function'){
    cancelAnimationFrame(charMenuRafId);
  }
  charMenuRafId=requestAnimationFrame(()=>{
    charMenuRafId=null;
    positionCharMenu();
  });
}

function startCharMenuAutoPosition(){
  if(removeCharMenuAutoPosition || !charSelMenu) return;
  if(typeof window==='undefined' || typeof document==='undefined') return;
  const handlers=[];
  const add=(target,type,listener,options)=>{
    if(target && typeof target.addEventListener==='function'){
      target.addEventListener(type,listener,options);
      handlers.push(()=>{
        try{ target.removeEventListener(type,listener,options); }
        catch(err){ target.removeEventListener(type,listener); }
      });
    }
  };
  const onChange=()=>scheduleCharMenuReposition();
  add(window,'resize',onChange);
  add(window,'scroll',onChange,{passive:true});
  add(document,'scroll',onChange,{passive:true});
  if(appMainEl){
    add(appMainEl,'scroll',onChange,{passive:true});
  }
  if(sheetHeaderEl){
    add(sheetHeaderEl,'scroll',onChange,{passive:true});
  }
  removeCharMenuAutoPosition=()=>{
    handlers.forEach(remove=>{
      try{ remove(); }
      catch(err){ /* no-op */ }
    });
    removeCharMenuAutoPosition=null;
  };
}

function stopCharMenuAutoPosition(){
  if(charMenuRafId!=null){
    if(typeof cancelAnimationFrame==='function'){
      cancelAnimationFrame(charMenuRafId);
    }
    charMenuRafId=null;
  }
  if(typeof removeCharMenuAutoPosition==='function'){
    removeCharMenuAutoPosition();
  }
}

function closeCharMenu({focusToggle=false}={}){
  if(charSelToggle){
    charSelToggle.setAttribute('aria-expanded','false');
  }
  const focusBack=()=>{
    if(focusToggle && charSelToggle){
      try{ charSelToggle.focus({preventScroll:true}); }
      catch(err){ charSelToggle.focus(); }
    }
  };
  stopCharMenuAutoPosition();
  if(!charSelMenu){
    focusBack();
    return;
  }
  const finalize=()=>{
    resetCharMenuPosition();
    focusBack();
  };
  animateMenuClose(charSelMenu,finalize);
}

function openCharMenu({focusLast=false}={}){
  if(!charSelToggle||!charSelMenu) return;
  rebuildCharacterMenu();
  const items=getCharMenuItems();
  if(!items.length){
    closeCharMenu();
    return;
  }
  closeAddMenu();
  animateMenuOpen(charSelMenu);
  charSelToggle.setAttribute('aria-expanded','true');
  positionCharMenu();
  startCharMenuAutoPosition();
  scheduleCharMenuReposition();
  const active=items.find(item=>item.classList.contains('active'));
  let target=active||null;
  if(focusLast){
    target=items[items.length-1];
  }else if(!target){
    target=items[0];
  }
  if(target){
    requestAnimationFrame(()=>focusCharMenuItem(target));
  }
}

function toggleCharMenu(){
  if(!charSelMenu) return;
  if(isMenuOpen(charSelMenu)){
    closeCharMenu();
  }else{
    openCharMenu();
  }
}

function selectCharacterFromMenu(value,{focusToggle=true}={}){
  if(!charSel) return;
  const previous=charSel.value;
  if(previous!==value){
    charSel.value=value;
    const event=new Event('change',{bubbles:true});
    charSel.dispatchEvent(event);
  }else{
    syncCharacterSelectorUI();
  }
  closeCharMenu({focusToggle});
}

/* --- character selector (no session counts) --- */
function rebuildCharacterOptions({preserveSelection=true, preferredKey=null}={}){
  if(!charSel) return null;
  const hasData=DATA && DATA.characters && typeof DATA.characters==='object';
  const previousSelection=preserveSelection?charSel.value:null;
  const scrollTop=charSel.scrollTop||0;
  charSel.innerHTML='';
  if(!hasData){
    return null;
  }
  let storedKey=getRememberedCharacterKey();
  if(storedKey && !isValidSheetKey(storedKey)){
    rememberCharacterKey('');
    storedKey='';
  }
  const entries=Object.entries(DATA.characters).map(([key,obj])=>{
    const sheetName=(obj.sheet||'').toString().trim();
    const displayName=(obj.display_name||'').toString().trim();
    const baseLabel=sheetName||displayName||key;
    const label=(displayName && displayName!==key)?(displayName+(sheetName&&sheetName!==displayName?' ('+sheetName+')':'')):baseLabel;
    const labelText=(label||'').toString().trim()||key;
    const sortValue=(displayName||sheetName||key||'').toString().trim();
    const level=currentLevelFor(key);
    const tier=tierInfoForLevel(level);
    return {
      key,
      label:labelText,
      sortValue,
      tierId:tier.id,
      tierLabel:tier.label,
      tierOrder:tier.order
    };
  }).sort((a,b)=>{
    if(a.tierOrder!==b.tierOrder){
      return a.tierOrder-b.tierOrder;
    }
    const cmp=a.sortValue.localeCompare(b.sortValue,undefined,{sensitivity:'base',numeric:true});
    if(cmp!==0) return cmp;
    return a.key.localeCompare(b.key,undefined,{sensitivity:'base',numeric:true});
  });
  if(hasDmLogData()){
    const dmOpt=document.createElement('option');
    dmOpt.value=DM_LOG_KEY;
    dmOpt.textContent='Dungeon Master Log';
    charSel.appendChild(dmOpt);
  }
  entries.forEach(({key,label,tierId,tierLabel,tierOrder})=>{
    const opt=document.createElement('option');
    opt.value=key;
    opt.textContent=label;
    if(tierId){
      opt.dataset.tierId=tierId;
      opt.dataset.tierLabel=tierLabel;
      opt.dataset.tierOrder=String(tierOrder);
    }
    charSel.appendChild(opt);
  });
  const candidateKeys=[preferredKey, previousSelection, storedKey];
  let nextKey=null;
  for(const candidate of candidateKeys){
    if(isValidSheetKey(candidate)){ nextKey=candidate; break; }
  }
  if(!nextKey){
    nextKey=getMostRecentCharacter();
  }
  if(!nextKey && hasDmLogData()){
    nextKey=DM_LOG_KEY;
  }
  if(nextKey){
    charSel.value=nextKey;
    rememberCharacterKey(nextKey);
  }else{
    rememberCharacterKey('');
  }
  if(typeof charSel.scrollTop==='number'){
    charSel.scrollTop=scrollTop;
  }
  rebuildCharacterSidebar();
  rebuildCharacterMenu();
  syncCharacterSelectorUI();
  return charSel.value||nextKey||null;
}

function getCharacterDisplayName(charKey){
  if(!charKey) return '';
  const key=String(charKey);
  if(DATA && DATA.characters && DATA.characters[key]){
    const obj=DATA.characters[key];
    const display=typeof obj.display_name==='string'?obj.display_name.trim():'';
    if(display) return display;
    const sheet=typeof obj.sheet==='string'?obj.sheet.trim():'';
    if(sheet) return sheet;
  }
  if(charSel && charSel.options){
    const option=Array.from(charSel.options).find(opt=>opt.value===key);
    if(option && typeof option.textContent==='string'){ return option.textContent.trim(); }
  }
  return key.trim();
}

/* --- utils --- */
function fmtDate(iso){ if(!iso)return''; const d=new Date(iso); if(isNaN(d))return String(iso); return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }
function fmtNumber(n,{signed=false}={}){
  if(n==null) return '0';
  const num=Number(n);
  if(!Number.isFinite(num)) return String(n);
  let rounded=Math.round(num*100)/100;
  if(Object.is(rounded,-0)) rounded=0;
  const formatted=rounded.toLocaleString(undefined,{maximumFractionDigits:2});
  if(signed){
    if(rounded===0) return '0';
    if(rounded>0) return '+'+formatted;
  }
  return formatted;
}
function normalizeDisplayValue(val){
  if(val==null) return '';
  if(typeof val==='number'){
    if(!Number.isFinite(val)) return '';
    return String(val);
  }
  const text=String(val).trim();
  if(!text) return '';
  const simple=text.replace(/[\s._\-\/?]/g,'').toLowerCase();
  if(!simple) return '';
  if(simple==='na'||simple==='none'||simple==='null'||simple==='tbd') return '';
  return text;
}
function hasMeaningfulValue(val){
  return normalizeDisplayValue(val)!=='';
}
function pill(label){ const s=document.createElement('span'); s.className='pill'; s.textContent=label; return s; }
function createChipsContainer(){
  const el=document.createElement('div');
  el.className='chips';
  chipTickerRegistry.register(el);
  return el;
}
function formatRace(value){
  if(!value) return '';
  if(Array.isArray(value)){
    return value.map(formatRace).filter(Boolean).join(' / ');
  }
  if(typeof value==='object'){
    const parts=[];
    if(value.lineage) parts.push(String(value.lineage));
    if(value.race) parts.push(String(value.race));
    if(value.ancestry) parts.push(String(value.ancestry));
    if(value.subrace) parts.push(String(value.subrace));
    if(value.variant) parts.push(String(value.variant));
    if(value.name && !parts.length) parts.push(String(value.name));
    return parts.filter(Boolean).join(' ');
  }
  return String(value);
}
function formatClassEntry(entry){
  if(!entry) return '';
  if(typeof entry==='string') return entry;
  if(typeof entry==='number') return String(entry);
  if(Array.isArray(entry)){
    return entry.map(formatClassEntry).filter(Boolean).join(' / ');
  }
  const parts=[];
  if(entry.name) parts.push(String(entry.name));
  if(entry.subclass) parts.push(String(entry.subclass));
  if(entry.level!=null && entry.level!=='') parts.push(String(entry.level));
  if(entry.title && !parts.length) parts.push(String(entry.title));
  return parts.filter(Boolean).join(' ');
}
function formatClasses(value){
  if(!value) return '';
  if(Array.isArray(value)){
    return value.map(formatClassEntry).filter(Boolean).join(' / ');
  }
  if(typeof value==='object'){
    return formatClassEntry(value);
  }
  return String(value);
}
function collectAvatarNames(obj,key){
  const names=[];
  if(obj){
    if(typeof obj.sheet==='string' && obj.sheet.trim()) names.push(obj.sheet);
    if(typeof obj.display_name==='string' && obj.display_name.trim()) names.push(obj.display_name);
    if(obj.identity && typeof obj.identity.name==='string' && obj.identity.name.trim()) names.push(obj.identity.name);
  }
  if(typeof key==='string' && key.trim()) names.push(key);
  return names
    .map(name=>String(name).trim())
    .filter((value,index,self)=>value && self.indexOf(value)===index);
}
function makeAvatarFileCandidates(name){
  if(!name) return [];
  const trimmed=String(name).trim();
  if(!trimmed) return [];
  const variants=new Set();
  variants.add(trimmed);
  variants.add(trimmed.toLowerCase());
  const dashed=trimmed.replace(/[^a-zA-Z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  if(dashed) variants.add(dashed);
  if(dashed) variants.add(dashed.toLowerCase());
  const collapsed=trimmed.replace(/[^a-zA-Z0-9]+/g,'');
  if(collapsed) variants.add(collapsed);
  if(collapsed) variants.add(collapsed.toLowerCase());
  return Array.from(variants).map(v=>`${v}.png`);
}


function resetAvatarPreviewSizing(){
  if(!avatarPreviewImage) return;
  avatarPreviewImage.style.width='';
  avatarPreviewImage.style.height='';
}

function parsePositiveNumber(value){
  const num=Number.parseFloat(value);
  return Number.isFinite(num) && num>0 ? num : 0;
}

function getAvatarNaturalSize(path){
  if(!path) return null;
  if(avatarSizeCache.has(path)) return avatarSizeCache.get(path);
  if(avatarEl && avatarEl.getAttribute('data-avatar-src')===path){
    const width=parsePositiveNumber(avatarEl.dataset.avatarNaturalWidth);
    const height=parsePositiveNumber(avatarEl.dataset.avatarNaturalHeight);
    if(width && height){
      const size={width,height};
      avatarSizeCache.set(path,size);
      return size;
    }
  }
  return null;
}

function getAvatarOverlayPadding(){
  if(!avatarOverlay || typeof window==='undefined'){
    return { horizontal: 0, vertical: 0 };
  }
  const style=window.getComputedStyle(avatarOverlay);
  const parse=value=>Number.parseFloat(value)||0;
  return {
    horizontal: parse(style.paddingLeft)+parse(style.paddingRight),
    vertical: parse(style.paddingTop)+parse(style.paddingBottom)
  };
}

function computeAvatarPreviewTargetSize(naturalWidth,naturalHeight){
  const width=parsePositiveNumber(naturalWidth);
  const height=parsePositiveNumber(naturalHeight);
  if(!width || !height) return null;
  const viewportWidth=typeof window!=='undefined'?window.innerWidth:0;
  const viewportHeight=typeof window!=='undefined'?window.innerHeight:0;
  if(!viewportWidth || !viewportHeight) return null;
  const padding=getAvatarOverlayPadding();
  const maxWidth=Math.max(viewportWidth-padding.horizontal,0);
  const maxHeight=Math.max(viewportHeight-padding.vertical,0);
  if(!maxWidth || !maxHeight) return null;
  const scale=Math.min(maxWidth/width,maxHeight/height,1);
  const targetWidth=Math.max(Math.round(width*scale),0);
  const targetHeight=Math.max(Math.round(height*scale),0);
  if(!targetWidth || !targetHeight) return null;
  return {width:targetWidth,height:targetHeight};
}

function prepareAvatarPreviewSizeForSrc(src){
  if(!avatarPreviewImage || !src){
    resetAvatarPreviewSizing();
    return;
  }
  const naturalSize=getAvatarNaturalSize(src);
  if(!naturalSize){
    resetAvatarPreviewSizing();
    return;
  }
  const target=computeAvatarPreviewTargetSize(naturalSize.width,naturalSize.height);
  if(!target){
    resetAvatarPreviewSizing();
    return;
  }
  avatarPreviewImage.style.width=`${target.width}px`;
  avatarPreviewImage.style.height=`${target.height}px`;
}

function rememberAvatarNaturalSize(path,width,height,{updateElement=true,updatePreview=true}={}){
  if(!path) return;
  const targetWidth=parsePositiveNumber(width);
  const targetHeight=parsePositiveNumber(height);
  if(!targetWidth || !targetHeight) return;
  avatarSizeCache.set(path,{width:targetWidth,height:targetHeight});
  if(updateElement && avatarEl && avatarEl.getAttribute('data-avatar-src')===path){
    avatarEl.dataset.avatarNaturalWidth=String(targetWidth);
    avatarEl.dataset.avatarNaturalHeight=String(targetHeight);
  }
  if(updatePreview && avatarOverlay && avatarOverlay.classList.contains('open') && avatarPreview && avatarPreview.getAttribute('data-avatar-src')===path){
    prepareAvatarPreviewSizeForSrc(path);
    scheduleAvatarPreviewResize();
  }
}

function onAvatarElementLoad(){
  if(!avatarEl) return;
  const src=avatarEl.getAttribute('data-avatar-src');
  if(!src) return;
  rememberAvatarNaturalSize(src,avatarEl.naturalWidth,avatarEl.naturalHeight);
}

function resizeAvatarPreviewToViewport(){
  if(!avatarOverlay || !avatarPreviewImage) return;
  if(!avatarOverlay.classList.contains('open')){
    resetAvatarPreviewSizing();
    return;
  }
  const target=computeAvatarPreviewTargetSize(avatarPreviewImage.naturalWidth,avatarPreviewImage.naturalHeight);
  if(!target){
    resetAvatarPreviewSizing();
    return;
  }
  avatarPreviewImage.style.width=`${target.width}px`;
  avatarPreviewImage.style.height=`${target.height}px`;
}

function scheduleAvatarPreviewResize(){
  if(!avatarPreviewImage) return;
  const run=()=>resizeAvatarPreviewToViewport();
  if(typeof avatarPreviewImage.decode==='function'){
    avatarPreviewImage.decode().then(run).catch(run);
    return;
  }
  if(avatarPreviewImage.complete){
    run();
    return;
  }
  const once=()=>{
    avatarPreviewImage.removeEventListener('load',once);
    run();
  };
  avatarPreviewImage.addEventListener('load',once);
}

function onAvatarOverlayResize(){
  if(!avatarOverlay || !avatarOverlay.classList.contains('open')) return;
  resizeAvatarPreviewToViewport();
}

if(typeof window!=='undefined' && typeof window.addEventListener==='function'){
  try{
    window.addEventListener('resize',onAvatarOverlayResize,{ passive: true });
  }catch(err){
    window.addEventListener('resize',onAvatarOverlayResize);
  }
}

function closeAvatarOverlay({returnFocus=true}={}){
  if(!avatarOverlay) return;
  if(!avatarOverlay.classList.contains('open')) return;
  avatarOverlay.classList.remove('open');
  avatarOverlay.setAttribute('aria-hidden','true');
  avatarOverlay.removeAttribute('aria-label');
  document.body.classList.remove('avatar-overlay-open');
  if(avatarEl){
    avatarEl.setAttribute('aria-expanded','false');
  }
  if(avatarPreview){
    avatarPreview.removeAttribute('data-avatar-src');
  }
  if(avatarPreviewImage){
    avatarPreviewImage.removeAttribute('src');
    avatarPreviewImage.setAttribute('alt','Character avatar');
    resetAvatarPreviewSizing();
  }
  document.removeEventListener('keydown', onAvatarOverlayKeydown);
  if(returnFocus && avatarEl){
    avatarEl.focus({preventScroll:true});
  }
}

function onAvatarOverlayKeydown(evt){
  if(evt.key==='Escape'){
    evt.preventDefault();
    closeAvatarOverlay();
  }
}

function openAvatarOverlay(){
  if(!avatarEl || !avatarOverlay || !avatarPreview) return;
  if(!avatarEl.classList.contains('has-avatar')) return;
  const src=avatarEl.getAttribute('data-avatar-src');
  if(!src) return;
  avatarPreview.setAttribute('data-avatar-src',src);
  const selectedOption=charSel && charSel.options && charSel.selectedIndex>=0 ? charSel.options[charSel.selectedIndex] : null;
  const optionLabel=selectedOption?selectedOption.textContent.trim():'';
  const label=optionLabel?`${optionLabel} avatar`:'Character avatar';
  if(avatarPreviewImage){
    prepareAvatarPreviewSizeForSrc(src);
    avatarPreviewImage.src=src;
    avatarPreviewImage.setAttribute('alt',label);
  }
  avatarOverlay.setAttribute('aria-label',label);
  avatarOverlay.classList.add('open');
  avatarOverlay.setAttribute('aria-hidden','false');
  document.body.classList.add('avatar-overlay-open');
  scheduleAvatarPreviewResize();
  avatarOverlay.focus({preventScroll:true});
  if(avatarEl){
    avatarEl.setAttribute('aria-expanded','true');
  }
  document.addEventListener('keydown', onAvatarOverlayKeydown);
}

if(avatarOverlay){
  avatarOverlay.addEventListener('click',()=>closeAvatarOverlay());
}

function resetAvatar(){
  if(!avatarEl) return;
  avatarEl.removeAttribute('src');
  avatarEl.classList.remove('has-avatar');
  avatarEl.classList.remove('avatar-fallback');
  avatarEl.removeAttribute('data-avatar-src');
  delete avatarEl.dataset.avatarNaturalWidth;
  delete avatarEl.dataset.avatarNaturalHeight;
  avatarEl.alt='Character avatar';
  avatarEl.removeAttribute('role');
  avatarEl.removeAttribute('aria-haspopup');
  avatarEl.removeAttribute('aria-expanded');
  avatarEl.tabIndex=-1;
  closeAvatarOverlay({returnFocus:false});
}
function applyAvatar(path,token,key,{persist=true,isFallback=false}={}){
  if(!avatarEl || token!==avatarLoadToken) return;
  avatarEl.src=path;
  avatarEl.classList.add('has-avatar');
  if(isFallback){
    avatarEl.classList.add('avatar-fallback');
  }else{
    avatarEl.classList.remove('avatar-fallback');
  }
  avatarEl.setAttribute('data-avatar-src',path);
  const cachedSize=avatarSizeCache.get(path);
  if(cachedSize && cachedSize.width && cachedSize.height){
    avatarEl.dataset.avatarNaturalWidth=String(cachedSize.width);
    avatarEl.dataset.avatarNaturalHeight=String(cachedSize.height);
  }else{
    delete avatarEl.dataset.avatarNaturalWidth;
    delete avatarEl.dataset.avatarNaturalHeight;
  }
  const selectedOption=charSel && charSel.options && charSel.selectedIndex>=0 ? charSel.options[charSel.selectedIndex] : null;
  const optionLabel=selectedOption?selectedOption.textContent.trim():'';
  const defaultLabel=optionLabel?`${optionLabel} avatar`:'Character avatar';
  const fallbackLabel=optionLabel?`${optionLabel} default avatar`:'Default character avatar';
  avatarEl.alt=isFallback?fallbackLabel:defaultLabel;
  avatarEl.setAttribute('role','button');
  avatarEl.setAttribute('aria-haspopup','dialog');
  avatarEl.setAttribute('aria-expanded','false');
  avatarEl.tabIndex=0;
  if(avatarEl.complete){
    rememberAvatarNaturalSize(path,avatarEl.naturalWidth,avatarEl.naturalHeight);
  }
  if(persist) rememberAvatarPath(key,path);
}
function buildAvatarCandidates(key,obj){
  const names=collectAvatarNames(obj,key);
  const candidates=[];
  const persistedPath=getPersistedAvatarPath(key);
  if(persistedPath) candidates.push(persistedPath);
  const manifestPath=AVATAR_MANIFEST[String(key)]||'';
  if(manifestPath && !candidates.includes(manifestPath)) candidates.push(manifestPath);
  names.forEach(name=>{
    makeAvatarFileCandidates(name).forEach(file=>{
      if(file && !candidates.includes(file)) candidates.push(file);
    });
  });
  return candidates;
}
function preloadAvatar(path){
  if(!path) return null;
  if(avatarCache.has(path)) return null;
  if(avatarPreloadPromises.has(path)) return avatarPreloadPromises.get(path);
  const promise=new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      avatarCache.set(path,true);
      rememberAvatarNaturalSize(path,img.naturalWidth,img.naturalHeight,{updateElement:false,updatePreview:false});
      resolve(true);
    };
    img.onerror=()=>{
      avatarCache.set(path,false);
      resolve(false);
    };
    img.src=path;
  });
  avatarPreloadPromises.set(path,promise);
  return promise;
}
function collectAllAvatarPaths(){
  if(!DATA || !DATA.characters) return [];
  const paths=new Set();
  Object.entries(DATA.characters).forEach(([key,obj])=>{
    buildAvatarCandidates(key,obj).forEach(path=>{ if(path) paths.add(path); });
  });
  if(AVATAR_FALLBACK_PATH) paths.add(AVATAR_FALLBACK_PATH);
  return Array.from(paths);
}
let avatarPreloadScheduled=false;
function scheduleAvatarPreload(){
  if(avatarPreloadScheduled) return;
  avatarPreloadScheduled=true;
  const startPreload=()=>{
    avatarPreloadScheduled=false;
    collectAllAvatarPaths().forEach(path=>preloadAvatar(path));
  };
  if(typeof window!=='undefined' && typeof window.requestIdleCallback==='function'){
    window.requestIdleCallback(startPreload,{timeout:1200});
  }else{
    setTimeout(startPreload,150);
  }
}
function updateAvatar(key,obj){
  if(!avatarEl){
    return;
  }
  const candidates=buildAvatarCandidates(key,obj);
  if(!candidates.length){
    const token=++avatarLoadToken;
    resetAvatar();
    forgetAvatarPath(key);
    if(AVATAR_FALLBACK_PATH){
      avatarCache.set(AVATAR_FALLBACK_PATH,true);
      applyAvatar(AVATAR_FALLBACK_PATH,token,key,{persist:false,isFallback:true});
    }
    return;
  }
  const token=++avatarLoadToken;
  resetAvatar();
  const tryNext=(index)=>{
    if(token!==avatarLoadToken) return;
    if(index>=candidates.length){
      forgetAvatarPath(key);
      if(AVATAR_FALLBACK_PATH){
        avatarCache.set(AVATAR_FALLBACK_PATH,true);
        applyAvatar(AVATAR_FALLBACK_PATH,token,key,{persist:false,isFallback:true});
      }else{
        resetAvatar();
      }
      return;
    }
    const path=candidates[index];
    if(avatarCache.has(path)){
      if(avatarCache.get(path)){
        applyAvatar(path,token,key);
      }else{
        tryNext(index+1);
      }
      return;
    }
    const img=new Image();
    img.onload=()=>{
      if(token!==avatarLoadToken) return;
      avatarCache.set(path,true);
      rememberAvatarNaturalSize(path,img.naturalWidth,img.naturalHeight,{updateElement:false,updatePreview:false});
      applyAvatar(path,token,key);
    };
    img.onerror=()=>{
      if(token!==avatarLoadToken) return;
      avatarCache.set(path,false);
      tryNext(index+1);
    };
    img.src=path;
  };
  tryNext(0);
}
function extractCharacterIdentity(obj){
  const identity={race:'',classes:''};
  if(!obj) return identity;
  const sheet=obj.sheet;
  if(sheet && typeof sheet==='object'){
    identity.race = identity.race || formatRace(sheet.race || sheet.ancestry || sheet.lineage);
    identity.classes = identity.classes || formatClasses(sheet.classes || sheet.class || sheet.archetype);
  }
  if((!identity.race || !identity.classes) && Array.isArray(obj.adventures)){
    const source=obj.adventures.find(entry=>entry && typeof entry.character==='object');
    if(source && source.character){
      const ch=source.character;
      identity.race = identity.race || formatRace(ch.race || ch.ancestry || ch.lineage);
      identity.classes = identity.classes || formatClasses(ch.classes || ch.class || ch.archetype);
    }
  }
  if(typeof obj.identity==='object'){
    identity.race = identity.race || formatRace(obj.identity.race || obj.identity.ancestry);
    identity.classes = identity.classes || formatClasses(obj.identity.classes || obj.identity.class);
  }
  return {
    race:identity.race && identity.race.trim()?identity.race.trim():'',
    classes:identity.classes && identity.classes.trim()?identity.classes.trim():''
  };
}
function identityBadge(label,value){
  const chip=document.createElement('span');
  chip.className='identity-badge';
  const labelEl=document.createElement('span');
  labelEl.className='label';
  labelEl.textContent=label;
  const valueEl=document.createElement('span');
  valueEl.className='value';
  valueEl.textContent=value;
  chip.append(labelEl,valueEl);
  return chip;
}
function sanitizeTitle(title){
  if(!title) return '';
  return String(title).replace(/\bdown\s*time\s*activity\b/gi,'').replace(/\s{2,}/g,' ').replace(/^[\s:,.-]+|[\s:,.-]+$/g,'').trim();
}
function listBox(items){
  const wrap=document.createElement('div'); wrap.className='scrollbox';
  const normalized=Array.isArray(items)?items.map(normalizeDisplayValue).filter(Boolean):[];
  if(!normalized.length){ wrap.innerHTML='<div class="muted"></div>'; return wrap; }
  normalized.forEach(name=>{ const row=document.createElement('div'); row.className='item'; row.textContent=name; wrap.appendChild(row); });
  return wrap;
}

function splitAllocationSegments(text){
  if(text==null) return [];
  const value=String(text).trim();
  if(!value) return [];
  const segments=[];
  let current='';
  let depth=0;
  for(let i=0;i<value.length;i++){
    const ch=value[i];
    if(ch==='('){ depth++; }
    else if(ch===')' && depth>0){ depth--; }
    if((ch===','||ch===';'||ch==='') && depth===0){
      const trimmed=current.trim();
      if(trimmed){ segments.push(trimmed); }
      current='';
      continue;
    }
    current+=ch;
  }
  const trimmed=current.trim();
  if(trimmed){ segments.push(trimmed); }
  return segments;
}

function createAllocationDetailsList(text){
  const wrap=document.createElement('div');
  wrap.className='scrollbox';
  const segments=splitAllocationSegments(text);
  if(!segments.length){
    const empty=document.createElement('div');
    empty.className='muted';
    empty.textContent='';
    wrap.appendChild(empty);
    return wrap;
  }
  segments.forEach(segment=>{
    const row=document.createElement('div');
    row.className='item';
    setElementTextWithCharacterChips(row, segment, {label:'Rewards allocated', force:true});
    wrap.appendChild(row);
  });
  return wrap;
}

function buildDmTotalsChip(baseHours, bonusHours, costHours, levelsEarned, levelsSpent){
  const hasHoursData=Number.isFinite(baseHours)||Number.isFinite(bonusHours)||Number.isFinite(costHours);
  const hasLevelsEarned=Number.isFinite(levelsEarned)&&levelsEarned!==0;
  const hasLevelsSpent=Number.isFinite(levelsSpent)&&levelsSpent!==0;
  const showLevels=hasLevelsEarned||hasLevelsSpent;
  if(!hasHoursData && !showLevels) return null;

  const baseTotal=Number.isFinite(baseHours)?baseHours:0;
  const bonusTotal=Number.isFinite(bonusHours)?bonusHours:0;
  const seasonalCost=Number.isFinite(costHours)
    ? (costHours>0?-Math.abs(costHours):costHours)
    : 0;
  const netHours=baseTotal+bonusTotal+seasonalCost;

  const earnedTotal=hasLevelsEarned?levelsEarned:0;
  const spentTotal=hasLevelsSpent?levelsSpent:0;
  const netLevels=earnedTotal-spentTotal;

  const formatSignedValue=(value)=>{
    const num=Number(value||0);
    if(!Number.isFinite(num) || num===0) return '0';
    const abs=fmtNumber(Math.abs(num));
    return num>0?`+${abs}`:`-${abs}`;
  };

  const makeValueEl=(label,value)=>{
    const el=document.createElement('span');
    el.className='totals-pill-value neutral';
    el.textContent=`${label} ${formatSignedValue(value)}`;
    el.setAttribute('data-value', String(Number(value)||0));
    el.classList.remove('gain','loss','neutral');
    if(value>0){
      el.classList.add('gain');
    }else if(value<0){
      el.classList.add('loss');
    }else{
      el.classList.add('neutral');
    }
    return el;
  };

  const labelParts=[];
  const ariaParts=[];
  const pill=document.createElement('span');
  pill.className='totals-pill dm-topline-totals';
  pill.setAttribute('role','group');
  const valuesWrap=document.createElement('span');
  valuesWrap.className='totals-pill-values';

  if(hasHoursData){
    const hoursEl=makeValueEl('Hours',netHours);
    valuesWrap.appendChild(hoursEl);
    const displayLabel=hoursEl.textContent||'';
    labelParts.push(displayLabel);
    const breakdown=[];
    if(Number.isFinite(baseHours)){
      breakdown.push(`base ${fmtNumber(baseTotal,{signed:true})}`);
    }
    if(Number.isFinite(bonusHours) && bonusTotal!==0){
      breakdown.push(`bonus ${fmtNumber(bonusTotal,{signed:true})}`);
    }
    if(Number.isFinite(costHours) && seasonalCost!==0){
      breakdown.push(`seasonal cost ${fmtNumber(seasonalCost,{signed:true})}`);
    }
    if(breakdown.length){
      ariaParts.push(`${displayLabel} (${breakdown.join(', ')})`);
    }else{
      ariaParts.push(displayLabel);
    }
  }

  if(showLevels){
    const levelsEl=makeValueEl('Levels',netLevels);
    valuesWrap.appendChild(levelsEl);
    const displayLabel=levelsEl.textContent||'';
    labelParts.push(displayLabel);
    const breakdown=[];
    if(hasLevelsEarned){
      breakdown.push(`earned ${fmtNumber(earnedTotal,{signed:true})}`);
    }
    if(hasLevelsSpent){
      const spentDisplay=-Math.abs(spentTotal);
      breakdown.push(`spent ${fmtNumber(spentDisplay,{signed:true})}`);
    }
    if(breakdown.length){
      ariaParts.push(`${displayLabel} (${breakdown.join(', ')})`);
    }else{
      ariaParts.push(displayLabel);
    }
  }

  if(!valuesWrap.childElementCount) return null;

  pill.appendChild(valuesWrap);
  const ariaLabel=`Net Dungeon Master rewards  ${ariaParts.join(', ')}`;
  pill.setAttribute('aria-label', ariaLabel);
  pill.title=labelParts.join('  ');
  return pill;
}

/* --- DM log helpers --- */
function dmNormalizeSeasonLabel(label){
  const text=(label==null?'':String(label)).trim();
  return text||'Unlabeled season';
}
function normalizeSeasonGroup(label){
  const text=(label==null?'':String(label)).trim().toLowerCase();
  if(!text) return '';
  if(text.startsWith('seasonal')) return 'seasonal';
  const seasonMatch=text.match(/^season\s*(\d+)([a-z])?/);
  if(seasonMatch){
    return `season-${seasonMatch[1]}`;
  }
  const anniversaryMatch=text.match(/(\d{1,3})(st|nd|rd|th)\s+anniversary\s+season/);
  if(anniversaryMatch){
    return `${anniversaryMatch[1]}th-anniversary-season`;
  }
  return text;
}
function extractSeasonLabel(text){
  if(!text) return '';
  const value=String(text);
  const anniversary=value.match(/(\d{1,3})(st|nd|rd|th)\s+Anniversary\s+Season\s+([A-Za-z])/i);
  if(anniversary){
    const ordinal=`${anniversary[1]}${anniversary[2]}`;
    const seasonLetter=anniversary[3].toUpperCase();
    return `${ordinal} Anniversary Season ${seasonLetter}`;
  }
  const seasonal=value.match(/Seasonal\s*\(([^)]+)\)/i);
  if(seasonal){
    return `Seasonal (${seasonal[1].trim()})`;
  }
  const detailed=value.match(/Season\s*(\d+)\s*([A-Za-z])?/i);
  if(detailed){
    const seasonNumber=detailed[1];
    const letter=(detailed[2]||'').trim();
    if(letter){
      return `Season ${seasonNumber}${letter.toLowerCase()}`;
    }
    return `Season ${seasonNumber}`;
  }
  return '';
}
function inferSeasonFromReward(adv){
  if(!adv || typeof adv!=='object') return '';
  const direct=extractSeasonLabel(adv.season);
  if(direct) return dmNormalizeSeasonLabel(direct);
  const fromTitle=extractSeasonLabel(adv.title);
  if(fromTitle) return dmNormalizeSeasonLabel(fromTitle);
  const fromNotes=extractSeasonLabel(adv.notes);
  if(fromNotes) return dmNormalizeSeasonLabel(fromNotes);
  return '';
}
function dmToNullableNumber(value){
  const num=Number(value);
  return Number.isFinite(num)?num:null;
}
function dmToNumber(value){
  const num=Number(value);
  return Number.isFinite(num)?num:0;
}
function dmTimestamp(value){
  if(!value) return Number.NEGATIVE_INFINITY;
  const t=new Date(value).getTime();
  return Number.isFinite(t)?t:Number.NEGATIVE_INFINITY;
}
function dmDateCountsTowardHoursPool(date){
  const ts=dmTimestamp(date);
  return ts>=DM_HOURS_POOL_START_TS;
}
function parseSeasonNumber(label){
  if(!label) return null;
  const match=String(label).match(/season\s*(\d+)/i);
  if(!match) return null;
  const num=Number(match[1]);
  return Number.isFinite(num)?num:null;
}
function escapeRegExp(str){
  const re=/[.*+?^${}()|[\]\\]/g;
  return String(str).replace(re,'\\$&');
}
function allocationSeasonEligibleForLevelAccrual(seasonLabel){
  if(!seasonLabel) return true;
  const normalized=String(seasonLabel).toLowerCase();
  if(normalized.includes('pre-season 11') || normalized.includes('pre season 11')){
    return false;
  }
  const seasonNumber=parseSeasonNumber(seasonLabel);
  if(seasonNumber==null) return true;
  return seasonNumber>=11;
}
function isLevelOnlyAllocation(allocationText, parsed){
  const detail=parsed || interpretAllocationDetails(allocationText);
  if(!detail || detail.levelsSpent==null || !Number.isFinite(detail.levelsSpent) || detail.levelsSpent<=0){
    return false;
  }
  if(detail.itemTokens && detail.itemTokens.length){
    return false;
  }
  if(detail.downtimeSpent!=null && detail.downtimeSpent>0){
    return false;
  }
  if(detail.goldSpent!=null && detail.goldSpent>0){
    return false;
  }
  let working=String(allocationText||'').toLowerCase();
  if(!working.trim()) return false;
  if(Array.isArray(detail.recipients)){
    detail.recipients.forEach(name=>{
      if(!name) return;
      const lowered=String(name).toLowerCase().trim();
      if(!lowered) return;
      const pattern=new RegExp(escapeRegExp(lowered),'g');
      working=working.replace(pattern,' ');
    });
  }
  working=working.replace(/\b\d+\s*(?:levels?|lvl)\b/g,' ');
  working=working.replace(/\blevels?\b/g,' ');
  working=working.replace(/\bplayer\b/g,' ');
  working=working.replace(/\brewards?\b/g,' ');
  working=working.replace(/\band\b/g,' ');
  working=working.replace(/\bbonus\b/g,' ');
  working=working.replace(/\bto\b/g,' ');
  working=working.replace(/[+,&:()]/g,' ');
  working=working.replace(/\s+/g,' ').trim();
  return !working;
}
function allocationHasNonLevelReward(allocationText, parsed){
  const detail=parsed || interpretAllocationDetails(allocationText);
  if(!detail) return false;
  if(detail.downtimeSpent!=null && detail.downtimeSpent>0){
    return true;
  }
  if(detail.goldSpent!=null && detail.goldSpent>0){
    return true;
  }
  if(detail.itemTokens && detail.itemTokens.some(token=>token && !/(?:loss|period|expire|expiration|forfeit|penalty)/i.test(token))){
    return true;
  }
  const raw=String(allocationText||'').toLowerCase();
  if(!raw.trim()) return false;
  if(/\b(loss|forfeit|expire|expiration|penalty)\b/.test(raw)){
    return false;
  }
  if(/\b(?:reward|item|potion|tattoo|wand|staff|amulet|boots|armor|shield|ring|stone|cloak|rod|scroll|saddle|quiver|caress|fiddle|maul|sword|bow|splint|mace|gem|guide|arrows|favor|rescue|saddle|boots|gloves|cowl|blade|tome|pen|shawl|sling|cloak)\b/.test(raw)){
    return true;
  }
  if(raw.includes('+')){
    return true;
  }
  return false;
}
function allocationGrantsLevelToPool(seasonLabel, allocationText, parsed){
  if(!allocationSeasonEligibleForLevelAccrual(seasonLabel)){
    return false;
  }
  if(isLevelOnlyAllocation(allocationText, parsed)){
    return false;
  }
  return allocationHasNonLevelReward(allocationText, parsed);
}
function buildDmEntries(){
  DM_ENTRIES=[];
  DM_SUMMARY={ runs:0, allocations:0, earnedHours:0, earnedBonus:0, allocatedHours:0, allocatedBonus:0, allocatedCost:0, earnedLevels:0, spentLevels:0, entries:0 };
  DM_PRE_ITEMS=[];
  const customAllocations=(DATA && Array.isArray(DATA.dm_allocations))?DATA.dm_allocations:[];
  let sortIndex=0;
  const normalizeSeason=(raw)=>dmNormalizeSeasonLabel(raw);
  const cloneSimple=(value)=>{
    if(value==null) return null;
    if(typeof structuredClone==='function'){
      try{ return structuredClone(value); }
      catch(err){ /* fallback to JSON clone */ }
    }
    try{ return JSON.parse(JSON.stringify(value)); }
    catch(err){ return null; }
  };
  const pushEntry=(entry)=>{
    entry.__origIndex=sortIndex++;
    if(entry && typeof entry==='object'){
      entry.seasonGroup=normalizeSeasonGroup(entry.season||'');
    }
    DM_ENTRIES.push(entry);
  };
  const addRun=(seasonLabel, run)=>{
    const season=normalizeSeason(seasonLabel);
    const hoursVal=dmToNullableNumber(run.hours);
    const bonusVal=dmToNullableNumber(run.extra_hours);
    const levelsPlus=dmToNullableNumber(run.levels_plus);
    const levelsMinus=dmToNullableNumber(run.levels_minus);
    const countsTowardHoursPool=dmDateCountsTowardHoursPool(run.date);
    const countsTowardLevelPool=allocationSeasonEligibleForLevelAccrual(season);
    pushEntry({
      type:'run',
      season,
      date:run.date||'',
      code:run.code||'',
      name:run.name||'',
      tier:run.tier,
      hours:hoursVal,
      extra_hours:bonusVal,
      roles:Array.isArray(run.roles)?run.roles.slice():[],
      location:run.location||'',
      levels_plus:levelsPlus,
      levels_minus:levelsMinus,
      item:run.item||'',
      allocation:run.allocation||''
    });
    DM_SUMMARY.runs+=1;
    if(countsTowardHoursPool){
      if(hoursVal!=null) DM_SUMMARY.earnedHours+=hoursVal;
      if(bonusVal!=null) DM_SUMMARY.earnedBonus+=bonusVal;
    }
    if(countsTowardLevelPool){
      if(levelsPlus!=null) DM_SUMMARY.earnedLevels+=levelsPlus;
      if(levelsMinus!=null) DM_SUMMARY.spentLevels+=levelsMinus;
    }
  };
  const addPreEntry=(entry)=>{
    const season=normalizeSeason('Pre-Season 11');
    const parsed=interpretAllocationDetails(entry.allocation);
    let levelsSpent=null;
    const parsedLevelsSpent=(parsed && parsed.levelsSpent!=null)?parsed.levelsSpent:null;
    if(Number.isFinite(parsedLevelsSpent) && parsedLevelsSpent>0){
      levelsSpent=parsedLevelsSpent;
    }else{
      const fallbackMinus=dmToNullableNumber(entry.levels_minus);
      const fallbackPlus=dmToNullableNumber(entry.levels_plus);
      const fallbackLevel=(Number.isFinite(fallbackMinus) && fallbackMinus>0)
        ? fallbackMinus
        : ((Number.isFinite(fallbackPlus) && fallbackPlus>0)?fallbackPlus:null);
      if(Number.isFinite(fallbackLevel) && fallbackLevel>0){
        levelsSpent=fallbackLevel;
      }
    }
    const entryLevelsPlus=null;
    const entryLevelsMinus=(Number.isFinite(levelsSpent) && levelsSpent>0)?levelsSpent:null;
    pushEntry({
      type:'run',
      season,
      date:entry.date||'',
      code:entry.code||'',
      name:entry.name||'',
      tier:entry.tier,
      hours:null,
      extra_hours:null,
      roles:[],
      location:entry.location||'',
      levels_plus:entryLevelsPlus,
      levels_minus:entryLevelsMinus,
      item:entry.item||'',
      allocation:entry.allocation||''
    });
    const countsTowardLevelPool=allocationSeasonEligibleForLevelAccrual(season);
    if(countsTowardLevelPool){
      if(entryLevelsPlus!=null) DM_SUMMARY.earnedLevels+=entryLevelsPlus;
      if(entryLevelsMinus!=null) DM_SUMMARY.spentLevels+=entryLevelsMinus;
    }
    const hasAllocation=Boolean((entry.allocation||'').trim());
    const itemName=String(entry.item||'').trim();
    if(itemName && !hasAllocation){
      DM_PRE_ITEMS.push({
        item:itemName,
        date:entry.date||'',
        code:entry.code||'',
        location:entry.location||''
      });
    }
    DM_SUMMARY.runs+=1;
  };
  const addAllocation=(seasonLabel, alloc={})=>{
    const season=normalizeSeason(seasonLabel);
    const hoursVal=dmToNullableNumber(alloc.hours);
    const bonusVal=dmToNullableNumber(alloc.extra_hours);
    const baseCost=dmToNullableNumber(alloc.cost);
    const allocationText=alloc.allocation;
    const parsed=interpretAllocationDetails(allocationText);
    const parsedLevelsSpent=(parsed && parsed.levelsSpent!=null)?parsed.levelsSpent:null;
    const rawLevelsSpent=dmToNullableNumber(alloc.levels_plus);
    const hasLevelKeyword=/\b(?:levels?|lvl)\b/i.test(String(allocationText||''));
    const levelAssignmentHint=/\blevels?\s+to\b/i.test(String(allocationText||'')) || /\blvl\s+to\b/i.test(String(allocationText||''));
    let levelsSpent=(Number.isFinite(parsedLevelsSpent) && parsedLevelsSpent>0)?parsedLevelsSpent:null;
    if(
      hasLevelKeyword && levelAssignmentHint && Number.isFinite(rawLevelsSpent) && rawLevelsSpent>0
      && (levelsSpent==null || rawLevelsSpent>levelsSpent)
    ){
      levelsSpent=rawLevelsSpent;
    }
    let effectiveCost=baseCost;
    if(effectiveCost==null && parsed && parsed.downtimeSpent!=null){
      effectiveCost=parsed.downtimeSpent;
    }
    const effectiveGold=(parsed && parsed.goldSpent!=null)?parsed.goldSpent:null;
    let earnsLevel=allocationGrantsLevelToPool(season, allocationText, parsed);
    if(alloc && Object.prototype.hasOwnProperty.call(alloc,'earns_level')){
      earnsLevel=!!alloc.earns_level;
    }
    let levelsMinus=earnsLevel?1:null;
    if(alloc && Object.prototype.hasOwnProperty.call(alloc,'levels_minus')){
      const explicitMinus=dmToNullableNumber(alloc.levels_minus);
      levelsMinus=Number.isFinite(explicitMinus)?explicitMinus:null;
    }
    const entry={
      type:'allocation',
      season,
      date:alloc.date||'',
      allocation:allocationText||'',
      cost:effectiveCost,
      levels_plus:levelsSpent,
      levels_minus:levelsMinus,
      hours:hoursVal,
      extra_hours:bonusVal,
      location:alloc.location||'',
      gp:effectiveGold,
      allocation_tokens:parsed && Array.isArray(parsed.tokens)?parsed.tokens.slice():[],
      allocation_recipients:parsed && Array.isArray(parsed.recipients)?parsed.recipients.slice():[],
      allocation_item_tokens:parsed && Array.isArray(parsed.itemTokens)?parsed.itemTokens.slice():[]
    };
    if(alloc && Object.prototype.hasOwnProperty.call(alloc,'id') && alloc.id!=null){
      entry.id=alloc.id;
    }
    if(alloc && typeof alloc.charKey==='string' && alloc.charKey){
      entry.charKey=alloc.charKey;
    }
    if(alloc && Object.prototype.hasOwnProperty.call(alloc,'reward')){
      const clonedReward=cloneSimple(alloc.reward);
      if(clonedReward!=null) entry.reward=clonedReward;
    }
    if(alloc && Object.prototype.hasOwnProperty.call(alloc,'__source')){
      entry.__source=alloc.__source;
    }
    pushEntry(entry);
    DM_SUMMARY.allocations+=1;
    const countsTowardHoursPool=dmDateCountsTowardHoursPool(entry.date);
    const countsTowardLevelPool=allocationSeasonEligibleForLevelAccrual(season);
    if(countsTowardHoursPool && entry.cost!=null) DM_SUMMARY.allocatedCost+=entry.cost;
    if(countsTowardLevelPool && levelsSpent!=null) DM_SUMMARY.spentLevels+=levelsSpent;
    if(countsTowardLevelPool && levelsMinus!=null){
      DM_SUMMARY.earnedLevels+=Math.max(0, levelsMinus);
    }else if(countsTowardLevelPool && earnsLevel){
      DM_SUMMARY.earnedLevels+=1;
    }
  };
  if(DM_DATA){
    if(Array.isArray(DM_DATA.preS11)){
      DM_DATA.preS11.forEach(preEntry=>addPreEntry(preEntry));
    }
    if(DM_DATA.seasonal && typeof DM_DATA.seasonal==='object'){
      Object.entries(DM_DATA.seasonal).forEach(([seasonName, seasonData])=>{
        const runs=seasonData && Array.isArray(seasonData.runs)?seasonData.runs:[];
        runs.forEach(run=>addRun(seasonName, run));
        const allocations=seasonData && Array.isArray(seasonData.allocations)?seasonData.allocations:[];
        allocations.forEach(allocation=>addAllocation(seasonName, allocation));
      });
    }
  }
  if(customAllocations.length){
    customAllocations.forEach(raw=>{
      if(!raw || typeof raw!=='object') return;
      const record={
        date:raw.date||'',
        allocation:raw.allocation||'',
        cost:raw.cost,
        hours:raw.hours,
        extra_hours:raw.extra_hours,
        levels_plus:raw.levels_plus,
        levels_minus:raw.levels_minus,
        location:raw.location||'',
        gp:raw.gp,
        id:raw.id||null,
        charKey:raw.charKey||null,
        reward:raw.reward||null,
        earns_level:raw.earns_level,
        __source:'custom'
      };
      addAllocation(raw.season||'', record);
    });
  }
  DM_ENTRIES.sort((a,b)=>{
    const diff=dmTimestamp(b.date)-dmTimestamp(a.date);
    if(diff!==0) return diff;
    const orderA=(typeof a.__origIndex==='number')?a.__origIndex:0;
    const orderB=(typeof b.__origIndex==='number')?b.__origIndex:0;
    return orderA-orderB;
  });
  DM_ENTRIES.forEach((entry,index)=>{
    entry.sortIndex=index;
  });
  DM_SUMMARY.entries=DM_ENTRIES.length;
  if(DM_PRE_ITEMS.length){
    DM_PRE_ITEMS.sort((a,b)=>dmTimestamp(a.date)-dmTimestamp(b.date));
  }
  updateDmSummaryBar();
}

let DM_ALLOCATION_LINKS=new WeakMap();
let DM_REWARD_LINKS=new WeakMap();

function normalizeDateString(value){
  if(!value) return '';
  const text=String(value);
  if(/^\d{4}-\d{2}-\d{2}/.test(text)){
    return text.slice(0,10);
  }
  const ts=new Date(text).getTime();
  if(Number.isFinite(ts)){
    return new Date(ts).toISOString().slice(0,10);
  }
  return '';
}

function normalizeMatchToken(value){
  return String(value||'').toLowerCase().replace(/[^a-z0-9]+/g,'');
}

function extractAllocationRecipientDetails(text){
  const raw=String(text||'');
  if(!raw.trim()) return [];
  const lower=raw.toLowerCase();
  const firstToIdx=lower.indexOf(' to ');
  if(firstToIdx===-1) return [];
  const leadingSegment=raw.slice(0, firstToIdx);

  const extractLevelishNumber=(segment)=>{
    if(!segment) return null;
    const text=String(segment);
    const regex=/([0-9]+)/g;
    let match;
    while((match=regex.exec(text))){
      const num=Number(match[1]);
      if(!Number.isFinite(num)) continue;
      const after=text.slice(match.index+match[0].length);
      const afterStripped=after.replace(/^\s+/,'');
      if(!afterStripped) return num;
      const nextChar=afterStripped[0];
      if(nextChar===','||nextChar==='.'||nextChar===')'||nextChar===']') return num;
      const lowered=afterStripped.toLowerCase();
      for(const prefix of ['level','levels','lvl','to']){
        if(lowered.startsWith(prefix)) return num;
      }
      if(nextChar && /[a-z]/i.test(nextChar)) continue;
      return num;
    }
    return null;
  };

  const firstCountHint=extractLevelishNumber(leadingSegment);
  let tail=raw.slice(firstToIdx+4);
  tail=tail.replace(/[,.;]+$/,'');
  tail=tail.replace(/\band\b/gi,',');
  tail=tail.replace(/&/g,',');
  tail=tail.replace(/\//g,',');
  const extractNumber=(segment)=>extractLevelishNumber(segment);
  const results=[];
  tail.split(',').map(part=>part.trim()).filter(Boolean).forEach((part,index)=>{
    if(!part) return;
    let working=part;
    let countHint=null;
    const innerToIdx=working.toLowerCase().lastIndexOf(' to ');
    if(innerToIdx!==-1){
      const beforeInner=working.slice(0, innerToIdx);
      const afterInner=working.slice(innerToIdx+4).trim();
      if(afterInner) working=afterInner;
      const innerNumber=extractNumber(beforeInner);
      if(innerNumber!=null) countHint=innerNumber;
    }
    const prefixMatch=working.match(/^([0-9]+)\s*(?:levels?|lvl)?\b/i);
    if(prefixMatch){
      countHint=Number(prefixMatch[1]);
      working=working.slice(prefixMatch[0].length).trim();
    }
    const multiplierMatch=working.match(/\(x\s*([0-9]+)\s*\)/i);
    if(multiplierMatch){
      countHint=Number(multiplierMatch[1]);
      working=working.replace(multiplierMatch[0],'').trim();
    }
    const suffixMatch=working.match(/([0-9]+)\s*(?:levels?|lvl)\b/i);
    if(suffixMatch){
      countHint=Number(suffixMatch[1]);
      working=working.replace(suffixMatch[0],'').trim();
    }
    working=working.replace(/^[+&]+/,'').trim();
    if(!working) return;
    if(countHint==null && index===0 && Number.isFinite(firstCountHint)){
      countHint=firstCountHint;
    }
    if(countHint==null) countHint=1;
    results.push({ name:working, count:countHint });
  });
  return results;
}
function parseAllocationRecipients(text){
  return extractAllocationRecipientDetails(text).map(item=>item.name).filter(Boolean);
}
function extractAllocationItemTokens(text){
  if(text && typeof text==='object'){
    if(Array.isArray(text.allocation_item_tokens)){
      return text.allocation_item_tokens.slice();
    }
    text=text.allocation||'';
  }
  const raw=String(text||'');
  if(!raw) return [];
  const idx=raw.toLowerCase().lastIndexOf(' to ');
  const before=idx===-1?raw:raw.slice(0, idx);
  const candidates=before.split(/[+,&/]/).map(part=>normalizeMatchToken(part));
  const tokens=new Set();
  candidates.forEach(token=>{
    if(!token) return;
    if(token.length<4) return;
    if(!/[a-z]/.test(token)) return;
    if(/^(?:level|levels|hours|extra|bonus|dtd|gp)$/.test(token)) return;
    if(/^\d/.test(token)) return;
    tokens.add(token);
  });
  return Array.from(tokens);
}

function interpretAllocationDetails(text){
  const raw=String(text||'');
  const recipientDetails=extractAllocationRecipientDetails(raw);
  const recipients=recipientDetails.map(item=>item.name);
  const itemTokens=extractAllocationItemTokens(raw);
  const tokens=new Set();
  itemTokens.forEach(token=>{
    if(token) tokens.add(`item:${token}`);
  });

  const addNumericToken=(prefix,value)=>{
    if(value==null) return;
    const rounded=value%1===0?Math.trunc(value):Number(value.toFixed(2));
    tokens.add(`${prefix}:${rounded}`);
  };

  const normalizeNumber=(value,kFlag)=>{
    if(value==null) return null;
    let cleaned=String(value).replace(/,/g,'');
    if(!cleaned) return null;
    const num=Number(cleaned);
    if(!Number.isFinite(num)) return null;
    return kFlag?num*1000:num;
  };

  const detail={
    recipients,
    itemTokens,
    tokens:null,
    levelsSpent:null,
    levelsGained:null,
    downtimeSpent:null,
    goldSpent:null
  };

  if(Array.isArray(recipients)){
    recipients.forEach(rec=>{
      const normalized=normalizeMatchToken(rec);
      if(normalized) tokens.add(`recipient:${normalized}`);
    });
  }

  const explicitLevelMatches=[];
  raw.replace(/(?:^|[\s,+/&-])([0-9]+)\s*(?:levels?|lvl)\b/gi,(match,value)=>{
    const parsed=normalizeNumber(value,false);
    if(parsed!=null) explicitLevelMatches.push(parsed);
    return match;
  });
  const explicitLevelTotal=explicitLevelMatches.reduce((sum,val)=>sum+val,0);
  const hasLevelKeyword=/\b(?:levels?|lvl)\b/i.test(raw);
  const levelAssignmentHint=/\blevels?\s+to\b/i.test(raw)||/\blvl\s+to\b/i.test(raw);
  const multiplierMatches=[];
  raw.replace(/\(x\s*([0-9]+)\s*\)/gi,(match,value)=>{
    const parsed=normalizeNumber(value,false);
    if(parsed!=null) multiplierMatches.push(parsed);
    return match;
  });
  if(hasLevelKeyword && levelAssignmentHint){
    const levelsFromRecipients=recipientDetails.reduce((sum,item)=>{
      const value=Number(item && item.count);
      if(!Number.isFinite(value) || value<=0) return sum;
      return sum+value;
    },0);
    if(levelsFromRecipients>0){
      detail.levelsSpent=levelsFromRecipients;
    }else if(explicitLevelTotal>0){
      detail.levelsSpent=explicitLevelTotal;
    }else if(multiplierMatches.length>0){
      const multiplierTotal=multiplierMatches.reduce((sum,val)=>sum+val,0);
      if(multiplierTotal>0){
        detail.levelsSpent=multiplierTotal;
      }
    }else if(recipientDetails.length>0){
      detail.levelsSpent=recipientDetails.length;
    }else{
      detail.levelsSpent=1;
    }
  }

  const dtdMatches=[];
  raw.replace(/([0-9][0-9,]*)(?:\s*(k))?\s*dtd\b/gi,(match,value,kFlag)=>{
    const parsed=normalizeNumber(value,kFlag);
    if(parsed!=null) dtdMatches.push(parsed);
    return match;
  });
  if(dtdMatches.length>0){
    const dtdTotal=dtdMatches.reduce((sum,val)=>sum+val,0);
    if(dtdTotal>0) detail.downtimeSpent=dtdTotal;
  }

  const gpMatches=[];
  raw.replace(/([0-9][0-9,]*)(?:\s*(k))?\s*gp\b/gi,(match,value,kFlag)=>{
    const parsed=normalizeNumber(value,kFlag);
    if(parsed!=null) gpMatches.push(parsed);
    return match;
  });
  if(gpMatches.length>0){
    const gpTotal=gpMatches.reduce((sum,val)=>sum+val,0);
    if(gpTotal>0) detail.goldSpent=gpTotal;
  }

  if(detail.levelsSpent!=null) addNumericToken('levels',detail.levelsSpent);
  if(detail.downtimeSpent!=null) addNumericToken('dtd',detail.downtimeSpent);
  if(detail.goldSpent!=null) addNumericToken('gp',detail.goldSpent);

  detail.tokens=Array.from(tokens);
  return detail;
}
function extractContentTokens(values){
  const tokens=new Set();
  const stopWords=new Set(['and','the','for','with','from','into','onto','this','that','item','items','reward','rewards','entry','entries','log','card','cards','season','seasonal','dm','of','to','per','plus','minus','bonus','extra','cost','gp','hour','hours','level','levels','dtd','loss','spent','earned','player']);
  const addFromValue=(val)=>{
    if(val==null) return;
    if(Array.isArray(val)){
      val.forEach(addFromValue);
      return;
    }
    const text=String(val).toLowerCase();
    if(!text.trim()) return;
    text.split(/[^a-z0-9]+/).forEach(part=>{
      const cleaned=part.trim();
      if(!cleaned) return;
      if(cleaned.length<3) return;
      if(stopWords.has(cleaned)) return;
      const normalized=normalizeMatchToken(cleaned);
      if(!normalized) return;
      tokens.add(normalized);
    });
  };
  addFromValue(values);
  return Array.from(tokens);
}
function buildAllocationItemSeasonIndex(entries){
  const map=new Map();
  if(!Array.isArray(entries)) return map;
  entries.forEach(entry=>{
    if(!entry || entry.type!=='allocation') return;
    const season=entry.season||'';
    if(!season) return;
    extractAllocationItemTokens(entry).forEach(token=>{
      if(!map.has(token)) map.set(token,new Set());
      map.get(token).add(season);
    });
  });
  return map;
}

function rebuildDmRewardLinks(){
  DM_ALLOCATION_LINKS=new WeakMap();
  DM_REWARD_LINKS=new WeakMap();
  if(!DATA || !DATA.characters || !DM_ENTRIES || !DM_ENTRIES.length){
    return;
  }
  DM_ENTRIES.forEach(entry=>{
    if(entry && typeof entry==='object' && Object.prototype.hasOwnProperty.call(entry,'__directMatchAssigned')){
      delete entry.__directMatchAssigned;
    }
  });
  const charEntries=Object.entries(DATA.characters);
  if(!charEntries.length) return;

  const itemSeasonIndex=buildAllocationItemSeasonIndex(DM_ENTRIES);

  const allocationById=new Map();
  DM_ENTRIES.forEach(entry=>{
    if(!entry || entry.type!=='allocation') return;
    if(entry.id!=null){
      allocationById.set(entry.id, entry);
    }
  });

  const assignedRewards=new Set();

  const fragmentOwnersLower=new Map();
  const fragmentOwnersCompact=new Map();
  const characterMeta=charEntries.map(([key,obj])=>{
    const names=new Set();
    const pushName=(val)=>{
      if(!val) return;
      const text=String(val).trim();
      if(text) names.add(text);
    };
    pushName(key);
    if(obj && typeof obj==='object'){
      pushName(obj.display_name);
      if(typeof obj.sheet==='string') pushName(obj.sheet);
    }
    Array.from(names).forEach(name=>{
      const cleaned=name.replace(/\(.*?\)/g,' ').replace(/\s{2,}/g,' ').trim();
      if(cleaned && cleaned!==name){
        names.add(cleaned);
      }
    });
    const lowerVariants=new Set();
    const compactVariants=new Set();
    const fragments=new Set();
    names.forEach(name=>{
      const lower=name.toLowerCase();
      if(lower) lowerVariants.add(lower);
      const compact=normalizeMatchToken(name);
      if(compact) compactVariants.add(compact);
      name.split(/[^A-Za-z0-9]+/).forEach(part=>{
        const trimmed=part.trim();
        if(trimmed.length>=3){
          fragments.add(trimmed);
        }
      });
    });
    return { key, lower:Array.from(lowerVariants).filter(Boolean), compact:Array.from(compactVariants).filter(Boolean), fragments };
  });

  characterMeta.forEach(meta=>{
    meta.fragments.forEach(fragment=>{
      const lower=fragment.toLowerCase();
      if(lower){
        if(!fragmentOwnersLower.has(lower)) fragmentOwnersLower.set(lower,new Set());
        fragmentOwnersLower.get(lower).add(meta.key);
      }
      const compact=normalizeMatchToken(fragment);
      if(compact){
        if(!fragmentOwnersCompact.has(compact)) fragmentOwnersCompact.set(compact,new Set());
        fragmentOwnersCompact.get(compact).add(meta.key);
      }
    });
  });

  const uniqueFragmentLower=new Map();
  fragmentOwnersLower.forEach((owners,frag)=>{
    if(owners.size===1){
      uniqueFragmentLower.set(frag, owners.values().next().value);
    }
  });
  const uniqueFragmentCompact=new Map();
  fragmentOwnersCompact.forEach((owners,frag)=>{
    if(owners.size===1){
      uniqueFragmentCompact.set(frag, owners.values().next().value);
    }
  });

  const rewardMetaByChar=new Map();
  charEntries.forEach(([key,obj])=>{
    const advs=obj && Array.isArray(obj.adventures)?obj.adventures:[];
    advs.forEach(adv=>{
      if(!isDmRewardEntry(adv)) return;
      const allocationId=adv.__dmAllocationId || adv.dm_allocation_id || adv.dmAllocationId;
      if(allocationId!=null && allocationById.has(allocationId)){
        const linkedEntry=allocationById.get(allocationId);
        if(linkedEntry){
          DM_ALLOCATION_LINKS.set(linkedEntry,{charKey:key,adv});
          DM_REWARD_LINKS.set(adv,{entry:linkedEntry,charKey:key});
          assignedRewards.add(adv);
          linkedEntry.__directMatchAssigned=true;
        }
        return;
      }
      const inferredSeason=inferSeasonFromReward(adv);
      const meta={
        charKey:key,
        adv,
        date:normalizeDateString(adv.date),
        levels:Number(adv.level_plus||0)||0,
        dtd:Number(adv.dtd_net||0)||0,
        hours:(Number(adv.hours)||0)+(Number(adv.extra_hours)||0),
        itemsNormalized:Array.isArray(adv.perm_items)?adv.perm_items.map(item=>normalizeMatchToken(item)).filter(token=>token && token.length>=2):[],
        season:inferredSeason,
        seasonGroup:normalizeSeasonGroup(inferredSeason)
      };
      const textSources=[];
      const pushText=(val)=>{
        if(val==null) return;
        if(Array.isArray(val)){
          val.forEach(pushText);
          return;
        }
        const text=String(val).trim();
        if(text) textSources.push(text);
      };
      pushText(adv.title);
      pushText(adv.notes);
      pushText(adv.adventure);
      pushText(adv.story_awards);
      pushText(adv.reward);
      pushText(adv.log);
      pushText(adv.description);
      pushText(adv.summary);
      pushText(adv.details);
      pushText(adv.item);
      pushText(adv.magic_item);
      pushText(adv.magic_items);
      pushText(adv.story);
      if(Array.isArray(adv.perm_items)) pushText(adv.perm_items.join(' '));
      if(Array.isArray(adv.temp_items)) pushText(adv.temp_items.join(' '));
      if(Array.isArray(adv.consumable_items)) pushText(adv.consumable_items.join(' '));
      const combinedLower=textSources.join(' ').toLowerCase();
      const contentTokenSet=new Set(meta.itemsNormalized);
      extractContentTokens(textSources).forEach(token=>contentTokenSet.add(token));
      meta.contentTokens=Array.from(contentTokenSet);
      meta.hasLevelKeyword=/\blevels?\b/.test(combinedLower);
      meta.hasDtdKeyword=/\bdtd\b/.test(combinedLower) || /down\s*time/.test(combinedLower);
      meta.hasHourKeyword=/\bhours?\b/.test(combinedLower);
      if(meta.itemsNormalized.length){
        const seasonsFromItems=new Set();
        meta.itemsNormalized.forEach(token=>{
          const seasons=itemSeasonIndex.get(token);
          if(seasons){
            seasons.forEach(season=>{
              if(season) seasonsFromItems.add(season);
            });
          }
        });
        const seasonsArray=Array.from(seasonsFromItems);
        if(seasonsArray.length===1){
          if(!meta.season) meta.season=dmNormalizeSeasonLabel(seasonsArray[0]);
          meta.seasonGroup=normalizeSeasonGroup(meta.season);
        }else if(seasonsArray.length>1){
          const groups=Array.from(new Set(seasonsArray.map(normalizeSeasonGroup).filter(Boolean)));
          if(groups.length===1){
            if(!meta.season) meta.season=dmNormalizeSeasonLabel(seasonsArray[0]);
            meta.seasonGroup=groups[0];
          }
        }
      }
      if(!meta.seasonGroup && meta.season){
        meta.seasonGroup=normalizeSeasonGroup(meta.season);
      }
      if(!rewardMetaByChar.has(key)) rewardMetaByChar.set(key,[]);
      rewardMetaByChar.get(key).push(meta);
    });
  });

  DM_ENTRIES.forEach(entry=>{
    if(!entry || entry.type!=='allocation' || entry.__directMatchAssigned) return;
    const allocationText=entry.allocation||'';
    if(!allocationText) return;
    const normalizedText=allocationText.toLowerCase();
    const normalizedCompact=normalizeMatchToken(allocationText);
    const allocationTokens=(entry && Array.isArray(entry.allocation_item_tokens) && entry.allocation_item_tokens.length)
      ? entry.allocation_item_tokens.slice()
      : extractAllocationItemTokens(allocationText);
    const allocationTokenSet=new Set(allocationTokens);
    const allocationWordSet=new Set(normalizedText.split(/[^a-z0-9]+/).map(part=>normalizeMatchToken(part)).filter(token=>token && token.length>=3));
    const recipients=parseAllocationRecipients(allocationText);
    const matchedKeys=new Set();

    if(recipients.length){
      recipients.forEach(rec=>{
        const variants=[rec, rec.replace(/\(.*?\)/g,' ').trim()];
        variants.forEach(variant=>{
          if(!variant) return;
          const lowerVariant=variant.toLowerCase();
          const compactVariant=normalizeMatchToken(variant);
          characterMeta.forEach(meta=>{
            if(matchedKeys.has(meta.key)) return;
            if(meta.lower.includes(lowerVariant) || (compactVariant && meta.compact.includes(compactVariant))){
              matchedKeys.add(meta.key);
              return;
            }
            if(uniqueFragmentLower.get(lowerVariant)===meta.key || (compactVariant && uniqueFragmentCompact.get(compactVariant)===meta.key)){
              matchedKeys.add(meta.key);
            }
          });
        });
      });
    }

    if(!matchedKeys.size){
      characterMeta.forEach(meta=>{
        const lowerHit=meta.lower.some(name=>name && normalizedText.includes(name));
        const compactHit=meta.compact.some(name=>name && normalizedCompact.includes(name));
        if(lowerHit || compactHit){
          matchedKeys.add(meta.key);
        }
      });
    }

    if(matchedKeys.size!==1) return;
    const [charKey]=matchedKeys;
    const candidates=rewardMetaByChar.get(charKey)||[];
    if(!candidates.length) return;

    const targetLevels=Number(entry.levels_plus||0)||0;
    const targetCost=Number(entry.cost||0)||0;
    const targetHours=(Number(entry.hours)||0)+(Number(entry.extra_hours)||0);
    let bestScore=-Infinity;
    let bestCandidates=[];

    candidates.forEach(meta=>{
      let score=0;
      if(targetLevels && meta.levels===targetLevels) score+=6;
      else if(targetLevels && meta.levels && Math.abs(meta.levels-targetLevels)===1) score+=2;
      else if(!targetLevels && meta.levels===0) score+=1;
      if(targetCost && meta.dtd===targetCost) score+=6;
      else if(targetCost && meta.dtd && Math.abs(meta.dtd-targetCost)<=1) score+=2;
      else if(!targetCost && meta.dtd===0) score+=1;
      if(targetHours && meta.hours===targetHours) score+=5;
      else if(targetHours && meta.hours && Math.abs(meta.hours-targetHours)<=1) score+=2;
      else if(!targetHours && meta.hours===0) score+=1;
      const itemMatches=meta.itemsNormalized.filter(token=>token && (allocationTokenSet.has(token) || normalizedCompact.includes(token))).length;
      if(itemMatches>0){
        score+=itemMatches*7;
        if(itemMatches===meta.itemsNormalized.length){
          score+=3;
        }
      }
      if(Array.isArray(meta.contentTokens) && meta.contentTokens.length){
        const contentMatches=meta.contentTokens.filter(token=>token && (allocationTokenSet.has(token) || normalizedCompact.includes(token) || allocationWordSet.has(token))).length;
        if(contentMatches>0){
          score+=contentMatches*3;
        }
      }
      if(meta.levels>0 && (normalizedText.includes('level') || meta.hasLevelKeyword)) score+=1;
      if(meta.dtd>0 && (normalizedText.includes('dtd') || meta.hasDtdKeyword)) score+=1;
      if(meta.hasHourKeyword && targetHours>0) score+=1;

      if(score>bestScore){
        bestScore=score;
        bestCandidates=[meta];
      }else if(score===bestScore && score>0){
        bestCandidates.push(meta);
      }
    });

    if(bestScore<5 || bestCandidates.length!==1) return;
    const bestMeta=bestCandidates[0];
    if(assignedRewards.has(bestMeta.adv)) return;
    assignedRewards.add(bestMeta.adv);
    DM_ALLOCATION_LINKS.set(entry,{charKey,adv:bestMeta.adv});
    DM_REWARD_LINKS.set(bestMeta.adv,{entry,charKey});
  });
}
function updateDmMeta(){
  if(metaEl){
    const totalRuns=Number(DM_SUMMARY && DM_SUMMARY.runs);
    const runs=Number.isFinite(totalRuns)?totalRuns:0;
    if(runs>0){
      const label=runs===1?'Session':'Sessions';
      const text=`${fmtNumber(runs)} ${label}`;
      metaEl.textContent=text;
      metaEl.style.display='block';
      metaEl.setAttribute('aria-hidden','false');
    }else{
      metaEl.textContent='';
      metaEl.style.display='none';
      metaEl.setAttribute('aria-hidden','true');
    }
  }
  updateDmSummaryBar();
}
function updateDmSummaryBar(){
  if(!dmSummaryBar) return;
  const earned=(Number(DM_SUMMARY.earnedHours)||0)+(Number(DM_SUMMARY.earnedBonus)||0);
  const spent=(Number(DM_SUMMARY.allocatedCost)||0);
  const available=earned-spent;
  const levelBalance=(Number(DM_SUMMARY.earnedLevels)||0)-(Number(DM_SUMMARY.spentLevels)||0);
  const applySummaryValue=(el,label,value)=>{
    if(!el) return '';
    const raw=Number(value||0);
    const num=Number.isFinite(raw)?raw:0;
    const formatted=num>0
      ? fmtNumber(num)
      : num<0
        ? `-${fmtNumber(Math.abs(num))}`
        : '0';
    el.textContent=formatted;
    el.setAttribute('data-value', String(num));
    el.classList.remove('gain','loss','neutral');
    if(num>0){
      el.classList.add('gain');
    }else if(num<0){
      el.classList.add('loss');
    }else{
      el.classList.add('neutral');
    }
    return `${label} ${formatted}`;
  };
  const hoursLabel=applySummaryValue(dmHoursValueEl,'Hours',available);
  const levelsLabel=applySummaryValue(dmLevelsValueEl,'Levels',levelBalance);
  if(dmTotalsPill){
    const labelParts=[hoursLabel,levelsLabel].filter(Boolean);
    if(labelParts.length){
      dmTotalsPill.style.display='inline-flex';
      dmTotalsPill.setAttribute('aria-label', `Net Dungeon Master rewards  ${labelParts.join(', ')}`);
      dmTotalsPill.setAttribute('title', labelParts.join('  '));
    }else{
      dmTotalsPill.style.display='none';
      dmTotalsPill.removeAttribute('title');
      dmTotalsPill.removeAttribute('aria-label');
    }
  }
  const itemCount=DM_PRE_ITEMS.length||0;
  if(dmItemsBtnEl){
    const label=`View unallocated pre-Season 11 magic items (${fmtNumber(itemCount)} ${itemCount===1?'item':'items'})`;
    dmItemsBtnEl.setAttribute('aria-label', label);
    dmItemsBtnEl.title=label;
  }
  if(dmItemsListEl){
    dmItemsListEl.innerHTML='';
    if(!itemCount){
      const empty=document.createElement('div');
      empty.className='dm-items-empty';
      empty.textContent='All pre-Season 11 items are allocated';
      dmItemsListEl.appendChild(empty);
    }else{
      DM_PRE_ITEMS.forEach(item=>{
        const row=document.createElement('div');
        row.className='dm-items-row';
        const name=document.createElement('div');
        name.textContent=item.item||'Unknown item';
        row.appendChild(name);
        const metaParts=[];
        if(item.date){
          const formatted=fmtDate(item.date);
          if(formatted) metaParts.push(formatted);
        }
        if(item.code){ metaParts.push(item.code); }
        if(item.location){ metaParts.push(item.location); }
        if(metaParts.length){
          const meta=document.createElement('div');
          meta.className='dm-items-meta';
          meta.textContent=metaParts.join('  ');
          row.appendChild(meta);
        }
        dmItemsListEl.appendChild(row);
      });
    }
  }
}
function openDmItemsModal(){
  if(!dmItemsModal) return;
  closeAddMenu();
  updateDmSummaryBar();
  dmItemsModal.classList.add('open');
  refreshModalState();
  if(dmItemsBtnEl){
    dmItemsBtnEl.setAttribute('aria-expanded','true');
  }
  if(dmItemsCloseBtn){
    try{ dmItemsCloseBtn.focus({preventScroll:true}); }
    catch(err){ dmItemsCloseBtn.focus(); }
  }
}
function closeDmItemsModal(){
  if(dmItemsModal){
    dmItemsModal.classList.remove('open');
  }
  refreshModalState();
  if(dmItemsBtnEl){
    dmItemsBtnEl.setAttribute('aria-expanded','false');
  }
}
function setDmHeader(){
  if(avatarEl){
    resetAvatar();
    if(AVATAR_FALLBACK_PATH){
      avatarEl.src=AVATAR_FALLBACK_PATH;
      avatarEl.classList.add('avatar-fallback');
    }
    avatarEl.alt='Dungeon Master Log';
  }
  if(badgesEl){
    badgesEl.innerHTML='';
    badgesEl.style.display='none';
    badgesEl.setAttribute('aria-hidden','true');
  }
}

function updateSearchClearButton(){
  if(!qEl || !searchClearBtn) return;
  const hasValue=typeof qEl.value==='string' && qEl.value.trim()!=='';
  searchClearBtn.hidden=!hasValue;
  searchClearBtn.setAttribute('aria-hidden', hasValue?'false':'true');
}

function updateSearchPlaceholder(selectedKey){
  if(!qEl) return;
  const key=selectedKey!=null?selectedKey:((charSel&&charSel.value)||'');
  let placeholder='';
  if(isDmLogKey(key)){
    placeholder='Search DM log entries';
  }else if(searchAllCharacters){
    placeholder='Search all characters';
  }else{
    const name=getCharacterDisplayName(key);
    if(name){
      placeholder=`Search ${name}`;
    }
  }
  if(!placeholder){
    placeholder=defaultSearchPlaceholder||'';
  }
  if(placeholder){
    qEl.setAttribute('placeholder', placeholder);
    qEl.setAttribute('aria-label', placeholder);
  }else{
    qEl.removeAttribute('aria-label');
  }
}
function updateUiForSelection(key){
  closeCharMenu();
  closeAddMenu();
  updateCharacterSidebarSelection(key);
  const isDm=isDmLogKey(key);
  if(headerQuick){
    headerQuick.style.display=isDm?'none':'';
    headerQuick.setAttribute('aria-hidden', isDm?'true':'false');
  }
  if(dmSummaryBar){
    const showSummary=isDm && hasDmLogData();
    dmSummaryBar.hidden=!showSummary;
    dmSummaryBar.setAttribute('aria-hidden', showSummary?'false':'true');
  }
  if(!isDm){
    closeDmItemsModal();
  }
  if(activityToggleBtn){
    activityToggleBtn.style.display=isDm?'none':'';
    activityToggleBtn.setAttribute('aria-hidden', isDm?'true':'false');
  }
  if(searchScopeToggleBtn){
    const showMulti=!isDm;
    searchScopeToggleBtn.style.display=showMulti?'':'none';
    searchScopeToggleBtn.setAttribute('aria-hidden', showMulti?'false':'true');
  }
  if(addCardBtn){
    const showButton=!isDm || hasDmLogData();
    addCardBtn.style.display=showButton?'':'';
    addCardBtn.setAttribute('aria-hidden', showButton?'false':'true');
    if(!showButton){
      closeAddMenu();
    }
  }
  if(qEl){
    updateSearchPlaceholder(key);
    updateSearchClearButton();
  }
  updateAddButtonContext(isDm);
}

function updateAddButtonContext(isDm){
  if(!addCardBtn) return;
  const description=isDm?'Add a new DM session or reward allocation':'Add a new adventure or downtime activity';
  addCardBtn.title=description;
  addCardBtn.setAttribute('aria-label', description);
  const expanded=isMenuOpen(addCardMenu)?'true':'false';
  addCardBtn.setAttribute('aria-expanded', expanded);
}
function renderDmLog(){
  if(!grid) return;
  const query=(qEl && typeof qEl.value==='string')?qEl.value.trim().toLowerCase():'';
  const filtered=DM_ENTRIES.filter(entry=>{
    if(!query) return true;
    const roleText=Array.isArray(entry.roles)?entry.roles.join(' '):'';
    const blob=[
      entry.season,
      entry.name,
      entry.code,
      entry.allocation,
      entry.location,
      entry.item,
      roleText,
      entry.tier,
      entry.cost,
      entry.levels_plus,
      entry.levels_minus,
      entry.hours,
      entry.extra_hours
    ].map(val=>val==null?'':String(val)).join(' ').toLowerCase();
    return blob.includes(query);
  });
  grid.innerHTML='';
  if(!filtered.length){
    if(emptyEl&&!isDataLoadErrorActive()){
      emptyEl.textContent=DM_EMPTY_MESSAGE;
      emptyEl.style.display='block';
    }
    return;
  }
  if(emptyEl&&!isDataLoadErrorActive()){
    emptyEl.textContent=DM_EMPTY_MESSAGE;
    emptyEl.style.display='none';
  }
  filtered.forEach((entry,idx)=>{
    const card=makeDmCard(entry,idx);
    grid.appendChild(card);
  });
}
function makeDmCard(entry,idx){
  const isAllocation=entry.type==='allocation';
  const card=document.createElement('article');
  card.className='card dm-card'+(isAllocation?' activity':'');
  card.classList.add(isAllocation?'dm-card--allocation':'dm-card--session');
  const sortIdx=entry.sortIndex!=null?entry.sortIndex:idx;
  card.dataset.idx=String(sortIdx);
  card.__dmEntry=entry;
  const dmHistoryId=getDmHistoryId(entry);
  if(dmHistoryId){
    card.dataset.historyId=dmHistoryId;
    card.dataset.historyType='dm';
  }
  const linkMeta=(DM_ALLOCATION_LINKS && DM_ALLOCATION_LINKS.get(entry))||null;
  let createLinkChip=null;
  if(linkMeta && linkMeta.adv){
    const charObj=(DATA && DATA.characters && DATA.characters[linkMeta.charKey])||null;
    const charName=(charObj && (charObj.display_name || charObj.sheet)) || linkMeta.charKey;
    const label=`View DM reward entry for ${charName}`;
    createLinkChip=()=>{
      const chip=document.createElement('button');
      chip.type='button';
      chip.className='pill pill-link';
      chip.textContent='Reward entry';
      chip.title=label;
      chip.setAttribute('aria-label',label);
      chip.addEventListener('click',(ev)=>{
        ev.stopPropagation();
        ev.preventDefault();
        navigateToCharacterReward(linkMeta.charKey, linkMeta.adv);
      });
      return chip;
    };
  }

  const header=document.createElement('div');
  header.className='card-hd';

  const headerMetaKeys=new Set();
  const headerMetricKeys=new Set();
  const metaParts=[];
  const addMetaPart=(key,label,value)=>{
    const normalized=normalizeDisplayValue(value);
    if(!normalized) return;
    if(key){ headerMetaKeys.add(key); }
    if(label){
      metaParts.push(`${label}: ${normalized}`);
    }else{
      metaParts.push(normalized);
    }
  };

  const metricsRow=document.createElement('div');
  metricsRow.className='dm-card-metrics';
  const addMetric=(key,label,value,variant)=>{
    if(value==null) return;
    const text=String(value).trim();
    if(!text) return;
    const metric=document.createElement('div');
    metric.className='dm-card-metric';
    if(variant){ metric.classList.add(`dm-card-metric--${variant}`); }
    const valueEl=document.createElement('div');
    valueEl.className='dm-card-metric-value';
    valueEl.textContent=text;
    const labelEl=document.createElement('div');
    labelEl.className='dm-card-metric-label';
    labelEl.textContent=label;
    metric.append(valueEl,labelEl);
    metricsRow.appendChild(metric);
    if(key){ headerMetricKeys.add(key); }
  };

  const main=document.createElement('div');
  main.className='log-row';
  const info=document.createElement('div');
  info.className='log-row-info';

  const headerMain=document.createElement('div');
  headerMain.className='log-row-main';
  info.appendChild(headerMain);

  const titleWrap=document.createElement('span');
  titleWrap.className='log-row-title';
  const titleDisplay=document.createElement('span');
  titleDisplay.className='display';
  titleWrap.appendChild(titleDisplay);
  titleWrap.__display=titleDisplay;
  bindScrollableObserver(titleWrap);
  headerMain.appendChild(titleWrap);

  const dateStatsRow=document.createElement('div');
  dateStatsRow.className='log-row-datestats';
  headerMain.appendChild(dateStatsRow);

  const dateEl=document.createElement('span');
  dateEl.className='log-row-date';
  const dateDisplay=document.createElement('span');
  dateDisplay.className='display';
  dateDisplay.textContent=fmtDate(entry.date);
  dateEl.appendChild(dateDisplay);
  dateEl.__display=dateDisplay;
  bindScrollableObserver(dateEl);
  dateStatsRow.appendChild(dateEl);

  const stats=document.createElement('div');
  stats.className='log-row-stats';
  dateStatsRow.appendChild(stats);

  const chipsRow=document.createElement('div');
  chipsRow.className='log-row-chips';
  chipTickerRegistry.register(chipsRow);
  const chips=createChipsContainer();
  chipsRow.appendChild(chips);

  const refreshChipsRow=()=>{
    const hasChips=chips.childElementCount>0;
    const statsVisible=(stats.parentNode===chipsRow && stats.style.display!=='none');
    chipsRow.style.display=(hasChips||statsVisible)?'flex':'none';
    chipTickerRegistry.refresh(chipsRow);
    tickerRowRegistry.schedule();
  };

  const mobileChipsQuery=(typeof window!=='undefined' && typeof window.matchMedia==='function')
    ? window.matchMedia('(max-width: 520px)')
    : null;
  const syncStatsPlacement=()=>{
    if(mobileChipsQuery && mobileChipsQuery.matches){
      if(stats.parentNode!==chipsRow){
        stats.classList.add('log-row-stats--mobile');
        chipsRow.appendChild(stats);
      }
    }else{
      if(stats.parentNode!==dateStatsRow){
        stats.classList.remove('log-row-stats--mobile');
        dateStatsRow.appendChild(stats);
      }
    }
    refreshChipsRow();
  };
  if(mobileChipsQuery){
    if(typeof mobileChipsQuery.addEventListener==='function'){
      mobileChipsQuery.addEventListener('change', syncStatsPlacement);
    }else if(typeof mobileChipsQuery.addListener==='function'){
      mobileChipsQuery.addListener(syncStatsPlacement);
    }
  }

  const headerLinkChip=(!isAllocation && createLinkChip)?createLinkChip():null;

  const typeTag=document.createElement('span');
  typeTag.className='tag '+(isAllocation?'tag-dm-allocation':'tag-dm-session');
  typeTag.textContent=isAllocation?'Allocation':'Session';
  chips.appendChild(typeTag);
  if(headerLinkChip){ chips.appendChild(headerLinkChip); }

  let hoursVal=null;
  let bonusVal=null;
  let costVal=null;
  let levelsEarnedVal=null;
  let levelsSpentVal=null;

  if(isAllocation){
    titleDisplay.textContent='Rewards allocated';
    hoursVal=dmToNullableNumber(entry.hours);
    bonusVal=dmToNullableNumber(entry.extra_hours);
    const mentions=renderCharacterMentions(entry.allocation||'');
    if(mentions){
      const chipLine=document.createElement('span');
      chipLine.className='dm-allocation-chipline';
      Array.from(mentions.childNodes).forEach(node=>{
        if(node.nodeType===Node.ELEMENT_NODE){
          chipLine.appendChild(node);
        }
      });
      if(chipLine.childNodes.length){
        titleDisplay.appendChild(document.createTextNode('  '));
        titleDisplay.appendChild(chipLine);
      }
    }
    costVal=dmToNullableNumber(entry.cost);
    levelsEarnedVal=dmToNullableNumber(entry.levels_minus);
    levelsSpentVal=dmToNullableNumber(entry.levels_plus);
  }else{
    const sessionTitle=sanitizeTitle(entry.name || entry.code || 'DM Session');
    setElementTextWithCharacterChips(titleDisplay, sessionTitle, {label:'DM Session', force:true});
    hoursVal=dmToNullableNumber(entry.hours);
    bonusVal=dmToNullableNumber(entry.extra_hours);
    levelsEarnedVal=dmToNullableNumber(entry.levels_plus);
    levelsSpentVal=dmToNullableNumber(entry.levels_minus);
  }

  const totalsChip=buildDmTotalsChip(hoursVal, bonusVal, costVal, levelsEarnedVal, levelsSpentVal);
  stats.innerHTML='';
  if(totalsChip){
    stats.appendChild(totalsChip);
    stats.style.display='flex';
  }else{
    stats.style.display='none';
  }

  setupTickerRow(headerMain,titleWrap,dateStatsRow,{
    onToggle:()=>{
      if(titleWrap && typeof titleWrap.__refreshScroll==='function'){
        titleWrap.__refreshScroll();
      }
      if(dateEl && typeof dateEl.__refreshScroll==='function'){
        dateEl.__refreshScroll();
      }
    }
  });
  requestAnimationFrame(()=>{
    refreshScrollableWrapper(titleWrap);
    refreshScrollableWrapper(dateEl);
  });

  if(isAllocation){
    addMetaPart('season','Season',entry.season);
  }else{
    addMetaPart('code',null,entry.code);
  }
  addMetaPart('location','Location',entry.location);
  if(!isAllocation){
    addMetaPart('item','Reward',entry.item);
  }
  if(metaParts.length){
    const metaRow=document.createElement('div');
    metaRow.className='log-row-meta';
    const metaText=document.createElement('span');
    metaText.className='log-row-meta-text';
    metaText.textContent=metaParts.join('    ');
    metaRow.appendChild(metaText);
    metaRow.__display=metaText;
    bindScrollableObserver(metaRow);
    info.appendChild(metaRow);
    requestAnimationFrame(()=>{ refreshScrollableWrapper(metaRow); });
  }

  info.appendChild(chipsRow);
  syncStatsPlacement();

  if(metricsRow.children.length){
    info.appendChild(metricsRow);
  }

  main.appendChild(info);
  header.appendChild(main);

  header.addEventListener('click',()=>toggleCard(card));
  card.appendChild(header);

  const body=document.createElement('div');
  body.className='card-bd';
  const inner=document.createElement('div');
  inner.className='bd-in dm-details';
  const detailsGrid=document.createElement('div');
  detailsGrid.className='dm-details-grid';
  inner.appendChild(detailsGrid);

  const addField=(label,value)=>{
    if(value==null) return;
    let node=null;
    let text='';
    if(value instanceof Node){
      node=value;
    }else{
      text=normalizeDisplayValue(value);
      if(!text){
        return;
      }
    }
    const field=document.createElement('div');
    field.className='field dm-details-field';
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v';
    const display=document.createElement('div'); display.className='display';
    if(node){
      display.appendChild(node);
    }else{
      setElementTextWithCharacterChips(display, text, {label});
    }
    v.appendChild(display);
    field.append(k,v);
    detailsGrid.appendChild(field);
    field.__display=display;
    field.__setDisplayValue=(nextValue)=>{
      if(nextValue instanceof Node){
        if(typeof display.replaceChildren==='function'){ display.replaceChildren(nextValue); }
        else{
          while(display.firstChild){ display.removeChild(display.firstChild); }
          display.appendChild(nextValue);
        }
      }else{
        const normalized=normalizeDisplayValue(nextValue);
        if(normalized){
          setElementTextWithCharacterChips(display, normalized, {label});
        }else{
          setElementTextWithCharacterChips(display, '', {label});
        }
      }
    };
    return field;
  };

  if(isAllocation){
    if(normalizeDisplayValue(entry.allocation)){
      addField('Rewards allocated', createAllocationDetailsList(entry.allocation));
    }
    if(createLinkChip){
      addField('Character reward entry', createLinkChip());
    }
    if(entry.season && !headerMetaKeys.has('season')){ addField('Season', entry.season); }
    if(entry.cost!=null && !headerMetricKeys.has('cost')){ addField('Season cost', fmtNumber(entry.cost)); }
    if(entry.levels_plus!=null && !headerMetricKeys.has('levels_plus')){ addField('Levels granted', fmtNumber(entry.levels_plus)); }
    if(entry.hours!=null && !headerMetricKeys.has('hours')){ addField('Hours', fmtNumber(entry.hours)); }
    if(entry.extra_hours!=null && !headerMetricKeys.has('extra_hours')){ addField('Bonus hours', fmtNumber(entry.extra_hours)); }
    if(entry.location && !headerMetaKeys.has('location')){ addField('Location', entry.location); }
  }else{
    if(entry.code && !headerMetaKeys.has('code')){ addField('Adventure code', entry.code); }
    if(entry.name){ addField('Adventure name', entry.name); }
    if(entry.tier!=null && entry.tier!=='' && !headerMetricKeys.has('tier')){ addField('Tier', fmtNumber(entry.tier)); }
    if(entry.hours!=null && !headerMetricKeys.has('hours')){ addField('Hours', fmtNumber(entry.hours)); }
    if(entry.extra_hours!=null && !headerMetricKeys.has('extra_hours')){ addField('Bonus hours', fmtNumber(entry.extra_hours)); }
    if(entry.roles && entry.roles.length){ addField('Roles', listBox(entry.roles)); }
    if(entry.levels_plus!=null && !headerMetricKeys.has('levels_plus')){ addField('Levels granted', fmtNumber(entry.levels_plus)); }
    if(entry.levels_minus!=null && entry.levels_minus!==entry.levels_plus && !headerMetricKeys.has('levels_minus')){ addField('Levels spent', fmtNumber(entry.levels_minus)); }
    if(entry.item && !headerMetaKeys.has('item')){ addField('Reward item', entry.item); }
    if(normalizeDisplayValue(entry.allocation)){ addField('Rewards allocated', createAllocationDetailsList(entry.allocation)); }
    if(entry.location && !headerMetaKeys.has('location')){ addField('Location', entry.location); }
  }

  body.appendChild(inner);
  card.appendChild(body);
  return card;
}

function getMostRecentCharacter(){
  if(!DATA || !DATA.characters){
    return '';
  }
  let latestKey=null, latestDate=0;
  for (const [key,obj] of Object.entries(DATA.characters)){
    if(!obj.adventures||!obj.adventures.length) continue;
    const maxDate=Math.max(...obj.adventures.map(a=>{ const t=new Date(a.date).getTime(); return isNaN(t)?0:t; }));
    if(maxDate>latestDate){ latestDate=maxDate; latestKey=key; }
  }
  const keys=Object.keys(DATA.characters);
  return latestKey || (keys.length?keys[0]:'');
}
function isActivityEntry(a){ return a && a.kind && a.kind!=='adventure'; }
function isDmRewardEntry(entry){
  if(!entry) return false;
  const title=String(entry.title||'').toLowerCase();
  const code=String(entry.code||'').toLowerCase();
  return title.includes('dm reward') || code.includes('dm reward');
}
function netVals(a){ return { gp:(+a.gp_plus||0)-(+a.gp_minus||0), dtd:(+a.dtd_plus||0)-(+a.dtd_minus||0) }; }
function fmtSigned(n){ return fmtNumber(n,{signed:true}); }

const __MIN_TIME=-8640000000000000;
function entryTimestamp(entry){
  if(!entry) return __MIN_TIME;
  const raw=entry.date;
  if(raw==null) return __MIN_TIME;
  if(raw instanceof Date){
    const t=raw.getTime();
    return Number.isFinite(t)?t:__MIN_TIME;
  }
  if(typeof raw==='number' && Number.isFinite(raw)) return raw;
  const t=new Date(raw).getTime();
  return Number.isFinite(t)?t:__MIN_TIME;
}
function entryIndexHint(wrapper){
  if(wrapper && typeof wrapper.idx==='number') return wrapper.idx;
  if(wrapper && typeof wrapper.index==='number') return wrapper.index;
  return 0;
}
function compareChronoDesc(a,b){
  const timeA=entryTimestamp(a&&a.adv?a.adv:a);
  const timeB=entryTimestamp(b&&b.adv?b.adv:b);
  if(timeA!==timeB) return timeB-timeA;
  return entryIndexHint(a)-entryIndexHint(b);
}
function compareChronoAsc(a,b){
  const timeA=entryTimestamp(a&&a.adv?a.adv:a);
  const timeB=entryTimestamp(b&&b.adv?b.adv:b);
  if(timeA!==timeB) return timeA-timeB;
  return entryIndexHint(a)-entryIndexHint(b);
}

/* --- smooth expand/collapse --- */
function isAnimating(card){ return card.dataset.anim==='1'; }
function setAnimating(card,on){ if(on) card.dataset.anim='1'; else delete card.dataset.anim; }
function afterTransition(el,prop,ms,cb){ let done=false; const onEnd=e=>{ if(e.propertyName!==prop||done)return; done=true; el.removeEventListener('transitionend',onEnd); cb(); }; el.addEventListener('transitionend',onEnd); setTimeout(()=>{ if(done)return; done=true; el.removeEventListener('transitionend',onEnd); cb(); },ms); }
const ACCORDION_EASE='cubic-bezier(0.33,1,0.68,1)';
function calcCardDuration(px){ if(!px||px<=0) return 220; const dur=200+px*0.35; return Math.round(Math.max(220, Math.min(620, dur))); }
function setCardDuration(bd,px){ const dur=calcCardDuration(px); bd.style.setProperty('--card-dur', dur+'ms'); return dur; }
function clearCardDuration(bd){ bd.style.removeProperty('--card-dur'); }
function cancelCardAnimation(card){
  if(!card) return;
  const bd=card.querySelector('.card-bd');
  if(!bd) return;
  const anim=bd.__accordionAnim;
  if(anim){
    anim.onfinish=null;
    anim.oncancel=null;
    try{ anim.cancel(); }
    catch(err){ /* no-op */ }
    bd.__accordionAnim=null;
  }
  bd.style.removeProperty('--card-ease');
  clearCardDuration(bd);
  setAnimating(card,false);
}
const MENU_TRANSITION_MS=260;
function setMenuTransitionDuration(menu){ if(menu) menu.style.setProperty('--menu-dur', MENU_TRANSITION_MS+'ms'); }
function clearMenuTransitionDuration(menu){ if(menu) menu.style.removeProperty('--menu-dur'); }
function isMenuOpen(menu){ return !!(menu && !menu.hidden && menu.dataset.menuState!=='closing'); }
function animateMenuOpen(menu){
  if(!menu) return;
  if(menu.dataset.menuState==='open') return;
  setMenuTransitionDuration(menu);
  menu.hidden=false;
  menu.setAttribute('aria-hidden','false');
  menu.dataset.menuState='opening';
  requestAnimationFrame(()=>{
    if(menu.dataset.menuState==='opening'){
      menu.dataset.menuState='open';
      setTimeout(()=>{ if(menu.dataset.menuState==='open'){ clearMenuTransitionDuration(menu); } }, MENU_TRANSITION_MS+80);
    }
  });
}
function animateMenuClose(menu,callback){
  if(!menu){
    if(typeof callback==='function') callback();
    return;
  }
  setMenuTransitionDuration(menu);
  const finalize=()=>{
    if(menu.dataset.menuState!=='closing') return;
    menu.hidden=true;
    delete menu.dataset.menuState;
    clearMenuTransitionDuration(menu);
    if(typeof callback==='function') callback();
  };
  menu.setAttribute('aria-hidden','true');
  if(menu.hidden){
    delete menu.dataset.menuState;
    clearMenuTransitionDuration(menu);
    if(typeof callback==='function') callback();
    return;
  }
  if(menu.dataset.menuState==='closing'){
    afterTransition(menu,'opacity',MENU_TRANSITION_MS+80,finalize);
    return;
  }
  menu.dataset.menuState='closing';
  afterTransition(menu,'opacity',MENU_TRANSITION_MS+80,finalize);
}
function notifyCardOpened(card){
  if(!card || suppressHistoryUpdates) return;
  const type=card.dataset?card.dataset.historyType:'';
  const id=card.dataset?card.dataset.historyId:'';
  if(type && id){
    if(type==='adventure'){
      const data=card.__dataRef||null;
      const charKey=normalizeHistoryCharKey((data&&data.__charKey)?data.__charKey:getActiveCharacterKey());
      if(charKey){
        recordEntryView({charKey,entryType:type,entryId:id});
      }
    }else if(type==='dm'){
      const charKey=normalizeHistoryCharKey(DM_LOG_KEY)||DM_LOG_KEY;
      recordEntryView({charKey,entryType:type,entryId:id});
    }else{
      recordCharacterView({});
    }
    return;
  }
  if(card.__dmEntry){
    recordCharacterView({charKey:DM_LOG_KEY});
  }else{
    recordCharacterView({});
  }
}

function notifyCardClosed(card){
  if(!card || suppressHistoryUpdates) return;
  const type=card.dataset?card.dataset.historyType:'';
  const id=card.dataset?String(card.dataset.historyId||''):'';
  if(!(type==='adventure'||type==='dm') || !id){
    return;
  }
  let charKey='';
  if(type==='adventure'){
    const data=card.__dataRef||null;
    const detected=(data&&data.__charKey)?data.__charKey:getActiveCharacterKey();
    charKey=normalizeHistoryCharKey(detected);
  }else if(type==='dm'){
    charKey=normalizeHistoryCharKey(DM_LOG_KEY)||DM_LOG_KEY;
  }
  if(!charKey) return;
  const stored=getLastEntryState(charKey);
  if(!stored) return;
  if(stored.entryType!==type || stored.entryId!==id){
    return;
  }
  rememberLastEntryState(charKey,{});
  recordCharacterView({charKey,replace:true,clearEntryState:true});
}
function expandCard(card){
  if(!card) return;
  const bd=card.querySelector('.card-bd');
  if(!bd) return;
  const wasOpen=card.classList.contains('open');
  if(isAnimating(card)) cancelCardAnimation(card);
  const start=Math.max(0,bd.offsetHeight||0);
  const target=Math.max(bd.scrollHeight,start);
  bd.style.setProperty('--card-ease', ACCORDION_EASE);
  bd.style.height=start+'px';
  bd.style.opacity='0';
  card.classList.add('open');
  if(!wasOpen){
    notifyCardOpened(card);
  }
  void bd.offsetHeight;
  const duration=setCardDuration(bd,target);
  setAnimating(card,true);
  const canAnimate=typeof bd.animate==='function';
  if(canAnimate){
    try{
      const animation=bd.animate([
        {height:start+'px',opacity:0},
        {height:target+'px',opacity:1}
      ],{duration,easing:ACCORDION_EASE,fill:'none'});
      bd.__accordionAnim=animation;
      animation.onfinish=()=>{
        if(bd.__accordionAnim!==animation) return;
        bd.__accordionAnim=null;
        bd.style.height='auto';
        bd.style.removeProperty('opacity');
        bd.style.removeProperty('--card-ease');
        clearCardDuration(bd);
        setAnimating(card,false);
      };
      animation.oncancel=()=>{
        if(bd.__accordionAnim===animation) bd.__accordionAnim=null;
      };
      return;
    }
    catch(err){ /* fall through to transition fallback */ }
  }
  requestAnimationFrame(()=>{
    bd.style.height=target+'px';
    bd.style.opacity='1';
    afterTransition(bd,'height',duration+100,()=>{
      bd.style.height='auto';
      bd.style.removeProperty('opacity');
      bd.style.removeProperty('--card-ease');
      clearCardDuration(bd);
      setAnimating(card,false);
    });
  });
}
function collapseCard(card){
  if(!card) return;
  const bd=card.querySelector('.card-bd');
  if(!bd) return;
  const wasOpen=card.classList.contains('open');
  if(wasOpen){
    notifyCardClosed(card);
  }
  if(isAnimating(card)) cancelCardAnimation(card);
  const start=Math.max(0,bd.offsetHeight||bd.scrollHeight||0);
  const duration=setCardDuration(bd,start);
  bd.style.setProperty('--card-ease', ACCORDION_EASE);
  bd.style.height=start+'px';
  bd.style.opacity='1';
  void bd.offsetHeight;
  setAnimating(card,true);
  const canAnimate=typeof bd.animate==='function';
  if(canAnimate){
    try{
      const animation=bd.animate([
        {height:start+'px',opacity:1},
        {height:'0px',opacity:0}
      ],{duration,easing:ACCORDION_EASE,fill:'none'});
      bd.__accordionAnim=animation;
      animation.onfinish=()=>{
        if(bd.__accordionAnim!==animation) return;
        bd.__accordionAnim=null;
        card.classList.remove('open');
        bd.style.removeProperty('height');
        bd.style.removeProperty('opacity');
        bd.style.removeProperty('--card-ease');
        clearCardDuration(bd);
        setAnimating(card,false);
      };
      animation.oncancel=()=>{
        if(bd.__accordionAnim===animation) bd.__accordionAnim=null;
      };
      return;
    }
    catch(err){ /* fall through to transition fallback */ }
  }
  requestAnimationFrame(()=>{
    bd.style.height='0px';
    bd.style.opacity='0';
  });
  afterTransition(bd,'height',duration+100,()=>{
    card.classList.remove('open');
    bd.style.removeProperty('height');
    bd.style.removeProperty('opacity');
    bd.style.removeProperty('--card-ease');
    clearCardDuration(bd);
    setAnimating(card,false);
  });
}
function toggleCard(card){ card.classList.contains('open')?collapseCard(card):expandCard(card); }

function focusCardElement(card,{expand=true}={}){
  if(!card) return;
  const shouldExpand=expand && !card.classList.contains('open');
  if(shouldExpand){
    expandCard(card);
  }
  if(!card.hasAttribute('tabindex')){
    card.setAttribute('tabindex','-1');
  }
  const applyFocus=()=>{
    try{ card.scrollIntoView({behavior:'smooth',block:'center'}); }
    catch(err){ try{ card.scrollIntoView({block:'center'}); }catch(_err){ /* no-op */ } }
    if(typeof card.focus==='function'){
      try{ card.focus({preventScroll:true}); }
      catch(err){ card.focus(); }
    }
    card.classList.remove('focus-glow');
    void card.offsetWidth;
    card.classList.add('focus-glow');
    setTimeout(()=>card.classList.remove('focus-glow'),1400);
  };
  const delay=shouldExpand?320:40;
  setTimeout(()=>{ requestAnimationFrame(applyFocus); }, delay);
}

function clearSearchForNavigation(){
  if(qEl && qEl.value){
    qEl.value='';
    updateSearchClearButton();
    return true;
  }
  return false;
}

function ensureActivitiesVisible(){
  if(showActivities) return false;
  showActivities=true;
  persistActivityVisibility();
  updateActivityToggle();
  return true;
}

function findCharacterCardFor(adv){
  if(!grid) return null;
  const cards=Array.from(grid.querySelectorAll('.card'));
  return cards.find(card=>card.__dataRef===adv) || null;
}

function findDmCardFor(entry){
  if(!grid) return null;
  const cards=Array.from(grid.querySelectorAll('.card'));
  return cards.find(card=>card.__dmEntry===entry) || null;
}

function navigateToCharacterReward(charKey, adv){
  const targetKey=normalizeHistoryCharKey(charKey);
  if(!targetKey || !adv || !charSel){
    return;
  }
  clearSearchForNavigation();
  ensureActivitiesVisible();
  if(charSel.value!==targetKey){
    charSel.value=targetKey;
  }
  filterAndRender();
  recordCharacterView({charKey:targetKey});
  requestAnimationFrame(()=>{
    const card=findCharacterCardFor(adv);
    if(card){
      focusCardElement(card,{expand:true});
    }
  });
}

function navigateToCharacter(charKey){
  const targetKey=normalizeHistoryCharKey(charKey);
  if(!targetKey || !charSel){
    return;
  }
  clearSearchForNavigation();
  if(charSel.value!==targetKey){
    charSel.value=targetKey;
  }
  filterAndRender();
  recordCharacterView({charKey:targetKey});
}

function navigateToDmAllocation(entry){
  if(!entry || !charSel){
    return;
  }
  clearSearchForNavigation();
  if(charSel.value!==DM_LOG_KEY){
    charSel.value=DM_LOG_KEY;
  }
  filterAndRender();
  recordCharacterView({charKey:DM_LOG_KEY});
  requestAnimationFrame(()=>{
    const card=findDmCardFor(entry);
    if(card){
      focusCardElement(card,{expand:true});
    }
  });
}

/* --- inventory helpers --- */
const REGEX_META_CHARS=/[\\^$.*+?()[\]{}|]/g;
function escapeRegexFragment(value){
  return String(value||'').replace(REGEX_META_CHARS,'\\$&');
}
function normItemName(s){ return (s||'').trim(); }
function parseLostItemList(raw){
  if(Array.isArray(raw)){
    return raw.map(normItemName).filter(Boolean);
  }
  const text=String(raw||'').replace(/\r\n?/g,'\n').trim();
  if(!text) return [];
  if(text.includes('\n')){
    return text.split('\n').map(normItemName).filter(Boolean);
  }
  if(text.includes(';')){
    return text.split(';').map(normItemName).filter(Boolean);
  }
  if(text.includes('')){
    return text.split('').map(normItemName).filter(Boolean);
  }
  return [normItemName(text)];
}
function parseAcquisitionName(s){ const t=String(s||'').trim(); const m=t.match(/^\((.*)\)$/); return m?{name:m[1].trim(),acquired:false}:{name:t,acquired:true}; }
function characterDisplayName(key){
  if(!key) return '';
  if(!DATA||!DATA.characters) return key;
  const obj=DATA.characters[key];
  if(!obj||typeof obj!=='object') return key;
  const display=typeof obj.display_name==='string'?obj.display_name.trim():'';
  if(display) return display;
  const sheet=typeof obj.sheet==='string'?obj.sheet.trim():'';
  if(sheet) return sheet;
  return key;
}
function sortCharacterAdventures(key){
  if(!DATA || !DATA.characters) return;
  const ch=DATA.characters[key];
  if(!ch || !Array.isArray(ch.adventures)) return;
  const decorated=ch.adventures.map((adv,idx)=>({adv,idx})).sort(compareChronoDesc);
  const reordered=decorated.map(item=>item.adv);
  const changed=reordered.length!==ch.adventures.length || reordered.some((adv,idx)=>adv!==ch.adventures[idx]);
  if(changed){
    ch.adventures=reordered;
  }
}
function collectPermanentInventory(charKey){
  const ch=DATA.characters[charKey]; if(!ch||!ch.adventures) return {kept:[], map:new Map()};
  const entries=ch.adventures.map((adv,idx)=>({adv,idx})).sort(compareChronoAsc);
  const keptMap=new Map();
  const removeByName=(name)=>{
    const cleaned=normItemName(name);
    if(!cleaned) return;
    keptMap.delete(cleaned.toLowerCase());
  };
  entries.forEach(({adv,idx})=>{
    ensureAdventureUid(adv);
    const items=adv.perm_items||[];
    const lostNames=parseLostItemList(adv.lost_perm_item);
    const tradeInfo=(adv.trade && typeof adv.trade==='object')?adv.trade:null;
    const tradedAway=[];
    if(tradeInfo){
      tradedAway.push(...parseLostItemList(tradeInfo.given));
    }else{
      tradedAway.push(...parseLostItemList(adv.traded_item));
      tradedAway.push(...parseLostItemList(adv.itemTraded));
    }
    const receivedList=tradeInfo
      ? parseLostItemList(tradeInfo.received)
      : parseLostItemList(adv.itemReceived);
    const handleAddition=(raw)=>{
      const {name,acquired}=parseAcquisitionName(raw);
      const cleaned=normItemName(name);
      if(!cleaned) return;
      const key=cleaned.toLowerCase();
      if(!acquired){
        keptMap.delete(key);
        return;
      }
      keptMap.set(key,{name:cleaned,index:idx,adv});
    };
    items.forEach(handleAddition);
    receivedList.forEach(handleAddition);
    lostNames.forEach(removeByName);
    tradedAway.forEach(removeByName);
  });
  const kept=[...keptMap.values()].sort((a,b)=>a.name.localeCompare(b.name));
  return {kept,map:keptMap};
}

const TRADE_LONG_PRESS_MS=600;
let activeTradeContext=null;

function resetTradeForm(){
  if(tradeReceiveInput) tradeReceiveInput.value='';
  if(tradeDateInput){
    tradeDateInput.value='';
    tradeDateInput.removeAttribute('max');
  }
  if(tradePartnerSelect) tradePartnerSelect.innerHTML='';
  if(tradePartnerCharacterInput) tradePartnerCharacterInput.value='';
  if(tradePartnerPlayerInput) tradePartnerPlayerInput.value='';
  if(tradePartnerCustom) tradePartnerCustom.hidden=true;
  if(tradeItemNameEl) tradeItemNameEl.textContent='';
  if(tradeMetaEl) tradeMetaEl.textContent='';
  if(tradeTitleEl) tradeTitleEl.textContent='Trade item';
  clearTradeError();
}

function clearTradeError(){
  if(!tradeErrorEl) return;
  tradeErrorEl.textContent='';
  tradeErrorEl.hidden=true;
}

function setTradeError(message){
  if(!tradeErrorEl) return;
  tradeErrorEl.textContent=message||'';
  tradeErrorEl.hidden=!message;
}

function populateTradePartnerOptions(sourceKey){
  if(!tradePartnerSelect) return;
  tradePartnerSelect.innerHTML='';
  const placeholder=document.createElement('option');
  placeholder.value='';
  placeholder.textContent='Select a character';
  placeholder.disabled=true;
  placeholder.selected=true;
  tradePartnerSelect.appendChild(placeholder);
  if(DATA && DATA.characters){
    const keys=Object.keys(DATA.characters).filter(key=>key!==sourceKey);
    keys.sort((a,b)=>characterDisplayName(a).localeCompare(characterDisplayName(b),undefined,{sensitivity:'base'}));
    keys.forEach(key=>{
      const opt=document.createElement('option');
      opt.value=`char:${key}`;
      opt.textContent=characterDisplayName(key);
      tradePartnerSelect.appendChild(opt);
    });
  }
  const otherOpt=document.createElement('option');
  otherOpt.value='custom';
  otherOpt.textContent='Other character';
  tradePartnerSelect.appendChild(otherOpt);
}

function syncTradePartnerFields(){
  if(!tradePartnerSelect||!tradePartnerCustom) return;
  const showCustom=tradePartnerSelect.value==='custom';
  tradePartnerCustom.hidden=!showCustom;
  if(!showCustom){
    if(tradePartnerCharacterInput) tradePartnerCharacterInput.value='';
    if(tradePartnerPlayerInput) tradePartnerPlayerInput.value='';
  }
}

function openTradeModal(context){
  if(!tradeModal||!context) return;
  const {charKey,itemName,itemCanonicalName,trigger}=context;
  if(!isValidSheetKey(charKey)) return;
  activeTradeContext={
    charKey,
    itemName:itemName||itemCanonicalName||'',
    itemCanonicalName:itemCanonicalName||itemName||'',
    trigger:trigger||null,
    wasEditing:invModal?invModal.classList.contains('editing'):false
  };
  if(tradeTitleEl) tradeTitleEl.textContent='Trade item';
  if(tradeMetaEl) tradeMetaEl.textContent=`${characterDisplayName(charKey)}  Permanent item trade`;
  if(tradeItemNameEl) tradeItemNameEl.textContent=activeTradeContext.itemName;
  if(tradeReceiveInput) tradeReceiveInput.value='';
  const today=new Date();
  const isoToday=today.toISOString().slice(0,10);
  if(tradeDateInput){
    tradeDateInput.value=isoToday;
    tradeDateInput.setAttribute('max',isoToday);
  }
  populateTradePartnerOptions(charKey);
  if(tradePartnerSelect){
    tradePartnerSelect.value='';
  }
  syncTradePartnerFields();
  clearTradeError();
  tradeModal.classList.add('open');
  refreshModalState();
  requestAnimationFrame(()=>{
    if(tradeReceiveInput){
      try{ tradeReceiveInput.focus({preventScroll:true}); }
      catch(err){ tradeReceiveInput.focus(); }
    }
  });
}

function closeTradeModal({restoreFocus=true}={}){
  if(!tradeModal) return;
  if(!tradeModal.classList.contains('open')) return;
  tradeModal.classList.remove('open');
  refreshModalState();
  const returnFocus=(restoreFocus && activeTradeContext && activeTradeContext.trigger)?activeTradeContext.trigger:null;
  resetTradeForm();
  const context=activeTradeContext;
  activeTradeContext=null;
  if(returnFocus && typeof returnFocus.focus==='function' && document.contains(returnFocus)){
    try{ returnFocus.focus({preventScroll:true}); }
    catch(err){ returnFocus.focus(); }
  }
  return context;
}

function removeInventoryLocalState(charKey,itemName){
  const cleaned=normItemName(itemName);
  if(!cleaned) return;
  const targetLower=cleaned.toLowerCase();
  const filterList=(list)=>{
    if(!Array.isArray(list)) return [];
    return list.map(name=>normItemName(name)).filter(name=>name && name.toLowerCase()!==targetLower);
  };
  const currentActive=loadActive(charKey)||[];
  const nextActive=filterList(currentActive);
  if(nextActive.length!==currentActive.length){
    saveActive(charKey,nextActive);
  }
  const currentAttuned=loadAttuned(charKey)||[];
  const nextAttuned=filterList(currentAttuned);
  if(nextAttuned.length!==currentAttuned.length){
    saveAttuned(charKey,nextAttuned);
  }
  const currentCommon=loadCommon(charKey)||[];
  const nextCommon=filterList(currentCommon);
  if(nextCommon.length!==currentCommon.length){
    saveCommon(charKey,nextCommon);
  }
}

function makeTradeEntry({charKey,date,itemTraded,itemReceived,partnerCharacter,partnerPlayer}){
  const traded=normItemName(itemTraded||'');
  const received=normItemName(itemReceived||'');
  const partnerChar=(partnerCharacter||'').trim();
  const partnerPlay=(partnerPlayer||'').trim();
  const entry={
    title:'Trade',
    date:date||new Date().toISOString().slice(0,10),
    code:'DT-TRADE',
    dm:'',
    gp_plus:0,
    gp_minus:0,
    gp_net:0,
    dtd_plus:0,
    dtd_minus:5,
    dtd_net:-5,
    level_plus:0,
    perm_items:received?[received]:[],
    lost_perm_item:[],
    consumable_items:[],
    story_awards:[],
    supernatural_gifts:[],
    notes:'',
    kind:'Downtime Activity',
    __charKey:charKey
  };
  const trade={};
  if(traded){ trade.given=traded; }
  if(received){ trade.received=received; }
  if(partnerChar){ trade.partnerCharacter=partnerChar; }
  if(partnerPlay){ trade.partnerPlayer=partnerPlay; }
  if(Object.keys(trade).length){ entry.trade=trade; }
  ensureAdventureUid(entry);
  return entry;
}

async function handleTradeSubmit(){
  if(!activeTradeContext) return;
  const charKey=activeTradeContext.charKey;
  if(!isValidSheetKey(charKey)){
    setTradeError('Select a valid character.');
    return;
  }
  const tradedName=activeTradeContext.itemCanonicalName||activeTradeContext.itemName||'';
  const receivedRaw=tradeReceiveInput?tradeReceiveInput.value:'';
  const receivedItem=normItemName(receivedRaw||'');
  const partnerValue=tradePartnerSelect?tradePartnerSelect.value:'';
  if(!partnerValue){
    setTradeError('Select a trade partner.');
    if(tradePartnerSelect){ tradePartnerSelect.focus(); }
    return;
  }
  let partnerKey=null;
  let partnerCharacter='';
  let partnerPlayer='';
  if(partnerValue.startsWith('char:')){
    partnerKey=partnerValue.slice(5);
    if(!partnerKey || partnerKey===charKey || !isValidSheetKey(partnerKey)){
      setTradeError('Select a different trade partner.');
      if(tradePartnerSelect){ tradePartnerSelect.focus(); }
      return;
    }
    partnerCharacter=characterDisplayName(partnerKey);
  }else if(partnerValue==='custom'){
    partnerCharacter=tradePartnerCharacterInput?tradePartnerCharacterInput.value.trim():'';
    partnerPlayer=tradePartnerPlayerInput?tradePartnerPlayerInput.value.trim():'';
    if(!partnerCharacter){
      setTradeError('Enter the partner character name.');
      if(tradePartnerCharacterInput){ tradePartnerCharacterInput.focus(); }
      return;
    }
  }else{
    setTradeError('Select a trade partner.');
    if(tradePartnerSelect){ tradePartnerSelect.focus(); }
    return;
  }
  let tradeDate=tradeDateInput?tradeDateInput.value:'';
  if(!tradeDate){
    tradeDate=new Date().toISOString().slice(0,10);
  }
  const tradeEntry=makeTradeEntry({
    charKey,
    date:tradeDate,
    itemTraded:tradedName,
    itemReceived:receivedItem,
    partnerCharacter,
    partnerPlayer
  });
  const charData=(DATA && DATA.characters && DATA.characters[charKey])||null;
  if(!charData){
    setTradeError('Character could not be found.');
    return;
  }
  if(!Array.isArray(charData.adventures)) charData.adventures=[];
  charData.adventures.push(tradeEntry);
  removeInventoryLocalState(charKey,tradedName);
  registerDerivedUpdate(charKey);

  let partnerContext=null;
  if(partnerKey){
    const partnerData=DATA.characters[partnerKey];
    if(partnerData){
      const partnerEntry=makeTradeEntry({
        charKey:partnerKey,
        date:tradeDate,
        itemTraded:receivedItem,
        itemReceived:tradedName,
        partnerCharacter:characterDisplayName(charKey),
        partnerPlayer:''
      });
      if(!Array.isArray(partnerData.adventures)) partnerData.adventures=[];
      partnerData.adventures.push(partnerEntry);
      removeInventoryLocalState(partnerKey,receivedItem);
      registerDerivedUpdate(partnerKey);
      partnerContext={partnerKey};
    }
  }

  markDirty();
  applyDataMutation(charKey);
  if(partnerContext && partnerContext.partnerKey){
    applyDataMutation(partnerContext.partnerKey);
  }
  const context=activeTradeContext;
  closeTradeModal({restoreFocus:false});
  if(context){
    openInventoryModal(context.charKey,{editing:context.wasEditing});
  }
  try{
    await saveDataJs();
  }catch(err){
    /* saveDataJs already surfaces feedback */
  }
}

function bindInventoryTradeInteraction(row,{charKey,itemName,itemCanonicalName}){
  if(!row) return;
  const openMenu=()=>{
    if(invModal && invModal.classList.contains('editing')) return;
    openTradeModal({
      charKey,
      itemName,
      itemCanonicalName,
      trigger:row
    });
  };
  row.addEventListener('contextmenu',(event)=>{
    event.preventDefault();
    openMenu();
  });
  let pressTimer=null;
  const clearTimer=()=>{
    if(pressTimer){
      clearTimeout(pressTimer);
      pressTimer=null;
    }
  };
  row.addEventListener('pointerdown',(event)=>{
    if(event.pointerType==='mouse' && event.button!==0) return;
    if(invModal && invModal.classList.contains('editing')) return;
    clearTimer();
    pressTimer=setTimeout(()=>{
      pressTimer=null;
      openMenu();
    },TRADE_LONG_PRESS_MS);
  });
  ['pointerup','pointerleave','pointercancel'].forEach(type=>{
    row.addEventListener(type,clearTimer);
  });
}

function giftsActiveKey(k){ return 'ACTIVE_GIFTS__'+k; }
function loadActiveSupernatural(k){
  try{
    const raw=JSON.parse(localStorage.getItem(giftsActiveKey(k))||'{}');
    if(raw&&typeof raw==='object'){
      const blessing=typeof raw.blessing==='string'?raw.blessing.trim():'';
      const boon=typeof raw.boon==='string'?raw.boon.trim():'';
      return {blessing,boon};
    }
  }catch(_){ /* ignore */ }
  return {blessing:'',boon:''};
}
function saveActiveSupernatural(k,state){
  const payload={};
  if(state&&typeof state==='object'){
    if(typeof state.blessing==='string'&&state.blessing.trim()) payload.blessing=state.blessing.trim();
    if(typeof state.boon==='string'&&state.boon.trim()) payload.boon=state.boon.trim();
  }
  const key=giftsActiveKey(k);
  if(Object.keys(payload).length){
    localStorage.setItem(key,JSON.stringify(payload));
  }else{
    localStorage.removeItem(key);
  }
}
function detectGiftType(name){
  const value=String(name||'');
  const lower=value.toLowerCase();
  if(lower.includes('resistance')) return 'resistance';
  if(lower.includes('boon')) return 'boon';
  if(lower.includes('blessing')) return 'blessing';
  return 'other';
}
function collectSupernaturalGifts(charKey){
  const ch=DATA.characters[charKey];
  if(!ch||!Array.isArray(ch.adventures)) return [];
  const giftsMap=new Map();
  const registerGift=(name,adv)=>{
    const cleaned=normalizeDisplayValue(name);
    if(!cleaned) return;
    const key=cleaned.toLowerCase();
    if(!giftsMap.has(key)){
      giftsMap.set(key,{name:cleaned,adv,type:detectGiftType(cleaned)});
    }
  };
  ch.adventures.forEach(adv=>{
    const list=Array.isArray(adv.supernatural_gifts)?adv.supernatural_gifts:[];
    list.forEach(item=>registerGift(item,adv));
  });
  const finalList=Array.isArray(ch.supernatural_gifts)?ch.supernatural_gifts:[];
  finalList.forEach(item=>registerGift(item,null));
  return [...giftsMap.values()].sort((a,b)=>a.name.localeCompare(b.name,undefined,{sensitivity:'base'}));
}
function currentLevelFor(charKey){
  const ch=DATA.characters[charKey]; const lvl=1+Math.floor((ch.adventures||[]).reduce((s,a)=>s+(+a.level_plus||0),0)); return Math.max(1,lvl);
}
function entryLevelAtStart(entry){
  if(!entry) return null;
  const stored=Number(entry.__levelAtStart);
  if(Number.isFinite(stored) && stored>0){
    return stored;
  }
  const key=entry.__charKey;
  if(typeof key==='string' && key && isValidSheetKey(key)){
    const fallback=currentLevelFor(key);
    if(Number.isFinite(fallback) && fallback>0){
      return fallback;
    }
  }
  return null;
}
function activeSlotsFor(level){ if(level<=4)return 1; if(level<=10)return 3; if(level<=16)return 6; return 10; }
function consumableCarrySlotsFor(level){ if(level<=4)return 5; if(level<=16)return 10; return 15; }
function consumableCarryKey(k){ return 'CARRIED_CONS__'+k; }
function loadCarriedConsumables(k){
  try{
    const raw=JSON.parse(localStorage.getItem(consumableCarryKey(k))||'[]');
    if(Array.isArray(raw)) return raw.map(item=>String(item||'').trim()).filter(Boolean);
  }catch(_){ /* ignore */ }
  return [];
}
function saveCarriedConsumables(k,list){
  localStorage.setItem(consumableCarryKey(k),JSON.stringify(Array.isArray(list)?list:[]));
}
function activeKey(k){ return 'ACTIVE_INV__'+k; }
function attuneKey(k){ return 'ATTUNED__'+k; }
function loadActive(k){ try{return JSON.parse(localStorage.getItem(activeKey(k))||'[]')}catch(_){return[]} }
function saveActive(k,a){ localStorage.setItem(activeKey(k),JSON.stringify(a||[])) }
function loadAttuned(k){ try{return JSON.parse(localStorage.getItem(attuneKey(k))||'[]')}catch(_){return[]} }
function saveAttuned(k,a){ localStorage.setItem(attuneKey(k),JSON.stringify(a||[])) }
function commonKey(k){ return 'COMMON_INV__'+k; }
function loadCommon(k){
  try{
    const raw=JSON.parse(localStorage.getItem(commonKey(k))||'[]');
    if(Array.isArray(raw)){
      const seen=new Set();
      const cleaned=[];
      raw.forEach(name=>{
        const cleanedName=normItemName(name);
        if(!cleanedName) return;
        const lower=cleanedName.toLowerCase();
        if(seen.has(lower)) return;
        seen.add(lower);
        cleaned.push(cleanedName);
      });
      return cleaned;
    }
  }catch(_){ /* ignore */ }
  return [];
}
function saveCommon(k,list){
  if(!Array.isArray(list)){
    localStorage.removeItem(commonKey(k));
    return;
  }
  const seen=new Set();
  const cleaned=[];
  list.forEach(name=>{
    const cleanedName=normItemName(name);
    if(!cleanedName) return;
    const lower=cleanedName.toLowerCase();
    if(seen.has(lower)) return;
    seen.add(lower);
    cleaned.push(cleanedName);
  });
  localStorage.setItem(commonKey(k),JSON.stringify(cleaned));
}

function parseConsumableName(s){ const t=String(s||'').trim(); const m=t.match(/^\((.*)\)$/); return m?{name:m[1].trim(),acquired:false}:{name:t,acquired:true}; }
function formatConsumableDisplay(raw){
  const original=String(raw||'').trim();
  if(!original) return {label:'',chips:[]};
  let working=original;
  const chips=[];
  const addChip=(chip)=>{ if(!chips.includes(chip)) chips.push(chip); };
  const stripOuterParens=(str)=>{
    let next=String(str||'').trim();
    while(next.startsWith('(') && next.endsWith(')')){
      const inner=next.slice(1,-1).trim();
      if(!inner) break;
      next=inner;
    }
    return next;
  };
  const stripLeadingSeparators=(str)=>String(str||'').replace(/^[\s,:;-]+/, '');

  const hasSpellScroll=/spell\s*scroll/i.test(working);
  if(hasSpellScroll){ addChip('Scroll'); }
  else if(/^scrolls?\b/i.test(working)){ addChip('Scroll'); }

  const potionPrefix=/^potion\b/i.test(working);
  if(potionPrefix) addChip('Potion');

  if(!/^spell\s*scrolls?\b/i.test(working)){
    let match;
    if((match=working.match(/^spell\s*\((.+)\)\s*$/i))){
      working=match[1];
    }else if((match=working.match(/^spell\s*(?:of\s+|[:-]\s*)(.+)$/i))){
      working=match[1];
    }else if(/^spell\b/i.test(working)){
      working=working.replace(/^spell\b/i,'');
      working=stripLeadingSeparators(working);
    }
  }

  if(/^spell\s*scrolls?\b/i.test(working)){
    working=working.replace(/^spell\s*scrolls?\b/i,'');
    working=stripLeadingSeparators(working);
    if(/^of\s+/i.test(working)) working=working.replace(/^of\s+/i,'');
    working=stripOuterParens(working);
  }else if(/^scrolls?\b/i.test(working)){
    working=working.replace(/^scrolls?\b/i,'');
    working=stripLeadingSeparators(working);
    if(/^of\s+/i.test(working)) working=working.replace(/^of\s+/i,'');
    working=stripOuterParens(working);
  }

  if(potionPrefix || /^potion\b/i.test(working)){
    working=working.replace(/^potion\b/i,'');
    working=stripLeadingSeparators(working);
    if(/^of\s+/i.test(working)) working=working.replace(/^of\s+/i,'');
    working=stripOuterParens(working);
  }

  working=stripOuterParens(working).trim();
  if(!working) working=original;
  return {label:working,chips};
}
function deriveConsumableInventory(charKey){
  const ch=DATA.characters[charKey]; if (!ch || !ch.adventures) return new Map();
  const sorted=ch.adventures.map((adv,idx)=>({adv,idx})).sort(compareChronoAsc);
  const counts=new Map();
  const add=(n,k=1)=>{ n=n.trim(); if(!n) return; counts.set(n,(counts.get(n)||0)+k); };
  const sub=(n,k=1)=>{ n=n.trim(); if(!n) return; const cur=(counts.get(n)||0)-k; counts.set(n,Math.max(0,cur)); if(counts.get(n)===0) counts.delete(n); };
  sorted.forEach(({adv})=>{
    const items=adv.consumable_items||[];
    items.forEach(raw=>{
      const {name,acquired}=parseConsumableName(raw);
      if(!name) return;
      if(acquired){
        add(name);
      }else{
        sub(name);
      }
    });
  });
  return counts;
}
function getConsumableUseMap(charKey){
  const ch=DATA.characters[charKey];
  const uses=new Map();
  const rawUses=ch&&typeof ch.consumable_uses==='object'&&ch.consumable_uses;
  if(!rawUses) return uses;
  Object.entries(rawUses).forEach(([name,val])=>{
    const count=Math.max(0,Number(val)||0);
    if(count>0) uses.set(name,count);
  });
  return uses;
}
function buildConsumableInventory(charKey){
  const base=deriveConsumableInventory(charKey);
  const ch=DATA.characters[charKey];
  const manual=(ch&&typeof ch.consumables==='object'&&ch.consumables)?ch.consumables:null;
  if(manual){
    Object.entries(manual).forEach(([name,val])=>{
      const num=Math.max(0,Number(val)||0);
      if(num>0) base.set(name,num);
      else base.delete(name);
    });
  }
  const uses=getConsumableUseMap(charKey);
  uses.forEach((used,name)=>{
    if(!base.has(name)) return;
    const remaining=Math.max(0,(base.get(name)||0)-used);
    if(remaining>0) base.set(name,remaining);
    else base.delete(name);
  });
  return base;
}
function incrementConsumableUse(charKey,name){
  const ch=DATA.characters[charKey];
  if(!ch) return false;
  const baseCount=(deriveConsumableInventory(charKey).get(name)||0);
  let total=baseCount;
  if(ch.consumables&&typeof ch.consumables==='object'&&Object.prototype.hasOwnProperty.call(ch.consumables,name)){
    const manualCount=Math.max(0,Number(ch.consumables[name])||0);
    total=manualCount;
  }
  if(total<=0) return false;
  const uses=getConsumableUseMap(charKey);
  const used=uses.get(name)||0;
  if(used>=total) return false;
  if(!ch.consumable_uses||typeof ch.consumable_uses!=='object') ch.consumable_uses={};
  const next=used+1;
  ch.consumable_uses[name]=next;
  if(ch.consumable_uses[name]<=0) delete ch.consumable_uses[name];
  if(ch.consumable_uses && !Object.keys(ch.consumable_uses).length) delete ch.consumable_uses;
  registerDerivedUpdate(charKey);
  markDirty();
  applyDataMutation(charKey);
  return true;
}

/* --- inventory modal UI --- */
const invModal=document.getElementById('invModal');
const invTitle=document.getElementById('invTitle');
const invMeta=document.getElementById('invMeta');
const invList=document.getElementById('invList');
const invSummary=document.getElementById('invSummary');
const consModal=document.getElementById('consModal');
const consTitle=document.getElementById('consTitle');
const consMeta=document.getElementById('consMeta');
const consList=document.getElementById('consList');
const consSummary=document.getElementById('consSummary');
const giftsModal=document.getElementById('giftsModal');
const giftsTitle=document.getElementById('giftsTitle');
const giftsMeta=document.getElementById('giftsMeta');
const giftsList=document.getElementById('giftsList');
const giftsSummary=document.getElementById('giftsSummary');
const tradeModal=document.getElementById('tradeModal');
const tradeForm=document.getElementById('tradeForm');
const tradeTitleEl=document.getElementById('tradeTitle');
const tradeMetaEl=document.getElementById('tradeMeta');
const tradeItemNameEl=document.getElementById('tradeItemName');
const tradeReceiveInput=document.getElementById('tradeReceiveInput');
const tradeDateInput=document.getElementById('tradeDateInput');
const tradePartnerSelect=document.getElementById('tradePartnerSelect');
const tradePartnerCustom=document.getElementById('tradePartnerCustom');
const tradePartnerCharacterInput=document.getElementById('tradePartnerCharacter');
const tradePartnerPlayerInput=document.getElementById('tradePartnerPlayer');
const tradeErrorEl=document.getElementById('tradeError');
const tradeCancelBtn=document.getElementById('tradeCancel');
const tradeSubmitBtn=document.getElementById('tradeSubmit');

if(tradePartnerSelect){
  tradePartnerSelect.addEventListener('change',syncTradePartnerFields);
}
if(tradeCancelBtn){
  tradeCancelBtn.addEventListener('click',()=>{ closeTradeModal(); });
}
if(tradeModal){
  tradeModal.addEventListener('click',(event)=>{
    if(event.target===tradeModal){
      closeTradeModal();
    }
  });
}
if(tradeForm){
  tradeForm.addEventListener('submit',async(event)=>{
    event.preventDefault();
    if(tradeSubmitBtn) tradeSubmitBtn.disabled=true;
    try{
      await handleTradeSubmit();
    }finally{
      if(tradeSubmitBtn) tradeSubmitBtn.disabled=false;
    }
  });
}
document.getElementById('invClose').addEventListener('click',()=>{ invModal.classList.remove('open','editing'); refreshModalState(); });
function closeConsumableModal(){
  consModal.classList.remove('open','editing');
  refreshModalState();
}
document.getElementById('consClose').addEventListener('click',closeConsumableModal);
invModal.addEventListener('click',(e)=>{ if(e.target===invModal){ invModal.classList.remove('open','editing'); refreshModalState(); } });
consModal.addEventListener('click',(e)=>{ if(e.target===consModal) closeConsumableModal(); });
document.getElementById('giftsClose').addEventListener('click',()=>{ giftsModal.classList.remove('open'); refreshModalState(); });
giftsModal.addEventListener('click',(e)=>{ if(e.target===giftsModal){ giftsModal.classList.remove('open'); refreshModalState(); } });

function openInventoryModal(charKey, opts={}){
  const ch=DATA.characters[charKey];
  if(invModal){
    invModal.dataset.charKey=charKey;
  }
  const level=currentLevelFor(charKey);
  const cap=activeSlotsFor(level);
  const {kept:keptMeta}=collectPermanentInventory(charKey);
  const metaByName=new Map(keptMeta.map(item=>[item.name.toLowerCase(),item]));
  const keptNames=keptMeta.map(item=>item.name);

  const rawCommon=loadCommon(charKey);
  const normalizedCommon=[];
  const commonSeen=new Set();
  rawCommon.forEach(name=>{
    const cleaned=normItemName(name);
    if(!cleaned) return;
    const lower=cleaned.toLowerCase();
    const meta=metaByName.get(lower);
    if(!meta) return;
    if(commonSeen.has(lower)) return;
    commonSeen.add(lower);
    normalizedCommon.push(meta.name);
  });
  const commonChanged=normalizedCommon.length!==rawCommon.length || normalizedCommon.some((name,idx)=>name!==rawCommon[idx]);
  if(commonChanged){
    saveCommon(charKey, normalizedCommon);
  }
  const commonList=normalizedCommon;
  const commonSet=new Set(commonList.map(name=>name.toLowerCase()));

  const rawActive=loadActive(charKey);
  const normalizedActive=[];
  const activeSeen=new Set();
  rawActive.forEach(name=>{
    const cleaned=normItemName(name);
    if(!cleaned) return;
    const lower=cleaned.toLowerCase();
    const meta=metaByName.get(lower);
    if(!meta) return;
    if(activeSeen.has(lower)) return;
    activeSeen.add(lower);
    normalizedActive.push(meta.name);
  });
  let active=[...normalizedActive];
  let activeChanged=normalizedActive.length!==rawActive.length || normalizedActive.some((name,idx)=>name!==rawActive[idx]);
  const nonCommonActiveCount=active.filter(name=>!commonSet.has(name.toLowerCase())).length;
  if(nonCommonActiveCount>cap){
    const trimmed=[];
    let used=0;
    active.forEach(name=>{
      const lower=name.toLowerCase();
      if(commonSet.has(lower)){
        trimmed.push(name);
      }else if(used<cap){
        trimmed.push(name);
        used++;
      }
    });
    if(trimmed.length!==active.length){
      active=trimmed;
      activeChanged=true;
    }
  }
  if(activeChanged){
    saveActive(charKey, active);
  }

  const activeSet=new Set(active.map(a=>a.toLowerCase()));

  const rawAttuned=loadAttuned(charKey);
  const normalizedAttuned=[];
  const attunedSeen=new Set();
  rawAttuned.forEach(name=>{
    const cleaned=normItemName(name);
    if(!cleaned) return;
    const lower=cleaned.toLowerCase();
    const meta=metaByName.get(lower);
    if(!meta) return;
    if(!activeSet.has(lower)) return;
    if(attunedSeen.has(lower)) return;
    attunedSeen.add(lower);
    normalizedAttuned.push(meta.name);
  });
  let attuned=normalizedAttuned.slice(0,3);
  const attunedChanged=normalizedAttuned.length!==rawAttuned.length || normalizedAttuned.some((name,idx)=>name!==rawAttuned[idx]) || attuned.length!==normalizedAttuned.length;
  if(attunedChanged){
    saveAttuned(charKey, attuned);
  }
  const attunedSet=new Set(attuned.map(a=>a.toLowerCase()));

  invTitle.textContent=(ch.display_name||ch.sheet||'Character')+'  Permanent Items';
  invMeta.textContent=`Level ${level}  Active slots: ${cap}  Attunement max: 3`;

  const activeOrdered=active
    .map(name=>metaByName.get(name.toLowerCase()))
    .filter(Boolean)
    .sort((a,b)=>{
      const aCommon=commonSet.has(a.name.toLowerCase());
      const bCommon=commonSet.has(b.name.toLowerCase());
      if(aCommon!==bCommon){
        return aCommon?1:-1;
      }
      return a.name.localeCompare(b.name,undefined,{sensitivity:'base'});
    });
  const rest=keptMeta
    .filter(item=>!activeSet.has(item.name.toLowerCase()))
    .sort((a,b)=>a.name.localeCompare(b.name,undefined,{sensitivity:'base'}));
  const ordered=activeOrdered.concat(rest);

  invList.innerHTML='';
  const actions=invModal.querySelector('.modal-actions');
  let editToggle=actions?actions.querySelector('.edit-toggle'):null;
  if(actions && !editToggle){
    editToggle=document.createElement('button');
    editToggle.type='button';
    editToggle.className='btn small edit-toggle';
    editToggle.textContent='Edit items';
    editToggle.setAttribute('aria-pressed','false');
    editToggle.style.marginRight='auto';
    actions.insertBefore(editToggle, actions.firstChild);
  }
  let editing=!!(opts && opts.editing);
  if(!ordered.length){ editing=false; }
  function syncEditing(){
    const activeEditing=editing && ordered.length>0;
    invModal.classList.toggle('editing', activeEditing);
    if(editToggle){
      editToggle.textContent=activeEditing?'Finish editing':'Edit items';
      editToggle.setAttribute('aria-pressed', activeEditing?'true':'false');
    }
  }
  if(editToggle){
    editToggle.onclick=()=>{
      if(!ordered.length) return;
      openInventoryModal(charKey,{editing:!editing});
    };
    editToggle.style.display=ordered.length?'':'none';
  }

  ordered.forEach(item=>{
    const label=item&&item.name?item.name:String(item||'');
    const lower=label.toLowerCase();
    const meta=metaByName.get(lower)||null;
    const isActive=activeSet.has(lower);
    const isCommon=commonSet.has(lower);
    const row=document.createElement('div');
    const rowClasses=['inv-row'];
    if(isActive) rowClasses.push('active');
    if(isCommon) rowClasses.push('common');
    row.className=rowClasses.join(' ');
    row.dataset.name=label;

    const nameDiv=document.createElement('div');
    nameDiv.className='inv-name';
    const labelSpan=document.createElement('span');
    labelSpan.className='inv-label';
    labelSpan.textContent=label;
    nameDiv.appendChild(labelSpan);

    const commonChip=document.createElement('button');
    commonChip.type='button';
    commonChip.className='common-chip'+(isCommon?' on':'');
    commonChip.innerHTML='<span aria-hidden="true">C</span><span class="sr-only">Common</span>';
    commonChip.setAttribute('aria-pressed', isCommon?'true':'false');
    commonChip.title=isCommon
      ?'Marked as common. Common items do not count against the active limit.'
      :'Mark this item as common so it does not count against the active limit.';
    commonChip.addEventListener('click',(ev)=>{
      ev.preventDefault();
      ev.stopPropagation();
      const stored=loadCommon(charKey);
      const normalized=[];
      const seen=new Set();
      stored.forEach(name=>{
        const cleaned=normItemName(name);
        if(!cleaned) return;
        const lc=cleaned.toLowerCase();
        const meta=metaByName.get(lc);
        if(!meta) return;
        if(seen.has(lc)) return;
        seen.add(lc);
        normalized.push(meta.name);
      });
      const exists=normalized.some(name=>name.toLowerCase()===lower);
      if(exists){
        const next=normalized.filter(name=>name.toLowerCase()!==lower);
        const nextSet=new Set(next.map(name=>name.toLowerCase()));
        if(isActive){
          const activeNames=loadActive(charKey)
            .map(normItemName)
            .filter(name=>name && metaByName.has(name.toLowerCase()))
            .map(name=>metaByName.get(name.toLowerCase()).name);
          const activeNonCommon=activeNames.filter(name=>!nextSet.has(name.toLowerCase())).length;
          if(activeNonCommon>cap){
            window.alert('Removing the Common tag would exceed your active item limit. Deactivate another item first.');
            return;
          }
        }
        saveCommon(charKey,next);
      }else{
        const next=normalized.concat([label]);
        saveCommon(charKey,next);
      }
      openInventoryModal(charKey,{editing});
    });
    nameDiv.appendChild(commonChip);

    const rightDiv=document.createElement('div');
    rightDiv.className='inv-tools';
    if(isActive){
      const pill=document.createElement('span');
      pill.className='attune-pill'+(attunedSet.has(lower)?' on':'');
      pill.textContent=attunedSet.has(lower)?'Attuned':'Attune';
      pill.title='Toggle attunement (max 3)';
      pill.addEventListener('click',(ev)=>{
        if(editing) return;
        ev.stopPropagation();
        let cur=loadAttuned(charKey)
          .map(normItemName)
          .filter(name=>name && metaByName.has(name.toLowerCase()))
          .map(name=>metaByName.get(name.toLowerCase()).name);
        const on=attunedSet.has(lower);
        if(!on){
          if(cur.length>=3){ alert('You can only be attuned to 3 items at a time.'); return; }
          cur.push(label);
        }else{
          cur=cur.filter(n=>n.toLowerCase()!==lower);
        }
        saveAttuned(charKey,cur);
        openInventoryModal(charKey,{editing});
      });
      rightDiv.appendChild(pill);
    }

    const deleteBtn=document.createElement('button');
    deleteBtn.type='button';
    deleteBtn.className='icon-btn danger delete-btn';
    deleteBtn.innerHTML=ICON_TRASH;
    deleteBtn.setAttribute('aria-label',`Remove ${label}`);
    deleteBtn.title='Remove this item';
    deleteBtn.addEventListener('click',async(ev)=>{
      ev.stopPropagation();
      if(!window.confirm(`Remove "${label}" from permanent items?`)) return;
      const adv=item&&item.adv;
      const originalPermItems=(adv&&Array.isArray(adv.perm_items))?adv.perm_items.slice():null;
      const activeBefore=loadActive(charKey);
      const attunedBefore=loadAttuned(charKey);
      const commonBefore=loadCommon(charKey);
      if(adv){
        const lowerName=lower;
        const source=Array.isArray(adv.perm_items)?adv.perm_items:[];
        adv.perm_items=source.filter(raw=>{
          const parsed=parseAcquisitionName(raw);
          const cleaned=normItemName(parsed.name).toLowerCase();
          return cleaned!==lowerName;
        });
      }
      const lc=lower;
      const nextActive=(Array.isArray(activeBefore)?activeBefore:[]).filter(n=>n.toLowerCase()!==lc);
      const nextAttuned=(Array.isArray(attunedBefore)?attunedBefore:[]).filter(n=>n.toLowerCase()!==lc);
      const nextCommon=(Array.isArray(commonBefore)?commonBefore:[]).filter(n=>n.toLowerCase()!==lc);
      saveActive(charKey,nextActive);
      saveAttuned(charKey,nextAttuned);
      saveCommon(charKey,nextCommon);
      registerDerivedUpdate(charKey);
      markDirty();
      applyDataMutation(charKey);
      openInventoryModal(charKey,{editing:true});
      try{
        await saveDataJs();
      }catch(err){
        if(adv){
          if(originalPermItems){
            adv.perm_items=originalPermItems;
          }else{
            delete adv.perm_items;
          }
        }
        saveActive(charKey,Array.isArray(activeBefore)?activeBefore:[]);
        saveAttuned(charKey,Array.isArray(attunedBefore)?attunedBefore:[]);
        saveCommon(charKey,Array.isArray(commonBefore)?commonBefore:[]);
        pendingDerivedUpdates.delete(charKey);
        applyDataMutation(charKey);
        openInventoryModal(charKey,{editing:true});
      }
    });
    rightDiv.appendChild(deleteBtn);

    row.appendChild(nameDiv);
    row.appendChild(rightDiv);

    row.addEventListener('click',()=>{
      if(editing) return;
      let cur=loadActive(charKey)
        .map(normItemName)
        .filter(name=>name && metaByName.has(name.toLowerCase()))
        .map(name=>metaByName.get(name.toLowerCase()).name);
      const on=cur.some(n=>n.toLowerCase()===lower);
      if(!on){
        const nonCommonCount=cur.filter(name=>!commonSet.has(name.toLowerCase())).length;
        if(!commonSet.has(lower) && nonCommonCount>=cap){
          alert(`You can only have ${cap} active item${cap>1?'s':''} at level ${level}.`);
          return;
        }
        cur.push(label);
      }else{
        cur=cur.filter(n=>n.toLowerCase()!==lower);
        saveAttuned(charKey, loadAttuned(charKey).filter(n=>n.toLowerCase()!==lower));
      }
      saveActive(charKey,cur);
      openInventoryModal(charKey,{editing});
    });

    bindInventoryTradeInteraction(row,{
      charKey,
      itemName:label,
      itemCanonicalName:meta?meta.name:label
    });

    invList.appendChild(row);
  });

  syncEditing();

  function updateSummary(){
    const storedActive=loadActive(charKey);
    const sanitizedActive=[];
    const activeLower=new Set();
    storedActive.forEach(name=>{
      const cleaned=normItemName(name);
      if(!cleaned) return;
      const lower=cleaned.toLowerCase();
      if(!metaByName.has(lower)) return;
      if(activeLower.has(lower)) return;
      activeLower.add(lower);
      sanitizedActive.push(metaByName.get(lower).name);
    });
    const nonCommonCount=sanitizedActive.filter(name=>!commonSet.has(name.toLowerCase())).length;
    const commonActiveCount=sanitizedActive.length-nonCommonCount;
    const storedAttuned=loadAttuned(charKey);
    const attunedActive=new Set();
    const attunedList=[];
    storedAttuned.forEach(name=>{
      const cleaned=normItemName(name);
      if(!cleaned) return;
      const lower=cleaned.toLowerCase();
      if(!metaByName.has(lower)) return;
      if(attunedActive.has(lower)) return;
      attunedActive.add(lower);
      attunedList.push(metaByName.get(lower).name);
    });
    const activeLowerSet=new Set(sanitizedActive.map(name=>name.toLowerCase()));
    const attunedCount=Math.min(3, attunedList.filter(name=>activeLowerSet.has(name.toLowerCase())).length);
    let summary=`Kept: ${keptMeta.length}  Active: ${nonCommonCount}/${cap}`;
    if(commonActiveCount>0){
      summary+=` (Common active: ${commonActiveCount})`;
    }
    summary+=`  Attuned: ${attunedCount}/3`;
    invSummary.textContent=summary;
  }
  updateSummary();
  invModal.classList.add('open');
  refreshModalState();
}


function openConsumableModal(charKey){
  const ch=DATA.characters[charKey];
  const level=currentLevelFor(charKey);
  const carryCap=consumableCarrySlotsFor(level);
  let baseCounts=deriveConsumableInventory(charKey);
  let counts=buildConsumableInventory(charKey);
  const reloadData=()=>{
    baseCounts=deriveConsumableInventory(charKey);
    counts=buildConsumableInventory(charKey);
  };
  const hasBaseInventory=()=>Array.from(baseCounts.values()).some(val=>val>0);

  consTitle.textContent=(ch.display_name||ch.sheet||'Character')+'  Consumables';
  consMeta.textContent=`Level ${level}  Carry limit: ${carryCap}`;
  consList.innerHTML='';

  let lastBaseSummary='';
  let summaryNote='';
  const applySummary=()=>{
    if(summaryNote){
      if(lastBaseSummary) consSummary.textContent=`${lastBaseSummary}  ${summaryNote}`;
      else consSummary.textContent=summaryNote;
    }else{
      consSummary.textContent=lastBaseSummary;
    }
  };
  const setSummaryNote=(msg)=>{
    summaryNote=msg||'';
    applySummary();
  };
  setSummaryNote('');

  const state={carriedList:[],carriedCounts:new Map()};
  const rawCarried=loadCarriedConsumables(charKey);
  rawCarried.forEach(item=>{
    const name=String(item||'').trim();
    if(name) state.carriedList.push(name);
  });

  const sanitizeCarried=()=>{
    const next=[];
    const usage=new Map();
    let changed=false;
    state.carriedList.forEach(name=>{
      if(!counts.has(name)){
        changed=true;
        return;
      }
      const total=counts.get(name)||0;
      const current=usage.get(name)||0;
      if(current>=total){
        changed=true;
        return;
      }
      usage.set(name,current+1);
      next.push(name);
    });
    if(changed || next.length!==state.carriedList.length){
      saveCarriedConsumables(charKey,next);
    }
    state.carriedList=next;
    state.carriedCounts=usage;
  };

  const totalCarried=()=>state.carriedList.length;
  const slotsFree=()=>Math.max(0,carryCap-totalCarried());
  const totalInventoryCopies=()=>Array.from(counts.values()).reduce((sum,val)=>sum+val,0);
  const totalStowedCopies=()=>Array.from(counts.entries()).reduce((sum,[name,total])=>{
    const carried=state.carriedCounts.get(name)||0;
    return sum+Math.max(0,total-carried);
  },0);

  const buildNameDiv=(name)=>{
    const nameDiv=document.createElement('div');
    nameDiv.className='inv-name consumable-name';
    const {label:displayLabel,chips}=formatConsumableDisplay(name);
    const primary=document.createElement('div');
    primary.className='cons-primary';
    const labelSpan=document.createElement('span');
    labelSpan.className='cons-name';
    labelSpan.textContent=displayLabel||name;
    primary.appendChild(labelSpan);
    if(Array.isArray(chips) && chips.length){
      const chipWrap=document.createElement('span');
      chipWrap.className='cons-chips';
      chips.forEach(chip=>{
        const chipEl=document.createElement('span');
        chipEl.className='cons-chip';
        const slug=chip.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
        if(slug){ chipEl.classList.add(`cons-chip--${slug}`); }
        chipEl.textContent=chip;
        chipWrap.appendChild(chipEl);
      });
      primary.appendChild(chipWrap);
    }
    nameDiv.appendChild(primary);
    return {element:nameDiv,label:labelSpan.textContent};
  };

  const createSection=(title)=>{
    const section=document.createElement('section');
    section.className='cons-section';
    const heading=document.createElement('div');
    heading.className='cons-section-title';
    heading.textContent=title;
    const list=document.createElement('div');
    list.className='cons-sublist';
    section.appendChild(heading);
    section.appendChild(list);
    return {section,list};
  };

  const addCarry=(name,{toFront=true}={})=>{
    const total=counts.get(name)||0;
    const carried=state.carriedCounts.get(name)||0;
    if(total<=carried) return false;
    if(totalCarried()>=carryCap){
      window.alert(`You can only carry ${carryCap} consumable${carryCap===1?'':'s'} at level ${level}.`);
      return false;
    }
    if(toFront) state.carriedList.unshift(name);
    else state.carriedList.push(name);
    saveCarriedConsumables(charKey,state.carriedList);
    setSummaryNote('');
    renderView();
    return true;
  };

  const removeCarry=(name)=>{
    const idx=state.carriedList.indexOf(name);
    if(idx===-1) return false;
    state.carriedList.splice(idx,1);
    saveCarriedConsumables(charKey,state.carriedList);
    setSummaryNote('');
    renderView();
    return true;
  };

  const renderView=()=>{
    reloadData();
    sanitizeCarried();
    consList.innerHTML='';

    if(!hasBaseInventory()){
      lastBaseSummary='No consumables tracked yet.';
      applySummary();
      const empty=document.createElement('div');
      empty.className='muted';
      empty.textContent='No consumables tracked yet.';
      consList.appendChild(empty);
      return;
    }

    const inventoryTotal=totalInventoryCopies();
    if(inventoryTotal<=0){
      lastBaseSummary='No consumables remaining.';
      applySummary();
      const empty=document.createElement('div');
      empty.className='muted';
      empty.textContent='All consumables have been used.';
      consList.appendChild(empty);
      return;
    }

    const carriedTotal=totalCarried();
    const free=slotsFree();
    const stowed=totalStowedCopies();
    const summaryParts=[`Carried: ${carriedTotal}/${carryCap}`];
    summaryParts.push(free>0?`${free} slot${free===1?'':'s'} free`:'Carry limit reached');
    summaryParts.push(`${inventoryTotal} total remaining`);
    if(stowed>0) summaryParts.push(`${stowed} stowed`);
    lastBaseSummary=summaryParts.join('  ');
    applySummary();

    const carriedSection=createSection('Carried');
    const carriedOrdered=[];
    const seen=new Set();
    state.carriedList.forEach(name=>{ if(!seen.has(name)){ seen.add(name); carriedOrdered.push(name); } });
    carriedOrdered.sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));
    if(carriedOrdered.length){
      carriedOrdered.forEach(name=>{
        const total=counts.get(name)||0;
        const carried=state.carriedCounts.get(name)||0;
        const remaining=Math.max(0,total-carried);
        const row=document.createElement('div');
        row.className='inv-row active';
        row.style.cursor='default';
        row.dataset.name=name;
        const {element:nameDiv,label:displayLabel}=buildNameDiv(name);
        const secondary=document.createElement('span');
        secondary.className='cons-secondary';
        secondary.textContent=`Carried ${carried} of ${total}`+(remaining>0?`  ${remaining} stowed`:'');
        nameDiv.appendChild(secondary);
        row.appendChild(nameDiv);

        const tools=document.createElement('div');
        tools.className='inv-tools';

        const qtyDiv=document.createElement('div');
        qtyDiv.className='qty';

        const minus=document.createElement('span');
        minus.className='qty-icon'+(carried<=0?' disabled':'');
        minus.innerHTML=ICON_MINUS;
        minus.setAttribute('role','button');
        minus.setAttribute('aria-label',`Stow one ${name}`);
        minus.tabIndex=0;
        minus.setAttribute('aria-disabled',carried<=0?'true':'false');

        const pill=document.createElement('span');
        pill.className='qty-pill';
        pill.textContent=String(carried);

        const plus=document.createElement('span');
        const canIncrease=remaining>0 && free>0;
        plus.className='qty-icon'+(canIncrease?'':' disabled');
        plus.innerHTML=ICON_PLUS;
        plus.setAttribute('role','button');
        plus.setAttribute('aria-label',`Carry one more ${name}`);
        plus.tabIndex=0;
        plus.setAttribute('aria-disabled',canIncrease?'false':'true');

        const handleAdjust=(delta)=>(ev)=>{
          if(ev.type==='keydown' && ev.key!=='Enter' && ev.key!==' ' && ev.key!=='Spacebar'){ return; }
          ev.preventDefault();
          ev.stopPropagation();
          if(delta<0){
            if(carried>0) removeCarry(name);
          }else{
            addCarry(name,{toFront:false});
          }
        };

        minus.addEventListener('click',handleAdjust(-1));
        minus.addEventListener('keydown',handleAdjust(-1));
        plus.addEventListener('click',handleAdjust(1));
        plus.addEventListener('keydown',handleAdjust(1));

        qtyDiv.appendChild(minus);
        qtyDiv.appendChild(pill);
        qtyDiv.appendChild(plus);
        tools.appendChild(qtyDiv);

        const useBtn=document.createElement('button');
        useBtn.type='button';
        useBtn.className='btn small danger cons-use-btn';
        useBtn.textContent='Use';
        useBtn.disabled=total<=0;
        const handleUse=async(ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          const usesBefore=getConsumableUseMap(charKey).get(name)||0;
          const success=incrementConsumableUse(charKey,name);
          if(!success){
            window.alert(`No ${displayLabel} remaining to use.`);
            return;
          }
          const idx=state.carriedList.indexOf(name);
          if(idx!==-1){
            state.carriedList.splice(idx,1);
            saveCarriedConsumables(charKey,state.carriedList);
          }
          setSummaryNote(`Used one ${displayLabel}.`);
          renderView();
          try{
            await saveDataJs();
          }catch(err){
            const ch=DATA.characters[charKey];
            if(ch && ch.consumable_uses && Object.prototype.hasOwnProperty.call(ch.consumable_uses,name)){
              if(usesBefore>0){
                ch.consumable_uses[name]=usesBefore;
              }else{
                delete ch.consumable_uses[name];
              }
              if(!Object.keys(ch.consumable_uses).length){
                delete ch.consumable_uses;
              }
            }
            pendingDerivedUpdates.delete(charKey);
            applyDataMutation(charKey);
            renderView();
          }
        };
        useBtn.addEventListener('click',handleUse);
        tools.appendChild(useBtn);

        row.appendChild(tools);
        carriedSection.list.appendChild(row);
      });
    }else{
      const empty=document.createElement('div');
      empty.className='muted';
      empty.style.padding='4px 8px';
      empty.textContent='Not carrying any consumables.';
      carriedSection.list.appendChild(empty);
    }
    consList.appendChild(carriedSection.section);

    const availableSection=createSection('Stowed');
    const availableNames=Array.from(counts.keys()).filter(name=>{
      const total=counts.get(name)||0;
      const carried=state.carriedCounts.get(name)||0;
      return total-carried>0;
    }).sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));
    if(availableNames.length){
      availableNames.forEach(name=>{
        const total=counts.get(name)||0;
        const carried=state.carriedCounts.get(name)||0;
        const remaining=Math.max(0,total-carried);
        const row=document.createElement('div');
        row.className='inv-row';
        row.setAttribute('role','button');
        row.tabIndex=0;
        row.title='Click to carry one copy';
        const {element:nameDiv}=buildNameDiv(name);
        const secondary=document.createElement('span');
        secondary.className='cons-secondary';
        secondary.textContent=`${remaining} available${total!==remaining?`  ${total} total`:''}`;
        nameDiv.appendChild(secondary);
        row.appendChild(nameDiv);

        const tools=document.createElement('div');
        tools.className='inv-tools';
        const qtyDiv=document.createElement('div');
        qtyDiv.className='qty';
        const pill=document.createElement('span');
        pill.className='qty-pill';
        pill.textContent=String(remaining);
        qtyDiv.appendChild(pill);
        tools.appendChild(qtyDiv);
        row.appendChild(tools);

        const activate=(ev)=>{
          if(ev.type==='keydown' && ev.key!=='Enter' && ev.key!==' ' && ev.key!=='Spacebar'){ return; }
          ev.preventDefault();
          ev.stopPropagation();
          addCarry(name,{toFront:true});
        };
        row.addEventListener('click',activate);
        row.addEventListener('keydown',activate);
        availableSection.list.appendChild(row);
      });
    }else{
      const empty=document.createElement('div');
      empty.className='muted';
      empty.style.padding='4px 8px';
      empty.textContent='No consumables stowed.';
      availableSection.list.appendChild(empty);
    }
    consList.appendChild(availableSection.section);
  };

  renderView();
  consModal.classList.add('open');
  refreshModalState();
}

function openSupernaturalModal(charKey){
  const ch=DATA.characters[charKey];
  if(!ch) return;
  const level=currentLevelFor(charKey);
  const gifts=collectSupernaturalGifts(charKey);
  const typeGroups={blessing:[],boon:[],resistance:[],other:[]};
  const nameMap=new Map();
  gifts.forEach(gift=>{
    const key=gift.name.toLowerCase();
    nameMap.set(key,gift);
    const bucket=typeGroups[gift.type]||typeGroups.other;
    bucket.push(gift);
  });
  const canonicalName=(value)=>{
    if(!value) return '';
    const lower=String(value).trim().toLowerCase();
    if(!lower) return '';
    const match=nameMap.get(lower);
    return match?match.name:'';
  };
  const storedSelections=loadActiveSupernatural(charKey);
  const state={
    blessing:canonicalName(storedSelections.blessing),
    boon:canonicalName(storedSelections.boon)
  };
  const canActivateBoon=level>=17;
  const persistState=()=>{
    saveActiveSupernatural(charKey,state);
  };
  const sanitizeState=()=>{
    let changed=false;
    if(state.blessing && !nameMap.has(state.blessing.toLowerCase())){
      state.blessing='';
      changed=true;
    }
    if(state.boon && !nameMap.has(state.boon.toLowerCase())){
      state.boon='';
      changed=true;
    }
    if(changed) persistState();
  };
  sanitizeState();
  giftsTitle.textContent=(ch.display_name||ch.sheet||'Character')+'  Supernatural Gifts';
  giftsMeta.textContent=`Level ${fmtNumber(level)}`;

  const buildGiftRow=(gift,options={})=>{
    const {
      type='',
      isActive=false,
      showActivate=false,
      onActivate=null,
      onClear=null,
      canActivate=true,
      note=''
    }=options;
    const row=document.createElement('div');
    row.className='inv-row';
    const canToggle=showActivate && (canActivate || isActive);
    if(!canToggle){
      row.classList.add('static');
    }else{
      row.setAttribute('role','button');
      row.tabIndex=0;
      row.setAttribute('aria-pressed',isActive?'true':'false');
    }
    if(isActive){
      row.classList.add('active');
      if(type==='blessing'||type==='boon'||type==='resistance'){
        row.classList.add(`active--${type}`);
      }
    }
    const nameDiv=document.createElement('div');
    nameDiv.className='inv-name';
    const labelSpan=document.createElement('span');
    labelSpan.className='inv-label';
    labelSpan.textContent=gift.name;
    nameDiv.appendChild(labelSpan);
    row.appendChild(nameDiv);
    const tools=document.createElement('div');
    tools.className='inv-tools';
    let hasTools=false;
    if(note){
      const noteSpan=document.createElement('span');
      noteSpan.className='gift-note';
      noteSpan.textContent=note;
      tools.appendChild(noteSpan);
      hasTools=true;
    }
    if(gift.adv){
      const linkBtn=document.createElement('button');
      linkBtn.type='button';
      linkBtn.className='icon-btn';
      linkBtn.setAttribute('aria-label','View entry');
      linkBtn.title='View entry';
      const icon=document.createElementNS('http://www.w3.org/2000/svg','svg');
      icon.setAttribute('viewBox','0 0 24 24');
      icon.setAttribute('width','20');
      icon.setAttribute('height','20');
      icon.setAttribute('fill','none');
      icon.setAttribute('stroke','currentColor');
      icon.setAttribute('stroke-width','2');
      icon.setAttribute('stroke-linecap','round');
      icon.setAttribute('stroke-linejoin','round');
      icon.setAttribute('aria-hidden','true');
      const path=document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d','M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z');
      icon.appendChild(path);
      linkBtn.appendChild(icon);
      linkBtn.addEventListener('click',(ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        giftsModal.classList.remove('open');
        refreshModalState();
        navigateToCharacterReward(charKey,gift.adv);
      });
      tools.appendChild(linkBtn);
      hasTools=true;
    }
    if(hasTools){
      row.appendChild(tools);
    }
    if(canToggle){
      const triggerToggle=()=>{
        if(isActive){
          if(typeof onClear==='function'){
            onClear();
          }
          return;
        }
        if(canActivate && typeof onActivate==='function'){
          onActivate();
        }
      };
      row.addEventListener('click',(ev)=>{
        ev.preventDefault();
        triggerToggle();
      });
      row.addEventListener('keydown',(ev)=>{
        if(ev.key==='Enter'||ev.key===' '||ev.key==='Spacebar'){
          ev.preventDefault();
          triggerToggle();
        }
      });
    }
    return row;
  };

  const persistAndRender=()=>{
    persistState();
    render();
  };
  const setActiveBlessing=(name)=>{
    const next=String(name||'').trim();
    if(next===state.blessing) return;
    state.blessing=next;
    persistAndRender();
  };
  const setActiveBoon=(name)=>{
    if(!canActivateBoon) return;
    const next=String(name||'').trim();
    if(next===state.boon) return;
    state.boon=next;
    persistAndRender();
  };

  const render=()=>{
    giftsList.innerHTML='';
    const blessingKey=state.blessing?state.blessing.toLowerCase():'';
    const boonKey=state.boon?state.boon.toLowerCase():'';
    const activeEntries=[];
    if(blessingKey && nameMap.has(blessingKey)){
      activeEntries.push(nameMap.get(blessingKey));
    }
    if(canActivateBoon && boonKey && nameMap.has(boonKey)){
      activeEntries.push(nameMap.get(boonKey));
    }
    typeGroups.resistance.forEach(gift=>{
      activeEntries.push(gift);
    });

    const noteFragment=document.createDocumentFragment();
    const addNote=(text)=>{
      if(!text) return;
      const note=document.createElement('div');
      note.className='gifts-list-note';
      note.textContent=text;
      noteFragment.appendChild(note);
    };

    if(!activeEntries.length){
      addNote('No active supernatural gifts yet.');
    }
    if(!state.blessing && typeGroups.blessing.length){
      addNote('No blessing selected. Choose one below to set it active.');
    }
    if(typeGroups.boon.length){
      if(canActivateBoon){
        if(!state.boon){
          addNote('No boon selected. Choose one below to set it active.');
        }
      }else{
        addNote('Boons unlock at level 17.');
      }
    }

    if(noteFragment.childNodes.length){
      giftsList.appendChild(noteFragment);
    }

    if(gifts.length){
      const list=document.createElement('div');
      list.className='gifts-sublist';
      giftsList.appendChild(list);

      const appendGift=(gift,type,options={})=>{
        list.appendChild(buildGiftRow(gift,{type,...options}));
      };

      typeGroups.blessing.forEach(gift=>{
        const lower=gift.name.toLowerCase();
        const isActive=lower===blessingKey;
        appendGift(gift,'blessing',{
          isActive,
          showActivate:true,
          onActivate:()=>setActiveBlessing(gift.name),
          onClear:()=>setActiveBlessing('')
        });
      });

      typeGroups.boon.forEach(gift=>{
        const lower=gift.name.toLowerCase();
        const isActive=canActivateBoon && lower===boonKey;
        appendGift(gift,'boon',{
          isActive,
          showActivate:true,
          onActivate:()=>setActiveBoon(gift.name),
          onClear:()=>setActiveBoon(''),
          canActivate:canActivateBoon,
          note:!canActivateBoon?'Unlocks at level 17':''
        });
      });

      typeGroups.resistance.forEach(gift=>{
        appendGift(gift,'resistance',{
          isActive:true,
          note:'Always active'
        });
      });

      typeGroups.other.forEach(gift=>{
        appendGift(gift,'',{
          isActive:false
        });
      });
    }else{
      const empty=document.createElement('div');
      empty.className='gifts-list-note';
      empty.textContent='No supernatural gifts recorded.';
      giftsList.appendChild(empty);
    }

    const summaryParts=[`Total gifts: ${fmtNumber(gifts.length)}`];
    summaryParts.push(`Blessings active: ${state.blessing? '1':'0'}/1`);
    const boonCount=typeGroups.boon.length;
    if(boonCount){
      if(canActivateBoon){
        summaryParts.push(`Boons active: ${state.boon? '1':'0'}/1`);
      }else{
        summaryParts.push(`Boons: ${fmtNumber(boonCount)} (unlock at level 17)`);
      }
    }
    summaryParts.push(`Resistances: ${fmtNumber(typeGroups.resistance.length)} (always active)`);
    if(typeGroups.other.length){
      summaryParts.push(`Other gifts: ${fmtNumber(typeGroups.other.length)}`);
    }
    giftsSummary.textContent=summaryParts.join('  ');
  };

  render();
  giftsModal.classList.add('open');
  refreshModalState();
}

/* --- cards --- */
function makeCard(a,idx){
  const act=isActivityEntry(a); const {gp,dtd}=netVals(a);
  const card=document.createElement('article'); card.className='card'+(act?' activity':''); card.dataset.idx=String(idx);
  card.__dataRef=a;
  const historyId=getAdventureHistoryId(a,a&&a.__charKey?a.__charKey:null);
  if(historyId){
    card.dataset.historyId=historyId;
    card.dataset.historyType='adventure';
  }
  const lockedKind=(a && a.__lockedKind)?String(a.__lockedKind):'';
  const hasLockedKind=!!lockedKind;
  const dmLinkMeta=(DM_REWARD_LINKS && DM_REWARD_LINKS.get(a))||null;

  const hd=document.createElement('div'); hd.className='card-hd';
  const main=document.createElement('div'); main.className='log-row';
  const info=document.createElement('div'); info.className='log-row-info';
  const tagRow=document.createElement('div'); tagRow.className='log-row-tags';
  const chipsRow=document.createElement('div'); chipsRow.className='log-row-chips';
  chipTickerRegistry.register(chipsRow);
  chipsRow.appendChild(tagRow);
  let titleEditorSlot=null, titleDisplayEl=null;
  let dateEditorSlot=null, dateDisplayEl=null;
  let codeEditorSlot=null, codeDisplayEl=null;
  let codeFieldView=null;
  let metaDisplayEl=null;
  let levelTag=null;
  let characterChip=null;
  const syncCharacterChipPosition=()=>{
    if(!characterChip) return;
    const firstChild=tagRow.firstChild;
    if(firstChild!==characterChip){
      tagRow.insertBefore(characterChip, firstChild);
    }
  };
  let downtimeTag=null;

  const dateSpan=document.createElement('span'); dateSpan.className='log-row-date editable-inline';
  const dateDisplay=document.createElement('span'); dateDisplay.className='display'; dateDisplay.textContent=fmtDate(a.date);
  const dateEditor=document.createElement('span'); dateEditor.className='editor';
  dateSpan.append(dateDisplay,dateEditor); dateSpan.__display=dateDisplay; dateSpan.__editor=dateEditor;
  dateEditorSlot=dateEditor; dateDisplayEl=dateDisplay;

  const nameSpan=document.createElement('span'); nameSpan.className='log-row-title editable-inline '+(act?'is-activity':'is-adventure');
  const nameDisplay=document.createElement('span'); nameDisplay.className='display';
  const fullTitle=sanitizeTitle((a.title&&a.title.trim())||(act?'Activity':'Untitled Adventure'));
  nameDisplay.textContent=fullTitle;
  const nameEditor=document.createElement('span'); nameEditor.className='editor';
  nameSpan.append(nameDisplay,nameEditor); nameSpan.__display=nameDisplay; nameSpan.__editor=nameEditor;
  titleEditorSlot=nameEditor; titleDisplayEl=nameDisplay;

  const buildHeaderMeta=(entry)=>{
    if(!entry) return '';
    const parts=[];
    const codeText=normalizeDisplayValue(entry.code);
    if(codeText) parts.push(`${codeText}`);
    const dmText=normalizeDisplayValue(entry.dm);
    if(dmText) parts.push(`DM: ${dmText}`);
    return parts.join('    ');
  };

  const headerMain=document.createElement('div'); headerMain.className='log-row-main';
  headerMain.appendChild(nameSpan);

  const dateStatsRow=document.createElement('div'); dateStatsRow.className='log-row-datestats';
  dateStatsRow.appendChild(dateSpan);

  const stats=document.createElement('div'); stats.className='log-row-stats';
  const totalsPill=document.createElement('div'); totalsPill.className='totals-pill';
  const totalsValues=document.createElement('span'); totalsValues.className='totals-pill-values';
  const totalsGp=document.createElement('span'); totalsGp.className='totals-pill-value neutral';
  const totalsDt=document.createElement('span'); totalsDt.className='totals-pill-value neutral';
  totalsValues.append(totalsGp,totalsDt);
  totalsPill.append(totalsValues);
  stats.appendChild(totalsPill);
  dateStatsRow.appendChild(stats);
  headerMain.appendChild(dateStatsRow);

  info.appendChild(headerMain);

  const refreshChipsRow=()=>{
    const hasTags=tagRow.childElementCount>0;
    const statsInChips=(stats.parentNode===chipsRow && stats.style.display!=='none');
    chipsRow.style.display=(hasTags||statsInChips)?'flex':'none';
    chipTickerRegistry.refresh(chipsRow);
    tickerRowRegistry.schedule();
  };

  const mobileChipsQuery=(typeof window!=='undefined' && typeof window.matchMedia==='function')
    ? window.matchMedia('(max-width: 520px)')
    : null;
  const syncStatsPlacement=()=>{
    if(mobileChipsQuery && mobileChipsQuery.matches){
      if(stats.parentNode!==chipsRow){
        stats.classList.add('log-row-stats--mobile');
        chipsRow.appendChild(stats);
      }
    }else{
      if(stats.parentNode!==dateStatsRow){
        stats.classList.remove('log-row-stats--mobile');
        dateStatsRow.appendChild(stats);
      }
    }
    refreshChipsRow();
  };
  syncStatsPlacement();
  if(mobileChipsQuery){
    if(typeof mobileChipsQuery.addEventListener==='function'){
      mobileChipsQuery.addEventListener('change', syncStatsPlacement);
    }else if(typeof mobileChipsQuery.addListener==='function'){
      mobileChipsQuery.addListener(syncStatsPlacement);
    }
  }

  const metaSpan=document.createElement('div');
  metaSpan.className='log-row-meta';
  const metaText=document.createElement('span');
  metaText.className='log-row-meta-text';
  metaSpan.appendChild(metaText);
  metaSpan.__display=metaText;
  bindScrollableObserver(metaSpan);
  metaDisplayEl=metaText;

  if(searchAllCharacters){
    const charKey=typeof a.__charKey==='string'?a.__charKey:String(a.__charKey||'');
    const charName=charKey?getCharacterDisplayName(charKey):'';
    if(charKey && charName){
      const characterLink=document.createElement('a');
      characterLink.href='#';
      characterLink.className='log-row-character-chip';
      characterLink.textContent=charName;
      const linkLabel=`View ${charName}'s log`;
      characterLink.title=linkLabel;
      characterLink.setAttribute('aria-label',linkLabel);
      characterLink.addEventListener('click',(ev)=>{
        ev.preventDefault();
        if(searchAllCharacters){
          searchAllCharacters=false;
          persistSearchScope();
          updateSearchScopeToggle();
        }
        navigateToCharacterReward(charKey,a);
      });
      characterChip=characterLink;
      syncCharacterChipPosition();
      refreshChipsRow();
    }
  }

  info.appendChild(metaSpan);
  info.appendChild(chipsRow);
  main.appendChild(info);

  metaDisplayEl.textContent=buildHeaderMeta(a);
  refreshScrollableWrapper(metaSpan);

  const ensureTag=(label,className)=>{
    const tag=document.createElement('span');
    tag.className=`tag ${className}`.trim();
    tag.textContent=label;
    tagRow.appendChild(tag);
    refreshChipsRow();
    return tag;
  };

  const applyActivityBadge=(isActivity)=>{
    if(isActivity){
      if(!downtimeTag){
        downtimeTag=ensureTag('Downtime','tag-downtime');
      }
    }else if(downtimeTag){
      downtimeTag.remove();
      downtimeTag=null;
      refreshChipsRow();
    }
  };

  applyActivityBadge(act);
  const formatSignedValue=(value)=>{
    const num=Number(value||0);
    if(!Number.isFinite(num) || num===0) return '0';
    const abs=fmtNumber(Math.abs(num));
    return num>0?`+${abs}`:`-${abs}`;
  };

  const applyTotalsState=(el,label,value,editing=false)=>{
    if(!el) return false;
    const num=Number(value||0);
    el.classList.remove('gain','loss','neutral');
    if(num>0){
      el.classList.add('gain');
    }else if(num<0){
      el.classList.add('loss');
    }else{
      el.classList.add('neutral');
    }
    el.textContent=`${label} ${formatSignedValue(num)}`;
    const shouldShow=editing || num!==0;
    el.style.display=shouldShow?'inline-flex':'none';
    return shouldShow;
  };

  const updateTotals=(gpValue,dtValue,editing=false)=>{
    const showGp=applyTotalsState(totalsGp,'GP',gpValue,editing);
    const showDt=applyTotalsState(totalsDt,'DT',dtValue,editing);
    const showPill=showGp||showDt;
    totalsPill.style.display=showPill?'inline-flex':'none';
    stats.style.display=showPill?'flex':'none';
    refreshChipsRow();
  };
  totalsPill.style.display='none';
  stats.style.display='none';
  refreshChipsRow();
  totalsGp.style.display='none';
  totalsDt.style.display='none';

  const updateLevelSummary=(startVal,gainVal,editing=false)=>{
    const startNum=Number(startVal);
    const gainNum=Number(gainVal||0);
    const hasStart=Number.isFinite(startNum) && startNum>0;
    const shouldShow=hasStart || gainNum!==0;
    if(!shouldShow){
      if(levelTag){
        levelTag.remove();
        levelTag=null;
      }
      syncCharacterChipPosition();
      refreshChipsRow();
      return;
    }
    if(!levelTag){
      levelTag=ensureTag('', 'tag-level');
    }
    if(hasStart && gainNum>0){
      const finalLevel=startNum+gainNum;
      levelTag.textContent=`Level ${fmtNumber(startNum)}  ${fmtNumber(finalLevel)}`;
    }else if(hasStart){
      levelTag.textContent=`Level ${fmtNumber(startNum)}`;
    }else if(gainNum!==0){
      const prefix=gainNum>0?'+':'';
      levelTag.textContent=`Levels ${prefix}${fmtNumber(Math.abs(gainNum))}`;
    }
    syncCharacterChipPosition();
  };

  const levelStart=entryLevelAtStart(a);
  updateLevelSummary(levelStart,a.level_plus);

  if(!act){
    const netGP=(a.gp_net==null?gp:a.gp_net);
    const netDTD=(a.dtd_net==null?dtd:a.dtd_net);
    updateTotals(netGP,netDTD,false);
  }else{
    updateTotals(gp,dtd,false);
  }

  nameDisplay.textContent=fullTitle;
  nameDisplay.removeAttribute('title');
  hd.appendChild(main);

  bindScrollableObserver(nameSpan);
  bindScrollableObserver(dateSpan);
  requestAnimationFrame(()=>{
    refreshScrollableWrapper(nameSpan);
    refreshScrollableWrapper(dateSpan);
    refreshScrollableWrapper(metaSpan);
  });

  setupTickerRow(headerMain,nameSpan,dateStatsRow,{
    onToggle:()=>{
      if(nameSpan && typeof nameSpan.__refreshScroll==='function'){
        nameSpan.__refreshScroll();
      }
      if(dateSpan && typeof dateSpan.__refreshScroll==='function'){
        dateSpan.__refreshScroll();
      }
    }
  });

  hd.addEventListener('click',(ev)=>{ if(card.classList.contains('editing')) return; toggleCard(card); });

  const bd=document.createElement('div'); bd.className='card-bd';
  const cardActions=document.createElement('div'); cardActions.className='card-actions';
  const editBtn=document.createElement('button');
  editBtn.type='button';
  editBtn.className='btn card-edit-btn';
  editBtn.setAttribute('aria-label','Toggle edit mode');
  editBtn.setAttribute('aria-pressed','false');
  editBtn.textContent='Edit';
  editBtn.title='Edit entry';
  editBtn.addEventListener('click',(ev)=>{
    ev.stopPropagation();
    if(card.classList.contains('editing')){
      exitEditMode(card);
    }else{
      enterEditMode(card);
    }
  });
  cardActions.appendChild(editBtn);
  const view=document.createElement('div'); view.className='bd-in';
  view.innerHTML='';

  const createSection=(title,options={})=>{
    const {collapsible=false,startOpen=false}=options;
    const section=document.createElement('section');
    section.className='card-section'+(collapsible?' card-section--collapsible':'');
    const header=document.createElement('div'); header.className='card-section-header';
    let toggle=null;
    if(collapsible){
      toggle=document.createElement('button');
      toggle.type='button';
      toggle.className='card-section-toggle';
      toggle.textContent=title||'Section';
      toggle.setAttribute('aria-expanded',startOpen?'true':'false');
      header.appendChild(toggle);
      section.appendChild(header);
    }else if(title){
      const heading=document.createElement('h3');
      heading.className='card-section-title';
      heading.textContent=title;
      header.appendChild(heading);
      section.appendChild(header);
    }
    const content=document.createElement('div');
    content.className='card-section-content card-section-content--grid';
    section.appendChild(content);
    if(collapsible && startOpen){
      section.classList.add('open');
    }
    view.appendChild(section);
    const setOpen=(next)=>{
      if(!collapsible) return;
      const open=!!next;
      section.classList.toggle('open',open);
      if(toggle){ toggle.setAttribute('aria-expanded',open?'true':'false'); }
    };
    if(collapsible && toggle){
      toggle.addEventListener('click',()=>{
        const open=section.classList.contains('open');
        setOpen(!open);
      });
    }
    return {section, content, setOpen:collapsible?setOpen:()=>{}, toggle};
  };

  if(dmLinkMeta && dmLinkMeta.entry){
    const linkRow=document.createElement('div');
    linkRow.className='card-link-chip-row';
    const linkChip=document.createElement('button');
    linkChip.type='button';
    linkChip.className='pill pill-link card-link-chip';
    const label='View linked DM log allocation';
    linkChip.textContent=label;
    linkChip.title=label;
    linkChip.setAttribute('aria-label',label);
    linkChip.addEventListener('click',(ev)=>{
      ev.stopPropagation();
      ev.preventDefault();
      navigateToDmAllocation(dmLinkMeta.entry);
    });
    linkRow.appendChild(linkChip);
    view.appendChild(linkRow);
  }

  const overviewContent=document.createElement('div');
  overviewContent.className='card-overview card-section-content card-section-content--grid';
  overviewContent.style.display='none';
  view.appendChild(overviewContent);
  const rewardsSection=createSection('Rewards & Progress');
  const rewardsContent=rewardsSection.content;
  const inventorySectionLabel='Magic & Consumables';
  const inventorySection=createSection(inventorySectionLabel,{collapsible:true,startOpen:false});
  const inventoryContent=inventorySection.content;
  const notesSectionLabel='Notes';
  const notesSection=createSection(notesSectionLabel,{collapsible:true,startOpen:false});
  const notesContent=notesSection.content;

  function makeValue(val, empty=''){
    const text=normalizeDisplayValue(val);
    return text?text:empty;
  }

  function makeKVS(label,value){
    const cell=document.createElement('div');
    cell.className='kvsingle';
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v';
    const display=document.createElement('div'); display.className='display';
    setElementTextWithCharacterChips(display, value, {label});
    const editor=document.createElement('div'); editor.className='editor';
    v.appendChild(display); v.appendChild(editor);
    cell.appendChild(k); cell.appendChild(v);
    cell.__display=display;
    cell.__editor=editor;
    cell.__setDisplayValue=(nextValue)=>{
      setElementTextWithCharacterChips(display, nextValue, {label});
    };
    return cell;
  }

  function appendField(label, content, extraClass, target){
    const field=document.createElement('div');
    field.className='field'+(extraClass?(' '+extraClass):'');
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v';
    const display=document.createElement('div'); display.className='display';
    if(content instanceof Node){ display.appendChild(content); }
    else{ setElementTextWithCharacterChips(display, makeValue(content), {label}); }
    const editor=document.createElement('div'); editor.className='editor';
    v.appendChild(display); v.appendChild(editor);
    field.appendChild(k); field.appendChild(v);
    const parent=target||overviewContent;
    parent.appendChild(field);
    field.__display=display;
    field.__editor=editor;
    field.__setDisplayValue=(nextValue)=>{
      setElementTextWithCharacterChips(display, makeValue(nextValue), {label});
    };
    return field;
  }

  const gpRowView=document.createElement('div'); gpRowView.className='kv2';
  const gpEarn=Number(a.gp_plus??0);
  const gpEarnCell=makeKVS('Gold earned', fmtNumber(gpEarn)); gpRowView.appendChild(gpEarnCell);
  const gpSpend=Number(a.gp_minus??0);
  const gpSpendCell=makeKVS('Gold spent', fmtNumber(gpSpend)); gpRowView.appendChild(gpSpendCell);
  const showGpEarn=(!act || gpEarn!==0);
  const showGpSpend=(!act || gpSpend!==0);
  gpEarnCell.style.display=showGpEarn?'':'none';
  gpSpendCell.style.display=showGpSpend?'':'none';
  if(!(showGpEarn||showGpSpend)){ gpRowView.style.display='none'; }
  rewardsContent.appendChild(gpRowView);

  const dtRowView=document.createElement('div'); dtRowView.className='kv2';
  const dtEarnVal=Number(a.dtd_plus??0);
  const dtEarnCell=makeKVS('Downtime earned', fmtNumber(dtEarnVal)); dtRowView.appendChild(dtEarnCell);
  const dtSpendVal=Number(a.dtd_minus??0);
  const dtSpendCell=makeKVS('Downtime spent', fmtNumber(dtSpendVal)); dtRowView.appendChild(dtSpendCell);
  const showDtEarn=(!act || dtEarnVal!==0);
  const showDtSpend=(!act || dtSpendVal!==0);
  dtEarnCell.style.display=showDtEarn?'':'none';
  dtSpendCell.style.display=showDtSpend?'':'none';
  if(!(showDtEarn||showDtSpend)){ dtRowView.style.display='none'; }
  rewardsContent.appendChild(dtRowView);

  const lvlVal=Number(a.level_plus||0);
  const levelField=makeKVS('Levels gained', fmtNumber(lvlVal));
  const showLevel=(!act && lvlVal) || (act && lvlVal!==0);
  if(!showLevel){ levelField.style.display='none'; }
  rewardsContent.appendChild(levelField);

  const tradeData=act && a && a.trade && typeof a.trade==='object'?a.trade:null;
  const dmDisplay=normalizeDisplayValue(a.dm);
  const tradeGivenDisplay=tradeData
    ? normalizeDisplayValue(tradeData.given)
    : normalizeDisplayValue(a.traded_item||a.itemTraded);
  const tradeReceivedDisplay=tradeData
    ? normalizeDisplayValue(tradeData.received)
    : normalizeDisplayValue(a.itemReceived);
  const playerRaw=tradeData
    ? normalizeDisplayValue(tradeData.partnerPlayer)
    : normalizeDisplayValue(a.player);
  const characterDisplay=tradeData
    ? normalizeDisplayValue(tradeData.partnerCharacter)
    : normalizeDisplayValue(a.character);
  const hasLegacyTradeMeta=!!(
    normalizeDisplayValue(a.itemReceived)||
    normalizeDisplayValue(a.player)||
    normalizeDisplayValue(a.character)
  );
  const hasTradeMeta=act && (tradeData ? (tradeReceivedDisplay || playerRaw || characterDisplay) : hasLegacyTradeMeta);
  const tradePlayer=hasTradeMeta?(playerRaw||dmDisplay):playerRaw;
  const usedDmAsPlayer=hasTradeMeta && !playerRaw && !!dmDisplay && tradePlayer===dmDisplay;

  const dmField=appendField('DM', dmDisplay||'');
  if(!dmDisplay){ dmField.style.display='none'; }
  const kindField=appendField('Entry type', act?'Downtime Activity':'Adventure');
  kindField.classList.add('show-when-editing');
  kindField.style.display='none';

  codeFieldView=document.createElement('div');
  codeFieldView.className='field inline-field show-when-editing log-row-code';
  const codeLabel=document.createElement('div'); codeLabel.className='k'; codeLabel.textContent='Adventure code';
  const codeValue=document.createElement('div'); codeValue.className='v';
  const codeDisplay=document.createElement('div'); codeDisplay.className='display'; codeDisplay.textContent=makeValue(a.code||'');
  const codeEditor=document.createElement('div'); codeEditor.className='editor';
  codeValue.appendChild(codeDisplay);
  codeValue.appendChild(codeEditor);
  codeFieldView.appendChild(codeLabel);
  codeFieldView.appendChild(codeValue);
  info.appendChild(codeFieldView);
  codeFieldView.__display=codeDisplay;
  codeFieldView.__editor=codeEditor;
  codeEditorSlot=codeEditor;
  codeDisplayEl=codeDisplay;
  if(!(a.code||'').trim()){ codeFieldView.style.display='none'; }

  if(hasTradeMeta){
    if(tradeGivenDisplay){ appendField('Item traded away', tradeGivenDisplay); }
    if(tradeReceivedDisplay){ appendField('Item received', tradeReceivedDisplay); }
    if(tradePlayer || characterDisplay){
      const metaRow=document.createElement('div');
      metaRow.className='kv2';
      if(tradePlayer){ metaRow.appendChild(makeKVS('Player', tradePlayer)); }
      if(characterDisplay){ metaRow.appendChild(makeKVS('Character', characterDisplay)); }
      if(metaRow.children.length){ overviewContent.appendChild(metaRow); }
    }
  }

  let tradedItemField=null;
  if(!hasTradeMeta && act && !a.__isNew){
    const tradedItem=tradeGivenDisplay;
    tradedItemField=appendField('Item traded away', tradedItem,null,overviewContent);
    if(!tradedItem){ tradedItemField.style.display='none'; }
  }

  const hasPermItems=Array.isArray(a.perm_items)&&a.perm_items.some(item=>hasMeaningfulValue(item));
  const permField=appendField('Magic items gained', listBox(a.perm_items),'mi', inventoryContent);
  const showPerm=(!act || (!hasTradeMeta && hasPermItems));
  if(!showPerm){ permField.style.display='none'; }
  const lostValueList=parseLostItemList(a.lost_perm_item);
  const lostField=appendField('Magic items lost', listBox(lostValueList),null,inventoryContent);
  lostField.classList.add('milost');
  if(!lostValueList.length){ lostField.style.display='none'; }
  const hasConsumables=Array.isArray(a.consumable_items)&&a.consumable_items.some(item=>hasMeaningfulValue(item));
  const consField=appendField('Consumables', listBox(a.consumable_items),'cons', inventoryContent);
  const showCons=(!act || hasConsumables);
  if(!showCons){ consField.style.display='none'; }
  const hasGifts=Array.isArray(a.supernatural_gifts)&&a.supernatural_gifts.some(item=>hasMeaningfulValue(item));
  const giftsField=appendField('Supernatural gifts', listBox(a.supernatural_gifts),'gifts', inventoryContent);
  const showGifts=(!act || hasGifts);
  if(!showGifts){ giftsField.style.display='none'; }
  const noteText=normalizeDisplayValue(a.notes);
  const notesBox=document.createElement('div');
  notesBox.className='notesbox';
  setElementTextWithCharacterChips(notesBox, noteText||'', {label:'Notes'});
  const notesField=appendField('Notes', notesBox,null,notesContent);
  const showNotes=(!hasTradeMeta && (!act || noteText));
  if(!showNotes){ notesField.style.display='none'; }

  const formWrap=document.createElement('div'); formWrap.className='edit-form';
  const form=document.createElement('form');
  form.addEventListener('submit',async(ev)=>{ ev.preventDefault(); await saveCardChanges(card); });
  formWrap.appendChild(form);

  const controls={};
  function addField(label, element){
    const field=document.createElement('div'); field.className='field';
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v'; v.appendChild(element);
    field.appendChild(k); field.appendChild(v);
    form.appendChild(field);
    return element;
  }
  function makeInput(type){ const input=document.createElement('input'); input.type=type; if(type==='number'){ input.step='any'; } return input; }
  function makeTextarea(){ const t=document.createElement('textarea'); return t; }

  controls.title=addField('Title', makeInput('text'));
  controls.date=addField('Date', makeInput('date'));
  controls.code=addField('Adventure code', makeInput('text'));
  controls.dm=addField('DM', makeInput('text'));
  if(controls.title){ controls.title.placeholder='e.g. The Frozen Forge'; }
  if(controls.code){ controls.code.placeholder='DDAL00-01'; }
  if(controls.dm){ controls.dm.placeholder='Dungeon Master name'; }
  const updateHeaderMeta=()=>{
    if(!metaDisplayEl) return;
    const metaEntry={...a};
    metaEntry.date=controls.date.value||a.date;
    metaEntry.code=controls.code.value;
    metaEntry.dm=controls.dm.value;
    metaEntry.kind=(controls.kind.value||'adventure')==='adventure'?'adventure':'activity';
    metaDisplayEl.textContent=buildHeaderMeta(metaEntry);
    refreshScrollableWrapper(metaSpan);
  };
  if(controls.code){ controls.code.addEventListener('input',updateHeaderMeta); }
  if(controls.dm){ controls.dm.addEventListener('input',updateHeaderMeta); }
  if(controls.date){ controls.date.addEventListener('input',updateHeaderMeta); }
  function makeKindSelect(){
    const select=document.createElement('select');
    const options=[
      {value:'adventure',label:'Adventure'},
      {value:'Downtime Activity',label:'Downtime Activity'}
    ];
    options.forEach(opt=>{ const o=document.createElement('option'); o.value=opt.value; o.textContent=opt.label; select.appendChild(o); });
    return select;
  }
  controls.kind=addField('Kind', makeKindSelect());
  if(hasLockedKind){
    controls.kind.value=lockedKind;
    controls.kind.disabled=true;
    const kindFieldEl=controls.kind.closest('.field');
    if(kindFieldEl){
      kindFieldEl.style.display='none';
    }
  }
  controls.traded_item=addField('Item traded away', makeInput('text'));
  if(controls.traded_item){ controls.traded_item.placeholder='Describe the traded item'; }

  const gpRowForm=document.createElement('div'); gpRowForm.className='kv2';
  const gpEarnField=document.createElement('div'); gpEarnField.className='kvsingle';
  gpEarnField.innerHTML='<div class="k">Gold earned</div>';
  controls.gp_plus=makeInput('number');
  const gpEarnWrap=document.createElement('div'); gpEarnWrap.className='v'; gpEarnWrap.appendChild(controls.gp_plus); gpEarnField.appendChild(gpEarnWrap);

  const gpSpendField=document.createElement('div'); gpSpendField.className='kvsingle';
  gpSpendField.innerHTML='<div class="k">Gold spent</div>';
  controls.gp_minus=makeInput('number');
  const gpSpendWrap=document.createElement('div'); gpSpendWrap.className='v'; gpSpendWrap.appendChild(controls.gp_minus); gpSpendField.appendChild(gpSpendWrap);

  gpRowForm.appendChild(gpEarnField); gpRowForm.appendChild(gpSpendField); form.appendChild(gpRowForm);

  const dtRowForm=document.createElement('div'); dtRowForm.className='kv2';
  const dtEarnField=document.createElement('div'); dtEarnField.className='kvsingle';
  dtEarnField.innerHTML='<div class="k">Downtime earned</div>';
  controls.dtd_plus=makeInput('number');
  const dtEarnWrap=document.createElement('div'); dtEarnWrap.className='v'; dtEarnWrap.appendChild(controls.dtd_plus); dtEarnField.appendChild(dtEarnWrap);
  const dtSpendField=document.createElement('div'); dtSpendField.className='kvsingle';
  dtSpendField.innerHTML='<div class="k">Downtime spent</div>';
  controls.dtd_minus=makeInput('number');
  const dtSpendWrap=document.createElement('div'); dtSpendWrap.className='v'; dtSpendWrap.appendChild(controls.dtd_minus); dtSpendField.appendChild(dtSpendWrap);
  dtRowForm.appendChild(dtEarnField); dtRowForm.appendChild(dtSpendField); form.appendChild(dtRowForm);

  controls.level_plus=addField('Levels gained', makeInput('number'));

  const handleTotalsInput=()=>{
    const gpPlus=Number(controls.gp_plus.value||0);
    const gpMinus=Number(controls.gp_minus.value||0);
    const dtPlus=Number(controls.dtd_plus.value||0);
    const dtMinus=Number(controls.dtd_minus.value||0);
    updateTotals(gpPlus-gpMinus,dtPlus-dtMinus,true);
  };
  controls.gp_plus.addEventListener('input',handleTotalsInput);
  controls.gp_minus.addEventListener('input',handleTotalsInput);
  controls.dtd_plus.addEventListener('input',handleTotalsInput);
  controls.dtd_minus.addEventListener('input',handleTotalsInput);
  controls.level_plus.addEventListener('input',()=>{
    updateLevelSummary(levelStart,controls.level_plus.value,true);
  });

  let tradeField=controls.traded_item.closest('.field');
  function syncKindVisibility(){
    const isActivity=controls.kind.value!=='adventure';
    if(tradeField){ tradeField.style.display=isActivity?'':'none'; }
  }
  controls.kind.addEventListener('change',()=>{
    syncKindVisibility();
    const isActivityNow=(controls.kind.value||'adventure')!=='adventure';
    applyActivityBadge(isActivityNow);
    updateHeaderMeta();
  });
  syncKindVisibility();

  function createListEditor(items){
    const wrap=document.createElement('div'); wrap.className='list-editor';
    const list=document.createElement('div'); list.className='list'; wrap.appendChild(list);
    function addRow(val){
      const row=document.createElement('div'); row.className='list-row';
      const input=document.createElement('input'); input.type='text'; input.value=val||'';
      const btn=document.createElement('button'); btn.type='button'; btn.innerHTML=ICON_TRASH; btn.setAttribute('aria-label','Remove item');
      btn.addEventListener('click',()=>row.remove());
      row.appendChild(input); row.appendChild(btn); list.appendChild(row);
    }
    (items||[]).forEach(item=>addRow(item));
    const addBtn=document.createElement('button'); addBtn.type='button'; addBtn.className='add-row'; addBtn.textContent='Add item';
    addBtn.addEventListener('click',()=>addRow(''));
    wrap.appendChild(addBtn);
    wrap.getValues=()=>Array.from(list.querySelectorAll('input')).map(el=>el.value.trim()).filter(Boolean);
    wrap.setValues=(vals)=>{ list.innerHTML=''; (vals||[]).forEach(item=>addRow(item)); };
    return wrap;
  }

  controls.perm_items=createListEditor(a.perm_items||[]);
  addField('Magic items gained', controls.perm_items);
  function createLostItemEditor(items){
    const wrap=document.createElement('div');
    wrap.className='list-editor lost-item-editor';
    const list=document.createElement('div');
    list.className='list';
    wrap.appendChild(list);
    wrap.__selects=[];

    function availableNames(){
      const key=(a && a.__charKey)||charSel.value;
      const names=[];
      if(key && DATA && DATA.characters && DATA.characters[key]){
        const {kept}=collectPermanentInventory(key);
        kept.forEach(meta=>{
          const name=meta && meta.name?normItemName(meta.name):'';
          if(name) names.push(name);
        });
      }
      return names;
    }

    function refreshOptions(){
      const baseNames=availableNames();
      const currentValues=wrap.__selects.map(sel=>normItemName(sel.value)).filter(Boolean);
      const uniqueMap=new Map();
      [...baseNames,...currentValues].forEach(name=>{
        const cleaned=normItemName(name);
        if(!cleaned) return;
        const key=cleaned.toLowerCase();
        if(uniqueMap.has(key)) return;
        uniqueMap.set(key,cleaned);
      });
      const options=[...uniqueMap.values()].sort((lhs,rhs)=>lhs.localeCompare(rhs,'en',{sensitivity:'base'}));
      wrap.__selects.forEach(select=>{
        const prev=normItemName(select.value);
        select.innerHTML='';
        const placeholder=document.createElement('option');
        placeholder.value='';
        placeholder.textContent='Select item';
        placeholder.disabled=true;
        placeholder.selected=!prev;
        select.appendChild(placeholder);
        options.forEach(name=>{
          const opt=document.createElement('option');
          opt.value=name;
          opt.textContent=name;
          select.appendChild(opt);
        });
        if(prev){
          const normalizedPrev=prev.toLowerCase();
          const match=options.find(name=>name.toLowerCase()===normalizedPrev);
          if(match){
            select.value=match;
          }else{
            const custom=document.createElement('option');
            custom.value=prev;
            custom.textContent=prev;
            select.appendChild(custom);
            select.value=prev;
          }
        }
      });
    }

    function addRow(value){
      const row=document.createElement('div');
      row.className='list-row';
      const select=document.createElement('select');
      wrap.__selects.push(select);
      select.addEventListener('change',()=>{
        wrap.dispatchEvent(new Event('input',{bubbles:true}));
      });
      row.appendChild(select);
      const btn=document.createElement('button');
      btn.type='button';
      btn.innerHTML=ICON_TRASH;
      btn.setAttribute('aria-label','Remove item');
      btn.addEventListener('click',()=>{
        const idx=wrap.__selects.indexOf(select);
        if(idx>=0){ wrap.__selects.splice(idx,1); }
        row.remove();
        refreshOptions();
        wrap.dispatchEvent(new Event('input',{bubbles:true}));
      });
      row.appendChild(btn);
      list.appendChild(row);
      refreshOptions();
      const val=normItemName(value);
      if(val){
        const normalized=val.toLowerCase();
        const optionMatch=Array.from(select.options).find(opt=>normItemName(opt.value).toLowerCase()===normalized);
        if(optionMatch){
          select.value=optionMatch.value;
        }else{
          const opt=document.createElement('option');
          opt.value=val;
          opt.textContent=val;
          select.appendChild(opt);
          select.value=val;
        }
      }
      return select;
    }

    const setValues=(vals)=>{
      list.innerHTML='';
      wrap.__selects=[];
      const arr=Array.isArray(vals)?vals:parseLostItemList(vals);
      const seen=new Set();
      arr.forEach(item=>{
        const cleaned=normItemName(item);
        if(!cleaned) return;
        const key=cleaned.toLowerCase();
        if(seen.has(key)) return;
        seen.add(key);
        addRow(cleaned);
      });
      refreshOptions();
    };

    wrap.setValues=setValues;
    wrap.getValues=()=>wrap.__selects.map(sel=>normItemName(sel.value)).filter(Boolean);
    Object.defineProperty(wrap,'value',{
      get(){
        return wrap.getValues().join('\n');
      },
      set(val){ setValues(val); }
    });

    const addBtn=document.createElement('button');
    addBtn.type='button';
    addBtn.className='add-row';
    addBtn.textContent='Add item';
    addBtn.addEventListener('click',()=>{
      const select=addRow('');
      select.focus();
    });
    wrap.appendChild(addBtn);

    if(items && items.length){
      setValues(items);
    }else{
      refreshOptions();
    }

    wrap.focus=()=>{
      const target=wrap.__selects[0];
      if(target){
        target.focus();
      }else{
        addBtn.focus();
      }
    };

    wrap.refreshOptions=refreshOptions;
    return wrap;
  }
  controls.lost_perm_item=addField('Magic items lost', createLostItemEditor(lostValueList));
  controls.consumable_items=createListEditor(a.consumable_items||[]);
  addField('Consumables', controls.consumable_items);
  controls.supernatural_gifts=createListEditor(a.supernatural_gifts||[]);
  addField('Supernatural gifts', controls.supernatural_gifts);
  controls.notes=addField('Notes', makeTextarea());
  if(controls.notes){
    controls.notes.rows=8;
    controls.notes.placeholder='Key highlights, rewards, table notes';
    const notesControlField=controls.notes.closest('.field');
    if(notesControlField){
      notesControlField.classList.add('full');
    }
  }

  form.querySelectorAll('.field,.kv2').forEach(el=>el.remove());

  function mountControl(control,target){
    if(!control||!target) return;
    target.appendChild(control);
  }

  mountControl(controls.title,titleEditorSlot);
  mountControl(controls.date,dateEditorSlot);
  mountControl(controls.code, codeEditorSlot || (codeFieldView && codeFieldView.__editor));
  mountControl(controls.dm, dmField.__editor);
  mountControl(controls.kind, kindField.__editor);
  tradeField=null;
  if(tradedItemField && controls.traded_item){
    mountControl(controls.traded_item, tradedItemField.__editor);
    tradeField=controls.traded_item.closest('.field');
  }
  mountControl(controls.gp_plus, gpEarnCell.__editor);
  mountControl(controls.gp_minus, gpSpendCell.__editor);
  mountControl(controls.dtd_plus, dtEarnCell.__editor);
  mountControl(controls.dtd_minus, dtSpendCell.__editor);
  mountControl(controls.level_plus, levelField.__editor);
  mountControl(controls.perm_items, permField.__editor);
  mountControl(controls.lost_perm_item, lostField.__editor);
  mountControl(controls.consumable_items, consField.__editor);
  mountControl(controls.supernatural_gifts, giftsField.__editor);
  mountControl(controls.notes, notesField.__editor);

  permField.classList.add('full');
  lostField.classList.add('full');
  consField.classList.add('full');
  notesField.classList.add('full','notes-field');

  const actions=document.createElement('div'); actions.className='edit-actions';
  actions.classList.add('show-when-editing');
  const deleteBtn=document.createElement('button'); deleteBtn.type='button'; deleteBtn.className='btn small danger delete-btn'; deleteBtn.innerHTML='<span class="btn-icon">'+ICON_TRASH+'</span><span>Delete entry</span>';
  deleteBtn.addEventListener('click',(ev)=>{ ev.preventDefault(); deleteCard(card); });
  const cancelBtn=document.createElement('button'); cancelBtn.type='button'; cancelBtn.className='btn small'; cancelBtn.textContent='Cancel';
  cancelBtn.addEventListener('click',(ev)=>{
    ev.preventDefault();
    if(card.__dataRef && card.__dataRef.__isNew){
      closeCardOverlay();
      return;
    }
    exitEditMode(card,true);
  });
  const saveBtn=document.createElement('button');
  saveBtn.type='button';
  saveBtn.className='btn small primary';
  saveBtn.textContent='Save';
  saveBtn.addEventListener('click',async(ev)=>{
    ev.preventDefault();
    await saveCardChanges(card);
  });
  actions.appendChild(deleteBtn);
  actions.appendChild(cancelBtn); actions.appendChild(saveBtn);
  view.appendChild(actions);

  function populate(editing=false){
    if(overviewContent){
      overviewContent.style.display=editing?'grid':'none';
    }
    const kindRaw=hasLockedKind?lockedKind:(a.kind||'').toString();
    const kindVal=kindRaw && kindRaw.toLowerCase()!=='adventure'?'Downtime Activity':'adventure';
    controls.kind.value=kindVal;
    controls.kind.disabled=hasLockedKind;
    const isActivityMode=(controls.kind.value||'adventure')!=='adventure';

    applyActivityBadge(isActivityMode);

    const titleRaw=a.title||'';
    controls.title.value=titleRaw;
    if(titleDisplayEl){
      const fallback=isActivityMode?'Activity':'Untitled Adventure';
      titleDisplayEl.textContent=sanitizeTitle(titleRaw||fallback);
      refreshScrollableWrapper(nameSpan);
    }

    const dateValue=a.date?String(a.date).slice(0,10):'';
    controls.date.value=dateValue;
    if(dateDisplayEl){
      dateDisplayEl.textContent=fmtDate(a.date);
      refreshScrollableWrapper(dateSpan);
    }

    const codeRaw=a.code||'';
    controls.code.value=codeRaw;
    if(codeDisplayEl){ codeDisplayEl.textContent=makeValue(codeRaw); }
    if(codeFieldView){
      codeFieldView.style.display=(editing||codeRaw)?'':'none';
    }

    const kindLabel=(controls.kind.value||'adventure')==='adventure'?'Adventure':'Downtime Activity';
    kindField.__display.textContent=kindLabel;
    const showKindField=editing && !hasLockedKind;
    kindField.style.display=showKindField?'':'none';

    const dmRaw=a.dm||'';
    controls.dm.value=dmRaw;
    const dmDisplayVal=normalizeDisplayValue(dmRaw)||'';
    if(dmField && dmField.__display){ dmField.__display.textContent=dmDisplayVal; }
    if(dmField){
      const showDM=editing || !isActivityMode || dmDisplayVal!=='';
      dmField.style.display=showDM?'':'none';
    }

    if(tradedItemField && controls.traded_item){
      const tradeObj=(a.trade && typeof a.trade==='object')?a.trade:null;
      const tradeVal=tradeObj?(tradeObj.given||''):(a.traded_item||a.itemTraded||'');
      controls.traded_item.value=tradeVal;
      tradedItemField.__display.textContent=makeValue(tradeVal);
      tradedItemField.style.display=(editing||tradeVal.trim())?'':'none';
    }

    const gpEarn=Number(a.gp_plus??0);
    controls.gp_plus.value=a.gp_plus!=null&&a.gp_plus!==''?a.gp_plus:'';
    gpEarnCell.__display.textContent=fmtNumber(gpEarn);
    const gpSpend=Number(a.gp_minus??0);
    controls.gp_minus.value=a.gp_minus!=null&&a.gp_minus!==''?a.gp_minus:'';
    gpSpendCell.__display.textContent=fmtNumber(gpSpend);
    const showGpEarn=!isActivityMode || gpEarn!==0 || editing;
    const showGpSpend=!isActivityMode || gpSpend!==0 || editing;
    gpEarnCell.style.display=showGpEarn?'':'none';
    gpSpendCell.style.display=showGpSpend?'':'none';
    gpRowView.style.display=(editing||showGpEarn||showGpSpend)?'':'none';

    const dtEarn=Number(a.dtd_plus??0);
    controls.dtd_plus.value=a.dtd_plus!=null&&a.dtd_plus!==''?a.dtd_plus:'';
    dtEarnCell.__display.textContent=fmtNumber(dtEarn);
    const dtSpend=Number(a.dtd_minus??0);
    controls.dtd_minus.value=a.dtd_minus!=null&&a.dtd_minus!==''?a.dtd_minus:'';
    dtSpendCell.__display.textContent=fmtNumber(dtSpend);
    const showDtEarn=!isActivityMode || dtEarn!==0 || editing;
    const showDtSpend=!isActivityMode || dtSpend!==0 || editing;
    dtEarnCell.style.display=showDtEarn?'':'none';
    dtSpendCell.style.display=showDtSpend?'':'none';
    dtRowView.style.display=(editing||showDtEarn||showDtSpend)?'':'none';

    const levelVal=Number(a.level_plus||0);
    controls.level_plus.value=a.level_plus!=null&&a.level_plus!==''?a.level_plus:'';
    levelField.__display.textContent=fmtNumber(levelVal);
    const showLevel=(editing||(!isActivityMode && levelVal) || (isActivityMode && levelVal!==0));
    levelField.style.display=showLevel?'':'none';

    const editingGpPlus=Number(controls.gp_plus.value||0);
    const editingGpMinus=Number(controls.gp_minus.value||0);
    const editingDtPlus=Number(controls.dtd_plus.value||0);
    const editingDtMinus=Number(controls.dtd_minus.value||0);
    let summaryGpValue=gp;
    let summaryDtValue=dtd;
    if(!isActivityMode){
      summaryGpValue=(a.gp_net==null?gp:a.gp_net);
      summaryDtValue=(a.dtd_net==null?dtd:a.dtd_net);
    }
    if(editing){
      summaryGpValue=editingGpPlus-editingGpMinus;
      summaryDtValue=editingDtPlus-editingDtMinus;
    }
    updateTotals(summaryGpValue,summaryDtValue,editing);
    const currentGain=editing?Number(controls.level_plus.value||0):levelVal;
    updateLevelSummary(levelStart,currentGain,editing);

    const permValues=Array.isArray(a.perm_items)?a.perm_items:[];
    controls.perm_items.setValues(permValues);
    permField.__display.innerHTML='';
    permField.__display.appendChild(listBox(permValues));
    const permCount=permValues.filter(item=>hasMeaningfulValue(item)).length;
    const hasPermItemsNow=permCount>0;
    permField.style.display=(editing || (!hasTradeMeta && (!isActivityMode || hasPermItemsNow)))?'':'none';

    const consValues=Array.isArray(a.consumable_items)?a.consumable_items:[];
    controls.consumable_items.setValues(consValues);
    consField.__display.innerHTML='';
    consField.__display.appendChild(listBox(consValues));
    const consCount=consValues.filter(item=>hasMeaningfulValue(item)).length;
    const hasConsNow=consCount>0;
    consField.style.display=(editing || (!isActivityMode || hasConsNow))?'':'none';

    const giftValues=Array.isArray(a.supernatural_gifts)?a.supernatural_gifts:[];
    if(controls.supernatural_gifts){
      controls.supernatural_gifts.setValues(giftValues);
    }
    giftsField.__display.innerHTML='';
    giftsField.__display.appendChild(listBox(giftValues));
    const giftCount=giftValues.filter(item=>hasMeaningfulValue(item)).length;
    const hasGiftsNow=giftCount>0;
    giftsField.style.display=(editing || (!isActivityMode || hasGiftsNow))?'':'none';

    const notesRaw=a.notes||'';
    controls.notes.value=notesRaw;
    const notesDisplay=normalizeDisplayValue(notesRaw)||'';
    notesField.__display.innerHTML='';
    const notesNode=document.createElement('div'); notesNode.className='notesbox'; notesNode.textContent=notesDisplay;
    notesField.__display.appendChild(notesNode);
    const showNotes=(editing || (!hasTradeMeta && (!isActivityMode || notesDisplay!=='')));
    notesField.style.display=showNotes?'':'none';

    let lostItems=parseLostItemList(a.lost_perm_item);
    if(controls.lost_perm_item){
      controls.lost_perm_item.setValues(lostItems);
      if(typeof controls.lost_perm_item.refreshOptions==='function'){
        controls.lost_perm_item.refreshOptions();
      }
      lostItems=controls.lost_perm_item.getValues();
    }
    lostField.__display.innerHTML='';
    lostField.__display.appendChild(listBox(lostItems));
    lostField.style.display=(editing || lostItems.length)?'':'none';

    const totalInventoryEntries=permCount+consCount+giftCount+lostItems.length;
    const hasRewardsSectionContent=(gpRowView.style.display!=='none')||(dtRowView.style.display!=='none')||(levelField.style.display!=='none');
    const showRewardsSection=editing || hasRewardsSectionContent;
    rewardsSection.section.style.display=showRewardsSection?'':'none';

    if(inventorySection.toggle){
      inventorySection.toggle.textContent=`${inventorySectionLabel}${totalInventoryEntries?` (${totalInventoryEntries})`:''}`;
    }
    const showInventorySection=editing || totalInventoryEntries>0;
    inventorySection.section.style.display=showInventorySection?'':'none';
    if(showInventorySection){
      inventorySection.setOpen(editing || totalInventoryEntries>0);
    }

    if(notesSection.toggle){
      notesSection.toggle.textContent=`${notesSectionLabel}${notesDisplay!==''?' (1)':''}`;
    }
    const showNotesSection=editing || notesDisplay!=='';
    notesSection.section.style.display=showNotesSection?'':'none';
    if(showNotesSection){
      notesSection.setOpen(editing || notesDisplay!=='');
    }

    const hasOverviewContent=Array.from(overviewContent.children||[]).some(child=>{
      if(!(child instanceof HTMLElement)) return true;
      if(child.style.display==='none' || child.hidden) return false;
      if(!editing && child.classList.contains('show-when-editing')) return false;
      return true;
    });
    overviewContent.style.display=(editing || hasOverviewContent)?'':'none';

    updateHeaderMeta();

    syncKindVisibility();
  }

  function collect(){
    const selectedKind=(controls.kind.value||'').trim();
    const normalizedKind=selectedKind==='Downtime Activity'?'Downtime Activity':'adventure';
    const isActivity=normalizedKind!=='adventure';
    return {
      title:(controls.title.value||'').trim(),
      date:controls.date.value||'',
      code:(controls.code.value||'').trim(),
      dm:(controls.dm.value||'').trim(),
      kind:normalizedKind,
      gp_plus:Number(controls.gp_plus.value||0),
      gp_minus:Number(controls.gp_minus.value||0),
      dtd_plus:Number(controls.dtd_plus.value||0),
      dtd_minus:Number(controls.dtd_minus.value||0),
      level_plus:Number(controls.level_plus.value||0),
      perm_items:controls.perm_items.getValues(),
      lost_perm_item:controls.lost_perm_item?controls.lost_perm_item.getValues():[],
      consumable_items:controls.consumable_items.getValues(),
      supernatural_gifts:controls.supernatural_gifts.getValues(),
      notes:controls.notes.value||'',
      trade:(()=>{
        if(!isActivity) return null;
        const given=(controls.traded_item.value||'').trim();
        if(!given) return null;
        return { given };
      })()
    };
  }

  formWrap.populate=populate;
  formWrap.collect=collect;

  populate(false);

  bd.appendChild(cardActions);
  bd.appendChild(view);
  bd.appendChild(formWrap);
  card.appendChild(hd);
  card.appendChild(bd);

  card.__edit={button:editBtn, form:formWrap, populate, collect, saveButton:saveBtn};

  if(a && a.__openEdit){
    delete a.__openEdit;
    requestAnimationFrame(()=>enterEditMode(card));
  }

  return card;
}

function enterEditMode(card){
  if(!card||!card.__edit) return;
  card.classList.add('editing');
  card.classList.add('open');
  card.__edit.populate(true);
  const bd=card.querySelector('.card-bd');
  if(bd){
    bd.style.height='auto';
    bd.style.opacity='1';
  }
  if(card.__edit.button){
    card.__edit.button.setAttribute('aria-pressed','true');
    card.__edit.button.title='Exit edit mode';
  }
}

function exitEditMode(card,reset){
  if(!card||!card.__edit) return;
  card.classList.remove('editing');
  if(reset){ card.__edit.populate(false); }
  if(card.__edit.button){
    card.__edit.button.setAttribute('aria-pressed','false');
    card.__edit.button.title='Edit entry';
    card.__edit.button.textContent='Edit';
  }
}

async function saveCardChanges(card){
  if(!card||!card.__edit) return;
  const data=card.__dataRef;
  if(!data) return;
  const saveButton=card.__edit.saveButton||null;
  const originalSaveLabel=saveButton?saveButton.textContent:null;
  if(saveButton){
    saveButton.disabled=true;
    saveButton.setAttribute('aria-busy','true');
    saveButton.textContent='Saving...';
  }
  try{
    const updates=card.__edit.collect();
    data.title=updates.title||null;
    data.date=updates.date||null;
    data.code=updates.code||'';
    data.dm=updates.dm||null;
    data.kind=updates.kind||'adventure';
    data.gp_plus=Number.isFinite(updates.gp_plus)?updates.gp_plus:0;
    data.gp_minus=Number.isFinite(updates.gp_minus)?updates.gp_minus:0;
    data.gp_net=data.gp_plus-data.gp_minus;
    data.dtd_plus=Number.isFinite(updates.dtd_plus)?updates.dtd_plus:0;
    data.dtd_minus=Number.isFinite(updates.dtd_minus)?updates.dtd_minus:0;
    data.dtd_net=data.dtd_plus-data.dtd_minus;
    data.level_plus=Number.isFinite(updates.level_plus)?updates.level_plus:0;
    data.perm_items=[...updates.perm_items];
    data.lost_perm_item=Array.isArray(updates.lost_perm_item)?[...updates.lost_perm_item]:[];
    data.consumable_items=[...updates.consumable_items];
    data.supernatural_gifts=[...updates.supernatural_gifts];
    const trimmedNotes=(updates.notes||'').trim();
    data.notes=trimmedNotes||'';
    if(data.kind!=='adventure'){
      const currentTrade=(data.trade && typeof data.trade==='object')?{...data.trade}:null;
      const hasExtendedTrade=currentTrade && (currentTrade.received||currentTrade.partnerCharacter||currentTrade.partnerPlayer);
      const nextTrade=updates.trade && typeof updates.trade==='object'?updates.trade:null;
      if(nextTrade){
        data.trade={...nextTrade};
      }else if(hasExtendedTrade){
        data.trade=currentTrade;
      }else{
        data.trade=null;
      }
    }else{
      data.trade=null;
    }
    if('traded_item' in data){ delete data.traded_item; }
    if('itemTraded' in data){ delete data.itemTraded; }
    if('itemReceived' in data){ delete data.itemReceived; }
    if('player' in data){ delete data.player; }
    if('character' in data){ delete data.character; }
    if(!data.trade){ delete data.trade; }
    const keyOverride=data.__charKey||null;
    const wasNew=!!data.__isNew;
    const targetKey=keyOverride||charSel.value;
    let targetChar=null;
    let insertedNew=false;
    if(wasNew){
      targetChar=DATA.characters[targetKey]||null;
      if(targetChar){
        targetChar.adventures=Array.isArray(targetChar.adventures)?targetChar.adventures:[];
        if(!targetChar.adventures.includes(data)){
          targetChar.adventures.unshift(data);
          insertedNew=true;
        }
      }
    }
    markDirty();
    const mutationKey=wasNew?targetKey:charSel.value;
    let saveError=null;
    const shouldCloseOverlay=card.classList.contains('overlay-card');
    try{
      registerDerivedUpdate(mutationKey);
      exitEditMode(card);
      if(shouldCloseOverlay){
        closeCardOverlay();
      }
      await saveDataJs();
    }catch(err){
      saveError=err;
    }
    if(saveError){
      if(wasNew && insertedNew && targetChar){
        const idx=targetChar.adventures.indexOf(data);
        if(idx!==-1){
          targetChar.adventures.splice(idx,1);
        }
      }
      if(wasNew){
        pendingDerivedUpdates.delete(mutationKey);
      }
      return false;
    }
    if(wasNew){
      delete data.__isNew;
      delete data.__charKey;
    }
    if(Object.prototype.hasOwnProperty.call(data,'__lockedKind')){
      delete data.__lockedKind;
    }
    applyDataMutation(mutationKey);
    return true;
  }finally{
    if(saveButton){
      saveButton.disabled=false;
      saveButton.removeAttribute('aria-busy');
      saveButton.textContent=originalSaveLabel!=null?originalSaveLabel:'Save';
    }
  }
}

async function deleteCard(card){
  if(!card||!card.__dataRef) return;
  if(card.__dataRef.__isNew){
    const confirmed=window.confirm('Discard this new entry?');
    if(confirmed) closeCardOverlay();
    return;
  }
  const key=(card.__dataRef && card.__dataRef.__charKey)||charSel.value;
  const ch=DATA.characters[key];
  if(!ch||!Array.isArray(ch.adventures)) return;
  const idx=ch.adventures.indexOf(card.__dataRef);
  if(idx===-1) return;
  const confirmed=window.confirm('Delete this entry?');
  if(!confirmed) return;
  const [removed]=ch.adventures.splice(idx,1);
  registerDerivedUpdate(key);
  markDirty();
  applyDataMutation(key);
  try{
    await saveDataJs();
  }catch(err){
    if(removed){
      ch.adventures.splice(idx,0,removed);
    }
    pendingDerivedUpdates.delete(key);
    applyDataMutation(key);
  }
}

function ensureDerivedStores(){
  if(!DATA || typeof DATA!=='object') return;
  if(!DATA.stats || typeof DATA.stats!=='object'){
    DATA.stats={};
  }
  if(!DATA.years || typeof DATA.years!=='object'){
    DATA.years={};
  }
  if(!Array.isArray(DATA.dm_allocations)){
    DATA.dm_allocations=[];
  }
}

function updateDerivedDataFor(key){
  if(isDmLogKey(key)) return;
  if(!DATA || !DATA.characters) return;
  ensureDerivedStores();
  sortCharacterAdventures(key);
  const ch=DATA.characters[key];
  if(!ch) return;
  const advs=ch.adventures||[];
  const years=new Set();
  let sessions=0, netGP=0, netDTD=0, levelUps=0;
  advs.forEach(entry=>{
    if(entry && typeof entry==='object'){
      entry.__charKey=key;
      ensureAdventureUid(entry);
    }
    if(entry.date){
      const year=new Date(entry.date).getFullYear();
      if(!Number.isNaN(year)) years.add(year);
    }
    const {gp,dtd}=netVals(entry);
    netGP+=gp;
    netDTD+=dtd;
    const levelGain=Number(entry.level_plus);
    if(Number.isFinite(levelGain)){
      levelUps+=levelGain;
    }
    if(!isActivityEntry(entry)) sessions++;
  });
  const descending=advs.map((adv,idx)=>({adv,idx})).sort(compareChronoDesc);
  let runningLevel=Math.max(1, Math.round(1+levelUps));
  descending.forEach(({adv})=>{
    if(!adv || typeof adv!=='object') return;
    const afterLevel=Number.isFinite(runningLevel)?runningLevel:1;
    const normalizedAfter=Math.max(1, Math.round(afterLevel));
    adv.__levelAfter=normalizedAfter;
    const gainRaw=Number(adv.level_plus);
    const gain=Number.isFinite(gainRaw)?gainRaw:0;
    const beforeLevel=afterLevel-gain;
    const normalizedBefore=Number.isFinite(beforeLevel)?Math.max(1, Math.round(beforeLevel)):normalizedAfter;
    adv.__levelAtStart=normalizedBefore;
    const nextLevel=Number.isFinite(beforeLevel)?Math.max(1, beforeLevel):normalizedBefore;
    runningLevel=nextLevel;
  });
  DATA.years[key]=Array.from(years).sort((a,b)=>a-b);
  const perm=collectPermanentInventory(key);
  const cons=buildConsumableInventory(key);
  const gifts=collectSupernaturalGifts(key);
  DATA.stats[key]={
    sessions,
    net_gp:netGP,
    net_dtd:netDTD,
    level_ups:levelUps,
    perm_count:(perm.kept||[]).length,
    cons_count:cons.size||0,
    gifts_count:gifts.length||0
  };
}

function refreshAllDerivedData(){
  if(!DATA || !DATA.characters) return;
  invalidateAdventureSearchCache();
  ensureDerivedStores();
  Object.keys(DATA.characters).forEach(key=>{
    updateDerivedDataFor(key);
  });
  adventureSearchCache.all=buildAllAdventureEntries();
  buildDmEntries();
  rebuildDmRewardLinks();
  refreshCharacterMentionIndex();
  pendingDerivedUpdates.clear();
}

function applyDataMutation(key){
  invalidateAdventureSearchCache(key);
  let updated=false;
  try{
    updateDerivedDataFor(key);
    updated=true;
  }catch(err){
    console.error('Failed to update derived data for', key, err);
  }
  if(updated && key){
    pendingDerivedUpdates.delete(key);
  }
  rebuildDmRewardLinks();
  refreshCharacterMentionIndex();
  filterAndRender();
  scheduleAvatarPreload();
  if(pendingChanges){
    persistDataDraft();
  }
  scheduleDataValidation();
}

/* --- stats & header --- */
let headerStateOverride=null;
function setHeaderOverride(override){
  if(override && typeof override==='object'){
    headerStateOverride={
      label:typeof override.label==='string'?override.label:'',
      meta:typeof override.meta==='string'?override.meta:'',
      title:typeof override.title==='string'?override.title:'',
      multi:!!override.multi
    };
  }else{
    headerStateOverride=null;
  }
}
function getHeaderOverride(){
  return headerStateOverride;
}

function applyMultiSearchHeaderState(isActive){
  if(!sheetHeaderEl) return;
  sheetHeaderEl.classList.toggle('multi-search-active', !!isActive);
}

function updateCharMeta(key){
  if(!metaEl) return;
  const statsMap=(DATA && typeof DATA.stats==='object')?DATA.stats:{};
  const stats=statsMap[key];
  if(!stats){
    metaEl.textContent='';
    metaEl.style.display='none';
    metaEl.setAttribute('aria-hidden','true');
    return;
  }
  const levelUps=Number(stats.level_ups||0);
  const currentLevel=(Number.isFinite(levelUps)?Math.round(levelUps):0)+1;
  const sessionsRaw=Number(stats.sessions||0);
  const parts=[];
  if(Number.isFinite(currentLevel)) parts.push(`Level ${fmtNumber(currentLevel)}`);
  if(Number.isFinite(sessionsRaw)){
    const label=sessionsRaw===1?'Session':'Sessions';
    parts.push(`${fmtNumber(sessionsRaw)} ${label}`);
  }
  const text=parts.join('  ');
  metaEl.textContent=text;
  const show=Boolean(text);
  metaEl.style.display=show?'block':'none';
  metaEl.setAttribute('aria-hidden',show?'false':'true');
}

function setInventorySidebarManageEnabled(enabled){
  inventorySidebarManageButtons.forEach(btn=>{
    if(!btn) return;
    btn.disabled=!enabled;
  });
}

function renderInventorySidebarList(listEl,items,emptyText,{renderQuantity=false}={}){
  if(!listEl) return;
  listEl.innerHTML='';
  if(!items || !items.length){
    const empty=document.createElement('li');
    empty.className='inventory-sidebar-item inventory-sidebar-note';
    empty.textContent=emptyText;
    listEl.appendChild(empty);
    return;
  }
  items.forEach(item=>{
    const li=document.createElement('li');
    li.className='inventory-sidebar-item';
    const label=document.createElement('span');
    label.className='inventory-sidebar-label';
    if(renderQuantity && item && typeof item==='object'){
      label.textContent=item.name;
      const qty=document.createElement('span');
      qty.className='inventory-sidebar-qty';
      qty.textContent=`${fmtNumber(item.count)}`;
      li.appendChild(label);
      li.appendChild(qty);
    }else{
      label.textContent=typeof item==='string'?item:String(item);
      li.appendChild(label);
    }
    listEl.appendChild(li);
  });
}

function renderInventorySidebar(key){
  if(!inventorySidebarContent||!inventorySidebarEmpty){
    return;
  }
  const hasCharacter=isValidSheetKey(key) && !isDmLogKey(key) && DATA && DATA.characters && DATA.characters[key];
  if(!hasCharacter){
    inventorySidebarContent.hidden=true;
    inventorySidebarContent.setAttribute('aria-hidden','true');
    inventorySidebarEmpty.hidden=false;
    inventorySidebarEmpty.setAttribute('aria-hidden','false');
    setInventorySidebarManageEnabled(false);
    if(inventorySidebarMagicCount) inventorySidebarMagicCount.textContent='0';
    if(inventorySidebarConsumableCount) inventorySidebarConsumableCount.textContent='0';
    if(inventorySidebarActiveSummary) inventorySidebarActiveSummary.textContent='0/0 slots';
    if(inventorySidebarActiveList){
      inventorySidebarActiveList.innerHTML='';
      inventorySidebarActiveList.hidden=true;
      inventorySidebarActiveList.setAttribute('aria-hidden','true');
    }
    if(inventorySidebarActiveEmpty){
      inventorySidebarActiveEmpty.hidden=false;
      inventorySidebarActiveEmpty.setAttribute('aria-hidden','false');
    }
    [inventorySidebarMagicList,inventorySidebarConsumableList].forEach(list=>{
      if(list) list.innerHTML='';
    });
    return;
  }
  inventorySidebarContent.hidden=false;
  inventorySidebarContent.setAttribute('aria-hidden','false');
  inventorySidebarEmpty.hidden=true;
  inventorySidebarEmpty.setAttribute('aria-hidden','true');
  setInventorySidebarManageEnabled(true);

  const { kept,map:keptMap }=collectPermanentInventory(key);
  if(inventorySidebarMagicCount) inventorySidebarMagicCount.textContent=fmtNumber(kept.length);
  renderInventorySidebarList(
    inventorySidebarMagicList,
    kept.map(item=>item.name),
    'No permanent items recorded.'
  );

  const level=currentLevelFor(key);
  const activeCap=activeSlotsFor(level);
  const commonSet=new Set(loadCommon(key).map(name=>{
    const cleaned=normItemName(name);
    return cleaned?cleaned.toLowerCase():null;
  }).filter(Boolean));
  const activeOrder=[];
  const seenActive=new Set();
  loadActive(key).forEach(name=>{
    const cleaned=normItemName(name);
    if(!cleaned) return;
    const lower=cleaned.toLowerCase();
    if(seenActive.has(lower)) return;
    const meta=keptMap.get(lower);
    if(!meta) return;
    seenActive.add(lower);
    activeOrder.push(meta.name);
  });
  const nonCommonActive=activeOrder.reduce((sum,label)=>{
    return sum+(commonSet.has(label.toLowerCase())?0:1);
  },0);
  if(inventorySidebarActiveSummary){
    if(activeCap>0){
      const slotLabel=activeCap===1?'slot':'slots';
      const itemLabel=activeOrder.length===1?'item':'items';
      const slotText=`${fmtNumber(nonCommonActive)}/${fmtNumber(activeCap)} ${slotLabel} used`;
      const totalText=`${fmtNumber(activeOrder.length)} ${itemLabel}`;
      inventorySidebarActiveSummary.textContent=`${slotText}  ${totalText}`;
    }else{
      inventorySidebarActiveSummary.textContent=`${fmtNumber(activeOrder.length)} active`;
    }
  }
  if(inventorySidebarActiveList){
    inventorySidebarActiveList.innerHTML='';
    activeOrder.forEach(label=>{
      const pill=document.createElement('li');
      pill.className='inventory-active-pill';
      const lower=label.toLowerCase();
      if(commonSet.has(lower)){
        pill.classList.add('inventory-active-pill--common');
        pill.title='Marked as common';
      }else{
        pill.title='Counts against active slots';
      }
      pill.textContent=label;
      inventorySidebarActiveList.appendChild(pill);
    });
    const hasActive=activeOrder.length>0;
    inventorySidebarActiveList.hidden=!hasActive;
    inventorySidebarActiveList.setAttribute('aria-hidden',hasActive?'false':'true');
    if(inventorySidebarActiveEmpty){
      inventorySidebarActiveEmpty.hidden=hasActive;
      inventorySidebarActiveEmpty.setAttribute('aria-hidden',hasActive?'true':'false');
    }
  }

  const consumableMap=buildConsumableInventory(key);
  const consumables=Array.from(consumableMap.entries())
    .map(([name,count])=>({ name, count:Number(count)||0 }))
    .filter(item=>item.count>0)
    .sort((a,b)=>a.name.localeCompare(b.name,undefined,{sensitivity:'base'}));
  const totalConsumables=consumables.reduce((sum,item)=>sum+item.count,0);
  if(inventorySidebarConsumableCount) inventorySidebarConsumableCount.textContent=fmtNumber(totalConsumables);
  renderInventorySidebarList(
    inventorySidebarConsumableList,
    consumables,
    'No consumables recorded.',
    {renderQuantity:true}
  );
}

function renderStats(key){
  renderInventorySidebar(key);
  if(isDmLogKey(key)){
    updateDmMeta();
    return;
  }
  const statsMap=(DATA && typeof DATA.stats==='object')?DATA.stats:{};
  const s=statsMap[key]||{};
  updateCharMeta(key);
  const goldVal=fmtNumber(s.net_gp||0);
  if(goldValueEl) goldValueEl.textContent=goldVal;
  if(goldMetricEl) goldMetricEl.setAttribute('aria-label', `Gold: ${goldVal} gold pieces total`);
  const dtdVal=fmtNumber(s.net_dtd||0);
  if(downtimeValueEl) downtimeValueEl.textContent=dtdVal;
  if(downtimeMetricEl) downtimeMetricEl.setAttribute('aria-label', `Downtime: ${dtdVal} downtime days total`);
  const permCount=Number(s.perm_count||0);
  const consCount=Number(s.cons_count||0);
  const giftsCount=Number(s.gifts_count||0);
  if(magicItemsCountEl) magicItemsCountEl.textContent=`${fmtNumber(permCount)} permanent items`;
  if(consumablesCountEl) consumablesCountEl.textContent=`${fmtNumber(consCount)} consumables`;
  if(giftsCountEl) giftsCountEl.textContent=`${fmtNumber(giftsCount)} supernatural gifts`;
  if(magicItemsBtn){
    const label=`View permanent magic items (${fmtNumber(permCount)} total)`;
    magicItemsBtn.setAttribute('aria-label',label);
    magicItemsBtn.title=label;
  }
  if(consumablesBtn){
    const label=`View consumables (${fmtNumber(consCount)} total)`;
    consumablesBtn.setAttribute('aria-label',label);
    consumablesBtn.title=label;
  }
  if(giftsBtn){
    const label=`View supernatural gifts (${fmtNumber(giftsCount)} total)`;
    giftsBtn.setAttribute('aria-label',label);
    giftsBtn.title=label;
  }
  if(giftsValueEl) giftsValueEl.textContent=fmtNumber(giftsCount);
  if(giftsMetricEl){
    giftsMetricEl.style.display='';
  }
}
function setHeader(key){
  if(avatarEl){
    avatarEl.classList.remove('avatar-hidden');
  }
  const override=getHeaderOverride();
  const multiActive=!isDmLogKey(key) && override && override.multi;
  applyMultiSearchHeaderState(multiActive);
  if(isDmLogKey(key)){
    setDmHeader();
    return;
  }
  const obj=DATA.characters[key];
  updateAvatar(key,obj);
  if(metaEl&&!obj){
    metaEl.textContent='';
    metaEl.style.display='none';
    metaEl.setAttribute('aria-hidden','true');
  }
  if(multiActive){
    if(metaEl){
      const text=override&&override.meta?override.meta:'';
      metaEl.textContent=text;
      const show=text.trim().length>0;
      metaEl.style.display=show?'block':'none';
      metaEl.setAttribute('aria-hidden',show?'false':'true');
    }
    if(badgesEl){
      badgesEl.innerHTML='';
      badgesEl.style.display='none';
      badgesEl.setAttribute('aria-hidden','true');
    }
    return;
  }
  if(!badgesEl) return;
  badgesEl.innerHTML='';
  if(!obj){
    badgesEl.style.display='none';
    badgesEl.setAttribute('aria-hidden','true');
    return;
  }
  const identity=extractCharacterIdentity(obj);
  const chips=[];
  if(identity.race){ chips.push(identityBadge('Race', identity.race)); }
  if(identity.classes){ chips.push(identityBadge('Classes', identity.classes)); }
  chips.forEach(chip=>badgesEl.appendChild(chip));
  const show=chips.length>0;
  badgesEl.style.display=show?'flex':'none';
  badgesEl.setAttribute('aria-hidden', show?'false':'true');
}

/* --- rendering --- */
function filterAndRender(options={}){
  const opts=(options && typeof options==='object')?options:{};
  const immediate=!!opts.immediate;
  if(immediate){
    if(pendingRenderFrame!=null){
      cancelAnimationFrame(pendingRenderFrame);
      pendingRenderFrame=null;
    }
    performFilterAndRender();
    return;
  }
  if(pendingRenderFrame!=null){
    return;
  }
  pendingRenderFrame=requestAnimationFrame(()=>{
    pendingRenderFrame=null;
    performFilterAndRender();
  });
}

function performFilterAndRender(){
  if(!charSel) return;
  let key=charSel.value;
  if(!isValidSheetKey(key)){
    const stored=getRememberedCharacterKey();
    if(isValidSheetKey(stored)){
      charSel.value=stored;
      key=stored;
    }
  }
  if(!isValidSheetKey(key)){
    const fallback=getMostRecentCharacter();
    if(isValidSheetKey(fallback)){
      charSel.value=fallback;
      key=fallback;
    }else if(hasDmLogData()){
      charSel.value=DM_LOG_KEY;
      key=DM_LOG_KEY;
    }else{
      rememberCharacterKey('');
      syncAdventureGrid([]);
      if(emptyEl){
        setEmptyStateMessage(defaultEmptyMessage);
        if(!isDataLoadErrorActive()){
          emptyEl.style.display='block';
        }
      }
      setHeaderOverride(null);
      syncCharacterSelectorUI();
      return;
    }
  }
  rememberCharacterKey(key);
  updateUiForSelection(key);
  if(isDmLogKey(key)){
    setHeaderOverride(null);
    syncCharacterSelectorUI();
    setEmptyStateMessage(DM_EMPTY_MESSAGE);
    renderDmLog();
    renderStats(key);
    setHeader(key);
    return;
  }
  if(!DATA || !DATA.characters){
    setHeaderOverride(null);
    syncCharacterSelectorUI();
    return;
  }
  if(pendingSearchInputHandle){
    clearTimeout(pendingSearchInputHandle);
    pendingSearchInputHandle=null;
  }
  setEmptyStateMessage(defaultEmptyMessage);
  const rawQuery=(qEl && typeof qEl.value==='string'?qEl.value:'');
  const normalizedQuery=rawQuery.toLowerCase();
  const activeQuery=normalizedQuery.trim();
  if(searchAllCharacters && activeQuery.length<MULTI_SEARCH_MIN_QUERY_LENGTH){
    syncAdventureGrid([]);
    if(emptyEl && !isDataLoadErrorActive()){
      setEmptyStateMessage(MULTI_SEARCH_PROMPT_TEXT);
      emptyEl.style.display='block';
    }
    setHeaderOverride(null);
    syncCharacterSelectorUI();
    renderStats(key);
    setHeader(key);
    return;
  }
  const decorated=searchAllCharacters?getAllAdventureEntries():getCharacterAdventureEntries(key);
  const filtered=decorated.filter((entry)=>{
    const adv=entry && entry.adv;
    if(!adv) return false;
    if(!showActivities && isActivityEntry(adv)) return false;
    if(!activeQuery) return true;
    const blob=typeof entry.searchBlob==='string'?entry.searchBlob:'';
    return blob.indexOf(activeQuery)!==-1;
  });
  syncAdventureGrid(filtered);
  if(!filtered.length){
    if(!isDataLoadErrorActive()&&emptyEl){ emptyEl.style.display='block'; }
  }else{
    if(!isDataLoadErrorActive()&&emptyEl){ emptyEl.style.display='none'; }
  }
  const visibleKeys=new Set(filtered.map(item=>item.charKey).filter(Boolean));
  let override=null;
  if(searchAllCharacters){
    const count=visibleKeys.size;
    const countLabel=fmtNumber(count);
    const plural=count===1?'character':'characters';
    const hasResults=count>0;
    const entryCount=filtered.length;
    const entryLabel=fmtNumber(entryCount);
    const entryPlural=entryCount===1?'entry':'entries';
    const meta=hasResults
      ?`Showing ${entryLabel} ${entryPlural} from ${countLabel} ${plural}`
      :'Searching across all characters';
    override={
      label:'',
      meta,
      title:meta,
      multi:true
    };
  }
  setHeaderOverride(override);
  syncCharacterSelectorUI();
  renderStats(key);
  setHeader(key);
}

/* --- events --- */
if(qEl){
  const handleSearchInput=()=>{
    updateSearchClearButton();
    if(pendingSearchInputHandle){
      clearTimeout(pendingSearchInputHandle);
    }
    pendingSearchInputHandle=setTimeout(()=>{
      pendingSearchInputHandle=null;
      filterAndRender();
    }, SEARCH_INPUT_DEBOUNCE_MS);
  };
  qEl.addEventListener('input', handleSearchInput);
  updateSearchClearButton();
}
if(qEl && searchClearBtn){
  searchClearBtn.addEventListener('click',()=>{
    if(qEl.value){
      qEl.value='';
    }
    updateSearchClearButton();
    if(pendingSearchInputHandle){
      clearTimeout(pendingSearchInputHandle);
      pendingSearchInputHandle=null;
    }
    filterAndRender();
    try{ qEl.focus({preventScroll:true}); }
    catch(err){ qEl.focus(); }
  });
}
if(searchScopeToggleBtn){
  searchScopeToggleBtn.addEventListener('click',()=>{
    searchAllCharacters=!searchAllCharacters;
    persistSearchScope();
    updateSearchScopeToggle();
    filterAndRender();
  });
}
if(dataQualityReviewBtn){
  dataQualityReviewBtn.addEventListener('click',()=>{
    openDataQualityModal();
  });
}
if(dataQualityCloseBtn){
  dataQualityCloseBtn.addEventListener('click',()=>{
    closeDataQualityModal();
  });
}
if(dataQualityValidateBtn){
  dataQualityValidateBtn.addEventListener('click',()=>{
    runDataValidation();
  });
}
if(dataQualityModal){
  dataQualityModal.addEventListener('click',(event)=>{
    if(event.target===dataQualityModal){
      closeDataQualityModal();
    }
  });
  dataQualityModal.addEventListener('keydown',(event)=>{
    if(event.key==='Escape'){
      closeDataQualityModal();
    }
  });
}
if(charSel){
  charSel.addEventListener('change',()=>{
    syncCharacterSelectorUI();
    filterAndRender();
    recordCharacterView({charKey:charSel.value});
  });
}
if(charSelToggle){
  charSelToggle.addEventListener('click',(event)=>{
    event.preventDefault();
    toggleCharMenu();
  });
  charSelToggle.addEventListener('keydown',(event)=>{
    if(event.key==='ArrowDown'){
      event.preventDefault();
      openCharMenu();
    }else if(event.key==='ArrowUp'){
      event.preventDefault();
      openCharMenu({focusLast:true});
    }else if(event.key==='Enter' || event.key===' '){
      event.preventDefault();
      toggleCharMenu();
    }
  });
}
if(charSelMenu){
  charSelMenu.addEventListener('keydown',(event)=>{
    const items=getCharMenuItems();
    if(!items.length) return;
    const currentIndex=items.indexOf(document.activeElement);
    if(event.key==='ArrowDown'){
      event.preventDefault();
      const nextIndex=currentIndex>=0?((currentIndex+1)%items.length):0;
      const target=items[nextIndex];
      focusCharMenuItem(target||items[0]);
    }else if(event.key==='ArrowUp'){
      event.preventDefault();
      const prevIndex=currentIndex>=0?((currentIndex-1+items.length)%items.length):items.length-1;
      const target=items[prevIndex]||items[items.length-1];
      focusCharMenuItem(target);
    }else if(event.key==='Home'){
      event.preventDefault();
      focusCharMenuItem(items[0]);
    }else if(event.key==='End'){
      event.preventDefault();
      focusCharMenuItem(items[items.length-1]);
    }else if(event.key==='Escape'){
      event.preventDefault();
      closeCharMenu({focusToggle:true});
    }else if(event.key==='Tab'){
      closeCharMenu();
    }else if(event.key==='Enter' || event.key===' '){
      const target=event.target && event.target.closest ? event.target.closest('.char-menu-item') : null;
      if(target){
        event.preventDefault();
        target.click();
      }
    }
  });
}
syncCharacterSelectorUI();
if(dmItemsBtnEl){
  dmItemsBtnEl.addEventListener('click',()=>{
    const isOpen=dmItemsModal && dmItemsModal.classList.contains('open');
    if(isOpen){
      closeDmItemsModal();
    }else{
      openDmItemsModal();
    }
  });
}
if(dmItemsCloseBtn){
  dmItemsCloseBtn.addEventListener('click',()=>{
    closeDmItemsModal();
  });
}
if(dmItemsModal){
  dmItemsModal.addEventListener('click',(event)=>{
    if(event.target===dmItemsModal){
      closeDmItemsModal();
    }
  });
}
document.addEventListener('click',(event)=>{
  if(isMenuOpen(addCardMenu)){
    const withinMenu=addCardMenu.contains(event.target);
    const withinButton=addCardBtn && addCardBtn.contains(event.target);
    if(!withinMenu && !withinButton){
      closeAddMenu();
    }
  }
  if(isMenuOpen(charSelMenu)){
    const withinMenu=charSelMenu.contains(event.target);
    const withinToggle=charSelToggle && charSelToggle.contains(event.target);
    if(!withinMenu && !withinToggle){
      closeCharMenu();
    }
  }
});
document.addEventListener('keydown',(event)=>{
  if(event.key==='Escape'){
    let handled=false;
    if(isMenuOpen(addCardMenu)){
      closeAddMenu();
      handled=true;
    }
    if(isMenuOpen(charSelMenu)){
      closeCharMenu({focusToggle:true});
      handled=true;
    }
    if(dmItemsModal && dmItemsModal.classList.contains('open')){
      closeDmItemsModal();
      handled=true;
    }
    if(tradeModal && tradeModal.classList.contains('open')){
      closeTradeModal();
      handled=true;
    }
    if(handled){
      event.stopPropagation();
    }
  }
});
if(activityToggleBtn){
  activityToggleBtn.addEventListener('click',()=>{
    showActivities=!showActivities;
    persistActivityVisibility();
    updateActivityToggle();
    filterAndRender();
  });
}
/* --- init --- */
function initApp(){
  DATA=window.DATA||null;
  if(!DATA || !DATA.characters){
    showDataLoadError('Could not load <code>data.js</code>.');
    return false;
  }
  clearDataLoadError();
  refreshAllDerivedData();
  if(emptyEl){
    emptyEl.style.display='none';
  }
  updateActivityToggle();
  updateSearchScopeToggle();
  const historyState=parseHistoryStateFromLocation();
  let initialKey=rebuildCharacterOptions({preserveSelection:false})||getMostRecentCharacter();
  if(historyState && historyState.charKey){
    const desired=normalizeHistoryCharKey(historyState.charKey);
    if(desired){
      initialKey=desired;
    }
  }
  if(initialKey && charSel){
    charSel.value=initialKey;
  }
  filterAndRender({immediate:true});
  scheduleAvatarPreload();
  const activeChar=normalizeHistoryCharKey(getActiveCharacterKey())||normalizeHistoryCharKey(initialKey);
  const hasEntryState=historyState && (historyState.entryType==='adventure'||historyState.entryType==='dm') && historyState.entryId!=null;
  if(historySupported){
    const normalized=buildHistoryState({
      charKey:activeChar,
      entryType:hasEntryState?historyState.entryType:null,
      entryId:hasEntryState?historyState.entryId:null
    });
    lastHistoryState=normalized;
    const url=historyUrlForState(normalized);
    window.history.replaceState(normalized,'',url);
  }else{
    lastHistoryState=buildHistoryState({
      charKey:activeChar,
      entryType:hasEntryState?historyState.entryType:null,
      entryId:hasEntryState?historyState.entryId:null
    });
  }
  if(hasEntryState){
    focusEntryFromState({
      charKey:activeChar,
      entryType:historyState.entryType,
      entryId:historyState.entryId
    },{suppressHistoryPush:true});
  }
  if(pendingChanges){
    updateSaveIndicatorState();
  }else{
    clearDirty();
  }
  return true;
}

let __appInitialized=false;
function ensureAppInitialized(){
  if(__appInitialized) return;
  __appInitialized=initApp();
}

function tryInitApp(){
  const usedDraft=applyDraftIfAvailable({force:pendingChanges || hasLocalDraft});
  if(window.DATA && window.DATA.characters){
    if(!dataNormalized){
      adoptDataPayload(window.DATA);
    }
    const wasInitialized=__appInitialized;
    DATA=window.DATA;
    ensureAppInitialized();
    if(usedDraft && wasInitialized){
      refreshAllDerivedData();
      rebuildCharacterOptions({preserveSelection:true});
      filterAndRender();
      scheduleAvatarPreload();
    }
    return __appInitialized;
  }
  return false;
}

updateDataQualityBanner();

if(!tryInitApp()){
  if(dataScriptEl){
    const onLoad=()=>{
      if(!tryInitApp()){
        showDataLoadError('Could not load <code>data.js</code>.');
      }
    };
    dataScriptEl.addEventListener('load', onLoad, {once:true});
    dataScriptEl.addEventListener('error',()=>{
      showDataLoadError('Could not load <code>data.js</code>.');
    },{once:true});
    const state=dataScriptEl.readyState;
    if(state==='loaded'||state==='complete'){
      tryInitApp();
    }
    [0,50,200].forEach(delay=>{ setTimeout(()=>{ tryInitApp(); },delay); });
  }else{
    showDataLoadError('Could not load <code>data.js</code>.');
  }
}

/* prevent accidental jump-to-top for href="#" */
document.addEventListener('click',(e)=>{ const a=e.target.closest('a[href="#"]'); if(a) e.preventDefault(); },{passive:true});

if(addCardBtn){
  addCardBtn.addEventListener('click',()=>{
    if(isMenuOpen(addCardMenu)){
      closeAddMenu();
    }else{
      openAddMenu();
    }
  });
}
</script>
</body>
</html>
