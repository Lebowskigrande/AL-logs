<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Adventure Log Dashboard</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg"/>
<link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"/>
<link rel="shortcut icon" href="favicon.ico"/>
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"/>
<link rel="manifest" href="site.webmanifest"/>
<style>
:root{
  --bg:#f6f8fb; --surface:#fff; --ink:#0f172a; --muted:#64748b; --primary:#1a73e8; --border:#e5eaf3;
  --radius:16px; --shadow1:0 2px 10px rgba(16,24,40,.06); --shadow2:0 20px 40px rgba(16,24,40,.12);
  --dur:220ms; --ease:cubic-bezier(.2,.8,.2,1); --gap:14px; --min-card:320px;
  --danger:#dc2626;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg);scrollbar-gutter:stable}
.container{max-width:1200px;margin:28px auto 80px;padding:0 20px 120px}
.header{position:relative;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow1);padding-right:76px}
.row{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
.avatar{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,var(--primary),#34a853);box-shadow:var(--shadow1)}
h1{margin:0;font-size:28px;line-height:1.05;font-weight:800;letter-spacing:-0.01em}
.header-main{display:flex;flex-direction:column;gap:6px;min-width:0;flex:1 1 auto}
.title-select-wrap{display:inline-flex;align-items:center;gap:10px;position:relative;padding-right:22px;max-width:100%}
.title-select-wrap::after{content:"";width:12px;height:8px;clip-path:polygon(0 0,100% 0,50% 100%);background:currentColor;opacity:.55;transition:opacity var(--dur) var(--ease),transform var(--dur) var(--ease);pointer-events:none;position:absolute;right:0;top:50%;transform:translateY(-50%)}
.title-select-wrap:focus-within::after{opacity:1;transform:translateY(-40%)}
.title-select{appearance:none;border:none;background:transparent;font:inherit;color:var(--ink);padding:0;margin:0;cursor:pointer;line-height:1.1;font-weight:800;letter-spacing:-0.01em;max-width:100%}
.title-select:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:2px;border-radius:6px}
.title-select option{color:var(--ink)}
.char-badges{margin-top:4px;display:none;gap:8px;flex-wrap:wrap;align-items:center}
.char-badges .identity-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#eef4ff;color:#1e293b;font-weight:600;font-size:12px}
.char-badges .identity-badge .label{font-size:10px;letter-spacing:.08em;text-transform:uppercase;color:#64748b}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.muted{color:var(--muted);font-size:13px}

/* Toolbar */
.toolbar{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
.select,.btn,.search input{border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 12px;font-weight:600;box-shadow:var(--shadow1)}
.btn{cursor:pointer;transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.btn:hover{transform:translateY(-1px);box-shadow:var(--shadow2)}
.btn.primary{background:var(--primary);color:#fff;border-color:transparent}
.btn-icon{display:inline-flex;align-items:center;justify-content:center;margin-right:6px}
.btn-icon svg{width:14px;height:14px}
.btn.danger{border:1px solid rgba(220,38,38,.2);background:rgba(254,226,226,1);color:var(--danger);}
.btn.danger:hover{background:#fecaca;border-color:rgba(220,38,38,.35)}
.btn.small{padding:6px 10px;font-size:12px;border-radius:10px;display:inline-flex;align-items:center;gap:6px}
.search{position:relative}
.search input{padding-left:36px;outline:none}
.search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:18px;height:18px;opacity:.6}
.toolbar .spacer{flex:1 1 auto}

.icon-btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:#fff;color:var(--muted);cursor:pointer;transition:background var(--dur) var(--ease),color var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.icon-btn svg{width:14px;height:14px;pointer-events:none}
.icon-btn:hover{color:var(--primary);background:#eef4ff;box-shadow:var(--shadow1)}
.icon-btn.danger{border-color:rgba(220,38,38,.2);background:#fee2e2;color:var(--danger)}
.icon-btn.danger:hover{color:#991b1b;background:#fecaca;box-shadow:var(--shadow1)}
.icon-btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.icon-btn.primary:hover{box-shadow:var(--shadow2)}
.icon-btn[disabled]{opacity:.5;cursor:not-allowed;box-shadow:none;background:#f1f5f9;color:#94a3b8}
.download-btn{position:absolute;top:16px;right:16px;width:40px;height:40px;border-radius:12px;box-shadow:var(--shadow1);color:var(--muted);background:#fff}
.download-btn svg{width:18px;height:18px}
.download-btn::after{content:"";position:absolute;top:8px;right:8px;width:8px;height:8px;border-radius:50%;background:var(--primary);opacity:0;transform:scale(.6);transition:opacity var(--dur) var(--ease),transform var(--dur) var(--ease)}
.download-btn:hover{box-shadow:var(--shadow2)}
.download-btn.dirty{color:#fff;background:var(--primary);border-color:var(--primary)}
.download-btn.dirty:hover{background:var(--primary);color:#fff}
.download-btn.dirty::after{opacity:1;transform:scale(1)}
.download-btn:focus-visible{outline:2px solid rgba(26,115,232,.35);outline-offset:2px}

/* Stats */
.stats{display:flex;gap:10px;flex-wrap:wrap}
.stat{background:#f9fafb;border:1px solid var(--border);border-radius:12px;padding:12px;min-width:100px;flex:1 1 140px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;text-align:center}
@media (max-width:480px){
  .stats{justify-content:space-between}
  .stat{padding:10px;flex:1 1 calc((100% - 20px)/3);max-width:calc((100% - 20px)/3);min-width:0}
}
.stat .k{font-weight:700;font-size:18px}
.stat .v{color:var(--muted);font-size:12px}

/* Grid / masonry columns */
.grid{margin-top:24px}
.grid.cols{display:flex;gap:var(--gap);align-items:flex-start}
.grid.cols .col{display:flex;flex-direction:column;gap:var(--gap);flex:1 1 0;min-width:var(--min-card)}

/* Card */
.card{display:block;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow1);overflow:hidden;transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
.card:hover{transform:translateY(-3px);box-shadow:var(--shadow2)}
.card-hd{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:14px;cursor:pointer;min-height:96px}
.card-hd .card-tools{display:flex;align-items:center;gap:6px}
.card .card-tools .icon-btn{opacity:0;visibility:hidden;pointer-events:none;transform:translateY(-4px);transition:opacity var(--dur) var(--ease),transform var(--dur) var(--ease)}
.card:hover .card-tools .icon-btn,
.card.open .card-tools .icon-btn,
.card.editing .card-tools .icon-btn,
.card .card-tools .icon-btn:focus-visible{opacity:1;visibility:visible;pointer-events:auto;transform:translateY(0)}
.card.editing .card-hd{cursor:default}
.card.editing{border-color:rgba(26,115,232,.35);box-shadow:0 0 0 2px rgba(26,115,232,.08)}
.titleLine{display:flex;flex-direction:column}
.date{color:var(--muted);line-height:16px}
.title{font-weight:700;line-height:20px;height:20px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}
.subtitle{color:var(--muted);font-size:12px;margin-top:2px;line-height:16px;min-height:16px}
.chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;min-height:22px}
.pill{background:#fff7e6;color:#a05a00;border:1px solid #ffe3b0;border-radius:999px;padding:4px 8px;font-weight:700;font-size:11px}

/* Collapsible */
.card-bd{height:0;overflow:hidden;border-top:1px solid var(--border);transition:height var(--card-dur,var(--dur)) var(--ease),opacity var(--card-dur,var(--dur)) linear;padding:0 14px;opacity:0;will-change:height,opacity;contain:layout paint}
.bd-in{padding:12px 0 16px}
.edit-form{padding:12px 0 16px;display:none}
.card.editing .edit-form{display:block}
.card.editing .bd-in{display:none}
@media (prefers-reduced-motion:reduce){.card-bd{transition:none}}

/* Fields */
.field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
.field .k{color:var(--muted);font-size:12px;font-weight:400}
.field .v{width:100%}
.field input,.field textarea,.field select{font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;resize:vertical}
.field textarea{min-height:80px}
.kv2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:8px 0}
.kvsingle{display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;margin:6px 0}
.kvsingle .k{color:var(--muted);font-size:12px;font-weight:400}
.kvsingle .v{font-weight:400}
.scrollbox{background:#f9fafb;border:1px dashed var(--border);border-radius:12px;padding:10px;max-height:160px;overflow:auto}
.scrollbox .item{margin:2px 0}
.notesbox{background:#f9fafb;border:1px solid var(--border);border-radius:12px;padding:10px;max-height:160px;overflow:auto}
.empty{text-align:center;color:var(--muted);padding:40px 0}
.list-editor{display:flex;flex-direction:column;gap:8px}
.list-editor .list{display:flex;flex-direction:column;gap:8px}
.list-editor .list-row{display:flex;align-items:center;gap:8px}
.list-editor .list-row input{flex:1 1 auto;font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;min-width:0}
.list-editor .list-row button{width:32px;height:32px;border-radius:10px;border:1px solid rgba(220,38,38,.25);background:#fee2e2;color:var(--danger);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background var(--dur) var(--ease),color var(--dur) var(--ease)}
.list-editor .list-row button:hover{background:#fecaca;color:#991b1b}
.list-editor .list-row button svg{width:16px;height:16px}
.list-editor .add-row{align-self:flex-start;border:1px dashed var(--border);background:#f8fafc;color:var(--primary);border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}
.list-editor .add-row:hover{background:#eef4ff}
.edit-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
.edit-actions .delete-btn{margin-right:auto}

.edit-form form{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.edit-form .field{margin:0}
.edit-form .field.full{grid-column:1 / -1}
.edit-form .field .v input,.edit-form .field .v select,.edit-form .field .v textarea{width:100%}
.edit-form input[type=number]{max-width:140px}
.edit-form .kv2{grid-column:1 / -1;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:0}
.edit-form .kv2 .kvsingle{margin:0}
.edit-form .kv2 .v{display:flex}
.edit-form .kv2 .v input{flex:1 1 auto}
.edit-form .list-editor{grid-column:1 / -1}
.edit-form .edit-actions{grid-column:1 / -1;margin-top:4px}

body.modal-open{overflow:hidden;}
body.modal-open #addCard{display:none;}

#addCard{
  position:fixed;
  bottom:24px;
  right:24px;
  width:64px;
  height:64px;
  border-radius:50%;
  border:none;
  background:linear-gradient(135deg,#ff8a5c,#ff3d71);
  color:#fff;
  box-shadow:0 16px 30px rgba(255,61,113,.35);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease);
  z-index:60;
}
#addCard svg{width:28px;height:28px}
#addCard:hover{transform:translateY(-2px);box-shadow:0 24px 40px rgba(255,61,113,.45)}
#addCard:focus-visible{outline:3px solid rgba(255,61,113,.4);outline-offset:4px}
.toolbar #addCard{margin-left:auto}

/* Activity cards (compact header) */
.card.activity{background:#f7f8fa;border-color:#e6e9f2}
.card.activity .card-hd{padding:6px 12px;min-height:44px;display:flex;align-items:center}
.activity-line{display:flex;align-items:center;justify-content:space-between;flex-wrap:nowrap;width:100%;gap:8px}
.activity-left{display:flex;align-items:center;gap:6px;min-width:0;flex:1 1 auto;white-space:nowrap}
.activity-date{font-size:12px;line-height:16px;color:var(--muted)}
.activity-name{font-weight:600;font-size:14px;line-height:18px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.card.activity .chips{display:flex;flex:0 0 auto;align-items:center;gap:6px;margin:0;white-space:nowrap}
.card.activity .pill{height:22px;line-height:22px;padding:0 8px;max-width:160px;overflow:hidden;text-overflow:ellipsis}
.pill.muted{background:#eef1f6;color:#475569;border-color:#dce2ee}

/* Modals (shared) */
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(15,23,42,.4);z-index:50}
.modal.open{display:grid}
.modal-card{width:min(92vw,800px);max-height:80vh;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow2);display:flex;flex-direction:column;overflow:hidden}
.modal-hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700;display:flex;align-items:center;justify-content:space-between;gap:8px}
.modal-body{padding:12px 16px;overflow:auto}
.modal-actions{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
.inv-meta{color:var(--muted);font-size:12px}
.inv-list{display:flex;flex-direction:column;gap:6px}
.modal-add{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.modal-add input,.modal-add select{font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
.modal-add button{border:1px solid var(--primary);background:rgba(26,115,232,.1);color:var(--primary);border-radius:10px;padding:8px 14px;font-weight:600;cursor:pointer}
.modal-add button:hover{background:rgba(26,115,232,.2)}

/* Inventory row styles */
.inv-row{display:grid;grid-template-columns:1fr auto;align-items:center;padding:6px 10px;border-radius:8px;cursor:pointer;transition:background .2s}
.inv-row:nth-child(odd){background:#fafbfc}
.inv-row:nth-child(even){background:#f2f5f8}
.inv-row.active{background:#e8f0ff;font-weight:600}
.inv-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.inv-tools{display:flex;align-items:center;gap:6px}
.inv-row .delete-btn{display:none;margin-left:8px}
.modal.editing .inv-row{cursor:default}
.modal.editing .inv-row .delete-btn{display:inline-flex}
.modal.editing .inv-row .attune-pill{pointer-events:none;opacity:.6}
.modal.editing .inv-row .qty-btn{pointer-events:none;opacity:.6}
.modal.editing .inv-row .qty-pill{opacity:.6}

/* Attunement pill (perm modal, active rows only) */
.attune-pill{display:inline-block;border:1px solid #cfe0ff;background:#eef4ff;color:#1a73e8;border-radius:999px;padding:2px 8px;font-size:11px;user-select:none;cursor:pointer;transition:background .2s,color .2s}
.attune-pill.on{background:#1a73e8;color:#fff}

/* Consumables qty controls */
.inv-row .qty{display:flex;align-items:center;gap:6px;white-space:nowrap}
.qty-pill{display:inline-block;min-width:28px;padding:2px 8px;text-align:center;border:1px solid var(--border);border-radius:999px;background:#f9fafb;font-size:11px;color:#475569}
.qty-input{width:64px;padding:4px 8px;border:1px solid var(--border);border-radius:10px;font:inherit;font-size:12px;text-align:center;background:#fff}
.qty-btn{border:1px solid #dbe4f3;background:#eef4ff;color:#1a73e8;border-radius:999px;padding:2px 8px;font-size:11px;cursor:pointer;min-width:28px;display:inline-flex;align-items:center;justify-content:center}
.qty-btn.plus{background:#1a73e8;color:#fff;border-color:#1a73e8}

/* Reduce scroll anchoring jumps */
html,body,.grid,.grid .col,.card-bd{overflow-anchor:none}

/* New entry overlay */
.card-overlay{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(15,23,42,.4);backdrop-filter:blur(2px);z-index:70;padding:48px 16px;overflow:auto}
.card-overlay.open{display:flex}
.card-overlay .card{max-width:720px;width:100%;box-shadow:var(--shadow2);margin:0 auto}
.card-overlay .card .card-tools{display:none}
</style>
</head>
<body>
<div class="container">
  <section class="header">
    <div class="row">
      <div class="avatar" aria-hidden="true"></div>
      <div class="header-main">
        <h1 class="title-select-wrap" id="charTitle">
          <label for="charSel" class="sr-only">Select a sheet or character</label>
          <select id="charSel" class="title-select"></select>
        </h1>
        <div id="charBadges" class="char-badges" aria-live="polite"></div>
      </div>
      <button id="downloadData" class="icon-btn download-btn" title="Download adventure log JSON" aria-label="Download adventure log JSON">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="m7 12 5 5 5-5"/><path d="M5 21h14"/></svg>
      </button>
    </div>
    <div class="toolbar">
      <div class="search">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/></svg>
        <input id="q" placeholder="Search adventures (name, code, notes, DM)"/>
      </div>
      <button id="expandAll" class="btn">Expand All</button>
      <button id="collapseAll" class="btn">Collapse All</button>
      <button id="addCard" class="icon-btn" title="Add new adventure" aria-label="Add new adventure">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
      </button>
    </div>
    <div class="stats" id="stats" style="margin-top:10px;"></div>
  </section>
  <section id="grid" class="grid cols"></section>
  <div id="empty" class="empty" style="display:none;">No adventures match your filters.</div>
</div>

<!-- Permanent Items Modal -->
<div id="invModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="invTitle">
  <div class="modal-card">
    <div class="modal-hd">
      <div id="invTitle">Permanent Magic Items</div>
      <div class="inv-meta" id="invMeta"></div>
    </div>
    <div class="modal-body">
      <div id="invSummary" class="inv-meta" style="margin-bottom:8px;"></div>
      <div id="invList" class="inv-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="invClose">Close</button>
    </div>
  </div>
</div>

<!-- Consumables Modal -->
<div id="consModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="consTitle">
  <div class="modal-card">
    <div class="modal-hd">
      <div id="consTitle">Consumables</div>
      <div class="inv-meta" id="consMeta"></div>
    </div>
    <div class="modal-body">
      <div id="consSummary" class="inv-meta" style="margin-bottom:8px;"></div>
      <div id="consList" class="inv-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn primary" id="consSave" style="display:none;">Save data.js</button>
      <button class="btn" id="consClose">Close</button>
    </div>
  </div>
</div>

<div id="cardOverlay" class="card-overlay" role="dialog" aria-modal="true" aria-hidden="true"></div>

<script src="data.js"></script>
<script>
/* --- data boot --- */
const DATA = window.DATA || null;
if (!DATA || !DATA.characters) {
  const e = document.getElementById('empty');
  e.style.display='block'; e.innerHTML='Could not load <code>data.js</code>.'; throw new Error('DATA missing');
}

/* --- DOM handles --- */
const charSel  = document.getElementById('charSel');
const downloadBtn = document.getElementById('downloadData');
const qEl      = document.getElementById('q');
const grid     = document.getElementById('grid');
const emptyEl  = document.getElementById('empty');
const statsEl  = document.getElementById('stats');
const badgesEl = document.getElementById('charBadges');
const addCardBtn = document.getElementById('addCard');
const cardOverlay=document.getElementById('cardOverlay');
let overlayCard=null;
const ICON_TRASH='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-14"/></svg>';

let pendingChanges=false;

function updateDownloadState(){
  if(!downloadBtn) return;
  const label=pendingChanges?'Download updated data.js':'Download adventure log JSON';
  downloadBtn.classList.toggle('dirty',pendingChanges);
  downloadBtn.setAttribute('aria-label',label);
  downloadBtn.title=label;
}

function anyModalOpen(){
  return (invModal && invModal.classList.contains('open'))
    || (consModal && consModal.classList.contains('open'))
    || (cardOverlay && cardOverlay.classList.contains('open'));
}

function refreshModalState(){
  if(anyModalOpen()){ document.body.classList.add('modal-open'); }
  else{ document.body.classList.remove('modal-open'); }
}

function openCardOverlay(card){
  if(!cardOverlay || !card) return;
  cardOverlay.innerHTML='';
  cardOverlay.appendChild(card);
  cardOverlay.classList.add('open');
  cardOverlay.setAttribute('aria-hidden','false');
  overlayCard=card;
  refreshModalState();
}

function closeCardOverlay(){
  if(!cardOverlay) return;
  cardOverlay.classList.remove('open');
  cardOverlay.setAttribute('aria-hidden','true');
  overlayCard=null;
  cardOverlay.innerHTML='';
  refreshModalState();
}

function markDirty(){
  pendingChanges=true;
  updateDownloadState();
}
function clearDirty(){
  pendingChanges=false;
  updateDownloadState();
}
function downloadFile(name,mime,content){
  const link=document.createElement('a');
  link.href=`data:${mime};charset=utf-8,`+encodeURIComponent(content);
  link.download=name;
  link.click();
}

/* --- character selector (no session counts) --- */
Object.entries(DATA.characters).forEach(([key,obj])=>{
  const opt=document.createElement('option');
  const disp=(obj.display_name&&obj.display_name!==key)?(obj.display_name+' ('+obj.sheet+')'):obj.sheet;
  opt.value=key; opt.textContent=disp; charSel.appendChild(opt);
});

/* --- utils --- */
function fmtDate(iso){ if(!iso)return'—'; const d=new Date(iso); if(isNaN(d))return String(iso); return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }
function fmtNumber(n,{signed=false}={}){
  if(n==null) return '0';
  const num=Number(n);
  if(!Number.isFinite(num)) return String(n);
  let rounded=Math.round(num*100)/100;
  if(Object.is(rounded,-0)) rounded=0;
  const formatted=rounded.toLocaleString(undefined,{maximumFractionDigits:2});
  if(signed){
    if(rounded===0) return '0';
    if(rounded>0) return '+'+formatted;
  }
  return formatted;
}
function pill(label){ const s=document.createElement('span'); s.className='pill'; s.textContent=label; return s; }
function formatRace(value){
  if(!value) return '';
  if(Array.isArray(value)){
    return value.map(formatRace).filter(Boolean).join(' / ');
  }
  if(typeof value==='object'){
    const parts=[];
    if(value.lineage) parts.push(String(value.lineage));
    if(value.race) parts.push(String(value.race));
    if(value.ancestry) parts.push(String(value.ancestry));
    if(value.subrace) parts.push(String(value.subrace));
    if(value.variant) parts.push(String(value.variant));
    if(value.name && !parts.length) parts.push(String(value.name));
    return parts.filter(Boolean).join(' ');
  }
  return String(value);
}
function formatClassEntry(entry){
  if(!entry) return '';
  if(typeof entry==='string') return entry;
  if(typeof entry==='number') return String(entry);
  if(Array.isArray(entry)){
    return entry.map(formatClassEntry).filter(Boolean).join(' / ');
  }
  const parts=[];
  if(entry.name) parts.push(String(entry.name));
  if(entry.subclass) parts.push(String(entry.subclass));
  if(entry.level!=null && entry.level!=='') parts.push(String(entry.level));
  if(entry.title && !parts.length) parts.push(String(entry.title));
  return parts.filter(Boolean).join(' ');
}
function formatClasses(value){
  if(!value) return '';
  if(Array.isArray(value)){
    return value.map(formatClassEntry).filter(Boolean).join(' / ');
  }
  if(typeof value==='object'){
    return formatClassEntry(value);
  }
  return String(value);
}
function extractCharacterIdentity(obj){
  const identity={race:'',classes:''};
  if(!obj) return identity;
  const sheet=obj.sheet;
  if(sheet && typeof sheet==='object'){
    identity.race = identity.race || formatRace(sheet.race || sheet.ancestry || sheet.lineage);
    identity.classes = identity.classes || formatClasses(sheet.classes || sheet.class || sheet.archetype);
  }
  if((!identity.race || !identity.classes) && Array.isArray(obj.adventures)){
    const source=obj.adventures.find(entry=>entry && typeof entry.character==='object');
    if(source && source.character){
      const ch=source.character;
      identity.race = identity.race || formatRace(ch.race || ch.ancestry || ch.lineage);
      identity.classes = identity.classes || formatClasses(ch.classes || ch.class || ch.archetype);
    }
  }
  if(typeof obj.identity==='object'){
    identity.race = identity.race || formatRace(obj.identity.race || obj.identity.ancestry);
    identity.classes = identity.classes || formatClasses(obj.identity.classes || obj.identity.class);
  }
  return {
    race:identity.race && identity.race.trim()?identity.race.trim():'',
    classes:identity.classes && identity.classes.trim()?identity.classes.trim():''
  };
}
function identityBadge(label,value){
  const chip=document.createElement('span');
  chip.className='identity-badge';
  const labelEl=document.createElement('span');
  labelEl.className='label';
  labelEl.textContent=label;
  const valueEl=document.createElement('span');
  valueEl.className='value';
  valueEl.textContent=value;
  chip.append(labelEl,valueEl);
  return chip;
}
function sanitizeTitle(title){
  if(!title) return '';
  return String(title).replace(/\bdown\s*time\s*activity\b/gi,'').replace(/\s{2,}/g,' ').replace(/^[\s:,.–—-]+|[\s:,.–—-]+$/g,'').trim();
}
function listBox(items){
  const wrap=document.createElement('div'); wrap.className='scrollbox';
  if(!items||!items.length){ wrap.innerHTML='<div class="muted">—</div>'; return wrap; }
  items.forEach(name=>{ const row=document.createElement('div'); row.className='item'; row.textContent='• '+String(name); wrap.appendChild(row); });
  return wrap;
}
function getMostRecentCharacter(){
  let latestKey=null, latestDate=0;
  for (const [key,obj] of Object.entries(DATA.characters)){
    if(!obj.adventures||!obj.adventures.length) continue;
    const maxDate=Math.max(...obj.adventures.map(a=>{ const t=new Date(a.date).getTime(); return isNaN(t)?0:t; }));
    if(maxDate>latestDate){ latestDate=maxDate; latestKey=key; }
  }
  return latestKey || Object.keys(DATA.characters)[0];
}
function isActivityEntry(a){ return a && a.kind && a.kind!=='adventure'; }
function netVals(a){ return { gp:(+a.gp_plus||0)-(+a.gp_minus||0), dtd:(+a.dtd_plus||0)-(+a.dtd_minus||0) }; }
function fmtSigned(n){ return fmtNumber(n,{signed:true}); }

/* --- smooth expand/collapse --- */
function isAnimating(card){ return card.dataset.anim==='1'; }
function setAnimating(card,on){ if(on) card.dataset.anim='1'; else delete card.dataset.anim; }
function afterTransition(el,prop,ms,cb){ let done=false; const onEnd=e=>{ if(e.propertyName!==prop||done)return; done=true; el.removeEventListener('transitionend',onEnd); cb(); }; el.addEventListener('transitionend',onEnd); setTimeout(()=>{ if(done)return; done=true; el.removeEventListener('transitionend',onEnd); cb(); },ms); }
function calcCardDuration(px){ if(!px||px<=0) return 220; const dur=200+px*0.35; return Math.round(Math.max(220, Math.min(620, dur))); }
function setCardDuration(bd,px){ const dur=calcCardDuration(px); bd.style.setProperty('--card-dur', dur+'ms'); return dur; }
function clearCardDuration(bd){ bd.style.removeProperty('--card-dur'); }
function expandCard(card){ if(isAnimating(card))return; const bd=card.querySelector('.card-bd'); if(!bd)return; setAnimating(card,true); const start=bd.offsetHeight||0; const target=Math.max(bd.scrollHeight, start); const duration=setCardDuration(bd,target); bd.style.height=start+'px'; bd.style.opacity='0'; card.classList.add('open'); void bd.offsetHeight; requestAnimationFrame(()=>{ bd.style.height=target+'px'; bd.style.opacity='1'; }); afterTransition(bd,'height',duration+100,()=>{ bd.style.height='auto'; clearCardDuration(bd); setAnimating(card,false); columnizeGrid('relayout'); }); }
function collapseCard(card){ if(isAnimating(card))return; const bd=card.querySelector('.card-bd'); if(!bd)return; setAnimating(card,true); const start=bd.offsetHeight||bd.scrollHeight||0; const duration=setCardDuration(bd,start); bd.style.height=start+'px'; bd.style.opacity='1'; void bd.offsetHeight; requestAnimationFrame(()=>{ bd.style.height='0px'; bd.style.opacity='0'; }); afterTransition(bd,'height',duration+100,()=>{ card.classList.remove('open'); clearCardDuration(bd); setAnimating(card,false); columnizeGrid('relayout'); }); }
function toggleCard(card){ card.classList.contains('open')?collapseCard(card):expandCard(card); }

/* --- inventory helpers --- */
function normItemName(s){ return (s||'').trim(); }
function parseAcquisitionName(s){ const t=String(s||'').trim(); const m=t.match(/^\((.*)\)$/); return m?{name:m[1].trim(),acquired:false}:{name:t,acquired:true}; }
function looksLikeLossEntry(entry){ const t=((entry.title||'')+' '+(entry.notes||'')).toLowerCase(); return /trade|traded|sold|gave|gifted|lost|relinquish|transfer/.test(t); }
function collectPermanentInventory(charKey){
  const ch=DATA.characters[charKey]; if(!ch||!ch.adventures) return {kept:[], map:new Map()};
  const entries=ch.adventures.map((adv,index)=>({adv,index})).sort((a,b)=>new Date(a.adv.date||'1900-01-01')-new Date(b.adv.date||'1900-01-01'));
  const keptMap=new Map();
  entries.forEach(({adv,index})=>{
    const items=adv.perm_items||[];
    const isLoss=(adv.kind&&adv.kind!=='adventure')?looksLikeLossEntry(adv):false;
    if(isLoss){
      if(items.length){
        items.forEach(raw=>{
          const cleaned=normItemName(raw.replace(/^\(|\)$/g,''));
          if(!cleaned) return;
          keptMap.delete(cleaned.toLowerCase());
        });
      }else if(adv.notes){
        [...keptMap.values()].forEach(meta=>{
          const regex=new RegExp('\\b'+meta.name.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')+'\\b','i');
          if(regex.test(adv.notes)) keptMap.delete(meta.name.toLowerCase());
        });
      }
      return;
    }
    items.forEach(raw=>{
      const {name,acquired}=parseAcquisitionName(raw);
      const cleaned=normItemName(name);
      if(!cleaned) return;
      const key=cleaned.toLowerCase();
      if(!acquired){
        keptMap.delete(key);
        return;
      }
      keptMap.set(key,{name:cleaned,index,adv});
    });
  });
  const kept=[...keptMap.values()].sort((a,b)=>a.name.localeCompare(b.name));
  return {kept,map:keptMap};
}
function currentLevelFor(charKey){
  const ch=DATA.characters[charKey]; const lvl=1+Math.floor((ch.adventures||[]).reduce((s,a)=>s+(+a.level_plus||0),0)); return Math.max(1,lvl);
}
function activeSlotsFor(level){ if(level<=4)return 1; if(level<=10)return 3; if(level<=16)return 6; return 10; }
function activeKey(k){ return 'ACTIVE_INV__'+k; }
function attuneKey(k){ return 'ATTUNED__'+k; }
function loadActive(k){ try{return JSON.parse(localStorage.getItem(activeKey(k))||'[]')}catch(_){return[]} }
function saveActive(k,a){ localStorage.setItem(activeKey(k),JSON.stringify(a||[])) }
function loadAttuned(k){ try{return JSON.parse(localStorage.getItem(attuneKey(k))||'[]')}catch(_){return[]} }
function saveAttuned(k,a){ localStorage.setItem(attuneKey(k),JSON.stringify(a||[])) }

function parseConsumableName(s){ const t=String(s||'').trim(); const m=t.match(/^\((.*)\)$/); return m?{name:m[1].trim(),acquired:false}:{name:t,acquired:true}; }
function deriveConsumableInventory(charKey){
  const ch=DATA.characters[charKey]; if (!ch || !ch.adventures) return new Map();
  const sorted=[...ch.adventures].sort((a,b)=>new Date(a.date||'1900-01-01')-new Date(b.date||'1900-01-01'));
  const counts=new Map();
  const add=(n,k=1)=>{ n=n.trim(); if(!n) return; counts.set(n,(counts.get(n)||0)+k); };
  const sub=(n,k=1)=>{ n=n.trim(); if(!n) return; const cur=(counts.get(n)||0)-k; counts.set(n,Math.max(0,cur)); if(counts.get(n)===0) counts.delete(n); };
  sorted.forEach(e=>{
    const items=e.consumable_items||[];
    const isLoss=(e.kind&&e.kind!=='adventure')?looksLikeLossEntry(e):false;
    if(isLoss){
      if(items.length) items.forEach(raw=>sub(raw.replace(/^\(|\)$/g,'')));
      else if(e.notes){ [...counts.keys()].forEach(name=>{ if(new RegExp('\\b'+name.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')+'\\b','i').test(e.notes)) sub(name); }); }
      return;
    }
    items.forEach(raw=>{ const {name,acquired}=parseConsumableName(raw); if(acquired) add(name); });
  });
  return counts;
}
function buildConsumableInventory(charKey){
  const base=deriveConsumableInventory(charKey);
  const ch=DATA.characters[charKey];
  const manual=(ch&&typeof ch.consumables==='object'&&ch.consumables)?ch.consumables:null;
  if(manual){
    Object.entries(manual).forEach(([name,val])=>{
      const num=Math.max(0,Number(val)||0);
      if(num>0) base.set(name,num);
      else base.delete(name);
    });
  }
  return base;
}

/* --- inventory modal UI --- */
const invModal=document.getElementById('invModal');
const invTitle=document.getElementById('invTitle');
const invMeta=document.getElementById('invMeta');
const invList=document.getElementById('invList');
const invSummary=document.getElementById('invSummary');
const consModal=document.getElementById('consModal');
const consTitle=document.getElementById('consTitle');
const consMeta=document.getElementById('consMeta');
const consList=document.getElementById('consList');
const consSummary=document.getElementById('consSummary');
const consSaveBtn=document.getElementById('consSave');
let currentConsumableContext=null;
document.getElementById('invClose').addEventListener('click',()=>{ invModal.classList.remove('open','editing'); refreshModalState(); });
function closeConsumableModal(){
  consModal.classList.remove('open');
  refreshModalState();
  currentConsumableContext=null;
}
document.getElementById('consClose').addEventListener('click',closeConsumableModal);
invModal.addEventListener('click',(e)=>{ if(e.target===invModal){ invModal.classList.remove('open','editing'); refreshModalState(); } });
consModal.addEventListener('click',(e)=>{ if(e.target===consModal) closeConsumableModal(); });

function openInventoryModal(charKey, opts={}){
  const ch=DATA.characters[charKey];
  const level=currentLevelFor(charKey);
  const cap=activeSlotsFor(level);
  const {kept:keptMeta}=collectPermanentInventory(charKey);
  const keptNames=keptMeta.map(item=>item.name);
  let active=loadActive(charKey).filter(n=>keptNames.some(k=>k.toLowerCase()===n.toLowerCase()));
  let attuned=loadAttuned(charKey).filter(n=>keptNames.some(k=>k.toLowerCase()===n.toLowerCase()));
  if(active.length>cap) active=active.slice(0,cap);
  if(attuned.length>3) attuned=attuned.slice(0,3);

  invTitle.textContent=(ch.display_name||ch.sheet||'Character')+' — Permanent Items';
  invMeta.textContent=`Level ${level} • Active slots: ${cap} • Attunement max: 3`;

  const activeSet=new Set(active.map(a=>a.toLowerCase()));
  const attunedSet=new Set(attuned.map(a=>a.toLowerCase()));
  const metaByName=new Map(keptMeta.map(item=>[item.name.toLowerCase(),item]));
  const rest=keptMeta.filter(item=>!activeSet.has(item.name.toLowerCase())).sort((a,b)=>a.name.localeCompare(b.name));
  const ordered=active.map(name=>metaByName.get(name.toLowerCase())).filter(Boolean).concat(rest);

  invList.innerHTML='';
  const actions=invModal.querySelector('.modal-actions');
  let editToggle=actions?actions.querySelector('.edit-toggle'):null;
  if(actions && !editToggle){
    editToggle=document.createElement('button');
    editToggle.type='button';
    editToggle.className='btn small edit-toggle';
    editToggle.textContent='Edit items';
    editToggle.setAttribute('aria-pressed','false');
    editToggle.style.marginRight='auto';
    actions.insertBefore(editToggle, actions.firstChild);
  }
  let editing=!!(opts && opts.editing);
  if(!ordered.length){ editing=false; }
  function syncEditing(){
    const activeEditing=editing && ordered.length>0;
    invModal.classList.toggle('editing', activeEditing);
    if(editToggle){
      editToggle.textContent=activeEditing?'Done':'Edit items';
      editToggle.setAttribute('aria-pressed', activeEditing?'true':'false');
    }
  }
  if(editToggle){
    editToggle.onclick=()=>{
      if(!ordered.length) return;
      openInventoryModal(charKey,{editing:!editing});
    };
    editToggle.style.display=ordered.length?'':'none';
  }

  ordered.forEach(item=>{
    const label=item&&item.name?item.name:String(item||'');
    const lower=label.toLowerCase();
    const isActive=activeSet.has(lower);
    const row=document.createElement('div');
    row.className='inv-row'+(isActive?' active':'');
    row.dataset.name=label;

    const nameDiv=document.createElement('div');
    nameDiv.className='inv-name';
    nameDiv.textContent=label;

    const rightDiv=document.createElement('div');
    rightDiv.className='inv-tools';
    if(isActive){
      const pill=document.createElement('span');
      pill.className='attune-pill'+(attunedSet.has(lower)?' on':'');
      pill.textContent=attunedSet.has(lower)?'Attuned':'Attune';
      pill.title='Toggle attunement (max 3)';
      pill.addEventListener('click',(ev)=>{
        if(editing) return;
        ev.stopPropagation();
        let cur=loadAttuned(charKey).filter(n=>keptNames.some(k=>k.toLowerCase()===n.toLowerCase()));
        const on=attunedSet.has(lower);
        if(!on){
          if(cur.length>=3){ alert('You can only be attuned to 3 items at a time.'); return; }
          cur.push(label);
        }else{
          cur=cur.filter(n=>n.toLowerCase()!==lower);
        }
        saveAttuned(charKey,cur);
        openInventoryModal(charKey,{editing});
      });
      rightDiv.appendChild(pill);
    }

    const deleteBtn=document.createElement('button');
    deleteBtn.type='button';
    deleteBtn.className='icon-btn danger delete-btn';
    deleteBtn.innerHTML=ICON_TRASH;
    deleteBtn.setAttribute('aria-label',`Remove ${label}`);
    deleteBtn.title='Remove this item';
    deleteBtn.addEventListener('click',(ev)=>{
      ev.stopPropagation();
      if(!window.confirm(`Remove "${label}" from permanent items?`)) return;
      const adv=item&&item.adv;
      if(adv){
        const lowerName=lower;
        const source=Array.isArray(adv.perm_items)?adv.perm_items:[];
        adv.perm_items=source.filter(raw=>{
          const parsed=parseAcquisitionName(raw);
          const cleaned=normItemName(parsed.name).toLowerCase();
          return cleaned!==lowerName;
        });
      }
      const lc=lower;
      saveActive(charKey, loadActive(charKey).filter(n=>n.toLowerCase()!==lc));
      saveAttuned(charKey, loadAttuned(charKey).filter(n=>n.toLowerCase()!==lc));
      markDirty();
      applyDataMutation(charKey);
      openInventoryModal(charKey,{editing:true});
    });
    rightDiv.appendChild(deleteBtn);

    row.appendChild(nameDiv);
    row.appendChild(rightDiv);

    row.addEventListener('click',()=>{
      if(editing) return;
      let cur=loadActive(charKey).filter(n=>keptNames.some(k=>k.toLowerCase()===n.toLowerCase()));
      const on=cur.some(n=>n.toLowerCase()===lower);
      if(!on){
        if(cur.length>=cap){ alert(`You can only have ${cap} active item${cap>1?'s':''} at level ${level}.`); return; }
        cur.push(label);
      }else{
        cur=cur.filter(n=>n.toLowerCase()!==lower);
        saveAttuned(charKey, loadAttuned(charKey).filter(n=>n.toLowerCase()!==lower));
      }
      saveActive(charKey,cur);
      openInventoryModal(charKey,{editing});
    });

    invList.appendChild(row);
  });

  syncEditing();

  function updateSummary(){
    const aCount=loadActive(charKey).length;
    const tCount=loadAttuned(charKey).length;
    invSummary.textContent=`Kept: ${keptMeta.length} • Active: ${aCount}/${cap} • Attuned: ${tCount}/3`;
  }
  updateSummary();
  invModal.classList.add('open');
  refreshModalState();
}

function openConsumableModal(charKey){
  const ch=DATA.characters[charKey];
  const baseCounts=deriveConsumableInventory(charKey);
  const manual=(ch&&typeof ch.consumables==='object'&&ch.consumables)?ch.consumables:{};
  const counts=buildConsumableInventory(charKey);
  const names=new Set([...counts.keys(), ...baseCounts.keys(), ...Object.keys(manual)]);
  const ordered=[...names].sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));

  consTitle.textContent=(ch.display_name||ch.sheet||'Character')+' — Consumables';
  consMeta.textContent='';
  consSummary.textContent='';
  consList.innerHTML='';
  if(consSaveBtn){ consSaveBtn.style.display='none'; }

  const states=[];
  const updateSaveVisibility=()=>{
    const dirty=states.some(state=>state.value!==state.initial);
    if(consSaveBtn){ consSaveBtn.style.display=dirty?'inline-flex':'none'; }
    if(dirty){ consSummary.textContent=''; }
  };

  ordered.forEach(name=>{
    const value=counts.get(name)||0;
    const base=baseCounts.get(name)||0;
    if(value<=0 && base<=0) return;

    const state={name,value,initial:value,base};
    states.push(state);

    const row=document.createElement('div');
    row.className='inv-row';
    row.style.cursor='default';

    const nameDiv=document.createElement('div');
    nameDiv.className='inv-name';
    nameDiv.textContent=name;

    const qtyDiv=document.createElement('div');
    qtyDiv.className='qty';

    const minus=document.createElement('button');
    minus.type='button';
    minus.className='qty-btn';
    minus.textContent='−';

    const input=document.createElement('input');
    input.type='number';
    input.min='0';
    input.step='1';
    input.inputMode='numeric';
    input.className='qty-input';
    input.value=String(state.value);

    const plus=document.createElement('button');
    plus.type='button';
    plus.className='qty-btn plus';
    plus.textContent='+';

    const sync=()=>{
      input.value=String(state.value);
      minus.disabled=state.value<=0;
    };
    const adjust=(delta)=>{
      state.value=Math.max(0,state.value+delta);
      sync();
      updateSaveVisibility();
    };

    minus.addEventListener('click',(ev)=>{
      ev.stopPropagation();
      adjust(-1);
    });
    plus.addEventListener('click',(ev)=>{
      ev.stopPropagation();
      adjust(1);
    });

    const handleInput=()=>{
      let next=parseInt(input.value,10);
      if(Number.isNaN(next)) next=0;
      if(next<0) next=0;
      state.value=next;
      sync();
      updateSaveVisibility();
    };
    input.addEventListener('change',handleInput);
    input.addEventListener('input',handleInput);

    sync();
    qtyDiv.appendChild(minus);
    qtyDiv.appendChild(input);
    qtyDiv.appendChild(plus);

    row.appendChild(nameDiv);
    row.appendChild(qtyDiv);

    consList.appendChild(row);
  });

  if(!states.length){
    const empty=document.createElement('div');
    empty.className='muted';
    empty.textContent='No consumables tracked yet.';
    consList.appendChild(empty);
  }

  currentConsumableContext={charKey,states,updateSaveVisibility};
  updateSaveVisibility();
  consModal.classList.add('open');
  refreshModalState();
}

if(consSaveBtn){
  consSaveBtn.addEventListener('click',()=>{
    if(!currentConsumableContext) return;
    const {charKey,states,updateSaveVisibility}=currentConsumableContext;
    const ch=DATA.characters[charKey];
    if(!ch) return;
    const next={};
    states.forEach(state=>{
      const raw=Number(state.value);
      const count=Number.isFinite(raw)?Math.max(0,Math.round(raw)):0;
      if(count>0){
        if(count!==state.base) next[state.name]=count;
      }else if(state.base>0){
        next[state.name]=0;
      }
    });
    if(Object.keys(next).length) ch.consumables=next;
    else delete ch.consumables;
    applyDataMutation(charKey);
    states.forEach(state=>{ state.initial=state.value; });
    if(typeof updateSaveVisibility==='function') updateSaveVisibility();
    consSummary.textContent='Consumable counts saved to data.js.';
    if(consSaveBtn) consSaveBtn.style.display='none';
    const payload='window.DATA = '+JSON.stringify(DATA,null,2)+';';
    downloadFile('data.js','application/javascript',payload);
  });
}

/* --- cards --- */
function makeCard(a,idx){
  const act=isActivityEntry(a); const {gp,dtd}=netVals(a);
  const card=document.createElement('article'); card.className='card'+(act?' activity':''); card.dataset.idx=String(idx);
  card.__dataRef=a;

  const hd=document.createElement('div'); hd.className='card-hd';
  const main=document.createElement('div');
  if(act){
    main.className='activity-line';
    const left=document.createElement('div'); left.className='activity-left';
    const dateSpan=document.createElement('span'); dateSpan.className='activity-date'; dateSpan.textContent=fmtDate(a.date);
    const nameSpan=document.createElement('span'); nameSpan.className='activity-name'; nameSpan.textContent=sanitizeTitle(a.title||'Activity');
    left.appendChild(dateSpan); left.appendChild(nameSpan);
    const chips=document.createElement('div'); chips.className='chips';
    if(gp){ const p=pill('GP '+fmtSigned(gp)); p.classList.add('muted'); chips.appendChild(p); }
    if(dtd){ const p=pill('DTD '+fmtSigned(dtd)); p.classList.add('muted'); chips.appendChild(p); }
    main.appendChild(left); main.appendChild(chips);
  }else{
    main.className='titleLine';
    const dateDiv=document.createElement('div'); dateDiv.className='date'; dateDiv.textContent=fmtDate(a.date);
    const titleDiv=document.createElement('div'); titleDiv.className='title'; titleDiv.textContent=sanitizeTitle(a.title||'Untitled Adventure');
    const subtitleDiv=document.createElement('div'); subtitleDiv.className='subtitle'; subtitleDiv.textContent=a.code||'';
    const chips=document.createElement('div'); chips.className='chips';
    const netGP=(a.gp_net==null?gp:a.gp_net);
    chips.appendChild(pill('GP '+fmtSigned(Number(netGP))));
    main.appendChild(dateDiv);
    main.appendChild(titleDiv);
    main.appendChild(subtitleDiv);
    main.appendChild(chips);
  }
  hd.appendChild(main);

  const tools=document.createElement('div'); tools.className='card-tools';
  const editBtn=document.createElement('button');
  editBtn.type='button';
  editBtn.className='icon-btn';
  editBtn.setAttribute('aria-label','Toggle edit mode');
  editBtn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.1 5.1 5 12.2V19h6.8l7.1-7.1-6.8-6.8Z"/><path d="M3 21h18"/></svg>';
  editBtn.title='Edit entry';
  editBtn.addEventListener('click',(ev)=>{
    ev.stopPropagation();
    if(card.classList.contains('editing')){
      exitEditMode(card);
    }else{
      enterEditMode(card);
    }
  });
  tools.appendChild(editBtn);
  hd.appendChild(tools);

  hd.addEventListener('click',(ev)=>{ if(card.classList.contains('editing')) return; toggleCard(card); });

  const bd=document.createElement('div'); bd.className='card-bd';
  const view=document.createElement('div'); view.className='bd-in';
  view.innerHTML='';

  function makeValue(val, empty='—'){
    if(val==null) return empty;
    const text=String(val).trim();
    return text?text:empty;
  }

  function makeKVS(label,value){
    const cell=document.createElement('div');
    cell.className='kvsingle';
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v'; v.textContent=value;
    cell.appendChild(k); cell.appendChild(v);
    return cell;
  }

  function appendField(label, content, extraClass){
    const field=document.createElement('div');
    field.className='field'+(extraClass?(' '+extraClass):'');
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v';
    if(content instanceof Node){ v.appendChild(content); }
    else{ v.textContent=makeValue(content); }
    field.appendChild(k); field.appendChild(v);
    view.appendChild(field);
    return field;
  }

  if(!act){
    view.appendChild(makeKVS('DM', makeValue(a.dm,'—')));
  }else if(a.dm){
    view.appendChild(makeKVS('DM', makeValue(a.dm,'—')));
  }

  const gpRowView=document.createElement('div'); gpRowView.className='kv2';
  const gpEarn=Number(a.gp_plus??0);
  if(!act || gpEarn!==0){ gpRowView.appendChild(makeKVS('Gold earned', fmtNumber(gpEarn))); }
  const gpSpend=Number(a.gp_minus??0);
  if(!act || gpSpend!==0){ gpRowView.appendChild(makeKVS('Gold spent', fmtNumber(gpSpend))); }
  if(gpRowView.children.length) view.appendChild(gpRowView);

  const dtRowView=document.createElement('div'); dtRowView.className='kv2';
  const dtEarnVal=Number(a.dtd_plus??0);
  if(!act || dtEarnVal!==0){ dtRowView.appendChild(makeKVS('Downtime earned', fmtNumber(dtEarnVal))); }
  const dtSpendVal=Number(a.dtd_minus??0);
  if(!act || dtSpendVal!==0){ dtRowView.appendChild(makeKVS('Downtime spent', fmtNumber(dtSpendVal))); }
  if(dtRowView.children.length) view.appendChild(dtRowView);

  const lvlVal=Number(a.level_plus||0);
  if((!act && lvlVal) || (act && lvlVal!==0)){
    view.appendChild(makeKVS('Levels gained', fmtNumber(lvlVal)));
  }

  const hasTradeMeta = act && (('itemTraded' in a) || ('itemReceived' in a));
  if(hasTradeMeta){
    if('itemTraded' in a){ appendField('Item traded away', makeValue(a.itemTraded,'—')); }
    if('itemReceived' in a){ appendField('Item received', makeValue(a.itemReceived,'—')); }
    if('player' in a || 'character' in a){
      const metaRow=document.createElement('div');
      metaRow.className='kv2';
      if('player' in a){ metaRow.appendChild(makeKVS('Player', makeValue(a.player,'—'))); }
      if('character' in a){ metaRow.appendChild(makeKVS('Character', makeValue(a.character,'—'))); }
      if(metaRow.children.length){ view.appendChild(metaRow); }
    }
  }else if(act && a.traded_item){
    appendField('Item traded away', makeValue(a.traded_item,'—'));
  }

  const hasPermItems=Array.isArray(a.perm_items)&&a.perm_items.some(item=>String(item||'').trim());
  if(!act || (!hasTradeMeta && hasPermItems)){
    appendField('Magic Items', listBox(a.perm_items),'mi');
  }
  const hasConsumables=Array.isArray(a.consumable_items)&&a.consumable_items.some(item=>String(item||'').trim());
  if(!act || hasConsumables){
    appendField('Consumables', listBox(a.consumable_items),'cons');
  }
  if(!hasTradeMeta){
    const notesBox=document.createElement('div');
    notesBox.className='notesbox';
    notesBox.textContent=makeValue((a.notes||'').trim(),'—');
    appendField('Notes', notesBox);
  }

  const formWrap=document.createElement('div'); formWrap.className='edit-form';
  const form=document.createElement('form');
  form.addEventListener('submit',(ev)=>{ ev.preventDefault(); saveCardChanges(card); });
  formWrap.appendChild(form);

  const controls={};
  function addField(label, element){
    const field=document.createElement('div'); field.className='field';
    const k=document.createElement('div'); k.className='k'; k.textContent=label;
    const v=document.createElement('div'); v.className='v'; v.appendChild(element);
    field.appendChild(k); field.appendChild(v);
    form.appendChild(field);
    return element;
  }
  function makeInput(type){ const input=document.createElement('input'); input.type=type; if(type==='number'){ input.step='any'; } return input; }
  function makeTextarea(){ const t=document.createElement('textarea'); return t; }

  controls.title=addField('Title', makeInput('text'));
  controls.date=addField('Date', makeInput('date'));
  controls.code=addField('Code', makeInput('text'));
  controls.dm=addField('DM', makeInput('text'));
  function makeKindSelect(){
    const select=document.createElement('select');
    const options=[
      {value:'adventure',label:'Adventure'},
      {value:'Downtime Activity',label:'Downtime Activity'}
    ];
    options.forEach(opt=>{ const o=document.createElement('option'); o.value=opt.value; o.textContent=opt.label; select.appendChild(o); });
    return select;
  }
  controls.kind=addField('Kind', makeKindSelect());
  controls.traded_item=addField('Item traded away', makeInput('text'));

  const gpRowForm=document.createElement('div'); gpRowForm.className='kv2';
  const gpEarnField=document.createElement('div'); gpEarnField.className='kvsingle';
  gpEarnField.innerHTML='<div class="k">Gold earned</div>';
  controls.gp_plus=makeInput('number');
  const gpEarnWrap=document.createElement('div'); gpEarnWrap.className='v'; gpEarnWrap.appendChild(controls.gp_plus); gpEarnField.appendChild(gpEarnWrap);

  const gpSpendField=document.createElement('div'); gpSpendField.className='kvsingle';
  gpSpendField.innerHTML='<div class="k">Gold spent</div>';
  controls.gp_minus=makeInput('number');
  const gpSpendWrap=document.createElement('div'); gpSpendWrap.className='v'; gpSpendWrap.appendChild(controls.gp_minus); gpSpendField.appendChild(gpSpendWrap);

  gpRowForm.appendChild(gpEarnField); gpRowForm.appendChild(gpSpendField); form.appendChild(gpRowForm);

  const dtRowForm=document.createElement('div'); dtRowForm.className='kv2';
  const dtEarnField=document.createElement('div'); dtEarnField.className='kvsingle';
  dtEarnField.innerHTML='<div class="k">Downtime earned</div>';
  controls.dtd_plus=makeInput('number');
  const dtEarnWrap=document.createElement('div'); dtEarnWrap.className='v'; dtEarnWrap.appendChild(controls.dtd_plus); dtEarnField.appendChild(dtEarnWrap);
  const dtSpendField=document.createElement('div'); dtSpendField.className='kvsingle';
  dtSpendField.innerHTML='<div class="k">Downtime spent</div>';
  controls.dtd_minus=makeInput('number');
  const dtSpendWrap=document.createElement('div'); dtSpendWrap.className='v'; dtSpendWrap.appendChild(controls.dtd_minus); dtSpendField.appendChild(dtSpendWrap);
  dtRowForm.appendChild(dtEarnField); dtRowForm.appendChild(dtSpendField); form.appendChild(dtRowForm);

  controls.level_plus=addField('Levels gained', makeInput('number'));

  const tradeField=controls.traded_item.closest('.field');
  function syncKindVisibility(){
    const isActivity=controls.kind.value!=='adventure';
    if(tradeField){ tradeField.style.display=isActivity?'':'none'; }
  }
  controls.kind.addEventListener('change', syncKindVisibility);
  syncKindVisibility();

  function createListEditor(items){
    const wrap=document.createElement('div'); wrap.className='list-editor';
    const list=document.createElement('div'); list.className='list'; wrap.appendChild(list);
    function addRow(val){
      const row=document.createElement('div'); row.className='list-row';
      const input=document.createElement('input'); input.type='text'; input.value=val||'';
      const btn=document.createElement('button'); btn.type='button'; btn.innerHTML=ICON_TRASH; btn.setAttribute('aria-label','Remove item');
      btn.addEventListener('click',()=>row.remove());
      row.appendChild(input); row.appendChild(btn); list.appendChild(row);
    }
    (items||[]).forEach(item=>addRow(item));
    const addBtn=document.createElement('button'); addBtn.type='button'; addBtn.className='add-row'; addBtn.textContent='Add item';
    addBtn.addEventListener('click',()=>addRow(''));
    wrap.appendChild(addBtn);
    wrap.getValues=()=>Array.from(list.querySelectorAll('input')).map(el=>el.value.trim()).filter(Boolean);
    wrap.setValues=(vals)=>{ list.innerHTML=''; (vals||[]).forEach(item=>addRow(item)); };
    return wrap;
  }

  controls.perm_items=createListEditor(a.perm_items||[]);
  addField('Magic items', controls.perm_items);
  controls.consumable_items=createListEditor(a.consumable_items||[]);
  addField('Consumables', controls.consumable_items);
  controls.notes=addField('Notes', makeTextarea());
  if(controls.notes){ controls.notes.rows=4; }
  const notesField=controls.notes.closest('.field');
  if(notesField){ notesField.classList.add('full','notes-field'); }
  const permField=controls.perm_items.closest('.field');
  if(permField){ permField.classList.add('full'); }
  const consField=controls.consumable_items.closest('.field');
  if(consField){ consField.classList.add('full'); }

  const actions=document.createElement('div'); actions.className='edit-actions';
  const deleteBtn=document.createElement('button'); deleteBtn.type='button'; deleteBtn.className='btn small danger delete-btn'; deleteBtn.innerHTML='<span class="btn-icon">'+ICON_TRASH+'</span><span>Delete entry</span>';
  deleteBtn.addEventListener('click',(ev)=>{ ev.preventDefault(); deleteCard(card); });
  const cancelBtn=document.createElement('button'); cancelBtn.type='button'; cancelBtn.className='btn small'; cancelBtn.textContent='Cancel';
  cancelBtn.addEventListener('click',(ev)=>{
    ev.preventDefault();
    if(card.__dataRef && card.__dataRef.__isNew){
      closeCardOverlay();
      return;
    }
    exitEditMode(card,true);
  });
  const saveBtn=document.createElement('button'); saveBtn.type='submit'; saveBtn.className='btn small primary'; saveBtn.textContent='Save changes';
  actions.appendChild(deleteBtn);
  actions.appendChild(cancelBtn); actions.appendChild(saveBtn);
  form.appendChild(actions);

  function populate(){
    controls.title.value=a.title||'';
    controls.date.value=a.date?String(a.date).slice(0,10):'';
    controls.code.value=a.code||'';
    controls.dm.value=a.dm||'';
    const kindRaw=(a.kind||'').toString();
    const kindVal=kindRaw && kindRaw.toLowerCase()!=='adventure'?'Downtime Activity':'adventure';
    controls.kind.value=kindVal;
    controls.traded_item.value=a.traded_item||'';
    syncKindVisibility();
    controls.gp_plus.value=a.gp_plus!=null?a.gp_plus:'';
    controls.gp_minus.value=a.gp_minus!=null?a.gp_minus:'';
    controls.dtd_plus.value=a.dtd_plus!=null?a.dtd_plus:'';
    controls.dtd_minus.value=a.dtd_minus!=null?a.dtd_minus:'';
    controls.level_plus.value=a.level_plus!=null?a.level_plus:'';
    controls.perm_items.setValues(a.perm_items||[]);
    controls.consumable_items.setValues(a.consumable_items||[]);
    controls.notes.value=a.notes||'';
  }

  function collect(){
    const selectedKind=(controls.kind.value||'').trim();
    const normalizedKind=selectedKind==='Downtime Activity'?'Downtime Activity':'adventure';
    const isActivity=normalizedKind!=='adventure';
    return {
      title:(controls.title.value||'').trim(),
      date:controls.date.value||'',
      code:(controls.code.value||'').trim(),
      dm:(controls.dm.value||'').trim(),
      kind:normalizedKind,
      gp_plus:Number(controls.gp_plus.value||0),
      gp_minus:Number(controls.gp_minus.value||0),
      dtd_plus:Number(controls.dtd_plus.value||0),
      dtd_minus:Number(controls.dtd_minus.value||0),
      level_plus:Number(controls.level_plus.value||0),
      perm_items:controls.perm_items.getValues(),
      consumable_items:controls.consumable_items.getValues(),
      notes:controls.notes.value||'',
      traded_item:isActivity?(controls.traded_item.value||'').trim():''
    };
  }

  formWrap.populate=populate;
  formWrap.collect=collect;

  bd.appendChild(view);
  bd.appendChild(formWrap);
  card.appendChild(hd);
  card.appendChild(bd);

  card.__edit={button:editBtn, form:formWrap, populate, collect};

  if(a && a.__openEdit){
    delete a.__openEdit;
    requestAnimationFrame(()=>enterEditMode(card));
  }

  return card;
}

function enterEditMode(card){
  if(!card||!card.__edit) return;
  card.__edit.populate();
  card.classList.add('editing');
  card.classList.add('open');
  const bd=card.querySelector('.card-bd');
  if(bd){
    bd.style.height='auto';
    bd.style.opacity='1';
  }
  if(card.__edit.button){
    card.__edit.button.setAttribute('aria-pressed','true');
    card.__edit.button.title='Exit edit mode';
  }
}

function exitEditMode(card,reset){
  if(!card||!card.__edit) return;
  if(reset){ card.__edit.populate(); }
  card.classList.remove('editing');
  if(card.__edit.button){
    card.__edit.button.setAttribute('aria-pressed','false');
    card.__edit.button.title='Edit entry';
  }
}

function saveCardChanges(card){
  if(!card||!card.__edit) return;
  const data=card.__dataRef;
  if(!data) return;
  const updates=card.__edit.collect();
  data.title=updates.title||null;
  data.date=updates.date||null;
  data.code=updates.code||'';
  data.dm=updates.dm||null;
  data.kind=updates.kind||'adventure';
  data.gp_plus=Number.isFinite(updates.gp_plus)?updates.gp_plus:0;
  data.gp_minus=Number.isFinite(updates.gp_minus)?updates.gp_minus:0;
  data.gp_net=data.gp_plus-data.gp_minus;
  data.dtd_plus=Number.isFinite(updates.dtd_plus)?updates.dtd_plus:0;
  data.dtd_minus=Number.isFinite(updates.dtd_minus)?updates.dtd_minus:0;
  data.dtd_net=data.dtd_plus-data.dtd_minus;
  data.level_plus=Number.isFinite(updates.level_plus)?updates.level_plus:0;
  data.perm_items=[...updates.perm_items];
  data.consumable_items=[...updates.consumable_items];
  const trimmedNotes=(updates.notes||'').trim();
  data.notes=trimmedNotes||'';
  data.traded_item=data.kind!=='adventure'?(updates.traded_item||''):'';
  const keyOverride=data.__charKey||null;
  const wasNew=!!data.__isNew;
  const targetKey=keyOverride||charSel.value;
  if(wasNew){
    const targetChar=DATA.characters[targetKey];
    if(targetChar){
      targetChar.adventures=Array.isArray(targetChar.adventures)?targetChar.adventures:[];
      targetChar.adventures.unshift(data);
    }
    delete data.__isNew;
    delete data.__charKey;
  }
  markDirty();
  exitEditMode(card);
  if(wasNew){
    closeCardOverlay();
    applyDataMutation(targetKey);
    return;
  }
  applyDataMutation(charSel.value);
}

function deleteCard(card){
  if(!card||!card.__dataRef) return;
  if(card.__dataRef.__isNew){
    const confirmed=window.confirm('Discard this new entry?');
    if(confirmed) closeCardOverlay();
    return;
  }
  const key=charSel.value;
  const ch=DATA.characters[key];
  if(!ch||!Array.isArray(ch.adventures)) return;
  const idx=ch.adventures.indexOf(card.__dataRef);
  if(idx===-1) return;
  const confirmed=window.confirm('Delete this entry?');
  if(!confirmed) return;
  ch.adventures.splice(idx,1);
  markDirty();
  applyDataMutation(key);
}

function updateDerivedDataFor(key){
  const ch=DATA.characters[key];
  if(!ch) return;
  const advs=ch.adventures||[];
  const years=new Set();
  let sessions=0, netGP=0, netDTD=0, levelUps=0;
  advs.forEach(entry=>{
    if(entry.date){
      const year=new Date(entry.date).getFullYear();
      if(!Number.isNaN(year)) years.add(year);
    }
    const {gp,dtd}=netVals(entry);
    netGP+=gp;
    netDTD+=dtd;
    levelUps+=Number(entry.level_plus||0);
    if(!isActivityEntry(entry)) sessions++;
  });
  DATA.years[key]=Array.from(years).sort((a,b)=>a-b);
  const perm=collectPermanentInventory(key);
  const cons=buildConsumableInventory(key);
  DATA.stats[key]={
    sessions,
    net_gp:netGP,
    net_dtd:netDTD,
    level_ups:levelUps,
    perm_count:(perm.kept||[]).length,
    cons_count:cons.size||0
  };
}

function applyDataMutation(key){
  updateDerivedDataFor(key);
  filterAndRender();
}

/* --- stats & header --- */
function renderStats(key){
  statsEl.innerHTML='';
  const s=DATA.stats[key]||{};
  const levelUps=Number(s.level_ups||0);
  const currentLevel=(Number.isFinite(levelUps)?Math.round(levelUps):0)+1;
  const rows=[
    ['Level',fmtNumber(currentLevel),'level'],
    ['Gold Pieces',fmtNumber(s.net_gp||0),'net_gp'],
    ['Downtime Days',fmtNumber(s.net_dtd||0),'net_dtd'],
    ['Sessions',fmtNumber(s.sessions||0),'sessions'],
    ['Magic Items',fmtNumber(s.perm_count||0),'perm_items'],
    ['Consumables',fmtNumber(s.cons_count||0),'consumables']
  ];
  rows.forEach(([label,val,name])=>{ const el=document.createElement('div'); el.className='stat'; el.dataset.key=name; el.innerHTML='<div class="k">'+val+'</div><div class="v">'+label+'</div>'; statsEl.appendChild(el); });
  const permTile=statsEl.querySelector('[data-key="perm_items"]');
  if(permTile){ permTile.style.cursor='pointer'; permTile.title='Click to view cumulative permanent inventory'; permTile.addEventListener('click',()=>openInventoryModal(charSel.value)); }
  const consTile=statsEl.querySelector('[data-key="consumables"]');
  if(consTile){ consTile.style.cursor='pointer'; consTile.title='Click to view consumables summary'; consTile.addEventListener('click',()=>openConsumableModal(charSel.value)); }
}
function setHeader(key){
  const obj=DATA.characters[key];
  if(!badgesEl) return;
  badgesEl.innerHTML='';
  if(!obj){
    badgesEl.style.display='none';
    badgesEl.setAttribute('aria-hidden','true');
    return;
  }
  const identity=extractCharacterIdentity(obj);
  const chips=[];
  if(identity.race){ chips.push(identityBadge('Race', identity.race)); }
  if(identity.classes){ chips.push(identityBadge('Classes', identity.classes)); }
  chips.forEach(chip=>badgesEl.appendChild(chip));
  const show=chips.length>0;
  badgesEl.style.display=show?'flex':'none';
  badgesEl.setAttribute('aria-hidden', show?'false':'true');
}

/* --- masonry --- */
let __lastCols = null, __lastWidth = window.innerWidth || document.documentElement.clientWidth || 0;

function columnizeGrid(mode){
  if (!grid.classList.contains('cols')) return;
  if (mode === 'relayout') return;

  const GAP = 14, MIN = 320;
  const cw  = grid.clientWidth || grid.offsetWidth || 1200;
  const cols = Math.max(1, Math.floor((cw + GAP) / (MIN + GAP)));

  // NEW: if grid currently contains direct .card children, we must wrap them
  const hasDirectCards = Array.from(grid.children).some(el => el.classList && el.classList.contains('card'));
  const hasColumns     = Array.from(grid.children).some(el => el.classList && el.classList.contains('col'));

  // Only skip when columns exist AND count hasn't changed
  if (hasColumns && !hasDirectCards && __lastCols === cols) return;

  __lastCols = cols;

  const y = window.scrollY || document.documentElement.scrollTop || 0;

  // Collect whatever cards exist (either direct children or inside old columns)
  const cards = hasDirectCards
    ? Array.from(grid.querySelectorAll(':scope > .card'))
    : Array.from(grid.querySelectorAll('.col .card'));

  // Remove old columns
  Array.from(grid.children)
    .filter(el => el.classList && el.classList.contains('col'))
    .forEach(c => c.remove());

  // Create new columns
  const colEls = [];
  for (let i = 0; i < cols; i++) {
    const col = document.createElement('div');
    col.className = 'col';
    grid.appendChild(col);
    colEls.push(col);
  }

  // Stable order by data-idx
  cards.sort((a,b) => parseInt(a.dataset.idx||'0',10) - parseInt(b.dataset.idx||'0',10));
  cards.forEach((card,i) => colEls[i % cols].appendChild(card));

  window.scrollTo(0, y);
}
/* --- rendering --- */
function filterAndRender(){
  const key=charSel.value;
  const advs=(DATA.characters[key]&&DATA.characters[key].adventures)||[];
  const q=(qEl.value||'').toLowerCase();
  const filtered=advs.filter(a=>{
    const blob=[a.title,a.code,a.notes,a.dm,a.traded_item,a.itemTraded,a.itemReceived,a.player,a.character]
      .concat(a.perm_items||[])
      .concat(a.consumable_items||[])
      .map(x=>(x||'').toString().toLowerCase()).join(' ');
    return !q||blob.indexOf(q)!==-1;
  });
  grid.innerHTML='';
  if(!filtered.length){ emptyEl.style.display='block'; } else { emptyEl.style.display='none'; filtered.forEach((a,i)=>grid.appendChild(makeCard(a,i))); }
  renderStats(key); setHeader(key); columnizeGrid('build');
}

/* --- events --- */
document.getElementById('expandAll').addEventListener('click',()=>{ grid.querySelectorAll('.card').forEach(c=>{ if(!c.classList.contains('open')) expandCard(c); }); });
document.getElementById('collapseAll').addEventListener('click',()=>{ grid.querySelectorAll('.card').forEach(c=>{ if(c.classList.contains('open')) collapseCard(c); }); });
qEl.addEventListener('input',filterAndRender);
charSel.addEventListener('change',filterAndRender);
window.addEventListener('resize',()=>{
  const w=window.innerWidth||document.documentElement.clientWidth||0;
  if(Math.abs(w-__lastWidth)<8) return; __lastWidth=w;
  clearTimeout(window.__colize); window.__colize=setTimeout(()=>{ columnizeGrid('build'); },120);
});

/* --- init --- */
const firstKey=getMostRecentCharacter(); charSel.value=firstKey; filterAndRender();
clearDirty();

/* prevent accidental jump-to-top for href="#" */
document.addEventListener('click',(e)=>{ const a=e.target.closest('a[href="#"]'); if(a) e.preventDefault(); },{passive:true});

/* download JSON / data.js */
if(downloadBtn){
  downloadBtn.addEventListener('click',()=>{
    if(pendingChanges){
      const payload='window.DATA = '+JSON.stringify(DATA,null,2)+';';
      downloadFile('data.js','application/javascript',payload);
      clearDirty();
    }else{
      const dataStr='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(DATA,null,2));
      const a=document.createElement('a'); a.href=dataStr; a.download='adventure_log_dashboard.json'; a.click();
    }
  });
}
if(addCardBtn){
  addCardBtn.addEventListener('click',()=>{
    const key=charSel.value;
    const ch=DATA.characters[key];
    if(!ch) return;
    const today=new Date().toISOString().slice(0,10);
    const template={
      date:today,
      title:'New Adventure',
      code:'',
      dm:'',
      gp_plus:0,
      gp_minus:0,
      dtd_plus:0,
      dtd_minus:0,
      level_plus:0,
      perm_items:[],
      consumable_items:[],
      notes:'',
      kind:'adventure',
      traded_item:'',
      __openEdit:true,
      __isNew:true,
      __charKey:key
    };
    const card=makeCard(template,-1);
    card.classList.add('overlay-card');
    openCardOverlay(card);
  });
}
</script>
</body>
</html>
